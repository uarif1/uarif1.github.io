<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head>
<title>Virtual I/O Device (VIRTIO) Version 1.1</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.tug.org/tex4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.tug.org/tex4ht/)"> 
<!-- info,charset=utf-8,fn-in,html --> 
<meta name="src" content="virtio-v1.1-cs01.tex"> 
<link rel="stylesheet" type="text/css" href="virtio-v1.1-cs01.css"> 
</head><body 
>
<!--l. 1--><p class="noindent" >
                                                                  

                                                                  
<!--l. 4--><p class="noindent" ><table style="border-collapse:collapse;"><tr class="row-1"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ><img 
src="images/oasis.png" alt="PIC"  
width="39" height="39" >  </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table>
<!--l. 9--><p class="noindent" ><div style="color: #446CAA; font-size: 24pt;"> <span 
class="aeb10-">Virtual I/O Device (VIRTIO) Version 1.1 </span></div>
<!--l. 10--><p class="noindent" ><div style="color: #446CAA; font-size: 18pt;"> <span 
class="aeb10-">Committee Specification 01 </span></div>
<!--l. 12--><p class="noindent" ><div style="color: #446CAA; font-size: 18pt;"> <span 
class="aeb10-">11 April 2019 </span></div>
<!--l. 14--><p class="noindent" ><div style="color: #446CAA; font-size: 12pt;"> <span 
class="aeb10-">Specification URIs </span></div>
<!--l. 16--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aeb10-">This version: </span></div> <div style="margin-left: 20px;">  <a 
href="https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/tex/" class="url" >https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/tex/</a>
(Authoritative)<br 
class="newline" /><a 
href="https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/virtio-v1.1-cs01.pdf" class="url" >https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/virtio-v1.1-cs01.pdf</a><br 
class="newline" /><a 
href="https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/virtio-v1.1-cs01.html" class="url" >https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/virtio-v1.1-cs01.html</a> </div>
<!--l. 22--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aeb10-">Previous version: </span></div> <div style="margin-left: 20px;">  N/A  </div>
<!--l. 26--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aeb10-">Latest version: </span></div> <div style="margin-left: 20px;">  <a 
href="https://docs.oasis-open.org/virtio/virtio/v1.1/virtio-v1.1.pdf" class="url" >https://docs.oasis-open.org/virtio/virtio/v1.1/virtio-v1.1.pdf</a><br 
class="newline" /><a 
href="https://docs.oasis-open.org/virtio/virtio/v1.1/virtio-v1.1.html" class="url" >https://docs.oasis-open.org/virtio/virtio/v1.1/virtio-v1.1.html</a> </div>
<!--l. 31--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aeb10-">Technical Committee: </span></div> <div style="margin-left: 20px;">  <a 
href="https://www.oasis-open.org/committees/virtio/" >OASIS Virtual I/O Device (VIRTIO) TC</a>  </div>
<!--l. 35--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aeb10-">Chairs: </span></div> <div style="margin-left: 20px;"> <a 
 id="x1-1doc"></a> Michael S. Tsirkin (<a 
href="mailto:mst@redhat.com" >mst@redhat.com</a>), <a 
href="https://www.redhat.com/" >Red Hat</a><br 
class="newline" />Cornelia Huck (<a 
href="mailto:cohuck@redhat.com" >cohuck@redhat.com</a>), <a 
href="https://www.redhat.com/" >Red Hat</a><br 
class="newline" /> </div>
<!--l. 40--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aeb10-">Editors: </span></div> <div style="margin-left: 20px;">  Michael S. Tsirkin (<a 
href="mailto:mst@redhat.com" >mst@redhat.com</a>), <a 
href="https://www.redhat.com/" >Red Hat</a><br 
class="newline" />Cornelia Huck (<a 
href="mailto:cohuck@redhat.com" >cohuck@redhat.com</a>), <a 
href="https://www.redhat.com/" >Red Hat</a><br 
class="newline" /> </div>
<!--l. 46--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aeb10-">Additional artifacts: </span></div> <div style="margin-left: 20px;">  This prose specification is one component of a Work Product
that also includes:
     <ul class="itemize1">
     <li class="itemize">Example Driver Listing: <br 
class="newline" /><a 
href="https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/listings/" class="url" >https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/listings/</a></li></ul>
                                                                  

                                                                  
</div>
<!--l. 55--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aeb10-">Related work: </span></div> <div style="margin-left: 20px;">  This specification replaces or supersedes:
     <ul class="itemize1">
     <li class="itemize">Virtual  I/O  Device  (VIRTIO)  Version  1.0.  Edited  by  Rusty  Russell,
     Michael S. Tsirkin, Cornelia Huck, and Pawel Moll. Latest version:<br 
class="newline" /><a 
href="https://docs.oasis-open.org/virtio/virtio/v1.0/virtio-v1.0.html" class="url" >https://docs.oasis-open.org/virtio/virtio/v1.0/virtio-v1.0.html</a>
     </li>
     <li class="itemize">Virtio PCI Card Specification Version 0.9.5:<br 
class="newline" /><a 
href="http://ozlabs.org/~rusty/virtio-spec/virtio-0.9.5.pdf" class="url" >http://ozlabs.org/~rusty/virtio-spec/virtio-0.9.5.pdf</a></li></ul>
</div>
<!--l. 77--><p class="noindent" >
                                                                  

                                                                  
<!--l. 79--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aeb10-">Abstract: </span></div> <div style="margin-left: 20px;">  This document describes the specifications of the “virtio” family of
devices. These devices are found in virtual environments, yet by design they look like
physical devices to the guest within the virtual machine - and this document treats
them as such. This similarity allows the guest to use standard drivers and discovery
mechanisms.
<!--l. 8--><p class="noindent" >The purpose of virtio and this specification is that virtual environments and guests
should have a straightforward, efficient, standard and extensible mechanism for
virtual devices, rather than boutique per-environment or per-OS mechanisms.   </div>
<!--l. 83--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aeb10-">Status: </span></div> <div style="margin-left: 20px;">  This document was last revised or approved by the Virtual I/O
Device (VIRTIO) TC on the above date. The level of approval is also
listed above. Check the “Latest version” location noted above for possible
later revisions of this document. Any other numbered Versions and other
technical work produced by the Technical Committee (TC) are listed at
<a 
href="https://www.oasis-open.org/committees/tc_home.php?wg_abbrev=virtio#technical" class="url" >https://www.oasis-open.org/committees/tc_home.php?wg_abbrev=virtio#technical</a>.
<!--l. 91--><p class="noindent" >Technical Committee members should send comments on this specification to the
Technical Committee’s email list. Others should send comments to the Technical
Committee by using the “<a 
href="https://www.oasis-open.org/committees/comments/form.php?wg_abbrev=virtio" >Send A Comment</a>” button on the Technical Committee’s
web page at <a 
href="https://www.oasis-open.org/committees/virtio/" class="url" >https://www.oasis-open.org/committees/virtio/</a>.
<!--l. 1--><p class="noindent" >This specification is provided under the <a 
href="https://www.oasis-open.org/policies-guidelines/ipr#Non-Assertion-Mode" >Non-Assertion</a> Mode of the <a 
href="https://www.oasis-open.org/policies-guidelines/ipr" >OASIS IPR
Policy</a>, the mode chosen when the Technical Committee was established. For
information on whether any patents have been disclosed that may be essential to
implementing this specification, and any offers of patent licensing terms,
please refer to the Intellectual Property Rights section of the TC’s web page
(<a 
href="https://github.com/oasis-tcs/virtio-admin/blob/master/IPR.md" class="url" >https://github.com/oasis-tcs/virtio-admin/blob/master/IPR.md</a>).
<!--l. 100--><p class="noindent" >Note that any machine-readable content (<a 
href="https://www.oasis-open.org/policies-guidelines/tc-process#wpComponentsCompLang" >Computer Language Definitions</a>) declared
Normative for this Work Product is provided in separate plain text files. In the event
of a discrepancy between any such plain text file and display content in the Work
Product’s prose narrative document(s), the content in the separate plain text file
prevails.
</div>
<!--l. 111--><p class="noindent" ><div style="color: #446CAA; font-size: 10pt;"> <span 
class="aeb10-">Citation format: </span></div> <div style="margin-left: 20px;">  When referencing this specification the following citation format
should be used:<br 
class="newline" />
<!--l. 114--><p class="noindent" ><span 
class="aeb10-">[VIRTIO-v1.1]</span><br 
class="newline" /><span 
class="aeti-10">Virtual I/O Device (VIRTIO) Version 1.1</span>. Edited by Michael S. Tsirkin
and Cornelia Huck. 11 April 2019. OASIS Committee Specification 01.
<a 
href="https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/virtio-v1.1-cs01.html" class="url" >https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/virtio-v1.1-cs01.html</a>. Latest
version: <a 
href="https://docs.oasis-open.org/virtio/virtio/v1.1/virtio-v1.1.html" class="url" >https://docs.oasis-open.org/virtio/virtio/v1.1/virtio-v1.1.html</a>.  </div>
                                                                  

                                                                  
<!--l. 120--><p class="noindent" >
                                                                  

                                                                  
__________________________________________________________________
<!--l. 122--><p class="noindent" ><div style="color: #446CAA; font-size: 18pt;"> <span 
class="aeb10-">Notices </span></div>
<!--l. 124--><p class="noindent" >Copyright <span 
class="tcrm-1000">© </span>OASIS Open 2018. All Rights Reserved.
<!--l. 126--><p class="noindent" >All capitalized terms in the following text have the meanings assigned to them in the
OASIS Intellectual Property Rights Policy (the "OASIS IPR Policy"). The full <a 
href="https://www.oasis-open.org/policies-guidelines/ipr" >Policy</a>
may be found at the OASIS website.
<!--l. 130--><p class="noindent" >This document and translations of it may be copied and furnished to others, and
derivative works that comment on or otherwise explain it or assist in its
implementation may be prepared, copied, published, and distributed, in whole or in
part, without restriction of any kind, provided that the above copyright notice and
this section are included on all such copies and derivative works. However, this
document itself may not be modified in any way, including by removing the copyright
notice or references to OASIS, except as needed for the purpose of developing any
document or deliverable produced by an OASIS Technical Committee (in which case
the rules applicable to copyrights, as set forth in the OASIS IPR Policy,
must be followed) or as required to translate it into languages other than
English.
<!--l. 1--><p class="noindent" >This specification is provided under the <a 
href="https://www.oasis-open.org/policies-guidelines/ipr#Non-Assertion-Mode" >Non-Assertion</a> Mode of the <a 
href="https://www.oasis-open.org/policies-guidelines/ipr" >OASIS IPR
Policy</a>, the mode chosen when the Technical Committee was established. For
information on whether any patents have been disclosed that may be essential to
implementing this specification, and any offers of patent licensing terms,
please refer to the Intellectual Property Rights section of the TC’s web page
(<a 
href="https://github.com/oasis-tcs/virtio-admin/blob/master/IPR.md" class="url" >https://github.com/oasis-tcs/virtio-admin/blob/master/IPR.md</a>).
<!--l. 145--><p class="noindent" >The limited permissions granted above are perpetual and will not be revoked by
OASIS or its successors or assigns.
<!--l. 148--><p class="noindent" >This document and the information contained herein is provided on an "AS IS" basis
and OASIS DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED,
INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF
THE INFORMATION HEREIN WILL NOT INFRINGE ANY OWNERSHIP
RIGHTS OR ANY IMPLIED WARRANTIES OF MERCHANTABILITY OR
FITNESS FOR A PARTICULAR PURPOSE.
<!--l. 155--><p class="noindent" >OASIS requests that any OASIS Party or any other party that believes it has patent
claims that would necessarily be infringed by implementations of this OASIS
Committee Specification or OASIS Standard, to notify OASIS TC Administrator and
provide an indication of its willingness to grant patent licenses to such patent claims
in a manner consistent with the IPR Mode of the OASIS Technical Committee that
produced this specification.
<!--l. 163--><p class="noindent" >OASIS invites any party to contact the OASIS TC Administrator if it is aware of a
claim of ownership of any patent claims that would necessarily be infringed by
implementations of this specification by a patent holder that is not willing to provide
                                                                  

                                                                  
a license to such patent claims in a manner consistent with the IPR Mode of
the OASIS Technical Committee that produced this specification. OASIS
may include such claims on its website, but disclaims any obligation to do
so.
<!--l. 171--><p class="noindent" >OASIS takes no position regarding the validity or scope of any intellectual property
or other rights that might be claimed to pertain to the implementation or use
of the technology described in this document or the extent to which any
license under such rights might or might not be available; neither does it
represent that it has made any effort to identify any such rights. Information on
OASIS’ procedures with respect to rights in any document or deliverable
produced by an OASIS Technical Committee can be found on the OASIS
website. Copies of claims of rights made available for publication and any
assurances of licenses to be made available, or the result of an attempt made to
obtain a general license or permission for the use of such proprietary rights by
implementers or users of this OASIS Committee Specification or OASIS
Standard, can be obtained from the OASIS TC Administrator. OASIS makes no
representation that any information or list of intellectual property rights will at
any time be complete, or that any claims in such list are, in fact, Essential
Claims.
<!--l. 188--><p class="noindent" >The name "OASIS" is a trademark of <a 
href="https://www.oasis-open.org/" >OASIS</a>, the owner and developer of this
specification, and should be used only to refer to the organization and its official
outputs. OASIS welcomes reference to, and implementation and use of, specifications,
while reserving the right to enforce its marks against misleading uses. Please see
<a 
href="https://www.oasis-open.org/policies-guidelines/trademark" class="url" >https://www.oasis-open.org/policies-guidelines/trademark</a> for above guidance.
<br 
class="newline" /><br 
class="newline" />
                                                                  

                                                                  
                                                                  

                                                                  
__________________________________________________________________
<h2 class="likechapterHead"><a 
 id="x1-1000"></a>Table of Contents</h2>
<div class="tableofcontents">
<span class="chapterToc" >1 <a 
href="#x1-20001" id="QQ2-1-2">Introduction</a></span>
<br /> <span class="sectionToc" >1.1 <a 
href="#x1-30001" id="QQ2-1-3">Normative References</a></span>
<br /> <span class="sectionToc" >1.2 <a 
href="#x1-40002" id="QQ2-1-4">Non-Normative References</a></span>
<br /> <span class="sectionToc" >1.3 <a 
href="#x1-50003" id="QQ2-1-5">Terminology</a></span>
<br />  <span class="subsectionToc" >1.3.1 <a 
href="#x1-60001" id="QQ2-1-6">Legacy Interface: Terminology</a></span>
<br />  <span class="subsectionToc" >1.3.2 <a 
href="#x1-70002" id="QQ2-1-7">Transition from earlier specification drafts</a></span>
<br /> <span class="sectionToc" >1.4 <a 
href="#x1-80004" id="QQ2-1-8">Structure Specifications</a></span>
<br /> <span class="sectionToc" >1.5 <a 
href="#x1-90005" id="QQ2-1-9">Constant Specifications</a></span>
<br /><span class="chapterToc" >2 <a 
href="#x1-100002" id="QQ2-1-10">Basic Facilities of a Virtio Device</a></span>
<br /> <span class="sectionToc" >2.1 <a 
href="#x1-110001" id="QQ2-1-11"><span 
class="aeti-10">Device Status </span>Field</a></span>
<br />  <span class="subsectionToc" >2.1.1 <a 
href="#x1-120001" id="QQ2-1-12">Driver Requirements: Device Status Field</a></span>
<br />  <span class="subsectionToc" >2.1.2 <a 
href="#x1-130002" id="QQ2-1-13">Device Requirements: Device Status Field</a></span>
<br /> <span class="sectionToc" >2.2 <a 
href="#x1-140002" id="QQ2-1-14">Feature Bits</a></span>
<br />  <span class="subsectionToc" >2.2.1 <a 
href="#x1-150001" id="QQ2-1-15">Driver Requirements: Feature Bits</a></span>
<br />  <span class="subsectionToc" >2.2.2 <a 
href="#x1-160002" id="QQ2-1-16">Device Requirements: Feature Bits</a></span>
<br />  <span class="subsectionToc" >2.2.3 <a 
href="#x1-170003" id="QQ2-1-17">Legacy Interface: A Note on Feature Bits</a></span>
<br /> <span class="sectionToc" >2.3 <a 
href="#x1-180003" id="QQ2-1-18">Notifications</a></span>
<br /> <span class="sectionToc" >2.4 <a 
href="#x1-190004" id="QQ2-1-19">Device Reset</a></span>
<br />  <span class="subsectionToc" >2.4.1 <a 
href="#x1-200001" id="QQ2-1-20">Device Requirements: Device Reset</a></span>
                                                                  

                                                                  
<br />  <span class="subsectionToc" >2.4.2 <a 
href="#x1-210002" id="QQ2-1-21">Driver Requirements: Device Reset</a></span>
<br /> <span class="sectionToc" >2.5 <a 
href="#x1-220005" id="QQ2-1-22">Device Configuration Space</a></span>
<br />  <span class="subsectionToc" >2.5.1 <a 
href="#x1-230001" id="QQ2-1-23">Driver Requirements: Device Configuration Space</a></span>
<br />  <span class="subsectionToc" >2.5.2 <a 
href="#x1-240002" id="QQ2-1-24">Device Requirements: Device Configuration Space</a></span>
<br />  <span class="subsectionToc" >2.5.3 <a 
href="#x1-250003" id="QQ2-1-25">Legacy Interface: A Note on Device Configuration Space endian-ness</a></span>
<br />  <span class="subsectionToc" >2.5.4 <a 
href="#x1-260004" id="QQ2-1-26">Legacy Interface: Device Configuration Space</a></span>
<br /> <span class="sectionToc" >2.6 <a 
href="#x1-270006" id="QQ2-1-27">Virtqueues</a></span>
<br />  <span class="subsectionToc" >2.6.1 <a 
href="#x1-280001" id="QQ2-1-28">Virtqueue Reset</a></span>
<br /> <span class="sectionToc" >2.7 <a 
href="#x1-350007" id="QQ2-1-35">Split Virtqueues</a></span>
<br />  <span class="subsectionToc" >2.7.1 <a 
href="#x1-360001" id="QQ2-1-36">Driver Requirements: Virtqueues</a></span>
<br />  <span class="subsectionToc" >2.7.2 <a 
href="#x1-370002" id="QQ2-1-37">Legacy Interfaces: A Note on Virtqueue Layout</a></span>
<br />  <span class="subsectionToc" >2.7.3 <a 
href="#x1-380003" id="QQ2-1-38">Legacy Interfaces: A Note on Virtqueue Endianness</a></span>
<br />  <span class="subsectionToc" >2.7.4 <a 
href="#x1-390004" id="QQ2-1-39">Message Framing</a></span>
<br />  <span class="subsectionToc" >2.7.5 <a 
href="#x1-430005" id="QQ2-1-43">The Virtqueue Descriptor Table</a></span>
<br />  <span class="subsectionToc" >2.7.6 <a 
href="#x1-490006" id="QQ2-1-49">The Virtqueue Available Ring</a></span>
<br />  <span class="subsectionToc" >2.7.7 <a 
href="#x1-510007" id="QQ2-1-51">Used Buffer Notification Suppression</a></span>
<br />  <span class="subsectionToc" >2.7.8 <a 
href="#x1-540008" id="QQ2-1-54">The Virtqueue Used Ring</a></span>
<br />  <span class="subsectionToc" >2.7.9 <a 
href="#x1-580009" id="QQ2-1-58">In-order use of descriptors</a></span>
<br />  <span class="subsectionToc" >2.7.10 <a 
href="#x1-5900010" id="QQ2-1-59">Available Buffer Notification Suppression</a></span>
<br />  <span class="subsectionToc" >2.7.11 <a 
href="#x1-6200011" id="QQ2-1-62">Helpers for Operating Virtqueues</a></span>
<br />  <span class="subsectionToc" >2.7.12 <a 
href="#x1-6300012" id="QQ2-1-63">Virtqueue Operation</a></span>
<br />  <span class="subsectionToc" >2.7.13 <a 
href="#x1-6400013" id="QQ2-1-64">Supplying Buffers to The Device</a></span>
<br />  <span class="subsectionToc" >2.7.14 <a 
href="#x1-7100014" id="QQ2-1-71">Receiving Used Buffers From The Device</a></span>
<br /> <span class="sectionToc" >2.8 <a 
href="#x1-720008" id="QQ2-1-72">Packed Virtqueues</a></span>
<br />  <span class="subsectionToc" >2.8.1 <a 
href="#x1-730001" id="QQ2-1-73">Driver and Device Ring Wrap Counters</a></span>
<br />  <span class="subsectionToc" >2.8.2 <a 
href="#x1-740002" id="QQ2-1-74">Polling of available and used descriptors</a></span>
<br />  <span class="subsectionToc" >2.8.3 <a 
href="#x1-750003" id="QQ2-1-75">Write Flag</a></span>
<br />  <span class="subsectionToc" >2.8.4 <a 
href="#x1-760004" id="QQ2-1-76">Element Address and Length</a></span>
<br />  <span class="subsectionToc" >2.8.5 <a 
href="#x1-770005" id="QQ2-1-77">Scatter-Gather Support</a></span>
<br />  <span class="subsectionToc" >2.8.6 <a 
href="#x1-780006" id="QQ2-1-78">Next Flag: Descriptor Chaining</a></span>
<br />  <span class="subsectionToc" >2.8.7 <a 
href="#x1-790007" id="QQ2-1-79">Indirect Flag: Scatter-Gather Support</a></span>
                                                                  

                                                                  
<br />  <span class="subsectionToc" >2.8.8 <a 
href="#x1-800008" id="QQ2-1-80">In-order use of descriptors</a></span>
<br />  <span class="subsectionToc" >2.8.9 <a 
href="#x1-810009" id="QQ2-1-81">Multi-buffer requests</a></span>
<br />  <span class="subsectionToc" >2.8.10 <a 
href="#x1-8200010" id="QQ2-1-82">Driver and Device Event Suppression</a></span>
<br />  <span class="subsectionToc" >2.8.11 <a 
href="#x1-8400011" id="QQ2-1-84">Driver Requirements: Virtqueues</a></span>
<br />  <span class="subsectionToc" >2.8.12 <a 
href="#x1-8500012" id="QQ2-1-85">Device Requirements: Virtqueues</a></span>
<br />  <span class="subsectionToc" >2.8.13 <a 
href="#x1-8600013" id="QQ2-1-86">The Virtqueue Descriptor Format</a></span>
<br />  <span class="subsectionToc" >2.8.14 <a 
href="#x1-8700014" id="QQ2-1-87">Event Suppression Structure Format</a></span>
<br />  <span class="subsectionToc" >2.8.15 <a 
href="#x1-8800015" id="QQ2-1-88">Device Requirements: The Virtqueue Descriptor Table</a></span>
<br />  <span class="subsectionToc" >2.8.16 <a 
href="#x1-8900016" id="QQ2-1-89">Driver Requirements: The Virtqueue Descriptor Table</a></span>
<br />  <span class="subsectionToc" >2.8.17 <a 
href="#x1-9000017" id="QQ2-1-90">Driver Requirements: Scatter-Gather Support</a></span>
<br />  <span class="subsectionToc" >2.8.18 <a 
href="#x1-9100018" id="QQ2-1-91">Device Requirements: Scatter-Gather Support</a></span>
<br />  <span class="subsectionToc" >2.8.19 <a 
href="#x1-9200019" id="QQ2-1-92">Driver Requirements: Indirect Descriptors</a></span>
<br />  <span class="subsectionToc" >2.8.20 <a 
href="#x1-9300020" id="QQ2-1-93">Virtqueue Operation</a></span>
<br />  <span class="subsectionToc" >2.8.21 <a 
href="#x1-9400021" id="QQ2-1-94">Supplying Buffers to The Device</a></span>
<br />  <span class="subsectionToc" >2.8.22 <a 
href="#x1-10000022" id="QQ2-1-100">Receiving Used Buffers From The Device</a></span>
<br /> <span class="sectionToc" >2.9 <a 
href="#x1-1010009" id="QQ2-1-101">Driver Notifications</a></span>
<br /> <span class="sectionToc" >2.10 <a 
href="#x1-10200010" id="QQ2-1-102">Shared Memory Regions</a></span>
<br />  <span class="subsectionToc" >2.10.1 <a 
href="#x1-1030001" id="QQ2-1-103">Addressing within regions</a></span>
<br />  <span class="subsectionToc" >2.10.2 <a 
href="#x1-1040002" id="QQ2-1-104">Device Requirements: Shared Memory Regions</a></span>
<br /> <span class="sectionToc" >2.11 <a 
href="#x1-10500011" id="QQ2-1-105">Exporting Objects</a></span>
<br /><span class="chapterToc" >3 <a 
href="#x1-1060003" id="QQ2-1-106">General Initialization And Device Operation</a></span>
<br /> <span class="sectionToc" >3.1 <a 
href="#x1-1070001" id="QQ2-1-107">Device Initialization</a></span>
<br />  <span class="subsectionToc" >3.1.1 <a 
href="#x1-1080001" id="QQ2-1-108">Driver Requirements: Device Initialization</a></span>
<br />  <span class="subsectionToc" >3.1.2 <a 
href="#x1-1090002" id="QQ2-1-109">Legacy Interface: Device Initialization</a></span>
<br /> <span class="sectionToc" >3.2 <a 
href="#x1-1100002" id="QQ2-1-110">Device Operation</a></span>
<br />  <span class="subsectionToc" >3.2.1 <a 
href="#x1-1110001" id="QQ2-1-111">Notification of Device Configuration Changes</a></span>
<br /> <span class="sectionToc" >3.3 <a 
href="#x1-1120003" id="QQ2-1-112">Device Cleanup</a></span>
<br />  <span class="subsectionToc" >3.3.1 <a 
href="#x1-1130001" id="QQ2-1-113">Driver Requirements: Device Cleanup</a></span>
<br /><span class="chapterToc" >4 <a 
href="#x1-1140004" id="QQ2-1-114">Virtio Transport Options</a></span>
<br /> <span class="sectionToc" >4.1 <a 
href="#x1-1150001" id="QQ2-1-115">Virtio Over PCI Bus</a></span>
<br />  <span class="subsectionToc" >4.1.1 <a 
href="#x1-1160001" id="QQ2-1-116">Device Requirements: Virtio Over PCI Bus</a></span>
                                                                  

                                                                  
<br />  <span class="subsectionToc" >4.1.2 <a 
href="#x1-1170002" id="QQ2-1-117">PCI Device Discovery</a></span>
<br />  <span class="subsectionToc" >4.1.3 <a 
href="#x1-1210003" id="QQ2-1-121">PCI Device Layout</a></span>
<br />  <span class="subsectionToc" >4.1.4 <a 
href="#x1-1240004" id="QQ2-1-124">Virtio Structure PCI Capabilities</a></span>
<br />  <span class="subsectionToc" >4.1.5 <a 
href="#x1-1520005" id="QQ2-1-152">PCI-specific Initialization And Device Operation</a></span>
<br /> <span class="sectionToc" >4.2 <a 
href="#x1-1690002" id="QQ2-1-170">Virtio Over MMIO</a></span>
<br />  <span class="subsectionToc" >4.2.1 <a 
href="#x1-1700001" id="QQ2-1-171">MMIO Device Discovery</a></span>
<br />  <span class="subsectionToc" >4.2.2 <a 
href="#x1-1710002" id="QQ2-1-172">MMIO Device Register Layout</a></span>
<br />  <span class="subsectionToc" >4.2.3 <a 
href="#x1-1740003" id="QQ2-1-177">MMIO-specific Initialization And Device Operation</a></span>
<br />  <span class="subsectionToc" >4.2.4 <a 
href="#x1-1810004" id="QQ2-1-185">Legacy interface</a></span>
<br /> <span class="sectionToc" >4.3 <a 
href="#x1-1820003" id="QQ2-1-187">Virtio Over Channel I/O</a></span>
<br />  <span class="subsectionToc" >4.3.1 <a 
href="#x1-1830001" id="QQ2-1-188">Basic Concepts</a></span>
<br />  <span class="subsectionToc" >4.3.2 <a 
href="#x1-1880002" id="QQ2-1-193">Device Initialization</a></span>
<br />  <span class="subsectionToc" >4.3.3 <a 
href="#x1-2070003" id="QQ2-1-212">Device Operation</a></span>
<br /><span class="chapterToc" >5 <a 
href="#x1-2200005" id="QQ2-1-226">Device Types</a></span>
<br /> <span class="sectionToc" >5.1 <a 
href="#x1-2210001" id="QQ2-1-227">Network Device</a></span>
<br />  <span class="subsectionToc" >5.1.1 <a 
href="#x1-2220001" id="QQ2-1-228">Device ID</a></span>
<br />  <span class="subsectionToc" >5.1.2 <a 
href="#x1-2230002" id="QQ2-1-229">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.1.3 <a 
href="#x1-2240003" id="QQ2-1-230">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.1.4 <a 
href="#x1-2270004" id="QQ2-1-233">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.1.5 <a 
href="#x1-2310005" id="QQ2-1-237">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.1.6 <a 
href="#x1-2320006" id="QQ2-1-238">Device Operation</a></span>
<br /> <span class="sectionToc" >5.2 <a 
href="#x1-2780002" id="QQ2-1-284">Block Device</a></span>
<br />  <span class="subsectionToc" >5.2.1 <a 
href="#x1-2790001" id="QQ2-1-285">Device ID</a></span>
<br />  <span class="subsectionToc" >5.2.2 <a 
href="#x1-2800002" id="QQ2-1-286">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.2.3 <a 
href="#x1-2810003" id="QQ2-1-287">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.2.4 <a 
href="#x1-2830004" id="QQ2-1-289">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.2.5 <a 
href="#x1-2850005" id="QQ2-1-291">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.2.6 <a 
href="#x1-2890006" id="QQ2-1-295">Device Operation</a></span>
<br /> <span class="sectionToc" >5.3 <a 
href="#x1-2940003" id="QQ2-1-300">Console Device</a></span>
<br />  <span class="subsectionToc" >5.3.1 <a 
href="#x1-2950001" id="QQ2-1-301">Device ID</a></span>
<br />  <span class="subsectionToc" >5.3.2 <a 
href="#x1-2960002" id="QQ2-1-302">Virtqueues</a></span>
                                                                  

                                                                  
<br />  <span class="subsectionToc" >5.3.3 <a 
href="#x1-2970003" id="QQ2-1-303">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.3.4 <a 
href="#x1-2980004" id="QQ2-1-304">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.3.5 <a 
href="#x1-3000005" id="QQ2-1-306">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.3.6 <a 
href="#x1-3020006" id="QQ2-1-308">Device Operation</a></span>
<br /> <span class="sectionToc" >5.4 <a 
href="#x1-3090004" id="QQ2-1-315">Entropy Device</a></span>
<br />  <span class="subsectionToc" >5.4.1 <a 
href="#x1-3100001" id="QQ2-1-316">Device ID</a></span>
<br />  <span class="subsectionToc" >5.4.2 <a 
href="#x1-3110002" id="QQ2-1-317">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.4.3 <a 
href="#x1-3120003" id="QQ2-1-318">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.4.4 <a 
href="#x1-3130004" id="QQ2-1-319">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.4.5 <a 
href="#x1-3140005" id="QQ2-1-320">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.4.6 <a 
href="#x1-3150006" id="QQ2-1-321">Device Operation</a></span>
<br /> <span class="sectionToc" >5.5 <a 
href="#x1-3180005" id="QQ2-1-324">Traditional Memory Balloon Device</a></span>
<br />  <span class="subsectionToc" >5.5.1 <a 
href="#x1-3190001" id="QQ2-1-325">Device ID</a></span>
<br />  <span class="subsectionToc" >5.5.2 <a 
href="#x1-3200002" id="QQ2-1-326">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.5.3 <a 
href="#x1-3210003" id="QQ2-1-327">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.5.4 <a 
href="#x1-3250004" id="QQ2-1-331">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.5.5 <a 
href="#x1-3270005" id="QQ2-1-333">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.5.6 <a 
href="#x1-3280006" id="QQ2-1-334">Device Operation</a></span>
<br /> <span class="sectionToc" >5.6 <a 
href="#x1-3470006" id="QQ2-1-353">SCSI Host Device</a></span>
<br />  <span class="subsectionToc" >5.6.1 <a 
href="#x1-3480001" id="QQ2-1-354">Device ID</a></span>
<br />  <span class="subsectionToc" >5.6.2 <a 
href="#x1-3490002" id="QQ2-1-355">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.6.3 <a 
href="#x1-3500003" id="QQ2-1-356">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.6.4 <a 
href="#x1-3510004" id="QQ2-1-357">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.6.5 <a 
href="#x1-3550005" id="QQ2-1-361">Device Requirements: Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.6.6 <a 
href="#x1-3560006" id="QQ2-1-362">Device Operation</a></span>
<br /> <span class="sectionToc" >5.7 <a 
href="#x1-3690007" id="QQ2-1-375">GPU Device</a></span>
<br />  <span class="subsectionToc" >5.7.1 <a 
href="#x1-3700001" id="QQ2-1-376">Device ID</a></span>
<br />  <span class="subsectionToc" >5.7.2 <a 
href="#x1-3710002" id="QQ2-1-377">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.7.3 <a 
href="#x1-3720003" id="QQ2-1-378">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.7.4 <a 
href="#x1-3730004" id="QQ2-1-379">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.7.5 <a 
href="#x1-3760005" id="QQ2-1-382">Device Requirements: Device Initialization</a></span>
                                                                  

                                                                  
<br />  <span class="subsectionToc" >5.7.6 <a 
href="#x1-3770006" id="QQ2-1-383">Device Operation</a></span>
<br />  <span class="subsectionToc" >5.7.7 <a 
href="#x1-3880007" id="QQ2-1-394">VGA Compatibility</a></span>
<br /> <span class="sectionToc" >5.8 <a 
href="#x1-3890008" id="QQ2-1-395">Input Device</a></span>
<br />  <span class="subsectionToc" >5.8.1 <a 
href="#x1-3900001" id="QQ2-1-396">Device ID</a></span>
<br />  <span class="subsectionToc" >5.8.2 <a 
href="#x1-3910002" id="QQ2-1-397">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.8.3 <a 
href="#x1-3920003" id="QQ2-1-398">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.8.4 <a 
href="#x1-3930004" id="QQ2-1-399">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.8.5 <a 
href="#x1-3940005" id="QQ2-1-400">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.8.6 <a 
href="#x1-3970006" id="QQ2-1-403">Device Operation</a></span>
<br /> <span class="sectionToc" >5.9 <a 
href="#x1-4000009" id="QQ2-1-406">Crypto Device</a></span>
<br />  <span class="subsectionToc" >5.9.1 <a 
href="#x1-4010001" id="QQ2-1-407">Device ID</a></span>
<br />  <span class="subsectionToc" >5.9.2 <a 
href="#x1-4020002" id="QQ2-1-408">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.9.3 <a 
href="#x1-4030003" id="QQ2-1-409">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.9.4 <a 
href="#x1-4050004" id="QQ2-1-411">Supported crypto services</a></span>
<br />  <span class="subsectionToc" >5.9.5 <a 
href="#x1-4100005" id="QQ2-1-416">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.9.6 <a 
href="#x1-4130006" id="QQ2-1-419">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.9.7 <a 
href="#x1-4150007" id="QQ2-1-421">Device Operation</a></span>
<br /> <span class="sectionToc" >5.10 <a 
href="#x1-44000010" id="QQ2-1-446">Socket Device</a></span>
<br />  <span class="subsectionToc" >5.10.1 <a 
href="#x1-4410001" id="QQ2-1-447">Device ID</a></span>
<br />  <span class="subsectionToc" >5.10.2 <a 
href="#x1-4420002" id="QQ2-1-448">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.10.3 <a 
href="#x1-4430003" id="QQ2-1-449">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.10.4 <a 
href="#x1-4440004" id="QQ2-1-450">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.10.5 <a 
href="#x1-4450005" id="QQ2-1-451">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.10.6 <a 
href="#x1-4460006" id="QQ2-1-452">Device Operation</a></span>
<br /> <span class="sectionToc" >5.11 <a 
href="#x1-46200011" id="QQ2-1-468">File System Device</a></span>
<br />  <span class="subsectionToc" >5.11.1 <a 
href="#x1-4630001" id="QQ2-1-469">Device ID</a></span>
<br />  <span class="subsectionToc" >5.11.2 <a 
href="#x1-4640002" id="QQ2-1-470">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.11.3 <a 
href="#x1-4650003" id="QQ2-1-471">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.11.4 <a 
href="#x1-4660004" id="QQ2-1-472">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.11.5 <a 
href="#x1-4690005" id="QQ2-1-475">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.11.6 <a 
href="#x1-4700006" id="QQ2-1-476">Device Operation</a></span>
                                                                  

                                                                  
<br /> <span class="sectionToc" >5.12 <a 
href="#x1-48200012" id="QQ2-1-488">RPMB Device</a></span>
<br />  <span class="subsectionToc" >5.12.1 <a 
href="#x1-4830001" id="QQ2-1-489">Device ID</a></span>
<br />  <span class="subsectionToc" >5.12.2 <a 
href="#x1-4840002" id="QQ2-1-490">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.12.3 <a 
href="#x1-4850003" id="QQ2-1-491">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.12.4 <a 
href="#x1-4860004" id="QQ2-1-492">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.12.5 <a 
href="#x1-4870005" id="QQ2-1-493">Device Requirements: Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.12.6 <a 
href="#x1-4880006" id="QQ2-1-494">Device Operation</a></span>
<br /> <span class="sectionToc" >5.13 <a 
href="#x1-49700013" id="QQ2-1-503">IOMMU device</a></span>
<br />  <span class="subsectionToc" >5.13.1 <a 
href="#x1-4980001" id="QQ2-1-504">Device ID</a></span>
<br />  <span class="subsectionToc" >5.13.2 <a 
href="#x1-4990002" id="QQ2-1-505">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.13.3 <a 
href="#x1-5000003" id="QQ2-1-506">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.13.4 <a 
href="#x1-5030004" id="QQ2-1-509">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.13.5 <a 
href="#x1-5060005" id="QQ2-1-512">Device initialization</a></span>
<br />  <span class="subsectionToc" >5.13.6 <a 
href="#x1-5080006" id="QQ2-1-514">Device operations</a></span>
<br /> <span class="sectionToc" >5.14 <a 
href="#x1-53300014" id="QQ2-1-539">Sound Device</a></span>
<br />  <span class="subsectionToc" >5.14.1 <a 
href="#x1-5340001" id="QQ2-1-540">Device ID</a></span>
<br />  <span class="subsectionToc" >5.14.2 <a 
href="#x1-5350002" id="QQ2-1-541">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.14.3 <a 
href="#x1-5360003" id="QQ2-1-542">Feature Bits</a></span>
<br />  <span class="subsectionToc" >5.14.4 <a 
href="#x1-5370004" id="QQ2-1-543">Device Configuration Layout</a></span>
<br />  <span class="subsectionToc" >5.14.5 <a 
href="#x1-5380005" id="QQ2-1-544">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.14.6 <a 
href="#x1-5400006" id="QQ2-1-546">Device Operation</a></span>
<br /> <span class="sectionToc" >5.15 <a 
href="#x1-57200015" id="QQ2-1-578">Memory Device</a></span>
<br />  <span class="subsectionToc" >5.15.1 <a 
href="#x1-5730001" id="QQ2-1-579">Device ID</a></span>
<br />  <span class="subsectionToc" >5.15.2 <a 
href="#x1-5740002" id="QQ2-1-580">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.15.3 <a 
href="#x1-5750003" id="QQ2-1-581">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.15.4 <a 
href="#x1-5760004" id="QQ2-1-582">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.15.5 <a 
href="#x1-5790005" id="QQ2-1-585">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.15.6 <a 
href="#x1-5820006" id="QQ2-1-588">Device Operation</a></span>
<br /> <span class="sectionToc" >5.16 <a 
href="#x1-59700016" id="QQ2-1-603">I2C Adapter Device</a></span>
<br />  <span class="subsectionToc" >5.16.1 <a 
href="#x1-5980001" id="QQ2-1-604">Device ID</a></span>
<br />  <span class="subsectionToc" >5.16.2 <a 
href="#x1-5990002" id="QQ2-1-605">Virtqueues</a></span>
                                                                  

                                                                  
<br />  <span class="subsectionToc" >5.16.3 <a 
href="#x1-6000003" id="QQ2-1-606">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.16.4 <a 
href="#x1-6010004" id="QQ2-1-607">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.16.5 <a 
href="#x1-6020005" id="QQ2-1-608">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.16.6 <a 
href="#x1-6030006" id="QQ2-1-609">Device Operation</a></span>
<br /> <span class="sectionToc" >5.17 <a 
href="#x1-60800017" id="QQ2-1-614">SCMI Device</a></span>
<br />  <span class="subsectionToc" >5.17.1 <a 
href="#x1-6090001" id="QQ2-1-615">Device ID</a></span>
<br />  <span class="subsectionToc" >5.17.2 <a 
href="#x1-6100002" id="QQ2-1-616">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.17.3 <a 
href="#x1-6110003" id="QQ2-1-617">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.17.4 <a 
href="#x1-6130004" id="QQ2-1-619">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.17.5 <a 
href="#x1-6140005" id="QQ2-1-620">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.17.6 <a 
href="#x1-6150006" id="QQ2-1-621">Device Operation</a></span>
<br /> <span class="sectionToc" >5.18 <a 
href="#x1-62500018" id="QQ2-1-631">GPIO Device</a></span>
<br />  <span class="subsectionToc" >5.18.1 <a 
href="#x1-6260001" id="QQ2-1-632">Device ID</a></span>
<br />  <span class="subsectionToc" >5.18.2 <a 
href="#x1-6270002" id="QQ2-1-633">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.18.3 <a 
href="#x1-6280003" id="QQ2-1-634">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.18.4 <a 
href="#x1-6290004" id="QQ2-1-635">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.18.5 <a 
href="#x1-6300005" id="QQ2-1-636">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.18.6 <a 
href="#x1-6310006" id="QQ2-1-637">Device Operation: requestq</a></span>
<br />  <span class="subsectionToc" >5.18.7 <a 
href="#x1-6410007" id="QQ2-1-647">Device Operation: eventq</a></span>
<br /> <span class="sectionToc" >5.19 <a 
href="#x1-64500019" id="QQ2-1-651">PMEM Device</a></span>
<br />  <span class="subsectionToc" >5.19.1 <a 
href="#x1-6460001" id="QQ2-1-652">Device ID</a></span>
<br />  <span class="subsectionToc" >5.19.2 <a 
href="#x1-6470002" id="QQ2-1-653">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.19.3 <a 
href="#x1-6480003" id="QQ2-1-654">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.19.4 <a 
href="#x1-6490004" id="QQ2-1-655">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.19.5 <a 
href="#x1-6500005" id="QQ2-1-656">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.19.6 <a 
href="#x1-6530006" id="QQ2-1-659">Driver Operations</a></span>
<br />  <span class="subsectionToc" >5.19.7 <a 
href="#x1-6540007" id="QQ2-1-660">Device Operations</a></span>
<br />  <span class="subsectionToc" >5.19.8 <a 
href="#x1-6580008" id="QQ2-1-664">Possible security implications</a></span>
<br />  <span class="subsectionToc" >5.19.9 <a 
href="#x1-6590009" id="QQ2-1-665">Countermeasures</a></span>
<br /> <span class="sectionToc" >5.20 <a 
href="#x1-66400020" id="QQ2-1-670">Vhost-user Device Backend</a></span>
<br />  <span class="subsectionToc" >5.20.1 <a 
href="#x1-6650001" id="QQ2-1-671">Device ID</a></span>
                                                                  

                                                                  
<br />  <span class="subsectionToc" >5.20.2 <a 
href="#x1-6660002" id="QQ2-1-672">Virtqueues</a></span>
<br />  <span class="subsectionToc" >5.20.3 <a 
href="#x1-6670003" id="QQ2-1-673">Feature bits</a></span>
<br />  <span class="subsectionToc" >5.20.4 <a 
href="#x1-6680004" id="QQ2-1-674">Device configuration layout</a></span>
<br />  <span class="subsectionToc" >5.20.5 <a 
href="#x1-6700005" id="QQ2-1-676">Device Initialization</a></span>
<br />  <span class="subsectionToc" >5.20.6 <a 
href="#x1-6720006" id="QQ2-1-678">Device Operation</a></span>
<br />  <span class="subsectionToc" >5.20.7 <a 
href="#x1-6740007" id="QQ2-1-680">Additional Device Resources</a></span>
<br /><span class="chapterToc" >6 <a 
href="#x1-6800006" id="QQ2-1-686">Reserved Feature Bits</a></span>
<br /> <span class="sectionToc" >6.1 <a 
href="#x1-6810001" id="QQ2-1-687">Driver Requirements: Reserved Feature Bits</a></span>
<br /> <span class="sectionToc" >6.2 <a 
href="#x1-6820002" id="QQ2-1-688">Device Requirements: Reserved Feature Bits</a></span>
<br /> <span class="sectionToc" >6.3 <a 
href="#x1-6830003" id="QQ2-1-689">Legacy Interface: Reserved Feature Bits</a></span>
<br /><span class="chapterToc" >7 <a 
href="#x1-6840007" id="QQ2-1-690">Conformance</a></span>
<br /> <span class="sectionToc" >7.1 <a 
href="#x1-6850001" id="QQ2-1-691">Conformance Targets</a></span>
<br /> <span class="sectionToc" >7.2 <a 
href="#x1-6860002" id="QQ2-1-692">Clause 1: Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.1 <a 
href="#x1-6870001" id="QQ2-1-693">Clause 2: PCI Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.2 <a 
href="#x1-6880002" id="QQ2-1-694">Clause 3: MMIO Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.3 <a 
href="#x1-6890003" id="QQ2-1-695">Clause 4: Channel I/O Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.4 <a 
href="#x1-6900004" id="QQ2-1-696">Clause 5: Network Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.5 <a 
href="#x1-6910005" id="QQ2-1-697">Clause 6: Block Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.6 <a 
href="#x1-6920006" id="QQ2-1-698">Clause 7: Console Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.7 <a 
href="#x1-6930007" id="QQ2-1-699">Clause 8: Entropy Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.8 <a 
href="#x1-6940008" id="QQ2-1-700">Clause 9: Traditional Memory Balloon Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.9 <a 
href="#x1-6950009" id="QQ2-1-701">Clause 10: SCSI Host Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.10 <a 
href="#x1-69600010" id="QQ2-1-702">Clause 11: Input Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.11 <a 
href="#x1-69700011" id="QQ2-1-703">Clause 12: Crypto Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.12 <a 
href="#x1-69800012" id="QQ2-1-704">Clause 13: Socket Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.13 <a 
href="#x1-69900013" id="QQ2-1-705">Clause 14: File System Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.14 <a 
href="#x1-70000014" id="QQ2-1-706">Clause 15: RPMB Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.15 <a 
href="#x1-70100015" id="QQ2-1-707">Clause 16: IOMMU Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.16 <a 
href="#x1-70200016" id="QQ2-1-708">Clause 17: Sound Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.17 <a 
href="#x1-70300017" id="QQ2-1-709">Clause 18: Memory Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.18 <a 
href="#x1-70400018" id="QQ2-1-710">Clause 19: I2C Adapter Driver Conformance</a></span>
                                                                  

                                                                  
<br />  <span class="subsectionToc" >7.2.19 <a 
href="#x1-70500019" id="QQ2-1-711">Clause 20: SCMI Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.20 <a 
href="#x1-70600020" id="QQ2-1-712">Clause 21: GPIO Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.21 <a 
href="#x1-70700021" id="QQ2-1-713">Clause 22: PMEM Driver Conformance</a></span>
<br />  <span class="subsectionToc" >7.2.22 <a 
href="#x1-70800022" id="QQ2-1-714">Clause 23: Vhost-user Backend Driver Conformance</a></span>
<br /> <span class="sectionToc" >7.3 <a 
href="#x1-7090003" id="QQ2-1-715">Clause 24: Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.1 <a 
href="#x1-7100001" id="QQ2-1-716">Clause 25: PCI Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.2 <a 
href="#x1-7110002" id="QQ2-1-717">Clause 26: MMIO Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.3 <a 
href="#x1-7120003" id="QQ2-1-718">Clause 27: Channel I/O Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.4 <a 
href="#x1-7130004" id="QQ2-1-719">Clause 28: Network Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.5 <a 
href="#x1-7140005" id="QQ2-1-720">Clause 29: Block Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.6 <a 
href="#x1-7150006" id="QQ2-1-721">Clause 30: Console Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.7 <a 
href="#x1-7160007" id="QQ2-1-722">Clause 31: Entropy Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.8 <a 
href="#x1-7170008" id="QQ2-1-723">Clause 32: Traditional Memory Balloon Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.9 <a 
href="#x1-7180009" id="QQ2-1-724">Clause 33: SCSI Host Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.10 <a 
href="#x1-71900010" id="QQ2-1-725">Clause 34: Input Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.11 <a 
href="#x1-72000011" id="QQ2-1-726">Clause 35: Crypto Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.12 <a 
href="#x1-72100012" id="QQ2-1-727">Clause 36: Socket Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.13 <a 
href="#x1-72200013" id="QQ2-1-728">Clause 37: File System Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.14 <a 
href="#x1-72300014" id="QQ2-1-729">Clause 38: RPMB Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.15 <a 
href="#x1-72400015" id="QQ2-1-730">Clause 39: IOMMU Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.16 <a 
href="#x1-72500016" id="QQ2-1-731">Clause 40: Sound Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.17 <a 
href="#x1-72600017" id="QQ2-1-732">Clause 41: Memory Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.18 <a 
href="#x1-72700018" id="QQ2-1-733">Clause 42: I2C Adapter Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.19 <a 
href="#x1-72800019" id="QQ2-1-734">Clause 43: SCMI Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.20 <a 
href="#x1-72900020" id="QQ2-1-735">Clause 44: GPIO Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.21 <a 
href="#x1-73000021" id="QQ2-1-736">Clause 45: PMEM Device Conformance</a></span>
<br />  <span class="subsectionToc" >7.3.22 <a 
href="#x1-73100022" id="QQ2-1-737">Clause 46: Vhost-user Backend Device Conformance</a></span>
<br /> <span class="sectionToc" >7.4 <a 
href="#x1-7320004" id="QQ2-1-738">Clause 47: Legacy Interface: Transitional Device and Transitional Driver Conformance</a></span>
<br /><span class="appendixToc" >A <a 
href="#x1-733000A" id="QQ2-1-739">virtio_queue.h</a></span>
<br /><span class="appendixToc" >B <a 
href="#x1-734000B" id="QQ2-1-741">Creating New Device Types</a></span>
<br /> <span class="sectionToc" >B.1 <a 
href="#x1-7350001" id="QQ2-1-742">How Many Virtqueues?</a></span>
                                                                  

                                                                  
<br /> <span class="sectionToc" >B.2 <a 
href="#x1-7360002" id="QQ2-1-743">What Device Configuration Space Layout?</a></span>
<br /> <span class="sectionToc" >B.3 <a 
href="#x1-7370003" id="QQ2-1-744">What Device Number?</a></span>
<br /> <span class="sectionToc" >B.4 <a 
href="#x1-7380004" id="QQ2-1-745">How many MSI-X vectors? (for PCI)</a></span>
<br /> <span class="sectionToc" >B.5 <a 
href="#x1-7390005" id="QQ2-1-746">Device Improvements</a></span>
<br /><span class="appendixToc" >C <a 
href="#x1-740000C" id="QQ2-1-747">Acknowledgements</a></span>
<br /><span class="appendixToc" >D <a 
href="#x1-743000D" id="QQ2-1-752">Revision History</a></span>
</div>
                                                                  

                                                                  
                                                                  

                                                                  
<!--l. 1--><p class="noindent" ><h2 class="chapterHead"><hr><span class="titlemark">1</span> <a 
 id="x1-20001"></a>Introduction</h2>
This document describes the specifications of the “virtio” family of devices. These
devices are found in virtual environments, yet by design they look like physical
devices to the guest within the virtual machine - and this document treats them as
such. This similarity allows the guest to use standard drivers and discovery
mechanisms.
<!--l. 8--><p class="noindent" >The purpose of virtio and this specification is that virtual environments
and guests should have a straightforward, efficient, standard and extensible
mechanism for virtual devices, rather than boutique per-environment or per-OS
mechanisms.
     <dl class="description"><dt class="description">
<span 
class="aeb10-">Straightforward:</span> </dt><dd 
class="description">Virtio devices use normal bus mechanisms of interrupts and
     DMA which should be familiar to any device driver author. There is no
     exotic page-flipping or COW mechanism: it’s just a normal device.<span class="footnote-mark"><a 
href="#fn1x1" id="fn1x1-bk"><sup class="textsuperscript">1</sup></a></span><a 
 id="x1-2001f1"></a>
     </dd><dt class="description">
<span 
class="aeb10-">Efficient:</span> </dt><dd 
class="description">Virtio devices consist of rings of descriptors for both input and output,
     which are neatly laid out to avoid cache effects from both driver and device
     writing to the same cache lines.
     </dd><dt class="description">
<span 
class="aeb10-">Standard:</span> </dt><dd 
class="description">Virtio  makes  no  assumptions  about  the  environment  in  which  it
     operates, beyond supporting the bus to which device is attached. In this
     specification, virtio devices are implemented over MMIO, Channel I/O and
     PCI bus transports <span class="footnote-mark"><a 
href="#fn2x1" id="fn2x1-bk"><sup class="textsuperscript">2</sup></a></span><a 
 id="x1-2002f2"></a>,
     earlier drafts have been implemented on other buses not included here.
     </dd><dt class="description">
<span 
class="aeb10-">Extensible:</span> </dt><dd 
class="description">Virtio devices contain feature bits which are acknowledged by the
     guest  operating  system  during  device  setup.  This  allows  forwards  and
     backwards compatibility: the device offers all the features it knows about,
     and the driver acknowledges those it understands and wishes to use.</dd></dl>
<a 
 id="x1-2003r1"></a>
<h3 class="sectionHead"><span class="titlemark">1.1   </span> <a 
 id="x1-30001"></a>Normative References</h3>
<a 
 id="x1-3001r1"></a><!--l. 40--><div class="longtable"> <table id="TBL-2" class="longtable" 
cellspacing="0" cellpadding="0"  
><colgroup id="TBL-2-1g"><col 
id="TBL-2-1"><col 
id="TBL-2-2"></colgroup>
<tr  
 style="vertical-align:baseline;" id="TBL-2-1-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-1-1"  
class="td11"> <a 
 id="likesection.1"></a><span 
class="aeb10-">[RFC2119]                </span></td><td  style="white-space:normal; text-align:left;" id="TBL-2-1-2"  
class="td11">
 <!--l. 41--><p class="noindent" >Bradner S., “Key words for use in RFCs to Indicate Requirement Levels”, BCP 14,
  RFC 2119, March 1997. <br 
class="newline" /><a 
href="http://www.ietf.org/rfc/rfc2119.txt" class="url" >http://www.ietf.org/rfc/rfc2119.txt</a>                                                                </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-2-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-2-1"  
class="td11"> <a 
 id="likesection.2"></a><span 
class="aeb10-">[RFC4122]                </span></td><td  style="white-space:normal; text-align:left;" id="TBL-2-2-2"  
class="td11">
 <!--l. 44--><p class="noindent" >Leach, P., Mealling, M., and R. Salz, “A Universally Unique IDentifier (UUID) URN
  Namespace”, RFC 4122, DOI 10.17487/RFC4122, July 2005. <br 
class="newline" /><a 
href="http://www.ietf.org/rfc/rfc4122.txt" class="url" >http://www.ietf.org/rfc/rfc4122.txt</a>                                                                </td>
                                                                  

                                                                  
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-3-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-3-1"  
class="td11"> <a 
 id="likesection.3"></a><span 
class="aeb10-">[S390 PoP]                </span></td><td  style="white-space:normal; text-align:left;" id="TBL-2-3-2"  
class="td11">
 <!--l. 47--><p class="noindent" >z/Architecture Principles of Operation, IBM Publication SA22-7832, <br 
class="newline" /><a 
href="http://publibfi.boulder.ibm.com/epubs/pdf/dz9zr009.pdf" class="url" >http://publibfi.boulder.ibm.com/epubs/pdf/dz9zr009.pdf</a>, and any future revisions  </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-4-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-4-1"  
class="td11"> <a 
 id="likesection.4"></a><span 
class="aeb10-">[S390 Common I/O]   </span></td><td  style="white-space:normal; text-align:left;" id="TBL-2-4-2"  
class="td11">
 <!--l. 48--><p class="noindent" >ESA/390 Common I/O-Device and Self-Description, IBM Publication SA22-7204, <br 
class="newline" /><a 
href="http://publibfp.dhe.ibm.com/cgi-bin/bookmgr/BOOKS/dz9ar501/CCONTENTS" class="url" >http://publibfp.dhe.ibm.com/cgi-bin/bookmgr/BOOKS/dz9ar501/CCONTENTS</a>,
  and any future revisions                                                                               </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-5-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-5-1"  
class="td11"> <a 
 id="likesection.5"></a><span 
class="aeb10-">[PCI]                       </span></td><td  style="white-space:normal; text-align:left;" id="TBL-2-5-2"  
class="td11">
 <!--l. 50--><p class="noindent" >Conventional PCI Specifications, <br 
class="newline" /><a 
href="http://www.pcisig.com/specifications/conventional/" class="url" >http://www.pcisig.com/specifications/conventional/</a>, PCI-SIG                             </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-6-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-6-1"  
class="td11"> <a 
 id="likesection.6"></a><span 
class="aeb10-">[PCIe]                      </span></td><td  style="white-space:normal; text-align:left;" id="TBL-2-6-2"  
class="td11">
 <!--l. 54--><p class="noindent" >PCI Express Specifications <br 
class="newline" /><a 
href="http://www.pcisig.com/specifications/pciexpress/" class="url" >http://www.pcisig.com/specifications/pciexpress/</a>, PCI-SIG                                </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-7-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-7-1"  
class="td11"> <a 
 id="likesection.7"></a><span 
class="aeb10-">[IEEE 802]                </span></td><td  style="white-space:normal; text-align:left;" id="TBL-2-7-2"  
class="td11">
 <!--l. 58--><p class="noindent" >IEEE  Standard  for  Local  and  Metropolitan  Area  Networks:  Overview  and
  Architecture, <br 
class="newline" /><a 
href="http://www.ieee802.org/" class="url" >http://www.ieee802.org/</a>, IEEE                                                                     </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-8-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-8-1"  
class="td11"> <a 
 id="likesection.8"></a><span 
class="aeb10-">[SAM]                      </span></td><td  style="white-space:normal; text-align:left;" id="TBL-2-8-2"  
class="td11">
 <!--l. 62--><p class="noindent" >SCSI Architectural Model, <br 
class="newline" /><a 
href="http://www.t10.org/cgi-bin/ac.pl?t=f&f=sam4r05.pdf" class="url" >http://www.t10.org/cgi-bin/ac.pl?t=f&f=sam4r05.pdf</a>                                       </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-9-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-9-1"  
class="td11"> <a 
 id="likesection.9"></a><span 
class="aeb10-">[SCSI MMC]             </span></td><td  style="white-space:normal; text-align:left;" id="TBL-2-9-2"  
class="td11">
 <!--l. 65--><p class="noindent" >SCSI Multimedia Commands, <br 
class="newline" /><a 
href="http://www.t10.org/cgi-bin/ac.pl?t=f&f=mmc6r00.pdf" class="url" >http://www.t10.org/cgi-bin/ac.pl?t=f&f=mmc6r00.pdf</a>                                      </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-10-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-10-1"  
class="td11"> <a 
 id="likesection.10"></a><span 
class="aeb10-">[FUSE]                     </span></td><td  style="white-space:normal; text-align:left;" id="TBL-2-10-2"  
class="td11">
 <!--l. 68--><p class="noindent" >Linux FUSE interface, <br 
class="newline" /><a 
href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/uapi/linux/fuse.h" class="url" >https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/uapi/linux/fuse.h</a> </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-11-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-11-1"  
class="td11"> <a 
 id="likesection.11"></a><span 
class="aeb10-">[eMMC]                   </span></td><td  style="white-space:normal; text-align:left;" id="TBL-2-11-2"  
class="td11">
 <!--l. 71--><p class="noindent" >eMMC Electrical Standard (5.1), JESD84-B51, <br 
class="newline" /><a 
href="http://www.jedec.org/sites/default/files/docs/JESD84-B51.pdf" class="url" >http://www.jedec.org/sites/default/files/docs/JESD84-B51.pdf</a>                           </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-12-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-12-1"  
class="td11"> <a 
 id="likesection.12"></a><span 
class="aeb10-">[HDA]                      </span></td><td  style="white-space:normal; text-align:left;" id="TBL-2-12-2"  
class="td11">
 <!--l. 74--><p class="noindent" >High Definition Audio Specification, <br 
class="newline" /><a 
href="https://www.intel.com/content/dam/www/public/us/en/documents/product-specifications/high-definition-audio-specification.pdf" class="url" >https://www.intel.com/content/dam/www/public/us/en/documents/product-specifications/high-definition-audio-specification.pdf</a> </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-13-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-13-1"  
class="td11"> <a 
 id="likesection.13"></a><span 
class="aeb10-">[I2C]                        </span></td><td  style="white-space:normal; text-align:left;" id="TBL-2-13-2"  
class="td11">
 <!--l. 77--><p class="noindent" >I2C-bus specification and user manual, <br 
class="newline" /><a 
href="https://www.nxp.com/docs/en/user-guide/UM10204.pdf" class="url" >https://www.nxp.com/docs/en/user-guide/UM10204.pdf</a>                                   </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-14-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-14-1"  
class="td11"> <a 
 id="likesection.14"></a><span 
class="aeb10-">[SCMI]                    </span></td><td  style="white-space:normal; text-align:left;" id="TBL-2-14-2"  
class="td11">
 <!--l. 80--><p class="noindent" >Arm System Control and Management Interface, DEN0056, <br 
class="newline" /><a 
href="https://developer.arm.com/docs/den0056/c" class="url" >https://developer.arm.com/docs/den0056/c</a>, version C and any future revisions      </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-15-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-15-1"  
class="td11"> <a 
 id="likesection.15"></a><span 
class="aeb10-">[Vhost-user Protocol]  </span></td><td  style="white-space:normal; text-align:left;" id="TBL-2-15-2"  
class="td11">
 <!--l. 83--><p class="noindent" >Vhost-user Protocol, <br 
class="newline" /><a 
href="https://qemu.readthedocs.io/en/latest/interop/vhost-user.html" class="url" >https://qemu.readthedocs.io/en/latest/interop/vhost-user.html</a>                           </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-16-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-16-1"  
class="td11">                  </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-17-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-17-1"  
class="td11">                  </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-18-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-18-1"  
class="td11">                  </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-19-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-19-1"  
class="td11">                  </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-2-20-"><td  style="white-space:nowrap; text-align:left;" id="TBL-2-20-1"  
class="td11">                    </td><td  style="white-space:normal; text-align:left;" id="TBL-2-20-2"  
class="td11">
</td></tr>
</table></div>
<a 
 id="x1-3002r3"></a>
                                                                  

                                                                  
<h3 class="sectionHead"><span class="titlemark">1.2   </span> <a 
 id="x1-40002"></a>Non-Normative References</h3>
<a 
 id="x1-4001r2"></a><!--l. 91--><div class="longtable"> <table id="TBL-3" class="longtable" 
cellspacing="0" cellpadding="0"  
><colgroup id="TBL-3-1g"><col 
id="TBL-3-1"><col 
id="TBL-3-2"></colgroup>
<tr  
 style="vertical-align:baseline;" id="TBL-3-1-"><td  style="white-space:nowrap; text-align:left;" id="TBL-3-1-1"  
class="td11"> <a 
 id="likesection.16"></a><span 
class="aeb10-">[Virtio PCI Draft]  </span></td><td  style="white-space:normal; text-align:left;" id="TBL-3-1-2"  
class="td11">
 <!--l. 92--><p class="noindent" >Virtio PCI Draft Specification <br 
class="newline" /><a 
href="http://ozlabs.org/~rusty/virtio-spec/virtio-0.9.5.pdf" class="url" >http://ozlabs.org/~rusty/virtio-spec/virtio-0.9.5.pdf</a>                                          </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-3-2-"><td  style="white-space:nowrap; text-align:left;" id="TBL-3-2-1"  
class="td11">               </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-3-3-"><td  style="white-space:nowrap; text-align:left;" id="TBL-3-3-1"  
class="td11">               </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-3-4-"><td  style="white-space:nowrap; text-align:left;" id="TBL-3-4-1"  
class="td11">               </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-3-5-"><td  style="white-space:nowrap; text-align:left;" id="TBL-3-5-1"  
class="td11">               </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-3-6-"><td  style="white-space:nowrap; text-align:left;" id="TBL-3-6-1"  
class="td11">                  </td><td  style="white-space:normal; text-align:left;" id="TBL-3-6-2"  
class="td11">
</td></tr>
</table></div>
<a 
 id="x1-4002r4"></a>
<h3 class="sectionHead"><span class="titlemark">1.3   </span> <a 
 id="x1-50003"></a>Terminology</h3>
<!--l. 98--><p class="noindent" >The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”,
“SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL” in
this document are to be interpreted as described in <a 
href="#x1-3001r1">[RFC2119]</a>.
<a 
 id="x1-5001r1"></a>
<h4 class="subsectionHead"><span class="titlemark">1.3.1   </span> <a 
 id="x1-60001"></a>Legacy Interface: Terminology</h4>
<!--l. 103--><p class="noindent" >Specification drafts preceding version 1.0 of this specification (e.g. see <a 
href="#x1-4001r2">[Virtio PCI
Draft]</a>) defined a similar, but different interface between the driver and the device.
Since these are widely deployed, this specification accommodates OPTIONAL
features to simplify transition from these earlier draft interfaces.
<!--l. 111--><p class="noindent" >Specifically devices and drivers MAY support:
     <dl class="description"><dt class="description">
<span 
class="aeb10-">Legacy Interface</span> </dt><dd 
class="description">is an interface specified by an earlier draft of this specification
     (before 1.0)
     </dd><dt class="description">
<span 
class="aeb10-">Legacy Device</span> </dt><dd 
class="description">is a device implemented before this specification was released,
     and implementing a legacy interface on the host side
     </dd><dt class="description">
<span 
class="aeb10-">Legacy Driver</span> </dt><dd 
class="description">is a driver implemented before this specification was released,
     and implementing a legacy interface on the guest side</dd></dl>
<!--l. 124--><p class="noindent" >Legacy devices and legacy drivers are not compliant with this specification.
<!--l. 127--><p class="noindent" >To simplify transition from these earlier draft interfaces, a device MAY implement:
     <dl class="description"><dt class="description">
<span 
class="aeb10-">Transitional Device</span> </dt><dd 
class="description">a  device  supporting  both  drivers  conforming  to  this
     specification, and allowing legacy drivers.</dd></dl>
<!--l. 136--><p class="noindent" >Similarly, a driver MAY implement:
                                                                  

                                                                  
     <dl class="description"><dt class="description">
<span 
class="aeb10-">Transitional Driver</span> </dt><dd 
class="description">a  driver  supporting  both  devices  conforming  to  this
     specification, and legacy devices.</dd></dl>
<span 
class="aeb10-">Note:</span> Legacy interfaces are not required; ie. don’t implement them unless you
      have a need for backwards compatibility!
<!--l. 148--><p class="noindent" >Devices or drivers with no legacy compatibility are referred to as non-transitional
devices and drivers, respectively.
<a 
 id="x1-6001r6"></a>
<h4 class="subsectionHead"><span class="titlemark">1.3.2   </span> <a 
 id="x1-70002"></a>Transition from earlier specification drafts</h4>
<!--l. 153--><p class="noindent" >For devices and drivers already implementing the legacy interface, some changes will
have to be made to support this specification.
<!--l. 157--><p class="noindent" >In this case, it might be beneficial for the reader to focus on sections tagged "Legacy
Interface" in the section title. These highlight the changes made since the earlier
drafts.
<a 
 id="x1-7001r5"></a>
<h3 class="sectionHead"><span class="titlemark">1.4   </span> <a 
 id="x1-80004"></a>Structure Specifications</h3>
<!--l. 163--><p class="noindent" >Many device and driver in-memory structure layouts are documented using the C
struct syntax. All structures are assumed to be without additional padding.
To stress this, cases where common C compilers are known to insert extra
padding within structures are tagged using the GNU C __attribute__((packed))
syntax.
<!--l. 169--><p class="noindent" >For the integer data types used in the structure definitions, the following conventions
are used:
     <dl class="description"><dt class="description">
<span 
class="aeb10-">u8, u16, u32, u64</span> </dt><dd 
class="description">An unsigned integer of the specified length in bits.
     </dd><dt class="description">
<span 
class="aeb10-">le16, le32, le64</span> </dt><dd 
class="description">An  unsigned  integer  of  the  specified  length  in  bits,  in
     little-endian byte order.
     </dd><dt class="description">
<span 
class="aeb10-">be16, be32, be64</span> </dt><dd 
class="description">An  unsigned  integer  of  the  specified  length  in  bits,  in
     big-endian byte order.</dd></dl>
<!--l. 182--><p class="noindent" >Some of the fields to be defined in this specification don’t start or don’t end on a byte
boundary. Such fields are called bit-fields. A set of bit-fields is always a sub-division
of an integer typed field.
<!--l. 186--><p class="noindent" >Bit-fields within integer fields are always listed in order, from the least significant
to the most significant bit. The bit-fields are considered unsigned integers
of the specified width with the next in significance relationship of the bits
preserved.
                                                                  

                                                                  
<!--l. 192--><p class="noindent" >For example: <!--l. 193-->
<div class="lstlisting" id="listing-1"><span class="label"><a 
 id="x1-8001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">S</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-8002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-8003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">A</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">15;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-8004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">B</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-8005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">x</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-8006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">y</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-8007r7"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 202--><p class="noindent" >documents the value A stored in the low 15 bit of <span 
class="aeti-10">x </span>and the value B stored in the
high bit of <span 
class="aeti-10">x</span>, the 16-bit integer <span 
class="aeti-10">x </span>in turn stored using the big-endian byte order at
the beginning of the structure S, and being followed immediately by an unsigned
integer <span 
class="aeti-10">y </span>stored in big-endian byte order at an offset of 2 bytes (16 bits) from the
beginning of the structure.
<!--l. 210--><p class="noindent" >Note that this notation somewhat resembles the C bitfield syntax but should not be
naively converted to a bitfield notation for portable code: it matches the way bitfields
are packed by C compilers on little-endian architectures but not the way bitfields are
packed by C compilers on big-endian architectures.
<!--l. 216--><p class="noindent" >Assuming that CPU_TO_BE16 converts a 16-bit integer from a native CPU to the
big-endian byte order, the following is the equivalent portable C code to generate a
value to be stored into <span 
class="aeti-10">x</span>: <!--l. 219-->
<div class="lstlisting" id="listing-2"><span class="label"><a 
 id="x1-8008r1"></a></span><span 
class="pcrr8t-x-x-80">CPU_TO_BE16</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">B</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">15</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">|</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">A</span><span 
class="pcrr8t-x-x-80">)</span>
</div>
<a 
 id="x1-8009r8"></a>
<h3 class="sectionHead"><span class="titlemark">1.5   </span> <a 
 id="x1-90005"></a>Constant Specifications</h3>
<!--l. 224--><p class="noindent" >In many cases, numeric values used in the interface between the device and the driver
are documented using the C #define and /* */ comment syntax. Multiple
related values are grouped together with a common name as a prefix, using _
as a separator. Using _XXX as a suffix refers to all values in a group. For
example:
<!--l. 231-->
<div class="lstlisting" id="listing-3"><span class="label"><a 
 id="x1-9001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Field</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Fld</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">value</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">A</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">description</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-9002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_FLD_A</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-9003r3"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Field</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Fld</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">value</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">B</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">description</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-9004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_FLD_B</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1)</span>
</div>
<!--l. 237--><p class="noindent" >documents two numeric values for a field <span 
class="aeti-10">Fld</span>, with <span 
class="aeti-10">Fld </span>having value 1 referring to <span 
class="aeti-10">A</span>
and <span 
class="aeti-10">Fld </span>having value 2 referring to <span 
class="aeti-10">B</span>. Note that <span 
class="cmmi-10"><< </span>refers to the shift-left
operation.
<!--l. 242--><p class="noindent" >Further, in this case VIRTIO_FLD_A and VIRTIO_FLD_B refer to values 1 and 2 of
Fld respectively. Further, VIRTIO_FLD_XXX refers to either VIRTIO_FLD_A or
VIRTIO_FLD_B.
<!--l. 246--><p class="noindent" >
                                                                  

                                                                  
                                                                  

                                                                  
<!--l. 1--><p class="noindent" ><h2 class="chapterHead"><hr><span class="titlemark">2</span> <a 
 id="x1-100002"></a>Basic Facilities of a Virtio Device</h2>
A virtio device is discovered and identified by a bus-specific method (see
the bus specific sections: <a 
href="#x1-1150001">4.1<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus --></a> <a 
href="#x1-1150001">Virtio Over PCI Bus<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus --></a>, <a 
href="#x1-1690002">4.2<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over MMIO --></a> <a 
href="#x1-1690002">Virtio Over MMIO<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over MMIO --></a>
and <a 
href="#x1-1820003">4.3<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over Channel I/O --></a> <a 
href="#x1-1820003">Virtio Over Channel I/O<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over Channel I/O --></a>). Each device consists of the following
parts:
     <ul class="itemize1">
     <li class="itemize">Device status field
     </li>
     <li class="itemize">Feature bits
     </li>
     <li class="itemize">Notifications
     </li>
     <li class="itemize">Device Configuration space
     </li>
     <li class="itemize">One or more virtqueues</li></ul>
<a 
 id="x1-10001r9"></a>
<h3 class="sectionHead"><span class="titlemark">2.1   </span> <a 
 id="x1-110001"></a><span 
class="aeti-10">Device Status </span>Field</h3>
<!--l. 17--><p class="noindent" >During device initialization by a driver, the driver follows the sequence of steps
specified in <a 
href="#x1-1070001">3.1<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a>.
<!--l. 22--><p class="noindent" >The <span 
class="aeti-10">device status </span>field provides a simple low-level indication of the completed steps of
this sequence. It’s most useful to imagine it hooked up to traffic lights on the console
indicating the status of each device. The following bits are defined (listed below in
the order in which they would be typically set):
     <dl class="description"><dt class="description">
<span 
class="aeb10-">ACKNOWLEDGE (1)</span> </dt><dd 
class="description">Indicates that the guest OS has found the device and
     recognized it as a valid virtio device.
     </dd><dt class="description">
<span 
class="aeb10-">DRIVER (2)</span> </dt><dd 
class="description">Indicates that the guest OS knows how to drive the device.
     <span 
class="aeb10-">Note:</span> There could be a significant (or infinite) delay before setting this
          bit. For example, under Linux, drivers can be loadable modules.
     </dd><dt class="description">
<span 
class="aeb10-">FAILED (128)</span> </dt><dd 
class="description">Indicates that something went wrong in the guest, and it has given up
     on the device. This could be an internal error, or the driver didn’t
     like the device for some reason, or even a fatal error during device
     operation.
     </dd><dt class="description">
<span 
class="aeb10-">FEATURES_OK (8)</span> </dt><dd 
class="description">Indicates that the driver has acknowledged all the features it
                                                                  

                                                                  
     understands, and feature negotiation is complete.
     </dd><dt class="description">
<span 
class="aeb10-">DRIVER_OK (4)</span> </dt><dd 
class="description">Indicates that the driver is set up and ready to drive the
     device.
     </dd><dt class="description">
<span 
class="aeb10-">DEVICE_NEEDS_RESET (64)</span> </dt><dd 
class="description">Indicates that the device has experienced an error
     from which it can’t recover.</dd></dl>
<!--l. 54--><p class="noindent" >The <span 
class="aeti-10">device status </span>field starts out as 0, and is reinitialized to 0 by the device during
reset.
<a 
 id="x1-11001r7"></a>
<h4 class="subsectionHead"><span class="titlemark">2.1.1   </span> <a 
 id="x1-120001"></a>Driver Requirements: Device Status Field</h4>
<!--l. 58--><p class="noindent" >The driver MUST update <span 
class="aeti-10">device status</span>, setting bits to indicate the completed steps of
the driver initialization sequence specified in <a 
href="#x1-1070001">3.1<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a>. The driver MUST NOT clear a
<span 
class="aeti-10">device status </span>bit. If the driver sets the FAILED bit, the driver MUST later reset the
device before attempting to re-initialize.
<!--l. 67--><p class="noindent" >The driver SHOULD NOT rely on completion of operations of a device if
DEVICE_NEEDS_RESET is set.
<span 
class="aeb10-">Note:</span> For example, the driver can’t assume requests in flight will be completed
      if DEVICE_NEEDS_RESET is set, nor can it assume that they have not
      been completed. A good implementation will try to recover by issuing a
      reset.
<a 
 id="x1-12001r12"></a>
<h4 class="subsectionHead"><span class="titlemark">2.1.2   </span> <a 
 id="x1-130002"></a>Device Requirements: Device Status Field</h4>
<!--l. 78--><p class="noindent" >The device MUST NOT consume buffers or send any used buffer notifications to the
driver before DRIVER_OK.
<!--l. 81--><p class="noindent" >The device SHOULD set DEVICE_NEEDS_RESET when it enters an error state
that a reset is needed. If DRIVER_OK is set, after it sets DEVICE_NEEDS_RESET,
the device MUST send a device configuration change notification to the
driver.
<a 
 id="x1-13001r11"></a>
<h3 class="sectionHead"><span class="titlemark">2.2   </span> <a 
 id="x1-140002"></a>Feature Bits</h3>
<!--l. 87--><p class="noindent" >Each virtio device offers all the features it understands. During device initialization,
the driver reads this and tells the device the subset that it accepts. The only way to
renegotiate is to reset the device.
<!--l. 92--><p class="noindent" >This allows for forwards and backwards compatibility: if the device is enhanced with
a new feature bit, older drivers will not write that feature bit back to the device.
Similarly, if a driver is enhanced with a feature that the device doesn’t support, it see
the new feature is not offered.
                                                                  

                                                                  
<!--l. 97--><p class="noindent" >Feature bits are allocated as follows:
     <dl class="description"><dt class="description">
<span 
class="aeb10-">0 to 23, and 50 to 127</span> </dt><dd 
class="description">Feature bits for the specific device type
     </dd><dt class="description">
<span 
class="aeb10-">24 to 40</span> </dt><dd 
class="description">Feature  bits  reserved  for  extensions  to  the  queue  and  feature
     negotiation mechanisms
     </dd><dt class="description">
<span 
class="aeb10-">41 to 49, and 128 and above</span> </dt><dd 
class="description">Feature bits reserved for future extensions.</dd></dl>
<span 
class="aeb10-">Note:</span> For example, feature bit 0 for a network device (i.e. Device ID 1) indicates
      that the device supports checksumming of packets.
<!--l. 114--><p class="noindent" >In particular, new fields in the device configuration space are indicated by offering a
new feature bit.
<a 
 id="x1-14001r13"></a>
<h4 class="subsectionHead"><span class="titlemark">2.2.1   </span> <a 
 id="x1-150001"></a>Driver Requirements: Feature Bits</h4>
<!--l. 118--><p class="noindent" >The driver MUST NOT accept a feature which the device did not offer, and
MUST NOT accept a feature which requires another feature which was not
accepted.
<!--l. 122--><p class="noindent" >The driver SHOULD go into backwards compatibility mode if the device does not
offer a feature it understands, otherwise MUST set the FAILED <span 
class="aeti-10">device status </span>bit and
cease initialization.
<a 
 id="x1-15001r15"></a>
<h4 class="subsectionHead"><span class="titlemark">2.2.2   </span> <a 
 id="x1-160002"></a>Device Requirements: Feature Bits</h4>
<!--l. 127--><p class="noindent" >The device MUST NOT offer a feature which requires another feature which was not
offered. The device SHOULD accept any valid subset of features the driver accepts,
otherwise it MUST fail to set the FEATURES_OK <span 
class="aeti-10">device status </span>bit when the driver
writes it.
<!--l. 132--><p class="noindent" >If a device has successfully negotiated a set of features at least once (by accepting the
FEATURES_OK <span 
class="aeti-10">device status </span>bit during device initialization), then it SHOULD
NOT fail re-negotiation of the same set of features after a device or system
reset. Failure to do so would interfere with resuming from suspend and error
recovery.
<a 
 id="x1-16001r16"></a>
<h4 class="subsectionHead"><span class="titlemark">2.2.3   </span> <a 
 id="x1-170003"></a>Legacy Interface: A Note on Feature Bits</h4>
<!--l. 143--><p class="noindent" >Transitional Drivers MUST detect Legacy Devices by detecting that the feature bit
VIRTIO_F_VERSION_1 is not offered. Transitional devices MUST detect Legacy
drivers by detecting that VIRTIO_F_VERSION_1 has not been acknowledged by the
driver.
                                                                  

                                                                  
<!--l. 148--><p class="noindent" >In this case device is used through the legacy interface.
<!--l. 150--><p class="noindent" >Legacy interface support is OPTIONAL. Thus, both transitional and non-transitional
devices and drivers are compliant with this specification.
<!--l. 154--><p class="noindent" >Requirements pertaining to transitional devices and drivers is contained in sections
named ’Legacy Interface’ like this one.
<!--l. 157--><p class="noindent" >When device is used through the legacy interface, transitional devices and
transitional drivers MUST operate according to the requirements documented within
these legacy interface sections. Specification text within these sections generally does
not apply to non-transitional devices.
<a 
 id="x1-17001r14"></a>
<h3 class="sectionHead"><span class="titlemark">2.3   </span> <a 
 id="x1-180003"></a>Notifications</h3>
<!--l. 165--><p class="noindent" >The notion of sending a notification (driver to device or device to driver) plays an
important role in this specification. The modus operandi of the notifications is
transport specific.
<!--l. 169--><p class="noindent" >There are five types of notifications:
     <ul class="itemize1">
     <li class="itemize">configuration change notification
     </li>
     <li class="itemize">available buffer notification
     </li>
     <li class="itemize">used buffer notification
     </li>
     <li class="itemize">driver auxiliary notification
     </li>
     <li class="itemize">device auxiliary notification</li></ul>
<!--l. 178--><p class="noindent" >Configuration change notifications, used buffer notifications and driver auxiliary
notifications are sent by the device, the recipient is the driver. A configuration change
notification indicates that the device configuration space has changed; a used
buffer notification indicates that a buffer may have been made used on the
virtqueue designated by the notification; driver auxiliary notifications allow
the device to send notifications other than configuration changes and used
buffer notifications to the driver, these are optional and their meaning is
device-specific.
<!--l. 188--><p class="noindent" >Available buffer notifications and device auxiliary notifications are sent by the driver,
the recipient is the device. Available buffer notifications indicate that a buffer may
have been made available on the virtqueue designated by the notification; device
auxiliary notifications allow the driver to send notifications other than available
buffer notifications to the device for example through a device register, these are
optional and their meaning is device-specific.
                                                                  

                                                                  
<!--l. 196--><p class="noindent" >The semantics, the transport-specific implementations, and other important
aspects of the different notifications are specified in detail in the following
chapters.
<!--l. 200--><p class="noindent" >Most transports implement notifications sent by the device to the driver using
interrupts. Therefore, in previous versions of this specification, these notifications
were often called interrupts. Some names defined in this specification still retain this
interrupt terminology. Occasionally, the term event is used to refer to a notification
or a receipt of a notification.
<a 
 id="x1-18001r18"></a>
<h3 class="sectionHead"><span class="titlemark">2.4   </span> <a 
 id="x1-190004"></a>Device Reset</h3>
<!--l. 209--><p class="noindent" >The driver may want to initiate a device reset at various times; notably, it is required
to do so during device initialization and device cleanup.
<!--l. 212--><p class="noindent" >The mechanism used by the driver to initiate the reset is transport specific.
<a 
 id="x1-19001r17"></a>
<h4 class="subsectionHead"><span class="titlemark">2.4.1   </span> <a 
 id="x1-200001"></a>Device Requirements: Device Reset</h4>
<!--l. 216--><p class="noindent" >A device MUST reinitialize <span 
class="aeti-10">device status </span>to 0 after receiving a reset.
<!--l. 218--><p class="noindent" >A device MUST NOT send notifications or interact with the queues after indicating
completion of the reset by reinitializing <span 
class="aeti-10">device status </span>to 0, until the driver
re-initializes the device.
<a 
 id="x1-20001r20"></a>
<h4 class="subsectionHead"><span class="titlemark">2.4.2   </span> <a 
 id="x1-210002"></a>Driver Requirements: Device Reset</h4>
<!--l. 224--><p class="noindent" >The driver SHOULD consider a driver-initiated reset complete when it reads <span 
class="aeti-10">device</span>
<span 
class="aeti-10">status </span>as 0.
<a 
 id="x1-21001r19"></a>
<h3 class="sectionHead"><span class="titlemark">2.5   </span> <a 
 id="x1-220005"></a>Device Configuration Space</h3>
<!--l. 229--><p class="noindent" >Device configuration space is generally used for rarely-changing or initialization-time
parameters. Where configuration fields are optional, their existence is indicated by
feature bits: Future versions of this specification will likely extend the device
configuration space by adding extra fields at the tail.
<span 
class="aeb10-">Note:</span> The device configuration space uses the little-endian format for multi-byte
      fields.
<!--l. 240--><p class="noindent" >Each transport also provides a generation count for the device configuration space,
which will change whenever there is a possibility that two accesses to the device
configuration space can see different versions of that space.
<a 
 id="x1-22001r21"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">2.5.1   </span> <a 
 id="x1-230001"></a>Driver Requirements: Device Configuration Space</h4>
<!--l. 246--><p class="noindent" >Drivers MUST NOT assume reads from fields greater than 32 bits wide are atomic,
nor are reads from multiple fields: drivers SHOULD read device configuration space
fields like so:
<!--l. 250-->
<div class="lstlisting" id="listing-4"><span class="label"><a 
 id="x1-23001r1"></a></span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">before</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">after</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-23002r2"></a></span><span 
class="pcrr8t-x-x-80">do</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-23003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">before</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">get_config_generation</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-23004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">entry</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">entries</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-23005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">after</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">get_config_generation</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-23006r6"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">while</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">after</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">!=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">before</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span>
</div>
<!--l. 259--><p class="noindent" >For optional configuration space fields, the driver MUST check that the
corresponding feature is offered before accessing that part of the configuration
space.
<span 
class="aeb10-">Note:</span> See section <a 
href="#x1-1070001">3.1<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a> for details on feature negotiation.
<!--l. 266--><p class="noindent" >Drivers MUST NOT limit structure size and device configuration space size. Instead,
drivers SHOULD only check that device configuration space is <span 
class="aeti-10">large enough </span>to
contain the fields necessary for device operation.
<span 
class="aeb10-">Note:</span> For example, if the specification states that device configuration space
      ’includes a single 8-bit field’ drivers should understand this to mean that
      the device configuration space might also include an arbitrary amount of
      tail padding, and accept any device configuration space size equal to or
      greater than the specified 8-bit size.
<a 
 id="x1-23007r23"></a>
<h4 class="subsectionHead"><span class="titlemark">2.5.2   </span> <a 
 id="x1-240002"></a>Device Requirements: Device Configuration Space</h4>
<!--l. 280--><p class="noindent" >The device MUST allow reading of any device-specific configuration field
before FEATURES_OK is set by the driver. This includes fields which are
conditional on feature bits, as long as those feature bits are offered by the
device.
<a 
 id="x1-24001r24"></a>
<h4 class="subsectionHead"><span class="titlemark">2.5.3   </span> <a 
 id="x1-250003"></a>Legacy Interface: A Note on Device Configuration Space endian-ness</h4>
<!--l. 287--><p class="noindent" >Note that for legacy interfaces, device configuration space is generally the guest’s
native endian, rather than PCI’s little-endian. The correct endian-ness is documented
for each device.
<a 
 id="x1-25001r25"></a>
<h4 class="subsectionHead"><span class="titlemark">2.5.4   </span> <a 
 id="x1-260004"></a>Legacy Interface: Device Configuration Space</h4>
<!--l. 293--><p class="noindent" >Legacy devices did not have a configuration generation field, thus are susceptible to
race conditions if configuration is updated. This affects the block <span 
class="aeti-10">capacity </span>(see <a 
href="#x1-2830004">5.2.4<!--tex4ht:ref: sec:Device Types / Block Device / Device configuration layout --></a>)
and network <span 
class="aeti-10">mac </span>(see <a 
href="#x1-2270004">5.1.4<!--tex4ht:ref: sec:Device Types / Network Device / Device configuration layout --></a>) fields; when using the legacy interface, drivers
                                                                  

                                                                  
SHOULD read these fields multiple times until two reads generate a consistent
result.
<a 
 id="x1-26001r22"></a>
<h3 class="sectionHead"><span class="titlemark">2.6   </span> <a 
 id="x1-270006"></a>Virtqueues</h3>
<!--l. 305--><p class="noindent" >The mechanism for bulk data transport on virtio devices is
pretentiously called a virtqueue. Each device can have zero or more
virtqueues<span class="footnote-mark"><a 
href="#fn3x2" id="fn3x2-bk"><sup class="textsuperscript">3</sup></a></span><a 
 id="x1-27001f3"></a>.
<!--l. 310--><p class="noindent" >Driver makes requests available to device by adding an available buffer to the queue,
i.e., adding a buffer describing the request to a virtqueue, and optionally
triggering a driver event, i.e., sending an available buffer notification to the
device.
<!--l. 316--><p class="noindent" >Device executes the requests and - when complete - adds a used buffer to
the queue, i.e., lets the driver know by marking the buffer as used. Device
can then trigger a device event, i.e., send a used buffer notification to the
driver.
<!--l. 321--><p class="noindent" >Device reports the number of bytes it has written to memory for each buffer it uses.
This is referred to as “used length”.
<!--l. 324--><p class="noindent" >Device is not generally required to use buffers in the same order in which they have
been made available by the driver.
<!--l. 328--><p class="noindent" >Some devices always use descriptors in the same order in which they have been made
available. These devices can offer the VIRTIO_F_IN_ORDER feature. If negotiated,
this knowledge might allow optimizations or simplify driver and/or device
code.
<!--l. 333--><p class="noindent" >Each virtqueue can consist of up to 3 parts:
     <ul class="itemize1">
     <li class="itemize">Descriptor Area - used for describing buffers
     </li>
     <li class="itemize">Driver Area - extra data supplied by driver to the device
     </li>
     <li class="itemize">Device Area - extra data supplied by device to driver</li></ul>
<span 
class="aeb10-">Note:</span> Note that previous versions of this spec used different names for these parts
      (following <a 
href="#x1-350007">2.7<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Split Virtqueues --></a>):
          <ul class="itemize1">
          <li class="itemize">Descriptor Table - for the Descriptor Area
          </li>
          <li class="itemize">Available Ring - for the Driver Area
                                                                  

                                                                  
          </li>
          <li class="itemize">Used Ring - for the Device Area</li></ul>
<!--l. 351--><p class="noindent" >Two formats are supported: Split Virtqueues (see <a 
href="#x1-350007">2.7<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Split Virtqueues --></a> <a 
href="#x1-350007">Split Virtqueues<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Split Virtqueues --></a>) and Packed
Virtqueues (see <a 
href="#x1-720008">2.8<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Packed Virtqueues --></a> <a 
href="#x1-720008">Packed Virtqueues<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Packed Virtqueues --></a>).
<!--l. 359--><p class="noindent" >Every driver and device supports either the Packed or the Split Virtqueue format, or
both.
<a 
 id="x1-27002r26"></a>
<h4 class="subsectionHead"><span class="titlemark">2.6.1   </span> <a 
 id="x1-280001"></a>Virtqueue Reset</h4>
<!--l. 364--><p class="noindent" >When VIRTIO_F_RING_RESET is negotiated, the driver can reset a virtqueue
individually. The way to reset the virtqueue is transport specific.
<!--l. 367--><p class="noindent" >Virtqueue reset is divided into two parts. The driver first resets a queue and can
afterwards optionally re-enable it.
<a 
 id="x1-28001r1"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.6.1.1   </span> <a 
 id="x1-290001"></a>Virtqueue Reset</h5>
<a 
 id="x1-29001r1"></a>
<h5 class="paragraphHead"><span class="titlemark">2.6.1.1.1</span> <a 
 id="x1-300001"></a>Device Requirements: Virtqueue Reset</h5>
After a queue has been reset by the driver, the device MUST NOT execute any
requests from that virtqueue, or notify the driver for it.
<!--l. 377--><p class="noindent" >The device MUST reset any state of a virtqueue to the default state, including the
available state and the used state.
<a 
 id="x1-30001r30"></a>
<h5 class="paragraphHead"><span class="titlemark">2.6.1.1.2</span> <a 
 id="x1-310002"></a>Driver Requirements: Virtqueue Reset</h5>
After the driver tells the device to reset a queue, the driver MUST verify that the
queue has actually been reset.
<!--l. 385--><p class="noindent" >After the queue has been successfully reset, the driver MAY release any resource
associated with that virtqueue.
<a 
 id="x1-31001r29"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.6.1.2   </span> <a 
 id="x1-320002"></a>Virtqueue Re-enable</h5>
<!--l. 390--><p class="noindent" >This process is the same as the initialization process of a single queue during the
initialization of the entire device.
<a 
 id="x1-32001r31"></a>
<h5 class="paragraphHead"><span class="titlemark">2.6.1.2.1</span> <a 
 id="x1-330001"></a>Device Requirements: Virtqueue Re-enable</h5>
The device MUST observe any queue configuration that may have been changed by
the driver, like the maximum queue size.
<a 
 id="x1-33001r33"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">2.6.1.2.2</span> <a 
 id="x1-340002"></a>Driver Requirements: Virtqueue Re-enable</h5>
When re-enabling a queue, the driver MUST configure the queue resources as during
initial virtqueue discovery, but optionally with different parameters.
<a 
 id="x1-34001r27"></a>
<h3 class="sectionHead"><span class="titlemark">2.7   </span> <a 
 id="x1-350007"></a>Split Virtqueues</h3>
<!--l. 2--><p class="noindent" >The split virtqueue format was the only format supported by the version 1.0 (and
earlier) of this standard.
<!--l. 5--><p class="noindent" >The split virtqueue format separates the virtqueue into several parts, where each part
is write-able by either the driver or the device, but not both. Multiple parts and/or
locations within a part need to be updated when making a buffer available and when
marking it as used.
<!--l. 11--><p class="noindent" >Each queue has a 16-bit queue size parameter, which sets the number of entries and
implies the total size of the queue.
<!--l. 15--><p class="noindent" >Each virtqueue consists of three parts:
     <ul class="itemize1">
     <li class="itemize">Descriptor Table - occupies the Descriptor Area
     </li>
     <li class="itemize">Available Ring - occupies the Driver Area
     </li>
     <li class="itemize">Used Ring - occupies the Device Area</li></ul>
<!--l. 23--><p class="noindent" >where each part is physically-contiguous in guest memory, and has different
alignment requirements.
<!--l. 26--><p class="noindent" >The memory alignment and size requirements, in bytes, of each part of the virtqueue
are summarized in the following table:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Virtqueue Part    </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Alignment  </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Size                      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Descriptor Table  </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16            </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="cmr-10">16</span><span 
class="cmsy-10">∗</span>(Queue Size)     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Available Ring    </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 2              </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="cmr-10">6 + 2</span><span 
class="cmsy-10">∗</span>(Queue Size)  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Used Ring          </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 4              </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="cmr-10">6 + 8</span><span 
class="cmsy-10">∗</span>(Queue Size)  </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 41--><p class="noindent" >The Alignment column gives the minimum alignment for each part of the
virtqueue.
<!--l. 44--><p class="noindent" >The Size column gives the total number of bytes for each part of the virtqueue.
<!--l. 47--><p class="noindent" >Queue Size corresponds to the maximum number of buffers in the
virtqueue<span class="footnote-mark"><a 
href="#fn4x2" id="fn4x2-bk"><sup class="textsuperscript">4</sup></a></span><a 
 id="x1-35001f4"></a>.
Queue Size value is always a power of 2. The maximum Queue Size value is 32768.
This value is specified in a bus-specific way.
<!--l. 53--><p class="noindent" >When the driver wants to send a buffer to the device, it fills in a slot in the descriptor
table (or chains several together), and writes the descriptor index into the
                                                                  

                                                                  
available ring. It then notifies the device. When the device has finished a buffer,
it writes the descriptor index into the used ring, and sends a used buffer
notification.
<a 
 id="x1-35002r28"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.1   </span> <a 
 id="x1-360001"></a>Driver Requirements: Virtqueues</h4>
<!--l. 61--><p class="noindent" >The driver MUST ensure that the physical address of the first byte of each
virtqueue part is a multiple of the specified alignment value in the above
table.
<a 
 id="x1-36001r36"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.2   </span> <a 
 id="x1-370002"></a>Legacy Interfaces: A Note on Virtqueue Layout</h4>
<!--l. 67--><p class="noindent" >For Legacy Interfaces, several additional restrictions are placed on the virtqueue
layout:
<!--l. 70--><p class="noindent" >Each virtqueue occupies two or more physically-contiguous pages (usually defined as
4096 bytes, but depending on the transport; henceforth referred to as Queue Align)
and consists of three parts:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Descriptor Table  </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Available Ring (…padding…)  </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Used Ring  </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table>
</div>
<!--l. 81--><p class="noindent" >The bus-specific Queue Size field controls the total number of bytes for the virtqueue.
When using the legacy interface, the transitional driver MUST retrieve the Queue
Size field from the device and MUST allocate the total number of bytes for the
virtqueue according to the following formula (Queue Align given in qalign and Queue
Size given in qsz):
<!--l. 89-->
<div class="lstlisting" id="listing-5"><span class="label"><a 
 id="x1-37001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ALIGN</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">x</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(((</span><span 
class="pcrr8t-x-x-80">x</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">qalign</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&amp;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">"</span><span 
class="pcrr8t-x-x-80">qalign</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-37002r2"></a></span><span 
class="pcrr8t-x-x-80">static</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">inline</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unsigned</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_size</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">unsigned</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">int</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">qsz</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-37003r3"></a></span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-37004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">return</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ALIGN</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">sizeof</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_desc</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">qsz</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sizeof</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">u16</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">*(3</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">qsz</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-37005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ALIGN</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">sizeof</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">u16</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">*3</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sizeof</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used_elem</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">qsz</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-37006r6"></a></span><span 
class="pcrr8t-x-x-80">}</span>
</div>
<!--l. 98--><p class="noindent" >This wastes some space with padding. When using the legacy interface, both
transitional devices and drivers MUST use the following virtqueue layout structure to
locate elements of the virtqueue:
<!--l. 103-->
<div class="lstlisting" id="listing-6"><span class="label"><a 
 id="x1-37007r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-37008r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">actual</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">each</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-37009r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Queue</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Size</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-37010r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-37011r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">A</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">available</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">heads</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">free</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">running</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-37012r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-37013r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-37014r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Padding</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Queue</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Align</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">boundary</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-37015r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pad</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Padding</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-37016r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-37017r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">A</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">heads</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">free</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">running</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-37018r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-37019r13"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-37020r37"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.3   </span> <a 
 id="x1-380003"></a>Legacy Interfaces: A Note on Virtqueue Endianness</h4>
<!--l. 121--><p class="noindent" >Note that when using the legacy interface, transitional devices and drivers
MUST use the native endian of the guest as the endian of fields and in the
                                                                  

                                                                  
virtqueue. This is opposed to little-endian for non-legacy interface as specified
by this standard. It is assumed that the host is already aware of the guest
endian.
<a 
 id="x1-38001r38"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.4   </span> <a 
 id="x1-390004"></a>Message Framing</h4>
<!--l. 129--><p class="noindent" >The framing of messages with descriptors is independent of the contents of the
buffers. For example, a network transmit buffer consists of a 12 byte header followed
by the network packet. This could be most simply placed in the descriptor table as a
12 byte output descriptor followed by a 1514 byte output descriptor, but it could also
consist of a single 1526 byte output descriptor in the case where the header and
packet are adjacent, or even three or more descriptors (possibly with loss of efficiency
in that case).
<!--l. 138--><p class="noindent" >Note that, some device implementations have large-but-reasonable restrictions on
total descriptor size (such as based on IOV_MAX in the host OS). This has not been
a problem in practice: little sympathy will be given to drivers which create
unreasonably-sized descriptors such as by dividing a network packet into 1500
single-byte descriptors!
<a 
 id="x1-39001r32"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.7.4.1   </span> <a 
 id="x1-400001"></a>Device Requirements: Message Framing</h5>
<!--l. 146--><p class="noindent" >The device MUST NOT make assumptions about the particular arrangement of
descriptors. The device MAY have a reasonable limit of descriptors it will allow in a
chain.
<a 
 id="x1-40001r40"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.7.4.2   </span> <a 
 id="x1-410002"></a>Driver Requirements: Message Framing</h5>
<!--l. 151--><p class="noindent" >The driver MUST place any device-writable descriptor elements after any
device-readable descriptor elements.
<!--l. 154--><p class="noindent" >The driver SHOULD NOT use an excessive number of descriptors to describe a
buffer.
<a 
 id="x1-41001r41"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.7.4.3   </span> <a 
 id="x1-420003"></a>Legacy Interface: Message Framing</h5>
<!--l. 159--><p class="noindent" >Regrettably, initial driver implementations used simple layouts, and devices came to
rely on it, despite this specification wording. In addition, the specification for
virtio_blk SCSI commands required intuiting field lengths from frame boundaries (see
<a 
href="#x1-2920003">5.2.6.3<!--tex4ht:ref: sec:Device Types / Block Device / Device Operation / Legacy Interface: Device Operation --></a> <a 
href="#x1-2920003">Legacy Interface: Device Operation<!--tex4ht:ref: sec:Device Types / Block Device / Device Operation / Legacy Interface: Device Operation --></a>)
<!--l. 165--><p class="noindent" >Thus when using the legacy interface, the VIRTIO_F_ANY_LAYOUT feature
indicates to both the device and the driver that no assumptions were made about
framing. Requirements for transitional drivers when this is not negotiated are
included in each device section.
<a 
 id="x1-42001r39"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">2.7.5   </span> <a 
 id="x1-430005"></a>The Virtqueue Descriptor Table</h4>
<!--l. 173--><p class="noindent" >The descriptor table refers to the buffers the driver is using for the device. <span 
class="aeti-10">addr </span>is a
physical address, and the buffers can be chained via <span 
class="aeti-10">next</span>. Each descriptor describes a
buffer which is read-only for the device (“device-readable”) or write-only for the
device (“device-writable”), but a chain of descriptors can contain both device-readable
and device-writable buffers.
<!--l. 179--><p class="noindent" >The actual contents of the memory offered to the device depends on the device type.
Most common is to begin the data with a header (containing little-endian fields)
for the device to read, and postfix it with a status tailer for the device to
write.
<!--l. 184-->
<div class="lstlisting" id="listing-7"><span class="label"><a 
 id="x1-43001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Address</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">guest</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">physical</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">addr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43007r7"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">marks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">continuing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">via</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_NEXT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43009r9"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">marks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">otherwise</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_WRITE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43011r11"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">means</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">contains</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">list</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43012r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_INDIRECT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">indicated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&amp;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">NEXT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-43017r17"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 204--><p class="noindent" >The number of descriptors in the table is defined by the queue size for this virtqueue:
this is the maximum possible descriptor chain length.
<!--l. 207--><p class="noindent" >If VIRTIO_F_IN_ORDER has been negotiated, driver uses descriptors in ring order:
starting from offset 0 in the table, and wrapping around at the end of the
table.
<span 
class="aeb10-">Note:</span> The legacy <a 
href="#x1-4001r2">[Virtio PCI Draft]</a> referred to this structure as vring_desc, and
      the constants as VRING_DESC_F_NEXT, etc, but the layout and values
      were identical.
<a 
 id="x1-43018r42"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.7.5.1   </span> <a 
 id="x1-440001"></a>Device Requirements: The Virtqueue Descriptor Table</h5>
<!--l. 218--><p class="noindent" >A device MUST NOT write to a device-readable buffer, and a device SHOULD NOT
read a device-writable buffer (it MAY do so for debugging or diagnostic purposes). A
device MUST NOT write to any descriptor table entry.
<a 
 id="x1-44001r44"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.7.5.2   </span> <a 
 id="x1-450002"></a>Driver Requirements: The Virtqueue Descriptor Table</h5>
<!--l. 223--><p class="noindent" >Drivers MUST NOT add a descriptor chain longer than <span 
class="cmr-10">2</span><sup><span 
class="cmr-7">32</span></sup> bytes in total; this
implies that loops in the descriptor chain are forbidden!
<!--l. 226--><p class="noindent" >If VIRTIO_F_IN_ORDER has been negotiated, and when making a descriptor with
VRING_DESC_F_NEXT set in <span 
class="aeti-10">flags </span>at offset <span 
class="cmmi-10">x </span>in the table available to the
device, driver MUST set <span 
class="aeti-10">next </span>to <span 
class="cmr-10">0 </span>for the last descriptor in the table (where
<span 
class="cmmi-10">x </span><span 
class="cmr-10">= </span><span 
class="cmmi-10">queue</span>_<span 
class="cmmi-10">size </span><span 
class="cmsy-10">− </span><span 
class="cmr-10">1</span>) and to <span 
class="cmmi-10">x </span><span 
class="cmr-10">+ 1 </span>for the rest of the descriptors.
<a 
 id="x1-45001r45"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">2.7.5.3   </span> <a 
 id="x1-460003"></a>Indirect Descriptors</h5>
<!--l. 234--><p class="noindent" >Some devices benefit by concurrently dispatching a large number of large requests.
The VIRTIO_F_INDIRECT_DESC feature allows this (see <a 
href="#x1-733000A">A<!--tex4ht:ref: sec:virtio-queue.h --></a> <a 
href="#x1-733000A">virtio_queue.h<!--tex4ht:ref: sec:virtio-queue.h --></a>). To
increase ring capacity the driver can store a table of indirect descriptors
anywhere in memory, and insert a descriptor in main virtqueue (with
<span 
class="aeti-10">flags</span>&VIRTQ_DESC_F_INDIRECT on) that refers to memory buffer containing this
indirect descriptor table; <span 
class="aeti-10">addr </span>and <span 
class="aeti-10">len </span>refer to the indirect table address and length
in bytes, respectively.
<!--l. 243--><p class="noindent" >The indirect table layout structure looks like this (<span 
class="aeti-10">len </span>is the length of the
descriptor that refers to this table, which is a variable, so this code won’t
compile):
<!--l. 247-->
<div class="lstlisting" id="listing-8"><span class="label"><a 
 id="x1-46001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">indirect_descriptor_table</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-46002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">actual</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">each</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-46003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-46004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 254--><p class="noindent" >The first indirect descriptor is located at start of the indirect descriptor table (index
0), additional indirect descriptors are chained by <span 
class="aeti-10">next</span>. An indirect descriptor without
a valid <span 
class="aeti-10">next </span>(with <span 
class="aeti-10">flags</span>&VIRTQ_DESC_F_NEXT off) signals the end of the
descriptor. A single indirect descriptor table can include both device-readable and
device-writable descriptors.
<!--l. 261--><p class="noindent" >If VIRTIO_F_IN_ORDER has been negotiated, indirect descriptors use sequential
indices, in-order: index 0 followed by index 1 followed by index 2, etc.
<a 
 id="x1-46005r34"></a>
<h5 class="paragraphHead"><span class="titlemark">2.7.5.3.1</span> <a 
 id="x1-470001"></a>Driver Requirements: Indirect Descriptors</h5>
The driver MUST NOT set the VIRTQ_DESC_F_INDIRECT flag unless the
VIRTIO_F_INDIRECT_DESC feature was negotiated. The driver MUST NOT set
the VIRTQ_DESC_F_INDIRECT flag within an indirect descriptor (ie. only one table
per descriptor).
<!--l. 271--><p class="noindent" >A driver MUST NOT create a descriptor chain longer than the Queue Size of the
device.
<!--l. 274--><p class="noindent" >A driver MUST NOT set both VIRTQ_DESC_F_INDIRECT and VIRTQ_DESC_F_NEXT
in <span 
class="aeti-10">flags</span>.
<!--l. 277--><p class="noindent" >If VIRTIO_F_IN_ORDER has been negotiated, indirect descriptors MUST appear
sequentially, with <span 
class="aeti-10">next </span>taking the value of 1 for the 1st descriptor, 2 for the 2nd one,
etc.
<a 
 id="x1-47001r47"></a>
<h5 class="paragraphHead"><span class="titlemark">2.7.5.3.2</span> <a 
 id="x1-480002"></a>Device Requirements: Indirect Descriptors</h5>
The device MUST ignore the write-only flag (<span 
class="aeti-10">flags</span>&VIRTQ_DESC_F_WRITE) in the
                                                                  

                                                                  
descriptor that refers to an indirect table.
<!--l. 284--><p class="noindent" >The device MUST handle the case of zero or more normal chained descriptors
followed by a single descriptor with <span 
class="aeti-10">flags</span>&VIRTQ_DESC_F_INDIRECT.
<span 
class="aeb10-">Note:</span> While unusual (most implementations either create a chain solely using
      non-indirect descriptors, or use a single indirect element), such a layout
      is valid.
<a 
 id="x1-48001r43"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.6   </span> <a 
 id="x1-490006"></a>The Virtqueue Available Ring</h4>
<!--l. 295--><p class="noindent" >The available ring has the following layout structure:
<!--l. 297-->
<div class="lstlisting" id="listing-9"><span class="label"><a 
 id="x1-49001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-49002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_AVAIL_F_NO_INTERRUPT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-49003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-49004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-49005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Queue</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Size</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-49006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used_event</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_EVENT_IDX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-49007r7"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 307--><p class="noindent" >The driver uses the available ring to offer buffers to the device: each ring entry refers
to the head of a descriptor chain. It is only written by the driver and read by the
device.
<!--l. 311--><p class="noindent" ><span 
class="aeti-10">idx </span>field indicates where the driver would put the next descriptor entry in the ring
(modulo the queue size). This starts at 0, and increases.
<span 
class="aeb10-">Note:</span> The legacy <a 
href="#x1-4001r2">[Virtio PCI Draft]</a> referred to this structure as vring_avail,
      and the constant as VRING_AVAIL_F_NO_INTERRUPT, but the layout
      and value were identical.
<a 
 id="x1-49008r46"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.7.6.1   </span> <a 
 id="x1-500001"></a>Driver Requirements: The Virtqueue Available Ring</h5>
<!--l. 321--><p class="noindent" >A driver MUST NOT decrement the available <span 
class="aeti-10">idx </span>on a virtqueue (ie. there is no way
to “unexpose” buffers).
<a 
 id="x1-50001r49"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.7   </span> <a 
 id="x1-510007"></a>Used Buffer Notification Suppression</h4>
<!--l. 327--><p class="noindent" >If the VIRTIO_F_EVENT_IDX feature bit is not negotiated, the <span 
class="aeti-10">flags </span>field in the
available ring offers a crude mechanism for the driver to inform the device that it
doesn’t want notifications when buffers are used. Otherwise <span 
class="aeti-10">used_event </span>is a more
performant alternative where the driver specifies how far the device can progress
before a notification is required.
<!--l. 334--><p class="noindent" >Neither of these notification suppression methods are reliable, as they are not
synchronized with the device, but they serve as useful optimizations.
<a 
 id="x1-51001r50"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">2.7.7.1   </span> <a 
 id="x1-520001"></a>Driver Requirements: Used Buffer Notification Suppression</h5>
<!--l. 339--><p class="noindent" >If the VIRTIO_F_EVENT_IDX feature bit is not negotiated:
     <ul class="itemize1">
     <li class="itemize">The driver MUST set <span 
class="aeti-10">flags </span>to 0 or 1.
     </li>
     <li class="itemize">The driver MAY set <span 
class="aeti-10">flags </span>to 1 to advise the device that notifications are
     not needed.</li></ul>
<!--l. 346--><p class="noindent" >Otherwise, if the VIRTIO_F_EVENT_IDX feature bit is negotiated:
     <ul class="itemize1">
     <li class="itemize">The driver MUST set <span 
class="aeti-10">flags </span>to 0.
     </li>
     <li class="itemize">The driver MAY use <span 
class="aeti-10">used_event </span>to advise the device that notifications are
     unnecessary until the device writes an entry with an index specified by
     <span 
class="aeti-10">used_event </span>into the used ring (equivalently, until <span 
class="aeti-10">idx </span>in the used ring will
     reach the value <span 
class="aeti-10">used_event </span>+ 1).</li></ul>
<!--l. 354--><p class="noindent" >The driver MUST handle spurious notifications from the device.
<a 
 id="x1-52001r52"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.7.7.2   </span> <a 
 id="x1-530002"></a>Device Requirements: Used Buffer Notification Suppression</h5>
<!--l. 358--><p class="noindent" >If the VIRTIO_F_EVENT_IDX feature bit is not negotiated:
     <ul class="itemize1">
     <li class="itemize">The device MUST ignore the <span 
class="aeti-10">used_event </span>value.
     </li>
     <li class="itemize">After the device writes a descriptor index into the used ring:
         <ul class="itemize2">
         <li class="itemize">If <span 
class="aeti-10">flags </span>is 1, the device SHOULD NOT send a notification.
         </li>
         <li class="itemize">If <span 
class="aeti-10">flags </span>is 0, the device MUST send a notification.</li></ul>
     </li></ul>
<!--l. 368--><p class="noindent" >Otherwise, if the VIRTIO_F_EVENT_IDX feature bit is negotiated:
     <ul class="itemize1">
     <li class="itemize">The device MUST ignore the lower bit of <span 
class="aeti-10">flags</span>.
     </li>
     <li class="itemize">After the device writes a descriptor index into the used ring:
         <ul class="itemize2">
         <li class="itemize">If  the  <span 
class="aeti-10">idx  </span>field  in  the  used  ring  (which  determined  where  that
         descriptor  index  was  placed)  was  equal  to  <span 
class="aeti-10">used_event</span>,  the  device
                                                                  

                                                                  
         MUST send a notification.
         </li>
         <li class="itemize">Otherwise the device SHOULD NOT send a notification.</li></ul>
     </li></ul>
<span 
class="aeb10-">Note:</span> For example, if <span 
class="aeti-10">used_event </span>is 0, then a device using
      <!--l. 383--><p class="noindent" >VIRTIO_F_EVENT_IDX would send a used buffer notification to the
      driver after the first buffer is used (and again after the 65536th buffer,
      etc).
<a 
 id="x1-53001r51"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.8   </span> <a 
 id="x1-540008"></a>The Virtqueue Used Ring</h4>
<!--l. 390--><p class="noindent" >The used ring has the following layout structure:
<!--l. 392-->
<div class="lstlisting" id="listing-10"><span class="label"><a 
 id="x1-54001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-54002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_USED_F_NO_NOTIFY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-54003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-54004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-54005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used_elem</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Queue</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Size</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-54006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail_event</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_EVENT_IDX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-54007r7"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-54008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-54009r9"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">here</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ids</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reasons</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-54010r10"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used_elem</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-54011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Index</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">start</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">chain</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-54012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-54013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-54014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">number</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">written</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">into</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-54015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">described</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">by</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">chain</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-54016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-54017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-54018r18"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 413--><p class="noindent" >The used ring is where the device returns buffers once it is done with them: it is only
written to by the device, and read by the driver.
<!--l. 416--><p class="noindent" >Each entry in the ring is a pair: <span 
class="aeti-10">id </span>indicates the head entry of the descriptor chain
describing the buffer (this matches an entry placed in the available ring by the guest
earlier), and <span 
class="aeti-10">len </span>the total of bytes written into the buffer.
<span 
class="aeb10-">Note:</span> <span 
class="aeti-10">len </span>is particularly useful for drivers using untrusted buffers: if a driver
      does not know exactly how much has been written by the device, the
      driver would have to zero the buffer in advance to ensure no data leakage
      occurs.
      <!--l. 427--><p class="noindent" >For example, a network driver may hand a received buffer directly to
      an  unprivileged  userspace  application.  If  the  network  device  has  not
      overwritten  the  bytes  which  were  in  that  buffer,  this  could  leak  the
      contents of freed memory from other processes to the application.
<!--l. 433--><p class="noindent" ><span 
class="aeti-10">idx </span>field indicates where the device would put the next descriptor entry in the ring
(modulo the queue size). This starts at 0, and increases.
<span 
class="aeb10-">Note:</span> The legacy <a 
href="#x1-4001r2">[Virtio PCI Draft]</a> referred to these structures as vring_used
      and                                                                    vring_used_elem,
      and the constant as VRING_USED_F_NO_NOTIFY, but the layout and
      value were identical.
<a 
 id="x1-54019r53"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">2.7.8.1   </span> <a 
 id="x1-550001"></a>Legacy Interface: The Virtqueue Used Ring</h5>
<!--l. 448--><p class="noindent" >Historically, many drivers ignored the <span 
class="aeti-10">len </span>value, as a result, many devices set <span 
class="aeti-10">len</span>
incorrectly. Thus, when using the legacy interface, it is generally a good idea to
ignore the <span 
class="aeti-10">len </span>value in used ring entries if possible. Specific known issues are listed
per device type.
<a 
 id="x1-55001r55"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.7.8.2   </span> <a 
 id="x1-560002"></a>Device Requirements: The Virtqueue Used Ring</h5>
<!--l. 456--><p class="noindent" >The device MUST set <span 
class="aeti-10">len </span>prior to updating the used <span 
class="aeti-10">idx</span>.
<!--l. 458--><p class="noindent" >The device MUST write at least <span 
class="aeti-10">len </span>bytes to descriptor, beginning at the first
device-writable buffer, prior to updating the used <span 
class="aeti-10">idx</span>.
<!--l. 462--><p class="noindent" >The device MAY write more than <span 
class="aeti-10">len </span>bytes to descriptor.
<span 
class="aeb10-">Note:</span> There are potential error cases where a device might not know what parts
      of the buffers have been written. This is why <span 
class="aeti-10">len </span>is permitted to be an
      underestimate: that’s preferable to the driver believing that uninitialized
      memory has been overwritten when it has not.
<a 
 id="x1-56001r56"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.7.8.3   </span> <a 
 id="x1-570003"></a>Driver Requirements: The Virtqueue Used Ring</h5>
<!--l. 473--><p class="noindent" >The driver MUST NOT make assumptions about data in device-writable buffers
beyond the first <span 
class="aeti-10">len </span>bytes, and SHOULD ignore this data.
<a 
 id="x1-57001r54"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.9   </span> <a 
 id="x1-580009"></a>In-order use of descriptors</h4>
<!--l. 479--><p class="noindent" >Some devices always use descriptors in the same order in which they have been made
available. These devices can offer the VIRTIO_F_IN_ORDER feature. If negotiated,
this knowledge allows devices to notify the use of a batch of buffers to the
driver by only writing out a single used ring entry with the <span 
class="aeti-10">id </span>corresponding
to the head entry of the descriptor chain describing the last buffer in the
batch.
<!--l. 487--><p class="noindent" >The device then skips forward in the ring according to the size of the batch.
Accordingly, it increments the used <span 
class="aeti-10">idx </span>by the size of the batch.
<!--l. 491--><p class="noindent" >The driver needs to look up the used <span 
class="aeti-10">id </span>and calculate the batch size to be
able to advance to where the next used ring entry will be written by the
device.
<!--l. 495--><p class="noindent" >This will result in the used ring entry at an offset matching the first available ring
entry in the batch, the used ring entry for the next batch at an offset matching the
first available ring entry in the next batch, etc.
<!--l. 500--><p class="noindent" >The skipped buffers (for which no used ring entry was written) are assumed to have
been used (read or written) by the device completely.
                                                                  

                                                                  
<a 
 id="x1-58001r58"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.10   </span> <a 
 id="x1-5900010"></a>Available Buffer Notification Suppression</h4>
<!--l. 506--><p class="noindent" >The device can suppress available buffer notifications in a manner analogous to the
way drivers can suppress used buffer notifications as detailed in section <a 
href="#x1-510007">2.7.7<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Used Buffer Notification Suppression --></a>. The
device manipulates <span 
class="aeti-10">flags </span>or <span 
class="aeti-10">avail_event </span>in the used ring the same way the driver
manipulates <span 
class="aeti-10">flags </span>or <span 
class="aeti-10">used_event </span>in the available ring.
<a 
 id="x1-59001r57"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.7.10.1   </span> <a 
 id="x1-600001"></a>Driver Requirements: Available Buffer Notification Suppression</h5>
<!--l. 515--><p class="noindent" >The driver MUST initialize <span 
class="aeti-10">flags </span>in the used ring to 0 when allocating the used
ring.
<!--l. 518--><p class="noindent" >If the VIRTIO_F_EVENT_IDX feature bit is not negotiated:
     <ul class="itemize1">
     <li class="itemize">The driver MUST ignore the <span 
class="aeti-10">avail_event </span>value.
     </li>
     <li class="itemize">After the driver writes a descriptor index into the available ring:
         <ul class="itemize2">
         <li class="itemize">If <span 
class="aeti-10">flags </span>is 1, the driver SHOULD NOT send a notification.
         </li>
         <li class="itemize">If <span 
class="aeti-10">flags </span>is 0, the driver MUST send a notification.</li></ul>
     </li></ul>
<!--l. 528--><p class="noindent" >Otherwise, if the VIRTIO_F_EVENT_IDX feature bit is negotiated:
     <ul class="itemize1">
     <li class="itemize">The driver MUST ignore the lower bit of <span 
class="aeti-10">flags</span>.
     </li>
     <li class="itemize">After the driver writes a descriptor index into the available ring:
         <ul class="itemize2">
         <li class="itemize">If the <span 
class="aeti-10">idx  </span>field in the available ring (which determined where that
         descriptor  index  was  placed)  was  equal  to  <span 
class="aeti-10">avail_event</span>,  the  driver
         MUST send a notification.
         </li>
         <li class="itemize">Otherwise the driver SHOULD NOT send a notification.</li></ul>
     </li></ul>
<a 
 id="x1-60001r60"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.7.10.2   </span> <a 
 id="x1-610002"></a>Device Requirements: Available Buffer Notification Suppression</h5>
<!--l. 541--><p class="noindent" >If the VIRTIO_F_EVENT_IDX feature bit is not negotiated:
                                                                  

                                                                  
     <ul class="itemize1">
     <li class="itemize">The device MUST set <span 
class="aeti-10">flags </span>to 0 or 1.
     </li>
     <li class="itemize">The device MAY set <span 
class="aeti-10">flags </span>to 1 to advise the driver that notifications are
     not needed.</li></ul>
<!--l. 548--><p class="noindent" >Otherwise, if the VIRTIO_F_EVENT_IDX feature bit is negotiated:
     <ul class="itemize1">
     <li class="itemize">The device MUST set <span 
class="aeti-10">flags </span>to 0.
     </li>
     <li class="itemize">The device MAY use <span 
class="aeti-10">avail_event </span>to advise the driver that notifications
     are unnecessary until the driver writes entry with an index specified by
     <span 
class="aeti-10">avail_event </span>into the available ring (equivalently, until <span 
class="aeti-10">idx </span>in the available
     ring will reach the value <span 
class="aeti-10">avail_event </span>+ 1).</li></ul>
<!--l. 555--><p class="noindent" >The device MUST handle spurious notifications from the driver.
<a 
 id="x1-61001r59"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.11   </span> <a 
 id="x1-6200011"></a>Helpers for Operating Virtqueues</h4>
<!--l. 559--><p class="noindent" >The Linux Kernel Source code contains the definitions above and helper routines in a
more usable form, in include/uapi/linux/virtio_ring.h. This was explicitly licensed
by IBM and Red Hat under the (3-clause) BSD license so that it can be
freely used by all other projects, and is reproduced (with slight variation) in
<a 
href="#x1-733000A">A<!--tex4ht:ref: sec:virtio-queue.h --></a> <a 
href="#x1-733000A">virtio_queue.h<!--tex4ht:ref: sec:virtio-queue.h --></a>.
<a 
 id="x1-62001r62"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.12   </span> <a 
 id="x1-6300012"></a>Virtqueue Operation</h4>
<!--l. 568--><p class="noindent" >There are two parts to virtqueue operation: supplying new available buffers to the
device, and processing used buffers from the device.
<span 
class="aeb10-">Note:</span> As an example, the simplest virtio network device has two virtqueues: the
      transmit virtqueue and the receive virtqueue. The driver adds outgoing
      (device-readable) packets to the transmit virtqueue, and then frees them
      after  they  are  used.  Similarly,  incoming  (device-writable)  buffers  are
      added to the receive virtqueue, and processed after they are used.
<!--l. 581--><p class="noindent" >What follows is the requirements of each of these two parts when using the split
virtqueue format in more detail.
<a 
 id="x1-63001r63"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.13   </span> <a 
 id="x1-6400013"></a>Supplying Buffers to The Device</h4>
<!--l. 586--><p class="noindent" >The driver offers buffers to one of the device’s virtqueues as follows:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-64002x1"><a 
 id="x1-640011"></a> The driver places the buffer into free descriptor(s) in the descriptor table,
                                                                  

                                                                  
     chaining as necessary (see <a 
href="#x1-430005">2.7.5<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table --></a> <a 
href="#x1-430005">The Virtqueue Descriptor Table<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table --></a>).
     </li>
     <li 
  class="enumerate" id="x1-64004x2"><a 
 id="x1-640032"></a> The driver places the index of the head of the descriptor chain into the
     next ring entry of the available ring.
     </li>
     <li 
  class="enumerate" id="x1-64006x3">Steps <a 
href="#x1-640011">1<!--tex4ht:ref: itm:Basic Facilities of a Virtio Device / Virtqueues / Supplying Buffers to The Device / Place Buffers --></a> and <a 
href="#x1-640032">2<!--tex4ht:ref: itm:Basic Facilities of a Virtio Device / Virtqueues / Supplying Buffers to The Device / Place Index --></a> MAY be performed repeatedly if batching is possible.
     </li>
     <li 
  class="enumerate" id="x1-64008x4">The driver performs a suitable memory barrier to ensure the device sees
     the updated descriptor table and available ring before the next step.
     </li>
     <li 
  class="enumerate" id="x1-64010x5">The available <span 
class="aeti-10">idx  </span>is increased by the number of descriptor chain heads
     added to the available ring.
     </li>
     <li 
  class="enumerate" id="x1-64012x6">The driver performs a suitable memory barrier to ensure that it updates
     the <span 
class="aeti-10">idx </span>field before checking for notification suppression.
     </li>
     <li 
  class="enumerate" id="x1-64014x7">The  driver  sends  an  available  buffer  notification  to  the  device  if  such
     notifications are not suppressed.</li></ol>
<!--l. 612--><p class="noindent" >Note that the above code does not take precautions against the available ring buffer
wrapping around: this is not possible since the ring buffer is the same size as the
descriptor table, so step (1) will prevent such a condition.
<!--l. 617--><p class="noindent" >In addition, the maximum queue size is 32768 (the highest power of 2 which fits in 16
bits), so the 16-bit <span 
class="aeti-10">idx </span>value can always distinguish between a full and empty
buffer.
<!--l. 621--><p class="noindent" >What follows is the requirements of each stage in more detail.
<a 
 id="x1-64015r61"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.7.13.1   </span> <a 
 id="x1-650001"></a>Placing Buffers Into The Descriptor Table</h5>
<!--l. 625--><p class="noindent" >A buffer consists of zero or more device-readable physically-contiguous elements
followed by zero or more physically-contiguous device-writable elements (each has at
least one element). This algorithm maps it into the descriptor table to form a
descriptor chain:
<!--l. 631--><p class="noindent" >for each buffer element, b:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-65002x1">Get the next free descriptor table entry, d
     </li>
     <li 
  class="enumerate" id="x1-65004x2">Set <span 
class="aeti-10">d.addr </span>to the physical address of the start of b
     </li>
     <li 
  class="enumerate" id="x1-65006x3">Set <span 
class="aeti-10">d.len </span>to the length of b.
                                                                  

                                                                  
     </li>
     <li 
  class="enumerate" id="x1-65008x4">If b is device-writable, set <span 
class="aeti-10">d.flags </span>to VIRTQ_DESC_F_WRITE, otherwise
     0.
     </li>
     <li 
  class="enumerate" id="x1-65010x5">If there is a buffer element after this:
         <ol  class="enumerate2" >
         <li 
  class="enumerate" id="x1-65012x1">Set <span 
class="aeti-10">d.next </span>to the index of the next free descriptor element.
         </li>
         <li 
  class="enumerate" id="x1-65014x2">Set the VIRTQ_DESC_F_NEXT bit in <span 
class="aeti-10">d.flags</span>.</li></ol>
     </li></ol>
<!--l. 647--><p class="noindent" >In practice, <span 
class="aeti-10">d.next </span>is usually used to chain free descriptors, and a separate
count kept to check there are enough free descriptors before beginning the
mappings.
<a 
 id="x1-65015r65"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.7.13.2   </span> <a 
 id="x1-660002"></a>Updating The Available Ring</h5>
<!--l. 653--><p class="noindent" >The descriptor chain head is the first d in the algorithm above, ie. the index of the
descriptor table entry referring to the first part of the buffer. A naive driver
implementation MAY do the following (with the appropriate conversion to-and-from
little-endian assumed):
<!--l. 658-->
<div class="lstlisting" id="listing-11"><span class="label"><a 
 id="x1-66001r1"></a></span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">%</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">qsz</span><span 
class="pcrr8t-x-x-80">]</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">head</span><span 
class="pcrr8t-x-x-80">;</span>
</div>
<!--l. 662--><p class="noindent" >However, in general the driver MAY add many descriptor chains before it updates <span 
class="aeti-10">idx</span>
(at which point they become visible to the device), so it is common to keep a counter
of how many the driver has added:
<!--l. 666-->
<div class="lstlisting" id="listing-12"><span class="label"><a 
 id="x1-66002r1"></a></span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[(</span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">added</span><span 
class="pcrr8t-x-x-80">++)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">%</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">qsz</span><span 
class="pcrr8t-x-x-80">]</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">head</span><span 
class="pcrr8t-x-x-80">;</span>
</div>
<a 
 id="x1-66003r66"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.7.13.3   </span> <a 
 id="x1-670003"></a>Updating <span 
class="aeti-10">idx</span></h5>
<!--l. 672--><p class="noindent" ><span 
class="aeti-10">idx </span>always increments, and wraps naturally at 65536:
<!--l. 675-->
<div class="lstlisting" id="listing-13"><span class="label"><a 
 id="x1-67001r1"></a></span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">added</span><span 
class="pcrr8t-x-x-80">;</span>
                                                                  

                                                                  
</div>
<!--l. 679--><p class="noindent" >Once available <span 
class="aeti-10">idx </span>is updated by the driver, this exposes the descriptor and its
contents. The device MAY access the descriptor chains the driver created and the
memory they refer to immediately.
<a 
 id="x1-67002r48"></a>
<h5 class="paragraphHead"><span class="titlemark">2.7.13.3.1</span> <a 
 id="x1-680001"></a>Driver Requirements: Updating idx</h5>
The driver MUST perform a suitable memory barrier before the <span 
class="aeti-10">idx </span>update, to
ensure the device sees the most up-to-date copy.
<a 
 id="x1-68001r67"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.7.13.4   </span> <a 
 id="x1-690004"></a>Notifying The Device</h5>
<!--l. 690--><p class="noindent" >The actual method of device notification is bus-specific, but generally it can be
expensive. So the device MAY suppress such notifications if it doesn’t need them, as
detailed in section <a 
href="#x1-5900010">2.7.10<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Virtqueue Notification Suppression --></a>.
<!--l. 694--><p class="noindent" >The driver has to be careful to expose the new <span 
class="aeti-10">idx </span>value before checking if
notifications are suppressed.
<a 
 id="x1-69001r68"></a>
<h5 class="paragraphHead"><span class="titlemark">2.7.13.4.1</span> <a 
 id="x1-700001"></a>Driver Requirements: Notifying The Device</h5>
The driver MUST perform a suitable memory barrier before reading <span 
class="aeti-10">flags </span>or
<span 
class="aeti-10">avail_event</span>, to avoid missing a notification.
<a 
 id="x1-70001r64"></a>
<h4 class="subsectionHead"><span class="titlemark">2.7.14   </span> <a 
 id="x1-7100014"></a>Receiving Used Buffers From The Device</h4>
<!--l. 703--><p class="noindent" >Once the device has used buffers referred to by a descriptor (read from or written to
them, or parts of both, depending on the nature of the virtqueue and the
device), it sends a used buffer notification to the driver as detailed in section
<a 
href="#x1-510007">2.7.7<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Used Buffer Notification Suppression --></a>.
<span 
class="aeb10-">Note:</span>
      <!--l. 711--><p class="noindent" >For optimal performance, a driver MAY disable used buffer notifications
      while  processing  the  used  ring,  but  beware  the  problem  of  missing
      notifications between emptying the ring and reenabling notifications. This
      is usually handled by re-checking for more used buffers after notifications
      are re-enabled:
      <!--l. 717-->
      <div class="lstlisting" id="listing-14"><span class="label"><a 
 id="x1-71001r1"></a></span><span 
class="pcrr8t-x-x-80">virtq_disable_used_buffer_notifications</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71003r3"></a></span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(;;)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">last_seen_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">!=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16_to_cpu</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">virtq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_enable_used_buffer_notifications</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mb</span><span 
class="pcrr8t-x-x-80">()</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">last_seen_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">!=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16_to_cpu</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">virtq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">break</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_disable_used_buffer_notifications</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used_elem</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">e</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">last_seen_used</span><span 
class="pcrr8t-x-x-80">%</span><span 
class="pcrr8t-x-x-80">vsz</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">process_buffer</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">e</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">last_seen_used</span><span 
class="pcrr8t-x-x-80">++;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-71017r17"></a></span><span 
class="pcrr8t-x-x-80">}</span>
      
      </div>
<a 
 id="x1-71018r35"></a>
                                                                  

                                                                  
<h3 class="sectionHead"><span class="titlemark">2.8   </span> <a 
 id="x1-720008"></a>Packed Virtqueues</h3>
<!--l. 3--><p class="noindent" >Packed virtqueues is an alternative compact virtqueue layout using read-write
memory, that is memory that is both read and written by both host and
guest.
<!--l. 7--><p class="noindent" >Use of packed virtqueues is negotiated by the VIRTIO_F_RING_PACKED feature
bit.
<!--l. 10--><p class="noindent" >Packed virtqueues support up to <span 
class="cmr-10">2</span><sup><span 
class="cmr-7">15</span></sup> entries each.
<!--l. 12--><p class="noindent" >With current transports, virtqueues are located in guest memory allocated by the
driver. Each packed virtqueue consists of three parts:
     <ul class="itemize1">
     <li class="itemize">Descriptor Ring - occupies the Descriptor Area
     </li>
     <li class="itemize">Driver Event Suppression - occupies the Driver Area
     </li>
     <li class="itemize">Device Event Suppression - occupies the Device Area</li></ul>
<!--l. 22--><p class="noindent" >Where the Descriptor Ring in turn consists of descriptors, and where each descriptor
can contain the following parts:
     <ul class="itemize1">
     <li class="itemize">Buffer ID
     </li>
     <li class="itemize">Element Address
     </li>
     <li class="itemize">Element Length
     </li>
     <li class="itemize">Flags</li></ul>
<!--l. 32--><p class="noindent" >A buffer consists of zero or more device-readable physically-contiguous elements
followed by zero or more physically-contiguous device-writable elements (each buffer
has at least one element).
<!--l. 36--><p class="noindent" >When the driver wants to send such a buffer to the device, it writes at least one
available descriptor describing elements of the buffer into the Descriptor Ring. The
descriptor(s) are associated with a buffer by means of a Buffer ID stored within the
descriptor.
<!--l. 42--><p class="noindent" >The driver then notifies the device. When the device has finished processing the
buffer, it writes a used device descriptor including the Buffer ID into the Descriptor
Ring (overwriting a driver descriptor previously made available), and sends a used
event notification.
<!--l. 48--><p class="noindent" >The Descriptor Ring is used in a circular manner: the driver writes descriptors into
                                                                  

                                                                  
the ring in order. After reaching the end of the ring, the next descriptor is placed at
the head of the ring. Once the ring is full of driver descriptors, the driver stops
sending new requests and waits for the device to start processing descriptors and
to write out some used descriptors before making new driver descriptors
available.
<!--l. 56--><p class="noindent" >Similarly, the device reads descriptors from the ring in order and detects that a driver
descriptor has been made available. As processing of descriptors is completed, used
descriptors are written by the device back into the ring.
<!--l. 61--><p class="noindent" >Note: after reading driver descriptors and starting their processing in order, the
device might complete their processing out of order. Used device descriptors are
written in the order in which their processing is complete.
<!--l. 66--><p class="noindent" >The Device Event Suppression data structure is write-only by the device. It includes
information for reducing the number of device events, i.e., sending fewer available
buffer notifications to the device.
<!--l. 71--><p class="noindent" >The Driver Event Suppression data structure is read-only by the device. It includes
information for reducing the number of driver events, i.e., sending fewer used buffer
notifications to the driver.
<a 
 id="x1-72001r71"></a>
<h4 class="subsectionHead"><span class="titlemark">2.8.1   </span> <a 
 id="x1-730001"></a>Driver and Device Ring Wrap Counters</h4>
<!--l. 78--><p class="noindent" >Each of the driver and the device are expected to maintain, internally, a single-bit
ring wrap counter initialized to 1.
<!--l. 81--><p class="noindent" >The counter maintained by the driver is called the Driver Ring Wrap Counter. The
driver changes the value of this counter each time it makes available the last
descriptor in the ring (after making the last descriptor available).
<!--l. 87--><p class="noindent" >The counter maintained by the device is called the Device Ring Wrap Counter. The
device changes the value of this counter each time it uses the last descriptor in the
ring (after marking the last descriptor used).
<!--l. 92--><p class="noindent" >It is easy to see that the Driver Ring Wrap Counter in the driver matches the Device
Ring Wrap Counter in the device when both are processing the same descriptor, or
when all available descriptors have been used.
<!--l. 96--><p class="noindent" >To mark a descriptor as available and used, both the driver and the device use the
following two flags: <!--l. 98-->
<div class="lstlisting" id="listing-15"><span class="label"><a 
 id="x1-73001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_AVAIL</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-73002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_USED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">15)</span>
</div>
<!--l. 103--><p class="noindent" >To mark a descriptor as available, the driver sets the VIRTQ_DESC_F_AVAIL bit
in Flags to match the internal Driver Ring Wrap Counter. It also sets the
VIRTQ_DESC_F_USED bit to match the <span 
class="aeti-10">inverse </span>value (i.e. to not match the internal
Driver Ring Wrap Counter).
                                                                  

                                                                  
<!--l. 109--><p class="noindent" >To mark a descriptor as used, the device sets the VIRTQ_DESC_F_USED bit in
Flags to match the internal Device Ring Wrap Counter. It also sets the
VIRTQ_DESC_F_AVAIL bit to match the <span 
class="aeti-10">same </span>value.
<!--l. 114--><p class="noindent" >Thus VIRTQ_DESC_F_AVAIL and VIRTQ_DESC_F_USED bits are different for an
available descriptor and equal for a used descriptor.
<!--l. 117--><p class="noindent" >Note that this observation is mostly useful for sanity-checking as these are necessary
but not sufficient conditions - for example, all descriptors are zero-initialized. To
detect used and available descriptors it is possible for drivers and devices to keep
track of the last observed value of VIRTQ_DESC_F_USED/VIRTQ_DESC_F_AVAIL.
Other techniques to detect VIRTQ_DESC_F_AVAIL/VIRTQ_DESC_F_USED bit
changes might also be possible.
<a 
 id="x1-73003r73"></a>
<h4 class="subsectionHead"><span class="titlemark">2.8.2   </span> <a 
 id="x1-740002"></a>Polling of available and used descriptors</h4>
<!--l. 129--><p class="noindent" >Writes of device and driver descriptors can generally be reordered, but each side
(driver and device) are only required to poll (or test) a single location in memory: the
next device descriptor after the one they processed previously, in circular
order.
<!--l. 134--><p class="noindent" >Sometimes the device needs to only write out a single used descriptor after processing
a batch of multiple available descriptors. As described in more detail below, this can
happen when using descriptor chaining or with in-order use of descriptors. In this
case, the device writes out a used descriptor with the buffer id of the last descriptor
in the group. After processing the used descriptor, both device and driver then skip
forward in the ring the number of the remaining descriptors in the group until
processing (reading for the driver and writing for the device) the next used
descriptor.
<a 
 id="x1-74001r74"></a>
<h4 class="subsectionHead"><span class="titlemark">2.8.3   </span> <a 
 id="x1-750003"></a>Write Flag</h4>
<!--l. 148--><p class="noindent" >In an available descriptor, the VIRTQ_DESC_F_WRITE bit within Flags is used to
mark a descriptor as corresponding to a write-only or read-only element of a
buffer.
<!--l. 152-->
<div class="lstlisting" id="listing-16"><span class="label"><a 
 id="x1-75001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">marks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">otherwise</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-75002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_WRITE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span>
</div>
<!--l. 157--><p class="noindent" >In a used descriptor, this bit is used to specify whether any data has been written by
the device into any parts of the buffer.
<a 
 id="x1-75003r75"></a>
<h4 class="subsectionHead"><span class="titlemark">2.8.4   </span> <a 
 id="x1-760004"></a>Element Address and Length</h4>
<!--l. 164--><p class="noindent" >In an available descriptor, Element Address corresponds to the physical address of
                                                                  

                                                                  
the buffer element. The length of the element assumed to be physically contiguous is
stored in Element Length.
<!--l. 168--><p class="noindent" >In a used descriptor, Element Address is unused. Element Length specifies the length
of the buffer that has been initialized (written to) by the device.
<!--l. 172--><p class="noindent" >Element Length is reserved for used descriptors without the VIRTQ_DESC_F_WRITE
flag, and is ignored by drivers.
<a 
 id="x1-76001r76"></a>
<h4 class="subsectionHead"><span class="titlemark">2.8.5   </span> <a 
 id="x1-770005"></a>Scatter-Gather Support</h4>
<!--l. 178--><p class="noindent" >Some drivers need an ability to supply a list of multiple buffer elements (also known
as a scatter/gather list) with a request. Two features support this: descriptor
chaining and indirect descriptors.
<!--l. 182--><p class="noindent" >If neither feature is in use by the driver, each buffer is physically-contiguous, either
read-only or write-only and is described completely by a single descriptor.
<!--l. 186--><p class="noindent" >While unusual (most implementations either create all lists solely using non-indirect
descriptors, or always use a single indirect element), if both features have been
negotiated, mixing indirect and non-indirect descriptors in a ring is valid, as long as
each list only contains descriptors of a given type.
<!--l. 192--><p class="noindent" >Scatter/gather lists only apply to available descriptors. A single used descriptor
corresponds to the whole list.
<!--l. 195--><p class="noindent" >The device limits the number of descriptors in a list through a transport-specific
and/or device-specific value. If not limited, the maximum number of descriptors in a
list is the virt queue size.
<a 
 id="x1-77001r77"></a>
<h4 class="subsectionHead"><span class="titlemark">2.8.6   </span> <a 
 id="x1-780006"></a>Next Flag: Descriptor Chaining</h4>
<!--l. 203--><p class="noindent" >The packed ring format allows the driver to supply a scatter/gather list to the device
by using multiple descriptors, and setting the VIRTQ_DESC_F_NEXT bit in Flags
for all but the last available descriptor.
<!--l. 208-->
<div class="lstlisting" id="listing-17"><span class="label"><a 
 id="x1-78001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">marks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">continuing</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-78002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_NEXT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span>
</div>
<!--l. 213--><p class="noindent" >Buffer ID is included in the last descriptor in the list.
<!--l. 215--><p class="noindent" >The driver always makes the first descriptor in the list available after the rest of the
list has been written out into the ring. This guarantees that the device will never
observe a partial scatter/gather list in the ring.
<!--l. 220--><p class="noindent" >Note: all flags, including VIRTQ_DESC_F_AVAIL, VIRTQ_DESC_F_USED,
VIRTQ_DESC_F_WRITE must be set/cleared correctly in all descriptors in the list,
not just the first one.
                                                                  

                                                                  
<!--l. 224--><p class="noindent" >The device only writes out a single used descriptor for the whole list. It
then skips forward according to the number of descriptors in the list. The
driver needs to keep track of the size of the list corresponding to each buffer
ID, to be able to skip to where the next used descriptor is written by the
device.
<!--l. 230--><p class="noindent" >For example, if descriptors are used in the same order in which they are made
available, this will result in the used descriptor overwriting the first available
descriptor in the list, the used descriptor for the next list overwriting the first
available descriptor in the next list, etc.
<!--l. 236--><p class="noindent" >VIRTQ_DESC_F_NEXT is reserved in used descriptors, and should be ignored by
drivers.
<a 
 id="x1-78003r78"></a>
<h4 class="subsectionHead"><span class="titlemark">2.8.7   </span> <a 
 id="x1-790007"></a>Indirect Flag: Scatter-Gather Support</h4>
<!--l. 242--><p class="noindent" >Some devices benefit by concurrently dispatching a large number of large requests.
The VIRTIO_F_INDIRECT_DESC feature allows this. To increase ring capacity the
driver can store a (read-only by the device) table of indirect descriptors anywhere
in memory, and insert a descriptor in the main virtqueue (with <span 
class="aeti-10">Flags </span>bit
VIRTQ_DESC_F_INDIRECT on) that refers to a buffer element containing this
indirect descriptor table; <span 
class="aeti-10">addr </span>and <span 
class="aeti-10">len </span>refer to the indirect table address and length
in bytes, respectively. <!--l. 251-->
<div class="lstlisting" id="listing-18"><span class="label"><a 
 id="x1-79001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">means</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">element</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">contains</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">table</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-79002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_INDIRECT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span>
</div>
<!--l. 256--><p class="noindent" >The indirect table layout structure looks like this (<span 
class="aeti-10">len </span>is the Buffer Length of the
descriptor that refers to this table, which is a variable):
<!--l. 260-->
<div class="lstlisting" id="listing-19"><span class="label"><a 
 id="x1-79003r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pvirtq_indirect_descriptor_table</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-79004r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">actual</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">structures</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pvirtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">each</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-79005r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pvirtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sizeof</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pvirtq_desc</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-79006r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 267--><p class="noindent" >The first descriptor is located at the start of the indirect descriptor table, additional
indirect descriptors come immediately afterwards. The VIRTQ_DESC_F_WRITE
<span 
class="aeti-10">flags </span>bit is the only valid flag for descriptors in the indirect table. Others are reserved
and are ignored by the device. Buffer ID is also reserved and is ignored by the
device.
<!--l. 274--><p class="noindent" >In descriptors with VIRTQ_DESC_F_INDIRECT set VIRTQ_DESC_F_WRITE is
reserved and is ignored by the device.
<a 
 id="x1-79007r79"></a>
<h4 class="subsectionHead"><span class="titlemark">2.8.8   </span> <a 
 id="x1-800008"></a>In-order use of descriptors</h4>
<!--l. 280--><p class="noindent" >Some devices always use descriptors in the same order in which they have been made
                                                                  

                                                                  
available. These devices can offer the VIRTIO_F_IN_ORDER feature. If negotiated,
this knowledge allows devices to notify the use of a batch of buffers to the driver by
only writing out a single used descriptor with the Buffer ID corresponding to the last
descriptor in the batch.
<!--l. 287--><p class="noindent" >The device then skips forward in the ring according to the size of the batch. The
driver needs to look up the used Buffer ID and calculate the batch size to be
able to advance to where the next used descriptor will be written by the
device.
<!--l. 292--><p class="noindent" >This will result in the used descriptor overwriting the first available descriptor in the
batch, the used descriptor for the next batch overwriting the first available descriptor
in the next batch, etc.
<!--l. 297--><p class="noindent" >The skipped buffers (for which no used descriptor was written) are assumed to have
been used (read or written) by the device completely.
<a 
 id="x1-80001r80"></a>
<h4 class="subsectionHead"><span class="titlemark">2.8.9   </span> <a 
 id="x1-810009"></a>Multi-buffer requests</h4>
<!--l. 303--><p class="noindent" >Some devices combine multiple buffers as part of processing of a single request. These
devices always mark the descriptor corresponding to the first buffer in the request
used after the rest of the descriptors (corresponding to rest of the buffers) in the
request - which follow the first descriptor in ring order - has been marked used and
written out into the ring. This guarantees that the driver will never observe a partial
request in the ring.
<a 
 id="x1-81001r81"></a>
<h4 class="subsectionHead"><span class="titlemark">2.8.10   </span> <a 
 id="x1-8200010"></a>Driver and Device Event Suppression</h4>
<!--l. 314--><p class="noindent" >In many systems used and available buffer notifications involve significant overhead.
To mitigate this overhead, each virtqueue includes two identical structures used for
controlling notifications between the device and the driver.
<!--l. 319--><p class="noindent" >The Driver Event Suppression structure is read-only by the device and controls the
used buffer notifications sent by the device to the driver.
<!--l. 323--><p class="noindent" >The Device Event Suppression structure is read-only by the driver and controls the
available buffer notifications sent by the driver to the device.
<!--l. 327--><p class="noindent" >Each of these Event Suppression structures includes the following fields:
     <dl class="description"><dt class="description">
<span 
class="aeb10-">Descriptor Ring Change Event Flags</span> </dt><dd 
class="description">Takes values: <!--l. 331-->
     <div class="lstlisting" id="listing-20"><span class="label"><a 
 id="x1-82001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Enable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">events</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-82002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">RING_EVENT_FLAGS_ENABLE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-82003r3"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Disable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">events</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-82004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">RING_EVENT_FLAGS_DISABLE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-82005r5"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-82006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Enable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">events</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-82007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specified</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">by</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Ring</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Change</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Offset</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">Wrap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Counter</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-82008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">valid</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_EVENT_IDX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">has</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">been</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">negotiated</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-82009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-82010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">RING_EVENT_FLAGS_DESC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-82011r11"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">value</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x3</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span>
     
     </div>
     </dd><dt class="description">
<span 
class="aeb10-">Descriptor Ring Change Event Offset</span> </dt><dd 
class="description">If Event Flags set to descriptor specific event:
                                                                  

                                                                  
     offset within the ring (in units of descriptor size). Event will only trigger when
     this descriptor is made available/used respectively.
     </dd><dt class="description">
<span 
class="aeb10-">Descriptor Ring Change Event Wrap Counter</span> </dt><dd 
class="description">If Event Flags set to descriptor
     specific event: offset within the ring (in units of descriptor size). Event will only
     trigger when Ring Wrap Counter matches this value and a descriptor is made
     available/used respectively.</dd></dl>
<!--l. 355--><p class="noindent" >After writing out some descriptors, both the device and the driver are expected to
consult the relevant structure to find out whether a used respectively an available
buffer notification should be sent.
<a 
 id="x1-82012r69"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.8.10.1   </span> <a 
 id="x1-830001"></a>Structure Size and Alignment</h5>
<!--l. 362--><p class="noindent" >Each part of the virtqueue is physically-contiguous in guest memory, and has
different alignment requirements.
<!--l. 365--><p class="noindent" >The memory alignment and size requirements, in bytes, of each part of the virtqueue
are summarized in the following table:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Virtqueue Part                </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Alignment  </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Size                  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Descriptor Ring               </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16            </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="cmr-10">16</span><span 
class="cmsy-10">∗</span>(Queue Size)  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device Event Suppression  </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 4              </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 4                      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Driver Event Suppression  </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 4              </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 4                      </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 380--><p class="noindent" >The Alignment column gives the minimum alignment for each part of the
virtqueue.
<!--l. 383--><p class="noindent" >The Size column gives the total number of bytes for each part of the virtqueue.
<!--l. 386--><p class="noindent" >Queue Size corresponds to the maximum number of descriptors in the
virtqueue<span class="footnote-mark"><a 
href="#fn5x2" id="fn5x2-bk"><sup class="textsuperscript">5</sup></a></span><a 
 id="x1-83001f5"></a>.
The Queue Size value does not have to be a power of 2.
<a 
 id="x1-83002r82"></a>
<h4 class="subsectionHead"><span class="titlemark">2.8.11   </span> <a 
 id="x1-8400011"></a>Driver Requirements: Virtqueues</h4>
<!--l. 393--><p class="noindent" >The driver MUST ensure that the physical address of the first byte of each
virtqueue part is a multiple of the specified alignment value in the above
table.
<a 
 id="x1-84001r84"></a>
<h4 class="subsectionHead"><span class="titlemark">2.8.12   </span> <a 
 id="x1-8500012"></a>Device Requirements: Virtqueues</h4>
<!--l. 399--><p class="noindent" >The device MUST start processing driver descriptors in the order in which they
appear in the ring. The device MUST start writing device descriptors into the ring in
the order in which they complete. The device MAY reorder descriptor writes once
they are started.
<a 
 id="x1-85001r85"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">2.8.13   </span> <a 
 id="x1-8600013"></a>The Virtqueue Descriptor Format</h4>
<!--l. 409--><p class="noindent" >The available descriptor refers to the buffers the driver is sending to the device. <span 
class="aeti-10">addr</span>
is a physical address, and the descriptor is identified with a buffer using the <span 
class="aeti-10">id</span>
field.
<!--l. 413-->
<div class="lstlisting" id="listing-21"><span class="label"><a 
 id="x1-86001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pvirtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-86002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Address</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-86003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">addr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-86004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-86005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-86006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ID</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-86007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-86008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">depending</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">on</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-86009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-86010r10"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 426--><p class="noindent" >The descriptor ring is zero-initialized.
<a 
 id="x1-86011r86"></a>
<h4 class="subsectionHead"><span class="titlemark">2.8.14   </span> <a 
 id="x1-8700014"></a>Event Suppression Structure Format</h4>
<!--l. 432--><p class="noindent" >The following structure is used to reduce the number of notifications sent between
driver and device.
<!--l. 435-->
<div class="lstlisting" id="listing-22"><span class="label"><a 
 id="x1-87001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pvirtq_event_suppress</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">desc_event_off</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">15;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Ring</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Change</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Offset</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">desc_event_wrap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Ring</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Change</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Wrap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Counter</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">If</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">desc_event_flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">set</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">RING_EVENT_FLAGS_DESC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">desc_event_flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Ring</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Change</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">14;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Reserved</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">set</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-87010r10"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-87011r87"></a>
<h4 class="subsectionHead"><span class="titlemark">2.8.15   </span> <a 
 id="x1-8800015"></a>Device Requirements: The Virtqueue Descriptor Table</h4>
<!--l. 449--><p class="noindent" >A device MUST NOT write to a device-readable buffer, and a device SHOULD NOT
read a device-writable buffer. A device MUST NOT use a descriptor unless it
observes the VIRTQ_DESC_F_AVAIL bit in its <span 
class="aeti-10">flags </span>being changed (e.g. as compared
to the initial zero value). A device MUST NOT change a descriptor after changing
it’s the VIRTQ_DESC_F_USED bit in its <span 
class="aeti-10">flags</span>.
<a 
 id="x1-88001r88"></a>
<h4 class="subsectionHead"><span class="titlemark">2.8.16   </span> <a 
 id="x1-8900016"></a>Driver Requirements: The Virtqueue Descriptor Table</h4>
<!--l. 458--><p class="noindent" >A driver MUST NOT change a descriptor unless it observes the VIRTQ_DESC_F_USED
bit in its <span 
class="aeti-10">flags </span>being changed. A driver MUST NOT change a descriptor after
changing the VIRTQ_DESC_F_AVAIL bit in its <span 
class="aeti-10">flags</span>. When notifying the device,
driver MUST set <span 
class="aeti-10">next_off  </span>and <span 
class="aeti-10">next_wrap </span>to match the next descriptor not
yet made available to the device. A driver MAY send multiple available
buffer notifications without making any new descriptors available to the
device.
<a 
 id="x1-89001r89"></a>
<h4 class="subsectionHead"><span class="titlemark">2.8.17   </span> <a 
 id="x1-9000017"></a>Driver Requirements: Scatter-Gather Support</h4>
<!--l. 471--><p class="noindent" >A driver MUST NOT create a descriptor list longer than allowed by the
device.
                                                                  

                                                                  
<!--l. 474--><p class="noindent" >A driver MUST NOT create a descriptor list longer than the Queue Size.
<!--l. 477--><p class="noindent" >This implies that loops in the descriptor list are forbidden!
<!--l. 479--><p class="noindent" >The driver MUST place any device-writable descriptor elements after any
device-readable descriptor elements.
<!--l. 482--><p class="noindent" >A driver MUST NOT depend on the device to use more descriptors to be able to
write out all descriptors in a list. A driver MUST make sure there’s enough space in
the ring for the whole list before making the first descriptor in the list available to
the device.
<!--l. 488--><p class="noindent" >A driver MUST NOT make the first descriptor in the list available before all
subsequent descriptors comprising the list are made available.
<a 
 id="x1-90001r90"></a>
<h4 class="subsectionHead"><span class="titlemark">2.8.18   </span> <a 
 id="x1-9100018"></a>Device Requirements: Scatter-Gather Support</h4>
<!--l. 494--><p class="noindent" >The device MUST use descriptors in a list chained by the VIRTQ_DESC_F_NEXT
flag in the same order that they were made available by the driver.
<!--l. 498--><p class="noindent" >The device MAY limit the number of buffers it will allow in a list.
<a 
 id="x1-91001r91"></a>
<h4 class="subsectionHead"><span class="titlemark">2.8.19   </span> <a 
 id="x1-9200019"></a>Driver Requirements: Indirect Descriptors</h4>
<!--l. 502--><p class="noindent" >The driver MUST NOT set the DESC_F_INDIRECT flag unless the
VIRTIO_F_INDIRECT_DESC feature was negotiated. The driver MUST NOT set
any flags except DESC_F_WRITE within an indirect descriptor.
<!--l. 506--><p class="noindent" >A driver MUST NOT create a descriptor chain longer than allowed by the
device.
<!--l. 509--><p class="noindent" >A driver MUST NOT write direct descriptors with DESC_F_INDIRECT set in a
scatter-gather list linked by VIRTQ_DESC_F_NEXT. <span 
class="aeti-10">flags</span>.
<a 
 id="x1-92001r92"></a>
<h4 class="subsectionHead"><span class="titlemark">2.8.20   </span> <a 
 id="x1-9300020"></a>Virtqueue Operation</h4>
<!--l. 516--><p class="noindent" >There are two parts to virtqueue operation: supplying new available buffers to the
device, and processing used buffers from the device.
<!--l. 520--><p class="noindent" >What follows is the requirements of each of these two parts when using the packed
virtqueue format in more detail.
<a 
 id="x1-93001r93"></a>
<h4 class="subsectionHead"><span class="titlemark">2.8.21   </span> <a 
 id="x1-9400021"></a>Supplying Buffers to The Device</h4>
<!--l. 525--><p class="noindent" >The driver offers buffers to one of the device’s virtqueues as follows:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-94002x1">The driver places the buffer into free descriptor(s) in the Descriptor Ring.
     </li>
                                                                  

                                                                  
     <li 
  class="enumerate" id="x1-94004x2">The driver performs a suitable memory barrier to ensure that it updates
     the descriptor(s) before checking for notification suppression.
     </li>
     <li 
  class="enumerate" id="x1-94006x3">If notifications are not suppressed, the driver notifies the device of the new
     available buffers.</li></ol>
<!--l. 537--><p class="noindent" >What follows are the requirements of each stage in more detail.
<a 
 id="x1-94007r83"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.8.21.1   </span> <a 
 id="x1-950001"></a>Placing Available Buffers Into The Descriptor Ring</h5>
<!--l. 541--><p class="noindent" >For each buffer element, b:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-95002x1">Get the next descriptor table entry, d
     </li>
     <li 
  class="enumerate" id="x1-95004x2">Get the next free buffer id value
     </li>
     <li 
  class="enumerate" id="x1-95006x3">Set <span 
class="aeti-10">d.addr </span>to the physical address of the start of b
     </li>
     <li 
  class="enumerate" id="x1-95008x4">Set <span 
class="aeti-10">d.len </span>to the length of b.
     </li>
     <li 
  class="enumerate" id="x1-95010x5">Set <span 
class="aeti-10">d.id </span>to the buffer id
     </li>
     <li 
  class="enumerate" id="x1-95012x6">Calculate the flags as follows:
         <ol  class="enumerate2" >
         <li 
  class="enumerate" id="x1-95014x1">If b is device-writable, set the VIRTQ_DESC_F_WRITE bit to 1,
         otherwise 0
         </li>
         <li 
  class="enumerate" id="x1-95016x2">Set the VIRTQ_DESC_F_AVAIL bit to the current value of the Driver
         Ring Wrap Counter
         </li>
         <li 
  class="enumerate" id="x1-95018x3">Set the VIRTQ_DESC_F_USED bit to inverse value</li></ol>
     </li>
     <li 
  class="enumerate" id="x1-95020x7">Perform a memory barrier to ensure that the descriptor has been initialized
     </li>
     <li 
  class="enumerate" id="x1-95022x8">Set <span 
class="aeti-10">d.flags </span>to the calculated flags value
     </li>
     <li 
  class="enumerate" id="x1-95024x9">If d is the last descriptor in the ring, toggle the Driver Ring Wrap
     Counter
                                                                  

                                                                  
     </li>
     <li 
  class="enumerate" id="x1-95026x10">Otherwise, increment d to point at the next descriptor</li></ol>
<!--l. 563--><p class="noindent" >This makes a single descriptor buffer available. However, in general the driver
MAY make use of a batch of descriptors as part of a single request. In that
case, it defers updating the descriptor flags for the first descriptor (and the
previous memory barrier) until after the rest of the descriptors have been
initialized.
<!--l. 570--><p class="noindent" >Once the descriptor <span 
class="aeti-10">flags </span>field is updated by the driver, this exposes the descriptor
and its contents. The device MAY access the descriptor and any following descriptors
the driver created and the memory they refer to immediately.
<a 
 id="x1-95027r70"></a>
<h5 class="paragraphHead"><span class="titlemark">2.8.21.1.1</span> <a 
 id="x1-960001"></a>Driver Requirements: Updating flags</h5>
The driver MUST perform a suitable memory barrier before the <span 
class="aeti-10">flags </span>update, to
ensure the device sees the most up-to-date copy.
<a 
 id="x1-96001r95"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.8.21.2   </span> <a 
 id="x1-970002"></a>Sending Available Buffer Notifications</h5>
<!--l. 586--><p class="noindent" >The actual method of device notification is bus-specific, but generally it can be
expensive. So the device MAY suppress such notifications if it doesn’t need them,
using the Event Suppression structure comprising the Device Area as detailed in
section <a 
href="#x1-8700014">2.8.14<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Packed Virtqueues / Event Suppression Structure Format --></a>.
<!--l. 593--><p class="noindent" >The driver has to be careful to expose the new <span 
class="aeti-10">flags </span>value before checking if
notifications are suppressed.
<a 
 id="x1-97001r97"></a>
<h5 class="subsubsectionHead"><span class="titlemark">2.8.21.3   </span> <a 
 id="x1-980003"></a>Implementation Example</h5>
<!--l. 598--><p class="noindent" >Below is a driver code example. It does not attempt to reduce the number of
available buffer notifications, neither does it support the VIRTIO_F_EVENT_IDX
feature.
<!--l. 602-->
<div class="lstlisting" id="listing-23"><span class="label"><a 
 id="x1-98001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Note</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">avail_wrap_count</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">initialized</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98002r2"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Note</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">sgs</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">an</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">array</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">same</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98004r4"></a></span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">alloc_id</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98006r6"></a></span><span 
class="pcrr8t-x-x-80">first</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">next_avail</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98007r7"></a></span><span 
class="pcrr8t-x-x-80">sgs</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98008r8"></a></span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">each</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">element</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">b</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sgs</span><span 
class="pcrr8t-x-x-80">++;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">ids</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">next_avail</span><span 
class="pcrr8t-x-x-80">]</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-1;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">next_avail</span><span 
class="pcrr8t-x-x-80">].</span><span 
class="pcrr8t-x-x-80">address</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">get_addr</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">b</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">next_avail</span><span 
class="pcrr8t-x-x-80">].</span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">get_len</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">b</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">avail_wrap_count</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">?</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_AVAIL</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">!</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">avail_wrap_count</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">?</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_USED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">f</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">get_flags</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">b</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">|</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">|</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">b</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">not</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">last</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">element</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">f</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">|=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_NEXT</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98022r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Don</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">t</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mark</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80">st</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">available</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">until</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">all</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">them</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ready</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">next_avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">==</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">first</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98024r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">f</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98025r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">else</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98026r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">next_avail</span><span 
class="pcrr8t-x-x-80">].</span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">f</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98027r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98028r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98029r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">last</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">next_avail</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98030r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98031r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">next_avail</span><span 
class="pcrr8t-x-x-80">++;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98032r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98033r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">next_avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&gt;=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98034r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">next_avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98035r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">avail_wrap_count</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">^=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98036r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98037r37"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98038r38"></a></span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">sgs</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">]</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sgs</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98039r39"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ID</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">included</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">last</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">list</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98040r40"></a></span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">last</span><span 
class="pcrr8t-x-x-80">].</span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98041r41"></a></span><span 
class="pcrr8t-x-x-80">write_memory_barrier</span><span 
class="pcrr8t-x-x-80">()</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98042r42"></a></span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">first</span><span 
class="pcrr8t-x-x-80">].</span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98043r43"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98044r44"></a></span><span 
class="pcrr8t-x-x-80">memory_barrier</span><span 
class="pcrr8t-x-x-80">()</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98045r45"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98046r46"></a></span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">device_event</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">!=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">RING_EVENT_FLAGS_DISABLE</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98047r47"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notify_device</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-98048r48"></a></span><span 
class="pcrr8t-x-x-80">}</span>
</div>
<a 
 id="x1-98051r96"></a>
<h5 class="paragraphHead"><span class="titlemark">2.8.21.3.1</span> <a 
 id="x1-990001"></a>Driver Requirements: Sending Available Buffer Notifications</h5>
The driver MUST perform a suitable memory barrier before reading the Event
Suppression structure occupying the Device Area. Failing to do so could result in
mandatory available buffer notifications not being sent.
<a 
 id="x1-99001r94"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">2.8.22   </span> <a 
 id="x1-10000022"></a>Receiving Used Buffers From The Device</h4>
<!--l. 663--><p class="noindent" >Once the device has used buffers referred to by a descriptor (read from or written to
them, or parts of both, depending on the nature of the virtqueue and the
device), it sends a used buffer notification to the driver as detailed in section
<a 
href="#x1-8700014">2.8.14<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Packed Virtqueues / Event Suppression Structure Format --></a>.
<span 
class="aeb10-">Note:</span>
      <!--l. 672--><p class="noindent" >For optimal performance, a driver MAY disable used buffer notifications
      while processing the used buffers, but beware the problem of missing
      notifications  between  emptying  the  ring  and  reenabling  used  buffer
      notifications. This is usually handled by re-checking for more used buffers
      after notifications are re-enabled:
<!--l. 680-->
<div class="lstlisting" id="listing-24"><span class="label"><a 
 id="x1-100001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Note</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">used_wrap_count</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">initialized</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100003r3"></a></span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">driver_event</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">RING_EVENT_FLAGS_DISABLE</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100005r5"></a></span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(;;)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pvirtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">d</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">next_used</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Check</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">that</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">has</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">been</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">made</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">available</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">check</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">necessary</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">making</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">new</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">available</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">parallel</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">processing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">e</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">g</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">from</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">another</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">thread</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Note</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">there</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">many</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">other</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ways</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">check</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">e</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">g</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">track</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">number</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">outstanding</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">available</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffers</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">check</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">that</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">it</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">not</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">has</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">been</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">by</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">d</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bool</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&amp;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_AVAIL</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bool</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&amp;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_USED</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">!=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">used_wrap_count</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">||</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">!=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">used_wrap_count</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100022r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">driver_event</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">RING_EVENT_FLAGS_ENABLE</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">memory_barrier</span><span 
class="pcrr8t-x-x-80">()</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100024r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100025r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100026r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Re</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">test</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">case</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">made</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">more</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">available</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100027r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">parallel</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">processing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">e</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">g</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">from</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">another</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100028r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">thread</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">more</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">before</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100029r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">enabled</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">events</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100030r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100031r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">d</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100032r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bool</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&amp;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_AVAIL</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100033r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bool</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&amp;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_USED</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100034r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">!=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">used_wrap_count</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">||</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">!=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">used_wrap_count</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100035r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">break</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100036r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100037r37"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100038r38"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">driver_event</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">RING_EVENT_FLAGS_DISABLE</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100039r39"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100040r40"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100041r41"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read_memory_barrier</span><span 
class="pcrr8t-x-x-80">()</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100042r42"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100043r43"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">skip</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">until</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100044r44"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">d</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100045r45"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">assert</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100046r46"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sgs</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">sgs</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100047r47"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">next_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sgs</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100048r48"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">next_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&gt;=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100049r49"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">next_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100050r50"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">used_wrap_count</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">^=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100051r51"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100052r52"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100053r53"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">free_id</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100054r54"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100055r55"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">process_buffer</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">d</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-100056r56"></a></span><span 
class="pcrr8t-x-x-80">}</span>
</div>
<a 
 id="x1-100057r72"></a>
<h3 class="sectionHead"><span class="titlemark">2.9   </span> <a 
 id="x1-1010009"></a>Driver Notifications</h3>
<!--l. 409--><p class="noindent" >The driver is sometimes required to send an available buffer notification to the
device.
<!--l. 412--><p class="noindent" >When VIRTIO_F_NOTIFICATION_DATA has not been negotiated, this notification
involves sending the virtqueue number to the device (method depending on the
transport).
<!--l. 416--><p class="noindent" >However, some devices benefit from the ability to find out the amount of available
data in the queue without accessing the virtqueue in memory: for efficiency or as a
debugging aid.
<!--l. 420--><p class="noindent" >To help with these optimizations, when VIRTIO_F_NOTIFICATION_DATA
has been negotiated, driver notifications to the device include the following
information:
     <dl class="description"><dt class="description">
<span 
class="aeb10-">vqn</span> </dt><dd 
class="description">VQ number to be notified.
     </dd><dt class="description">
<span 
class="aeb10-">next_off</span> </dt><dd 
class="description">Offset  within  the  ring  where  the  next  available  ring  entry  will  be
     written. When VIRTIO_F_RING_PACKED has not been negotiated this
     refers  to  the  15  least  significant  bits  of  the  available  index.  When
     VIRTIO_F_RING_PACKED has been negotiated this refers to the offset
     (in units of descriptor entries) within the descriptor ring where the next
     available descriptor will be written.
                                                                  

                                                                  
     </dd><dt class="description">
<span 
class="aeb10-">next_wrap</span> </dt><dd 
class="description">Wrap  Counter.  With  VIRTIO_F_RING_PACKED  this  is  the
     wrap  counter  referring  to  the  next  available  descriptor.  Without
     VIRTIO_F_RING_PACKED this is the most significant bit (bit 15) of the
     available index.</dd></dl>
<!--l. 442--><p class="noindent" >Note that the driver can send multiple notifications even without making any
more buffers available. When VIRTIO_F_NOTIFICATION_DATA has been
negotiated, these notifications would then have identical <span 
class="aeti-10">next_off  </span>and <span 
class="aeti-10">next_wrap</span>
values.
<a 
 id="x1-101001r101"></a>
<h3 class="sectionHead"><span class="titlemark">2.10   </span> <a 
 id="x1-10200010"></a>Shared Memory Regions</h3>
<!--l. 3--><p class="noindent" >Shared memory regions are an additional facility available to devices that
need a region of memory that’s continuously shared between the device and
the driver, rather than passed between them in the way virtqueue elements
are.
<!--l. 8--><p class="noindent" >Example uses include shared caches and version pools for versioned data
structures.
<!--l. 11--><p class="noindent" >The memory region is allocated by the device and presented to the driver. Where the
device is implemented in software on a host, this arrangement allows the memory
region to be allocated by a library on the host, which the device may not have full
control over.
<!--l. 17--><p class="noindent" >A device may have multiple shared memory regions associated with it. Each region
has a <span 
class="aeti-10">shmid </span>to identify it, the meaning of which is device-specific.
<!--l. 21--><p class="noindent" >Enumeration and location of shared memory regions is performed in a transport-specific
way.
<!--l. 24--><p class="noindent" >Memory consistency rules vary depending on the region and the device and they will
be specified as required by each device.
<a 
 id="x1-102001r100"></a>
<h4 class="subsectionHead"><span class="titlemark">2.10.1   </span> <a 
 id="x1-1030001"></a>Addressing within regions</h4>
<!--l. 29--><p class="noindent" >References into shared memory regions are represented as offsets from the beginning
of the region instead of absolute memory addresses. Offsets are used both for
references between structures stored within shared memory and for requests placed in
virtqueues that refer to shared memory. The <span 
class="aeti-10">shmid </span>may be explicit or may be
inferred from the context of the reference.
<a 
 id="x1-103001r103"></a>
<h4 class="subsectionHead"><span class="titlemark">2.10.2   </span> <a 
 id="x1-1040002"></a>Device Requirements: Shared Memory Regions</h4>
<!--l. 39--><p class="noindent" >Shared memory regions MUST NOT expose shared memory regions which are used
to control the operation of the device, nor to stream data.
<a 
 id="x1-104001r102"></a>
                                                                  

                                                                  
<h3 class="sectionHead"><span class="titlemark">2.11   </span> <a 
 id="x1-10500011"></a>Exporting Objects</h3>
<!--l. 451--><p class="noindent" >When an object created by one virtio device needs to be shared with a seperate virtio
device, the first device can export the object by generating a UUID which can then
be passed to the second device to identify the object.
<!--l. 456--><p class="noindent" >What constitutes an object, how to export objects, and how to import objects are
defined by the individual device types. It is RECOMMENDED that devices generate
version 4 UUIDs as specified by <a 
href="#x1-3001r1">[RFC4122]</a>.
                                                                  

                                                                  
<!--l. 461--><p class="noindent" ><h2 class="chapterHead"><hr><span class="titlemark">3</span> <a 
 id="x1-1060003"></a>General Initialization And Device Operation</h2>
We start with an overview of device initialization, then expand on the details of the
device and how each step is preformed. This section is best read along with the
bus-specific section which describes how to communicate with the specific
device.
<a 
 id="x1-106001r105"></a>
<h3 class="sectionHead"><span class="titlemark">3.1   </span> <a 
 id="x1-1070001"></a>Device Initialization</h3>
<a 
 id="x1-107001r104"></a>
<h4 class="subsectionHead"><span class="titlemark">3.1.1   </span> <a 
 id="x1-1080001"></a>Driver Requirements: Device Initialization</h4>
<!--l. 471--><p class="noindent" >The driver MUST follow this sequence to initialize a device:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-108002x1">Reset the device.
     </li>
     <li 
  class="enumerate" id="x1-108004x2">Set the ACKNOWLEDGE status bit: the guest OS has noticed the device.
     </li>
     <li 
  class="enumerate" id="x1-108006x3">Set the DRIVER status bit: the guest OS knows how to drive the device.
     </li>
     <li 
  class="enumerate" id="x1-108008x4"><a 
 id="x1-1080074"></a> Read device feature bits, and write the subset of feature bits understood
     by the OS and driver to the device. During this step the driver MAY read
     (but MUST NOT write) the device-specific configuration fields to check
     that it can support the device before accepting it.
     </li>
     <li 
  class="enumerate" id="x1-108010x5"><a 
 id="x1-1080095"></a> Set the FEATURES_OK status bit. The driver MUST NOT accept new
     feature bits after this step.
     </li>
     <li 
  class="enumerate" id="x1-108012x6"><a 
 id="x1-1080116"></a> Re-read  <span 
class="aeti-10">device  status  </span>to  ensure  the  FEATURES_OK  bit  is  still  set:
     otherwise, the device does not support our subset of features and the
     device is unusable.
     </li>
     <li 
  class="enumerate" id="x1-108014x7"><a 
 id="x1-1080137"></a> Perform device-specific setup, including discovery of virtqueues for the
     device, optional per-bus setup, reading and possibly writing the device’s
     virtio configuration space, and population of virtqueues.
     </li>
     <li 
  class="enumerate" id="x1-108016x8"><a 
 id="x1-1080158"></a> Set the DRIVER_OK status bit. At this point the device is “live”.</li></ol>
<!--l. 500--><p class="noindent" >If any of these steps go irrecoverably wrong, the driver SHOULD set the FAILED
status bit to indicate that it has given up on the device (it can reset the device later
to restart if desired). The driver MUST NOT continue initialization in that
case.
                                                                  

                                                                  
<!--l. 505--><p class="noindent" >The driver MUST NOT send any buffer available notifications to the device before
setting DRIVER_OK.
<a 
 id="x1-108017r108"></a>
<h4 class="subsectionHead"><span class="titlemark">3.1.2   </span> <a 
 id="x1-1090002"></a>Legacy Interface: Device Initialization</h4>
<!--l. 509--><p class="noindent" >Legacy devices did not support the FEATURES_OK status bit, and thus did not
have a graceful way for the device to indicate unsupported feature combinations.
They also did not provide a clear mechanism to end feature negotiation,
which meant that devices finalized features on first-use, and no features
could be introduced which radically changed the initial operation of the
device.
<!--l. 516--><p class="noindent" >Legacy driver implementations often used the device before setting the DRIVER_OK
bit, and sometimes even before writing the feature bits to the device.
<!--l. 520--><p class="noindent" >The result was the steps <a 
href="#x1-1080095">5<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Set FEATURES-OK --></a> and <a 
href="#x1-1080116">6<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Re-read FEATURES-OK --></a> were omitted, and steps <a 
href="#x1-1080074">4<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Read feature bits --></a>, <a 
href="#x1-1080137">7<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Device-specific Setup --></a> and <a 
href="#x1-1080158">8<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Set DRIVER-OK --></a> were
conflated.
<!--l. 529--><p class="noindent" >Therefore, when using the legacy interface:
     <ul class="itemize1">
     <li class="itemize">The  transitional  driver  MUST  execute  the  initialization  sequence  as
     described in <a 
href="#x1-1070001">3.1<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a> but omitting the steps <a 
href="#x1-1080095">5<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Set FEATURES-OK --></a> and <a 
href="#x1-1080116">6<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Re-read FEATURES-OK --></a>.
     </li>
     <li class="itemize">The  transitional  device  MUST  support  the  driver  writing  device
     configuration fields before the step <a 
href="#x1-1080074">4<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Read feature bits --></a>.
     </li>
     <li class="itemize">The transitional device MUST support the driver using the device before
     the step <a 
href="#x1-1080158">8<!--tex4ht:ref: itm:General Initialization And Device Operation / Device Initialization / Set DRIVER-OK --></a>.</li></ul>
<a 
 id="x1-109001r107"></a>
<h3 class="sectionHead"><span class="titlemark">3.2   </span> <a 
 id="x1-1100002"></a>Device Operation</h3>
<!--l. 553--><p class="noindent" >When operating the device, each field in the device configuration space can be
changed by either the driver or the device.
<!--l. 556--><p class="noindent" >Whenever such a configuration change is triggered by the device, driver is notified.
This makes it possible for drivers to cache device configuration, avoiding expensive
configuration reads unless notified.
<a 
 id="x1-110001r109"></a>
<h4 class="subsectionHead"><span class="titlemark">3.2.1   </span> <a 
 id="x1-1110001"></a>Notification of Device Configuration Changes</h4>
<!--l. 564--><p class="noindent" >For devices where the device-specific configuration information can be changed, a
configuration change notification is sent when a device-specific configuration change
occurs.
<!--l. 568--><p class="noindent" >In addition, this notification is triggered by the device setting DEVICE_NEEDS_RESET
(see <a 
href="#x1-130002">2.1.2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Status Field / DEVICENEEDSRESET --></a>).
                                                                  

                                                                  
<a 
 id="x1-111001r110"></a>
<h3 class="sectionHead"><span class="titlemark">3.3   </span> <a 
 id="x1-1120003"></a>Device Cleanup</h3>
<!--l. 573--><p class="noindent" >Once the driver has set the DRIVER_OK status bit, all the configured virtqueue of
the device are considered live. None of the virtqueues of a device are live once the
device has been reset.
<a 
 id="x1-112001r111"></a>
<h4 class="subsectionHead"><span class="titlemark">3.3.1   </span> <a 
 id="x1-1130001"></a>Driver Requirements: Device Cleanup</h4>
<!--l. 579--><p class="noindent" >A driver MUST NOT alter virtqueue entries for exposed buffers, i.e., buffers which
have been made available to the device (and not been used by the device) of a live
virtqueue.
<!--l. 584--><p class="noindent" >Thus a driver MUST ensure a virtqueue isn’t live (by device reset) before removing
exposed buffers.
                                                                  

                                                                  
<!--l. 586--><p class="noindent" ><h2 class="chapterHead"><hr><span class="titlemark">4</span> <a 
 id="x1-1140004"></a>Virtio Transport Options</h2>
Virtio can use various different buses, thus the standard is split into virtio general
and bus-specific sections.
<a 
 id="x1-114001r112"></a>
<h3 class="sectionHead"><span class="titlemark">4.1   </span> <a 
 id="x1-1150001"></a>Virtio Over PCI Bus</h3>
<!--l. 593--><p class="noindent" >Virtio devices are commonly implemented as PCI devices.
<!--l. 595--><p class="noindent" >A Virtio device can be implemented as any kind of PCI device: a Conventional PCI
device or a PCI Express device. To assure designs meet the latest level requirements,
see the PCI-SIG home page at <a 
href="http://www.pcisig.com" class="url" >http://www.pcisig.com</a> for any approved
changes.
<a 
 id="x1-115001r113"></a>
<h4 class="subsectionHead"><span class="titlemark">4.1.1   </span> <a 
 id="x1-1160001"></a>Device Requirements: Virtio Over PCI Bus</h4>
<!--l. 603--><p class="noindent" >A Virtio device using Virtio Over PCI Bus MUST expose to guest an interface that
meets the specification requirements of the appropriate PCI specification: <a 
href="#x1-3001r1">[PCI]</a> and
<a 
href="#x1-3001r1">[PCIe]</a> respectively.
<a 
 id="x1-116001r116"></a>
<h4 class="subsectionHead"><span class="titlemark">4.1.2   </span> <a 
 id="x1-1170002"></a>PCI Device Discovery</h4>
<!--l. 611--><p class="noindent" >Any PCI device with PCI Vendor ID 0x1AF4, and PCI Device ID 0x1000 through
0x107F inclusive is a virtio device. The actual value within this range indicates which
virtio device is supported by the device. The PCI Device ID is calculated by adding
0x1040 to the Virtio Device ID, as indicated in section <a 
href="#x1-2200005">5<!--tex4ht:ref: sec:Device Types --></a>. Additionally, devices MAY
utilize a Transitional PCI Device ID range, 0x1000 to 0x103F depending on the
device type.
<a 
 id="x1-117001r98"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.2.1   </span> <a 
 id="x1-1180001"></a>Device Requirements: PCI Device Discovery</h5>
<!--l. 621--><p class="noindent" >Devices MUST have the PCI Vendor ID 0x1AF4. Devices MUST either have the PCI
Device ID calculated by adding 0x1040 to the Virtio Device ID, as indicated in
section <a 
href="#x1-2200005">5<!--tex4ht:ref: sec:Device Types --></a> or have the Transitional PCI Device ID depending on the device type, as
follows:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Transitional PCI Device ID  </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         Virtio Device              </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >0x1000 </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >network card</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x1001                             </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         block device               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x1002                             </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > memory ballooning (traditional)  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x1003                             </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >            console                  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-6"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x1004                             </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          SCSI host                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-7"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x1005                             </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         entropy source             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-8"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x1009                             </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         9P transport               </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-9"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 647--><p class="noindent" >For example, the network card device with the Virtio Device ID 1 has the PCI Device
ID 0x1041 or the Transitional PCI Device ID 0x1000.
<!--l. 650--><p class="noindent" >The PCI Subsystem Vendor ID and the PCI Subsystem Device ID MAY reflect the
PCI Vendor and Device ID of the environment (for informational purposes by the
                                                                  

                                                                  
driver).
<!--l. 653--><p class="noindent" >Non-transitional devices SHOULD have a PCI Device ID in the range 0x1040 to
0x107f. Non-transitional devices SHOULD have a PCI Revision ID of 1 or higher.
Non-transitional devices SHOULD have a PCI Subsystem Device ID of 0x40 or
higher.
<!--l. 658--><p class="noindent" >This is to reduce the chance of a legacy driver attempting to drive the device.
<a 
 id="x1-118001r118"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.2.2   </span> <a 
 id="x1-1190002"></a>Driver Requirements: PCI Device Discovery</h5>
<!--l. 662--><p class="noindent" >Drivers MUST match devices with the PCI Vendor ID 0x1AF4 and the PCI Device
ID in the range 0x1040 to 0x107f, calculated by adding 0x1040 to the Virtio Device
ID, as indicated in section <a 
href="#x1-2200005">5<!--tex4ht:ref: sec:Device Types --></a>. Drivers for device types listed in section <a 
href="#x1-1170002">4.1.2<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Discovery --></a> MUST
match devices with the PCI Vendor ID 0x1AF4 and the Transitional PCI Device ID
indicated in section <a 
href="#x1-1170002">4.1.2<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Discovery --></a>.
<!--l. 673--><p class="noindent" >Drivers MUST match any PCI Revision ID value. Drivers MAY match any PCI
Subsystem Vendor ID and any PCI Subsystem Device ID value.
<a 
 id="x1-119001r119"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.2.3   </span> <a 
 id="x1-1200003"></a>Legacy Interfaces: A Note on PCI Device Discovery</h5>
<!--l. 678--><p class="noindent" >Transitional devices MUST have a PCI Revision ID of 0. Transitional devices MUST
have the PCI Subsystem Device ID matching the Virtio Device ID, as indicated in
section <a 
href="#x1-2200005">5<!--tex4ht:ref: sec:Device Types --></a>. Transitional devices MUST have the Transitional PCI Device ID in the
range 0x1000 to 0x103f.
<!--l. 684--><p class="noindent" >This is to match legacy drivers.
<a 
 id="x1-120001r117"></a>
<h4 class="subsectionHead"><span class="titlemark">4.1.3   </span> <a 
 id="x1-1210003"></a>PCI Device Layout</h4>
<!--l. 688--><p class="noindent" >The device is configured via I/O and/or memory regions (though see <a 
href="#x1-14600011">4.1.4.11<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / PCI configuration access capability --></a> for
access via the PCI configuration space), as specified by Virtio Structure PCI
Capabilities.
<!--l. 693--><p class="noindent" >Fields of different sizes are present in the device configuration regions. All 64-bit,
32-bit and 16-bit fields are little-endian. 64-bit fields are to be treated as two 32-bit
fields, with low 32 bit part followed by the high 32 bit part.
<a 
 id="x1-121001r120"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.3.1   </span> <a 
 id="x1-1220001"></a>Driver Requirements: PCI Device Layout</h5>
<!--l. 701--><p class="noindent" >For device configuration access, the driver MUST use 8-bit wide accesses for 8-bit
wide fields, 16-bit wide and aligned accesses for 16-bit wide fields and 32-bit
wide and aligned accesses for 32-bit and 64-bit wide fields. For 64-bit fields,
the driver MAY access each of the high and low 32-bit parts of the field
independently.
<a 
 id="x1-122001r122"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">4.1.3.2   </span> <a 
 id="x1-1230002"></a>Device Requirements: PCI Device Layout</h5>
<!--l. 710--><p class="noindent" >For 64-bit device configuration fields, the device MUST allow driver independent
access to high and low 32-bit parts of the field.
<a 
 id="x1-123001r121"></a>
<h4 class="subsectionHead"><span class="titlemark">4.1.4   </span> <a 
 id="x1-1240004"></a>Virtio Structure PCI Capabilities</h4>
<!--l. 715--><p class="noindent" >The virtio device configuration layout includes several structures:
     <ul class="itemize1">
     <li class="itemize">Common configuration
     </li>
     <li class="itemize">Notifications
     </li>
     <li class="itemize">ISR Status
     </li>
     <li class="itemize">Device-specific configuration (optional)
     </li>
     <li class="itemize">PCI configuration access
     </li>
     <li class="itemize">Driver auxiliary notifications (optional)
     </li>
     <li class="itemize">Device auxiliary notifications (optional)</li></ul>
<!--l. 726--><p class="noindent" >Each structure can be mapped by a Base Address register (BAR) belonging to the
function, or accessed via the special VIRTIO_PCI_CAP_PCI_CFG field in the PCI
configuration space.
<!--l. 729--><p class="noindent" >The location of each structure is specified using a vendor-specific PCI capability
located on the capability list in PCI configuration space of the device. This virtio
structure capability uses little-endian format; all fields are read-only for the driver
unless stated otherwise:
<!--l. 734-->
<div class="lstlisting" id="listing-25"><span class="label"><a 
 id="x1-124001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_cap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap_vndr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Generic</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCI_CAP_ID_VNDR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap_next</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Generic</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ptr</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Generic</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">capability</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cfg_type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Identifies</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">structure</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bar</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Where</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">find</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">it</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Multiple</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">capabilities</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">same</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">[2];</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Pad</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">full</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dword</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">offset</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Offset</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">within</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bar</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">structure</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124011r11"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 748--><p class="noindent" >This structure can be followed by extra data, depending on <span 
class="aeti-10">cfg_type</span>, as documented
below.
<!--l. 751--><p class="noindent" >The fields are interpreted as follows:
     <dl class="description"><dt class="description">
<span 
class="aebxti-10">cap_vndr</span> </dt><dd 
class="description">0x09; Identifies a vendor-specific capability.
                                                                  

                                                                  
     </dd><dt class="description">
<span 
class="aebxti-10">cap_next</span> </dt><dd 
class="description">Link to next capability in the capability list in the PCI configuration
     space.
     </dd><dt class="description">
<span 
class="aebxti-10">cap_len</span> </dt><dd 
class="description">Length  of  this  capability  structure,  including  the  whole  of  struct
     virtio_pci_cap, and extra data if any. This length MAY include padding,
     or fields unused by the driver.
     </dd><dt class="description">
<span 
class="aebxti-10">cfg_type</span> </dt><dd 
class="description">identifies the structure, according to the following table:
     <!--l. 768-->
     <div class="lstlisting" id="listing-26"><span class="label"><a 
 id="x1-124012r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Common</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">configuration</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124013r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_COMMON_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124014r3"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Notifications</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124015r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_NOTIFY_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124016r5"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ISR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Status</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124017r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_ISR_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124018r7"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">configuration</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124019r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_DEVICE_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124020r9"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">configuration</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">access</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124021r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_PCI_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124022r11"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auxiliary</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notification</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124023r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_DEVICE_AUX_NOTIFY_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124024r13"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Driver</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auxiliary</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notification</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124025r14"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_DRIVER_AUX_NOTIFY_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124026r15"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Shared</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">memory</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">region</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124027r16"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_SHARED_MEMORY_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124028r17"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Vendor</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124029r18"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PCI_CAP_VENDOR_CFG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9</span>
     
     </div>
     <!--l. 789--><p class="noindent" >Any other value is reserved for future use.
     <!--l. 791--><p class="noindent" >Each structure is detailed individually below.
     <!--l. 793--><p class="noindent" >The device MAY offer more than one structure of any type - this makes it
     possible for the device to expose multiple interfaces to drivers. The order of the
     capabilities in the capability list specifies the order of preference suggested by
     the device. A device may specify that this ordering mechanism be overridden by
     the use of the <span 
class="aeti-10">id </span>field.
     <span 
class="aeb10-">Note:</span> For   example,   on   some   hypervisors,   notifications   using   IO
          accesses  are  faster  than  memory  accesses.  In  this  case,  the
          device   would   expose   two   capabilities   with   <span 
class="aeti-10">cfg_type   </span>set   to
          VIRTIO_PCI_CAP_NOTIFY_CFG: the first one addressing an I/O
          BAR, the second one addressing a memory BAR. In this example,
          the driver would use the I/O BAR if I/O resources are available,
          and fall back on memory BAR when I/O resources are unavailable.
     </dd><dt class="description">
<span 
class="aebxti-10">bar</span> </dt><dd 
class="description">values 0x0 to 0x5 specify a Base Address register (BAR) belonging to the
     function located beginning at 10h in PCI Configuration Space and
     used to map the structure into Memory or I/O Space. The BAR is
     permitted to be either 32-bit or 64-bit, it can map Memory Space or I/O
     Space.
     <!--l. 814--><p class="noindent" >Any other value is reserved for future use.
     </dd><dt class="description">
<span 
class="aebxti-10">id</span> </dt><dd 
class="description">Used by some device types to uniquely identify multiple capabilities of a certain
     type. If the device type does not specify the meaning of this field, its contents
     are undefined.
                                                                  

                                                                  
     </dd><dt class="description">
<span 
class="aebxti-10">offset</span> </dt><dd 
class="description">indicates where the structure begins relative to the base address associated
     with the BAR. The alignment requirements of <span 
class="aeti-10">offset </span>are indicated in each
     structure-specific section below.
     </dd><dt class="description">
<span 
class="aebxti-10">length</span> </dt><dd 
class="description">indicates the length of the structure.
     <!--l. 830--><p class="noindent" ><span 
class="aeti-10">length </span>MAY include padding, or fields unused by the driver, or future
     extensions.
     <span 
class="aeb10-">Note:</span> For example, a future device might present a large structure size of
          several MBytes. As current devices never utilize structures larger
          than 4KBytes in size, driver MAY limit the mapped structure size
          to  e.g.  4KBytes  (thus  ignoring  parts  of  structure  after  the  first
          4KBytes) to allow forward compatibility with such devices without
          loss of functionality and without wasting resources.
     </dd></dl>
<!--l. 844--><p class="noindent" >A variant of this type, struct virtio_pci_cap64, is defined for those capabilities that
require offsets or lengths larger than 4GiB:
<!--l. 848-->
<div class="lstlisting" id="listing-27"><span class="label"><a 
 id="x1-124030r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_cap64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124031r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_cap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124032r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">offset_hi</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124033r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length_hi</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-124034r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 856--><p class="noindent" >Given that the <span 
class="aeti-10">cap.length </span>and <span 
class="aeti-10">cap.offset </span>fields are only 32 bit, the additional <span 
class="aeti-10">offset_hi</span>
and <span 
class="aeti-10">length_hi </span>fields provide the most significant 32 bits of a total 64 bit offset and
length within the BAR specified by <span 
class="aeti-10">cap.bar</span>.
<a 
 id="x1-124035r123"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.1   </span> <a 
 id="x1-1250001"></a>Driver Requirements: Virtio Structure PCI Capabilities</h5>
<!--l. 863--><p class="noindent" >The driver MUST ignore any vendor-specific capability structure which has a
reserved <span 
class="aeti-10">cfg_type </span>value.
<!--l. 866--><p class="noindent" >The driver SHOULD use the first instance of each virtio structure type they can
support.
<!--l. 869--><p class="noindent" >The driver MUST accept a <span 
class="aeti-10">cap_len </span>value which is larger than specified here.
<!--l. 871--><p class="noindent" >The driver MUST ignore any vendor-specific capability structure which has a
reserved <span 
class="aeti-10">bar </span>value.
<!--l. 874--><p class="noindent" >The drivers SHOULD only map part of configuration structure large enough for
device operation. The drivers MUST handle an unexpectedly large <span 
class="aeti-10">length</span>, but MAY
check that <span 
class="aeti-10">length </span>is large enough for device operation.
                                                                  

                                                                  
<!--l. 879--><p class="noindent" >The driver MUST NOT write into any field of the capability structure, with the
exception of those with <span 
class="aeti-10">cap_type </span>VIRTIO_PCI_CAP_PCI_CFG as detailed in
<a 
href="#x1-1480002">4.1.4.11.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / PCI configuration access capability --></a>.
<a 
 id="x1-125001r125"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.2   </span> <a 
 id="x1-1260002"></a>Device Requirements: Virtio Structure PCI Capabilities</h5>
<!--l. 885--><p class="noindent" >The device MUST include any extra data (from the beginning of the <span 
class="aeti-10">cap_vndr </span>field
through end of the extra data fields if any) in <span 
class="aeti-10">cap_len</span>. The device MAY append extra
data or padding to any structure beyond that.
<!--l. 890--><p class="noindent" >If the device presents multiple structures of the same type, it SHOULD order them
from optimal (first) to least-optimal (last).
<a 
 id="x1-126001r126"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.3   </span> <a 
 id="x1-1270003"></a>Common configuration structure layout</h5>
<!--l. 895--><p class="noindent" >The common configuration structure is found at the <span 
class="aeti-10">bar </span>and <span 
class="aeti-10">offset </span>within the
VIRTIO_PCI_CAP_COMMON_CFG capability; its layout is below.
<!--l. 897-->
<div class="lstlisting" id="listing-28"><span class="label"><a 
 id="x1-127001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_common_cfg</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">About</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">whole</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device_feature_select</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device_feature</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver_feature_select</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver_feature</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">config_msix_vector</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_queues</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device_status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">config_generation</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">About</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtqueue</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_select</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_msix_vector</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_enable</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_notify_off</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_desc</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_driver</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_device</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_notify_data</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127022r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_reset</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-127023r23"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
     <dl class="description"><dt class="description">
<span 
class="aebxti-10">device_feature_select</span> </dt><dd 
class="description">The  driver  uses  this  to  select  which  feature  bits
     <span 
class="aeti-10">device_feature </span>shows. Value 0x0 selects Feature Bits 0 to 31, 0x1 selects
     Feature Bits 32 to 63, etc.
     </dd><dt class="description">
<span 
class="aebxti-10">device_feature</span> </dt><dd 
class="description">The device uses this to report which feature bits it is offering to
     the driver: the driver writes to <span 
class="aeti-10">device_feature_select </span>to select which feature
     bits are presented.
     </dd><dt class="description">
<span 
class="aebxti-10">driver_feature_select</span> </dt><dd 
class="description">The  driver  uses  this  to  select  which  feature  bits
     <span 
class="aeti-10">driver_feature </span>shows. Value 0x0 selects Feature Bits 0 to 31, 0x1 selects
     Feature Bits 32 to 63, etc.
     </dd><dt class="description">
<span 
class="aebxti-10">driver_feature</span> </dt><dd 
class="description">The driver writes this to accept feature bits offered by the
     device. Driver Feature Bits selected by <span 
class="aeti-10">driver_feature_select</span>.
     </dd><dt class="description">
<span 
class="aebxti-10">config_msix_vector</span> </dt><dd 
class="description">The driver sets the Configuration Vector for MSI-X.
     </dd><dt class="description">
<span 
class="aebxti-10">num_queues</span> </dt><dd 
class="description">The  device  specifies  the  maximum  number  of  virtqueues
     supported here.
                                                                  

                                                                  
     </dd><dt class="description">
<span 
class="aebxti-10">device_status</span> </dt><dd 
class="description">The driver writes the device status here (see <a 
href="#x1-110001">2.1<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Status Field --></a>). Writing 0 into
     this field resets the device.
     </dd><dt class="description">
<span 
class="aebxti-10">config_generation</span> </dt><dd 
class="description">Configuration  atomicity  value.  The  device  changes  this
     every time the configuration noticeably changes.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_select</span> </dt><dd 
class="description">Queue Select. The driver selects which virtqueue the following
     fields refer to.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_size</span> </dt><dd 
class="description">Queue Size. On reset, specifies the maximum queue size supported
     by  the  device.  This  can  be  modified  by  the  driver  to  reduce  memory
     requirements. A 0 means the queue is unavailable.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_msix_vector</span> </dt><dd 
class="description">The driver uses this to specify the queue vector for MSI-X.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_enable</span> </dt><dd 
class="description">The  driver  uses  this  to  selectively  prevent  the  device  from
     executing requests from this virtqueue. 1 - enabled; 0 - disabled.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_notify_off</span> </dt><dd 
class="description">The driver reads this to calculate the offset from start of
     Notification structure at which this virtqueue is located.
     <span 
class="aeb10-">Note:</span> this is <span 
class="aeti-10">not an offset in bytes. See </span><a 
href="#x1-1300004"><span 
class="aeti-10">4.1.4.4</span><!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Notification capability --></a> <span 
class="aeti-10">below.</span>
     </dd><dt class="description">
<span 
class="aebxti-10">queue_desc</span> </dt><dd 
class="description">The driver writes the physical address of Descriptor Area here. See
     section <a 
href="#x1-270006">2.6<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues --></a>.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_driver</span> </dt><dd 
class="description">The driver writes the physical address of Driver Area here. See
     section <a 
href="#x1-270006">2.6<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues --></a>.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_device</span> </dt><dd 
class="description">The driver writes the physical address of Device Area here. See
     section <a 
href="#x1-270006">2.6<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues --></a>.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_notify_data</span> </dt><dd 
class="description">This field exists only if VIRTIO_F_NOTIF_CONFIG_DATA has
     been negotiated. The driver will use this value to put it in the ’virtqueue
     number’ field in the available buffer notification structure. See section
     <a 
href="#x1-1610002">4.1.5.2<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Available Buffer Notifications --></a>.
     <span 
class="aeb10-">Note:</span> This  field  provides  the  device  with  flexibility  to  determine  how
          virtqueues will be referred to in available buffer notifications. In a
                                                                  

                                                                  
          trivial case the device can set <span 
class="aeti-10">queue_notify_data</span>=vqn. Some devices
          may benefit from providing another value, for example an internal
          virtqueue identifier, or an internal offset related to the virtqueue
          number.
     </dd><dt class="description">
<span 
class="aebxti-10">queue_reset</span> </dt><dd 
class="description">The driver uses this to selectively reset the queue. This field exists only
     if VIRTIO_F_RING_RESET has been negotiated. (see <a 
href="#x1-280001">2.6.1<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Virtqueue Reset --></a>).
     </dd></dl>
<a 
 id="x1-127024r99"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.3.1</span> <a 
 id="x1-1280001"></a>Device Requirements: Common configuration structure layout</h5>
<span 
class="aeti-10">offset </span>MUST be 4-byte aligned.
<!--l. 1010--><p class="noindent" >The device MUST present at least one common configuration capability.
<!--l. 1012--><p class="noindent" >The device MUST present the feature bits it is offering in <span 
class="aeti-10">device_feature</span>, starting at
bit <span 
class="aeti-10">device_feature_select </span><span 
class="cmsy-10">∗ </span>32 for any <span 
class="aeti-10">device_feature_select </span>written by the
driver.
<span 
class="aeb10-">Note:</span> This means that it will present 0 for any <span 
class="aeti-10">device_feature_select </span>other than
      0 or 1, since no feature defined here exceeds 63.
<!--l. 1017--><p class="noindent" >The device MUST present any valid feature bits the driver has written in
<span 
class="aeti-10">driver_feature</span>, starting at bit <span 
class="aeti-10">driver_feature_select </span><span 
class="cmsy-10">∗ </span>32 for any <span 
class="aeti-10">driver_feature_select</span>
written by the driver. Valid feature bits are those which are subset of the
corresponding <span 
class="aeti-10">device_feature </span>bits. The device MAY present invalid bits written by the
driver.
<span 
class="aeb10-">Note:</span> This  means  that  a  device  can  ignore  writes  for  feature  bits  it  never
      offers, and simply present 0 on reads. Or it can just mirror what the
      driver wrote (but it will still have to check them when the driver sets
      FEATURES_OK).
<span 
class="aeb10-">Note:</span> A  driver  shouldn’t  write  invalid  bits  anyway,  as  per  <a 
href="#x1-1080001">3.1.1<!--tex4ht:ref: drivernormative:General Initialization And Device Operation / Device Initialization --></a>,  but  this
      attempts to handle it.
<!--l. 1029--><p class="noindent" >The device MUST present a changed <span 
class="aeti-10">config_generation </span>after the driver has read a
device-specific configuration value which has changed since any part of the
device-specific configuration was last read.
<span 
class="aeb10-">Note:</span> As <span 
class="aeti-10">config_generation </span>is an 8-bit value, simply incrementing it on every
      configuration change could violate this requirement due to wrap. Better
      would be to set an internal flag when it has changed, and if that flag is set
      when the driver reads from the device-specific configuration, increment
                                                                  

                                                                  
      <span 
class="aeti-10">config_generation </span>and clear the flag.
<!--l. 1041--><p class="noindent" >The device MUST reset when 0 is written to <span 
class="aeti-10">device_status</span>, and present a 0 in
<span 
class="aeti-10">device_status </span>once that is done.
<!--l. 1044--><p class="noindent" >The device MUST present a 0 in <span 
class="aeti-10">queue_enable </span>on reset.
<!--l. 1046--><p class="noindent" >If VIRTIO_F_RING_RESET has been negotiated, the device MUST present a 0 in
<span 
class="aeti-10">queue_enable </span>after the driver has reset the virtqueue via <span 
class="aeti-10">queue_reset</span>.
<!--l. 1050--><p class="noindent" >If VIRTIO_F_RING_RESET has been negotiated, the device MUST present a 0 in
<span 
class="aeti-10">queue_reset </span>on reset.
<!--l. 1053--><p class="noindent" >If VIRTIO_F_RING_RESET has been negotiated, the device MUST present a 0 in
<span 
class="aeti-10">queue_reset </span>after the virtqueue is enabled with <span 
class="aeti-10">queue_enable</span>.
<!--l. 1056--><p class="noindent" >The device MUST reset the queue when 1 is written to <span 
class="aeti-10">queue_reset</span>, and present a 1
in <span 
class="aeti-10">queue_reset </span>after the queue has been reset, until the driver re-enables the queue
via <span 
class="aeti-10">queue_enable </span>or the device is reset. The device MUST present consistent default
values after queue reset. (see <a 
href="#x1-280001">2.6.1<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Virtqueue Reset --></a>).
<!--l. 1062--><p class="noindent" >The device MUST present a 0 in <span 
class="aeti-10">queue_size </span>if the virtqueue corresponding to the
current <span 
class="aeti-10">queue_select </span>is unavailable.
<!--l. 1065--><p class="noindent" >If VIRTIO_F_RING_PACKED has not been negotiated, the device MUST present
either a value of 0 or a power of 2 in <span 
class="aeti-10">queue_size</span>.
<a 
 id="x1-128001r128"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.3.2</span> <a 
 id="x1-1290002"></a>Driver Requirements: Common configuration structure layout</h5>
The driver MUST NOT write to <span 
class="aeti-10">device_feature</span>, <span 
class="aeti-10">num_queues</span>, <span 
class="aeti-10">config_generation</span>,
<span 
class="aeti-10">queue_notify_off  </span>or <span 
class="aeti-10">queue_notify_data</span>.
<!--l. 1073--><p class="noindent" >If VIRTIO_F_RING_PACKED has been negotiated, the driver MUST NOT
write the value 0 to <span 
class="aeti-10">queue_size</span>. If VIRTIO_F_RING_PACKED has not been
negotiated, the driver MUST NOT write a value which is not a power of 2 to
<span 
class="aeti-10">queue_size</span>.
<!--l. 1078--><p class="noindent" >The driver MUST configure the other virtqueue fields before enabling the virtqueue
with <span 
class="aeti-10">queue_enable</span>.
<!--l. 1081--><p class="noindent" >After writing 0 to <span 
class="aeti-10">device_status</span>, the driver MUST wait for a read of <span 
class="aeti-10">device_status </span>to
return 0 before reinitializing the device.
<!--l. 1084--><p class="noindent" >The driver MUST NOT write a 0 to <span 
class="aeti-10">queue_enable</span>.
<!--l. 1086--><p class="noindent" >If VIRTIO_F_RING_RESET has been negotiated, after the driver writes 1 to
<span 
class="aeti-10">queue_reset </span>to reset the queue, it MUST verify that the queue has been reset by
reading back <span 
class="aeti-10">queue_reset </span>and ensuring that it is 1. The driver MAY re-enable the
queue by writing a 1 to <span 
class="aeti-10">queue_enable </span>after ensuring that the other virtqueue fields
have been set up correctly. The driver MAY set driver-writeable queue configuration
values to different values than those that were used before the queue reset. (see
<a 
href="#x1-280001">2.6.1<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Virtqueue Reset --></a>).
                                                                  

                                                                  
<a 
 id="x1-129001r127"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.4   </span> <a 
 id="x1-1300004"></a>Notification structure layout</h5>
<!--l. 1097--><p class="noindent" >The notification location is found using the VIRTIO_PCI_CAP_NOTIFY_CFG
capability. This capability is immediately followed by an additional field, like
so:
<!--l. 1101-->
<div class="lstlisting" id="listing-29"><span class="label"><a 
 id="x1-130001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_notify_cap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-130002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_cap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-130003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notify_off_multiplier</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Multiplier</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_notify_off</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-130004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1108--><p class="noindent" ><span 
class="aeti-10">notify_off_multiplier </span>is combined with the <span 
class="aeti-10">queue_notify_off  </span>to derive the Queue
Notify address within a BAR for a virtqueue:
<!--l. 1111-->
<div class="lstlisting" id="listing-30"><span class="label"><a 
 id="x1-130005r1"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">offset</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_notify_off</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notify_off_multiplier</span>
</div>
<!--l. 1115--><p class="noindent" >The <span 
class="aeti-10">cap.offset </span>and <span 
class="aeti-10">notify_off_multiplier </span>are taken from the notification capability
structure above, and the <span 
class="aeti-10">queue_notify_off </span>is taken from the common configuration
structure.
<span 
class="aeb10-">Note:</span> For example, if <span 
class="aeti-10">notifier_off_multiplier </span>is 0, the device uses the same Queue
      Notify address for all queues.
<a 
 id="x1-130006r129"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.4.1</span> <a 
 id="x1-1310001"></a>Device Requirements: Notification capability</h5>
The device MUST present at least one notification capability.
<!--l. 1127--><p class="noindent" >For devices not offering VIRTIO_F_NOTIFICATION_DATA:
<!--l. 1129--><p class="noindent" >The <span 
class="aeti-10">cap.offset </span>MUST be 2-byte aligned.
<!--l. 1131--><p class="noindent" >The device MUST either present <span 
class="aeti-10">notify_off_multiplier </span>as an even power of 2, or
present <span 
class="aeti-10">notify_off_multiplier </span>as 0.
<!--l. 1134--><p class="noindent" >The value <span 
class="aeti-10">cap.length </span>presented by the device MUST be at least 2 and MUST be large
enough to support queue notification offsets for all supported queues in all possible
configurations.
<!--l. 1138--><p class="noindent" >For all queues, the value <span 
class="aeti-10">cap.length </span>presented by the device MUST satisfy:
<!--l. 1139-->
<div class="lstlisting" id="listing-31"><span class="label"><a 
 id="x1-131001r1"></a></span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&gt;=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_notify_off</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notify_off_multiplier</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span>
                                                                  

                                                                  
</div>
<!--l. 1143--><p class="noindent" >For devices offering VIRTIO_F_NOTIFICATION_DATA:
<!--l. 1145--><p class="noindent" >The device MUST either present <span 
class="aeti-10">notify_off_multiplier </span>as a number that is
a power of 2 that is also a multiple 4, or present <span 
class="aeti-10">notify_off_multiplier </span>as
0.
<!--l. 1149--><p class="noindent" >The <span 
class="aeti-10">cap.offset </span>MUST be 4-byte aligned.
<!--l. 1151--><p class="noindent" >The value <span 
class="aeti-10">cap.length </span>presented by the device MUST be at least 4 and MUST be large
enough to support queue notification offsets for all supported queues in all possible
configurations.
<!--l. 1155--><p class="noindent" >For all queues, the value <span 
class="aeti-10">cap.length </span>presented by the device MUST satisfy:
<!--l. 1156-->
<div class="lstlisting" id="listing-32"><span class="label"><a 
 id="x1-131002r1"></a></span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&gt;=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_notify_off</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notify_off_multiplier</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span>
</div>
<a 
 id="x1-131003r130"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.5   </span> <a 
 id="x1-1320005"></a>ISR status capability</h5>
<!--l. 1162--><p class="noindent" >The VIRTIO_PCI_CAP_ISR_CFG capability refers to at least a single byte,
which contains the 8-bit ISR status field to be used for INT#x interrupt
handling.
<!--l. 1166--><p class="noindent" >The <span 
class="aeti-10">offset </span>for the <span 
class="aeti-10">ISR status </span>has no alignment requirements.
<!--l. 1168--><p class="noindent" >The ISR bits allow the driver to distinguish between device-specific configuration
change interrupts and normal virtqueue interrupts:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Bits       </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0                      </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 1                                         </td><td style="text-align: left; min-width: \@testpach 4 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 2                                                   </td><td style="text-align: left; min-width: \@testpach 5 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 3 to 31    </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Purpose  </td><td style="text-align: left; min-width: 5in; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Queue Interrupt  </td><td style="text-align: left; min-width: \@testpach 3 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device Configuration Interrupt  </td><td style="text-align: left; min-width: \@testpach 4 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Driver Auxiliary Notification Interrupt  </td><td style="text-align: left; min-width: \@testpach 5 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Reserved  </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: \@testpach 1 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table>
</div>
<!--l. 1179--><p class="noindent" >To avoid an extra access, simply reading this register resets it to 0 and causes the
device to de-assert the interrupt.
<!--l. 1182--><p class="noindent" >In this way, driver read of ISR status causes the device to de-assert an interrupt.
<!--l. 1185--><p class="noindent" >See sections <a 
href="#x1-1630003">4.1.5.3<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Used Buffer Notifications --></a> and <a 
href="#x1-1650004">4.1.5.4<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Notification of Device Configuration Changes --></a> for how this is used.
<a 
 id="x1-132001r131"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.5.1</span> <a 
 id="x1-1330001"></a>Device Requirements: ISR status capability</h5>
The device MUST present at least one VIRTIO_PCI_CAP_ISR_CFG capability.
<!--l. 1191--><p class="noindent" >The device MUST set the Device Configuration Interrupt bit in <span 
class="aeti-10">ISR status </span>before
sending a device configuration change notification to the driver.
<!--l. 1195--><p class="noindent" >If MSI-X capability is disabled, the device MUST set the Queue Interrupt bit in <span 
class="aeti-10">ISR</span>
<span 
class="aeti-10">status </span>before sending a virtqueue notification to the driver.
                                                                  

                                                                  
<!--l. 1199--><p class="noindent" >If MSI-X capability is disabled, the device MUST set the Interrupt Status bit
in the PCI Status register in the PCI Configuration Header of the device
to the logical OR of all bits in <span 
class="aeti-10">ISR status </span>of the device. The device then
asserts/deasserts INT#x interrupts unless masked according to standard PCI rules
<a 
href="#x1-3001r1">[PCI]</a>.
<!--l. 1205--><p class="noindent" >The device MUST reset <span 
class="aeti-10">ISR status </span>to 0 on driver read.
<a 
 id="x1-133001r133"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.5.2</span> <a 
 id="x1-1340002"></a>Driver Requirements: ISR status capability</h5>
If MSI-X capability is enabled, the driver SHOULD NOT access <span 
class="aeti-10">ISR status </span>upon
detecting a Queue Interrupt.
<a 
 id="x1-134001r132"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.6   </span> <a 
 id="x1-1350006"></a>Device-specific configuration</h5>
<!--l. 1214--><p class="noindent" >The device MUST present at least one VIRTIO_PCI_CAP_DEVICE_CFG capability
for any device type which has a device-specific configuration.
<a 
 id="x1-135001r134"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.6.1</span> <a 
 id="x1-1360001"></a>Device Requirements: Device-specific configuration</h5>
The <span 
class="aeti-10">offset </span>for the device-specific configuration MUST be 4-byte aligned.
<a 
 id="x1-136001r135"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.7   </span> <a 
 id="x1-1370007"></a>Device auxiliary notification capability</h5>
<!--l. 1223--><p class="noindent" >The device auxiliary notification <a 
href="#x1-180003">2.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Notifications --></a> location is found using the
VIRTIO_PCI_CAP_DEVICE_AUX_NOTIFY_CFG capability. This capability is
immediately followed by an additional field, like so:
<!--l. 1227-->
<div class="lstlisting" id="listing-33"><span class="label"><a 
 id="x1-137001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_dev_aux_notification_cap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-137002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_cap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-137003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dev_aux_notification_off_multiplier</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-137004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1234--><p class="noindent" >The device auxiliary notification address within a BAR is calculated as follows:
<!--l. 1236-->
<div class="lstlisting" id="listing-34"><span class="label"><a 
 id="x1-137005r1"></a></span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">offset</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dev_aux_notification_idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dev_aux_notification_off_multiplier</span>
</div>
<!--l. 1240--><p class="noindent" >The <span 
class="aeti-10">cap.offset </span>and <span 
class="aeti-10">dev_aux_notification_off_multiplier </span>are taken from the device
auxiliary notification capability structure above, and the <span 
class="aeti-10">dev_aux_notification_idx </span>is
the device auxiliary notification index. There is no restriction for the mapping
between device auxiliary notifications and dev_aux_notification_idx. The number of
device auxiliary notifications and their purpose is device-specific.
                                                                  

                                                                  
<a 
 id="x1-137006r136"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.7.1</span> <a 
 id="x1-1380001"></a>Device Requirements: Device auxiliary notification capability</h5>
The data width of the device auxiliary notifications is device specific.
<!--l. 1251--><p class="noindent" >For devices that provide a data width of 1 byte:
<!--l. 1253--><p class="noindent" >The <span 
class="aeti-10">cap.offset </span>MUST be byte aligned.
<!--l. 1255--><p class="noindent" >The value <span 
class="aeti-10">cap.length </span>presented by the device MUST be at least 1 and MUST be large
enough to support device auxiliary notification offsets for all supported device
auxiliary notifications in all possible configurations.
<!--l. 1259--><p class="noindent" >The value <span 
class="aeti-10">cap.length </span>presented by the device MUST satisfy:
<!--l. 1261-->
<div class="lstlisting" id="listing-35"><span class="label"><a 
 id="x1-138001r1"></a></span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&gt;=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_dev_aux_notification_idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dev_aux_notification_off_multiplier</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span>
</div>
<!--l. 1265--><p class="noindent" >where <span 
class="aeti-10">max_dev_aux_notification_idx </span>is the maximum device auxiliary notification
index and is dependent on the device.
<!--l. 1268--><p class="noindent" >For devices that provide a data width of 2 bytes:
<!--l. 1270--><p class="noindent" >The <span 
class="aeti-10">cap.offset </span>MUST be 2-byte aligned.
<!--l. 1272--><p class="noindent" >The device MUST either present <span 
class="aeti-10">dev_aux_notification_off_multiplier </span>as an even power
of 2, or present <span 
class="aeti-10">dev_aux_notification_off_multiplier </span>as 0.
<!--l. 1275--><p class="noindent" >The value <span 
class="aeti-10">cap.length </span>presented by the device MUST be at least 2 and MUST be large
enough to support device auxiliary notification offsets for all supported device
auxiliary notifications in all possible configurations.
<!--l. 1279--><p class="noindent" >The value <span 
class="aeti-10">cap.length </span>presented by the device MUST satisfy:
<!--l. 1281-->
<div class="lstlisting" id="listing-36"><span class="label"><a 
 id="x1-138002r1"></a></span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&gt;=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_dev_aux_notification_idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dev_aux_notification_off_multiplier</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span>
</div>
<!--l. 1285--><p class="noindent" >where <span 
class="aeti-10">max_dev_aux_notification_idx </span>is the maximum device auxiliary notification
index and is dependent on the device.
<!--l. 1288--><p class="noindent" >For devices that provide a data width of 4 bytes:
<!--l. 1290--><p class="noindent" >The <span 
class="aeti-10">cap.offset </span>MUST be 4-byte aligned.
<!--l. 1292--><p class="noindent" >The device MUST either present <span 
class="aeti-10">dev_aux_notification_off_multiplier </span>as a number that
is a power of 2 that is also a multiple 4, or present <span 
class="aeti-10">dev_aux_notification_off_multiplier</span>
as 0.
                                                                  

                                                                  
<!--l. 1296--><p class="noindent" >The value <span 
class="aeti-10">cap.length </span>presented by the device MUST be at least 4 and MUST be large
enough to support device auxiliary notification offsets for all supported device
auxiliary notifications in all possible configurations.
<!--l. 1300--><p class="noindent" >The value <span 
class="aeti-10">cap.length </span>presented by the device MUST satisfy:
<!--l. 1302-->
<div class="lstlisting" id="listing-37"><span class="label"><a 
 id="x1-138003r1"></a></span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&gt;=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_dev_aux_notification_idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dev_aux_notification_off_multiplier</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span>
</div>
<!--l. 1306--><p class="noindent" >where <span 
class="aeti-10">max_dev_aux_notification_idx </span>is the maximum device auxiliary notification
index and is dependent on the device.
<a 
 id="x1-138004r137"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.8   </span> <a 
 id="x1-1390008"></a>Driver auxiliary notification capability</h5>
<!--l. 1311--><p class="noindent" >The Driver auxiliary notification <a 
href="#x1-180003">2.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Notifications --></a> location is found using the
VIRTIO_PCI_CAP_DRIVER_AUX_NOTIFY_CFG capability. The driver auxiliary
notification structure allows MSI-X vectors to be configured for notification
interrupts. If MSI-X is not available, bit 2 of the ISR status <a 
href="#x1-1320005">4.1.4.5<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / ISR status capability --></a> indicates that a
driver auxiliary notification occurred. If MSI-X is not available, it is not possible to
determine which driver auxiliary notification occured, hence only a single notification
is supported.
<!--l. 1322--><p class="noindent" >The driver auxiliary notification structure is the following:
<!--l. 1324-->
<div class="lstlisting" id="listing-38"><span class="label"><a 
 id="x1-139001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_driver_aux_notification_cfg</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-139002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver_aux_notification_select</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-139003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver_aux_notification_msix_vector</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-139004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1331--><p class="noindent" >The driver indicates which notification is of interest by writing the
<span 
class="aeti-10">driver_aux_notification_select </span>field. The driver then writes the MSI-X vector or
VIRTIO_MSI_NO_VECTOR to <span 
class="aeti-10">driver_aux_notification_msix_vector </span>to change the
MSI-X vector for that notification.
<!--l. 1336--><p class="noindent" >The mapping between notifications and notification indices is device-specific. The
total number of notifications is also device-specific.
<a 
 id="x1-139005r138"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.8.1</span> <a 
 id="x1-1400001"></a>Device Requirements: Driver auxiliary notification capability</h5>
Device MUST ignore writes to <span 
class="aeti-10">driver_aux_notification_msix_vector </span>if the value
written to <span 
class="aeti-10">driver_aux_notification_select </span>is not a valid notification index.
<!--l. 1346--><p class="noindent" >Device MUST return VIRTIO_MSI_NO_VECTOR for reads from
<span 
class="aeti-10">driver_aux_notification_msix_vector </span>if the value written to <span 
class="aeti-10">driver_aux_notification_select</span>
is not a valid notification index.
                                                                  

                                                                  
<a 
 id="x1-140001r139"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.9   </span> <a 
 id="x1-1410009"></a>Shared memory capability</h5>
<!--l. 1352--><p class="noindent" >Shared memory regions <a 
href="#x1-10200010">2.10<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Shared Memory Regions --></a> are enumerated on the PCI transport as a sequence of
VIRTIO_PCI_CAP_SHARED_MEMORY_CFG capabilities, one per region.
<!--l. 1356--><p class="noindent" >The capability is defined by a struct virtio_pci_cap64 and utilises the <span 
class="aeti-10">cap.id </span>to allow
multiple shared memory regions per device. The identifier in <span 
class="aeti-10">cap.id </span>does not
denote a certain order of preference; it is only used to uniquely identify a
region.
<a 
 id="x1-141001r140"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.9.1</span> <a 
 id="x1-1420001"></a>Device Requirements: Shared memory capability</h5>
The region defined by the combination of the <span 
class="aeti-10">cap.offset</span>, <span 
class="aeti-10">offset_hi</span>, and <span 
class="aeti-10">cap.length</span>,
<span 
class="aeti-10">length_hi </span>fields MUST be contained within the BAR specified by <span 
class="aeti-10">cap.bar</span>.
<!--l. 1369--><p class="noindent" >The <span 
class="aeti-10">cap.id </span>MUST be unique for any one device instance.
<a 
 id="x1-142001r141"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.10   </span> <a 
 id="x1-14300010"></a>Vendor data capability</h5>
<!--l. 1375--><p class="noindent" >The optional Vendor data capability allows the device to present vendor-specific data
to the driver, without conflicts, for debugging and/or reporting purposes, and
without conflicting with standard functionality.
<!--l. 1380--><p class="noindent" >This capability augments but does not replace the standard subsystem ID and
subsystem vendor ID fields (offsets 0x2C and 0x2E in the PCI configuration space
header) as specified by <a 
href="#x1-3001r1">[PCI]</a>.
<!--l. 1385--><p class="noindent" >Vendor data capability is enumerated on the PCI transport as a
VIRTIO_PCI_CAP_VENDOR_CFG capability.
<!--l. 1388--><p class="noindent" >The capability has the following structure: <!--l. 1389-->
<div class="lstlisting" id="listing-39"><span class="label"><a 
 id="x1-143001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_vndr_data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-143002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap_vndr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Generic</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCI_CAP_ID_VNDR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-143003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap_next</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Generic</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ptr</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-143004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Generic</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">capability</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-143005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cfg_type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Identifies</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">structure</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-143006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vendor_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Identifies</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vendor</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">format</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-143007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Vendor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Definition</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-143008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Pads</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">structure</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">multiple</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-143009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Reads</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">must</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">not</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">have</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">side</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">effects</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-143010r10"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1402--><p class="noindent" >Where <span 
class="aeti-10">vendor_id </span>identifies the PCI-SIG assigned Vendor ID as specified by
<a 
href="#x1-3001r1">[PCI]</a>.
<!--l. 1405--><p class="noindent" >Note that the capability size is required to be a multiple of 4.
<!--l. 1407--><p class="noindent" >To make it safe for a generic driver to access the capability, reads from this capability
MUST NOT have any side effects.
<a 
 id="x1-143011r142"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.10.1</span> <a 
 id="x1-1440001"></a>Device Requirements: Vendor data capability</h5>
Devices CAN present <span 
class="aeti-10">vendor_id </span>that does not match either the PCI Vendor ID or the
PCI Subsystem Vendor ID.
                                                                  

                                                                  
<!--l. 1417--><p class="noindent" >Devices CAN present multiple Vendor data capabilities with either different or
identical <span 
class="aeti-10">vendor_id </span>values.
<!--l. 1420--><p class="noindent" >The value <span 
class="aeti-10">vendor_id </span>MUST NOT equal 0x1AF4.
<!--l. 1422--><p class="noindent" >The size of the Vendor data capability MUST be a multiple of 4 bytes.
<!--l. 1424--><p class="noindent" >Reads of the Vendor data capability by the driver MUST NOT have any side
effects.
<a 
 id="x1-144001r144"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.10.2</span> <a 
 id="x1-1450002"></a>Driver Requirements: Vendor data capability</h5>
The driver SHOULD NOT use the Vendor data capability except for debugging and
reporting purposes.
<!--l. 1434--><p class="noindent" >The driver MUST qualify the <span 
class="aeti-10">vendor_id </span>before interpreting or writing into the
Vendor data capability.
<a 
 id="x1-145001r143"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.11   </span> <a 
 id="x1-14600011"></a>PCI configuration access capability</h5>
<!--l. 1439--><p class="noindent" >The VIRTIO_PCI_CAP_PCI_CFG capability creates an alternative (and likely
suboptimal) access method to the common configuration, notification, ISR and
device-specific configuration regions.
<!--l. 1443--><p class="noindent" >The capability is immediately followed by an additional field like so:
<!--l. 1445-->
<div class="lstlisting" id="listing-40"><span class="label"><a 
 id="x1-146001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_cfg_cap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-146002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pci_cap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cap</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-146003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pci_cfg_data</span><span 
class="pcrr8t-x-x-80">[4];</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">BAR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">access</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-146004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1452--><p class="noindent" >The fields <span 
class="aeti-10">cap.bar</span>, <span 
class="aeti-10">cap.length</span>, <span 
class="aeti-10">cap.offset </span>and <span 
class="aeti-10">pci_cfg_data </span>are read-write (RW) for the
driver.
<!--l. 1455--><p class="noindent" >To access a device region, the driver writes into the capability structure (ie. within
the PCI configuration space) as follows:
     <ul class="itemize1">
     <li class="itemize">The driver sets the BAR to access by writing to <span 
class="aeti-10">cap.bar</span>.
     </li>
     <li class="itemize">The driver sets the size of the access by writing 1, 2 or 4 to <span 
class="aeti-10">cap.length</span>.
     </li>
     <li class="itemize">The driver sets the offset within the BAR by writing to <span 
class="aeti-10">cap.offset</span>.</li></ul>
<!--l. 1468--><p class="noindent" >At that point, <span 
class="aeti-10">pci_cfg_data </span>will provide a window of size <span 
class="aeti-10">cap.length </span>into the given
<span 
class="aeti-10">cap.bar </span>at offset <span 
class="aeti-10">cap.offset</span>.
<a 
 id="x1-146005r145"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">4.1.4.11.1</span> <a 
 id="x1-1470001"></a>Device Requirements: PCI configuration access capability</h5>
The device MUST present at least one VIRTIO_PCI_CAP_PCI_CFG capability.
<!--l. 1475--><p class="noindent" >Upon detecting driver write access to <span 
class="aeti-10">pci_cfg_data</span>, the device MUST execute a write
access at offset <span 
class="aeti-10">cap.offset </span>at BAR selected by <span 
class="aeti-10">cap.bar </span>using the first <span 
class="aeti-10">cap.length </span>bytes
from <span 
class="aeti-10">pci_cfg_data</span>.
<!--l. 1480--><p class="noindent" >Upon detecting driver read access to <span 
class="aeti-10">pci_cfg_data</span>, the device MUST execute a read
access of length cap.length at offset <span 
class="aeti-10">cap.offset </span>at BAR selected by <span 
class="aeti-10">cap.bar </span>and store
the first <span 
class="aeti-10">cap.length </span>bytes in <span 
class="aeti-10">pci_cfg_data</span>.
<a 
 id="x1-147001r147"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.4.11.2</span> <a 
 id="x1-1480002"></a>Driver Requirements: PCI configuration access capability</h5>
The driver MUST NOT write a <span 
class="aeti-10">cap.offset </span>which is not a multiple of <span 
class="aeti-10">cap.length </span>(ie. all
accesses MUST be aligned).
<!--l. 1491--><p class="noindent" >The driver MUST NOT read or write <span 
class="aeti-10">pci_cfg_data </span>unless <span 
class="aeti-10">cap.bar</span>, <span 
class="aeti-10">cap.length </span>and
<span 
class="aeti-10">cap.offset </span>address <span 
class="aeti-10">cap.length </span>bytes within a BAR range specified by some other
Virtio Structure PCI Capability of type other than <span 
class="aeti-10">VIRTIO_PCI_CAP_PCI_CFG</span>.
<a 
 id="x1-148001r146"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.12   </span> <a 
 id="x1-14900012"></a>Legacy Interfaces: A Note on PCI Device Layout</h5>
<!--l. 1499--><p class="noindent" >Transitional devices MUST present part of configuration registers in a legacy
configuration structure in BAR0 in the first I/O region of the PCI device, as
documented below. When using the legacy interface, transitional drivers MUST use
the legacy configuration structure in BAR0 in the first I/O region of the PCI device,
as documented below.
<!--l. 1506--><p class="noindent" >When using the legacy interface the driver MAY access the device-specific
configuration region using any width accesses, and a transitional device MUST
present driver with the same results as when accessed using the “natural” access
method (i.e. 32-bit accesses for 32-bit fields, etc).
<!--l. 1512--><p class="noindent" >Note that this is possible because while the virtio common configuration structure is
PCI (i.e. little) endian, when using the legacy interface the device-specific
configuration region is encoded in the native endian of the guest (where such
distinction is applicable).
<!--l. 1517--><p class="noindent" >When used through the legacy interface, the virtio common configuration structure
looks as follows:
<!--l. 1529--><p class="noindent" ><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Bits   </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 32    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 32    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 32    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 8     </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 8     </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >Read
 /
 Write  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R     </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R+W </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R+W </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R     </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R+W </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R+W </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R+W </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Purpose</td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device
 Features
 bits
 0:31   </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Driver
 Features
 bits
 0:31   </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Queue
 Address</td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">queue_size</span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ><span 
class="aeti-10">queue_select</span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >Queue
 Notify </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device
 Status </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > ISR <br 
class="newline" />Status </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >       </td>
</tr></table>
                                                                  

                                                                  
<!--l. 1531--><p class="noindent" >If MSI-X is enabled for the device, two additional fields immediately follow this
header:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Bits                   </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16                       </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16                       </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Read/Write         </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R+W                  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > R+W                  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Purpose (MSI-X)  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">config_msix_vector  </span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">queue_msix_vector  </span></td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 1544--><p class="noindent" >Note: When MSI-X capability is enabled, device-specific configuration starts at byte
offset 24 in virtio common configuration structure structure. When MSI-X capability
is not enabled, device-specific configuration starts at byte offset 20 in virtio header.
ie. once you enable MSI-X on the device, the other fields move. If you turn it off
again, they move back!
<!--l. 1550--><p class="noindent" >Any device-specific configuration space immediately follows these general
headers:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Bits              </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device Specific  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <div class="multirow"><!-- rows=13 -->
…</div>  </td></tr><tr class="row-2"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >
</td></tr><tr 
class="cline"><td><hr></td><td><hr></td><td></td></tr><tr class="row-3"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Read / Write  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device Specific  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >   </td></tr><tr class="row-4"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >
</td></tr><tr 
class="cline"><td><hr></td><td><hr></td><td></td></tr><tr class="row-5"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Purpose         </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device Specific  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >   </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-6"><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 1563--><p class="noindent" >When accessing the device-specific configuration space using the legacy interface,
transitional drivers MUST access the device-specific configuration space at an offset
immediately following the general headers.
<!--l. 1568--><p class="noindent" >When using the legacy interface, transitional devices MUST present the
device-specific configuration space if any at an offset immediately following the
general headers.
<!--l. 1572--><p class="noindent" >Note that only Feature Bits 0 to 31 are accessible through the Legacy Interface.
When used through the Legacy Interface, Transitional Devices MUST assume that
Feature Bits 32 to 63 are not acknowledged by Driver.
<!--l. 1577--><p class="noindent" >As legacy devices had no <span 
class="aeti-10">config_generation </span>field, see <a 
href="#x1-260004">2.5.4<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Configuration Space / Legacy Interface: Device Configuration Space --></a> <a 
href="#x1-260004">Legacy Interface: Device
Configuration Space<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Configuration Space / Legacy Interface: Device Configuration Space --></a> for workarounds.
<a 
 id="x1-149001r149"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.4.13   </span> <a 
 id="x1-15000013"></a>Non-transitional Device With Legacy Driver: A Note on PCI Device
Layout</h5>
<!--l. 1587--><p class="noindent" >All known legacy drivers check either the PCI Revision or the Device and Vendor
IDs, and thus won’t attempt to drive a non-transitional device.
<!--l. 1591--><p class="noindent" >A buggy legacy driver might mistakenly attempt to drive a non-transitional device. If
support for such drivers is required (as opposed to fixing the bug), the following
would be the recommended way to detect and handle them.
<span 
class="aeb10-">Note:</span> Such buggy drivers are not currently known to be used in production.
<a 
 id="x1-150001r1"></a>
                                                                  

                                                                  
<h6 class="subparagraphHead"><span class="titlemark">4.1.4.13.0.1</span> <a 
 id="x1-1510001"></a>Device Requirements: Non-transitional Device With Legacy Driver</h6>
Non-transitional devices, on a platform where a legacy driver for a legacy device with
the same ID (including PCI Revision, Device and Vendor IDs) is known to have
previously existed, SHOULD take the following steps to cause the legacy driver to fail
gracefully when it attempts to drive them:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-151002x1">Present an I/O BAR in BAR0, and
     </li>
     <li 
  class="enumerate" id="x1-151004x2">Respond to a single-byte zero write to offset 18 (corresponding to Device
     Status register in the legacy layout) of BAR0 by presenting zeroes on every
     BAR and ignoring writes.</li></ol>
<a 
 id="x1-151005r124"></a>
<h4 class="subsectionHead"><span class="titlemark">4.1.5   </span> <a 
 id="x1-1520005"></a>PCI-specific Initialization And Device Operation</h4>
<a 
 id="x1-152001r150"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.5.1   </span> <a 
 id="x1-1530001"></a>Device Initialization</h5>
<!--l. 1627--><p class="noindent" >This documents PCI-specific steps executed during Device Initialization.
<a 
 id="x1-153001r148"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.5.1.1</span> <a 
 id="x1-1540001"></a>Virtio Device Configuration Layout Detection</h5>
As a prerequisite to device initialization, the driver scans the PCI capability list,
detecting virtio configuration layout using Virtio Structure PCI capabilities as
detailed in <a 
href="#x1-1240004">4.1.4<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / Virtio Structure PCI Capabilities --></a>
<a 
 id="x1-154001r151"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.1.5.1.1.1</span> <a 
 id="x1-1550001"></a>Legacy Interface: A Note on Device Layout Detection</h6>
Legacy drivers skipped the Device Layout Detection step, assuming legacy device
configuration space in BAR0 in I/O space unconditionally.
<!--l. 1640--><p class="noindent" >Legacy devices did not have the Virtio PCI Capability in their capability
list.
<!--l. 1643--><p class="noindent" >Therefore:
<!--l. 1645--><p class="noindent" >Transitional devices MUST expose the Legacy Interface in I/O space in
BAR0.
<!--l. 1648--><p class="noindent" >Transitional drivers MUST look for the Virtio PCI Capabilities on the capability list.
If these are not present, driver MUST assume a legacy device, and use it through the
legacy interface.
<!--l. 1653--><p class="noindent" >Non-transitional drivers MUST look for the Virtio PCI Capabilities on the capability
list. If these are not present, driver MUST assume a legacy device, and fail
gracefully.
<a 
 id="x1-155001r154"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">4.1.5.1.2</span> <a 
 id="x1-1560002"></a>MSI-X Vector Configuration</h5>
When MSI-X capability is present and enabled in the device (through
standard PCI configuration space) <span 
class="aeti-10">config_msix_vector</span>, <span 
class="aeti-10">queue_msix_vector </span>and
<span 
class="aeti-10">driver_aux_notification_msix_vector </span>are used to map configuration change, queue and
device-specific interrupts to MSI-X vectors respectively. In this case, the ISR Status
is unused.
<!--l. 1666--><p class="noindent" >Writing a valid MSI-X Table entry number, 0 to 0x7FF, to
<span 
class="aeti-10">config_msix_vector</span>/<span 
class="aeti-10">queue_msix_vector</span>/<span 
class="aeti-10">driver_aux_notification_msix_vector </span>maps
interrupts triggered by the configuration change/selected queue/device-specific events
respectively to the corresponding MSI-X vector. To disable interrupts for an
event type, the driver unmaps this event by writing a special NO_VECTOR
value:
<!--l. 1673-->
<div class="lstlisting" id="listing-41"><span class="label"><a 
 id="x1-156001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Vector</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">value</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">disable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">MSI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-156002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_MSI_NO_VECTOR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">xffff</span>
</div>
<!--l. 1678--><p class="noindent" >Note that mapping an event to vector might require device to allocate internal device
resources, and thus could fail.
<a 
 id="x1-156003r155"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.1.5.1.2.1</span> <a 
 id="x1-1570001"></a>Device Requirements: MSI-X Vector Configuration</h6>
A device that has an MSI-X capability SHOULD support at least 2 and at most
0x800 MSI-X vectors.
<!--l. 1686--><p class="noindent" >A device that has an MSI-X capability MUST support atleast: <!--l. 1687-->
<div class="lstlisting" id="listing-42"><span class="label"><a 
 id="x1-157001r1"></a></span><span 
class="pcrr8t-x-x-80">num_msix_vectors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&gt;=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">config_msix_vector</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_vqs</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue_msix_vectors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_driver_aux_notifications</span>
</div>
<!--l. 1690--><p class="noindent" >where num_vqs is the number of virtqueues and num_driver_aux_notifications is the
number of driver auxiliary notifications.
<!--l. 1693--><p class="noindent" >Device MUST report the number of vectors supported in <span 
class="aeti-10">Table Size </span>in the MSI-X
Capability as specified in <a 
href="#x1-3001r1">[PCI]</a>. The device SHOULD restrict the reported MSI-X
Table Size field to a value that might benefit system performance.
<span 
class="aeb10-">Note:</span> For example, a device which does not expect to send interrupts at a high
      rate might only specify 2 MSI-X vectors.
<!--l. 1702--><p class="noindent" >Device MUST support mapping any event type to any valid vector 0 to MSI-X <span 
class="aeti-10">Table</span>
<span 
class="aeti-10">Size</span>. Device MUST support unmapping any event type.
                                                                  

                                                                  
<!--l. 1706--><p class="noindent" >The device MUST return the vector mapped to a given event, (NO_VECTOR if unmapped)
on read of <span 
class="aeti-10">config_msix_vector</span>/<span 
class="aeti-10">queue_msix_vector</span>/<span 
class="aeti-10">driver_aux_notification_msix_vector</span>.
The device MUST have all queue/configuration change/device-specific events
unmapped upon reset.
<!--l. 1712--><p class="noindent" >Devices SHOULD NOT cause mapping an event to vector to fail unless it is
impossible for the device to satisfy the mapping request. Devices MUST report
mapping failures by returning the NO_VECTOR value when the relevant
<span 
class="aeti-10">config_msix_vector</span>/<span 
class="aeti-10">queue_msix_vector</span>/<span 
class="aeti-10">driver_aux_notification_msix_vector </span>field is
read.
<a 
 id="x1-157002r157"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.1.5.1.2.2</span> <a 
 id="x1-1580002"></a>Driver Requirements: MSI-X Vector Configuration</h6>
Driver MUST support device with any MSI-X Table Size 0 to 0x7FF. Driver MAY
fall back on using INT#x interrupts for a device which only supports one MSI-X
vector (MSI-X Table Size = 0).
<!--l. 1725--><p class="noindent" >Driver MAY intepret the Table Size as a hint from the device for the suggested
number of MSI-X vectors to use.
<!--l. 1728--><p class="noindent" >Driver MUST NOT attempt to map an event to a vector outside the MSI-X Table
supported by the device, as reported by <span 
class="aeti-10">Table Size </span>in the MSI-X Capability.
<!--l. 1732--><p class="noindent" >After mapping an event to vector, the driver MUST verify success by reading the
Vector field value: on success, the previously written value is returned, and on
failure, NO_VECTOR is returned. If a mapping failure is detected, the driver
MAY retry mapping with fewer vectors, disable MSI-X or report device
failure.
<a 
 id="x1-158001r156"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.5.1.3</span> <a 
 id="x1-1590003"></a>Virtqueue Configuration</h5>
As a device can have zero or more virtqueues for bulk data
transport<span class="footnote-mark"><a 
href="#fn6x4" id="fn6x4-bk"><sup class="textsuperscript">6</sup></a></span><a 
 id="x1-159001f6"></a>,
the driver needs to configure them as part of the device-specific configuration.
<!--l. 1746--><p class="noindent" >The driver typically does this as follows, for each virtqueue a device has:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-159003x1">Write the virtqueue index (first queue is 0) to <span 
class="aeti-10">queue_select</span>.
     </li>
     <li 
  class="enumerate" id="x1-159005x2">Read  the  virtqueue  size  from  <span 
class="aeti-10">queue_size</span>.  This  controls  how  big  the
     virtqueue is (see <a 
href="#x1-270006">2.6<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues --></a> <a 
href="#x1-270006">Virtqueues<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues --></a>). If this field is 0, the virtqueue does not
     exist.
     </li>
     <li 
  class="enumerate" id="x1-159007x3">Optionally, select a smaller virtqueue size and write it to <span 
class="aeti-10">queue_size</span>.
     </li>
                                                                  

                                                                  
     <li 
  class="enumerate" id="x1-159009x4">Allocate  and  zero  Descriptor  Table,  Available  and  Used  rings  for  the
     virtqueue in contiguous physical memory.
     </li>
     <li 
  class="enumerate" id="x1-159011x5">Optionally,  if  MSI-X  capability  is  present  and  enabled  on  the  device,
     select a vector to use to request interrupts triggered by virtqueue events.
     Write the MSI-X Table entry number corresponding to this vector into
     <span 
class="aeti-10">queue_msix_vector</span>. Read <span 
class="aeti-10">queue_msix_vector</span>: on success, previously written
     value is returned; on failure, NO_VECTOR value is returned.</li></ol>
<a 
 id="x1-159012r158"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.1.5.1.3.1</span> <a 
 id="x1-1600001"></a>Legacy Interface: A Note on Virtqueue Configuration</h6>
When using the legacy interface, the queue layout follows <a 
href="#x1-370002">2.7.2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Layout --></a> <a 
href="#x1-370002">Legacy
Interfaces: A Note on Virtqueue Layout<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Layout --></a> with an alignment of 4096. Driver
writes the physical address, divided by 4096 to the Queue Address
field<span class="footnote-mark"><a 
href="#fn7x4" id="fn7x4-bk"><sup class="textsuperscript">7</sup></a></span><a 
 id="x1-160001f7"></a>.
There was no mechanism to negotiate the queue size.
<a 
 id="x1-160002r153"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.5.2   </span> <a 
 id="x1-1610002"></a>Available Buffer Notifications</h5>
<!--l. 1777--><p class="noindent" >When VIRTIO_F_NOTIFICATION_DATA has not been negotiated, the driver sends
an available buffer notification to the device by writing the 16-bit virtqueue index of
this virtqueue to the Queue Notify address.
<!--l. 1782--><p class="noindent" >When VIRTIO_F_NOTIFICATION_DATA has been negotiated, the driver sends an
available buffer notification to the device by writing the following 32-bit value to the
Queue Notify address: <!--l. 1785--><div class="lstinputlisting">
<a 
 id="x1-161001"></a>
<span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-161002r1"></a></span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-161003r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vqn</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-161004r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next_off</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">15;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-161005r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next_wrap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-161006r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1787--><p class="noindent" >See <a 
href="#x1-1010009">2.9<!--tex4ht:ref: sec:Virtqueues / Driver notifications --></a> <a 
href="#x1-1010009">Driver Notifications<!--tex4ht:ref: sec:Virtqueues / Driver notifications --></a> for the definition of the components.
<!--l. 1790--><p class="noindent" >See <a 
href="#x1-1300004">4.1.4.4<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Notification capability --></a> for how to calculate the Queue Notify address.
<a 
 id="x1-161007r159"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.5.2.1</span> <a 
 id="x1-1620001"></a>Driver Requirements: Available Buffer Notifications</h5>
If VIRTIO_F_NOTIF_CONFIG_DATA has been negotiated:
     <ul class="itemize1">
     <li class="itemize">If VIRTIO_F_NOTIFICATION_DATA has not been negotiated, the driver
     MUST use the <span 
class="aeti-10">queue_notify_data </span>value instead of the virtqueue index.
     </li>
     <li class="itemize">If  VIRTIO_F_NOTIFICATION_DATA  has  been  negotiated,  the  driver
     MUST set the <span 
class="aeti-10">vqn </span>field to the <span 
class="aeti-10">queue_notify_data </span>value.</li></ul>
                                                                  

                                                                  
<a 
 id="x1-162001r161"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.5.3   </span> <a 
 id="x1-1630003"></a>Used Buffer Notifications</h5>
<!--l. 1804--><p class="noindent" >If a used buffer notification is necessary for a virtqueue, the device would typically
act as follows:
     <ul class="itemize1">
     <li class="itemize">If MSI-X capability is disabled:
         <ol  class="enumerate1" >
         <li 
  class="enumerate" id="x1-163002x1">Set the lower bit of the ISR Status field for the device.
         </li>
         <li 
  class="enumerate" id="x1-163004x2">Send the appropriate PCI interrupt for the device.</li></ol>
     </li>
     <li class="itemize">If MSI-X capability is enabled:
         <ol  class="enumerate1" >
         <li 
  class="enumerate" id="x1-163006x1">If <span 
class="aeti-10">queue_msix_vector </span>is not NO_VECTOR, request the appropriate
         MSI-X interrupt message for the device, <span 
class="aeti-10">queue_msix_vector </span>sets the
         MSI-X Table entry number.</li></ol>
     </li></ul>
<a 
 id="x1-163007r163"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.5.3.1</span> <a 
 id="x1-1640001"></a>Device Requirements: Used Buffer Notifications</h5>
If MSI-X capability is enabled and <span 
class="aeti-10">queue_msix_vector </span>is NO_VECTOR for a
virtqueue, the device MUST NOT deliver an interrupt for that virtqueue.
<a 
 id="x1-164001r164"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.5.4   </span> <a 
 id="x1-1650004"></a>Notification of Device Configuration Changes</h5>
<!--l. 1831--><p class="noindent" >Some virtio PCI devices can change the device configuration state, as reflected in the
device-specific configuration region of the device. In this case:
     <ul class="itemize1">
     <li class="itemize">If MSI-X capability is disabled:
         <ol  class="enumerate1" >
         <li 
  class="enumerate" id="x1-165002x1">Set the second lower bit of the ISR Status field for the device.
         </li>
         <li 
  class="enumerate" id="x1-165004x2">Send the appropriate PCI interrupt for the device.</li></ol>
     </li>
     <li class="itemize">If MSI-X capability is enabled:
         <ol  class="enumerate1" >
         <li 
  class="enumerate" id="x1-165006x1">If <span 
class="aeti-10">config_msix_vector </span>is not NO_VECTOR, request the appropriate
         MSI-X interrupt message for the device, <span 
class="aeti-10">config_msix_vector </span>sets the
         MSI-X Table entry number.</li></ol>
                                                                  

                                                                  
     </li></ul>
<!--l. 1851--><p class="noindent" >A single interrupt MAY indicate both that one or more virtqueue has been used and
that the configuration space has changed.
<a 
 id="x1-165007r165"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.5.4.1</span> <a 
 id="x1-1660001"></a>Device Requirements: Notification of Device Configuration Changes</h5>
If MSI-X capability is enabled and <span 
class="aeti-10">config_msix_vector </span>is NO_VECTOR,
the device MUST NOT deliver an interrupt for device configuration space
changes.
<a 
 id="x1-166001r167"></a>
<h5 class="paragraphHead"><span class="titlemark">4.1.5.4.2</span> <a 
 id="x1-1670002"></a>Driver Requirements: Notification of Device Configuration Changes</h5>
A driver MUST handle the case where the same interrupt is used to indicate
both device configuration space change and one or more virtqueues being
used.
<a 
 id="x1-167001r166"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.1.5.5   </span> <a 
 id="x1-1680005"></a>Driver Handling Interrupts</h5>
<!--l. 1866--><p class="noindent" >The driver interrupt handler would typically:
     <ul class="itemize1">
     <li class="itemize">If MSI-X capability is disabled:
         <ul class="itemize2">
         <li class="itemize">Read the ISR Status field, which will reset it to zero.
         </li>
         <li class="itemize">If the lower bit is set: look through all virtqueues for the device, to see
         if any progress has been made by the device which requires servicing.
         </li>
         <li class="itemize">If the second lower bit is set: re-examine the configuration space to
         see what changed.</li></ul>
     </li>
     <li class="itemize">If MSI-X capability is enabled:
         <ul class="itemize2">
         <li class="itemize">Look through all virtqueues mapped to that MSI-X vector for the
         device, to see if any progress has been made by the device which
         requires servicing.
         </li>
         <li class="itemize">If the MSI-X vector is equal to <span 
class="aeti-10">config_msix_vector</span>, re-examine the
         configuration space to see what changed.</li></ul>
     </li></ul>
<a 
 id="x1-168001r115"></a>
                                                                  

                                                                  
<h3 class="sectionHead"><span class="titlemark">4.2   </span> <a 
 id="x1-1690002"></a>Virtio Over MMIO</h3>
<!--l. 1893--><p class="noindent" >Virtual environments without PCI support (a common situation in embedded devices
models) might use simple memory mapped device (“virtio-mmio”) instead of the PCI
device.
<!--l. 1897--><p class="noindent" >The memory mapped virtio device behaviour is based on the PCI device
specification. Therefore most operations including device initialization, queues
configuration and buffer transfers are nearly identical. Existing differences are
described in the following sections.
<a 
 id="x1-169001r152"></a>
<h4 class="subsectionHead"><span class="titlemark">4.2.1   </span> <a 
 id="x1-1700001"></a>MMIO Device Discovery</h4>
<!--l. 1905--><p class="noindent" >Unlike PCI, MMIO provides no generic device discovery mechanism. For each device,
the guest OS will need to know the location of the registers and interrupt(s) used.
The suggested binding for systems using flattened device trees is shown in this
example:
<!--l. 1910-->
<div class="lstlisting" id="listing-43"><span class="label"><a 
 id="x1-170001r1"></a></span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">EXAMPLE</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">taking</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">512</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">at</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x1e000</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">interrupt</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">42.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-170002r2"></a></span><span 
class="pcrr8t-x-x-80">virtio_block@1e000</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-170003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">compatible</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">"</span><span 
class="pcrr8t-x-x-80">virtio</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80">mmio</span><span 
class="pcrr8t-x-x-80">";</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-170004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reg</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;0</span><span 
class="pcrr8t-x-x-80">x1e000</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x200</span><span 
class="pcrr8t-x-x-80">&gt;;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-170005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">interrupts</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;42&gt;;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-170006r6"></a></span><span 
class="pcrr8t-x-x-80">}</span>
</div>
<a 
 id="x1-170007r171"></a>
<h4 class="subsectionHead"><span class="titlemark">4.2.2   </span> <a 
 id="x1-1710002"></a>MMIO Device Register Layout</h4>
<!--l. 1921--><p class="noindent" >MMIO virtio devices provide a set of memory mapped control registers followed by a
device-specific configuration space, described in the table <a 
href="#x1-171001r1">4.1<!--tex4ht:ref: tab:Virtio Trasport Options / Virtio Over MMIO / MMIO Device Register Layout --></a>.
<!--l. 1925--><p class="noindent" >All register values are organized as Little Endian.
<a 
 id="x1-171001r1"></a>
<!--l. 1936--><div class="longtable"> <table id="TBL-14" class="longtable" 
cellspacing="0" cellpadding="0"  
><colgroup id="TBL-14-1g"><col 
id="TBL-14-1"><col 
id="TBL-14-2"></colgroup>
                                                                  

                                                                  
<tr  
 style="vertical-align:baseline;" id="TBL-14-1-"><td colspan="2" style="white-space:nowrap; text-align:center;" id="TBL-14-1-1"  
class="td11">    <div class="multicolumn"  style="white-space:nowrap; text-align:center;"> <div class="caption" 
><span class="id">Table 4.1</span><span  
class="content">MMIO Device Register Layout</span></div><!--tex4ht:label?: x1-171001r1 -->                                 </div>        <a 
 id="x1-171002"></a>
</td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-2-"><td  style="white-space:normal; text-align:left;" id="TBL-14-2-1"  
class="td11">
 <!--l. 1939--><p class="noindent" ><span 
class="aeti-10">Name </span><br 
class="newline" />Offset       from
  base <br 
class="newline" />Direction          </td><td  style="white-space:normal; text-align:left;" id="TBL-14-2-2"  
class="td11">
 <!--l. 1939--><p class="noindent" ><span 
class="aeb10-">Function </span><br 
class="newline" />Description                                                           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-3-"><td  style="white-space:normal; text-align:left;" id="TBL-14-3-1"  
class="td11">
 <!--l. 1942--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-14-4-"><td  style="white-space:normal; text-align:left;" id="TBL-14-4-1"  
class="td11">               </td><td  style="white-space:normal; text-align:left;" id="TBL-14-4-2"  
class="td11">
</td></tr>
<tr  
 style="vertical-align:baseline;" id="TBL-14-12-"><td  style="white-space:normal; text-align:left;" id="TBL-14-12-1"  
class="td11">
 <!--l. 1953--><p class="noindent" ><span 
class="aeti-10">MagicValue </span><br 
class="newline" />0x000 <br 
class="newline" />R                    </td><td  style="white-space:normal; text-align:left;" id="TBL-14-12-2"  
class="td11">
 <!--l. 1953--><p class="noindent" ><span 
class="aeb10-">Magic value </span><br 
class="newline" />0x74726976  (a  Little  Endian  equivalent  of  the  “virt”
  string).                                                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-13-"><td  style="white-space:normal; text-align:left;" id="TBL-14-13-1"  
class="td11">
 <!--l. 1960--><p class="noindent" ><span 
class="aeti-10">Version </span><br 
class="newline" />0x004 <br 
class="newline" />R                    </td><td  style="white-space:normal; text-align:left;" id="TBL-14-13-2"  
class="td11">
 <!--l. 1960--><p class="noindent" ><span 
class="aeb10-">Device version number </span><br 
class="newline" />0x2.
  <span 
class="aeb10-">Note:</span>  Legacy devices (see <a 
href="#x1-1810004">4.2.4<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over MMIO / Legacy interface --></a> <a 
href="#x1-1810004">Legacy interface<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over MMIO / Legacy interface --></a>) used
           0x1.
  <!--l. 1961--><p class="noindent" >                                                                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-14-"><td  style="white-space:normal; text-align:left;" id="TBL-14-14-1"  
class="td11">
 <!--l. 1968--><p class="noindent" ><span 
class="aeti-10">DeviceID </span><br 
class="newline" />0x008 <br 
class="newline" />R                    </td><td  style="white-space:normal; text-align:left;" id="TBL-14-14-2"  
class="td11">
 <!--l. 1968--><p class="noindent" ><span 
class="aeb10-">Virtio Subsystem Device ID </span><br 
class="newline" />See  <a 
href="#x1-2200005">5<!--tex4ht:ref: sec:Device Types --></a> <a 
href="#x1-2200005">Device  Types<!--tex4ht:ref: sec:Device Types --></a>  for  possible  values.  Value  zero
  (0x0)  is  used  to  define  a  system  memory  map  with
  placeholder  devices  at  static,  well  known  addresses,
  assigning functions to them depending on user’s needs.  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-15-"><td  style="white-space:normal; text-align:left;" id="TBL-14-15-1"  
class="td11">
 <!--l. 1970--><p class="noindent" ><span 
class="aeti-10">VendorID </span><br 
class="newline" />0x00c <br 
class="newline" />R                    </td><td  style="white-space:normal; text-align:left;" id="TBL-14-15-2"  
class="td11">
 <!--l. 1970--><p class="noindent" ><span 
class="aeb10-">Virtio Subsystem Vendor ID </span><br 
class="newline" />                                                                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-16-"><td  style="white-space:normal; text-align:left;" id="TBL-14-16-1"  
class="td11">
 <!--l. 1980--><p class="noindent" ><span 
class="aeti-10">DeviceFeatures </span><br 
class="newline" />0x010 <br 
class="newline" />R                    </td><td  style="white-space:normal; text-align:left;" id="TBL-14-16-2"  
class="td11">
 <!--l. 1980--><p class="noindent" ><span 
class="aeb10-">Flags representing features the device supports </span><br 
class="newline" />Reading  from  this  register  returns  32  consecutive
  flag  bits,  the  least  significant  bit  depending  on  the
  last  value  written  to  <span 
class="aeti-10">DeviceFeaturesSel</span>.  Access  to
  this  register  returns  bits  <span 
class="aeti-10">DeviceFeaturesSel</span> <span 
class="cmsy-10">∗ </span><span 
class="cmr-10">32  </span>to
  <span 
class="cmr-10">(</span><span 
class="aeti-10">DeviceFeaturesSel</span> <span 
class="cmsy-10">∗ </span><span 
class="cmr-10">32) + 31</span>, eg. feature bits 0 to 31 if
  <span 
class="aeti-10">DeviceFeaturesSel </span>is set to 0 and features bits 32 to 63 if
  <span 
class="aeti-10">DeviceFeaturesSel </span>is set to 1. Also see <a 
href="#x1-140002">2.2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Feature Bits --></a> <a 
href="#x1-140002">Feature Bits<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Feature Bits --></a>.  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-17-"><td  style="white-space:normal; text-align:left;" id="TBL-14-17-1"  
class="td11">
 <!--l. 1985--><p class="noindent" ><span 
class="aeti-10">DeviceFeaturesSel</span>
  <br 
class="newline" />0x014 <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-14-17-2"  
class="td11">
 <!--l. 1985--><p class="noindent" ><span 
class="aeb10-">Device (host) features word selection. </span><br 
class="newline" />Writing to this register selects a set of 32 device feature
  bits accessible by reading from <span 
class="aeti-10">DeviceFeatures</span>.             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-18-"><td  style="white-space:normal; text-align:left;" id="TBL-14-18-1"  
class="td11">
 <!--l. 1994--><p class="noindent" ><span 
class="aeti-10">DriverFeatures </span><br 
class="newline" />0x020 <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-14-18-2"  
class="td11">
 <!--l. 1994--><p class="noindent" ><span 
class="aeb10-">Flags  representing  device  features  understood  and</span>
  <span 
class="aeb10-">activated by the driver </span><br 
class="newline" />Writing to this register sets 32 consecutive flag bits, the
  least significant bit depending on the last value written
  to <span 
class="aeti-10">DriverFeaturesSel</span>. Access to this register sets bits
  <span 
class="aeti-10">DriverFeaturesSel</span> <span 
class="cmsy-10">∗ </span><span 
class="cmr-10">32 </span>to <span 
class="cmr-10">(</span><span 
class="aeti-10">DriverFeaturesSel</span> <span 
class="cmsy-10">∗ </span><span 
class="cmr-10">32) + 31</span>,
  eg. feature bits 0 to 31 if <span 
class="aeti-10">DriverFeaturesSel </span>is set to 0
  and features bits 32 to 63 if <span 
class="aeti-10">DriverFeaturesSel </span>is set to
  1. Also see <a 
href="#x1-140002">2.2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Feature Bits --></a> <a 
href="#x1-140002">Feature Bits<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Feature Bits --></a>.                                     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-19-"><td  style="white-space:normal; text-align:left;" id="TBL-14-19-1"  
class="td11">
 <!--l. 1999--><p class="noindent" ><span 
class="aeti-10">DriverFeaturesSel</span>
  <br 
class="newline" />0x024 <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-14-19-2"  
class="td11">
 <!--l. 1999--><p class="noindent" ><span 
class="aeb10-">Activated (guest) features word selection </span><br 
class="newline" />Writing  to  this  register  selects  a  set  of  32  activated
  feature bits accessible by writing to <span 
class="aeti-10">DriverFeatures</span>.       </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-20-"><td  style="white-space:normal; text-align:left;" id="TBL-14-20-1"  
class="td11">
 <!--l. 2007--><p class="noindent" ><span 
class="aeti-10">QueueSel </span><br 
class="newline" />0x030 <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-14-20-2"  
class="td11">
 <!--l. 2007--><p class="noindent" ><span 
class="aeb10-">Virtual queue index </span><br 
class="newline" />Writing to this register selects the virtual queue that
  the following operations on <span 
class="aeti-10">QueueNumMax</span>, <span 
class="aeti-10">QueueNum</span>,
  <span 
class="aeti-10">QueueReady</span>,       <span 
class="aeti-10">QueueDescLow</span>,       <span 
class="aeti-10">QueueDescHigh</span>,
  <span 
class="aeti-10">QueueDriverlLow</span>, <span 
class="aeti-10">QueueDriverHigh</span>, <span 
class="aeti-10">QueueDeviceLow</span>,
  <span 
class="aeti-10">QueueDeviceHigh </span>and <span 
class="aeti-10">QueueReset </span>apply to. The index
  number of the first queue is zero (0x0).                       </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-21-"><td  style="white-space:normal; text-align:left;" id="TBL-14-21-1"  
class="td11">
 <!--l. 2014--><p class="noindent" ><span 
class="aeti-10">QueueNumMax</span>
  <br 
class="newline" />0x034 <br 
class="newline" />R                    </td><td  style="white-space:normal; text-align:left;" id="TBL-14-21-2"  
class="td11">
 <!--l. 2014--><p class="noindent" ><span 
class="aeb10-">Maximum virtual queue size </span><br 
class="newline" />Reading  from  the  register  returns  the  maximum  size
  (number of elements) of the queue the device is ready to
  process or zero (0x0) if the queue is not available. This
  applies to the queue selected by writing to <span 
class="aeti-10">QueueSel</span>.     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-22-"><td  style="white-space:normal; text-align:left;" id="TBL-14-22-1"  
class="td11">
 <!--l. 2021--><p class="noindent" ><span 
class="aeti-10">QueueNum </span><br 
class="newline" />0x038 <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-14-22-2"  
class="td11">
 <!--l. 2021--><p class="noindent" ><span 
class="aeb10-">Virtual queue size </span><br 
class="newline" />Queue  size  is  the  number  of  elements  in  the  queue.
  Writing to this register notifies the device what size of
  the queue the driver will use. This applies to the queue
  selected by writing to <span 
class="aeti-10">QueueSel</span>.                                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-23-"><td  style="white-space:normal; text-align:left;" id="TBL-14-23-1"  
class="td11">
 <!--l. 2028--><p class="noindent" ><span 
class="aeti-10">QueueReady </span><br 
class="newline" />0x044 <br 
class="newline" />RW                  </td><td  style="white-space:normal; text-align:left;" id="TBL-14-23-2"  
class="td11">
 <!--l. 2028--><p class="noindent" ><span 
class="aeb10-">Virtual queue ready bit </span><br 
class="newline" />Writing one (0x1) to this register notifies the device that
  it can execute requests from this virtual queue. Reading
  from this register returns the last value written to it.
  Both read and write accesses apply to the queue selected
  by writing to <span 
class="aeti-10">QueueSel</span>.                                           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-24-"><td  style="white-space:normal; text-align:left;" id="TBL-14-24-1"  
class="td11">
 <!--l. 2044--><p class="noindent" ><span 
class="aeti-10">QueueNotify </span><br 
class="newline" />0x050 <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-14-24-2"  
class="td11">
 <!--l. 2044--><p class="noindent" ><span 
class="aeb10-">Queue notifier </span><br 
class="newline" />Writing a value to this register notifies the device that
  there are new buffers to process in a queue.
  <!--l. 2044--><p class="noindent" >When   VIRTIO_F_NOTIFICATION_DATA   has   not
  been negotiated, the value written is the queue index.
  <!--l. 2044--><p class="noindent" >When  VIRTIO_F_NOTIFICATION_DATA  has  been
  negotiated, the <span 
class="aeti-10">Notification data </span>value has the following
  format:
  <!--l. 2044--><div class="lstinputlisting">
  <a 
 id="x1-171003"></a>
  <span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-171004r1"></a></span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-171005r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vqn</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-171006r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next_off</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">15;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-171007r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next_wrap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-171008r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
 
</div>
<!--l. 2044--><p class="noindent" >See  <a 
href="#x1-1010009">2.9<!--tex4ht:ref: sec:Virtqueues / Driver notifications --></a> <a 
href="#x1-1010009">Driver  Notifications<!--tex4ht:ref: sec:Virtqueues / Driver notifications --></a>  for  the  definition  of  the
components.                                                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-25-"><td  style="white-space:normal; text-align:left;" id="TBL-14-25-1"  
class="td11">
 <!--l. 2059--><p class="noindent" ><span 
class="aeti-10">InterruptStatus</span>
  <br 
class="newline" />0x60 <br 
class="newline" />R                    </td><td  style="white-space:normal; text-align:left;" id="TBL-14-25-2"  
class="td11">
 <!--l. 2059--><p class="noindent" ><span 
class="aeb10-">Interrupt status </span><br 
class="newline" />Reading from this register returns a bit mask of events that
  caused the device interrupt to be asserted. The following
  events are possible:
         <dl class="description"><dt class="description">
  <span 
class="aeb10-">Used Buffer Notification</span>  </dt><dd 
class="description">-  bit  0  -  the  interrupt  was
         asserted because the device has used a buffer in at
         least one of the active virtual queues.
         </dd><dt class="description">
  <span 
class="aeb10-">Configuration Change Notification</span>  </dt><dd 
class="description">-    bit    1    -    the
         interrupt was asserted because the configuration
         of the device has changed.
         </dd><dt class="description">
  <span 
class="aeb10-">Device-specific Driver Auxiliary Notification</span>  </dt><dd 
class="description">
         -  bit  2  -  the  interrupt  was  asserted  because  a
         device-specific event occurred to notify the driver.</dd></dl>
  <!--l. 2060--><p class="noindent" >                                                                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-26-"><td  style="white-space:normal; text-align:left;" id="TBL-14-26-1"  
class="td11">
 <!--l. 2065--><p class="noindent" ><span 
class="aeti-10">InterruptACK </span><br 
class="newline" />0x064 <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-14-26-2"  
class="td11">
 <!--l. 2065--><p class="noindent" ><span 
class="aeb10-">Interrupt acknowledge </span><br 
class="newline" />Writing           a           value           with           bits
  set as defined in <span 
class="aeti-10">InterruptStatus </span>to this register notifies
  the device that events causing the interrupt have been
  handled.                                                               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-27-"><td  style="white-space:normal; text-align:left;" id="TBL-14-27-1"  
class="td11">
 <!--l. 2074--><p class="noindent" ><span 
class="aeti-10">Status </span><br 
class="newline" />0x070 <br 
class="newline" />RW                  </td><td  style="white-space:normal; text-align:left;" id="TBL-14-27-2"  
class="td11">
 <!--l. 2074--><p class="noindent" ><span 
class="aeb10-">Device status </span><br 
class="newline" />Reading from this register returns the current device
  status flags. Writing non-zero values to this register sets
  the status flags, indicating the driver progress. Writing
  zero (0x0) to this register triggers a device reset. See
  also p. <a 
href="#x1-1750001">4.2.3.1<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over MMIO / MMIO-specific Initialization And Device Operation / Device Initialization --></a> <a 
href="#x1-1750001">Device Initialization<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over MMIO / MMIO-specific Initialization And Device Operation / Device Initialization --></a>.                           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-28-"><td  style="white-space:normal; text-align:left;" id="TBL-14-28-1"  
class="td11">
 <!--l. 2081--><p class="noindent" ><span 
class="aeti-10">QueueDescLow</span>
  <br 
class="newline" />0x080 <br 
class="newline" /><span 
class="aeti-10">QueueDescHigh</span>
  <br 
class="newline" />0x084 <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-14-28-2"  
class="td11">
 <!--l. 2081--><p class="noindent" ><span 
class="aeb10-">Virtual queue’s Descriptor Area 64 bit long physical</span>
  <span 
class="aeb10-">address </span><br 
class="newline" />Writing  to  these  two  registers  (lower  32  bits  of
  the  address  to  <span 
class="aeti-10">QueueDescLow</span>,  higher  32  bits  to
  <span 
class="aeti-10">QueueDescHigh</span>) notifies the device about location of
  the Descriptor Area of the queue selected by writing to
  <span 
class="aeti-10">QueueSel </span>register.                                                  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-29-"><td  style="white-space:normal; text-align:left;" id="TBL-14-29-1"  
class="td11">
 <!--l. 2088--><p class="noindent" ><span 
class="aeti-10">QueueDriverLow</span>
  <br 
class="newline" />0x090 <br 
class="newline" /><span 
class="aeti-10">QueueDriverHigh</span>
  <br 
class="newline" />0x094 <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-14-29-2"  
class="td11">
 <!--l. 2088--><p class="noindent" ><span 
class="aeb10-">Virtual queue’s Driver Area 64 bit long physical address</span>
  <br 
class="newline" />Writing  to  these  two  registers  (lower  32  bits  of
  the  address  to  <span 
class="aeti-10">QueueDriverLow</span>,  higher  32  bits  to
  <span 
class="aeti-10">QueueDriverHigh</span>) notifies the device about location of
  the  Driver  Area  of  the  queue  selected  by  writing  to
  <span 
class="aeti-10">QueueSel</span>.                                                             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-30-"><td  style="white-space:normal; text-align:left;" id="TBL-14-30-1"  
class="td11">
 <!--l. 2095--><p class="noindent" ><span 
class="aeti-10">QueueDeviceLow</span>
  <br 
class="newline" />0x0a0 <br 
class="newline" /><span 
class="aeti-10">QueueDeviceHigh</span>
  <br 
class="newline" />0x0a4 <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-14-30-2"  
class="td11">
 <!--l. 2095--><p class="noindent" ><span 
class="aeb10-">Virtual queue’s Device Area 64 bit long physical address</span>
  <br 
class="newline" />Writing  to  these  two  registers  (lower  32  bits  of
  the  address  to  <span 
class="aeti-10">QueueDeviceLow</span>,  higher  32  bits  to
  <span 
class="aeti-10">QueueDeviceHigh</span>) notifies the device about location of
  the  Device  Area  of  the  queue  selected  by  writing  to
  <span 
class="aeti-10">QueueSel</span>.                                                             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-31-"><td  style="white-space:normal; text-align:left;" id="TBL-14-31-1"  
class="td11">
 <!--l. 2101--><p class="noindent" ><span 
class="aeti-10">SHMSel </span><br 
class="newline" />0x0ac <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-14-31-2"  
class="td11">
 <!--l. 2101--><p class="noindent" ><span 
class="aeb10-">Shared memory id </span><br 
class="newline" />Writing  to  this  register  selects  the  shared  memory
  region   <a 
href="#x1-10200010">2.10<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Shared Memory Regions --></a>   following   operations   on   <span 
class="aeti-10">SHMLenLow</span>,
  <span 
class="aeti-10">SHMLenHigh</span>, <span 
class="aeti-10">SHMBaseLow </span>and <span 
class="aeti-10">SHMBaseHigh </span>apply
  to.                                                                       </td>

                                                                  
</tr><tr  
 style="vertical-align:baseline;" id="TBL-14-32-"><td  style="white-space:normal; text-align:left;" id="TBL-14-32-1"  
class="td11">
 <!--l. 2102--><p class="noindent" >            </td>
</tr>
<tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-33-"><td  style="white-space:normal; text-align:left;" id="TBL-14-33-1"  
class="td11">
 <!--l. 2111--><p class="noindent" ><span 
class="aeti-10">SHMLenLow </span><br 
class="newline" />0x0b0 <br 
class="newline" /><span 
class="aeti-10">SHMLenHigh </span><br 
class="newline" />0x0b4 <br 
class="newline" />R                    </td><td  style="white-space:normal; text-align:left;" id="TBL-14-33-2"  
class="td11">
 <!--l. 2111--><p class="noindent" ><span 
class="aeb10-">Shared memory region 64 bit long length </span><br 
class="newline" />These registers return the length of the shared memory
  region in bytes, as defined by the device for the region
  selected by the <span 
class="aeti-10">SHMSel </span>register. The lower 32 bits of
  the length are read from <span 
class="aeti-10">SHMLenLow </span>and the higher
  32 bits from <span 
class="aeti-10">SHMLenHigh</span>. Reading from a non-existent
  region (i.e. where the ID written to <span 
class="aeti-10">SHMSel </span>is unused)
  results in a length of -1.                                           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-34-"><td  style="white-space:normal; text-align:left;" id="TBL-14-34-1"  
class="td11">
 <!--l. 2122--><p class="noindent" ><span 
class="aeti-10">SHMBaseLow </span><br 
class="newline" />0x0b8 <br 
class="newline" /><span 
class="aeti-10">SHMBaseHigh </span><br 
class="newline" />0x0bc <br 
class="newline" />R                    </td><td  style="white-space:normal; text-align:left;" id="TBL-14-34-2"  
class="td11">
 <!--l. 2122--><p class="noindent" ><span 
class="aeb10-">Shared memory region 64 bit long physical address </span><br 
class="newline" />The  driver  reads  these  registers  to  discover  the  base
  address of the region in physical address space. This
  address  is  chosen  by  the  device  (or  other  part  of
  the  VMM).  The  lower  32  bits  of  the  address  are
  read from <span 
class="aeti-10">SHMBaseLow </span>with the higher 32 bits from
  <span 
class="aeti-10">SHMBaseHigh</span>. Reading from a non-existent region (i.e.
  where the ID written to <span 
class="aeti-10">SHMSel </span>is unused) results in a
  base address of 0xffffffffffffffff.                                    </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-35-"><td  style="white-space:normal; text-align:left;" id="TBL-14-35-1"  
class="td11">
 <!--l. 2128--><p class="noindent" ><span 
class="aeti-10">QueueReset </span><br 
class="newline" />0x0c0 <br 
class="newline" />RW                  </td><td  style="white-space:normal; text-align:left;" id="TBL-14-35-2"  
class="td11">
 <!--l. 2128--><p class="noindent" ><span 
class="aeb10-">Virtual queue reset bit </span><br 
class="newline" />If   VIRTIO_F_RING_RESET   has   been   negotiated,
  writing one (0x1) to this register selectively resets the
  queue. Both read and write accesses apply to the queue
  selected by writing to <span 
class="aeti-10">QueueSel</span>.                                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-36-"><td  style="white-space:normal; text-align:left;" id="TBL-14-36-1"  
class="td11">
 <!--l. 2135--><p class="noindent" ><span 
class="aeti-10">DeviceAuxNotificationIndex</span>
  <br 
class="newline" />0xd0 <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-14-36-2"  
class="td11">
 <!--l. 2135--><p class="noindent" ><span 
class="aeb10-">Device Auxiliary Notifier </span><br 
class="newline" />                                                               Writing
  to this register selects the device auxiliary notification
  index to which <span 
class="aeti-10">DeviceAuxiliaryNotificationData  </span>apply
  to.  The  number  of  device  auxiliary  notifications  and
  their purpose is device-specific.                                  </td>
                                                                  

                                                                  
</tr><tr  
 style="vertical-align:baseline;" id="TBL-14-37-"><td  style="white-space:normal; text-align:left;" id="TBL-14-37-1"  
class="td11">
 <!--l. 2141--><p class="noindent" ><span 
class="aeti-10">DeviceAuxNotificationData</span>
  <br 
class="newline" />0xd4 <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-14-37-2"  
class="td11">
 <!--l. 2141--><p class="noindent" ><span 
class="aeb10-">Device Auxiliary Notification Data </span><br 
class="newline" />  Writing  to  this  register  notifies  the  device  that  a
  device auxiliary notification has occured corresponding
  to the index indicated by <span 
class="aeti-10">DeviceAuxNotificationIndex</span>.
  The value written to this register has a device-specific
  meaning.                                                              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-38-"><td  style="white-space:normal; text-align:left;" id="TBL-14-38-1"  
class="td11">
 <!--l. 2149--><p class="noindent" ><span 
class="aeti-10">ConfigGeneration</span>
  <br 
class="newline" />0x0fc <br 
class="newline" />R                    </td><td  style="white-space:normal; text-align:left;" id="TBL-14-38-2"  
class="td11">
 <!--l. 2149--><p class="noindent" ><span 
class="aeb10-">Configuration atomicity value </span><br 
class="newline" /> Reading from this register returns a value describing
  a version of the device-specific configuration space (see
  <span 
class="aeti-10">Config</span>). The driver can then access the configuration
  space and, when finished, read <span 
class="aeti-10">ConfigGeneration </span>again.
  If  no  part  of  the  configuration  space  has  changed
  between these two <span 
class="aeti-10">ConfigGeneration </span>reads, the returned
  values  are  identical.  If  the  values  are  different,  the
  configuration space accesses were not atomic and the
  driver has to perform the operations again. See also <a 
href="#x1-220005">2.5<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Configuration Space --></a>.  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-39-"><td  style="white-space:normal; text-align:left;" id="TBL-14-39-1"  
class="td11">
 <!--l. 2155--><p class="noindent" ><span 
class="aeti-10">Config </span><br 
class="newline" />0x100+ <br 
class="newline" />RW                  </td><td  style="white-space:normal; text-align:left;" id="TBL-14-39-2"  
class="td11">
 <!--l. 2155--><p class="noindent" ><span 
class="aeb10-">Configuration space </span><br 
class="newline" /> Device-specific configuration space starts at the offset
  0x100 and is accessed with byte alignment. Its meaning
  and size depend on the device and the driver.              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-14-40-"><td  style="white-space:normal; text-align:left;" id="TBL-14-40-1"  
class="td11">             </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-14-41-"><td  style="white-space:normal; text-align:left;" id="TBL-14-41-1"  
class="td11">             </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-14-42-"><td  style="white-space:normal; text-align:left;" id="TBL-14-42-1"  
class="td11">
 <!--l. 2157--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-14-43-"><td  style="white-space:normal; text-align:left;" id="TBL-14-43-1"  
class="td11">
 <!--l. 2157--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-14-44-"><td  style="white-space:normal; text-align:left;" id="TBL-14-44-1"  
class="td11">
 <!--l. 2157--><p class="noindent" >            </td>
</tr>
<tr  
 style="vertical-align:baseline;" id="TBL-14-10-"><td  style="white-space:normal; text-align:left;" id="TBL-14-10-1"  
class="td11">
 <!--l. 1949--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-14-11-"><td  style="white-space:normal; text-align:left;" id="TBL-14-11-1"  
class="td11">
 <!--l. 1949--><p class="noindent" >            </td>
</tr>
</table></div>
<a 
 id="x1-171009r169"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.2.2.1   </span> <a 
 id="x1-1720001"></a>Device Requirements: MMIO Device Register Layout</h5>
<!--l. 2161--><p class="nopar" >The device MUST return 0x74726976 in <span 
class="aeti-10">MagicValue</span>.
<!--l. 2163--><p class="noindent" >The device MUST return value 0x2 in <span 
class="aeti-10">Version</span>.
<!--l. 2165--><p class="noindent" >The device MUST present each event by setting the corresponding bit in
<span 
class="aeti-10">InterruptStatus </span>from the moment it takes place, until the driver acknowledges
                                                                  

                                                                  
the interrupt by writing a corresponding bit mask to the <span 
class="aeti-10">InterruptACK</span>
register. Bits which do not represent events which took place MUST be
zero.
<!--l. 2170--><p class="noindent" >Upon reset, the device MUST clear all bits in <span 
class="aeti-10">InterruptStatus </span>and ready bits in the
<span 
class="aeti-10">QueueReady </span>register for all queues in the device.
<!--l. 2173--><p class="noindent" >The device MUST change value returned in <span 
class="aeti-10">ConfigGeneration </span>if there is any risk of a
driver seeing an inconsistent configuration state.
<!--l. 2176--><p class="noindent" >The device MUST NOT access virtual queue contents when <span 
class="aeti-10">QueueReady </span>is zero
(0x0).
<!--l. 2178--><p class="noindent" >The device MUST ignore device auxiliary notifications for invalid device auxiliary
notification indices.
<!--l. 2181--><p class="noindent" >If VIRTIO_F_RING_RESET has been negotiated, the device MUST present a 0 in
<span 
class="aeti-10">QueueReady </span>after the driver has reset the virtqueue via <span 
class="aeti-10">QueueReset</span>.
<!--l. 2185--><p class="noindent" >If VIRTIO_F_RING_RESET has been negotiated, the device MUST present a 0 in
<span 
class="aeti-10">QueueReset </span>on reset.
<!--l. 2188--><p class="noindent" >If VIRTIO_F_RING_RESET has been negotiated, The device MUST present a 0 in
<span 
class="aeti-10">QueueReset </span>after the virtqueue is enabled with <span 
class="aeti-10">QueueReady</span>.
<!--l. 2191--><p class="noindent" >The device MUST reset the queue when 1 is written to <span 
class="aeti-10">QueueReset</span>, and present a 1
in <span 
class="aeti-10">QueueReset </span>after the queue has been reset, until the driver re-enables the queue
via <span 
class="aeti-10">QueueReady </span>or until the device is reset. The device MUST present consistent
default values after queue reset. (see <a 
href="#x1-280001">2.6.1<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Virtqueue Reset --></a>).
<a 
 id="x1-172001r175"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.2.2.2   </span> <a 
 id="x1-1730002"></a>Driver Requirements: MMIO Device Register Layout</h5>
<!--l. 2198--><p class="nopar" >The driver MUST NOT access memory locations not described in the table <a 
href="#x1-171001r1">4.1<!--tex4ht:ref: tab:Virtio Trasport Options / Virtio Over MMIO / MMIO Device Register Layout --></a> (or, in
case of the configuration space, described in the device specification), MUST NOT
write to the read-only registers (direction R) and MUST NOT read from the
write-only registers (direction W).
<!--l. 2204--><p class="noindent" >The driver MUST only use 32 bit wide and aligned reads and writes to access the
control registers described in table <a 
href="#x1-171001r1">4.1<!--tex4ht:ref: tab:Virtio Trasport Options / Virtio Over MMIO / MMIO Device Register Layout --></a>. For the device-specific configuration space,
the driver MUST use 8 bit wide accesses for 8 bit wide fields, 16 bit wide and aligned
accesses for 16 bit wide fields and 32 bit wide and aligned accesses for 32 and 64 bit
wide fields.
<!--l. 2210--><p class="noindent" >The driver MUST ignore a device with <span 
class="aeti-10">MagicValue </span>which is not 0x74726976,
although it MAY report an error.
<!--l. 2213--><p class="noindent" >The driver MUST ignore a device with <span 
class="aeti-10">Version </span>which is not 0x2, although it MAY
report an error.
<!--l. 2216--><p class="noindent" >The driver MUST ignore a device with <span 
class="aeti-10">DeviceID </span>0x0, but MUST NOT report any
error.
                                                                  

                                                                  
<!--l. 2219--><p class="noindent" >Before reading from <span 
class="aeti-10">DeviceFeatures</span>, the driver MUST write a value to
<span 
class="aeti-10">DeviceFeaturesSel</span>.
<!--l. 2221--><p class="noindent" >Before writing to the <span 
class="aeti-10">DriverFeatures </span>register, the driver MUST write a value to the
<span 
class="aeti-10">DriverFeaturesSel </span>register.
<!--l. 2223--><p class="noindent" >The driver MUST write a value to <span 
class="aeti-10">QueueNum </span>which is less than or equal to the value
presented by the device in <span 
class="aeti-10">QueueNumMax</span>.
<!--l. 2226--><p class="noindent" >When <span 
class="aeti-10">QueueReady </span>is not zero, the driver MUST NOT access <span 
class="aeti-10">QueueNum</span>,
<span 
class="aeti-10">QueueDescLow</span>, <span 
class="aeti-10">QueueDescHigh</span>, <span 
class="aeti-10">QueueDriverLow</span>, <span 
class="aeti-10">QueueDriverHigh</span>, <span 
class="aeti-10">QueueDeviceLow</span>,
<span 
class="aeti-10">QueueDeviceHigh</span>.
<!--l. 2230--><p class="noindent" >To stop using the queue the driver MUST write zero (0x0) to this <span 
class="aeti-10">QueueReady </span>and
MUST read the value back to ensure synchronization.
<!--l. 2234--><p class="noindent" >The driver MUST ignore undefined bits in <span 
class="aeti-10">InterruptStatus</span>.
<!--l. 2236--><p class="noindent" >The driver MUST write a value with a bit mask describing events it handled into
<span 
class="aeti-10">InterruptACK </span>when it finishes handling an interrupt and MUST NOT set any of the
undefined bits in the value.
<!--l. 2239--><p class="noindent" >If VIRTIO_F_RING_RESET has been negotiated, after the driver writes 1 to
<span 
class="aeti-10">QueueReset </span>to reset the queue, it MUST verify that the queue has been reset by
reading back <span 
class="aeti-10">QueueReset </span>and ensuring that it is 1. The driver MAY re-enable the
queue by writing a 1 to <span 
class="aeti-10">QueueReady </span>after ensuring that the other virtqueue fields
have been set up correctly. The driver MAY set driver-writeable queue configuration
values to different values than those that were used before the queue reset. (see
<a 
href="#x1-280001">2.6.1<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Virtqueue Reset --></a>).
<a 
 id="x1-173001r172"></a>
<h4 class="subsectionHead"><span class="titlemark">4.2.3   </span> <a 
 id="x1-1740003"></a>MMIO-specific Initialization And Device Operation</h4>
<a 
 id="x1-174001r176"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.2.3.1   </span> <a 
 id="x1-1750001"></a>Device Initialization</h5>
<a 
 id="x1-175001r168"></a>
<h5 class="paragraphHead"><span class="titlemark">4.2.3.1.1</span> <a 
 id="x1-1760001"></a>Driver Requirements: Device Initialization</h5>
The driver MUST start the device initialization by reading and checking values from
<span 
class="aeti-10">MagicValue </span>and <span 
class="aeti-10">Version</span>. If both values are valid, it MUST read <span 
class="aeti-10">DeviceID </span>and if its
value is zero (0x0) MUST abort initialization and MUST NOT access any other
register.
<!--l. 2260--><p class="noindent" >Drivers not expecting shared memory MUST NOT use the shared memory
registers.
<!--l. 2263--><p class="noindent" >Drivers not expecting device auxiliary notifications MUST NOT use the device
auxiliary notification register.
<!--l. 2265--><p class="noindent" >Further initialization MUST follow the procedure described in <a 
href="#x1-1070001">3.1<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a> <a 
href="#x1-1070001">Device
Initialization<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a>.
                                                                  

                                                                  
<a 
 id="x1-176001r178"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.2.3.2   </span> <a 
 id="x1-1770002"></a>Virtqueue Configuration</h5>
<!--l. 2270--><p class="nopar" >The driver will typically initialize the virtual queue in the following way:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-177002x1">Select the queue writing its index (first queue is 0) to <span 
class="aeti-10">QueueSel</span>.
     </li>
     <li 
  class="enumerate" id="x1-177004x2">Check if the queue is not already in use: read <span 
class="aeti-10">QueueReady</span>, and expect a
     returned value of zero (0x0).
     </li>
     <li 
  class="enumerate" id="x1-177006x3">Read maximum queue size (number of elements) from <span 
class="aeti-10">QueueNumMax</span>. If
     the returned value is zero (0x0) the queue is not available.
     </li>
     <li 
  class="enumerate" id="x1-177008x4">Allocate and zero the queue memory, making sure the memory is physically
     contiguous.
     </li>
     <li 
  class="enumerate" id="x1-177010x5">Notify the device about the queue size by writing the size to <span 
class="aeti-10">QueueNum</span>.
     </li>
     <li 
  class="enumerate" id="x1-177012x6">Write physical addresses of the queue’s Descriptor Area, Driver Area and
     Device                    Area                    to                    (respectively)
     the <span 
class="aeti-10">QueueDescLow</span>/<span 
class="aeti-10">QueueDescHigh</span>, <span 
class="aeti-10">QueueDriverLow</span>/<span 
class="aeti-10">QueueDriverHigh</span>
     and <span 
class="aeti-10">QueueDeviceLow</span>/<span 
class="aeti-10">QueueDeviceHigh </span>register pairs.
     </li>
     <li 
  class="enumerate" id="x1-177014x7">Write 0x1 to <span 
class="aeti-10">QueueReady</span>.</li></ol>
<a 
 id="x1-177015r180"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.2.3.3   </span> <a 
 id="x1-1780003"></a>Available Buffer Notifications</h5>
<!--l. 2300--><p class="nopar" >When VIRTIO_F_NOTIFICATION_DATA has not been negotiated, the driver sends
an available buffer notification to the device by writing the 16-bit virtqueue index of
the queue to be notified to <span 
class="aeti-10">QueueNotify</span>.
<!--l. 2305--><p class="noindent" >When VIRTIO_F_NOTIFICATION_DATA has been negotiated, the driver sends an
available buffer notification to the device by writing the following 32-bit value to
<span 
class="aeti-10">QueueNotify</span>: <!--l. 2308--><div class="lstinputlisting">
<a 
 id="x1-178001"></a>
<span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-178002r1"></a></span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-178003r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vqn</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-178004r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next_off</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">15;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-178005r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next_wrap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-178006r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 2310--><p class="noindent" >See <a 
href="#x1-1010009">2.9<!--tex4ht:ref: sec:Virtqueues / Driver notifications --></a> <a 
href="#x1-1010009">Driver Notifications<!--tex4ht:ref: sec:Virtqueues / Driver notifications --></a> for the definition of the components.
<a 
 id="x1-178007r181"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">4.2.3.4   </span> <a 
 id="x1-1790004"></a>Notifications From The Device</h5>
<!--l. 2315--><p class="nopar" >The memory mapped virtio device is using a single, dedicated interrupt signal,
which is asserted when at least one of the bits described in the description of
<span 
class="aeti-10">InterruptStatus </span>is set. This is how the device sends a used buffer/configuration
change/device-specific notification to the device.
<a 
 id="x1-179001r179"></a>
<h5 class="paragraphHead"><span class="titlemark">4.2.3.4.1</span> <a 
 id="x1-1800001"></a>Driver Requirements: Notifications From The Device</h5>
After receiving an interrupt, the driver MUST read <span 
class="aeti-10">InterruptStatus </span>to check what
caused the interrupt (see the register description). The used buffer notification bit
being set SHOULD be interpreted as a used buffer notification for each active
virtqueue. After the interrupt is handled, the driver MUST acknowledge it by
writing a bit mask corresponding to the handled events to the InterruptACK
register.
<a 
 id="x1-180001r177"></a>
<h4 class="subsectionHead"><span class="titlemark">4.2.4   </span> <a 
 id="x1-1810004"></a>Legacy interface</h4>
<!--l. 2333--><p class="nopar" >The legacy MMIO transport used page-based addressing, resulting in a slightly
different control register layout, the device initialization and the virtual queue
configuration procedure.
<!--l. 2337--><p class="noindent" >Table <a 
href="#x1-181001r2">4.2<!--tex4ht:ref: tab:Virtio Trasport Options / Virtio Over MMIO / MMIO Device Legacy Register Layout --></a> presents control registers layout, omitting descriptions of registers which
did not change their function nor behaviour:
<a 
 id="x1-181001r2"></a>
<!--l. 2343--><div class="longtable"> <table id="TBL-15" class="longtable" 
cellspacing="0" cellpadding="0"  
><colgroup id="TBL-15-1g"><col 
id="TBL-15-1"><col 
id="TBL-15-2"></colgroup>
                                                                  

                                                                  
<tr  
 style="vertical-align:baseline;" id="TBL-15-1-"><td colspan="2" style="white-space:nowrap; text-align:center;" id="TBL-15-1-1"  
class="td11">    <div class="multicolumn"  style="white-space:nowrap; text-align:center;"> <div class="caption" 
><span class="id">Table 4.2</span><span  
class="content">MMIO Device Legacy Register Layout</span></div><!--tex4ht:label?: x1-181001r2 -->                       </div>        <a 
 id="x1-181002"></a>
</td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-2-"><td  style="white-space:normal; text-align:left;" id="TBL-15-2-1"  
class="td11">
 <!--l. 2346--><p class="noindent" ><span 
class="aeti-10">Name </span><br 
class="newline" />Offset       from
  base <br 
class="newline" />Direction          </td><td  style="white-space:normal; text-align:left;" id="TBL-15-2-2"  
class="td11">
 <!--l. 2346--><p class="noindent" ><span 
class="aeb10-">Function </span><br 
class="newline" />Description                                                           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-3-"><td  style="white-space:normal; text-align:left;" id="TBL-15-3-1"  
class="td11">
 <!--l. 2349--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-15-4-"><td  style="white-space:normal; text-align:left;" id="TBL-15-4-1"  
class="td11">               </td><td  style="white-space:normal; text-align:left;" id="TBL-15-4-2"  
class="td11">
</td></tr>
<tr  
 style="vertical-align:baseline;" id="TBL-15-12-"><td  style="white-space:normal; text-align:left;" id="TBL-15-12-1"  
class="td11">
 <!--l. 2357--><p class="noindent" ><span 
class="aeti-10">MagicValue </span><br 
class="newline" />0x000 <br 
class="newline" />R                    </td><td  style="white-space:normal; text-align:left;" id="TBL-15-12-2"  
class="td11">
 <!--l. 2357--><p class="noindent" ><span 
class="aeb10-">Magic value </span><br 
class="newline" />                                                                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-13-"><td  style="white-space:normal; text-align:left;" id="TBL-15-13-1"  
class="td11">
 <!--l. 2359--><p class="noindent" ><span 
class="aeti-10">Version </span><br 
class="newline" />0x004 <br 
class="newline" />R                    </td><td  style="white-space:normal; text-align:left;" id="TBL-15-13-2"  
class="td11">
 <!--l. 2359--><p class="noindent" ><span 
class="aeb10-">Device version number </span><br 
class="newline" />Legacy device returns value 0x1.                                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-14-"><td  style="white-space:normal; text-align:left;" id="TBL-15-14-1"  
class="td11">
 <!--l. 2361--><p class="noindent" ><span 
class="aeti-10">DeviceID </span><br 
class="newline" />0x008 <br 
class="newline" />R                    </td><td  style="white-space:normal; text-align:left;" id="TBL-15-14-2"  
class="td11">
 <!--l. 2361--><p class="noindent" ><span 
class="aeb10-">Virtio Subsystem Device ID </span><br 
class="newline" />                                                                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-15-"><td  style="white-space:normal; text-align:left;" id="TBL-15-15-1"  
class="td11">
 <!--l. 2363--><p class="noindent" ><span 
class="aeti-10">VendorID </span><br 
class="newline" />0x00c <br 
class="newline" />R                    </td><td  style="white-space:normal; text-align:left;" id="TBL-15-15-2"  
class="td11">
 <!--l. 2363--><p class="noindent" ><span 
class="aeb10-">Virtio Subsystem Vendor ID </span><br 
class="newline" />                                                                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-16-"><td  style="white-space:normal; text-align:left;" id="TBL-15-16-1"  
class="td11">
 <!--l. 2365--><p class="noindent" ><span 
class="aeti-10">HostFeatures </span><br 
class="newline" />0x010 <br 
class="newline" />R                    </td><td  style="white-space:normal; text-align:left;" id="TBL-15-16-2"  
class="td11">
 <!--l. 2365--><p class="noindent" ><span 
class="aeb10-">Flags representing features the device supports </span><br 
class="newline" />                                                                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-17-"><td  style="white-space:normal; text-align:left;" id="TBL-15-17-1"  
class="td11">
 <!--l. 2367--><p class="noindent" ><span 
class="aeti-10">HostFeaturesSel</span>
  <br 
class="newline" />0x014 <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-15-17-2"  
class="td11">
 <!--l. 2367--><p class="noindent" ><span 
class="aeb10-">Device (host) features word selection. </span><br 
class="newline" />                                                                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-18-"><td  style="white-space:normal; text-align:left;" id="TBL-15-18-1"  
class="td11">
 <!--l. 2369--><p class="noindent" ><span 
class="aeti-10">GuestFeatures </span><br 
class="newline" />0x020 <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-15-18-2"  
class="td11">
 <!--l. 2369--><p class="noindent" ><span 
class="aeb10-">Flags  representing  device  features  understood  and</span>
  <span 
class="aeb10-">activated by the driver </span><br 
class="newline" />                                                                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-19-"><td  style="white-space:normal; text-align:left;" id="TBL-15-19-1"  
class="td11">
 <!--l. 2371--><p class="noindent" ><span 
class="aeti-10">GuestFeaturesSel</span>
  <br 
class="newline" />0x024 <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-15-19-2"  
class="td11">
 <!--l. 2371--><p class="noindent" ><span 
class="aeb10-">Activated (guest) features word selection </span><br 
class="newline" />                                                                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-20-"><td  style="white-space:normal; text-align:left;" id="TBL-15-20-1"  
class="td11">
 <!--l. 2379--><p class="noindent" ><span 
class="aeti-10">GuestPageSize </span><br 
class="newline" />0x028 <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-15-20-2"  
class="td11">
 <!--l. 2379--><p class="noindent" ><span 
class="aeb10-">Guest page size </span><br 
class="newline" />The driver writes the guest page size in bytes to the
  register during initialization, before any queues are used.
  This value should be a power of 2 and is used by the
  device to calculate the Guest address of the first queue
  page (see QueuePFN).                                             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-21-"><td  style="white-space:normal; text-align:left;" id="TBL-15-21-1"  
class="td11">
 <!--l. 2387--><p class="noindent" ><span 
class="aeti-10">QueueSel </span><br 
class="newline" />0x030 <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-15-21-2"  
class="td11">
 <!--l. 2387--><p class="noindent" ><span 
class="aeb10-">Virtual queue index </span><br 
class="newline" />Writing to this register selects the virtual queue that the
  following operations on the <span 
class="aeti-10">QueueNumMax</span>, <span 
class="aeti-10">QueueNum</span>,
  <span 
class="aeti-10">QueueAlign  </span>and  <span 
class="aeti-10">QueuePFN  </span>registers  apply  to.  The
  index number of the first queue is zero (0x0). .             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-22-"><td  style="white-space:normal; text-align:left;" id="TBL-15-22-1"  
class="td11">
 <!--l. 2395--><p class="noindent" ><span 
class="aeti-10">QueueNumMax</span>
  <br 
class="newline" />0x034 <br 
class="newline" />R                    </td><td  style="white-space:normal; text-align:left;" id="TBL-15-22-2"  
class="td11">
 <!--l. 2395--><p class="noindent" ><span 
class="aeb10-">Maximum virtual queue size </span><br 
class="newline" />Reading from the register returns the maximum size of
  the queue the device is ready to process or zero (0x0)
  if the queue is not available. This applies to the queue
  selected  by  writing  to  <span 
class="aeti-10">QueueSel  </span>and  is  allowed  only
  when <span 
class="aeti-10">QueuePFN </span>is set to zero (0x0), so when the queue
  is not actively used.                                                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-23-"><td  style="white-space:normal; text-align:left;" id="TBL-15-23-1"  
class="td11">
 <!--l. 2402--><p class="noindent" ><span 
class="aeti-10">QueueNum </span><br 
class="newline" />0x038 <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-15-23-2"  
class="td11">
 <!--l. 2402--><p class="noindent" ><span 
class="aeb10-">Virtual queue size </span><br 
class="newline" />Queue  size  is  the  number  of  elements  in  the  queue.
  Writing to this register notifies the device what size of
  the queue the driver will use. This applies to the queue
  selected by writing to <span 
class="aeti-10">QueueSel</span>.                                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-24-"><td  style="white-space:normal; text-align:left;" id="TBL-15-24-1"  
class="td11">
 <!--l. 2408--><p class="noindent" ><span 
class="aeti-10">QueueAlign </span><br 
class="newline" />0x03c <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-15-24-2"  
class="td11">
 <!--l. 2408--><p class="noindent" ><span 
class="aeb10-">Used Ring alignment in the virtual queue </span><br 
class="newline" />Writing  to  this  register  notifies  the  device  about
  alignment boundary of the Used Ring in bytes. This
  value should be a power of 2 and applies to the queue
  selected by writing to <span 
class="aeti-10">QueueSel</span>.                                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-25-"><td  style="white-space:normal; text-align:left;" id="TBL-15-25-1"  
class="td11">
 <!--l. 2422--><p class="noindent" ><span 
class="aeti-10">QueuePFN </span><br 
class="newline" />0x040 <br 
class="newline" />RW                  </td><td  style="white-space:normal; text-align:left;" id="TBL-15-25-2"  
class="td11">
 <!--l. 2422--><p class="noindent" ><span 
class="aeb10-">Guest physical page number of the virtual queue </span><br 
class="newline" />Writing to this register notifies the device about location
  of  the  virtual  queue  in  the  Guest’s  physical  address
  space. This value is the index number of a page starting
  with the queue Descriptor Table. Value zero (0x0) means
  physical address zero (0x00000000) and is illegal. When
  the driver stops using the queue it writes zero (0x0)
  to this register. Reading from this register returns the
  currently used page number of the queue, therefore a
  value other than zero (0x0) means that the queue is in
  use. Both read and write accesses apply to the queue
  selected by writing to <span 
class="aeti-10">QueueSel</span>.                                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-26-"><td  style="white-space:normal; text-align:left;" id="TBL-15-26-1"  
class="td11">
 <!--l. 2424--><p class="noindent" ><span 
class="aeti-10">QueueNotify </span><br 
class="newline" />0x050 <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-15-26-2"  
class="td11">
 <!--l. 2424--><p class="noindent" ><span 
class="aeb10-">Queue notifier </span><br 
class="newline" />                                                                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-27-"><td  style="white-space:normal; text-align:left;" id="TBL-15-27-1"  
class="td11">
 <!--l. 2426--><p class="noindent" ><span 
class="aeti-10">InterruptStatus</span>
  <br 
class="newline" />0x60 <br 
class="newline" />R                    </td><td  style="white-space:normal; text-align:left;" id="TBL-15-27-2"  
class="td11">
 <!--l. 2426--><p class="noindent" ><span 
class="aeb10-">Interrupt status </span><br 
class="newline" />                                                                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-28-"><td  style="white-space:normal; text-align:left;" id="TBL-15-28-1"  
class="td11">
 <!--l. 2428--><p class="noindent" ><span 
class="aeti-10">InterruptACK </span><br 
class="newline" />0x064 <br 
class="newline" />W                   </td><td  style="white-space:normal; text-align:left;" id="TBL-15-28-2"  
class="td11">
 <!--l. 2428--><p class="noindent" ><span 
class="aeb10-">Interrupt acknowledge </span><br 
class="newline" />                                                                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-29-"><td  style="white-space:normal; text-align:left;" id="TBL-15-29-1"  
class="td11">
 <!--l. 2438--><p class="noindent" ><span 
class="aeti-10">Status </span><br 
class="newline" />0x070 <br 
class="newline" />RW                  </td><td  style="white-space:normal; text-align:left;" id="TBL-15-29-2"  
class="td11">
 <!--l. 2438--><p class="noindent" ><span 
class="aeb10-">Device status </span><br 
class="newline" />Reading from this register returns the current device
  status  flags.  Writing  non-zero  values  to  this  register
  sets the status flags, indicating the OS/driver progress.
  Writing zero (0x0) to this register triggers a device reset.
  The device sets <span 
class="aeti-10">QueuePFN </span>to zero (0x0) for all queues
  in the device. Also see <a 
href="#x1-1070001">3.1<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a> <a 
href="#x1-1070001">Device Initialization<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization --></a>.           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-30-"><td  style="white-space:normal; text-align:left;" id="TBL-15-30-1"  
class="td11">
 <!--l. 2440--><p class="noindent" ><span 
class="aeti-10">Config </span><br 
class="newline" />0x100+ <br 
class="newline" />RW                  </td><td  style="white-space:normal; text-align:left;" id="TBL-15-30-2"  
class="td11">
 <!--l. 2440--><p class="noindent" ><span 
class="aeb10-">Configuration space </span><br 
class="newline" />                                                                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-15-31-"><td  style="white-space:normal; text-align:left;" id="TBL-15-31-1"  
class="td11">             </td>                                                

                                                                  
</tr><tr  
 style="vertical-align:baseline;" id="TBL-15-32-"><td  style="white-space:normal; text-align:left;" id="TBL-15-32-1"  
class="td11">             </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-15-33-"><td  style="white-space:normal; text-align:left;" id="TBL-15-33-1"  
class="td11">
 <!--l. 2442--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-15-34-"><td  style="white-space:normal; text-align:left;" id="TBL-15-34-1"  
class="td11">
 <!--l. 2442--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-15-35-"><td  style="white-space:normal; text-align:left;" id="TBL-15-35-1"  
class="td11">
 <!--l. 2442--><p class="noindent" >            </td>
</tr>
<tr  
 style="vertical-align:baseline;" id="TBL-15-10-"><td  style="white-space:normal; text-align:left;" id="TBL-15-10-1"  
class="td11">
 <!--l. 2356--><p class="noindent" >            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-15-11-"><td  style="white-space:normal; text-align:left;" id="TBL-15-11-1"  
class="td11">
 <!--l. 2356--><p class="noindent" >            </td>
</tr>
</table></div>
<!--l. 2444--><p class="noindent" >The virtual queue page size is defined by writing to <span 
class="aeti-10">GuestPageSize</span>, as written by the
guest. The driver does this before the virtual queues are configured.
<!--l. 2448--><p class="noindent" >The virtual queue layout follows p. <a 
href="#x1-370002">2.7.2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Layout --></a> <a 
href="#x1-370002">Legacy Interfaces: A Note on Virtqueue
Layout<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Layout --></a>, with the alignment defined in <span 
class="aeti-10">QueueAlign</span>.
<!--l. 2452--><p class="noindent" >The virtual queue is configured as follows:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-181004x1">Select the queue writing its index (first queue is 0) to <span 
class="aeti-10">QueueSel</span>.
     </li>
     <li 
  class="enumerate" id="x1-181006x2">Check if the queue is not already in use: read <span 
class="aeti-10">QueuePFN</span>, expecting a
     returned value of zero (0x0).
     </li>
     <li 
  class="enumerate" id="x1-181008x3">Read maximum queue size (number of elements) from <span 
class="aeti-10">QueueNumMax</span>. If
     the returned value is zero (0x0) the queue is not available.
     </li>
     <li 
  class="enumerate" id="x1-181010x4">Allocate and zero the queue pages in contiguous virtual memory, aligning
     the Used Ring to an optimal boundary (usually page size). The driver
     should choose a queue size smaller than or equal to <span 
class="aeti-10">QueueNumMax</span>.
     </li>
     <li 
  class="enumerate" id="x1-181012x5">Notify the device about the queue size by writing the size to <span 
class="aeti-10">QueueNum</span>.
     </li>
     <li 
  class="enumerate" id="x1-181014x6">Notify the device about the used alignment by writing its value in bytes
     to <span 
class="aeti-10">QueueAlign</span>.
     </li>
     <li 
  class="enumerate" id="x1-181016x7">Write the physical number of the first page of the queue to the <span 
class="aeti-10">QueuePFN</span>
     register.</li></ol>
<!--l. 2479--><p class="noindent" >Notification mechanisms did not change.
                                                                  

                                                                  
<a 
 id="x1-181017r170"></a>
<h3 class="sectionHead"><span class="titlemark">4.3   </span> <a 
 id="x1-1820003"></a>Virtio Over Channel I/O</h3>
<!--l. 2483--><p class="nopar" >S/390 based virtual machines support neither PCI nor MMIO, so a different
transport is needed there.
<!--l. 2486--><p class="noindent" >virtio-ccw uses the standard channel I/O based mechanism used for the majority of
devices on S/390. A virtual channel device with a special control unit type acts as
proxy to the virtio device (similar to the way virtio-pci uses a PCI device) and
configuration and operation of the virtio device is accomplished (mostly) via channel
commands. This means virtio devices are discoverable via standard operating system
algorithms, and adding virtio support is mainly a question of supporting a new
control unit type.
<!--l. 2496--><p class="noindent" >As the S/390 is a big endian machine, the data structures transmitted via channel
commands are big-endian: this is made clear by use of the types be16, be32 and
be64.
<a 
 id="x1-182001r185"></a>
<h4 class="subsectionHead"><span class="titlemark">4.3.1   </span> <a 
 id="x1-1830001"></a>Basic Concepts</h4>
<!--l. 2502--><p class="nopar" >As a proxy device, virtio-ccw uses a channel-attached I/O control unit with a special
control unit type (0x3832) and a control unit model corresponding to the attached
virtio device’s subsystem device ID, accessed via a virtual I/O subchannel and a
virtual channel path of type 0x32. This proxy device is discoverable via normal
channel subsystem device discovery (usually a STORE SUBCHANNEL loop) and
answers to the basic channel commands:
     <ul class="itemize1">
     <li class="itemize">NO-OPERATION (0x03)
     </li>
     <li class="itemize">BASIC SENSE (0x04)
     </li>
     <li class="itemize">TRANSFER IN CHANNEL (0x08)
     </li>
     <li class="itemize">SENSE ID (0xe4)</li></ul>
<!--l. 2517--><p class="noindent" >For a virtio-ccw proxy device, SENSE ID will return the following information:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Bytes  </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Description                </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Contents              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0        </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > reserved                     </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0xff                     </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >1-2 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >control unit type </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >0x3832</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 3        </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > control unit model       </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <virtio device id>  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 4-5     </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > device type                </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > zeroes (unset)        </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-6"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 6        </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > device model              </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > zeroes (unset)        </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-7"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 7-255  </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > extended SenseId data  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > zeroes (unset)        </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-8"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 2538--><p class="noindent" >A virtio-ccw proxy device facilitates:
                                                                  

                                                                  
     <ul class="itemize1">
     <li class="itemize">Discovery and attachment of virtio devices (as described above).
     </li>
     <li class="itemize">Initialization   of   virtqueues   and   transport-specific   facilities   (using
     virtio-specific channel commands).
     </li>
     <li class="itemize">Notifications  (via  hypercall  and  a  combination  of  I/O  interrupts  and
     indicator bits).</li></ul>
<a 
 id="x1-183001r183"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.1.1   </span> <a 
 id="x1-1840001"></a>Channel Commands for Virtio</h5>
<!--l. 2550--><p class="nopar" >In addition to the basic channel commands, virtio-ccw defines a set of channel
commands related to configuration and operation of virtio:
<!--l. 2554-->
<div class="lstlisting" id="listing-44"><span class="label"><a 
 id="x1-184001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_SET_VQ</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x13</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_VDEV_RESET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x33</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_SET_IND</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x43</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_SET_CONF_IND</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x53</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184005r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_SET_IND_ADAPTER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x73</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_READ_FEAT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x12</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184007r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_WRITE_FEAT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x11</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_READ_CONF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x22</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_WRITE_CONF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x21</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_WRITE_STATUS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x31</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184011r11"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_READ_VQ_CONF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x32</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184012r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_SET_VIRTIO_REV</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x83</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-184013r13"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCW_CMD_READ_STATUS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x72</span>
</div>
<a 
 id="x1-184014r189"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.1.2   </span> <a 
 id="x1-1850002"></a>Notifications</h5>
<!--l. 2573--><p class="nopar" >Available buffer notifications are realized as a hypercall. No additional setup by the
driver is needed. The operation of available buffer notifications is described in section
<a 
href="#x1-2140002">4.3.3.2<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Operation / Guest->Host Notification --></a>.
<!--l. 2578--><p class="noindent" >Used buffer notifications are realized either as so-called classic or adapter I/O
interrupts depending on a transport level negotiation. The initialization is described
in sections <a 
href="#x1-2020001">4.3.2.6.1<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting Up Indicators / Setting Up Classic Queue Indicators --></a> and <a 
href="#x1-2040003">4.3.2.6.3<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting Up Indicators / Setting Up Two-Stage Queue Indicators --></a> respectively. The operation of each flavor is
described in sections <a 
href="#x1-2090001">4.3.3.1.1<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Operation / Host->Guest Notification / Notification via Classic I/O Interrupts --></a> and <a 
href="#x1-2100002">4.3.3.1.2<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Operation / Host->Guest Notification / Notification via Adapter I/O Interrupts --></a> respectively.
<!--l. 2592--><p class="noindent" >Configuration change notifications are done using so-called classic I/O interrupts.
The initialization is described in section <a 
href="#x1-2030002">4.3.2.6.2<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting Up Indicators / Setting Up Configuration Change Indicators --></a> and the operation in section
<a 
href="#x1-2090001">4.3.3.1.1<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Operation / Host->Guest Notification / Notification via Classic I/O Interrupts --></a>.
<a 
 id="x1-185001r190"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.1.3   </span> <a 
 id="x1-1860003"></a>Device Requirements: Basic Concepts</h5>
<!--l. 2602--><p class="nopar" >The virtio-ccw device acts like a normal channel device, as specified in <a 
href="#x1-3001r1">[S390 PoP]</a>
and <a 
href="#x1-3001r1">[S390 Common I/O]</a>. In particular:
     <ul class="itemize1">
     <li class="itemize">A device MUST post a unit check with command reject for any command
     it does not support.
     </li>
     <li class="itemize">If a driver did not suppress length checks for a channel command, the
     device MUST present a subchannel status as detailed in the architecture
                                                                  

                                                                  
     when the actual length did not match the expected length.
     </li>
     <li class="itemize">If a driver did suppress length checks for a channel command, the device
     MUST present a check condition if the transmitted data does not contain
     enough data to process the command. If the driver submitted a buffer that
     was too long, the device SHOULD accept the command.</li></ul>
<a 
 id="x1-186001r191"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.1.4   </span> <a 
 id="x1-1870004"></a>Driver Requirements: Basic Concepts</h5>
<!--l. 2621--><p class="nopar" >A driver for virtio-ccw devices MUST check for a control unit type of 0x3832 and
MUST ignore the device type and model.
<!--l. 2624--><p class="noindent" >A driver SHOULD attempt to provide the correct length in a channel command even
if it suppresses length checks for that command.
<a 
 id="x1-187001r188"></a>
<h4 class="subsectionHead"><span class="titlemark">4.3.2   </span> <a 
 id="x1-1880002"></a>Device Initialization</h4>
<!--l. 2629--><p class="nopar" >virtio-ccw uses several channel commands to set up a device.
<a 
 id="x1-188001r192"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.2.1   </span> <a 
 id="x1-1890001"></a>Setting the Virtio Revision</h5>
<!--l. 2633--><p class="nopar" >CCW_CMD_SET_VIRTIO_REV is issued by the driver to set the revision of the
virtio-ccw transport it intends to drive the device with. It uses the following
communication structure:
<!--l. 2637-->
<div class="lstlisting" id="listing-45"><span class="label"><a 
 id="x1-189001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_rev_info</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-189002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">revision</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-189003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-189004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-189005r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 2645--><p class="noindent" ><span 
class="aeti-10">revision </span>contains the desired revision id, <span 
class="aeti-10">length </span>the length of the data portion and
<span 
class="aeti-10">data </span>revision-dependent additional desired options.
<!--l. 2648--><p class="noindent" >The following values are supported:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">revision  </span></td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">length  </span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">data        </span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > remarks                                             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0           </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0        </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <empty>  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > legacy interface; transitional devices only  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 1           </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0        </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <empty>  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Virtio 1                                              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 2           </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0        </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <empty>  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > CCW_CMD_READ_STATUS support      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 3-n        </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >       </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > reserved for later revisions                     </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-6"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 2664--><p class="noindent" >Note that a change in the virtio standard does not necessarily correspond to a change
in the virtio-ccw revision.
<a 
 id="x1-189006r184"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.1.1</span> <a 
 id="x1-1900001"></a>Device Requirements: Setting the Virtio Revision</h5>
A device MUST post a unit check with command reject for any <span 
class="aeti-10">revision </span>it does not
                                                                  

                                                                  
support. For any invalid combination of <span 
class="aeti-10">revision</span>, <span 
class="aeti-10">length </span>and <span 
class="aeti-10">data</span>, it MUST post a
unit check with command reject as well. A non-transitional device MUST reject
revision id 0.
<!--l. 2674--><p class="noindent" >A device SHOULD answer with command reject to any virtio-ccw specific channel
command that is not contained in the revision selected by the driver.
<!--l. 2678--><p class="noindent" >A device MUST answer with command reject to any attempt to select a different
revision after a revision has been successfully selected by the driver.
<!--l. 2681--><p class="noindent" >A device MUST treat the revision as unset from the time the associated subchannel
has been enabled until a revision has been successfully set by the driver. This implies
that revisions are not persistent across disabling and enabling of the associated
subchannel.
<a 
 id="x1-190001r195"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.1.2</span> <a 
 id="x1-1910002"></a>Driver Requirements: Setting the Virtio Revision</h5>
A driver SHOULD start with trying to set the highest revision it supports and
continue with lower revisions if it gets a command reject.
<!--l. 2691--><p class="noindent" >A driver MUST NOT issue any other virtio-ccw specific channel commands prior to
setting the revision.
<!--l. 2694--><p class="noindent" >After a revision has been successfully selected by the driver, it MUST NOT attempt
to select a different revision.
<a 
 id="x1-191001r196"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.1.3</span> <a 
 id="x1-1920003"></a>Legacy Interfaces: A Note on Setting the Virtio Revision</h5>
A legacy device will not support the CCW_CMD_SET_VIRTIO_REV and answer
with a command reject. A non-transitional driver MUST stop trying to operate this
device in that case. A transitional driver MUST operate the device as if it had been
able to set revision 0.
<!--l. 2704--><p class="noindent" >A legacy driver will not issue the CCW_CMD_SET_VIRTIO_REV prior
to issuing other virtio-ccw specific channel commands. A non-transitional
device therefore MUST answer any such attempts with a command reject. A
transitional device MUST assume in this case that the driver is a legacy driver and
continue as if the driver selected revision 0. This implies that the device
MUST reject any command not valid for revision 0, including a subsequent
CCW_CMD_SET_VIRTIO_REV.
<a 
 id="x1-192001r194"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.2.2   </span> <a 
 id="x1-1930002"></a>Configuring a Virtqueue</h5>
<!--l. 2714--><p class="nopar" >CCW_CMD_READ_VQ_CONF is issued by the driver to obtain information about a
queue. It uses the following structure for communicating:
<!--l. 2717-->
<div class="lstlisting" id="listing-46"><span class="label"><a 
 id="x1-193001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq_config_block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-193002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-193003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_num</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-193004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
                                                                  

                                                                  
</div>
<!--l. 2724--><p class="noindent" >The requested number of buffers for queue <span 
class="aeti-10">index </span>is returned in <span 
class="aeti-10">max_num</span>.
<!--l. 2727--><p class="noindent" >Afterwards, CCW_CMD_SET_VQ is issued by the driver to inform the device about
the location used for its queue. The transmitted structure is
<!--l. 2731-->
<div class="lstlisting" id="listing-47"><span class="label"><a 
 id="x1-193005r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq_info_block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-193006r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-193007r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">res0</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-193008r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-193009r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-193010r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-193011r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-193012r8"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 2742--><p class="noindent" ><span 
class="aeti-10">desc</span>, <span 
class="aeti-10">driver </span>and <span 
class="aeti-10">device </span>contain the guest addresses for the descriptor area, available
area and used area for queue <span 
class="aeti-10">index</span>, respectively. The actual virtqueue size (number
of allocated buffers) is transmitted in <span 
class="aeti-10">num</span>.
<a 
 id="x1-193013r197"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.2.1</span> <a 
 id="x1-1940001"></a>Device Requirements: Configuring a Virtqueue</h5>
<span 
class="aeti-10">res0 </span>is reserved and MUST be ignored by the device.
<a 
 id="x1-194001r199"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.2.2</span> <a 
 id="x1-1950002"></a>Legacy Interface: A Note on Configuring a Virtqueue</h5>
For a legacy driver or for a driver that selected revision 0, CCW_CMD_SET_VQ uses
the following communication block:
<!--l. 2756-->
<div class="lstlisting" id="listing-48"><span class="label"><a 
 id="x1-195001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vq_info_block_legacy</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-195002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">queue</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-195003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">align</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-195004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-195005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-195006r6"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 2765--><p class="noindent" ><span 
class="aeti-10">queue </span>contains the guest address for queue <span 
class="aeti-10">index</span>, <span 
class="aeti-10">num </span>the number of buffers and
<span 
class="aeti-10">align </span>the alignment. The queue layout follows <a 
href="#x1-370002">2.7.2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Layout --></a> <a 
href="#x1-370002">Legacy Interfaces: A Note on
Virtqueue Layout<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Layout --></a>.
<a 
 id="x1-195007r198"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.2.3   </span> <a 
 id="x1-1960003"></a>Communicating Status Information</h5>
<!--l. 2770--><p class="nopar" >The driver changes the status of a device via the CCW_CMD_WRITE_STATUS
command, which transmits an 8 bit status value.
<!--l. 2774--><p class="noindent" >As described in <a 
href="#x1-160002">2.2.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Feature Bits --></a>, a device sometimes fails to set the <span 
class="aeti-10">device status </span>field: For
example, it might fail to accept the FEATURES_OK status bit during device
initialization.
<!--l. 2779--><p class="noindent" >With revision 2, CCW_CMD_READ_STATUS is defined: It reads an 8 bit status value
from the device and acts as a reverse operation to CCW_CMD_WRITE_STATUS.
                                                                  

                                                                  
<a 
 id="x1-196001r200"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.3.1</span> <a 
 id="x1-1970001"></a>Driver Requirements: Communicating Status Information</h5>
If the device posts a unit check with command reject in response to the
CCW_CMD_WRITE_STATUS command, the driver MUST assume that the
device failed to set the status and the <span 
class="aeti-10">device status </span>field retained its previous
value.
<!--l. 2789--><p class="noindent" >If at least revision 2 has been negotiated, the driver SHOULD use the
CCW_CMD_READ_STATUS command to retrieve the <span 
class="aeti-10">device status </span>field after a
configuration change has been detected.
<!--l. 2793--><p class="noindent" >If not at least revision 2 has been negotiated, the driver MUST NOT attempt to issue
the CCW_CMD_READ_STATUS command.
<a 
 id="x1-197001r202"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.3.2</span> <a 
 id="x1-1980002"></a>Device Requirements: Communicating Status Information</h5>
If the device fails to set the <span 
class="aeti-10">device status </span>field to the value written by the driver, the
device MUST assure that the <span 
class="aeti-10">device status </span>field is left unchanged and MUST post a
unit check with command reject.
<!--l. 2803--><p class="noindent" >If at least revision 2 has been negotiated, the device MUST return the current <span 
class="aeti-10">device</span>
<span 
class="aeti-10">status </span>field if the CCW_CMD_READ_STATUS command is issued.
<a 
 id="x1-198001r201"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.2.4   </span> <a 
 id="x1-1990004"></a>Handling Device Features</h5>
<!--l. 2809--><p class="nopar" >Feature bits are arranged in an array of 32 bit values, making for a total of 8192
feature bits. Feature bits are in little-endian byte order.
<!--l. 2813--><p class="noindent" >The CCW commands dealing with features use the following communication
block:
<!--l. 2816-->
<div class="lstlisting" id="listing-49"><span class="label"><a 
 id="x1-199001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_feature_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-199002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">features</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-199003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-199004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 2823--><p class="noindent" ><span 
class="aeti-10">features </span>are the 32 bits of features currently accessed, while <span 
class="aeti-10">index </span>describes which of
the feature bit values is to be accessed. No padding is added at the end of the
structure, it is exactly 5 bytes in length.
<!--l. 2828--><p class="noindent" >The guest obtains the device’s device feature set via the CCW_CMD_READ_FEAT
command. The device stores the features at <span 
class="aeti-10">index </span>to <span 
class="aeti-10">features</span>.
<!--l. 2832--><p class="noindent" >For communicating its supported features to the device, the driver uses the
CCW_CMD_WRITE_FEAT command, denoting a <span 
class="aeti-10">features</span>/<span 
class="aeti-10">index </span>combination.
<a 
 id="x1-199005r204"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">4.3.2.5   </span> <a 
 id="x1-2000005"></a>Device Configuration</h5>
<!--l. 2838--><p class="nopar" >The device’s configuration space is located in host memory.
<!--l. 2840--><p class="noindent" >To obtain information from the configuration space, the driver uses
CCW_CMD_READ_CONF, specifying the guest memory for the device to write
to.
<!--l. 2844--><p class="noindent" >For changing configuration information, the driver uses CCW_CMD_WRITE_CONF,
specifying the guest memory for the device to read from.
<!--l. 2848--><p class="noindent" >In both cases, the complete configuration space is transmitted. This allows the driver
to compare the new configuration space with the old version, and keep a generation
count internally whenever it changes.
<a 
 id="x1-200001r205"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.2.6   </span> <a 
 id="x1-2010006"></a>Setting Up Indicators</h5>
<!--l. 2854--><p class="nopar" >In order to set up the indicator bits for host->guest notification, the driver
uses different channel commands depending on whether it wishes to use
traditional I/O interrupts tied to a subchannel or adapter I/O interrupts for
virtqueue notifications. For any given device, the two mechanisms are mutually
exclusive.
<!--l. 2860--><p class="noindent" >For the configuration change indicators, only a mechanism using traditional I/O
interrupts is provided, regardless of whether traditional or adapter I/O interrupts are
used for virtqueue notifications.
<a 
 id="x1-201001r203"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.6.1</span> <a 
 id="x1-2020001"></a>Setting Up Classic Queue Indicators</h5>
Indicators for notification via classic I/O interrupts are contained in a 64 bit value
per virtio-ccw proxy device.
<!--l. 2870--><p class="noindent" >To communicate the location of the indicator bits for host->guest notification, the
driver uses the CCW_CMD_SET_IND command, pointing to a location containing
the guest address of the indicators in a 64 bit value.
<!--l. 2875--><p class="noindent" >If the driver has already set up two-staged queue indicators via the
CCW_CMD_SET_IND_ADAPTER command, the device MUST post a unit check
with command reject to any subsequent CCW_CMD_SET_IND command.
<a 
 id="x1-202001r207"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.6.2</span> <a 
 id="x1-2030002"></a>Setting Up Configuration Change Indicators</h5>
Indicators for configuration change host->guest notification are contained in a 64 bit
value per virtio-ccw proxy device.
<!--l. 2884--><p class="noindent" >To communicate the location of the indicator bits used in the configuration change
host->guest notification, the driver issues the CCW_CMD_SET_CONF_IND
command, pointing to a location containing the guest address of the indicators in a
64 bit value.
                                                                  

                                                                  
<a 
 id="x1-203001r208"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.6.3</span> <a 
 id="x1-2040003"></a>Setting Up Two-Stage Queue Indicators</h5>
Indicators for notification via adapter I/O interrupts consist of two stages:
     <ul class="itemize1">
     <li class="itemize">a  summary  indicator  byte  covering  the  virtqueues  for  one  or  more
     virtio-ccw proxy devices
     </li>
     <li class="itemize">a set of contigous indicator bits for the virtqueues for a virtio-ccw proxy
     device</li></ul>
<!--l. 2900--><p class="noindent" >To communicate the location of the summary and queue indicator bits, the driver
uses the CCW_CMD_SET_IND_ADAPTER command with the following
payload:
<!--l. 2904-->
<div class="lstlisting" id="listing-50"><span class="label"><a 
 id="x1-204001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_thinint_area</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-204002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">summary_indicator</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-204003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">indicator</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-204004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bit_nr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-204005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">isc</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-204006r6"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">__attribute__</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">((</span><span 
class="pcrr8t-x-x-80">packed</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span>
</div>
<!--l. 2913--><p class="noindent" ><span 
class="aeti-10">summary_indicator </span>contains the guest address of the 8 bit summary indicator.
<span 
class="aeti-10">indicator </span>contains the guest address of an area wherein the indicators for the devices
are contained, starting at <span 
class="aeti-10">bit_nr</span>, one bit per virtqueue of the device. Bit numbers
start at the left, i.e. the most significant bit in the first byte is assigned the bit
number 0. <span 
class="aeti-10">isc </span>contains the I/O interruption subclass to be used for the adapter I/O
interrupt. It MAY be different from the isc used by the proxy virtio-ccw device’s
subchannel. No padding is added at the end of the structure, it is exactly 25 bytes in
length.
<a 
 id="x1-204007r160"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.3.2.6.3.1</span> <a 
 id="x1-2050001"></a>Device Requirements: Setting Up Two-Stage Queue Indicators</h6>
If the driver has already set up classic queue indicators via the CCW_CMD_SET_IND
command, the device MUST post a unit check with command reject to any
subsequent CCW_CMD_SET_IND_ADAPTER command.
<a 
 id="x1-205001r209"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.2.6.4</span> <a 
 id="x1-2060004"></a>Legacy Interfaces: A Note on Setting Up Indicators</h5>
In some cases, legacy devices will only support classic queue indicators; in that case,
they will reject CCW_CMD_SET_IND_ADAPTER as they don’t know that
command. Some legacy devices will support two-stage queue indicators, though, and
a driver will be able to successfully use CCW_CMD_SET_IND_ADAPTER to set
them up.
<a 
 id="x1-206001r193"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">4.3.3   </span> <a 
 id="x1-2070003"></a>Device Operation</h4>
<a 
 id="x1-207001r206"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.3.1   </span> <a 
 id="x1-2080001"></a>Host->Guest Notification</h5>
<!--l. 2943--><p class="nopar" >There are two modes of operation regarding host->guest notification, classic I/O
interrupts and adapter I/O interrupts. The mode to be used is determined by the driver
by using CCW_CMD_SET_IND respectively CCW_CMD_SET_IND_ADAPTER to
set up queue indicators.
<!--l. 2948--><p class="noindent" >For configuration changes, the driver always uses classic I/O interrupts.
<a 
 id="x1-208001r211"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.3.1.1</span> <a 
 id="x1-2090001"></a>Notification via Classic I/O Interrupts</h5>
If the driver used the CCW_CMD_SET_IND command to set up queue indicators,
the device will use classic I/O interrupts for host->guest notification about virtqueue
activity.
<!--l. 2957--><p class="noindent" >For notifying the driver of virtqueue buffers, the device sets the corresponding bit in
the guest-provided indicators. If an interrupt is not already pending for the
subchannel, the device generates an unsolicited I/O interrupt.
<!--l. 2962--><p class="noindent" >If the device wants to notify the driver about configuration changes, it sets bit 0
in the configuration indicators and generates an unsolicited I/O interrupt,
if needed. This also applies if adapter I/O interrupts are used for queue
notifications.
<a 
 id="x1-209001r214"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.3.1.2</span> <a 
 id="x1-2100002"></a>Notification via Adapter I/O Interrupts</h5>
If the driver used the CCW_CMD_SET_IND_ADAPTER command to set up queue
indicators, the device will use adapter I/O interrupts for host->guest notification
about virtqueue activity.
<!--l. 2973--><p class="noindent" >For notifying the driver of virtqueue buffers, the device sets the bit in the
guest-provided indicator area at the corresponding offset. The guest-provided
summary indicator is set to 0x01. An adapter I/O interrupt for the corresponding
interruption subclass is generated.
<!--l. 2978--><p class="noindent" >The recommended way to process an adapter I/O interrupt by the driver is as
follows:
     <ul class="itemize1">
     <li class="itemize">Process all queue indicator bits associated with the summary indicator.
     </li>
     <li class="itemize">Clear  the  summary  indicator,  performing  a  synchronization  (memory
     barrier) afterwards.
     </li>
     <li class="itemize">Process all queue indicator bits associated with the summary indicator
                                                                  

                                                                  
     again.</li></ul>
<a 
 id="x1-210001r210"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.3.3.1.2.1</span> <a 
 id="x1-2110001"></a>Device Requirements: Notification via Adapter I/O Interrupts</h6>
The device SHOULD only generate an adapter I/O interrupt if the summary
indicator had not been set prior to notification.
<a 
 id="x1-211001r216"></a>
<h6 class="subparagraphHead"><span class="titlemark">4.3.3.1.2.2</span> <a 
 id="x1-2120002"></a>Driver Requirements: Notification via Adapter I/O Interrupts</h6>
The driver MUST clear the summary indicator after receiving an adapter I/O
interrupt before it processes the queue indicators.
<a 
 id="x1-212001r215"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.3.1.3</span> <a 
 id="x1-2130003"></a>Legacy Interfaces: A Note on Host->Guest Notification</h5>
As legacy devices and drivers support only classic queue indicators, host->guest
notification will always be done via classic I/O interrupts.
<a 
 id="x1-213001r213"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.3.2   </span> <a 
 id="x1-2140002"></a>Guest->Host Notification</h5>
<!--l. 3006--><p class="nopar" >For notifying the device of virtqueue buffers, the driver unfortunately can’t use a
channel command (the asynchronous characteristics of channel I/O interact badly
with the host block I/O backend). Instead, it uses a diagnose 0x500 call with subcode
3 specifying the queue, as follows:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > GPR  </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Input Value        </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Output Value  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 1       </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x3                   </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >              </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >2 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >Subchannel ID </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >Host Cookie</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 3       </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Notification data  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 4       </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Host Cookie        </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >              </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-6"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 3026--><p class="noindent" >When VIRTIO_F_NOTIFICATION_DATA has not been negotiated, the <span 
class="aeti-10">Notification</span>
<span 
class="aeti-10">data </span>contains the Virtqueue number.
<!--l. 3029--><p class="noindent" >When VIRTIO_F_NOTIFICATION_DATA has been negotiated, the value has the
following format: <!--l. 3031--><div class="lstinputlisting">
<a 
 id="x1-214001"></a>
<span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-214002r1"></a></span><span 
class="pcrr8t-x-x-80">be32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-214003r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vqn</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-214004r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next_off</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">15;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-214005r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next_wrap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-214006r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 3033--><p class="noindent" >See <a 
href="#x1-1010009">2.9<!--tex4ht:ref: sec:Virtqueues / Driver notifications --></a> <a 
href="#x1-1010009">Driver Notifications<!--tex4ht:ref: sec:Virtqueues / Driver notifications --></a> for the definition of the components.
<a 
 id="x1-214007r218"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.3.2.1</span> <a 
 id="x1-2150001"></a>Device Requirements: Guest->Host Notification</h5>
The device MUST ignore bits 0-31 (counting from the left) of GPR2. This aligns
passing the subchannel ID with the way it is passed for the existing I/O
                                                                  

                                                                  
instructions.
<!--l. 3041--><p class="noindent" >The device MAY return a 64-bit host cookie in GPR2 to speed up the notification
execution.
<a 
 id="x1-215001r221"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.3.2.2</span> <a 
 id="x1-2160002"></a>Driver Requirements: Guest->Host Notification</h5>
For each notification, the driver SHOULD use GPR4 to pass the host cookie received
in GPR2 from the previous notication.
<span 
class="aeb10-">Note:</span> For example: <!--l. 3050-->
      <div class="lstlisting" id="listing-51"><span class="label"><a 
 id="x1-216001r1"></a></span><span 
class="pcrr8t-x-x-80">info</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">cookie</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">do_notify</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">schid</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-216002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtqueue_get_queue_index</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-216003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">info</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">cookie</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span>
      
      </div>
<a 
 id="x1-216004r219"></a>
<h5 class="subsubsectionHead"><span class="titlemark">4.3.3.3   </span> <a 
 id="x1-2170003"></a>Resetting Devices</h5>
<!--l. 3059--><p class="nopar" >In order to reset a device, a driver sends the CCW_CMD_VDEV_RESET command.
This command does not carry any payload.
<!--l. 3062--><p class="noindent" >The device signals completion of the virtio reset operation through successful
conclusion of the CCW_CMD_VDEV_RESET channel command. In particular, the
command not only triggers the reset operation, but the reset operation is already
completed when the operation concludes successfully.
<a 
 id="x1-217001r222"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.3.3.1</span> <a 
 id="x1-2180001"></a>Device Requirements: Resetting Devices</h5>
The device MUST finish the virtio reset operation and reinitialize <span 
class="aeti-10">device</span>
<span 
class="aeti-10">status </span>to zero before it concludes the CCW_CMD_VDEV_RESET command
successfully.
<!--l. 3073--><p class="noindent" >The device MUST NOT send notifications or interact with the queues after it
signaled successful conclusion of the CCW_CMD_VDEV_RESET command.
<a 
 id="x1-218001r224"></a>
<h5 class="paragraphHead"><span class="titlemark">4.3.3.3.2</span> <a 
 id="x1-2190002"></a>Driver Requirements: Resetting Devices</h5>
The driver MAY consider the virtio reset operation to be complete already after
successful conclusion of the CCW_CMD_VDEV_RESET channel command, although
it MAY also choose to verify reset completion by reading <span 
class="aeti-10">device status </span>via
CCW_CMD_READ_STATUS and checking whether it is 0 afterwards.
                                                                  

                                                                  
<!--l. 3083--><p class="nopar" ><h2 class="chapterHead"><hr><span class="titlemark">5</span> <a 
 id="x1-2200005"></a>Device Types</h2>
On top of the queues, config space and feature negotiation facilities built into virtio,
several devices are defined.
<!--l. 3088--><p class="noindent" >The following device IDs are used to identify different types of virtio devices. Some
device IDs are reserved for devices which are not currently defined in this
standard.
<!--l. 3092--><p class="noindent" >Discovering what devices are available and their type is bus-dependent.
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Device ID  </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >              Virtio Device                     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >            reserved (invalid)                   </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 1             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >              network card                      </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >2 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >block device</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 3             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >                console                          </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-6"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >4 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >entropy source</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-7"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 5             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >      memory ballooning (traditional)         </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-8"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 6             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >               ioMemory                        </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-9"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 7             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >                 rpmsg                          </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-10"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 8             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >               SCSI host                        </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-11"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >9 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >9P transport</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-12"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 10            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >             mac80211 wlan                    </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-13"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >11 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >rproc serial</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-14"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 12            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >              virtio CAIF                      </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-15"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >13 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >memory balloon</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-16"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 16            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >              GPU device                      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-17"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 17            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >           Timer/Clock device                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-18"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 18            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >              Input device                      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-19"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 19            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >              Socket device                     </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-20"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >20 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >Crypto device</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-21"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 21            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >        Signal Distribution Module            </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-22"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 22            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >              pstore device                      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-23"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 23            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >             IOMMU device                    </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-24"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 24            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >             Memory device                    </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-25"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 25            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >              Audio device                      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-26"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 26            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >            file system device                   </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-27"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 27            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >             PMEM device                     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-28"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 28            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >             RPMB device                     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-29"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 29            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > mac80211 hwsim wireless simulation device  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-30"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 30            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          Video encoder device                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-31"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 31            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          Video decoder device                </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-32"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 32            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >              SCMI device                      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-33"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 33            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >           NitroSecureModule                  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-34"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 34            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >              I2C adapter                      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-35"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 35            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >               Watchdog                        </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-36"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 36            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >              CAN device                      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-37"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 38            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >            Parameter Server                   </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-38"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 39            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >           Audio policy device                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-39"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 40            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >            Bluetooth device                   </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-40"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 41            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >              GPIO device                      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-41"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 42            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >             RDMA device                     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-42"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 43            </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >        vhost-user device backend              </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-43"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 3182--><p class="noindent" >Some of the devices above are unspecified by this document, because they are seen as
immature or especially niche. Be warned that some are only specified by the sole
existing implementation; they could become part of a future specification, be
abandoned entirely, or live on outside this standard. We shall speak of them no
further.
<a 
 id="x1-220001r187"></a>
                                                                  

                                                                  
<h3 class="sectionHead"><span class="titlemark">5.1   </span> <a 
 id="x1-2210001"></a>Network Device</h3>
<!--l. 3191--><p class="nopar" >The virtio network device is a virtual ethernet card, and is the most complex of the
devices supported so far by virtio. It has enhanced rapidly and demonstrates clearly
how support for new features are added to an existing device. Empty buffers are
placed in one virtqueue for receiving packets, and outgoing packets are enqueued into
another for transmission in that order. A third command queue is used to control
advanced filtering features.
<a 
 id="x1-221001r212"></a>
<h4 class="subsectionHead"><span class="titlemark">5.1.1   </span> <a 
 id="x1-2220001"></a>Device ID</h4>
<!--l. 3202--><p class="nopar" >1
<a 
 id="x1-222001r228"></a>
<h4 class="subsectionHead"><span class="titlemark">5.1.2   </span> <a 
 id="x1-2230002"></a>Virtqueues</h4>
     <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">receiveq1
     </dd><dt class="description">
<span 
class="aeb10-">1</span> </dt><dd 
class="description">transmitq1
     </dd><dt class="description">
<span 
class="aeb10-">…</span> </dt><dd 
class="description">
     </dd><dt class="description">
<span 
class="aeb10-">2(N-1)</span> </dt><dd 
class="description">receiveqN
     </dd><dt class="description">
<span 
class="aeb10-">2(N-1)+1</span> </dt><dd 
class="description">transmitqN
     </dd><dt class="description">
<span 
class="aeb10-">2N</span> </dt><dd 
class="description">controlq</dd></dl>
<!--l. 3215--><p class="nopar" >N=1 if neither VIRTIO_NET_F_MQ nor VIRTIO_NET_F_RSS are negotiated,
otherwise N is set by <span 
class="aeti-10">max_virtqueue_pairs</span>.
<!--l. 3218--><p class="noindent" >controlq only exists if VIRTIO_NET_F_CTRL_VQ set.
<a 
 id="x1-223001r229"></a>
<h4 class="subsectionHead"><span class="titlemark">5.1.3   </span> <a 
 id="x1-2240003"></a>Feature bits</h4>
     <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_CSUM (0)</span> </dt><dd 
class="description">Device  handles  packets  with  partial  checksum.
     This “checksum offload” is a common feature on modern network cards.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_GUEST_CSUM (1)</span> </dt><dd 
class="description">Driver   handles   packets   with   partial
     checksum.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_CTRL_GUEST_OFFLOADS (2)</span> </dt><dd 
class="description">Control    channel    offloads
                                                                  

                                                                  
     reconfiguration support.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_MTU(3)</span> </dt><dd 
class="description">Device  maximum  MTU  reporting  is  supported.  If
     offered by the device, device advises driver about the value of its maximum
     MTU. If negotiated, the driver uses <span 
class="aeti-10">mtu </span>as the maximum MTU value.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_MAC (5)</span> </dt><dd 
class="description">Device has given MAC address.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_GUEST_TSO4 (7)</span> </dt><dd 
class="description">Driver can receive TSOv4.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_GUEST_TSO6 (8)</span> </dt><dd 
class="description">Driver can receive TSOv6.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_GUEST_ECN (9)</span> </dt><dd 
class="description">Driver can receive TSO with ECN.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_GUEST_UFO (10)</span> </dt><dd 
class="description">Driver can receive UFO.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_HOST_TSO4 (11)</span> </dt><dd 
class="description">Device can receive TSOv4.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_HOST_TSO6 (12)</span> </dt><dd 
class="description">Device can receive TSOv6.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_HOST_ECN (13)</span> </dt><dd 
class="description">Device can receive TSO with ECN.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_HOST_UFO (14)</span> </dt><dd 
class="description">Device can receive UFO.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_MRG_RXBUF (15)</span> </dt><dd 
class="description">Driver can merge receive buffers.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_STATUS (16)</span> </dt><dd 
class="description">Configuration status field is available.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_CTRL_VQ (17)</span> </dt><dd 
class="description">Control channel is available.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_CTRL_RX (18)</span> </dt><dd 
class="description">Control channel RX mode support.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_CTRL_VLAN (19)</span> </dt><dd 
class="description">Control channel VLAN filtering.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_GUEST_ANNOUNCE(21)</span> </dt><dd 
class="description">Driver    can    send    gratuitous
     packets.
                                                                  

                                                                  
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_MQ(22)</span> </dt><dd 
class="description">Device supports multiqueue with automatic receive
     steering.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_CTRL_MAC_ADDR(23)</span> </dt><dd 
class="description">Set  MAC  address  through  control
     channel.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_HOST_USO (56)</span> </dt><dd 
class="description">Device  can  receive  USO  packets.  Unlike
     UFO (fragmenting the packet) the USO splits large UDP packet to several
     segments when each of these smaller packets has UDP header.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_HASH_REPORT(57)</span> </dt><dd 
class="description">Device can report per-packet hash value
     and a type of calculated hash.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_GUEST_HDRLEN(59)</span> </dt><dd 
class="description">Driver can provide the exact <span 
class="aeti-10">hdr_len</span>
     value. Device benefits from knowing the exact header length.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_RSS(60)</span> </dt><dd 
class="description">Device  supports  RSS  (receive-side  scaling)  with
     Toeplitz hash calculation and configurable hash parameters for receive
     steering.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_RSC_EXT(61)</span> </dt><dd 
class="description">Device  can  process  duplicated  ACKs  and
     report number of coalesced segments and duplicated ACKs.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_STANDBY(62)</span> </dt><dd 
class="description">Device may act as a standby for a primary
     device with the same MAC address.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_SPEED_DUPLEX(63)</span> </dt><dd 
class="description">Device reports speed and duplex.</dd></dl>
<a 
 id="x1-224001r223"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.3.1   </span> <a 
 id="x1-2250001"></a>Feature bit requirements</h5>
<!--l. 3299--><p class="nopar" >Some networking feature bits require other networking feature bits (see <a 
href="#x1-150001">2.2.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Feature Bits --></a>):
     <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_GUEST_TSO4</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_GUEST_CSUM.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_GUEST_TSO6</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_GUEST_CSUM.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_GUEST_ECN</span> </dt><dd 
class="description">Requires  VIRTIO_NET_F_GUEST_TSO4  or
     VIRTIO_NET_F_GUEST_TSO6.
                                                                  

                                                                  
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_GUEST_UFO</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_GUEST_CSUM.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_HOST_TSO4</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_CSUM.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_HOST_TSO6</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_CSUM.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_HOST_ECN</span> </dt><dd 
class="description">Requires    VIRTIO_NET_F_HOST_TSO4    or
     VIRTIO_NET_F_HOST_TSO6.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_HOST_UFO</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_CSUM.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_HOST_USO</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_CSUM.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_CTRL_RX</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_CTRL_VQ.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_CTRL_VLAN</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_CTRL_VQ.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_GUEST_ANNOUNCE</span> </dt><dd 
class="description">Requires
     VIRTIO_NET_F_CTRL_VQ.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_MQ</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_CTRL_VQ.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_CTRL_MAC_ADDR</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_CTRL_VQ.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_RSC_EXT</span> </dt><dd 
class="description">Requires      VIRTIO_NET_F_HOST_TSO4      or
     VIRTIO_NET_F_HOST_TSO6.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_RSS</span> </dt><dd 
class="description">Requires VIRTIO_NET_F_CTRL_VQ.</dd></dl>
<a 
 id="x1-225001r231"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.3.2   </span> <a 
 id="x1-2260002"></a>Legacy Interface: Feature bits</h5>
     <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_GSO (6)</span> </dt><dd 
class="description">Device  handles  packets  with  any  GSO  type.  This
     was supposed to indicate segmentation offload support, but upon further
     investigation it became clear that multiple bits were needed.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_GUEST_RSC4 (41)</span> </dt><dd 
class="description">Device coalesces TCPIP v4 packets. This
     was  implemented  by  hypervisor  patch  for  certification  purposes  and
                                                                  

                                                                  
     current Windows driver depends on it. It will not function if virtio-net
     device reports this feature.
     </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_NET_F_GUEST_RSC6 (42)</span> </dt><dd 
class="description">Device   coalesces   TCPIP   v6   packets.
     Similar to VIRTIO_NET_F_GUEST_RSC4.</dd></dl>
<a 
 id="x1-226001r230"></a>
<h4 class="subsectionHead"><span class="titlemark">5.1.4   </span> <a 
 id="x1-2270004"></a>Device configuration layout</h4>
<!--l. 3335--><p class="nopar" >Device configuration fields are listed below, they are read-only for a driver. The <span 
class="aeti-10">mac</span>
address field always exists (though is only valid if VIRTIO_NET_F_MAC is set), and
<span 
class="aeti-10">status </span>only exists if VIRTIO_NET_F_STATUS is set. Two read-only bits (for the
driver) are currently defined for the status field: VIRTIO_NET_S_LINK_UP and
VIRTIO_NET_S_ANNOUNCE.
<!--l. 3341-->
<div class="lstlisting" id="listing-52"><span class="label"><a 
 id="x1-227001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_S_LINK_UP</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-227002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_S_ANNOUNCE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span>
</div>
<!--l. 3346--><p class="noindent" >The following driver-read-only field, <span 
class="aeti-10">max_virtqueue_pairs </span>only exists if
VIRTIO_NET_F_MQ or VIRTIO_NET_F_RSS is set. This field specifies the
maximum number of each of transmit and receive virtqueues (receiveq1…receiveqN
and transmitq1…transmitqN respectively) that can be configured once at least one of
these features is negotiated.
<!--l. 3352--><p class="noindent" >The following driver-read-only field, <span 
class="aeti-10">mtu </span>only exists if VIRTIO_NET_F_MTU is set.
This field specifies the maximum MTU for the driver to use.
<!--l. 3356--><p class="noindent" >The following two fields, <span 
class="aeti-10">speed </span>and <span 
class="aeti-10">duplex</span>, only exist if VIRTIO_NET_F_SPEED_DUPLEX
is set.
<!--l. 3359--><p class="noindent" ><span 
class="aeti-10">speed </span>contains the device speed, in units of 1 MBit per second, 0 to 0x7fffffff, or
0xffffffff for unknown speed.
<!--l. 3362--><p class="noindent" ><span 
class="aeti-10">duplex </span>has the values of 0x01 for full duplex, 0x00 for half duplex and 0xff for
unknown duplex state.
<!--l. 3365--><p class="noindent" >Both <span 
class="aeti-10">speed </span>and <span 
class="aeti-10">duplex </span>can change, thus the driver is expected to re-read these values
after receiving a configuration change notification.
<!--l. 3369-->
<div class="lstlisting" id="listing-53"><span class="label"><a 
 id="x1-227003r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_net_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-227004r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mac</span><span 
class="pcrr8t-x-x-80">[6];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-227005r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-227006r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_virtqueue_pairs</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-227007r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mtu</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-227008r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">speed</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-227009r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">duplex</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-227010r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rss_max_key_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-227011r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rss_max_indirection_table_length</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-227012r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">supported_hash_types</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-227013r11"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 3382--><p class="noindent" >The following field, <span 
class="aeti-10">rss_max_key_size </span>only exists if VIRTIO_NET_F_RSS or
VIRTIO_NET_F_HASH_REPORT is set. It specifies the maximum supported length
of RSS key in bytes.
                                                                  

                                                                  
<!--l. 3385--><p class="noindent" >The following field, <span 
class="aeti-10">rss_max_indirection_table_length </span>only exists if VIRTIO_NET_F_RSS
is set. It specifies the maximum number of 16-bit entries in RSS indirection
table.
<!--l. 3388--><p class="noindent" >The next field, <span 
class="aeti-10">supported_hash_types </span>only exists if the device supports hash
calculation, i.e. if VIRTIO_NET_F_RSS or VIRTIO_NET_F_HASH_REPORT is
set.
<!--l. 3391--><p class="noindent" >Field <span 
class="aeti-10">supported_hash_types </span>contains the bitmask of supported hash types. See
<a 
href="#x1-2450001">5.1.6.4.3.1<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Processing of Incoming Packets / Hash calculation for incoming packets / Supported/enabled hash types --></a> for details of supported hash types.
<a 
 id="x1-227014r232"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.4.1   </span> <a 
 id="x1-2280001"></a>Device Requirements: Device configuration layout</h5>
<!--l. 3396--><p class="nopar" >The device MUST set <span 
class="aeti-10">max_virtqueue_pairs </span>to between 1 and 0x8000 inclusive, if it
offers VIRTIO_NET_F_MQ.
<!--l. 3399--><p class="noindent" >The device MUST set <span 
class="aeti-10">mtu </span>to between 68 and 65535 inclusive, if it offers
VIRTIO_NET_F_MTU.
<!--l. 3402--><p class="noindent" >The device SHOULD set <span 
class="aeti-10">mtu </span>to at least 1280, if it offers VIRTIO_NET_F_MTU.
<!--l. 3405--><p class="noindent" >The device MUST NOT modify <span 
class="aeti-10">mtu </span>once it has been set.
<!--l. 3407--><p class="noindent" >The device MUST NOT pass received packets that exceed <span 
class="aeti-10">mtu </span>(plus low level ethernet
header length) size with <span 
class="aeti-10">gso_type </span>NONE or ECN after VIRTIO_NET_F_MTU has
been successfully negotiated.
<!--l. 3411--><p class="noindent" >The device MUST forward transmitted packets of up to <span 
class="aeti-10">mtu </span>(plus low level ethernet
header length) size with <span 
class="aeti-10">gso_type </span>NONE or ECN, and do so without fragmentation,
after VIRTIO_NET_F_MTU has been successfully negotiated.
<!--l. 3416--><p class="noindent" >The device MUST set <span 
class="aeti-10">rss_max_key_size </span>to at least 40, if it offers VIRTIO_NET_F_RSS
or VIRTIO_NET_F_HASH_REPORT.
<!--l. 3419--><p class="noindent" >The device MUST set <span 
class="aeti-10">rss_max_indirection_table_length </span>to at least 128, if it offers
VIRTIO_NET_F_RSS.
<!--l. 3422--><p class="noindent" >If the driver negotiates the VIRTIO_NET_F_STANDBY feature, the device
MAY act as a standby device for a primary device with the same MAC
address.
<!--l. 3425--><p class="noindent" >If VIRTIO_NET_F_SPEED_DUPLEX has been negotiated, <span 
class="aeti-10">speed </span>MUST contain the
device speed, in units of 1 MBit per second, 0 to 0x7ffffffff, or 0xfffffffff for
unknown.
<!--l. 3429--><p class="noindent" >If VIRTIO_NET_F_SPEED_DUPLEX has been negotiated, <span 
class="aeti-10">duplex </span>MUST have the
values of 0x00 for full duplex, 0x01 for half duplex, or 0xff for unknown.
<!--l. 3433--><p class="noindent" >If VIRTIO_NET_F_SPEED_DUPLEX and VIRTIO_NET_F_STATUS have both been
negotiated, the device SHOULD NOT change the <span 
class="aeti-10">speed </span>and <span 
class="aeti-10">duplex </span>fields as long as
VIRTIO_NET_S_LINK_UP is set in the <span 
class="aeti-10">status</span>.
<a 
 id="x1-228001r234"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">5.1.4.2   </span> <a 
 id="x1-2290002"></a>Driver Requirements: Device configuration layout</h5>
<!--l. 3440--><p class="nopar" >A driver SHOULD negotiate VIRTIO_NET_F_MAC if the device offers it. If
the driver negotiates the VIRTIO_NET_F_MAC feature, the driver MUST
set the physical address of the NIC to <span 
class="aeti-10">mac</span>. Otherwise, it SHOULD use a
locally-administered MAC address (see <a 
href="#x1-3001r1">IEEE 802</a>, “9.2 48-bit universal LAN MAC
addresses”).
<!--l. 3446--><p class="noindent" >If the driver does not negotiate the VIRTIO_NET_F_STATUS feature, it SHOULD
assume the link is active, otherwise it SHOULD read the link status from the bottom
bit of <span 
class="aeti-10">status</span>.
<!--l. 3450--><p class="noindent" >A driver SHOULD negotiate VIRTIO_NET_F_MTU if the device offers it.
<!--l. 3452--><p class="noindent" >If the driver negotiates VIRTIO_NET_F_MTU, it MUST supply enough receive
buffers to receive at least one receive packet of size <span 
class="aeti-10">mtu </span>(plus low level ethernet
header length) with <span 
class="aeti-10">gso_type </span>NONE or ECN.
<!--l. 3456--><p class="noindent" >If the driver negotiates VIRTIO_NET_F_MTU, it MUST NOT transmit packets of
size exceeding the value of <span 
class="aeti-10">mtu </span>(plus low level ethernet header length) with <span 
class="aeti-10">gso_type</span>
NONE or ECN.
<!--l. 3460--><p class="noindent" >A driver SHOULD negotiate the VIRTIO_NET_F_STANDBY feature if the device
offers it.
<!--l. 3462--><p class="noindent" >If VIRTIO_NET_F_SPEED_DUPLEX has been negotiated, the driver MUST treat
any value of <span 
class="aeti-10">speed </span>above 0x7fffffff as well as any value of <span 
class="aeti-10">duplex </span>not matching 0x00 or
0x01 as an unknown value.
<!--l. 3467--><p class="noindent" >If VIRTIO_NET_F_SPEED_DUPLEX has been negotiated, the driver SHOULD
re-read <span 
class="aeti-10">speed </span>and <span 
class="aeti-10">duplex </span>after a configuration change notification.
<a 
 id="x1-229001r235"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.4.3   </span> <a 
 id="x1-2300003"></a>Legacy Interface: Device configuration layout</h5>
<!--l. 3473--><p class="nopar" >When using the legacy interface, transitional devices and drivers MUST format <span 
class="aeti-10">status</span>
and <span 
class="aeti-10">max_virtqueue_pairs </span>in struct virtio_net_config according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<!--l. 3479--><p class="noindent" >When using the legacy interface, <span 
class="aeti-10">mac </span>is driver-writable which provided a way for drivers
to update the MAC without negotiating VIRTIO_NET_F_CTRL_MAC_ADDR.
<a 
 id="x1-230001r233"></a>
<h4 class="subsectionHead"><span class="titlemark">5.1.5   </span> <a 
 id="x1-2310005"></a>Device Initialization</h4>
<!--l. 3485--><p class="nopar" >A driver would perform a typical initialization routine like so:
     <ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-231002x1">Identify  and  initialize  the  receive  and  transmission  virtqueues,  up  to
     N  of  each  kind.  If  VIRTIO_NET_F_MQ  feature  bit  is  negotiated,
     N=<span 
class="aeti-10">max_virtqueue_pairs</span>, otherwise identify N=1.
                                                                  

                                                                  
     </li>
     <li 
  class="enumerate" id="x1-231004x2">If the VIRTIO_NET_F_CTRL_VQ feature bit is negotiated, identify the
     control virtqueue.
     </li>
     <li 
  class="enumerate" id="x1-231006x3">Fill the receive queues with buffers: see <a 
href="#x1-2380003">5.1.6.3<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Setting Up Receive Buffers --></a>.
     </li>
     <li 
  class="enumerate" id="x1-231008x4">Even with VIRTIO_NET_F_MQ, only receiveq1, transmitq1 and controlq
     are       used       by       default.       The       driver       would       send
     the VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET command specifying the
     number of the transmit and receive queues to use.
     </li>
     <li 
  class="enumerate" id="x1-231010x5">If the VIRTIO_NET_F_MAC feature bit is set, the configuration space
     <span 
class="aeti-10">mac </span>entry indicates the “physical” address of the network card, otherwise
     the driver would typically generate a random local MAC address.
     </li>
     <li 
  class="enumerate" id="x1-231012x6">If the VIRTIO_NET_F_STATUS feature bit is negotiated, the link status
     comes from the bottom bit of <span 
class="aeti-10">status</span>. Otherwise, the driver assumes it’s
     active.
     </li>
     <li 
  class="enumerate" id="x1-231014x7">A performant driver would indicate that it will generate checksumless
     packets by negotating the VIRTIO_NET_F_CSUM feature.
     </li>
     <li 
  class="enumerate" id="x1-231016x8">If                that                feature                is                negotiated,
     a driver can use TCP segmentation or UDP segmentation/fragmentation
     offload  by  negotiating  the  VIRTIO_NET_F_HOST_TSO4  (IPv4  TCP),
     VIRTIO_NET_F_HOST_TSO6
     (IPv6  TCP),  VIRTIO_NET_F_HOST_UFO  (UDP  fragmentation)  and
     VIRTIO_NET_F_HOST_USO (UDP segmentation) features.
     </li>
     <li 
  class="enumerate" id="x1-231018x9">The converse features are also available: a driver can save the virtual device
     some work by negotiating these features.
     <span 
class="aeb10-">Note:</span> For   example,   a   network   packet   transported   between   two
          guests  on  the  same  system  might  not  need  checksumming
          at  all,  nor  segmentation,  if  both  guests  are  amenable.  The
          VIRTIO_NET_F_GUEST_CSUM  feature  indicates  that  partially
          checksummed packets can be received, and if it can do that then the
          VIRTIO_NET_F_GUEST_TSO4, VIRTIO_NET_F_GUEST_TSO6,
          VIRTIO_NET_F_GUEST_UFO
          and VIRTIO_NET_F_GUEST_ECN are the input equivalents of the
          features described above. See <a 
href="#x1-2380003">5.1.6.3<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Setting Up Receive Buffers --></a> <a 
href="#x1-2380003">Setting Up Receive Buffers<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Setting Up Receive Buffers --></a>
          and <a 
href="#x1-2410004">5.1.6.4<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Processing of Incoming Packets --></a> <a 
href="#x1-2410004">Processing of Incoming Packets<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Processing of Incoming Packets --></a> below.
                                                                  

                                                                  
<!--l. 3537--><p class="noindent" >A truly minimal driver would only accept VIRTIO_NET_F_MAC and ignore
everything else.
<a 
 id="x1-231019r237"></a>
<h4 class="subsectionHead"><span class="titlemark">5.1.6   </span> <a 
 id="x1-2320006"></a>Device Operation</h4>
<!--l. 3542--><p class="nopar" >Packets are transmitted by placing them in the transmitq1…transmitqN, and buffers
for incoming packets are placed in the receiveq1…receiveqN. In each case, the packet
itself is preceded by a header:
<!--l. 3547-->
<div class="lstlisting" id="listing-54"><span class="label"><a 
 id="x1-232001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_net_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-232002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_F_NEEDS_CSUM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-232003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_F_DATA_VALID</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-232004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_F_RSC_INFO</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-232005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-232006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_GSO_NONE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-232007r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_GSO_TCPV4</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-232008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_GSO_UDP</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-232009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_GSO_TCPV6</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-232010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_GSO_UDP_L4</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-232011r11"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HDR_GSO_ECN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x80</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-232012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">gso_type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-232013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-232014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">gso_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-232015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">csum_start</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-232016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">csum_offset</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-232017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_buffers</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-232018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_value</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">Only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_F_HASH_REPORT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">negotiated</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-232019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_report</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">Only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_F_HASH_REPORT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">negotiated</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-232020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding_reserved</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">Only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_F_HASH_REPORT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">negotiated</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-232021r21"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 3571--><p class="noindent" >The controlq is used to control device features such as filtering.
<a 
 id="x1-232022r236"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.6.1   </span> <a 
 id="x1-2330001"></a>Legacy Interface: Device Operation</h5>
<!--l. 3575--><p class="nopar" >When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_net_hdr according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<!--l. 3580--><p class="noindent" >The legacy driver only presented <span 
class="aeti-10">num_buffers </span>in the struct virtio_net_hdr when
VIRTIO_NET_F_MRG_RXBUF was negotiated; without that feature the structure
was 2 bytes shorter.
<!--l. 3584--><p class="noindent" >When using the legacy interface, the driver SHOULD ignore the used length for the
transmit queues and the controlq queue.
<span 
class="aeb10-">Note:</span> Historically,  some  devices  put  the  total  descriptor  length  there,  even
      though no data was actually written.
<a 
 id="x1-233001r239"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.6.2   </span> <a 
 id="x1-2340002"></a>Packet Transmission</h5>
<!--l. 3595--><p class="nopar" >Transmitting a single packet is simple, but varies depending on the different features
the driver negotiated.
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-234002x1">The driver can send a completely checksummed packet. In this case, <span 
class="aeti-10">flags</span>
    will be zero, and <span 
class="aeti-10">gso_type </span>will be VIRTIO_NET_HDR_GSO_NONE.
    </li>
    <li 
  class="enumerate" id="x1-234004x2">If the driver negotiated VIRTIO_NET_F_CSUM, it can skip checksumming the
    packet:
        <ul class="itemize1">
        <li class="itemize"><span 
class="aeti-10">flags </span>has the VIRTIO_NET_HDR_F_NEEDS_CSUM set,
                                                                  

                                                                  
        </li>
        <li class="itemize"><span 
class="aeti-10">csum_start   </span>is   set   to   the   offset   within   the   packet   to   begin
        checksumming, and
        </li>
        <li class="itemize"><span 
class="aeti-10">csum_offset </span>indicates how many bytes after the csum_start the new
        (16 bit ones’ complement) checksum is placed by the device.
        </li>
        <li class="itemize">The TCP checksum field in the packet is set to the sum of the TCP
        pseudo header, so that replacing it by the ones’ complement checksum
        of the TCP header and body will give the correct result.</li></ul>
    <span 
class="aeb10-">Note:</span> For example, consider a partially checksummed TCP (IPv4) packet.
          It will have a 14 byte ethernet header and 20 byte IP header followed
          by the TCP header (with the TCP checksum field 16 bytes into that
          header). <span 
class="aeti-10">csum_start </span>will be 14+20 = 34 (the TCP checksum includes
          the header), and <span 
class="aeti-10">csum_offset </span>will be 16.
    </li>
    <li 
  class="enumerate" id="x1-234006x3">If the driver negotiated VIRTIO_NET_F_HOST_TSO4, TSO6, USO or UFO, and
    the packet requires TCP segmentation, UDP segmentation or fragmentation,
    then <span 
class="aeti-10">gso_type </span>is set to VIRTIO_NET_HDR_GSO_TCPV4, TCPV6, UDP_L4 or
    UDP. (Otherwise, it is set to VIRTIO_NET_HDR_GSO_NONE). In this case,
    packets larger than 1514 bytes can be transmitted: the metadata indicates how
    to replicate the packet header to cut it into smaller packets. The other gso fields
    are set:
        <ul class="itemize1">
        <li class="itemize">If the VIRTIO_NET_F_GUEST_HDRLEN feature has been negotiated,
        <span 
class="aeti-10">hdr_len </span>indicates the header length that needs to be replicated for each
        packet. It’s the number of bytes from the beginning of the packet to the
        beginning of the transport payload. Otherwise, if the VIRTIO_NET_F_GUEST_HDRLEN
        feature has not been negotiated, <span 
class="aeti-10">hdr_len </span>is a hint to the device as to
        how much of the header needs to be kept to copy into each packet,
        usually set to the length of the headers, including the transport header<span class="footnote-mark"><a 
href="#fn8x5" id="fn8x5-bk"><sup class="textsuperscript">8</sup></a></span><a 
 id="x1-234007f8"></a>.
        <span 
class="aeb10-">Note:</span> Some devices benefit from knowledge of the exact header length.
        </li>
        <li class="itemize"><span 
class="aeti-10">gso_size </span>is the maximum size of each packet beyond that header (ie.
        MSS).
        </li>
        <li class="itemize">If the driver negotiated the VIRTIO_NET_F_HOST_ECN
        feature, the VIRTIO_NET_HDR_GSO_ECN bit in
        <span 
class="aeti-10">gso_type </span>indicates that the TCP packet has the ECN bit
        set<span class="footnote-mark"><a 
href="#fn9x5" id="fn9x5-bk"><sup class="textsuperscript">9</sup></a></span><a 
 id="x1-234008f9"></a>.</li></ul>
                                                                  

                                                                  
    </li>
    <li 
  class="enumerate" id="x1-234010x4"><span 
class="aeti-10">num_buffers </span>is set to zero. This field is unused on transmitted packets.
    </li>
    <li 
  class="enumerate" id="x1-234012x5">The header and packet are added as one output descriptor to the transmitq, and
    the device is notified of the new entry (see <a 
href="#x1-2310005">5.1.5<!--tex4ht:ref: sec:Device Types / Network Device / Device Initialization --></a> <a 
href="#x1-2310005">Device Initialization<!--tex4ht:ref: sec:Device Types / Network Device / Device Initialization --></a>).</li></ol>
<a 
 id="x1-234013r225"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.2.1</span> <a 
 id="x1-2350001"></a>Driver Requirements: Packet Transmission</h5>
The driver MUST set <span 
class="aeti-10">num_buffers </span>to zero.
<!--l. 3672--><p class="noindent" >If VIRTIO_NET_F_CSUM is not negotiated, the driver MUST set <span 
class="aeti-10">flags </span>to zero and
SHOULD supply a fully checksummed packet to the device.
<!--l. 3676--><p class="noindent" >If VIRTIO_NET_F_HOST_TSO4 is negotiated, the driver MAY set <span 
class="aeti-10">gso_type </span>to
VIRTIO_NET_HDR_GSO_TCPV4 to request TCPv4 segmentation, otherwise the
driver MUST NOT set <span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_TCPV4.
<!--l. 3681--><p class="noindent" >If VIRTIO_NET_F_HOST_TSO6 is negotiated, the driver MAY set <span 
class="aeti-10">gso_type </span>to
VIRTIO_NET_HDR_GSO_TCPV6 to request TCPv6 segmentation, otherwise the
driver MUST NOT set <span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_TCPV6.
<!--l. 3686--><p class="noindent" >If VIRTIO_NET_F_HOST_UFO is negotiated, the driver MAY set <span 
class="aeti-10">gso_type </span>to
VIRTIO_NET_HDR_GSO_UDP to request UDP fragmentation, otherwise the driver
MUST NOT set <span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_UDP.
<!--l. 3691--><p class="noindent" >If VIRTIO_NET_F_HOST_USO is negotiated, the driver MAY set <span 
class="aeti-10">gso_type </span>to
VIRTIO_NET_HDR_GSO_UDP_L4 to request UDP segmentation, otherwise the
driver MUST NOT set <span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_UDP_L4.
<!--l. 3696--><p class="noindent" >The driver SHOULD NOT send to the device TCP packets requiring segmentation
offload which have the Explicit Congestion Notification bit set, unless the
VIRTIO_NET_F_HOST_ECN feature is negotiated, in which case the driver MUST
set the VIRTIO_NET_HDR_GSO_ECN bit in <span 
class="aeti-10">gso_type</span>.
<!--l. 3702--><p class="noindent" >If the VIRTIO_NET_F_CSUM feature has been negotiated, the driver MAY set the
VIRTIO_NET_HDR_F_NEEDS_CSUM bit in <span 
class="aeti-10">flags</span>, if so:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-235002x1">the driver MUST validate the packet checksum at offset <span 
class="aeti-10">csum_offset </span>from
    <span 
class="aeti-10">csum_start </span>as well as all preceding offsets;
    </li>
    <li 
  class="enumerate" id="x1-235004x2">the  driver  MUST  set  the  packet  checksum  stored  in  the  buffer  to  the
    TCP/UDP pseudo header;
    </li>
    <li 
  class="enumerate" id="x1-235006x3">the driver MUST set <span 
class="aeti-10">csum_start </span>and <span 
class="aeti-10">csum_offset </span>such that calculating a
    ones’ complement checksum from <span 
class="aeti-10">csum_start </span>up until the end of the packet
    and storing the result at offset <span 
class="aeti-10">csum_offset </span>from <span 
class="aeti-10">csum_start </span>will result in
    a fully checksummed packet;</li></ol>
                                                                  

                                                                  
<!--l. 3719--><p class="noindent" >If none of the VIRTIO_NET_F_HOST_TSO4, TSO6, USO or UFO options have been
negotiated, the driver MUST set <span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_NONE.
<!--l. 3723--><p class="noindent" >If <span 
class="aeti-10">gso_type </span>differs from VIRTIO_NET_HDR_GSO_NONE, then the driver MUST also
set the VIRTIO_NET_HDR_F_NEEDS_CSUM bit in <span 
class="aeti-10">flags </span>and MUST set <span 
class="aeti-10">gso_size </span>to
indicate the desired MSS.
<!--l. 3728--><p class="noindent" >If one of the VIRTIO_NET_F_HOST_TSO4, TSO6, USO or UFO options have been
negotiated:
    <ul class="itemize1">
    <li class="itemize">If  the  VIRTIO_NET_F_GUEST_HDRLEN  feature  has  been  negotiated,
    and  <span 
class="aeti-10">gso_type  </span>differs  from  VIRTIO_NET_HDR_GSO_NONE,  the  driver
    MUST set <span 
class="aeti-10">hdr_len </span>to a value equal to the length of the headers, including
    the transport header.
    </li>
    <li class="itemize">If the VIRTIO_NET_F_GUEST_HDRLEN feature has not been negotiated,
    or <span 
class="aeti-10">gso_type </span>is VIRTIO_NET_HDR_GSO_NONE, the driver SHOULD set
    <span 
class="aeti-10">hdr_len </span>to a value not less than the length of the headers, including the
    transport header.</li></ul>
<!--l. 3743--><p class="noindent" >The driver SHOULD accept the VIRTIO_NET_F_GUEST_HDRLEN feature if it has
been offered, and if it’s able to provide the exact header length.
<!--l. 3746--><p class="noindent" >The driver MUST NOT set the VIRTIO_NET_HDR_F_DATA_VALID and
VIRTIO_NET_HDR_F_RSC_INFO bits in <span 
class="aeti-10">flags</span>.
<a 
 id="x1-235007r241"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.2.2</span> <a 
 id="x1-2360002"></a>Device Requirements: Packet Transmission</h5>
The device MUST ignore <span 
class="aeti-10">flag </span>bits that it does not recognize.
<!--l. 3752--><p class="noindent" >If VIRTIO_NET_HDR_F_NEEDS_CSUM bit in <span 
class="aeti-10">flags </span>is not set, the device MUST
NOT use the <span 
class="aeti-10">csum_start </span>and <span 
class="aeti-10">csum_offset</span>.
<!--l. 3755--><p class="noindent" >If one of the VIRTIO_NET_F_HOST_TSO4, TSO6, USO or UFO options have been
negotiated:
    <ul class="itemize1">
    <li class="itemize">If  the  VIRTIO_NET_F_GUEST_HDRLEN  feature  has  been  negotiated,
    and  <span 
class="aeti-10">gso_type  </span>differs  from  VIRTIO_NET_HDR_GSO_NONE,  the  device
    MAY use <span 
class="aeti-10">hdr_len </span>as the transport header size.
    <span 
class="aeb10-">Note:</span> Caution should be taken by the implementation so as to prevent a
          malicious driver from attacking the device by setting an incorrect
          hdr_len.
    </li>
    <li class="itemize">If the VIRTIO_NET_F_GUEST_HDRLEN feature has not been negotiated, or
    <span 
class="aeti-10">gso_type </span>is VIRTIO_NET_HDR_GSO_NONE, the device MAY use <span 
class="aeti-10">hdr_len </span>only
                                                                  

                                                                  
    as a hint about the transport header size. The device MUST NOT rely on
    <span 
class="aeti-10">hdr_len </span>to be correct.
    <span 
class="aeb10-">Note:</span> This is due to various bugs in implementations.
    </li></ul>
<!--l. 3778--><p class="noindent" >If VIRTIO_NET_HDR_F_NEEDS_CSUM is not set, the device MUST NOT rely on
the packet checksum being correct.
<a 
 id="x1-236001r242"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.2.3</span> <a 
 id="x1-2370003"></a>Packet Transmission Interrupt</h5>
Often a driver will suppress transmission virtqueue interrupts and check for used
packets in the transmit path of following packets.
<!--l. 3786--><p class="noindent" >The normal behavior in this interrupt handler is to retrieve used buffers from the
virtqueue and free the corresponding headers and packets.
<a 
 id="x1-237001r240"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.6.3   </span> <a 
 id="x1-2380003"></a>Setting Up Receive Buffers</h5>
<!--l. 3792--><p class="nopar" >It is generally a good idea to keep the receive virtqueue as fully populated as
possible: if it runs out, network performance will suffer.
<!--l. 3796--><p class="noindent" >If the VIRTIO_NET_F_GUEST_TSO4, VIRTIO_NET_F_GUEST_TSO6 or
VIRTIO_NET_F_GUEST_UFO features are used, the maximum incoming packet will
be to 65550 bytes long (the maximum size of a TCP or UDP packet, plus the 14 byte
ethernet header), otherwise 1514 bytes. The 12-byte struct virtio_net_hdr is
prepended to this, making for 65562 or 1526 bytes.
<a 
 id="x1-238001r243"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.3.1</span> <a 
 id="x1-2390001"></a>Driver Requirements: Setting Up Receive Buffers</h5>
    <ul class="itemize1">
    <li class="itemize">If VIRTIO_NET_F_MRG_RXBUF is not negotiated:
        <ul class="itemize2">
        <li class="itemize">If  VIRTIO_NET_F_GUEST_TSO4,  VIRTIO_NET_F_GUEST_TSO6
        or VIRTIO_NET_F_GUEST_UFO are negotiated, the driver SHOULD
        populate the receive queue(s) with buffers of at least 65562 bytes.
        </li>
        <li class="itemize">Otherwise, the driver SHOULD populate the receive queue(s) with
        buffers of at least 1526 bytes.</li></ul>
    </li>
    <li class="itemize">If VIRTIO_NET_F_MRG_RXBUF is negotiated, each buffer MUST be at least
    the size of the struct virtio_net_hdr.</li></ul>
                                                                  

                                                                  
<span 
class="aeb10-">Note:</span> Obviously each buffer can be split across multiple descriptor elements.
<!--l. 3822--><p class="nopar" >If VIRTIO_NET_F_MQ is negotiated, each of receiveq1…receiveqN that will be used
SHOULD be populated with receive buffers.
<a 
 id="x1-239001r245"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.3.2</span> <a 
 id="x1-2400002"></a>Device Requirements: Setting Up Receive Buffers</h5>
The device MUST set <span 
class="aeti-10">num_buffers </span>to the number of descriptors used to hold the
incoming packet.
<!--l. 3830--><p class="noindent" >The device MUST use only a single descriptor if VIRTIO_NET_F_MRG_RXBUF was
not negotiated.
<span 
class="aeb10-">Note:</span> This     means     that     <span 
class="aeti-10">num_buffers     </span>will     always     be     1     if
      VIRTIO_NET_F_MRG_RXBUF is not negotiated.
<a 
 id="x1-240001r244"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.6.4   </span> <a 
 id="x1-2410004"></a>Processing of Incoming Packets</h5>
<!--l. 3840--><p class="nopar" >When a packet is copied into a buffer in the receiveq, the optimal path is to disable
further used buffer notifications for the receiveq and process packets until no more
are found, then re-enable them.
<!--l. 3845--><p class="noindent" >Processing incoming packets involves:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-241002x1"><span 
class="aeti-10">num_buffers                              </span>indicates                                how
    many descriptors this packet is spread over (including this one): this will
    always be 1 if VIRTIO_NET_F_MRG_RXBUF was not negotiated. This
    allows receipt of large packets without having to allocate large buffers: a
    packet that does not fit in a single buffer can flow over to the next buffer,
    and so on. In this case, there will be at least <span 
class="aeti-10">num_buffers </span>used buffers in the
    virtqueue, and the device chains them together to form a single packet in a
    way similar to how it would store it in a single buffer spread over multiple
    descriptors. The other buffers will not begin with a struct virtio_net_hdr.
    </li>
    <li 
  class="enumerate" id="x1-241004x2">If <span 
class="aeti-10">num_buffers </span>is one, then the entire packet will be contained within this
    buffer, immediately following the struct virtio_net_hdr.
    </li>
    <li 
  class="enumerate" id="x1-241006x3">If  the  VIRTIO_NET_F_GUEST_CSUM  feature  was  negotiated,  the
    VIRTIO_NET_HDR_F_DATA_VALID bit in <span 
class="aeti-10">flags </span>can be set: if so, device
    has  validated  the  packet  checksum.  In  case  of  multiple  encapsulated
    protocols, one level of checksums has been validated.</li></ol>
<!--l. 3871--><p class="noindent" >Additionally, VIRTIO_NET_F_GUEST_CSUM, TSO4, TSO6, UDP and ECN
features enable receive checksum, large receive offload and ECN support which are
the input equivalents of the transmit checksum, transmit segmentation offloading and
                                                                  

                                                                  
ECN features, as described in <a 
href="#x1-2340002">5.1.6.2<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Packet Transmission --></a>:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-241008x1">If                        the                        VIRTIO_NET_F_GUEST_TSO4,
    TSO6 or UFO options were negotiated, then <span 
class="aeti-10">gso_type </span>MAY be something
    other than VIRTIO_NET_HDR_GSO_NONE, and <span 
class="aeti-10">gso_size </span>field indicates
    the desired MSS (see Packet Transmission point 2).
    </li>
    <li 
  class="enumerate" id="x1-241010x2">If  the  VIRTIO_NET_F_RSC_EXT  option  was  negotiated  (this  implies
    one of VIRTIO_NET_F_GUEST_TSO4, TSO6), the device processes also
    duplicated ACK segments, reports number of coalesced TCP segments in
    <span 
class="aeti-10">csum_start </span>field and number of duplicated ACK segments in <span 
class="aeti-10">csum_offset</span>
    field and sets bit VIRTIO_NET_HDR_F_RSC_INFO in <span 
class="aeti-10">flags</span>.
    </li>
    <li 
  class="enumerate" id="x1-241012x3">If  the  VIRTIO_NET_F_GUEST_CSUM  feature  was  negotiated,  the
    VIRTIO_NET_HDR_F_NEEDS_CSUM bit in <span 
class="aeti-10">flags </span>can be set: if so, the
    packet checksum at offset <span 
class="aeti-10">csum_offset </span>from <span 
class="aeti-10">csum_start </span>and any preceding
    checksums have been validated. The checksum on the packet is incomplete
    and  if  bit  VIRTIO_NET_HDR_F_RSC_INFO  is  not  set  in  <span 
class="aeti-10">flags</span>,  then
    <span 
class="aeti-10">csum_start  </span>and  <span 
class="aeti-10">csum_offset  </span>indicate  how  to  calculate  it  (see  Packet
    Transmission point 1).
    </li></ol>
<!--l. 3899--><p class="noindent" >If applicable, the device calculates per-packet hash for incoming packets as defined in
<a 
href="#x1-2440003">5.1.6.4.3<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Processing of Incoming Packets / Hash calculation for incoming packets --></a>.
<!--l. 3902--><p class="noindent" >If applicable, the device reports hash information for incoming packets as defined in
<a 
href="#x1-2490004">5.1.6.4.4<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Processing of Incoming Packets / Hash reporting for incoming packets --></a>.
<a 
 id="x1-241013r246"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.4.1</span> <a 
 id="x1-2420001"></a>Device Requirements: Processing of Incoming Packets</h5>
If VIRTIO_NET_F_MRG_RXBUF has not been negotiated, the device MUST set
<span 
class="aeti-10">num_buffers </span>to 1.
<!--l. 3911--><p class="noindent" >If VIRTIO_NET_F_MRG_RXBUF has been negotiated, the device MUST set
<span 
class="aeti-10">num_buffers </span>to indicate the number of buffers the packet (including the header) is
spread over.
<!--l. 3915--><p class="noindent" >If a receive packet is spread over multiple buffers, the device MUST use all buffers
but the last (i.e. the first <span 
class="aeti-10">num_buffers </span>- 1 buffers) completely up to the full length of
each buffer supplied by the driver.
<!--l. 3920--><p class="noindent" >The device MUST use all buffers used by a single receive packet together, such that
at least <span 
class="aeti-10">num_buffers </span>are observed by driver as used.
<!--l. 3924--><p class="noindent" >If VIRTIO_NET_F_GUEST_CSUM is not negotiated, the device MUST
set <span 
class="aeti-10">flags </span>to zero and SHOULD supply a fully checksummed packet to the
                                                                  

                                                                  
driver.
<!--l. 3928--><p class="noindent" >If VIRTIO_NET_F_GUEST_TSO4 is not negotiated, the device MUST NOT set
<span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_TCPV4.
<!--l. 3931--><p class="noindent" >If VIRTIO_NET_F_GUEST_UDP is not negotiated, the device MUST NOT set
<span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_UDP.
<!--l. 3934--><p class="noindent" >If VIRTIO_NET_F_GUEST_TSO6 is not negotiated, the device MUST NOT set
<span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_TCPV6.
<!--l. 3937--><p class="noindent" >The device SHOULD NOT send to the driver TCP packets requiring segmentation
offload which have the Explicit Congestion Notification bit set, unless the
VIRTIO_NET_F_GUEST_ECN feature is negotiated, in which case the device MUST
set the VIRTIO_NET_HDR_GSO_ECN bit in <span 
class="aeti-10">gso_type</span>.
<!--l. 3943--><p class="noindent" >If the VIRTIO_NET_F_GUEST_CSUM feature has been negotiated, the
device MAY set the VIRTIO_NET_HDR_F_NEEDS_CSUM bit in <span 
class="aeti-10">flags</span>, if
so:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-242002x1">the device MUST validate the packet checksum at offset <span 
class="aeti-10">csum_offset </span>from
    <span 
class="aeti-10">csum_start </span>as well as all preceding offsets;
    </li>
    <li 
  class="enumerate" id="x1-242004x2">the device MUST set the packet checksum stored in the receive buffer to
    the TCP/UDP pseudo header;
    </li>
    <li 
  class="enumerate" id="x1-242006x3">the device MUST set <span 
class="aeti-10">csum_start </span>and <span 
class="aeti-10">csum_offset </span>such that calculating a
    ones’ complement checksum from <span 
class="aeti-10">csum_start </span>up until the end of the packet
    and storing the result at offset <span 
class="aeti-10">csum_offset </span>from <span 
class="aeti-10">csum_start </span>will result in
    a fully checksummed packet;</li></ol>
<!--l. 3960--><p class="noindent" >If none of the VIRTIO_NET_F_GUEST_TSO4, TSO6 or UFO options have been
negotiated, the device MUST set <span 
class="aeti-10">gso_type </span>to VIRTIO_NET_HDR_GSO_NONE.
<!--l. 3964--><p class="noindent" >If <span 
class="aeti-10">gso_type </span>differs from VIRTIO_NET_HDR_GSO_NONE, then the device MUST also
set the VIRTIO_NET_HDR_F_NEEDS_CSUM bit in <span 
class="aeti-10">flags </span>MUST set <span 
class="aeti-10">gso_size </span>to
indicate the desired MSS. If VIRTIO_NET_F_RSC_EXT was negotiated, the device
MUST also set VIRTIO_NET_HDR_F_RSC_INFO bit in <span 
class="aeti-10">flags</span>, set <span 
class="aeti-10">csum_start </span>to
number of coalesced TCP segments and set <span 
class="aeti-10">csum_offset </span>to number of received
duplicated ACK segments.
<!--l. 3972--><p class="noindent" >If VIRTIO_NET_F_RSC_EXT was not negotiated, the device MUST not set
VIRTIO_NET_HDR_F_RSC_INFO bit in <span 
class="aeti-10">flags</span>.
<!--l. 3975--><p class="noindent" >If one of the VIRTIO_NET_F_GUEST_TSO4, TSO6 or UFO options have been
negotiated, the device SHOULD set <span 
class="aeti-10">hdr_len </span>to a value not less than the length of the
headers, including the transport header.
<!--l. 3980--><p class="noindent" >If the VIRTIO_NET_F_GUEST_CSUM feature has been negotiated, the device MAY
                                                                  

                                                                  
set the VIRTIO_NET_HDR_F_DATA_VALID bit in <span 
class="aeti-10">flags</span>, if so, the device MUST
validate the packet checksum (in case of multiple encapsulated protocols, one level of
checksums is validated).
<a 
 id="x1-242007r248"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.4.2</span> <a 
 id="x1-2430002"></a>Driver Requirements: Processing of Incoming Packets</h5>
The driver MUST ignore <span 
class="aeti-10">flag </span>bits that it does not recognize.
<!--l. 3992--><p class="noindent" >If VIRTIO_NET_HDR_F_NEEDS_CSUM bit in <span 
class="aeti-10">flags </span>is not set or if
VIRTIO_NET_HDR_F_RSC_INFO bit <span 
class="aeti-10">flags </span>is set, the driver MUST NOT use the
<span 
class="aeti-10">csum_start </span>and <span 
class="aeti-10">csum_offset</span>.
<!--l. 3996--><p class="noindent" >If one of the VIRTIO_NET_F_GUEST_TSO4, TSO6 or UFO options have been
negotiated, the driver MAY use <span 
class="aeti-10">hdr_len </span>only as a hint about the transport header
size. The driver MUST NOT rely on <span 
class="aeti-10">hdr_len </span>to be correct.
<span 
class="aeb10-">Note:</span> This is due to various bugs in implementations.
<!--l. 4004--><p class="noindent" >If neither VIRTIO_NET_HDR_F_NEEDS_CSUM nor VIRTIO_NET_HDR_F_DATA_VALID
is set, the driver MUST NOT rely on the packet checksum being correct.
<a 
 id="x1-243001r249"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.4.3</span> <a 
 id="x1-2440003"></a>Hash calculation for incoming packets</h5>
A device attempts to calculate a per-packet hash in the following cases:
    <ul class="itemize1">
    <li class="itemize">The feature VIRTIO_NET_F_RSS was negotiated. The device uses the hash
    to determine the receive virtqueue to place incoming packets.
    </li>
    <li class="itemize">The feature VIRTIO_NET_F_HASH_REPORT was negotiated. The device
    reports the hash value and the hash type with the packet.</li></ul>
<!--l. 4017--><p class="noindent" >If the feature VIRTIO_NET_F_RSS was negotiated:
    <ul class="itemize1">
    <li class="itemize">The  device  uses  <span 
class="aeti-10">hash_types  </span>of  the  virtio_net_rss_config  structure  as
    ’Enabled hash types’ bitmask.
    </li>
    <li class="itemize">The device uses a key as defined in <span 
class="aeti-10">hash_key_data </span>and <span 
class="aeti-10">hash_key_length </span>of
    the virtio_net_rss_config structure (see <a 
href="#x1-2700001">5.1.6.5.7.1<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue / Receive-side scaling (RSS) / Setting RSS parameters --></a>).</li></ul>
<!--l. 4024--><p class="noindent" >If the feature VIRTIO_NET_F_RSS was not negotiated:
    <ul class="itemize1">
    <li class="itemize">The  device  uses  <span 
class="aeti-10">hash_types  </span>of  the  virtio_net_hash_config  structure  as
    ’Enabled hash types’ bitmask.
    </li>
                                                                  

                                                                  
    <li class="itemize">The device uses a key as defined in <span 
class="aeti-10">hash_key_data </span>and <span 
class="aeti-10">hash_key_length </span>of
    the virtio_net_hash_config structure (see <a 
href="#x1-2680004">5.1.6.5.6.4<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue / Automatic receive steering in multiqueue mode / Hash calculation --></a>).</li></ul>
<!--l. 4031--><p class="noindent" >Note that if the device offers VIRTIO_NET_F_HASH_REPORT, even if
it supports only one pair of virtqueues, it MUST support at least one of
commands of VIRTIO_NET_CTRL_MQ class to configure reported hash
parameters:
    <ul class="itemize1">
    <li class="itemize">If    the    device    offers    VIRTIO_NET_F_RSS,    it    MUST    support
    VIRTIO_NET_CTRL_MQ_RSS_CONFIG command per <a 
href="#x1-2700001">5.1.6.5.7.1<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue / Receive-side scaling (RSS) / Setting RSS parameters --></a>.
    </li>
    <li class="itemize">Otherwise             the             device             MUST             support
    VIRTIO_NET_CTRL_MQ_HASH_CONFIG command per <a 
href="#x1-2680004">5.1.6.5.6.4<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue / Automatic receive steering in multiqueue mode / Hash calculation --></a>.</li></ul>
<a 
 id="x1-244001r217"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.4.3.1</span> <a 
 id="x1-2450001"></a>Supported/enabled hash types</h6>
Hash types applicable for IPv4 packets: <!--l. 4043-->
<div class="lstlisting" id="listing-55"><span class="label"><a 
 id="x1-245001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HASH_TYPE_IPv4</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-245002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HASH_TYPE_TCPv4</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-245003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HASH_TYPE_UDPv4</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2)</span>
</div>
<!--l. 4048--><p class="noindent" >Hash types applicable for IPv6 packets without extension headers <!--l. 4049-->
<div class="lstlisting" id="listing-56"><span class="label"><a 
 id="x1-245004r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HASH_TYPE_IPv6</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-245005r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HASH_TYPE_TCPv6</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-245006r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HASH_TYPE_UDPv6</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5)</span>
</div>
<!--l. 4054--><p class="noindent" >Hash types applicable for IPv6 packets with extension headers <!--l. 4055-->
<div class="lstlisting" id="listing-57"><span class="label"><a 
 id="x1-245007r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HASH_TYPE_IP_EX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-245008r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HASH_TYPE_TCP_EX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-245009r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HASH_TYPE_UDP_EX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8)</span>
</div>
<a 
 id="x1-245010r251"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.4.3.2</span> <a 
 id="x1-2460002"></a>IPv4 packets</h6>
The device calculates the hash on IPv4 packets according to ’Enabled hash types’
bitmask as follows:
    <ul class="itemize1">
    <li class="itemize">If VIRTIO_NET_HASH_TYPE_TCPv4 is set and the packet has a TCP header,
    the hash is calculated over the following fields:
        <ul class="itemize2">
        <li class="itemize">Source IP address
                                                                  

                                                                  
        </li>
        <li class="itemize">Destination IP address
        </li>
        <li class="itemize">Source TCP port
        </li>
        <li class="itemize">Destination TCP port</li></ul>
    </li>
    <li class="itemize">Else if VIRTIO_NET_HASH_TYPE_UDPv4 is set and the packet has a UDP
    header, the hash is calculated over the following fields:
        <ul class="itemize2">
        <li class="itemize">Source IP address
        </li>
        <li class="itemize">Destination IP address
        </li>
        <li class="itemize">Source UDP port
        </li>
        <li class="itemize">Destination UDP port</li></ul>
    </li>
    <li class="itemize">Else if VIRTIO_NET_HASH_TYPE_IPv4 is set, the hash is calculated over the
    following fields:
        <ul class="itemize2">
        <li class="itemize">Source IP address
        </li>
        <li class="itemize">Destination IP address</li></ul>
    </li>
    <li class="itemize">Else the device does not calculate the hash</li></ul>
<a 
 id="x1-246001r252"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.4.3.3</span> <a 
 id="x1-2470003"></a>IPv6 packets without extension header</h6>
The device calculates the hash on IPv6 packets without extension headers according
to ’Enabled hash types’ bitmask as follows:
    <ul class="itemize1">
    <li class="itemize">If VIRTIO_NET_HASH_TYPE_TCPv6 is set and the packet has a TCPv6
    header, the hash is calculated over the following fields:
        <ul class="itemize2">
        <li class="itemize">Source IPv6 address
        </li>
        <li class="itemize">Destination IPv6 address
                                                                  

                                                                  
        </li>
        <li class="itemize">Source TCP port
        </li>
        <li class="itemize">Destination TCP port</li></ul>
    </li>
    <li class="itemize">Else if VIRTIO_NET_HASH_TYPE_UDPv6 is set and the packet has a UDPv6
    header, the hash is calculated over the following fields:
        <ul class="itemize2">
        <li class="itemize">Source IPv6 address
        </li>
        <li class="itemize">Destination IPv6 address
        </li>
        <li class="itemize">Source UDP port
        </li>
        <li class="itemize">Destination UDP port</li></ul>
    </li>
    <li class="itemize">Else if VIRTIO_NET_HASH_TYPE_IPv6 is set, the hash is calculated over the
    following fields:
        <ul class="itemize2">
        <li class="itemize">Source IPv6 address
        </li>
        <li class="itemize">Destination IPv6 address</li></ul>
    </li>
    <li class="itemize">Else the device does not calculate the hash</li></ul>
<a 
 id="x1-247001r253"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.4.3.4</span> <a 
 id="x1-2480004"></a>IPv6 packets with extension header</h6>
The device calculates the hash on IPv6 packets with extension headers according to
’Enabled hash types’ bitmask as follows:
    <ul class="itemize1">
    <li class="itemize">If VIRTIO_NET_HASH_TYPE_TCP_EX is set and the packet has a TCPv6
    header, the hash is calculated over the following fields:
        <ul class="itemize2">
        <li class="itemize">Home address from the home address option in the IPv6 destination
        options header. If the extension header is not present, use the Source
        IPv6 address.
        </li>
        <li class="itemize">IPv6 address that is contained in the Routing-Header-Type-2 from the
        associated extension header. If the extension header is not present, use
                                                                  

                                                                  
        the Destination IPv6 address.
        </li>
        <li class="itemize">Source TCP port
        </li>
        <li class="itemize">Destination TCP port</li></ul>
    </li>
    <li class="itemize">Else if VIRTIO_NET_HASH_TYPE_UDP_EX is set and the packet has a
    UDPv6 header, the hash is calculated over the following fields:
        <ul class="itemize2">
        <li class="itemize">Home address from the home address option in the IPv6 destination
        options header. If the extension header is not present, use the Source
        IPv6 address.
        </li>
        <li class="itemize">IPv6 address that is contained in the Routing-Header-Type-2 from the
        associated extension header. If the extension header is not present, use
        the Destination IPv6 address.
        </li>
        <li class="itemize">Source UDP port
        </li>
        <li class="itemize">Destination UDP port</li></ul>
    </li>
    <li class="itemize">Else if VIRTIO_NET_HASH_TYPE_IP_EX is set, the hash is calculated over the
    following fields:
        <ul class="itemize2">
        <li class="itemize">Home address from the home address option in the IPv6 destination
        options header. If the extension header is not present, use the Source
        IPv6 address.
        </li>
        <li class="itemize">IPv6 address that is contained in the Routing-Header-Type-2 from the
        associated extension header. If the extension header is not present, use
        the Destination IPv6 address.</li></ul>
    </li>
    <li class="itemize">Else skip IPv6 extension headers and calculate the hash as defined for an IPv6
    packet without extension headers (see <a 
href="#x1-2470003">5.1.6.4.3.3<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Processing of Incoming Packets / Hash calculation for incoming packets / IPv6 packets without extension header --></a>).</li></ul>
<a 
 id="x1-248001r250"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.4.4</span> <a 
 id="x1-2490004"></a>Hash reporting for incoming packets</h5>
If VIRTIO_NET_F_HASH_REPORT was negotiated and the device has calculated
the hash for the packet, the device fills <span 
class="aeti-10">hash_report </span>with the report type of calculated
hash and <span 
class="aeti-10">hash_value </span>with the value of calculated hash.
                                                                  

                                                                  
<!--l. 4159--><p class="noindent" >If VIRTIO_NET_F_HASH_REPORT was negotiated but due to any reason the hash was
not calculated, the device sets <span 
class="aeti-10">hash_report </span>to VIRTIO_NET_HASH_REPORT_NONE.
<!--l. 4162--><p class="noindent" >Possible values that the device can report in <span 
class="aeti-10">hash_report </span>are defined below. They
correspond to supported hash types defined in <a 
href="#x1-2450001">5.1.6.4.3.1<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Processing of Incoming Packets / Hash calculation for incoming packets / Supported/enabled hash types --></a> as follows:
<!--l. 4167--><p class="noindent" >VIRTIO_NET_HASH_TYPE_XXX = 1 « (VIRTIO_NET_HASH_REPORT_XXX -
1)
<!--l. 4169-->
<div class="lstlisting" id="listing-58"><span class="label"><a 
 id="x1-249001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HASH_REPORT_NONE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HASH_REPORT_IPv4</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HASH_REPORT_TCPv4</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HASH_REPORT_UDPv4</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249005r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HASH_REPORT_IPv6</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HASH_REPORT_TCPv6</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249007r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HASH_REPORT_UDPv6</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HASH_REPORT_IPv6_EX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HASH_REPORT_TCPv6_EX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-249010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_HASH_REPORT_UDPv6_EX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9</span>
</div>
<a 
 id="x1-249011r247"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.6.5   </span> <a 
 id="x1-2500005"></a>Control Virtqueue</h5>
<!--l. 4184--><p class="nopar" >The driver uses the control virtqueue (if VIRTIO_NET_F_CTRL_VQ is negotiated)
to send commands to manipulate various features of the device which would not
easily map into the configuration space.
<!--l. 4189--><p class="noindent" >All commands are of the following form:
<!--l. 4191-->
<div class="lstlisting" id="listing-59"><span class="label"><a 
 id="x1-250001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_net_ctrl</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-250002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">class</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-250003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">command</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-250004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">command</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-250005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ack</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-250006r6"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-250007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-250008r8"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ack</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">values</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-250009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_OK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-250010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_ERR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span>
</div>
<!--l. 4204--><p class="noindent" >The <span 
class="aeti-10">class</span>, <span 
class="aeti-10">command </span>and command-specific-data are set by the driver, and the device
sets the <span 
class="aeti-10">ack </span>byte. There is little it can do except issue a diagnostic if <span 
class="aeti-10">ack </span>is not
VIRTIO_NET_OK.
<a 
 id="x1-250011r255"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.5.1</span> <a 
 id="x1-2510001"></a>Packet Receive Filtering</h5>
If the VIRTIO_NET_F_CTRL_RX and VIRTIO_NET_F_CTRL_RX_EXTRA features
are negotiated, the driver can send control commands for promiscuous mode,
multicast, unicast and broadcast receiving.
<span 
class="aeb10-">Note:</span> In general, these commands are best-effort: unwanted packets could still
      arrive.
<!--l. 4221-->
<div class="lstlisting" id="listing-60"><span class="label"><a 
 id="x1-251001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_RX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-251002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_RX_PROMISC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-251003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_RX_ALLMULTI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-251004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_RX_ALLUNI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-251005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_RX_NOMULTI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-251006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_RX_NOUNI</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-251007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_RX_NOBCAST</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span>
</div>
<a 
 id="x1-251008r254"></a>
                                                                  

                                                                  
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.1.1</span> <a 
 id="x1-2520001"></a>Device Requirements: Packet Receive Filtering</h6>
If the VIRTIO_NET_F_CTRL_RX feature has been negotiated, the device MUST
support the following VIRTIO_NET_CTRL_RX class commands:
    <ul class="itemize1">
    <li class="itemize">VIRTIO_NET_CTRL_RX_PROMISC turns promiscuous mode on and off.
    The command-specific-data is one byte containing 0 (off) or 1 (on). If
    promiscous mode is on, the device SHOULD receive all incoming packets.
    This  SHOULD  take  effect  even  if  one  of  the  other  modes  set  by  a
    VIRTIO_NET_CTRL_RX class command is on.
    </li>
    <li class="itemize">VIRTIO_NET_CTRL_RX_ALLMULTI turns all-multicast receive on and
    off. The command-specific-data is one byte containing 0 (off) or 1 (on).
    When all-multicast receive is on the device SHOULD allow all incoming
    multicast packets.</li></ul>
<!--l. 4250--><p class="noindent" >If the VIRTIO_NET_F_CTRL_RX_EXTRA feature has been negotiated, the device
MUST support the following VIRTIO_NET_CTRL_RX class commands:
    <ul class="itemize1">
    <li class="itemize">VIRTIO_NET_CTRL_RX_ALLUNI  turns  all-unicast  receive  on  and  off.
    The command-specific-data is one byte containing 0 (off) or 1 (on). When
    all-unicast receive is on the device SHOULD allow all incoming unicast
    packets.
    </li>
    <li class="itemize">VIRTIO_NET_CTRL_RX_NOMULTI  suppresses  multicast  receive.  The
    command-specific-data is one byte containing 0 (multicast receive allowed)
    or 1 (multicast receive suppressed). When multicast receive is suppressed,
    the  device  SHOULD  NOT  send  multicast  packets  to  the  driver.  This
    SHOULD take effect even if VIRTIO_NET_CTRL_RX_ALLMULTI is on.
    This filter SHOULD NOT apply to broadcast packets.
    </li>
    <li class="itemize">VIRTIO_NET_CTRL_RX_NOUNI    suppresses    unicast    receive.    The
    command-specific-data is one byte containing 0 (unicast receive allowed)
    or 1 (unicast receive suppressed). When unicast receive is suppressed, the
    device SHOULD NOT send unicast packets to the driver. This SHOULD
    take effect even if VIRTIO_NET_CTRL_RX_ALLUNI is on.
    </li>
    <li class="itemize">VIRTIO_NET_CTRL_RX_NOBCAST suppresses broadcast receive. The
    command-specific-data is one byte containing 0 (broadcast receive allowed)
    or 1 (broadcast receive suppressed). When broadcast receive is suppressed,
    the  device  SHOULD  NOT  send  broadcast  packets  to  the  driver.  This
    SHOULD take effect even if VIRTIO_NET_CTRL_RX_ALLMULTI is on.</li></ul>
<a 
 id="x1-252001r258"></a>
                                                                  

                                                                  
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.1.2</span> <a 
 id="x1-2530002"></a>Driver Requirements: Packet Receive Filtering</h6>
If the VIRTIO_NET_F_CTRL_RX feature has not been negotiated, the driver
MUST NOT issue commands VIRTIO_NET_CTRL_RX_PROMISC or
VIRTIO_NET_CTRL_RX_ALLMULTI.
<!--l. 4285--><p class="noindent" >If the VIRTIO_NET_F_CTRL_RX_EXTRA feature has not been negotiated, the
driver MUST NOT issue commands VIRTIO_NET_CTRL_RX_ALLUNI,
VIRTIO_NET_CTRL_RX_NOMULTI, VIRTIO_NET_CTRL_RX_NOUNI or
VIRTIO_NET_CTRL_RX_NOBCAST.
<a 
 id="x1-253001r257"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.5.2</span> <a 
 id="x1-2540002"></a>Setting MAC Address Filtering</h5>
If the VIRTIO_NET_F_CTRL_RX feature is negotiated, the driver can send control
commands for MAC address filtering.
<!--l. 4297-->
<div class="lstlisting" id="listing-61"><span class="label"><a 
 id="x1-254001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_net_ctrl_mac</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-254002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">entries</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-254003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">macs</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">entries</span><span 
class="pcrr8t-x-x-80">][6];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-254004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-254005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-254006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MAC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-254007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MAC_TABLE_SET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-254008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MAC_ADDR_SET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span>
</div>
<!--l. 4308--><p class="noindent" >The device can filter incoming packets by any number of destination MAC
addresses<span class="footnote-mark"><a 
href="#fn10x5" id="fn10x5-bk"><sup class="textsuperscript">10</sup></a></span><a 
 id="x1-254009f10"></a>.
This table is set using the class VIRTIO_NET_CTRL_MAC and the command
VIRTIO_NET_CTRL_MAC_TABLE_SET. The command-specific-data is
two variable length tables of 6-byte MAC addresses (as described in struct
virtio_net_ctrl_mac). The first table contains unicast addresses, and the second
contains multicast addresses.
<!--l. 4318--><p class="noindent" >The VIRTIO_NET_CTRL_MAC_ADDR_SET command is used to set the default
MAC address which rx filtering accepts (and if VIRTIO_NET_F_MAC has been
negotiated, this will be reflected in <span 
class="aeti-10">mac </span>in config space).
<!--l. 4323--><p class="noindent" >The command-specific-data for VIRTIO_NET_CTRL_MAC_ADDR_SET is the 6-byte
MAC address.
<a 
 id="x1-254010r259"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.2.1</span> <a 
 id="x1-2550001"></a>Device Requirements: Setting MAC Address Filtering</h6>
The device MUST have an empty MAC filtering table on reset.
<!--l. 4330--><p class="noindent" >The device MUST update the MAC filtering table before it consumes the
VIRTIO_NET_CTRL_MAC_TABLE_SET command.
<!--l. 4333--><p class="noindent" >The device MUST update <span 
class="aeti-10">mac </span>in config space before it consumes the
VIRTIO_NET_CTRL_MAC_ADDR_SET command, if VIRTIO_NET_F_MAC has
been negotiated.
<!--l. 4337--><p class="noindent" >The device SHOULD drop incoming packets which have a destination MAC which
                                                                  

                                                                  
matches neither the <span 
class="aeti-10">mac </span>(or that set with VIRTIO_NET_CTRL_MAC_ADDR_SET)
nor the MAC filtering table.
<a 
 id="x1-255001r261"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.2.2</span> <a 
 id="x1-2560002"></a>Driver Requirements: Setting MAC Address Filtering</h6>
If VIRTIO_NET_F_CTRL_RX has not been negotiated, the driver MUST NOT issue
VIRTIO_NET_CTRL_MAC class commands.
<!--l. 4346--><p class="noindent" >If VIRTIO_NET_F_CTRL_RX has been negotiated, the driver SHOULD issue
VIRTIO_NET_CTRL_MAC_ADDR_SET to set the default mac if it is different from
<span 
class="aeti-10">mac</span>.
<!--l. 4350--><p class="noindent" >The driver MUST follow the VIRTIO_NET_CTRL_MAC_TABLE_SET command by
a le32 number, followed by that number of non-multicast MAC addresses, followed by
another le32 number, followed by that number of multicast addresses. Either number
MAY be 0.
<a 
 id="x1-256001r262"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.2.3</span> <a 
 id="x1-2570003"></a>Legacy Interface: Setting MAC Address Filtering</h6>
When using the legacy interface, transitional devices and drivers MUST
format <span 
class="aeti-10">entries </span>in struct virtio_net_ctrl_mac according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<!--l. 4361--><p class="noindent" >Legacy drivers that didn’t negotiate VIRTIO_NET_F_CTRL_MAC_ADDR changed
<span 
class="aeti-10">mac </span>in config space when NIC is accepting incoming packets. These drivers
always wrote the mac value from first to last byte, therefore after detecting
such drivers, a transitional device MAY defer MAC update, or MAY defer
processing incoming packets until driver writes the last byte of <span 
class="aeti-10">mac </span>in the config
space.
<a 
 id="x1-257001r260"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.5.3</span> <a 
 id="x1-2580003"></a>VLAN Filtering</h5>
If the driver negotiates the VIRTIO_NET_F_CTRL_VLAN feature, it can control a
VLAN filter table in the device.
<span 
class="aeb10-">Note:</span> Similar to the MAC address based filtering, the VLAN filtering is also
      best-effort: unwanted packets could still arrive.
<!--l. 4379-->
<div class="lstlisting" id="listing-62"><span class="label"><a 
 id="x1-258001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_VLAN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-258002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_VLAN_ADD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-258003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_VLAN_DEL</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span>
</div>
<!--l. 4385--><p class="noindent" >Both the VIRTIO_NET_CTRL_VLAN_ADD and VIRTIO_NET_CTRL_VLAN_DEL
command take a little-endian 16-bit VLAN id as the command-specific-data.
                                                                  

                                                                  
<a 
 id="x1-258004r263"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.3.1</span> <a 
 id="x1-2590001"></a>Legacy Interface: VLAN Filtering</h6>
When using the legacy interface, transitional devices and drivers MUST format the
VLAN id according to the native endian of the guest rather than (necessarily when
not using the legacy interface) little-endian.
<a 
 id="x1-259001r264"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.5.4</span> <a 
 id="x1-2600004"></a>Gratuitous Packet Sending</h5>
If the driver negotiates the VIRTIO_NET_F_GUEST_ANNOUNCE (depends on
VIRTIO_NET_F_CTRL_VQ), the device can ask the driver to send gratuitous
packets; this is usually done after the guest has been physically migrated, and needs
to announce its presence on the new network links. (As hypervisor does not have the
knowledge of guest network configuration (eg. tagged vlan) it is simplest to prod the
guest in this way).
<!--l. 4404-->
<div class="lstlisting" id="listing-63"><span class="label"><a 
 id="x1-260001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_ANNOUNCE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-260002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_ANNOUNCE_ACK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span>
</div>
<!--l. 4409--><p class="noindent" >The driver checks VIRTIO_NET_S_ANNOUNCE bit in the device configuration
<span 
class="aeti-10">status </span>field when it notices the changes of device configuration. The command
VIRTIO_NET_CTRL_ANNOUNCE_ACK is used to indicate that driver has received
the notification and device clears the VIRTIO_NET_S_ANNOUNCE bit in
<span 
class="aeti-10">status</span>.
<!--l. 4415--><p class="noindent" >Processing this notification involves:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-260004x1">Sending the gratuitous packets (eg. ARP) or marking there are pending
    gratuitous packets to be sent and letting deferred routine to send them.
    </li>
    <li 
  class="enumerate" id="x1-260006x2">Sending   VIRTIO_NET_CTRL_ANNOUNCE_ACK   command   through
    control vq.</li></ol>
<a 
 id="x1-260007r265"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.4.1</span> <a 
 id="x1-2610001"></a>Driver Requirements: Gratuitous Packet Sending</h6>
If the driver negotiates VIRTIO_NET_F_GUEST_ANNOUNCE, it SHOULD notify
network peers of its new location after it sees the VIRTIO_NET_S_ANNOUNCE
bit in <span 
class="aeti-10">status</span>. The driver MUST send a command on the command
queue with class VIRTIO_NET_CTRL_ANNOUNCE and command
VIRTIO_NET_CTRL_ANNOUNCE_ACK.
<a 
 id="x1-261001r267"></a>
                                                                  

                                                                  
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.4.2</span> <a 
 id="x1-2620002"></a>Device Requirements: Gratuitous Packet Sending</h6>
If VIRTIO_NET_F_GUEST_ANNOUNCE is negotiated, the device MUST
clear the VIRTIO_NET_S_ANNOUNCE bit in <span 
class="aeti-10">status </span>upon receipt of a
command buffer with class VIRTIO_NET_CTRL_ANNOUNCE and command
VIRTIO_NET_CTRL_ANNOUNCE_ACK before marking the buffer as used.
<a 
 id="x1-262001r266"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.5.5</span> <a 
 id="x1-2630005"></a>Device operation in multiqueue mode</h5>
This specification defines the following modes that a device MAY implement for
operation with multiple transmit/receive virtqueues:
    <ul class="itemize1">
    <li class="itemize">Automatic receive steering as defined in <a 
href="#x1-2640006">5.1.6.5.6<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue / Automatic receive steering in multiqueue mode --></a>. If a device supports this
    mode, it offers the VIRTIO_NET_F_MQ feature bit.
    </li>
    <li class="itemize">Receive-side scaling as defined in <a 
href="#x1-2720003">5.1.6.5.7.3<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Control Virtqueue / Receive-side scaling (RSS) / RSS processing --></a>. If a device supports this mode,
    it offers the VIRTIO_NET_F_RSS feature bit.</li></ul>
<!--l. 4450--><p class="noindent" >A device MAY support one of these features or both. The driver MAY negotiate any
set of these features that the device supports.
<!--l. 4452--><p class="noindent" >Multiqueue is disabled by default.
<!--l. 4454--><p class="noindent" >The driver enables multiqueue by sending a command using <span 
class="aeti-10">class</span>
VIRTIO_NET_CTRL_MQ. The <span 
class="aeti-10">command </span>selects the mode of multiqueue operation,
as follows: <!--l. 4455-->
<div class="lstlisting" id="listing-64"><span class="label"><a 
 id="x1-263001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MQ</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-263002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">automatic</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">receive</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">steering</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-263003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MQ_RSS_CONFIG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">configurable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">receive</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">steering</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-263004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MQ_HASH_CONFIG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">configurable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">calculation</span><span 
class="pcrr8t-x-x-80">)</span>
</div>
<!--l. 4462--><p class="noindent" >If more than one multiqueue mode is negotiated, the resulting device configuration is
defined by the last command sent by the driver.
<a 
 id="x1-263005r269"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.5.6</span> <a 
 id="x1-2640006"></a>Automatic receive steering in multiqueue mode</h5>
If the driver negotiates the VIRTIO_NET_F_MQ feature bit (depends on
VIRTIO_NET_F_CTRL_VQ), it MAY transmit outgoing packets on one of
the multiple transmitq1…transmitqN and ask the device to queue incoming
packets into one of the multiple receiveq1…receiveqN depending on the packet
flow.
<!--l. 4471--><p class="noindent" >The driver enables multiqueue by sending the VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET
command, specifying the number of the transmit and receive queues to be used up to
<span 
class="aeti-10">max_virtqueue_pairs</span>; subsequently, transmitq1…transmitqn and receiveq1…receiveqn
where n=<span 
class="aeti-10">virtqueue_pairs </span>MAY be used. <!--l. 4477-->
                                                                  

                                                                  
<div class="lstlisting" id="listing-65"><span class="label"><a 
 id="x1-264001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_net_ctrl_mq_pairs_set</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-264002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtqueue_pairs</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-264003r3"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-264004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MQ_VQ_PAIRS_MIN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-264005r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_MQ_VQ_PAIRS_MAX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x8000</span>
</div>
<!--l. 4486--><p class="noindent" >When multiqueue is enabled by VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET
command, the device MUST use automatic receive steering based on packet flow.
Programming of the receive steering classificator is implicit. After the driver
transmitted a packet of a flow on transmitqX, the device SHOULD cause incoming
packets for that flow to be steered to receiveqX. For uni-directional protocols, or
where no packets have been transmitted yet, the device MAY steer a packet to a
random queue out of the specified receiveq1…receiveqn.
<!--l. 4494--><p class="noindent" >Multiqueue is disabled by VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET with
<span 
class="aeti-10">virtqueue_pairs </span>to 1 (this is the default) and waiting for the device to use the
command buffer.
<a 
 id="x1-264008r268"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.6.1</span> <a 
 id="x1-2650001"></a>Driver Requirements: Automatic receive steering in multiqueue
mode</h6>
The driver MUST configure the virtqueues before enabling them with the
VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET command.
<!--l. 4502--><p class="noindent" >The driver MUST NOT request a <span 
class="aeti-10">virtqueue_pairs </span>of 0 or greater than
<span 
class="aeti-10">max_virtqueue_pairs </span>in the device configuration space.
<!--l. 4505--><p class="noindent" >The driver MUST queue packets only on any transmitq1 before the
VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET command.
<!--l. 4508--><p class="noindent" >The driver MUST NOT queue packets on transmit queues greater than
<span 
class="aeti-10">virtqueue_pairs </span>once it has placed the VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET
command in the available ring.
<a 
 id="x1-265001r271"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.6.2</span> <a 
 id="x1-2660002"></a>Device Requirements: Automatic receive steering in multiqueue
mode</h6>
After initialization of reset, the device MUST queue packets only on receiveq1.
<!--l. 4515--><p class="noindent" >The device MUST NOT queue packets on receive queues greater than <span 
class="aeti-10">virtqueue_pairs</span>
once it has placed the VIRTIO_NET_CTRL_MQ_VQ_PAIRS_SET command in a
used buffer.
<a 
 id="x1-266001r272"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.6.3</span> <a 
 id="x1-2670003"></a>Legacy Interface: Automatic receive steering in multiqueue mode</h6>
When using the legacy interface, transitional devices and drivers MUST format
<span 
class="aeti-10">virtqueue_pairs </span>according to the native endian of the guest rather than (necessarily
when not using the legacy interface) little-endian.
<a 
 id="x1-267001r273"></a>
                                                                  

                                                                  
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.6.4</span> <a 
 id="x1-2680004"></a>Hash calculation</h6>
If VIRTIO_NET_F_HASH_REPORT was negotiated and the device uses automatic
receive steering, the device MUST support a command to configure hash calculation
parameters.
<!--l. 4529--><p class="noindent" >The driver provides parameters for hash calculation as follows:
<!--l. 4531--><p class="noindent" ><span 
class="aeti-10">class </span>VIRTIO_NET_CTRL_MQ, <span 
class="aeti-10">command </span>VIRTIO_NET_CTRL_MQ_HASH_CONFIG.
<!--l. 4533--><p class="noindent" >The <span 
class="aeti-10">command-specific-data </span>has following format: <!--l. 4534-->
<div class="lstlisting" id="listing-66"><span class="label"><a 
 id="x1-268001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_net_hash_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-268002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_types</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-268003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">[4];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-268004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_key_length</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-268005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_key_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">hash_key_length</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-268006r6"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 4542--><p class="noindent" >Field <span 
class="aeti-10">hash_types </span>contains a bitmask of allowed hash types as defined in
<a 
href="#x1-2450001">5.1.6.4.3.1<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Processing of Incoming Packets / Hash calculation for incoming packets / Supported/enabled hash types --></a>. Initially the device has all hash types disabled and reports only
VIRTIO_NET_HASH_REPORT_NONE.
<!--l. 4547--><p class="noindent" >Field <span 
class="aeti-10">reserved </span>MUST contain zeroes. It is defined to make the structure to match the
layout of virtio_net_rss_config structure, defined in <a 
href="#x1-2690007">5.1.6.5.7<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue / Receive-side scaling (RSS) --></a>.
<!--l. 4550--><p class="noindent" >Fields <span 
class="aeti-10">hash_key_length </span>and <span 
class="aeti-10">hash_key_data </span>define the key to be used in hash
calculation.
<a 
 id="x1-268007r270"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.5.7</span> <a 
 id="x1-2690007"></a>Receive-side scaling (RSS)</h5>
A device offers the feature VIRTIO_NET_F_RSS if it supports RSS receive steering
with Toeplitz hash calculation and configurable parameters.
<!--l. 4555--><p class="noindent" >A driver queries RSS capabilities of the device by reading device configuration as
defined in <a 
href="#x1-2270004">5.1.4<!--tex4ht:ref: sec:Device Types / Network Device / Device configuration layout --></a>
<a 
 id="x1-269001r274"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.7.1</span> <a 
 id="x1-2700001"></a>Setting RSS parameters</h6>
Driver sends a VIRTIO_NET_CTRL_MQ_RSS_CONFIG command using the
following format for <span 
class="aeti-10">command-specific-data</span>: <!--l. 4560-->
<div class="lstlisting" id="listing-67"><span class="label"><a 
 id="x1-270001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_net_rss_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-270002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_types</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-270003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">indirection_table_mask</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-270004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unclassified_queue</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-270005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">indirection_table</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">indirection_table_length</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-270006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_tx_vq</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-270007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_key_length</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-270008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_key_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">hash_key_length</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-270009r9"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 4571--><p class="noindent" >Field <span 
class="aeti-10">hash_types </span>contains a bitmask of allowed hash types as defined in <a 
href="#x1-2450001">5.1.6.4.3.1<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Processing of Incoming Packets / Hash calculation for incoming packets / Supported/enabled hash types --></a>.
<!--l. 4575--><p class="noindent" >Field <span 
class="aeti-10">indirection_table_mask </span>is a mask to be applied to the calculated hash to
produce an index in the <span 
class="aeti-10">indirection_table </span>array. Number of entries in <span 
class="aeti-10">indirection_table</span>
is (<span 
class="aeti-10">indirection_table_mask </span>+ 1).
                                                                  

                                                                  
<!--l. 4580--><p class="noindent" >Field <span 
class="aeti-10">unclassified_queue </span>contains the 0-based index of the receive virtqueue to place
unclassified packets in. Index 0 corresponds to receiveq1.
<!--l. 4583--><p class="noindent" >Field <span 
class="aeti-10">indirection_table </span>contains an array of 0-based indices of receive virtqueus. Index
0 corresponds to receiveq1.
<!--l. 4585--><p class="noindent" >A driver sets <span 
class="aeti-10">max_tx_vq </span>to inform a device how many transmit virtqueues it may use
(transmitq1…transmitq <span 
class="aeti-10">max_tx_vq</span>).
<!--l. 4587--><p class="noindent" >Fields <span 
class="aeti-10">hash_key_length </span>and <span 
class="aeti-10">hash_key_data </span>define the key to be used in hash
calculation.
<a 
 id="x1-270010r276"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.7.2</span> <a 
 id="x1-2710002"></a>Driver Requirements: Setting RSS parameters</h6>
A driver MUST NOT send the VIRTIO_NET_CTRL_MQ_RSS_CONFIG command if
the feature VIRTIO_NET_F_RSS has not been negotiated.
<!--l. 4593--><p class="noindent" >A driver MUST fill the <span 
class="aeti-10">indirection_table </span>array only with indices of enabled queues.
Index 0 corresponds to receiveq1.
<!--l. 4595--><p class="noindent" >The number of entries in <span 
class="aeti-10">indirection_table </span>(<span 
class="aeti-10">indirection_table_mask </span>+ 1) MUST be a
power of two.
<!--l. 4597--><p class="noindent" >A driver MUST use <span 
class="aeti-10">indirection_table_mask </span>values that are less than
<span 
class="aeti-10">rss_max_indirection_table_length </span>reported by a device.
<!--l. 4599--><p class="noindent" >A driver MUST NOT set any VIRTIO_NET_HASH_TYPE_ flags that are not
supported by a device.
<a 
 id="x1-271001r277"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.7.3</span> <a 
 id="x1-2720003"></a>Device Requirements: RSS processing</h6>
The device MUST determine the destination queue for a network packet as
follows:
    <ul class="itemize1">
    <li class="itemize">Calculate the hash of the packet as defined in <a 
href="#x1-2440003">5.1.6.4.3<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Processing of Incoming Packets / Hash calculation for incoming packets --></a>.
    </li>
    <li class="itemize">If  the  device  did  not  calculate  the  hash  for  the  specific  packet,  the
    device directs the packet to the receiveq specified by <span 
class="aeti-10">unclassified_queue </span>of
    virtio_net_rss_config structure (value of 0 corresponds to receiveq1).
    </li>
    <li class="itemize">Apply <span 
class="aeti-10">indirection_table_mask </span>to the calculated hash and use the result as
    the index in the indirection table to get 0-based number of destination
    receiveq (value of 0 corresponds to receiveq1).</li></ul>
<a 
 id="x1-272001r275"></a>
<h5 class="paragraphHead"><span class="titlemark">5.1.6.5.8</span> <a 
 id="x1-2730008"></a>Offloads State Configuration</h5>
If the VIRTIO_NET_F_CTRL_GUEST_OFFLOADS feature is negotiated, the driver
                                                                  

                                                                  
can send control commands for dynamic offloads state configuration.
<a 
 id="x1-273001r278"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.8.1</span> <a 
 id="x1-2740001"></a>Setting Offloads State</h6>
To configure the offloads, the following layout structure and definitions are
used:
<!--l. 4619-->
<div class="lstlisting" id="listing-68"><span class="label"><a 
 id="x1-274001r1"></a></span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">offloads</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-274002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-274003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_F_GUEST_CSUM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-274004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_F_GUEST_TSO4</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-274005r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_F_GUEST_TSO6</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-274006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_F_GUEST_ECN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-274007r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_F_GUEST_UFO</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">10</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-274008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-274009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_GUEST_OFFLOADS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-274010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_NET_CTRL_GUEST_OFFLOADS_SET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span>
</div>
<!--l. 4632--><p class="noindent" >The class VIRTIO_NET_CTRL_GUEST_OFFLOADS has one command:
VIRTIO_NET_CTRL_GUEST_OFFLOADS_SET applies the new offloads
configuration.
<!--l. 4635--><p class="noindent" >le64 value passed as command data is a bitmask, bits set define offloads to be
enabled, bits cleared - offloads to be disabled.
<!--l. 4638--><p class="noindent" >There is a corresponding device feature for each offload. Upon feature negotiation
corresponding offload gets enabled to preserve backward compatibility.
<a 
 id="x1-274011r280"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.8.2</span> <a 
 id="x1-2750002"></a>Driver Requirements: Setting Offloads State</h6>
A driver MUST NOT enable an offload for which the appropriate feature has not
been negotiated.
<a 
 id="x1-275001r281"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.1.6.5.8.3</span> <a 
 id="x1-2760003"></a>Legacy Interface: Setting Offloads State</h6>
When using the legacy interface, transitional devices and drivers MUST format
<span 
class="aeti-10">offloads </span>according to the native endian of the guest rather than (necessarily when not
using the legacy interface) little-endian.
<a 
 id="x1-276001r256"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.1.6.6   </span> <a 
 id="x1-2770006"></a>Legacy Interface: Framing Requirements</h5>
<!--l. 4657--><p class="nopar" >When using legacy interfaces, transitional drivers which have not negotiated
VIRTIO_F_ANY_LAYOUT MUST use a single descriptor for the struct
virtio_net_hdr on both transmit and receive, with the network data in the following
descriptors.
<!--l. 4662--><p class="noindent" >Additionally, when using the control virtqueue (see <a 
href="#x1-2500005">5.1.6.5<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue --></a>) , transitional drivers
which have not negotiated VIRTIO_F_ANY_LAYOUT MUST:
    <ul class="itemize1">
    <li class="itemize">for all commands, use a single 2-byte descriptor including the first two
    fields: <span 
class="aeti-10">class </span>and <span 
class="aeti-10">command</span>
                                                                  

                                                                  
    </li>
    <li class="itemize">for all commands except VIRTIO_NET_CTRL_MAC_TABLE_SET use a
    single descriptor including command-specific-data with no padding.
    </li>
    <li class="itemize">for  the  VIRTIO_NET_CTRL_MAC_TABLE_SET  command  use  exactly
    two descriptors including command-specific-data with no padding: the first
    of these descriptors MUST include the virtio_net_ctrl_mac table structure
    for the unicast addresses with no padding, the second of these descriptors
    MUST include the virtio_net_ctrl_mac table structure for the multicast
    addresses with no padding.
    </li>
    <li class="itemize">for all commands, use a single 1-byte descriptor for the <span 
class="aeti-10">ack </span>field</li></ul>
<!--l. 4683--><p class="noindent" >See <a 
href="#x1-390004">2.7.4<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Message Framing --></a>.
<a 
 id="x1-277001r227"></a>
<h3 class="sectionHead"><span class="titlemark">5.2   </span> <a 
 id="x1-2780002"></a>Block Device</h3>
<!--l. 4688--><p class="nopar" >The virtio block device is a simple virtual block device (ie. disk). Read and write
requests (and other exotic requests) are placed in one of its queues, and serviced
(probably out of order) by the device except where noted.
<a 
 id="x1-278001r238"></a>
<h4 class="subsectionHead"><span class="titlemark">5.2.1   </span> <a 
 id="x1-2790001"></a>Device ID</h4>
<!--l. 4694--><p class="nopar" >2
<a 
 id="x1-279001r285"></a>
<h4 class="subsectionHead"><span class="titlemark">5.2.2   </span> <a 
 id="x1-2800002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">requestq1
    </dd><dt class="description">
<span 
class="aeb10-">…</span> </dt><dd 
class="description">
    </dd><dt class="description">
<span 
class="aeb10-">N-1</span> </dt><dd 
class="description">requestqN</dd></dl>
<!--l. 4703--><p class="nopar" >N=1 if VIRTIO_BLK_F_MQ is not negotiated, otherwise N is set by <span 
class="aeti-10">num_queues</span>.
<a 
 id="x1-280001r286"></a>
<h4 class="subsectionHead"><span class="titlemark">5.2.3   </span> <a 
 id="x1-2810003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_BLK_F_SIZE_MAX (1)</span> </dt><dd 
class="description">Maximum  size  of  any  single  segment  is  in
    <span 
class="aeti-10">size_max</span>.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BLK_F_SEG_MAX (2)</span> </dt><dd 
class="description">Maximum number of segments in a request is
    in <span 
class="aeti-10">seg_max</span>.
                                                                  

                                                                  
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BLK_F_GEOMETRY (4)</span> </dt><dd 
class="description">Disk-style geometry specified in <span 
class="aeti-10">geometry</span>.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BLK_F_RO (5)</span> </dt><dd 
class="description">Device is read-only.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BLK_F_BLK_SIZE (6)</span> </dt><dd 
class="description">Block size of disk is in <span 
class="aeti-10">blk_size</span>.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BLK_F_FLUSH (9)</span> </dt><dd 
class="description">Cache flush command support.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BLK_F_TOPOLOGY (10)</span> </dt><dd 
class="description">Device exports information on optimal I/O
    alignment.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BLK_F_CONFIG_WCE (11)</span> </dt><dd 
class="description">Device  can  toggle  its  cache  between
    writeback and writethrough modes.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BLK_F_MQ (12)</span> </dt><dd 
class="description">Device supports multiqueue.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BLK_F_DISCARD (13)</span> </dt><dd 
class="description">Device   can   support   discard   command,
    maximum discard sectors size in <span 
class="aeti-10">max_discard_sectors </span>and maximum discard
    segment number in <span 
class="aeti-10">max_discard_seg</span>.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BLK_F_WRITE_ZEROES (14)</span> </dt><dd 
class="description">Device   can   support   write   zeroes
    command, maximum write zeroes sectors size in <span 
class="aeti-10">max_write_zeroes_sectors</span>
    and maximum write zeroes segment number in <span 
class="aeti-10">max_write_zeroes_seg</span>.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BLK_F_LIFETIME (15)</span> </dt><dd 
class="description">Device  supports  providing  storage  lifetime
    information.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BLK_F_SECURE_ERASE (16)</span> </dt><dd 
class="description">Device     supports     secure     erase
    command, maximum erase sectors count in <span 
class="aeti-10">max_secure_erase_sectors </span>and
    maximum erase segment number in <span 
class="aeti-10">max_secure_erase_seg</span>.
    </dd></dl>
<a 
 id="x1-281001r283"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.3.1   </span> <a 
 id="x1-2820001"></a>Legacy Interface: Feature bits</h5>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_BLK_F_BARRIER (0)</span> </dt><dd 
class="description">Device supports request barriers.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BLK_F_SCSI (7)</span> </dt><dd 
class="description">Device supports scsi packet commands.</dd></dl>
                                                                  

                                                                  
<span 
class="aeb10-">Note:</span> In   the   legacy   interface,   VIRTIO_BLK_F_FLUSH   was   also   called
      VIRTIO_BLK_F_WCE.
<a 
 id="x1-282001r287"></a>
<h4 class="subsectionHead"><span class="titlemark">5.2.4   </span> <a 
 id="x1-2830004"></a>Device configuration layout</h4>
<!--l. 4764--><p class="nopar" >The <span 
class="aeti-10">capacity </span>of the device (expressed in 512-byte sectors) is always present.
The availability of the others all depend on various feature bits as indicated
above.
<!--l. 4768--><p class="noindent" >The field <span 
class="aeti-10">num_queues </span>only exists if VIRTIO_BLK_F_MQ is set. This field specifies
the number of queues.
<!--l. 4771--><p class="noindent" >The parameters in the configuration space of the device <span 
class="aeti-10">max_discard_sectors</span>
<span 
class="aeti-10">discard_sector_alignment </span>are expressed in 512-byte units if the VIRTIO_BLK_F_DISCARD
feature bit is negotiated. The <span 
class="aeti-10">max_write_zeroes_sectors </span>is expressed in 512-byte units if
the VIRTIO_BLK_F_WRITE_ZEROES feature bit is negotiated. The parameters in the
configuration space of the device <span 
class="aeti-10">max_secure_erase_sectors secure_erase_sector_alignment</span>
are expressed in 512-byte units if the VIRTIO_BLK_F_SECURE_ERASE feature bit
is negotiated.
<!--l. 4779-->
<div class="lstlisting" id="listing-69"><span class="label"><a 
 id="x1-283001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_blk_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">capacity</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size_max</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">seg_max</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_blk_geometry</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cylinders</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">heads</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sectors</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">geometry</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">blk_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_blk_topology</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">logical</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">blocks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">per</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">physical</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">log2</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">physical_block_exp</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">offset</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">first</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aligned</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">logical</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">block</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">alignment_offset</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">suggested</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">minimum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">I</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">O</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">blocks</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">min_io_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">optimal</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">suggested</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">maximum</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">I</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">O</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">blocks</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">opt_io_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">topology</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">writeback</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283022r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unused0</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_queues</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283024r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_discard_sectors</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283025r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_discard_seg</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283026r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">discard_sector_alignment</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283027r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_write_zeroes_sectors</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283028r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_write_zeroes_seg</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283029r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write_zeroes_may_unmap</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283030r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unused1</span><span 
class="pcrr8t-x-x-80">[3];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283031r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_secure_erase_sectors</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283032r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_secure_erase_seg</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283033r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">secure_erase_sector_alignment</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-283034r34"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-283035r288"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.4.1   </span> <a 
 id="x1-2840001"></a>Legacy Interface: Device configuration layout</h5>
<!--l. 4818--><p class="nopar" >When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_blk_config according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<a 
 id="x1-284001r289"></a>
<h4 class="subsectionHead"><span class="titlemark">5.2.5   </span> <a 
 id="x1-2850005"></a>Device Initialization</h4>
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-285002x1">The device size can be read from <span 
class="aeti-10">capacity</span>.
    </li>
    <li 
  class="enumerate" id="x1-285004x2">If the VIRTIO_BLK_F_BLK_SIZE feature is negotiated, <span 
class="aeti-10">blk_size </span>can be
    read to determine the optimal sector size for the driver to use. This does
    not affect the units used in the protocol (always 512 bytes), but awareness
    of the correct value can affect performance.
    </li>
    <li 
  class="enumerate" id="x1-285006x3">If the VIRTIO_BLK_F_RO feature is set by the device, any write requests
    will fail.
                                                                  

                                                                  
    </li>
    <li 
  class="enumerate" id="x1-285008x4">If the VIRTIO_BLK_F_TOPOLOGY feature is negotiated, the fields in the
    <span 
class="aeti-10">topology </span>struct can be read to determine the physical block size and optimal
    I/O lengths for the driver to use. This also does not affect the units in the
    protocol, only performance.
    </li>
    <li 
  class="enumerate" id="x1-285010x5">If  the  VIRTIO_BLK_F_CONFIG_WCE  feature  is  negotiated,  the  cache
    mode can be read or set through the <span 
class="aeti-10">writeback </span>field. 0 corresponds to a
    writethrough cache, 1 to a writeback cache<span class="footnote-mark"><a 
href="#fn11x5" id="fn11x5-bk"><sup class="textsuperscript">11</sup></a></span><a 
 id="x1-285011f11"></a>.
    The cache mode after reset can be either writeback or writethrough. The
    actual mode can be determined by reading <span 
class="aeti-10">writeback </span>after feature negotiation.
    </li>
    <li 
  class="enumerate" id="x1-285013x6">If                                                                                           the
    VIRTIO_BLK_F_DISCARD feature is negotiated, <span 
class="aeti-10">max_discard_sectors </span>and
    <span 
class="aeti-10">max_discard_seg </span>can be read to determine the maximum discard sectors
    and maximum number of discard segments for the block driver to use.
    <span 
class="aeti-10">discard_sector_alignment </span>can be used by OS when splitting a request based
    on alignment.
    </li>
    <li 
  class="enumerate" id="x1-285015x7">If        the        VIRTIO_BLK_F_WRITE_ZEROES        feature        is
    negotiated, <span 
class="aeti-10">max_write_zeroes_sectors </span>and <span 
class="aeti-10">max_write_zeroes_seg </span>can be read
    to determine the maximum write zeroes sectors and maximum number of
    write zeroes segments for the block driver to use.
    </li>
    <li 
  class="enumerate" id="x1-285017x8">If the VIRTIO_BLK_F_MQ feature is negotiated, <span 
class="aeti-10">num_queues </span>field can be
    read to determine the number of queues.
    </li>
    <li 
  class="enumerate" id="x1-285019x9">If                      the                      VIRTIO_BLK_F_SECURE_ERASE
    feature is negotiated, <span 
class="aeti-10">max_secure_erase_sectors </span>and <span 
class="aeti-10">max_secure_erase_seg</span>
    can  be  read  to  determine  the  maximum  secure  erase  sectors  and
    maximum number of secure erase segments for the block driver to use.
    <span 
class="aeti-10">secure_erase_sector_alignment </span>can be used by OS when splitting a request
    based on alignment.
    </li></ol>
<a 
 id="x1-285020r290"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.5.1   </span> <a 
 id="x1-2860001"></a>Driver Requirements: Device Initialization</h5>
<!--l. 4880--><p class="nopar" >Drivers SHOULD NOT negotiate VIRTIO_BLK_F_FLUSH if they are incapable of
sending VIRTIO_BLK_T_FLUSH commands.
<!--l. 4883--><p class="noindent" >If neither VIRTIO_BLK_F_CONFIG_WCE nor VIRTIO_BLK_F_FLUSH are
negotiated, the driver MAY deduce the presence of a writethrough cache. If
VIRTIO_BLK_F_CONFIG_WCE was not negotiated but VIRTIO_BLK_F_FLUSH
                                                                  

                                                                  
was, the driver SHOULD assume presence of a writeback cache.
<!--l. 4888--><p class="noindent" >The driver MUST NOT read <span 
class="aeti-10">writeback </span>before setting the FEATURES_OK <span 
class="aeti-10">device</span>
<span 
class="aeti-10">status </span>bit.
<a 
 id="x1-286001r292"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.5.2   </span> <a 
 id="x1-2870002"></a>Device Requirements: Device Initialization</h5>
<!--l. 4893--><p class="nopar" >Devices SHOULD always offer VIRTIO_BLK_F_FLUSH, and MUST offer it if they
offer VIRTIO_BLK_F_CONFIG_WCE.
<!--l. 4896--><p class="noindent" >If VIRTIO_BLK_F_CONFIG_WCE is negotiated but VIRTIO_BLK_F_FLUSH is not,
the device MUST initialize <span 
class="aeti-10">writeback </span>to 0.
<!--l. 4899--><p class="noindent" >The device MUST initialize padding bytes <span 
class="aeti-10">unused0 </span>and <span 
class="aeti-10">unused1 </span>to 0.
<a 
 id="x1-287001r293"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.5.3   </span> <a 
 id="x1-2880003"></a>Legacy Interface: Device Initialization</h5>
<!--l. 4904--><p class="nopar" >Because legacy devices do not have FEATURES_OK, transitional devices
MUST implement slightly different behavior around feature negotiation
when used through the legacy interface. In particular, when using the legacy
interface:
    <ul class="itemize1">
    <li class="itemize">the driver MAY read or write <span 
class="aeti-10">writeback  </span>before setting the DRIVER or
    DRIVER_OK <span 
class="aeti-10">device status </span>bit
    </li>
    <li class="itemize">the device MUST NOT modify the cache mode (and <span 
class="aeti-10">writeback</span>) as a result
    of a driver setting a status bit, unless the DRIVER_OK bit is being set and
    the driver has not set the VIRTIO_BLK_F_CONFIG_WCE driver feature
    bit.
    </li>
    <li class="itemize">the device MUST NOT modify the cache mode (and <span 
class="aeti-10">writeback</span>) as a result
    of a driver modifying the driver feature bits, for example if the driver sets
    the VIRTIO_BLK_F_CONFIG_WCE driver feature bit but does not set
    the VIRTIO_BLK_F_FLUSH bit.</li></ul>
<a 
 id="x1-288001r291"></a>
<h4 class="subsectionHead"><span class="titlemark">5.2.6   </span> <a 
 id="x1-2890006"></a>Device Operation</h4>
<!--l. 4927--><p class="nopar" >The driver queues requests to the virtqueues, and they are used by the device (not
necessarily in order). Each request is of form:
<!--l. 4930-->
<div class="lstlisting" id="listing-70"><span class="label"><a 
 id="x1-289001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_blk_req</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sector</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289007r7"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
                                                                  

                                                                  
<!--l. 4940--><p class="noindent" >The type of the request is either a read (VIRTIO_BLK_T_IN), a write
(VIRTIO_BLK_T_OUT), a discard (VIRTIO_BLK_T_DISCARD), a write zeroes
(VIRTIO_BLK_T_WRITE_ZEROES), a flush (VIRTIO_BLK_T_FLUSH), a
get device ID string command (VIRTIO_BLK_T_GET_ID), a secure erase
(VIRTIO_BLK_T_SECURE_ERASE), or a get device lifetime command
(VIRTIO_BLK_T_GET_LIFETIME).
<!--l. 4947-->
<div class="lstlisting" id="listing-71"><span class="label"><a 
 id="x1-289008r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_IN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289009r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_OUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289010r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_FLUSH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289011r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_GET_ID</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289012r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_GET_LIFETIME</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">10</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289013r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_DISCARD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">11</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289014r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_WRITE_ZEROES</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">13</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289015r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_SECURE_ERASE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">14</span>
</div>
<!--l. 4958--><p class="noindent" >The <span 
class="aeti-10">sector </span>number indicates the offset (multiplied by 512) where the read or write is
to occur. This field is unused and set to 0 for commands other than read or
write.
<!--l. 4962--><p class="noindent" >VIRTIO_BLK_T_IN requests populate <span 
class="aeti-10">data </span>with the contents of sectors read
from the block device (in multiples of 512 bytes). VIRTIO_BLK_T_OUT
requests write the contents of <span 
class="aeti-10">data </span>to the block device (in multiples of 512
bytes).
<!--l. 4967--><p class="noindent" >The <span 
class="aeti-10">data </span>used for discard, secure erase or write zeroes commands consists of one
or more segments. The maximum number of segments is <span 
class="aeti-10">max_discard_seg</span>
for discard commands, <span 
class="aeti-10">max_secure_erase_seg </span>for secure erase commands
and <span 
class="aeti-10">max_write_zeroes_seg </span>for write zeroes commands. Each segment is of
form:
<!--l. 4974-->
<div class="lstlisting" id="listing-72"><span class="label"><a 
 id="x1-289016r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_blk_discard_write_zeroes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289017r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sector</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289018r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_sectors</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289019r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289020r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unmap</span><span 
class="pcrr8t-x-x-80">:1;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289021r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">:31;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289022r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289023r8"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 4985--><p class="noindent" ><span 
class="aeti-10">sector </span>indicates the starting offset (in 512-byte units) of the segment, while
<span 
class="aeti-10">num_sectors </span>indicates the number of sectors in each discarded range. <span 
class="aeti-10">unmap </span>is only
used in write zeroes commands and allows the device to discard the specified range,
provided that following reads return zeroes.
<!--l. 4991--><p class="noindent" >VIRTIO_BLK_T_GET_ID requests fetch the device ID string from the device into
<span 
class="aeti-10">data</span>. The device ID string is a NUL-padded ASCII string up to 20 bytes long. If the
string is 20 bytes long then there is no NUL terminator.
<!--l. 4995--><p class="noindent" >The <span 
class="aeti-10">data </span>used for VIRTIO_BLK_T_GET_LIFETIME requests is populated by the
device, and is of the form
<!--l. 4998-->
<div class="lstlisting" id="listing-73"><span class="label"><a 
 id="x1-289024r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_blk_lifetime</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289025r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pre_eol_info</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289026r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device_lifetime_est_typ_a</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289027r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device_lifetime_est_typ_b</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289028r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
                                                                  

                                                                  
</div>
<!--l. 5006--><p class="noindent" >The <span 
class="aeti-10">pre_eol_info </span>specifies the percentage of reserved blocks that are consumed and
will have one of these values:
<!--l. 5009-->
<div class="lstlisting" id="listing-74"><span class="label"><a 
 id="x1-289029r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Value</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">not</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">available</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289030r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_PRE_EOL_INFO_UNDEFINED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289031r3"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">80%</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">blocks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">consumed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289032r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_PRE_EOL_INFO_NORMAL</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289033r5"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">80%</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">blocks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">consumed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289034r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_PRE_EOL_INFO_WARNING</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289035r7"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">90%</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">blocks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">consumed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289036r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_PRE_EOL_INFO_URGENT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289037r9"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">All</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">others</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">values</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span>
</div>
<!--l. 5021--><p class="noindent" >The <span 
class="aeti-10">device_lifetime_est_typ_a </span>refers to wear of SLC cells and is provided in increments
of 10used, and so on, thru to 11 meaning estimated lifetime exceeded. All values
above 11 are reserved.
<!--l. 5026--><p class="noindent" >The <span 
class="aeti-10">device_lifetime_est_typ_b </span>refers to wear of MLC cells and is provided with the
same semantics as <span 
class="aeti-10">device_lifetime_est_typ_a</span>.
<!--l. 5029--><p class="noindent" >The final <span 
class="aeti-10">status </span>byte is written by the device: either VIRTIO_BLK_S_OK for success,
VIRTIO_BLK_S_IOERR for device or driver error or VIRTIO_BLK_S_UNSUPP for a
request unsupported by device:
<!--l. 5033-->
<div class="lstlisting" id="listing-75"><span class="label"><a 
 id="x1-289038r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_S_OK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289039r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_S_IOERR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-289040r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_S_UNSUPP</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span>
</div>
<!--l. 5039--><p class="noindent" >The status of individual segments is indeterminate when a discard or write zero
command produces VIRTIO_BLK_S_IOERR. A segment may have completed
successfully, failed, or not been processed by the device.
<a 
 id="x1-289041r294"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.6.1   </span> <a 
 id="x1-2900001"></a>Driver Requirements: Device Operation</h5>
<!--l. 5045--><p class="nopar" >A driver MUST NOT submit a request which would cause a read or write beyond
<span 
class="aeti-10">capacity</span>.
<!--l. 5048--><p class="noindent" >A driver SHOULD accept the VIRTIO_BLK_F_RO feature if offered.
<!--l. 5050--><p class="noindent" >A driver MUST set <span 
class="aeti-10">sector </span>to 0 for a VIRTIO_BLK_T_FLUSH request. A driver
SHOULD NOT include any data in a VIRTIO_BLK_T_FLUSH request.
<!--l. 5053--><p class="noindent" >The length of <span 
class="aeti-10">data </span>MUST be a multiple of 512 bytes for VIRTIO_BLK_T_IN and
VIRTIO_BLK_T_OUT requests.
<!--l. 5056--><p class="noindent" >The length of <span 
class="aeti-10">data </span>MUST be a multiple of the size of struct virtio_blk_discard_write_zeroes
for VIRTIO_BLK_T_DISCARD, VIRTIO_BLK_T_SECURE_ERASE and
VIRTIO_BLK_T_WRITE_ZEROES requests.
<!--l. 5060--><p class="noindent" >The length of <span 
class="aeti-10">data </span>MUST be 20 bytes for VIRTIO_BLK_T_GET_ID requests.
                                                                  

                                                                  
<!--l. 5062--><p class="noindent" >VIRTIO_BLK_T_DISCARD requests MUST NOT contain more than <span 
class="aeti-10">max_discard_seg</span>
struct virtio_blk_discard_write_zeroes segments in <span 
class="aeti-10">data</span>.
<!--l. 5066--><p class="noindent" >VIRTIO_BLK_T_SECURE_ERASE requests MUST NOT contain more than
<span 
class="aeti-10">max_secure_erase_seg </span>struct virtio_blk_discard_write_zeroes segments in <span 
class="aeti-10">data</span>.
<!--l. 5070--><p class="noindent" >VIRTIO_BLK_T_WRITE_ZEROES requests MUST NOT contain more than
<span 
class="aeti-10">max_write_zeroes_seg </span>struct virtio_blk_discard_write_zeroes segments in <span 
class="aeti-10">data</span>.
<!--l. 5074--><p class="noindent" >If the VIRTIO_BLK_F_CONFIG_WCE feature is negotiated, the driver MAY switch
to writethrough or writeback mode by writing respectively 0 and 1 to the
<span 
class="aeti-10">writeback </span>field. After writing a 0 to <span 
class="aeti-10">writeback</span>, the driver MUST NOT assume
that any volatile writes have been committed to persistent device backend
storage.
<!--l. 5080--><p class="noindent" >The <span 
class="aeti-10">unmap </span>bit MUST be zero for discard commands. The driver MUST NOT
assume anything about the data returned by read requests after a range of sectors
has been discarded.
<!--l. 5084--><p class="noindent" >A driver MUST NOT assume that individual segments in a multi-segment
VIRTIO_BLK_T_DISCARD or VIRTIO_BLK_T_WRITE_ZEROES request
completed successfully, failed, or were processed by the device at all if the request
failed with VIRTIO_BLK_S_IOERR.
<a 
 id="x1-290001r296"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.6.2   </span> <a 
 id="x1-2910002"></a>Device Requirements: Device Operation</h5>
<!--l. 5091--><p class="nopar" >A device MUST set the <span 
class="aeti-10">status </span>byte to VIRTIO_BLK_S_IOERR for a write request
if the VIRTIO_BLK_F_RO feature if offered, and MUST NOT write any
data.
<!--l. 5095--><p class="noindent" >The device MUST set the <span 
class="aeti-10">status </span>byte to VIRTIO_BLK_S_UNSUPP for discard,
secure erase and write zeroes commands if any unknown flag is set. Furthermore, the
device MUST set the <span 
class="aeti-10">status </span>byte to VIRTIO_BLK_S_UNSUPP for discard commands
if the <span 
class="aeti-10">unmap </span>flag is set.
<!--l. 5100--><p class="noindent" >For discard commands, the device MAY deallocate the specified range of sectors in
the device backend storage.
<!--l. 5103--><p class="noindent" >For write zeroes commands, if the <span 
class="aeti-10">unmap </span>is set, the device MAY deallocate the
specified range of sectors in the device backend storage, as if the discard command
had been sent. After a write zeroes command is completed, reads of the specified
ranges of sectors MUST return zeroes. This is true independent of whether <span 
class="aeti-10">unmap</span>
was set or clear.
<!--l. 5109--><p class="noindent" >The device SHOULD clear the <span 
class="aeti-10">write_zeroes_may_unmap </span>field of the virtio
configuration space if and only if a write zeroes request cannot result in deallocating
one or more sectors. The device MAY change the content of the field during
operation of the device; when this happens, the device SHOULD trigger a
configuration change notification.
                                                                  

                                                                  
<!--l. 5115--><p class="noindent" >A write is considered volatile when it is submitted; the contents of sectors covered by
a volatile write are undefined in persistent device backend storage until the write
becomes stable. A write becomes stable once it is completed and one or more of the
following conditions is true:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-291002x1"><a 
 id="x1-2910011"></a> neither  VIRTIO_BLK_F_CONFIG_WCE  nor  VIRTIO_BLK_F_FLUSH
    feature were negotiated, but VIRTIO_BLK_F_FLUSH was offered by the
    device;
    </li>
    <li 
  class="enumerate" id="x1-291004x2"><a 
 id="x1-2910032"></a> the  VIRTIO_BLK_F_CONFIG_WCE  feature  was  negotiated  and  the
    <span 
class="aeti-10">writeback  </span>field  in  configuration  space  was  0  <span 
class="aeb10-">all  the  time  between  the</span>
    <span 
class="aeb10-">submission of the write and its completion</span>;
    </li>
    <li 
  class="enumerate" id="x1-291006x3"><a 
 id="x1-2910053"></a> a VIRTIO_BLK_T_FLUSH request is sent <span 
class="aeb10-">after the write is completed</span>
    and is completed itself.</li></ol>
<!--l. 5133--><p class="noindent" >If the device is backed by persistent storage, the device MUST ensure that stable
writes are committed to it, before reporting completion of the write (cases <a 
href="#x1-2910011">1<!--tex4ht:ref: item:flush1 --></a>
and <a 
href="#x1-2910032">2<!--tex4ht:ref: item:flush2 --></a>) or the flush (case <a 
href="#x1-2910053">3<!--tex4ht:ref: item:flush3 --></a>). Failure to do so can cause data loss in case of a
crash.
<!--l. 5139--><p class="noindent" >If the driver changes <span 
class="aeti-10">writeback </span>between the submission of the write and its
completion, the write could be either volatile or stable when its completion is
reported; in other words, the exact behavior is undefined.
<!--l. 5149--><p class="noindent" >If VIRTIO_BLK_F_FLUSH was not offered by the
device<span class="footnote-mark"><a 
href="#fn12x5" id="fn12x5-bk"><sup class="textsuperscript">12</sup></a></span><a 
 id="x1-291007f12"></a>,
the device MAY also commit writes to persistent device backend storage before
reporting their completion. Unlike case <a 
href="#x1-2910011">1<!--tex4ht:ref: item:flush1 --></a>, however, this is not an absolute
requirement of the specification.
<span 
class="aeb10-">Note:</span> An implementation that does not offer VIRTIO_BLK_F_FLUSH and does
      not commit completed writes will not be resilient to data loss in case of
      crashes. Not offering VIRTIO_BLK_F_FLUSH is an absolute requirement
      for implementations that do not wish to be safe against such data losses.
<!--l. 5164--><p class="noindent" >If the device is backed by storage providing lifetime metrics (such as eMMC or UFS
persistent storage), the device SHOULD offer the VIRTIO_BLK_F_LIFETIME flag.
The flag MUST NOT be offered if the device is backed by storage for which the
lifetime metrics described in this document cannot be obtained or for which such
metrics have no useful meaning. If the metrics are offered, the device MUST NOT
send any reserved values, as defined in this specification.
<span 
class="aeb10-">Note:</span> The   device   lifetime   metrics   <span 
class="aeti-10">pre_eol_info</span>,   <span 
class="aeti-10">device_lifetime_est_a   </span>and
      <span 
class="aeti-10">device_lifetime_est_b </span>are discussed in the JESD84-B50 specification.
                                                                  

                                                                  
      <!--l. 5175--><p class="noindent" >The   complete   JESD84-B50   is   available   at   the   JEDEC   website
      (https://www.jedec.org)  pursuant  to  JEDEC’s  licensing  terms  and
      conditions.   This   information   is   provided   to   simplfy   passthrough
      implementations from eMMC devices.
<a 
 id="x1-291008r297"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.6.3   </span> <a 
 id="x1-2920003"></a>Legacy Interface: Device Operation</h5>
<!--l. 5181--><p class="nopar" >When using the legacy interface, transitional devices and drivers MUST format the
fields in struct virtio_blk_req according to the native endian of the guest rather than
(necessarily when not using the legacy interface) little-endian.
<!--l. 5186--><p class="noindent" >When using the legacy interface, transitional drivers SHOULD ignore the used length
values.
<span 
class="aeb10-">Note:</span> Historically, some devices put the total descriptor length, or the total
      length of device-writable buffers there, even when only the status byte
      was actually written.
<!--l. 5194--><p class="noindent" >The <span 
class="aeti-10">reserved </span>field was previously called <span 
class="aeti-10">ioprio</span>. <span 
class="aeti-10">ioprio </span>is a hint about the relative
priorities of requests to the device: higher numbers indicate more important
requests.
<!--l. 5198-->
<div class="lstlisting" id="listing-76"><span class="label"><a 
 id="x1-292001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_FLUSH_OUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span>
</div>
<!--l. 5202--><p class="noindent" >The command VIRTIO_BLK_T_FLUSH_OUT was a synonym for
VIRTIO_BLK_T_FLUSH; a driver MUST treat it as a VIRTIO_BLK_T_FLUSH
command.
<!--l. 5205-->
<div class="lstlisting" id="listing-77"><span class="label"><a 
 id="x1-292002r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_BARRIER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x80000000</span>
</div>
<!--l. 5209--><p class="noindent" >If the device has VIRTIO_BLK_F_BARRIER feature the high bit
(VIRTIO_BLK_T_BARRIER) indicates that this request acts as a barrier and that
all preceding requests SHOULD be complete before this one, and all following
requests SHOULD NOT be started until this is complete.
<span 
class="aeb10-">Note:</span> A  barrier  does  not  flush  caches  in  the  underlying  backend  device  in
      host,  and  thus  does  not  serve  as  data  consistency  guarantee.  Only  a
      VIRTIO_BLK_T_FLUSH request does that.
                                                                  

                                                                  
<!--l. 5221--><p class="noindent" >Some older legacy devices did not commit completed writes to persistent device
backend storage when VIRTIO_BLK_F_FLUSH was offered but not negotiated.
In order to work around this, the driver MAY set the <span 
class="aeti-10">writeback </span>to 0 (if
available) or it MAY send an explicit flush request after every completed
write.
<!--l. 5227--><p class="noindent" >If the device has VIRTIO_BLK_F_SCSI feature, it can also support scsi packet
command requests, each of these requests is of form:
<!--l. 5230-->
<div class="lstlisting" id="listing-78"><span class="label"><a 
 id="x1-292003r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">All</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">guest</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">native</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">endian</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-292004r2"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_pc_req</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-292005r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-292006r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ioprio</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-292007r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sector</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-292008r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cmd</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-292009r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">[][512];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-292010r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SCSI_SENSE_BUFFERSIZE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">96</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-292011r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sense</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">SCSI_SENSE_BUFFERSIZE</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-292012r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">errors</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-292013r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-292014r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sense_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-292015r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">residual</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-292016r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-292017r15"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 5248--><p class="noindent" >A request type can also be a scsi packet command (VIRTIO_BLK_T_SCSI_CMD or
VIRTIO_BLK_T_SCSI_CMD_OUT). The two types are equivalent, the device does
not distinguish between them:
<!--l. 5252-->
<div class="lstlisting" id="listing-79"><span class="label"><a 
 id="x1-292018r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_SCSI_CMD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-292019r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BLK_T_SCSI_CMD_OUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span>
</div>
<!--l. 5257--><p class="noindent" >The <span 
class="aeti-10">cmd </span>field is only present for scsi packet command requests, and indicates the
command to perform. This field MUST reside in a single, separate device-readable
buffer; command length can be derived from the length of this buffer.
<!--l. 5262--><p class="noindent" >Note that these first three (four for scsi packet commands) fields are always
device-readable: <span 
class="aeti-10">data </span>is either device-readable or device-writable, depending on the
request. The size of the read or write can be derived from the total size of the request
buffers.
<!--l. 5267--><p class="noindent" ><span 
class="aeti-10">sense </span>is only present for scsi packet command requests, and indicates the buffer for
scsi sense data.
<!--l. 5270--><p class="noindent" ><span 
class="aeti-10">data_len </span>is only present for scsi packet command requests, this field is deprecated,
and SHOULD be ignored by the driver. Historically, devices copied data length
there.
<!--l. 5274--><p class="noindent" ><span 
class="aeti-10">sense_len </span>is only present for scsi packet command requests and indicates the number
of bytes actually written to the <span 
class="aeti-10">sense </span>buffer.
<!--l. 5278--><p class="noindent" ><span 
class="aeti-10">residual </span>field is only present for scsi packet command requests and indicates the
residual size, calculated as data length - number of bytes actually transferred.
<a 
 id="x1-292020r298"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.2.6.4   </span> <a 
 id="x1-2930004"></a>Legacy Interface: Framing Requirements</h5>
<!--l. 5284--><p class="nopar" >When using legacy interfaces, transitional drivers which have not negotiated
VIRTIO_F_ANY_LAYOUT:
                                                                  

                                                                  
    <ul class="itemize1">
    <li class="itemize">MUST use a single 8-byte descriptor containing <span 
class="aeti-10">type</span>, <span 
class="aeti-10">reserved </span>and <span 
class="aeti-10">sector</span>,
    followed by descriptors for <span 
class="aeti-10">data</span>, then finally a separate 1-byte descriptor
    for <span 
class="aeti-10">status</span>.
    </li>
    <li class="itemize">For SCSI commands there are additional constraints. <span 
class="aeti-10">sense </span>MUST reside
    in  a  single  separate  device-writable  descriptor  of  size  96  bytes,  and
    <span 
class="aeti-10">errors</span>, <span 
class="aeti-10">data_len</span>, <span 
class="aeti-10">sense_len  </span>and <span 
class="aeti-10">residual  </span>MUST reside a single separate
    device-writable descriptor.</li></ul>
<!--l. 5301--><p class="noindent" >See <a 
href="#x1-390004">2.7.4<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Message Framing --></a>.
<a 
 id="x1-293001r284"></a>
<h3 class="sectionHead"><span class="titlemark">5.3   </span> <a 
 id="x1-2940003"></a>Console Device</h3>
<!--l. 5305--><p class="nopar" >The virtio console device is a simple device for data input and output. A
device MAY have one or more ports. Each port has a pair of input and
output virtqueues. Moreover, a device has a pair of control IO virtqueues. The
control virtqueues are used to communicate information between the device
and the driver about ports being opened and closed on either side of the
connection, indication from the device about whether a particular port is a console
port, adding new ports, port hot-plug/unplug, etc., and indication from
the driver about whether a port or a device was successfully added, port
open/close, etc. For data IO, one or more empty buffers are placed in the receive
queue for incoming data and outgoing characters are placed in the transmit
queue.
<a 
 id="x1-294001r295"></a>
<h4 class="subsectionHead"><span class="titlemark">5.3.1   </span> <a 
 id="x1-2950001"></a>Device ID</h4>
<!--l. 5320--><p class="nopar" >3
<a 
 id="x1-295001r301"></a>
<h4 class="subsectionHead"><span class="titlemark">5.3.2   </span> <a 
 id="x1-2960002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">receiveq(port0)
    </dd><dt class="description">
<span 
class="aeb10-">1</span> </dt><dd 
class="description">transmitq(port0)
    </dd><dt class="description">
<span 
class="aeb10-">2</span> </dt><dd 
class="description">control receiveq
    </dd><dt class="description">
<span 
class="aeb10-">3</span> </dt><dd 
class="description">control transmitq
    </dd><dt class="description">
<span 
class="aeb10-">4</span> </dt><dd 
class="description">receiveq(port1)
    </dd><dt class="description">
                                                                  

                                                                  
<span 
class="aeb10-">5</span> </dt><dd 
class="description">transmitq(port1)
    </dd><dt class="description">
<span 
class="aeb10-">…</span> </dt><dd 
class="description"></dd></dl>
<!--l. 5334--><p class="nopar" >The port 0 receive and transmit queues always exist: other queues only exist if
VIRTIO_CONSOLE_F_MULTIPORT is set.
<a 
 id="x1-296001r302"></a>
<h4 class="subsectionHead"><span class="titlemark">5.3.3   </span> <a 
 id="x1-2970003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_CONSOLE_F_SIZE (0)</span> </dt><dd 
class="description">Configuration <span 
class="aeti-10">cols </span>and <span 
class="aeti-10">rows </span>are valid.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_CONSOLE_F_MULTIPORT (1)</span> </dt><dd 
class="description">Device   has   support   for   multiple
    ports; <span 
class="aeti-10">max_nr_ports </span>is valid and control virtqueues will be used.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_CONSOLE_F_EMERG_WRITE (2)</span> </dt><dd 
class="description">Device     has     support     for
    emergency write. Configuration field emerg_wr is valid.</dd></dl>
<a 
 id="x1-297001r303"></a>
<h4 class="subsectionHead"><span class="titlemark">5.3.4   </span> <a 
 id="x1-2980004"></a>Device configuration layout</h4>
<!--l. 5352--><p class="nopar" >The size of the console is supplied in the configuration space if
the VIRTIO_CONSOLE_F_SIZE feature is set. Furthermore, if the
VIRTIO_CONSOLE_F_MULTIPORT feature is set, the maximum number of ports
supported by the device can be fetched.
<!--l. 5358--><p class="noindent" >If VIRTIO_CONSOLE_F_EMERG_WRITE is set then the driver can use emergency
write to output a single character without initializing virtio queues, or even
acknowledging the feature.
<!--l. 5362-->
<div class="lstlisting" id="listing-80"><span class="label"><a 
 id="x1-298001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_console_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-298002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cols</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-298003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rows</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-298004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_nr_ports</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-298005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">emerg_wr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-298006r6"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-298007r299"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.3.4.1   </span> <a 
 id="x1-2990001"></a>Legacy Interface: Device configuration layout</h5>
<!--l. 5372--><p class="nopar" >When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_console_config according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<a 
 id="x1-299001r304"></a>
<h4 class="subsectionHead"><span class="titlemark">5.3.5   </span> <a 
 id="x1-3000005"></a>Device Initialization</h4>
    <ol  class="enumerate1" >
                                                                  

                                                                  
    <li 
  class="enumerate" id="x1-300002x1">If         the         VIRTIO_CONSOLE_F_EMERG_WRITE         feature
    is offered, <span 
class="aeti-10">emerg_wr </span>field of the configuration can be written at any time.
    Thus it works for very early boot debugging output as well as catastophic
    OS failures (eg. virtio ring corruption).
    </li>
    <li 
  class="enumerate" id="x1-300004x2">If the VIRTIO_CONSOLE_F_SIZE feature is negotiated, the driver can
    read the console dimensions from <span 
class="aeti-10">cols </span>and <span 
class="aeti-10">rows</span>.
    </li>
    <li 
  class="enumerate" id="x1-300006x3">If  the  VIRTIO_CONSOLE_F_MULTIPORT  feature  is  negotiated,  the
    driver can spawn multiple ports, not all of which are necessarily attached to
    a console. Some could be generic ports. In this case, the control virtqueues
    are enabled and according to <span 
class="aeti-10">max_nr_ports</span>, the appropriate number of
    virtqueues are created. A control message indicating the driver is ready
    is  sent  to  the  device.  The  device  can  then  send  control  messages  for
    adding new ports to the device. After creating and initializing each port, a
    VIRTIO_CONSOLE_PORT_READY control message is sent to the device
    for  that  port  so  the  device  can  let  the  driver  know  of  any  additional
    configuration options set for that port.
    </li>
    <li 
  class="enumerate" id="x1-300008x4">The receiveq for each port is populated with one or more receive buffers.</li></ol>
<a 
 id="x1-300009r305"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.3.5.1   </span> <a 
 id="x1-3010001"></a>Device Requirements: Device Initialization</h5>
<!--l. 5407--><p class="nopar" >The device MUST allow a write to <span 
class="aeti-10">emerg_wr</span>, even on an unconfigured device.
<!--l. 5410--><p class="noindent" >The device SHOULD transmit the lower byte written to <span 
class="aeti-10">emerg_wr </span>to an appropriate
log or output method.
<a 
 id="x1-301001r306"></a>
<h4 class="subsectionHead"><span class="titlemark">5.3.6   </span> <a 
 id="x1-3020006"></a>Device Operation</h4>
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-302002x1">For output, a buffer containing the characters is placed in the port’s transmitq<span class="footnote-mark"><a 
href="#fn13x5" id="fn13x5-bk"><sup class="textsuperscript">13</sup></a></span><a 
 id="x1-302003f13"></a>.
    </li>
    <li 
  class="enumerate" id="x1-302005x2">When  a  buffer  is  used  in  the  receiveq  (signalled  by  a  used  buffer
    notification), the contents is the input to the port associated with the
    virtqueue for which the notification was received.
    </li>
    <li 
  class="enumerate" id="x1-302007x3">If  the  driver  negotiated  the  VIRTIO_CONSOLE_F_SIZE  feature,  a
    configuration change notification indicates that the updated size can be
    read from the configuration fields. This size applies to port 0 only.
    </li>
    <li 
  class="enumerate" id="x1-302009x4">If the driver negotiated the VIRTIO_CONSOLE_F_MULTIPORT feature,
    active      ports      are      announced      by      the      device      using
                                                                  

                                                                  
    the VIRTIO_CONSOLE_PORT_ADD control message. The same message
    is used for port hot-plug as well.</li></ol>
<a 
 id="x1-302010r307"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.3.6.1   </span> <a 
 id="x1-3030001"></a>Driver Requirements: Device Operation</h5>
<!--l. 5442--><p class="nopar" >The driver MUST NOT put a device-readable buffer in a receiveq. The driver MUST
NOT put a device-writable buffer in a transmitq.
<a 
 id="x1-303001r309"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.3.6.2   </span> <a 
 id="x1-3040002"></a>Multiport Device Operation</h5>
<!--l. 5447--><p class="nopar" >If the driver negotiated the VIRTIO_CONSOLE_F_MULTIPORT, the two control
queues are used to manipulate the different console ports: the control receiveq for
messages from the device to the driver, and the control sendq for driver-to-device
messages. The layout of the control messages is:
<!--l. 5453-->
<div class="lstlisting" id="listing-81"><span class="label"><a 
 id="x1-304001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_console_control</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-304002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Port</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">number</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-304003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">kind</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">control</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-304004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">value</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Extra</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">information</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-304005r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 5461--><p class="noindent" >The values for <span 
class="aeti-10">event </span>are:
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_CONSOLE_DEVICE_READY (0)</span> </dt><dd 
class="description">Sent by the driver at initialization
    to indicate that it is ready to receive control messages. A value of 1 indicates
    success, and 0 indicates failure. The port number <span 
class="aeti-10">id </span>is unused.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_CONSOLE_DEVICE_ADD (1)</span> </dt><dd 
class="description">Sent by the device, to create a new
    port. <span 
class="aeti-10">value </span>is unused.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_CONSOLE_DEVICE_REMOVE (2)</span> </dt><dd 
class="description">Sent by the device, to remove an
    existing port. <span 
class="aeti-10">value </span>is unused.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_CONSOLE_PORT_READY (3)</span> </dt><dd 
class="description">Sent by the driver in response to the
    device’s VIRTIO_CONSOLE_PORT_ADD message, to indicate that the
    port is ready to be used. A <span 
class="aeti-10">value </span>of 1 indicates success, and 0 indicates
    failure.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_CONSOLE_CONSOLE_PORT (4)</span> </dt><dd 
class="description">Sent by the device to nominate a
    port as a console port. There MAY be more than one console port.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_CONSOLE_RESIZE (5)</span> </dt><dd 
class="description">Sent by the device to indicate a console size
    change. <span 
class="aeti-10">value </span>is unused. The buffer is followed by the number of columns and
    rows: <!--l. 5478-->
                                                                  

                                                                  
    <div class="lstlisting" id="listing-82"><span class="label"><a 
 id="x1-304006r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_console_resize</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-304007r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cols</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-304008r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rows</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-304009r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_CONSOLE_PORT_OPEN (6)</span> </dt><dd 
class="description">This message is sent by both the device and
    the driver. <span 
class="aeti-10">value </span>indicates the state: 0 (port closed) or 1 (port open). This allows
    for ports to be used directly by guest and host processes to communicate in an
    application-defined manner.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_CONSOLE_PORT_NAME (7)</span> </dt><dd 
class="description">Sent by the device to give a tag to the
    port. This control command is immediately followed by the UTF-8
    name of the port for identification within the guest (without a NUL
    terminator).</dd></dl>
<a 
 id="x1-304010r279"></a>
<h5 class="paragraphHead"><span class="titlemark">5.3.6.2.1</span> <a 
 id="x1-3050001"></a>Device Requirements: Multiport Device Operation</h5>
The device MUST NOT specify a port which exists in a VIRTIO_CONSOLE_DEVICE_ADD
message, nor a port which is equal or greater than <span 
class="aeti-10">max_nr_ports</span>.
<!--l. 5501--><p class="noindent" >The device MUST NOT specify a port in VIRTIO_CONSOLE_DEVICE_REMOVE
which has not been created with a previous VIRTIO_CONSOLE_DEVICE_ADD.
<a 
 id="x1-305001r311"></a>
<h5 class="paragraphHead"><span class="titlemark">5.3.6.2.2</span> <a 
 id="x1-3060002"></a>Driver Requirements: Multiport Device Operation</h5>
The driver MUST send a VIRTIO_CONSOLE_DEVICE_READY message if
VIRTIO_CONSOLE_F_MULTIPORT is negotiated.
<!--l. 5509--><p class="noindent" >Upon receipt of a VIRTIO_CONSOLE_CONSOLE_PORT message, the driver
SHOULD treat the port in a manner suitable for text console access and MUST
respond with a VIRTIO_CONSOLE_PORT_OPEN message, which MUST have <span 
class="aeti-10">value</span>
set to 1.
<a 
 id="x1-306001r310"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.3.6.3   </span> <a 
 id="x1-3070003"></a>Legacy Interface: Device Operation</h5>
<!--l. 5515--><p class="nopar" >When using the legacy interface, transitional devices and drivers MUST format
the fields in struct virtio_console_control according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<!--l. 5520--><p class="noindent" >When using the legacy interface, the driver SHOULD ignore the used length values
for the transmit queues and the control transmitq.
<span 
class="aeb10-">Note:</span> Historically,  some  devices  put  the  total  descriptor  length  there,  even
      though no data was actually written.
                                                                  

                                                                  
<a 
 id="x1-307001r313"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.3.6.4   </span> <a 
 id="x1-3080004"></a>Legacy Interface: Framing Requirements</h5>
<!--l. 5531--><p class="nopar" >When using legacy interfaces, transitional drivers which have not negotiated
VIRTIO_F_ANY_LAYOUT MUST use only a single descriptor for all buffers in the
control receiveq and control transmitq.
<a 
 id="x1-308001r300"></a>
<h3 class="sectionHead"><span class="titlemark">5.4   </span> <a 
 id="x1-3090004"></a>Entropy Device</h3>
<!--l. 5537--><p class="nopar" >The virtio entropy device supplies high-quality randomness for guest use.
<a 
 id="x1-309001r308"></a>
<h4 class="subsectionHead"><span class="titlemark">5.4.1   </span> <a 
 id="x1-3100001"></a>Device ID</h4>
<!--l. 5541--><p class="nopar" >4
<a 
 id="x1-310001r316"></a>
<h4 class="subsectionHead"><span class="titlemark">5.4.2   </span> <a 
 id="x1-3110002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">requestq</dd></dl>
<a 
 id="x1-311001r317"></a>
<h4 class="subsectionHead"><span class="titlemark">5.4.3   </span> <a 
 id="x1-3120003"></a>Feature bits</h4>
<!--l. 5549--><p class="nopar" >None currently defined
<a 
 id="x1-312001r318"></a>
<h4 class="subsectionHead"><span class="titlemark">5.4.4   </span> <a 
 id="x1-3130004"></a>Device configuration layout</h4>
<!--l. 5552--><p class="nopar" >None currently defined.
<a 
 id="x1-313001r319"></a>
<h4 class="subsectionHead"><span class="titlemark">5.4.5   </span> <a 
 id="x1-3140005"></a>Device Initialization</h4>
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-314002x1">The virtqueue is initialized</li></ol>
<a 
 id="x1-314003r320"></a>
<h4 class="subsectionHead"><span class="titlemark">5.4.6   </span> <a 
 id="x1-3150006"></a>Device Operation</h4>
<!--l. 5562--><p class="nopar" >When the driver requires random bytes, it places the descriptor of one or more
buffers in the queue. It will be completely filled by random data by the
device.
<a 
 id="x1-315001r314"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.4.6.1   </span> <a 
 id="x1-3160001"></a>Driver Requirements: Device Operation</h5>
<!--l. 5568--><p class="nopar" >The driver MUST NOT place device-readable buffers into the queue.
<!--l. 5570--><p class="noindent" >The driver MUST examine the length written by the device to determine how many
random bytes were received.
                                                                  

                                                                  
<a 
 id="x1-316001r322"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.4.6.2   </span> <a 
 id="x1-3170002"></a>Device Requirements: Device Operation</h5>
<!--l. 5575--><p class="nopar" >The device MUST place one or more random bytes into the buffer, but it MAY use
less than the entire buffer length.
<a 
 id="x1-317001r315"></a>
<h3 class="sectionHead"><span class="titlemark">5.5   </span> <a 
 id="x1-3180005"></a>Traditional Memory Balloon Device</h3>
<!--l. 5580--><p class="nopar" >This is the traditional balloon device. The device number 13 is reserved for a new
memory balloon interface, with different semantics, which is expected in a future
version of the standard.
<!--l. 5584--><p class="noindent" >The traditional virtio memory balloon device is a primitive device for managing guest
memory: the device asks for a certain amount of memory, and the driver supplies it
(or withdraws it, if the device has more than it asks for). This allows the guest to
adapt to changes in allowance of underlying physical memory. If the feature is
negotiated, the device can also be used to communicate guest memory statistics to
the host.
<a 
 id="x1-318001r321"></a>
<h4 class="subsectionHead"><span class="titlemark">5.5.1   </span> <a 
 id="x1-3190001"></a>Device ID</h4>
<!--l. 5593--><p class="nopar" >5
<a 
 id="x1-319001r325"></a>
<h4 class="subsectionHead"><span class="titlemark">5.5.2   </span> <a 
 id="x1-3200002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">inflateq
    </dd><dt class="description">
<span 
class="aeb10-">1</span> </dt><dd 
class="description">deflateq
    </dd><dt class="description">
<span 
class="aeb10-">2</span> </dt><dd 
class="description">statsq
    </dd><dt class="description">
<span 
class="aeb10-">3</span> </dt><dd 
class="description">free_page_vq
    </dd><dt class="description">
<span 
class="aeb10-">4</span> </dt><dd 
class="description">reporting_vq</dd></dl>
<!--l. 5604--><p class="nopar" >statsq only exists if VIRTIO_BALLOON_F_STATS_VQ is set.
<!--l. 5606--><p class="noindent" >free_page_vq only exists if VIRTIO_BALLOON_F_FREE_PAGE_HINT is
set.
<!--l. 5608--><p class="noindent" >reporting_vq only exists if VIRTIO_BALLOON_F_PAGE_REPORTING is
set.
<a 
 id="x1-320001r326"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">5.5.3   </span> <a 
 id="x1-3210003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_BALLOON_F_MUST_TELL_HOST (0)</span> </dt><dd 
class="description">Host  has  to  be  told  before
    pages from the balloon are used.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BALLOON_F_STATS_VQ (1)</span> </dt><dd 
class="description">A   virtqueue   for   reporting   guest
    memory statistics is present.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BALLOON_F_DEFLATE_ON_OOM (2)</span>  </dt><dd 
class="description">Deflate balloon on guest out
    of memory condition.
    </dd><dt class="description">
 <span 
class="aeb10-">VIRTIO_BALLOON_F_FREE_PAGE_HINT(3)</span>  </dt><dd 
class="description">The  device  has  support  for
    free page hinting. A virtqueue for providing hints as to what memory is
    currently free is present. Configuration field <span 
class="aeti-10">free_page_hint_cmd_id </span>is valid.
    </dd><dt class="description">
 <span 
class="aeb10-">VIRTIO_BALLOON_F_PAGE_POISON(4)</span>  </dt><dd 
class="description">A  hint  to  the  device,  that  the
    driver  will  immediately  write  <span 
class="aeti-10">poison_val  </span>to  pages  after  deflating  them.
    Configuration field <span 
class="aeti-10">poison_val </span>is valid.
    </dd><dt class="description">
 <span 
class="aeb10-">VIRTIO_BALLOON_F_PAGE_REPORTING(5)</span>  </dt><dd 
class="description">The device has support for
    free page reporting. A virtqueue for reporting free guest memory is present.
    </dd></dl>
<a 
 id="x1-321001r323"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.5.3.1   </span> <a 
 id="x1-3220001"></a>Driver Requirements: Feature bits</h5>
<!--l. 5632--><p class="nopar" >The driver SHOULD accept the VIRTIO_BALLOON_F_MUST_TELL_HOST feature
if offered by the device.
<!--l. 5635--><p class="noindent" >The driver SHOULD clear the VIRTIO_BALLOON_F_PAGE_POISON flag if it will
not immediately write <span 
class="aeti-10">poison_val </span>to deflated pages (e.g., to initialize them, or fill
them with a poison value).
<!--l. 5639--><p class="noindent" >If the driver is expecting the pages to retain some initialized value, it MUST NOT
accept VIRTIO_BALLOON_F_PAGE_REPORTING unless it also negotiates
VIRTIO_BALLOON_F_PAGE_POISON.
<a 
 id="x1-322001r328"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.5.3.2   </span> <a 
 id="x1-3230002"></a>Device Requirements: Feature bits</h5>
<!--l. 5644--><p class="nopar" >If the device offers the VIRTIO_BALLOON_F_MUST_TELL_HOST feature bit, and
if the driver did not accept this feature bit, the device MAY signal failure
by failing to set FEATURES_OK <span 
class="aeti-10">device status </span>bit when the driver writes
it.
<a 
 id="x1-323001r282"></a>
                                                                  

                                                                  
<h6 class="subparagraphHead"><span class="titlemark">5.5.3.2.0.1</span> <a 
 id="x1-3240001"></a>Legacy Interface: Feature bits</h6>
As the legacy interface does not have a way to gracefully report feature negotiation
failure, when using the legacy interface, transitional devices MUST support
guests which do not negotiate VIRTIO_BALLOON_F_MUST_TELL_HOST
feature, and SHOULD allow guest to use memory before notifying host if
VIRTIO_BALLOON_F_MUST_TELL_HOST is not negotiated.
<a 
 id="x1-324001r327"></a>
<h4 class="subsectionHead"><span class="titlemark">5.5.4   </span> <a 
 id="x1-3250004"></a>Device configuration layout</h4>
<!--l. 5659--><p class="nopar" ><span 
class="aeti-10">num_pages </span>and <span 
class="aeti-10">actual </span>are always available.
<!--l. 5661--><p class="noindent" ><span 
class="aeti-10">free_page_hint_cmd_id </span>is available if VIRTIO_BALLOON_F_FREE_PAGE_HINT has
been negotiated. The field is read-only by the driver. <span 
class="aeti-10">poison_val </span>is available if
VIRTIO_BALLOON_F_PAGE_POISON has been negotiated.
<!--l. 5667-->
<div class="lstlisting" id="listing-83"><span class="label"><a 
 id="x1-325001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_balloon_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-325002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_pages</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-325003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">actual</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-325004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">free_page_hint_cmd_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-325005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">poison_val</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-325006r6"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-325007r330"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.5.4.0.0.1</span> <a 
 id="x1-3260001"></a>Legacy Interface: Device configuration layout</h6>
When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_balloon_config according to the little-endian
format.
<span 
class="aeb10-">Note:</span> This is unlike the usual convention that legacy device fields are guest
      endian.
<a 
 id="x1-326001r331"></a>
<h4 class="subsectionHead"><span class="titlemark">5.5.5   </span> <a 
 id="x1-3270005"></a>Device Initialization</h4>
<!--l. 5687--><p class="nopar" >The device initialization process is outlined below:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-327002x1">The inflate and deflate virtqueues are identified.
    </li>
    <li 
  class="enumerate" id="x1-327004x2">If the VIRTIO_BALLOON_F_STATS_VQ feature bit is negotiated:
        <ol  class="enumerate2" >
        <li 
  class="enumerate" id="x1-327006x1">Identify the stats virtqueue.
        </li>
        <li 
  class="enumerate" id="x1-327008x2">Add one empty buffer to the stats virtqueue.</li></ol>
    </li>
                                                                  

                                                                  
    <li 
  class="enumerate" id="x1-327010x3">If the VIRTIO_BALLOON_F_FREE_PAGE_HINT feature bit is negotiated,
    identify the free_page_vq.
    </li>
    <li 
  class="enumerate" id="x1-327012x4">If the VIRTIO_BALLOON_F_PAGE_POISON feature bit is negotiated, update
    the <span 
class="aeti-10">poison_val </span>configuration field.
    </li>
    <li 
  class="enumerate" id="x1-327014x5">If the VIRTIO_BALLOON_F_PAGE_REPORTING feature bit is negotiated,
    identify the reporting_vq.
    </li>
    <li 
  class="enumerate" id="x1-327016x6">DRIVER_OK is set: device operation begins.
    </li>
    <li 
  class="enumerate" id="x1-327018x7">If the VIRTIO_BALLOON_F_STATS_VQ feature bit is negotiated, then notify
    the device about the stats virtqueue buffer.
    </li>
    <li 
  class="enumerate" id="x1-327020x8">If the VIRTIO_BALLOON_F_PAGE_REPORTING feature bit is negotiated,
    then begin reporting free pages to the device.</li></ol>
<a 
 id="x1-327021r333"></a>
<h4 class="subsectionHead"><span class="titlemark">5.5.6   </span> <a 
 id="x1-3280006"></a>Device Operation</h4>
<!--l. 5715--><p class="nopar" >The device is driven either by the receipt of a configuration change notification, or by
changing guest memory needs, such as performing memory compaction or responding
to out of memory conditions.
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-328002x1"><span 
class="aeti-10">num_pages </span>configuration field is examined. If this is greater than the <span 
class="aeti-10">actual</span>
    number of pages, the balloon wants more memory from the guest. If it is
    less than <span 
class="aeti-10">actual</span>, the balloon doesn’t need it all.
    </li>
    <li 
  class="enumerate" id="x1-328004x2">To supply memory to the balloon (aka. inflate):
        <ol  class="enumerate2" >
        <li 
  class="enumerate" id="x1-328006x1">The driver constructs an array of addresses of unused memory pages.
        These addresses are divided by 4096<span class="footnote-mark"><a 
href="#fn14x5" id="fn14x5-bk"><sup class="textsuperscript">14</sup></a></span><a 
 id="x1-328007f14"></a>
        and the descriptor describing the resulting 32-bit array is added to the
        inflateq.</li></ol>
    </li>
    <li 
  class="enumerate" id="x1-328009x3">To remove memory from the balloon (aka. deflate):
        <ol  class="enumerate2" >
        <li 
  class="enumerate" id="x1-328011x1">The driver constructs an array of addresses of memory pages it has
        previously given to the balloon, as described above. This descriptor is
        added to the deflateq.
        </li>
                                                                  

                                                                  
        <li 
  class="enumerate" id="x1-328013x2">If    the    VIRTIO_BALLOON_F_MUST_TELL_HOST    feature    is
        negotiated, the guest informs the device of pages before it uses them.
        </li>
        <li 
  class="enumerate" id="x1-328015x3">Otherwise, the guest is allowed to re-use pages previously given to the
        balloon before the device has acknowledged their withdrawal<span class="footnote-mark"><a 
href="#fn15x5" id="fn15x5-bk"><sup class="textsuperscript">15</sup></a></span><a 
 id="x1-328016f15"></a>.</li></ol>
    </li>
    <li 
  class="enumerate" id="x1-328018x4">In either case, the device acknowledges inflate and deflate requests by using the
    descriptor.
    </li>
    <li 
  class="enumerate" id="x1-328020x5">Once the device has acknowledged the inflation or deflation, the driver updates
    <span 
class="aeti-10">actual </span>to reflect the new number of pages in the balloon.</li></ol>
<a 
 id="x1-328021r329"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.5.6.1   </span> <a 
 id="x1-3290001"></a>Driver Requirements: Device Operation</h5>
<!--l. 5756--><p class="nopar" >The driver SHOULD supply pages to the balloon when <span 
class="aeti-10">num_pages </span>is greater than the
actual number of pages in the balloon.
<!--l. 5759--><p class="noindent" >The driver MAY use pages from the balloon when <span 
class="aeti-10">num_pages </span>is less than the actual
number of pages in the balloon.
<!--l. 5762--><p class="noindent" >The driver MAY supply pages to the balloon when <span 
class="aeti-10">num_pages </span>is greater than or
equal to the actual number of pages in the balloon.
<!--l. 5765--><p class="noindent" >If VIRTIO_BALLOON_F_DEFLATE_ON_OOM has not been negotiated, the driver
MUST NOT use pages from the balloon when <span 
class="aeti-10">num_pages </span>is less than or equal to the
actual number of pages in the balloon.
<!--l. 5770--><p class="noindent" >If VIRTIO_BALLOON_F_DEFLATE_ON_OOM has been negotiated, the
driver MAY use pages from the balloon when <span 
class="aeti-10">num_pages </span>is less than or
equal to the actual number of pages in the balloon if this is required for
system stability (e.g. if memory is required by applications running within the
guest).
<!--l. 5777--><p class="noindent" >The driver MUST use the deflateq to inform the device of pages that it wants to use
from the balloon.
<!--l. 5780--><p class="noindent" >If the VIRTIO_BALLOON_F_MUST_TELL_HOST feature is negotiated, the driver
MUST NOT use pages from the balloon until the device has acknowledged the deflate
request.
<!--l. 5784--><p class="noindent" >Otherwise, if the VIRTIO_BALLOON_F_MUST_TELL_HOST feature is not
negotiated, the driver MAY begin to re-use pages previously given to the balloon
before the device has acknowledged the deflate request.
<!--l. 5789--><p class="noindent" >In any case, the driver MUST NOT use pages from the balloon after adding the
pages to the balloon, but before the device has acknowledged the inflate
request.
                                                                  

                                                                  
<!--l. 5793--><p class="noindent" >The driver MUST NOT request deflation of pages in the balloon before the device
has acknowledged the inflate request.
<!--l. 5797--><p class="noindent" >The driver MUST update <span 
class="aeti-10">actual </span>after changing the number of pages in the
balloon.
<!--l. 5800--><p class="noindent" >The driver MAY update <span 
class="aeti-10">actual </span>once after multiple inflate and deflate operations.
<a 
 id="x1-329001r335"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.5.6.2   </span> <a 
 id="x1-3300002"></a>Device Requirements: Device Operation</h5>
<!--l. 5805--><p class="nopar" >The device MAY modify the contents of a page in the balloon after detecting its
physical number in an inflate request and before acknowledging the inflate request by
using the inflateq descriptor.
<!--l. 5810--><p class="noindent" >If the VIRTIO_BALLOON_F_MUST_TELL_HOST feature is negotiated, the device
MAY modify the contents of a page in the balloon after detecting its physical number
in an inflate request and before detecting its physical number in a deflate request and
acknowledging the deflate request.
<a 
 id="x1-330001r312"></a>
<h5 class="paragraphHead"><span class="titlemark">5.5.6.2.1</span> <a 
 id="x1-3310001"></a>Legacy Interface: Device Operation</h5>
When using the legacy interface, the driver SHOULD ignore the used length
values.
<span 
class="aeb10-">Note:</span> Historically,  some  devices  put  the  total  descriptor  length  there,  even
      though no data was actually written.
<!--l. 5825--><p class="nopar" >When using the legacy interface, the driver MUST write out all 4 bytes each time it
updates the <span 
class="aeti-10">actual </span>value in the configuration space, using a single atomic
operation.
<!--l. 5829--><p class="noindent" >When using the legacy interface, the device SHOULD NOT use the <span 
class="aeti-10">actual </span>value
written by the driver in the configuration space, until the last, most-significant byte
of the value has been written.
<span 
class="aeb10-">Note:</span> Historically, devices used the <span 
class="aeti-10">actual </span>value, even though when using Virtio
      Over PCI Bus the device-specific configuration space was not guaranteed
      to be atomic. Using intermediate values during update by driver is best
      avoided, except for debugging.
      <!--l. 5840--><p class="noindent" >Historically, drivers using Virtio Over PCI Bus wrote the <span 
class="aeti-10">actual </span>value
      by using multiple single-byte writes in order, from the least-significant to
      the most-significant value.
<a 
 id="x1-331001r336"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.5.6.3   </span> <a 
 id="x1-3320003"></a>Memory Statistics</h5>
<!--l. 5846--><p class="nopar" >The stats virtqueue is atypical because communication is driven by the device (not
                                                                  

                                                                  
the driver). The channel becomes active at driver initialization time when the driver
adds an empty buffer and notifies the device. A request for memory statistics
proceeds as follows:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-332002x1">The device uses the buffer and sends a used buffer notification.
    </li>
    <li 
  class="enumerate" id="x1-332004x2">The driver pops the used buffer and discards it.
    </li>
    <li 
  class="enumerate" id="x1-332006x3">The driver collects memory statistics and writes them into a new buffer.
    </li>
    <li 
  class="enumerate" id="x1-332008x4">The driver adds the buffer to the virtqueue and notifies the device.
    </li>
    <li 
  class="enumerate" id="x1-332010x5">The device pops the buffer (retaining it to initiate a subsequent request)
    and consumes the statistics.</li></ol>
<!--l. 5867--><p class="noindent" >Within the buffer, statistics are an array of 10-byte entries. Each statistic consists of
a 16 bit tag and a 64 bit value. All statistics are optional and the driver chooses
which ones to supply. To guarantee backwards compatibility, devices omit
unsupported statistics.
<!--l. 5873-->
<div class="lstlisting" id="listing-84"><span class="label"><a 
 id="x1-332011r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_balloon_stat</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-332012r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_SWAP_IN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-332013r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_SWAP_OUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-332014r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_MAJFLT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-332015r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_MINFLT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-332016r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_MEMFREE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-332017r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_MEMTOT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-332018r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_AVAIL</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-332019r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_CACHES</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-332020r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_HTLB_PGALLOC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-332021r11"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_BALLOON_S_HTLB_PGFAIL</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-332022r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tag</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-332023r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">val</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-332024r14"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">__attribute__</span><span 
class="pcrr8t-x-x-80">((</span><span 
class="pcrr8t-x-x-80">packed</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span>
</div>
<a 
 id="x1-332025r337"></a>
<h5 class="paragraphHead"><span class="titlemark">5.5.6.3.1</span> <a 
 id="x1-3330001"></a>Driver Requirements: Memory Statistics</h5>
Normative statements in this section apply if and only if the
VIRTIO_BALLOON_F_STATS_VQ feature has been negotiated.
<!--l. 5894--><p class="noindent" >The driver MUST make at most one buffer available to the device in the statsq, at all
times.
<!--l. 5897--><p class="noindent" >After initializing the device, the driver MUST make an output buffer available in the
statsq.
<!--l. 5900--><p class="noindent" >Upon detecting that device has used a buffer in the statsq, the driver MUST make an
output buffer available in the statsq.
<!--l. 5903--><p class="noindent" >Before making an output buffer available in the statsq, the driver MUST initialize
it, including one struct virtio_balloon_stat entry for each statistic that it
supports.
<!--l. 5907--><p class="noindent" >Driver MUST use an output buffer size which is a multiple of 6 bytes for all buffers
submitted to the statsq.
                                                                  

                                                                  
<!--l. 5910--><p class="noindent" >Driver MAY supply struct virtio_balloon_stat entries in the output buffer submitted
to the statsq in any order, without regard to <span 
class="aeti-10">tag </span>values.
<!--l. 5914--><p class="noindent" >Driver MAY supply a subset of all statistics in the output buffer submitted to the
statsq.
<!--l. 5917--><p class="noindent" >Driver MUST supply the same subset of statistics in all buffers submitted to the
statsq.
<a 
 id="x1-333001r339"></a>
<h5 class="paragraphHead"><span class="titlemark">5.5.6.3.2</span> <a 
 id="x1-3340002"></a>Device Requirements: Memory Statistics</h5>
Normative statements in this section apply if and only if the
VIRTIO_BALLOON_F_STATS_VQ feature has been negotiated.
<!--l. 5924--><p class="noindent" >Within an output buffer submitted to the statsq, the device MUST ignore entries
with <span 
class="aeti-10">tag </span>values that it does not recognize.
<!--l. 5927--><p class="noindent" >Within an output buffer submitted to the statsq, the device MUST accept struct
virtio_balloon_stat entries in any order without regard to <span 
class="aeti-10">tag </span>values.
<a 
 id="x1-334001r340"></a>
<h5 class="paragraphHead"><span class="titlemark">5.5.6.3.3</span> <a 
 id="x1-3350003"></a>Legacy Interface: Memory Statistics</h5>
When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_balloon_stat according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<!--l. 5938--><p class="noindent" >When using the legacy interface, the device SHOULD ignore all values in the first
buffer in the statsq supplied by the driver after device initialization.
<span 
class="aeb10-">Note:</span> Historically, drivers supplied an uninitialized buffer in the first buffer.
<a 
 id="x1-335001r338"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.5.6.4   </span> <a 
 id="x1-3360004"></a>Memory Statistics Tags</h5>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_BALLOON_S_SWAP_IN (0)</span> </dt><dd 
class="description">The amount of memory that has been
    swapped in (in bytes).
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BALLOON_S_SWAP_OUT (1)</span> </dt><dd 
class="description">The amount of memory that has been
    swapped out to disk (in bytes).
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BALLOON_S_MAJFLT (2)</span> </dt><dd 
class="description">The  number  of  major  page  faults  that
    have occurred.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BALLOON_S_MINFLT (3)</span> </dt><dd 
class="description">The  number  of  minor  page  faults  that
                                                                  

                                                                  
    have occurred.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BALLOON_S_MEMFREE (4)</span> </dt><dd 
class="description">The amount of memory not being used
    for any purpose (in bytes).
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BALLOON_S_MEMTOT (5)</span> </dt><dd 
class="description">The total amount of memory available
    (in bytes).
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BALLOON_S_AVAIL (6)</span> </dt><dd 
class="description">An  estimate  of  how  much  memory  is
    available  (in  bytes)  for  starting  new  applications,  without  pushing  the
    system to swap.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BALLOON_S_CACHES (7)</span> </dt><dd 
class="description">The amount of memory, in bytes, that can
    be quickly reclaimed without additional I/O. Typically these pages are
    used for caching files from disk.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BALLOON_S_HTLB_PGALLOC (8)</span> </dt><dd 
class="description">The    number    of    successful
    hugetlb page allocations in the guest.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BALLOON_S_HTLB_PGFAIL (9)</span> </dt><dd 
class="description">The number of failed hugetlb page
    allocations in the guest.</dd></dl>
<a 
 id="x1-336001r342"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.5.6.5   </span> <a 
 id="x1-3370005"></a>Free Page Hinting</h5>
<!--l. 5983--><p class="nopar" >Free page hinting is designed to be used during migration to determine what
pages within the guest are currently unused so that they can be skipped
over while migrating the guest. The device will indicate that it is ready to
start performing hinting by setting the <span 
class="aeti-10">free_page_hint_cmd_id </span>to one of the
non-reserved values that can be used as a command ID. The following values are
reserved:
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_BALLOON_CMD_ID_STOP (0)</span> </dt><dd 
class="description">Any             command             ID
    previously supplied by the device is invalid. The driver should stop hinting
    free pages until a new command ID is supplied, but should not release any
    hinted pages for use by the guest.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_BALLOON_CMD_ID_DONE (1)</span> </dt><dd 
class="description">
    Any command ID previously supplied by the device is invalid. The driver
    should stop hinting free pages, and should release all hinted pages for use
    by the guest.</dd></dl>
<!--l. 6001--><p class="noindent" >When a hint is provided by the driver it indicates that the data contained in the
                                                                  

                                                                  
given page is no longer needed and can be discarded. If the driver writes to the
page this overrides the hint and the data will be retained. The contents of
any stale pages that have not been written to since the page was hinted
may be lost, and if read the contents of such pages will be uninitialized
memory.
<!--l. 6008--><p class="noindent" >A request for free page hinting proceeds as follows:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-337002x1">The  driver  examines  the  <span 
class="aeti-10">free_page_hint_cmd_id  </span>configuration  field.  If  it
    contains a non-reserved value then free page hinting will begin.
    </li>
    <li 
  class="enumerate" id="x1-337004x2">To supply free page hints:
        <ol  class="enumerate2" >
        <li 
  class="enumerate" id="x1-337006x1">The  driver  constructs  an  output  buffer  containing  the  new  value
        from the <span 
class="aeti-10">free_page_hint_cmd_id </span>configuration field and adds it to the
        free_page_vq.
        </li>
        <li 
  class="enumerate" id="x1-337008x2">The driver maps a series of pages and adds them to the free_page_vq
        as individual scatter-gather input buffer entries.
        </li>
        <li 
  class="enumerate" id="x1-337010x3">When the driver is no longer able to fetch additional pages to add
        to the free_page_vq, it will construct an output buffer containing the
        command ID VIRTIO_BALLOON_CMD_ID_STOP.</li></ol>
    </li>
    <li 
  class="enumerate" id="x1-337012x3">A round of hinting ends either when the driver is no longer able to
    supply more pages for hinting as described above, or when the device
    updates <span 
class="aeti-10">free_page_hint_cmd_id </span>configuration field to contain either
    VIRTIO_BALLOON_CMD_ID_STOP or VIRTIO_BALLOON_CMD_ID_DONE.
    </li>
    <li 
  class="enumerate" id="x1-337014x4">The device may follow VIRTIO_BALLOON_CMD_ID_STOP with a new
    non-reserved value for the <span 
class="aeti-10">free_page_hint_cmd_id </span>configuration field in which
    case it will resume supplying free page hints.
    </li>
    <li 
  class="enumerate" id="x1-337016x5">Otherwise, if the device provides VIRTIO_BALLOON_CMD_ID_DONE then
    hinting is complete and the driver may release all previously hinted pages for use
    by the guest.
    </li></ol>
<a 
 id="x1-337017r341"></a>
<h5 class="paragraphHead"><span class="titlemark">5.5.6.5.1</span> <a 
 id="x1-3380001"></a>Driver Requirements: Free Page Hinting</h5>
Normative statements in this section apply if the VIRTIO_BALLOON_F_FREE_PAGE_HINT
                                                                  

                                                                  
feature has been negotiated.
<!--l. 6047--><p class="noindent" >The driver MUST use an output buffer size of 4 bytes for all output buffers
submitted to the free_page_vq.
<!--l. 6050--><p class="noindent" >The driver MUST start hinting by providing an output buffer containing the current
command ID for the given block of pages.
<!--l. 6053--><p class="noindent" >The driver MUST NOT provide more than one output buffer containing the current
command ID.
<!--l. 6056--><p class="noindent" >The driver SHOULD supply pages to the free_page_vq as input buffers when
<span 
class="aeti-10">free_page_hint_cmd_id </span>specifies a value of 2 or greater.
<!--l. 6059--><p class="noindent" >The driver SHOULD stop supplying pages for hinting when <span 
class="aeti-10">free_page_hint_cmd_id </span>specifies
a value of VIRTIO_BALLOON_CMD_ID_STOP or VIRTIO_BALLOON_CMD_ID_DONE.
<!--l. 6063--><p class="noindent" >If the driver is unable to supply pages, it MUST complete hinting by adding an
output buffer containing the command ID VIRTIO_BALLOON_CMD_ID_STOP.
<!--l. 6066--><p class="noindent" >The driver MAY release hinted pages for use by the guest including when the device
has not yet used the descriptor containing the hinting request.
<!--l. 6069--><p class="noindent" >The driver MUST treat the content of all hinted pages as uninitialized memory.
<!--l. 6072--><p class="noindent" >The driver MUST initialize the contents of any previously hinted page released before
<span 
class="aeti-10">free_page_hint_cmd_id </span>specifies a value of VIRTIO_BALLOON_CMD_ID_DONE.
<!--l. 6076--><p class="noindent" >The driver SHOULD release all previously hinted pages once <span 
class="aeti-10">free_page_hint_cmd_id</span>
specifies a value of VIRTIO_BALLOON_CMD_ID_DONE.
<a 
 id="x1-338001r344"></a>
<h5 class="paragraphHead"><span class="titlemark">5.5.6.5.2</span> <a 
 id="x1-3390002"></a>Device Requirements: Free Page Hinting</h5>
Normative statements in this section apply if the VIRTIO_BALLOON_F_FREE_PAGE_HINT
feature has been negotiated.
<!--l. 6085--><p class="noindent" >The device SHOULD set <span 
class="aeti-10">free_page_hint_cmd_id </span>to VIRTIO_BALLOON_CMD_ID_STOP
any time that it will not be able to make use of the hints provided by the
driver.
<!--l. 6089--><p class="noindent" >The device MUST NOT reuse a command ID until it has received an output buffer
containing VIRTIO_BALLOON_CMD_ID_STOP from the driver.
<!--l. 6092--><p class="noindent" >The device MUST ignore pages that are provided with a command ID that does not
match the current value in <span 
class="aeti-10">free_page_hint_cmd_id</span>.
<!--l. 6095--><p class="noindent" >If the content of a previously hinted page has not been modified by the guest since
the device issued the <span 
class="aeti-10">free_page_hint_cmd_id </span>associated with the hint, the device MAY
modify the contents of the page.
<!--l. 6099--><p class="noindent" >The device MUST NOT modify the content of a previously hinted page after
<span 
class="aeti-10">free_page_hint_cmd_id </span>is set to VIRTIO_BALLOON_CMD_ID_DONE.
                                                                  

                                                                  
<!--l. 6102--><p class="noindent" >The device MUST report a value of VIRTIO_BALLOON_CMD_ID_DONE in
<span 
class="aeti-10">free_page_hint_cmd_id </span>when it no longer has need for the previously hinted
pages.
<a 
 id="x1-339001r345"></a>
<h5 class="paragraphHead"><span class="titlemark">5.5.6.5.3</span> <a 
 id="x1-3400003"></a>Legacy Interface: Free Page Hinting</h5>
When using the legacy interface, transitional devices and drivers MUST
format the command ID field in output buffers according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<a 
 id="x1-340001r343"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.5.6.6   </span> <a 
 id="x1-3410006"></a>Page Poison</h5>
<!--l. 6115--><p class="nopar" >Page Poison provides a way to notify the host that the guest is initializing free pages
with <span 
class="aeti-10">poison_val</span>. When the feature is enabled, pages will be immediately written to by
the driver after deflating, and pages reported by free page reporting will retain the
value indicated by <span 
class="aeti-10">poison_val</span>.
<!--l. 6120--><p class="noindent" >If the guest is not initializing freed pages, the driver should reject the
VIRTIO_BALLOON_F_PAGE_POISON feature.
<!--l. 6123--><p class="noindent" >If VIRTIO_BALLOON_F_PAGE_POISON feature has been negotiated, the
driver will place the initialization value into the <span 
class="aeti-10">poison_val </span>configuration field
data.
<a 
 id="x1-341001r346"></a>
<h5 class="paragraphHead"><span class="titlemark">5.5.6.6.1</span> <a 
 id="x1-3420001"></a>Driver Requirements: Page Poison</h5>
Normative statements in this section apply if the VIRTIO_BALLOON_F_PAGE_POISON
feature has been negotiated.
<!--l. 6132--><p class="noindent" >The driver MUST initialize the deflated pages with <span 
class="aeti-10">poison_val </span>when they are reused
by the driver.
<!--l. 6135--><p class="noindent" >The driver MUST populate the <span 
class="aeti-10">poison_val </span>configuration data before setting the
DRIVER_OK bit.
<!--l. 6138--><p class="noindent" >The driver MUST NOT modify <span 
class="aeti-10">poison_val </span>while the DRIVER_OK bit is
set.
<a 
 id="x1-342001r348"></a>
<h5 class="paragraphHead"><span class="titlemark">5.5.6.6.2</span> <a 
 id="x1-3430002"></a>Device Requirements: Page Poison</h5>
Normative statements in this section apply if the VIRTIO_BALLOON_F_PAGE_POISON
feature has been negotiated.
<!--l. 6145--><p class="noindent" >The device MAY use the content of <span 
class="aeti-10">poison_val </span>as a hint to guest behavior.
<a 
 id="x1-343001r347"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">5.5.6.7   </span> <a 
 id="x1-3440007"></a>Free Page Reporting</h5>
<!--l. 6150--><p class="nopar" >Free Page Reporting provides a mechanism similar to balloon inflation, however it
does not provide a deflation queue. Reported free pages can be reused by the driver
after the reporting request has been acknowledged without notifying the
device.
<!--l. 6155--><p class="noindent" >The driver will begin reporting free pages. When exactly and which free pages are
reported is up to the driver.
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-344002x1">The driver determines it has enough pages available to begin reporting free
    pages.
    </li>
    <li 
  class="enumerate" id="x1-344004x2">The driver gathers free pages into a scatter-gather list and adds them to
    the reporting_vq.
    </li>
    <li 
  class="enumerate" id="x1-344006x3">The device acknowledges the reporting request by using the reporting_vq
    descriptor.
    </li>
    <li 
  class="enumerate" id="x1-344008x4">Once the device has acknowledged the report, the driver can reuse the
    reported free pages when needed (e.g., by putting them back to free page
    lists in the guest operating system).
    </li>
    <li 
  class="enumerate" id="x1-344010x5">The driver can then continue to gather and report free pages until it has
    determined it has reported a sufficient quantity of pages.
    </li></ol>
<a 
 id="x1-344011r349"></a>
<h5 class="paragraphHead"><span class="titlemark">5.5.6.7.1</span> <a 
 id="x1-3450001"></a>Driver Requirements: Free Page Reporting</h5>
Normative statements in this section apply if the VIRTIO_BALLOON_F_PAGE_REPORTING
feature has been negotiated.
<!--l. 6183--><p class="noindent" >If the VIRTIO_BALLOON_F_PAGE_POISON feature has not been negotiated, then
the driver MUST treat all reported pages as uninitialized memory.
<!--l. 6186--><p class="noindent" >If the VIRTIO_BALLOON_F_PAGE_POISON feature has been negotiated,
the driver MUST initialize all free pages with <span 
class="aeti-10">poison_val </span>before reporting
them.
<!--l. 6190--><p class="noindent" >The driver MUST NOT use the reported pages until the device has acknowledged the
reporting request.
<!--l. 6193--><p class="noindent" >The driver MAY report free pages any time after DRIVER_OK is set.
<!--l. 6195--><p class="noindent" >The driver SHOULD attempt to report large pages rather than smaller ones.
                                                                  

                                                                  
<!--l. 6197--><p class="noindent" >The driver SHOULD avoid reading/writing reported pages if not strictly
necessary.
<a 
 id="x1-345001r351"></a>
<h5 class="paragraphHead"><span class="titlemark">5.5.6.7.2</span> <a 
 id="x1-3460002"></a>Device Requirements: Free Page Reporting</h5>
Normative statements in this section apply if the VIRTIO_BALLOON_F_PAGE_REPORTING
feature has been negotiated.
<!--l. 6205--><p class="noindent" >If the VIRTIO_BALLOON_F_PAGE_POISON feature has not been negotiated, the
device MAY modify the contents of any page supplied in a report request before
acknowledging that request by using the reporting_vq descriptor.
<!--l. 6209--><p class="noindent" >If the VIRTIO_BALLOON_F_PAGE_POISON feature has been negotiated, the
device MUST NOT modify the the content of a reported page to a value other than
<span 
class="aeti-10">poison_val</span>.
<a 
 id="x1-346001r324"></a>
<h3 class="sectionHead"><span class="titlemark">5.6   </span> <a 
 id="x1-3470006"></a>SCSI Host Device</h3>
<!--l. 6215--><p class="nopar" >The virtio SCSI host device groups together one or more virtual logical units (such as
disks), and allows communicating to them using the SCSI protocol. An instance of
the device represents a SCSI host to which many targets and LUNs are
attached.
<!--l. 6220--><p class="noindent" >The virtio SCSI device services two kinds of requests:
    <ul class="itemize1">
    <li class="itemize">command requests for a logical unit;
    </li>
    <li class="itemize">task management functions related to a logical unit, target or command.</li></ul>
<!--l. 6228--><p class="noindent" >The device is also able to send out notifications about added and removed logical
units. Together, these capabilities provide a SCSI transport protocol that uses
virtqueues as the transfer medium. In the transport protocol, the virtio driver acts as
the initiator, while the virtio SCSI host provides one or more targets that receive and
process the requests.
<!--l. 6235--><p class="noindent" >This section relies on definitions from <a 
href="#x1-3001r1">SAM</a>.
<a 
 id="x1-347001r334"></a>
<h4 class="subsectionHead"><span class="titlemark">5.6.1   </span> <a 
 id="x1-3480001"></a>Device ID</h4>
<!--l. 6238--><p class="nopar" >8
<a 
 id="x1-348001r354"></a>
<h4 class="subsectionHead"><span class="titlemark">5.6.2   </span> <a 
 id="x1-3490002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">controlq
    </dd><dt class="description">
                                                                  

                                                                  
<span 
class="aeb10-">1</span> </dt><dd 
class="description">eventq
    </dd><dt class="description">
<span 
class="aeb10-">2</span><span 
class="aeb10-">…n</span> </dt><dd 
class="description">request queues</dd></dl>
<a 
 id="x1-349001r355"></a>
<h4 class="subsectionHead"><span class="titlemark">5.6.3   </span> <a 
 id="x1-3500003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_SCSI_F_INOUT (0)</span> </dt><dd 
class="description">A single request can include both device-readable
    and device-writable data buffers.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_SCSI_F_HOTPLUG (1)</span> </dt><dd 
class="description">The   host   SHOULD   enable   reporting   of
    hot-plug and hot-unplug events for LUNs and targets on the SCSI bus.
    The guest SHOULD handle hot-plug and hot-unplug events.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_SCSI_F_CHANGE (2)</span> </dt><dd 
class="description">The   host   will   report   changes   to   LUN
    parameters  via  a  VIRTIO_SCSI_T_PARAM_CHANGE  event;  the  guest
    SHOULD handle them.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_SCSI_F_T10_PI (3)</span> </dt><dd 
class="description">The                                                extended
    fields for T10 protection information (DIF/DIX) are included in the SCSI
    request header.</dd></dl>
<a 
 id="x1-350001r356"></a>
<h4 class="subsectionHead"><span class="titlemark">5.6.4   </span> <a 
 id="x1-3510004"></a>Device configuration layout</h4>
<!--l. 6268--><p class="nopar" >All fields of this configuration are always available.
<!--l. 6270-->
<div class="lstlisting" id="listing-85"><span class="label"><a 
 id="x1-351001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-351002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_queues</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-351003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">seg_max</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-351004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_sectors</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-351005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cmd_per_lun</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-351006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event_info_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-351007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sense_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-351008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cdb_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-351009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_channel</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-351010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_target</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-351011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_lun</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-351012r12"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">num_queues</span> </dt><dd 
class="description">is the total number of request virtqueues exposed by the device.
    The driver MAY use only one request queue, or it can use more to achieve
    better performance.
    </dd><dt class="description">
<span 
class="aebxti-10">seg_max</span> </dt><dd 
class="description">is the maximum number of segments that can be in a command. A
    bidirectional command can include <span 
class="aeti-10">seg_max </span>input segments and <span 
class="aeti-10">seg_max</span>
    output segments.
    </dd><dt class="description">
<span 
class="aebxti-10">max_sectors</span> </dt><dd 
class="description">is a hint to the driver about the maximum transfer size to use.
    </dd><dt class="description">
                                                                  

                                                                  
<span 
class="aebxti-10">cmd_per_lun</span> </dt><dd 
class="description">tells the driver the maximum number of linked commands it can
    send to one LUN.
    </dd><dt class="description">
<span 
class="aebxti-10">event_info_size</span> </dt><dd 
class="description">is the maximum size that the device will fill for buffers that
    the driver places in the eventq. It is written by the device depending on
    the set of negotiated features.
    </dd><dt class="description">
<span 
class="aebxti-10">sense_size</span> </dt><dd 
class="description">is the maximum size of the sense data that the device will write.
    The default value is written by the device and MUST be 96, but the driver
    can modify it. It is restored to the default when the device is reset.
    </dd><dt class="description">
<span 
class="aebxti-10">cdb_size</span> </dt><dd 
class="description">is the maximum size of the CDB that the driver will write. The default
    value is written by the device and MUST be 32, but the driver can likewise
    modify it. It is restored to the default when the device is reset.
    </dd><dt class="description">
<span 
class="aebxti-10">max_channel</span><span 
class="aeb10-">, </span><span 
class="aebxti-10">max_target </span><span 
class="aeb10-">and </span><span 
class="aebxti-10">max_lun</span> </dt><dd 
class="description">can be used by the driver as hints
    to constrain scanning the logical units on the host to channel/target/logical
    unit  numbers  that  are  less  than  or  equal  to  the  value  of  the  fields.
    <span 
class="aeti-10">max_channel </span>SHOULD be zero. <span 
class="aeti-10">max_target </span>SHOULD be less than or equal
    to 255. <span 
class="aeti-10">max_lun </span>SHOULD be less than or equal to 16383.</dd></dl>
<a 
 id="x1-351013r350"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.6.4.1   </span> <a 
 id="x1-3520001"></a>Driver Requirements: Device configuration layout</h5>
<!--l. 6325--><p class="nopar" >The driver MUST NOT write to device configuration fields other than <span 
class="aeti-10">sense_size </span>and
<span 
class="aeti-10">cdb_size</span>.
<!--l. 6328--><p class="noindent" >The driver MUST NOT send more than <span 
class="aeti-10">cmd_per_lun </span>linked commands to one LUN,
and MUST NOT send more than the virtqueue size number of linked commands to
one LUN.
<a 
 id="x1-352001r358"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.6.4.2   </span> <a 
 id="x1-3530002"></a>Device Requirements: Device configuration layout</h5>
<!--l. 6334--><p class="nopar" >On reset, the device MUST set <span 
class="aeti-10">sense_size </span>to 96 and <span 
class="aeti-10">cdb_size </span>to 32.
<a 
 id="x1-353001r359"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.6.4.3   </span> <a 
 id="x1-3540003"></a>Legacy Interface: Device configuration layout</h5>
<!--l. 6338--><p class="nopar" >When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_scsi_config according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<a 
 id="x1-354001r357"></a>
<h4 class="subsectionHead"><span class="titlemark">5.6.5   </span> <a 
 id="x1-3550005"></a>Device Requirements: Device Initialization</h4>
<!--l. 6345--><p class="nopar" >On initialization the driver SHOULD first discover the device’s virtqueues.
                                                                  

                                                                  
<!--l. 6348--><p class="noindent" >If the driver uses the eventq, the driver SHOULD place at least one buffer in the
eventq.
<!--l. 6351--><p class="noindent" >The  driver  MAY  immediately  issue
requests<span class="footnote-mark"><a 
href="#fn16x5" id="fn16x5-bk"><sup class="textsuperscript">16</sup></a></span><a 
 id="x1-355001f16"></a> or task
management functions<span class="footnote-mark"><a 
href="#fn17x5" id="fn17x5-bk"><sup class="textsuperscript">17</sup></a></span><a 
 id="x1-355002f17"></a>.
<a 
 id="x1-355003r361"></a>
<h4 class="subsectionHead"><span class="titlemark">5.6.6   </span> <a 
 id="x1-3560006"></a>Device Operation</h4>
<!--l. 6357--><p class="nopar" >Device operation consists of operating request queues, the control queue and the
event queue.
<a 
 id="x1-356001r352"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.0.1</span> <a 
 id="x1-3570001"></a>Legacy Interface: Device Operation</h5>
When using the legacy interface, the driver SHOULD ignore the used length
values.
<span 
class="aeb10-">Note:</span> Historically, devices put the total descriptor length, or the total length
      of device-writable buffers there, even when only part of the buffers were
      actually written.
<a 
 id="x1-357001r360"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.6.6.1   </span> <a 
 id="x1-3580001"></a>Device Operation: Request Queues</h5>
<!--l. 6373--><p class="nopar" >The driver queues requests to an arbitrary request queue, and they are used by the
device on that same queue. It is the responsibility of the driver to ensure strict
request ordering for commands placed on different queues, because they will be
consumed with no order constraints.
<!--l. 6379--><p class="noindent" >Requests have the following format:
<!--l. 6381-->
<div class="lstlisting" id="listing-86"><span class="label"><a 
 id="x1-358001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_req_cmd</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">readable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">lun</span><span 
class="pcrr8t-x-x-80">[8];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">task_attr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">prio</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">crn</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cdb</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">cdb_size</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">three</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">present</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_F_T10_PI</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">negotiated</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pi_bytesout</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pi_bytesin</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pi_out</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">pi_bytesout</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dataout</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sense_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">residual</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status_qualifier</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358022r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sense</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">sense_size</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">present</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_F_T10_PI</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358024r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">negotiated</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358025r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pi_in</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">pi_bytesin</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358026r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">datain</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358027r27"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358028r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358029r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358030r30"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">command</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">values</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358031r31"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_OK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358032r32"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_OVERRUN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358033r33"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_ABORTED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358034r34"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_BAD_TARGET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358035r35"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_RESET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358036r36"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_BUSY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358037r37"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_TRANSPORT_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358038r38"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_TARGET_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358039r39"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_NEXUS_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358040r40"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358041r41"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358042r42"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">task_attr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358043r43"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_SIMPLE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358044r44"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_ORDERED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358045r45"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_HEAD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-358046r46"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_ACA</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span>
</div>
<!--l. 6430--><p class="noindent" ><span 
class="aeti-10">lun </span>addresses the REPORT LUNS well-known logical unit, or a target and
logical unit in the virtio-scsi device’s SCSI domain. When used to address the
REPORT LUNS logical unit, <span 
class="aeti-10">lun </span>is 0xC1, 0x01 and six zero bytes. The
virtio-scsi device SHOULD implement the REPORT LUNS well-known logical
unit.
<!--l. 6436--><p class="noindent" >When used to address a target and logical unit, the only supported format for <span 
class="aeti-10">lun </span>is:
first byte set to 1, second byte set to target, third and fourth byte representing a
single level LUN structure, followed by four zero bytes. With this representation, a
virtio-scsi device can serve up to 256 targets and 16384 LUNs per target. The device
MAY also support having a well-known logical units in the third and fourth
                                                                  

                                                                  
byte.
<!--l. 6443--><p class="noindent" ><span 
class="aeti-10">id </span>is the command identifier (“tag”).
<!--l. 6445--><p class="noindent" ><span 
class="aeti-10">task_attr </span>defines the task attribute as in the table above, but all task attributes MAY
be mapped to SIMPLE by the device. Some commands are defined by SCSI
standards as "implicit head of queue"; for such commands, all task attributes MAY
also be mapped to HEAD OF QUEUE. Drivers and applications SHOULD NOT
send a command with the ORDERED task attribute if the command has an implicit
HEAD OF QUEUE attribute, because whether the ORDERED task attribute is
honored is vendor-specific.
<!--l. 6453--><p class="noindent" ><span 
class="aeti-10">crn </span>may also be provided by clients, but is generally expected to be 0. The maximum
CRN value defined by the protocol is 255, since CRN is stored in an 8-bit
integer.
<!--l. 6457--><p class="noindent" >The CDB is included in <span 
class="aeti-10">cdb </span>and its size, <span 
class="aeti-10">cdb_size</span>, is taken from the configuration
space.
<!--l. 6460--><p class="noindent" >All of these fields are defined in <a 
href="#x1-3001r1">SAM</a> and are always device-readable.
<!--l. 6463--><p class="noindent" ><span 
class="aeti-10">pi_bytesout </span>determines the size of the <span 
class="aeti-10">pi_out </span>field in bytes. If it is nonzero, the
<span 
class="aeti-10">pi_out </span>field contains outgoing protection information for write operations.
<span 
class="aeti-10">pi_bytesin </span>determines the size of the <span 
class="aeti-10">pi_in </span>field in the device-writable section, in
bytes. All three fields are only present if VIRTIO_SCSI_F_T10_PI has been
negotiated.
<!--l. 6469--><p class="noindent" >The remainder of the device-readable part is the data output buffer, <span 
class="aeti-10">dataout</span>.
<!--l. 6472--><p class="noindent" ><span 
class="aeti-10">sense </span>and subsequent fields are always device-writable. <span 
class="aeti-10">sense_len </span>indicates the
number of bytes actually written to the sense buffer.
<!--l. 6476--><p class="noindent" ><span 
class="aeti-10">residual </span>indicates the residual size, calculated as “data_length - number_of_transferred_bytes”,
for read or write operations. For bidirectional commands, the number_of_transferred_bytes
includes both read and written bytes. A <span 
class="aeti-10">residual </span>that is less than the size of <span 
class="aeti-10">datain</span>
means that <span 
class="aeti-10">dataout </span>was processed entirely. A <span 
class="aeti-10">residual </span>that exceeds the size of <span 
class="aeti-10">datain</span>
means that <span 
class="aeti-10">dataout </span>was processed partially and <span 
class="aeti-10">datain </span>was not processed at
all.
<!--l. 6486--><p class="noindent" >If the <span 
class="aeti-10">pi_bytesin </span>is nonzero, the <span 
class="aeti-10">pi_in </span>field contains incoming protection information
for read operations. <span 
class="aeti-10">pi_in </span>is only present if VIRTIO_SCSI_F_T10_PI has been
negotiated<span class="footnote-mark"><a 
href="#fn18x5" id="fn18x5-bk"><sup class="textsuperscript">18</sup></a></span><a 
 id="x1-358047f18"></a>.
<!--l. 6494--><p class="noindent" >The remainder of the device-writable part is the data input buffer, <span 
class="aeti-10">datain</span>.
<a 
 id="x1-358048r363"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.1.1</span> <a 
 id="x1-3590001"></a>Device Requirements: Device Operation: Request Queues</h5>
The device MUST write the <span 
class="aeti-10">status </span>byte as the status code as defined in
<a 
href="#x1-3001r1">SAM</a>.
<!--l. 6503--><p class="noindent" >The device MUST write the <span 
class="aeti-10">response </span>byte as one of the following:
                                                                  

                                                                  
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_SCSI_S_OK</span> </dt><dd 
class="description">when the request was completed and the <span 
class="aeti-10">status </span>byte is
    filled with a SCSI status code (not necessarily “GOOD”).
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_SCSI_S_OVERRUN</span> </dt><dd 
class="description">if the content of the CDB (such as the allocation
    length,  parameter  length  or  transfer  size)  requires  more  data  than  is
    available in the datain and dataout buffers.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_SCSI_S_ABORTED</span> </dt><dd 
class="description">if the request was cancelled due to an ABORT
    TASK or ABORT TASK SET task management function.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_SCSI_S_BAD_TARGET</span> </dt><dd 
class="description">if the request was never processed because
    the target indicated by <span 
class="aeti-10">lun </span>does not exist.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_SCSI_S_RESET</span> </dt><dd 
class="description">if the request was cancelled due to a bus or device
    reset (including a task management function).
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_SCSI_S_TRANSPORT_FAILURE</span> </dt><dd 
class="description">if  the  request  failed  due  to  a
    problem in the connection between the host and the target (severed link).
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_SCSI_S_TARGET_FAILURE</span> </dt><dd 
class="description">if the target is suffering a failure and to
    tell the driver not to retry on other paths.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_SCSI_S_NEXUS_FAILURE</span> </dt><dd 
class="description">if  the  nexus  is  suffering  a  failure  but
    retrying on other paths might yield a different result.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_SCSI_S_BUSY</span> </dt><dd 
class="description">if the request failed but retrying on the same path is
    likely to work.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_SCSI_S_FAILURE</span> </dt><dd 
class="description">for  other  host  or  driver  error.  In  particular,  if
    neither  <span 
class="aeti-10">dataout  </span>nor  <span 
class="aeti-10">datain  </span>is  empty,  and  the  VIRTIO_SCSI_F_INOUT
    feature has not been negotiated, the request will be immediately returned
    with a response equal to VIRTIO_SCSI_S_FAILURE.</dd></dl>
<!--l. 6544--><p class="noindent" >All commands must be completed before the virtio-scsi device is reset or unplugged.
The device MAY choose to abort them, or if it does not do so MUST pick the
VIRTIO_SCSI_S_FAILURE response.
<a 
 id="x1-359001r365"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.1.2</span> <a 
 id="x1-3600002"></a>Driver Requirements: Device Operation: Request Queues</h5>
<span 
class="aeti-10">task_attr</span>, <span 
class="aeti-10">prio </span>and <span 
class="aeti-10">crn </span>SHOULD be zero.
                                                                  

                                                                  
<!--l. 6552--><p class="noindent" >Upon receiving a VIRTIO_SCSI_S_TARGET_FAILURE response, the driver
SHOULD NOT retry the request on other paths.
<a 
 id="x1-360001r366"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.1.3</span> <a 
 id="x1-3610003"></a>Legacy Interface: Device Operation: Request Queues</h5>
When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_scsi_req_cmd according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<a 
 id="x1-361001r364"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.6.6.2   </span> <a 
 id="x1-3620002"></a>Device Operation: controlq</h5>
<!--l. 6563--><p class="nopar" >The controlq is used for other SCSI transport operations. Requests have the following
format:
<!--l. 6568-->
<div class="lstlisting" id="listing-87"><span class="label"><a 
 id="x1-362001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_ctrl</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362003r3"></a></span><span 
class="pcrr8t-x-x-80">…</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362005r5"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362007r7"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">values</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">valid</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">all</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">commands</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_OK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_BAD_TARGET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_BUSY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362011r11"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_TRANSPORT_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362012r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_TARGET_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362013r13"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_NEXUS_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362014r14"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362015r15"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_INCORRECT_LUN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">12</span>
</div>
<!--l. 6587--><p class="noindent" >The <span 
class="aeti-10">type </span>identifies the remaining fields.
<!--l. 6589--><p class="noindent" >The following commands are defined:
    <ul class="itemize1">
    <li class="itemize">Task management function. <!--l. 6593-->
    <div class="lstlisting" id="listing-88"><span class="label"><a 
 id="x1-362016r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362017r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362018r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_ABORT_TASK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362019r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_ABORT_TASK_SET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362020r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_CLEAR_ACA</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362021r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_CLEAR_TASK_SET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362022r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_I_T_NEXUS_RESET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362023r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_LOGICAL_UNIT_RESET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362024r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_QUERY_TASK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362025r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TMF_QUERY_TASK_SET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362026r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362027r12"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_ctrl_tmf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362028r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">readable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362029r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362030r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">subtype</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362031r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">lun</span><span 
class="pcrr8t-x-x-80">[8];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362032r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362033r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362034r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362035r20"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362036r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362037r22"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">command</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">values</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362038r23"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_FUNCTION_COMPLETE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362039r24"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_FUNCTION_SUCCEEDED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">10</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362040r25"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_S_FUNCTION_REJECTED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">11</span>
    
    </div>
    <!--l. 6621--><p class="noindent" >The <span 
class="aeti-10">type </span>is VIRTIO_SCSI_T_TMF; <span 
class="aeti-10">subtype </span>defines which task management
    function. All fields except <span 
class="aeti-10">response </span>are filled by the driver.
    <!--l. 6625--><p class="noindent" >Other fields which are irrelevant for the requested TMF are ignored but they are
    still present. <span 
class="aeti-10">lun </span>is in the same format specified for request queues; the single
    level LUN is ignored when the task management function addresses a whole I_T
    nexus. When relevant, the value of <span 
class="aeti-10">id </span>is matched against the id values passed on
    the requestq.
    <!--l. 6632--><p class="noindent" >The outcome of the task management function is written by the device in
    <span 
class="aeti-10">response</span>. The command-specific response values map 1-to-1 with those defined
    in <a 
href="#x1-3001r1">SAM</a>.
    <!--l. 6636--><p class="noindent" >Task management function can affect the response value for commands that are
    in the request queue and have not been completed yet. For example,
    the device MUST complete all active commands on a logical unit or
    target (possibly with a VIRTIO_SCSI_S_RESET response code) upon
                                                                  

                                                                  
    receiving a "logical unit reset" or "I_T nexus reset" TMF. Similarly,
    the device MUST complete the selected commands (possibly with a
    VIRTIO_SCSI_S_ABORTED response code) upon receiving an "abort task" or
    "abort task set" TMF. Such effects MUST take place before the TMF itself is
    successfully completed, and the device MUST use memory barriers
    appropriately in order to ensure that the driver sees these writes in the correct
    order.
    </li>
    <li class="itemize">Asynchronous notification query. <!--l. 6649-->
    <div class="lstlisting" id="listing-89"><span class="label"><a 
 id="x1-362041r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_AN_QUERY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362042r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362043r3"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_ctrl_an</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362044r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">readable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362045r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362046r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">lun</span><span 
class="pcrr8t-x-x-80">[8];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362047r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event_requested</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362048r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362049r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event_actual</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362050r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362051r11"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362052r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362053r13"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_ASYNC_OPERATIONAL_CHANGE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362054r14"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_ASYNC_POWER_MGMT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362055r15"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_ASYNC_EXTERNAL_REQUEST</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362056r16"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_ASYNC_MEDIA_CHANGE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362057r17"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_ASYNC_MULTI_HOST</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">32</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362058r18"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_ASYNC_DEVICE_BUSY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">64</span>
    
    </div>
    <!--l. 6670--><p class="noindent" >By sending this command, the driver asks the device which events the given
    LUN can report, as described in paragraphs 6.6 and A.6 of <a 
href="#x1-3001r1">SCSI MMC</a>. The
    driver writes the events it is interested in into <span 
class="aeti-10">event_requested</span>; the device
    responds by writing the events that it supports into <span 
class="aeti-10">event_actual</span>.
    <!--l. 6677--><p class="noindent" >The <span 
class="aeti-10">type </span>is VIRTIO_SCSI_T_AN_QUERY. <span 
class="aeti-10">lun </span>and <span 
class="aeti-10">event_requested </span>are
    written by the driver. <span 
class="aeti-10">event_actual </span>and <span 
class="aeti-10">response </span>fields are written by the
    device.
    <!--l. 6681--><p class="noindent" >No command-specific values are defined for the <span 
class="aeti-10">response </span>byte.
    </li>
    <li class="itemize">Asynchronous notification subscription. <!--l. 6684-->
    <div class="lstlisting" id="listing-90"><span class="label"><a 
 id="x1-362059r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_AN_SUBSCRIBE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362060r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362061r3"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_ctrl_an</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362062r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">readable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362063r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362064r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">lun</span><span 
class="pcrr8t-x-x-80">[8];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362065r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event_requested</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362066r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362067r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event_actual</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362068r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">response</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-362069r11"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 6698--><p class="noindent" >By sending this command, the driver asks the specified LUN to report events for
    its physical interface, again as described in <a 
href="#x1-3001r1">SCSI MMC</a>. The driver writes the
    events it is interested in into <span 
class="aeti-10">event_requested</span>; the device responds by writing the
    events that it supports into <span 
class="aeti-10">event_actual</span>.
    <!--l. 6704--><p class="noindent" >Event types are the same as for the asynchronous notification query
    message.
    <!--l. 6707--><p class="noindent" >The <span 
class="aeti-10">type </span>is VIRTIO_SCSI_T_AN_SUBSCRIBE. <span 
class="aeti-10">lun </span>and <span 
class="aeti-10">event_requested </span>are
    written by the driver. <span 
class="aeti-10">event_actual </span>and <span 
class="aeti-10">response </span>are written by the
    device.
    <!--l. 6711--><p class="noindent" >No command-specific values are defined for the response byte.</li></ul>
<a 
 id="x1-362070r367"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.2.1</span> <a 
 id="x1-3630001"></a>Legacy Interface: Device Operation: controlq</h5>
When using the legacy interface, transitional devices and drivers MUST
                                                                  

                                                                  
format the fields in struct virtio_scsi_ctrl, struct virtio_scsi_ctrl_tmf, struct
virtio_scsi_ctrl_an and struct virtio_scsi_ctrl_an according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<a 
 id="x1-363001r368"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.6.6.3   </span> <a 
 id="x1-3640003"></a>Device Operation: eventq</h5>
<!--l. 6726--><p class="nopar" >The eventq is populated by the driver for the device to report information on
logical units that are attached to it. In general, the device will not queue
events to cope with an empty eventq, and will end up dropping events if it
finds no buffer ready. However, when reporting events for many LUNs (e.g.
when a whole target disappears), the device can throttle events to avoid
dropping them. For this reason, placing 10-15 buffers on the event queue is
sufficient.
<!--l. 6735--><p class="noindent" >Buffers returned by the device on the eventq will be referred to as “events” in the rest
of this section. Events have the following format:
<!--l. 6739-->
<div class="lstlisting" id="listing-91"><span class="label"><a 
 id="x1-364001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_EVENTS_MISSED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x80000000</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-364002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-364003r3"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scsi_event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-364004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-364005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-364006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">lun</span><span 
class="pcrr8t-x-x-80">[8];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-364007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reason</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-364008r8"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 6750--><p class="noindent" >The devices sets bit 31 in <span 
class="aeti-10">event </span>to report lost events due to missing buffers.
<!--l. 6753--><p class="noindent" >The meaning of <span 
class="aeti-10">reason </span>depends on the contents of <span 
class="aeti-10">event</span>. The following events are
defined:
    <ul class="itemize1">
    <li class="itemize">No event. <!--l. 6758-->
    <div class="lstlisting" id="listing-92"><span class="label"><a 
 id="x1-364009r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_NO_EVENT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span>
    
    </div>
    <!--l. 6762--><p class="noindent" >This event is fired in the following cases:
        <ul class="itemize2">
        <li class="itemize">When the device detects in the eventq a buffer that is shorter than
        what is indicated in the configuration field, it MAY use it immediately
        and put this dummy value in <span 
class="aeti-10">event</span>. A well-written driver will never
        observe this situation.
        </li>
        <li class="itemize">When events are dropped, the device MAY signal this event as soon
        as the drivers makes a buffer available, in order to request action from
        the driver. In this case, of course, this event will be reported with the
        VIRTIO_SCSI_T_EVENTS_MISSED flag.</li></ul>
                                                                  

                                                                  
    </li>
    <li class="itemize">Transport reset <!--l. 6779-->
    <div class="lstlisting" id="listing-93"><span class="label"><a 
 id="x1-364010r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_TRANSPORT_RESET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-364011r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-364012r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_RESET_HARD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-364013r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_RESET_RESCAN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-364014r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_EVT_RESET_REMOVED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span>
    
    </div>
    <!--l. 6787--><p class="noindent" >By sending this event, the device signals that a logical unit on a target
    has been reset, including the case of a new device appearing or
    disappearing on the bus. The device fills in all fields. <span 
class="aeti-10">event </span>is set to
    VIRTIO_SCSI_T_TRANSPORT_RESET. <span 
class="aeti-10">lun </span>addresses a logical unit in the
    SCSI host.
    <!--l. 6794--><p class="noindent" >The <span 
class="aeti-10">reason </span>value is one of the three #define values appearing above:
        <dl class="description"><dt class="description">
    <span 
class="aeb10-">VIRTIO_SCSI_EVT_RESET_REMOVED</span> </dt><dd 
class="description">(“LUN/target    removed”)    is
        used if the target or logical unit is no longer able to receive commands.
        </dd><dt class="description">
    <span 
class="aeb10-">VIRTIO_SCSI_EVT_RESET_HARD</span> </dt><dd 
class="description">(“LUN  hard  reset”)  is  used  if  the
        logical unit has been reset, but is still present.
        </dd><dt class="description">
    <span 
class="aeb10-">VIRTIO_SCSI_EVT_RESET_RESCAN</span> </dt><dd 
class="description">(“rescan LUN/target”) is used if a
        target or logical unit has just appeared on the device.</dd></dl>
    <!--l. 6809--><p class="noindent" >The “removed” and “rescan” events can happen when VIRTIO_SCSI_F_HOTPLUG
    feature was negotiated; when sent for LUN 0, they MAY apply to the entire
    target so the driver can ask the initiator to rescan the target to detect
    this.
    <!--l. 6814--><p class="noindent" >Events will also be reported via sense codes (this obviously does not apply to
    newly appeared buses or targets, since the application has never discovered
    them):
        <ul class="itemize2">
        <li class="itemize">“LUN/target removed” maps to sense key ILLEGAL REQUEST, asc
        0x25, ascq 0x00 (LOGICAL UNIT NOT SUPPORTED)
        </li>
        <li class="itemize">“LUN hard reset” maps to sense key UNIT ATTENTION, asc 0x29
        (POWER ON, RESET OR BUS DEVICE RESET OCCURRED)
        </li>
        <li class="itemize">“rescan LUN/target” maps to sense key UNIT ATTENTION, asc 0x3f,
        ascq 0x0e (REPORTED LUNS DATA HAS CHANGED)</li></ul>
    <!--l. 6829--><p class="noindent" >The preferred way to detect transport reset is always to use events, because
    sense codes are only seen by the driver when it sends a SCSI command to
    the logical unit or target. However, in case events are dropped, the
                                                                  

                                                                  
    initiator will still be able to synchronize with the actual state of the
    controller if the driver asks the initiator to rescan of the SCSI bus. During
    the rescan, the initiator will be able to observe the above sense codes,
    and it will process them as if it the driver had received the equivalent
    event.
    </li>
    <li class="itemize">Asynchronous notification <!--l. 6840-->
    <div class="lstlisting" id="listing-94"><span class="label"><a 
 id="x1-364015r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_ASYNC_NOTIFY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span>
    
    </div>
    <!--l. 6844--><p class="noindent" >By sending this event, the device signals that an asynchronous event was fired
    from a physical interface.
    <!--l. 6847--><p class="noindent" >All fields are written by the device. <span 
class="aeti-10">event </span>is set to VIRTIO_SCSI_T_ASYNC_NOTIFY.
    <span 
class="aeti-10">lun </span>addresses a logical unit in the SCSI host. <span 
class="aeti-10">reason </span>is a subset of the events
    that the driver has subscribed to via the “Asynchronous notification
    subscription” command.
    </li>
    <li class="itemize">LUN parameter change <!--l. 6854-->
    <div class="lstlisting" id="listing-95"><span class="label"><a 
 id="x1-364016r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SCSI_T_PARAM_CHANGE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span>
    
    </div>
    <!--l. 6858--><p class="noindent" >By sending this event, the device signals a change in the configuration
    parameters of a logical unit, for example the capacity or cache mode. <span 
class="aeti-10">event </span>is
    set to VIRTIO_SCSI_T_PARAM_CHANGE. <span 
class="aeti-10">lun </span>addresses a logical unit in the
    SCSI host.
    <!--l. 6863--><p class="noindent" >The same event SHOULD also be reported as a unit attention condition. <span 
class="aeti-10">reason</span>
    contains the additional sense code and additional sense code qualifier,
    respectively in bits 0…7 and 8…15.
    <span 
class="aeb10-">Note:</span> For example, a change in capacity will be reported as asc 0x2a, ascq
          0x09 (CAPACITY DATA HAS CHANGED).
    <!--l. 6871--><p class="noindent" >For MMC devices (inquiry type 5) there would be some overlap between this
    event and the asynchronous notification event, so for simplicity the host never
    reports this event for MMC devices.</li></ul>
<a 
 id="x1-364017r369"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.3.1</span> <a 
 id="x1-3650001"></a>Driver Requirements: Device Operation: eventq</h5>
The driver SHOULD keep the eventq populated with buffers. These buffers MUST be
device-writable, and SHOULD be at least <span 
class="aeti-10">event_info_size </span>bytes long, and MUST be
at least the size of struct virtio_scsi_event.
                                                                  

                                                                  
<!--l. 6883--><p class="noindent" >If <span 
class="aeti-10">event </span>has bit 31 set, the driver SHOULD poll the logical units for unit attention
conditions, and/or do whatever form of bus scan is appropriate for the guest
operating system and SHOULD poll for asynchronous events manually using SCSI
commands.
<!--l. 6888--><p class="noindent" >When receiving a VIRTIO_SCSI_T_TRANSPORT_RESET message with <span 
class="aeti-10">reason </span>set to
VIRTIO_SCSI_EVT_RESET_REMOVED or VIRTIO_SCSI_EVT_RESET_RESCAN
for LUN 0, the driver SHOULD ask the initiator to rescan the target, in order to
detect the case when an entire target has appeared or disappeared.
<a 
 id="x1-365001r371"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.3.2</span> <a 
 id="x1-3660002"></a>Device Requirements: Device Operation: eventq</h5>
The device MUST set bit 31 in <span 
class="aeti-10">event </span>if events were lost due to missing
buffers, and it MAY use a VIRTIO_SCSI_T_NO_EVENT event to report
this.
<!--l. 6900--><p class="noindent" >The device MUST NOT send VIRTIO_SCSI_T_TRANSPORT_RESET
messages with <span 
class="aeti-10">reason </span>set to VIRTIO_SCSI_EVT_RESET_REMOVED or
VIRTIO_SCSI_EVT_RESET_RESCAN unless VIRTIO_SCSI_F_HOTPLUG was
negotiated.
<!--l. 6904--><p class="noindent" >The device MUST NOT report VIRTIO_SCSI_T_PARAM_CHANGE for MMC
devices.
<a 
 id="x1-366001r372"></a>
<h5 class="paragraphHead"><span class="titlemark">5.6.6.3.3</span> <a 
 id="x1-3670003"></a>Legacy Interface: Device Operation: eventq</h5>
When using the legacy interface, transitional devices and drivers MUST
format the fields in struct virtio_scsi_event according to the native endian
of the guest rather than (necessarily when not using the legacy interface)
little-endian.
<a 
 id="x1-367001r370"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.6.6.4   </span> <a 
 id="x1-3680004"></a>Legacy Interface: Framing Requirements</h5>
<!--l. 6915--><p class="nopar" >When using legacy interfaces, transitional drivers which have not negotiated
VIRTIO_F_ANY_LAYOUT MUST use a single descriptor for the <span 
class="aeti-10">lun</span>, <span 
class="aeti-10">id</span>, <span 
class="aeti-10">task_attr</span>,
<span 
class="aeti-10">prio</span>, <span 
class="aeti-10">crn </span>and <span 
class="aeti-10">cdb </span>fields, and MUST only use a single descriptor for the <span 
class="aeti-10">sense_len</span>,
<span 
class="aeti-10">residual</span>, <span 
class="aeti-10">status_qualifier</span>, <span 
class="aeti-10">status</span>, <span 
class="aeti-10">response </span>and <span 
class="aeti-10">sense </span>fields.
<a 
 id="x1-368001r353"></a>
<h3 class="sectionHead"><span class="titlemark">5.7   </span> <a 
 id="x1-3690007"></a>GPU Device</h3>
<!--l. 3--><p class="nopar" >virtio-gpu is a virtio based graphics adapter. It can operate in 2D mode and in 3D
mode. 3D mode will offload rendering ops to the host gpu and therefore requires a
gpu with 3D support on the host machine.
<!--l. 8--><p class="noindent" >In 2D mode the virtio-gpu device provides support for ARGB Hardware cursors and
multiple scanouts (aka heads).
                                                                  

                                                                  
<a 
 id="x1-369001r362"></a>
<h4 class="subsectionHead"><span class="titlemark">5.7.1   </span> <a 
 id="x1-3700001"></a>Device ID</h4>
<!--l. 13--><p class="nopar" >16
<a 
 id="x1-370001r376"></a>
<h4 class="subsectionHead"><span class="titlemark">5.7.2   </span> <a 
 id="x1-3710002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">controlq - queue for sending control commands
    </dd><dt class="description">
<span 
class="aeb10-">1</span> </dt><dd 
class="description">cursorq - queue for sending cursor updates</dd></dl>
<!--l. 22--><p class="nopar" >Both queues have the same format. Each request and each response have a fixed
header, followed by command specific data fields. The separate cursor queue is the
"fast track" for cursor commands (VIRTIO_GPU_CMD_UPDATE_CURSOR and
VIRTIO_GPU_CMD_MOVE_CURSOR), so they go through without being delayed
by time-consuming commands in the control queue.
<a 
 id="x1-371001r377"></a>
<h4 class="subsectionHead"><span class="titlemark">5.7.3   </span> <a 
 id="x1-3720003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_F_VIRGL (0)</span> </dt><dd 
class="description">virgl 3D mode is supported.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_F_EDID (1)</span> </dt><dd 
class="description">EDID is supported.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_F_RESOURCE_UUID (2)</span> </dt><dd 
class="description">assigning resources UUIDs for export
    to other virtio devices is supported.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_F_RESOURCE_BLOB (3)</span> </dt><dd 
class="description">creating  and  using  size-based  blob
    resources is supported.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_F_CONTEXT_INIT (4)</span> </dt><dd 
class="description">
    multiple context types and synchronization timelines supported. Requires
    VIRTIO_GPU_F_VIRGL.</dd></dl>
<a 
 id="x1-372001r378"></a>
<h4 class="subsectionHead"><span class="titlemark">5.7.4   </span> <a 
 id="x1-3730004"></a>Device configuration layout</h4>
<!--l. 44--><p class="nopar" >GPU device configuration uses the following layout structure and definitions:
<!--l. 47-->
<div class="lstlisting" id="listing-96"><span class="label"><a 
 id="x1-373001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_EVENT_DISPLAY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-373002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-373003r3"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-373004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">events_read</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-373005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">events_clear</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-373006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_scanouts</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-373007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_capsets</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-373008r8"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
                                                                  

                                                                  
<a 
 id="x1-373009r374"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.4.1   </span> <a 
 id="x1-3740001"></a>Device configuration fields</h5>
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">events_read</span> </dt><dd 
class="description">signals pending events to the driver. The driver MUST NOT write
    to this field.
    </dd><dt class="description">
<span 
class="aebxti-10">events_clear</span> </dt><dd 
class="description">clears  pending  events  in  the  device.  Writing  a  ’1’  into  a  bit
    will clear the corresponding bit in <span 
class="aeti-10">events_read</span>, mimicking write-to-clear
    behavior.
    </dd><dt class="description">
<span 
class="aebxti-10">num_scanouts</span> </dt><dd 
class="description">specifies the maximum number of scanouts supported by the
    device. Minimum value is 1, maximum value is 16.
    </dd><dt class="description">
<span 
class="aebxti-10">num_capsets</span> </dt><dd 
class="description">specifies the maximum number of capability sets supported by
    the device. The minimum value is zero.</dd></dl>
<a 
 id="x1-374001r380"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.4.2   </span> <a 
 id="x1-3750002"></a>Events</h5>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_EVENT_DISPLAY</span> </dt><dd 
class="description">Display  configuration  has  changed.  The
    driver   SHOULD   use   the   VIRTIO_GPU_CMD_GET_DISPLAY_INFO
    command to fetch the information from the device. In case EDID support is
    negotiated (VIRTIO_GPU_F_EDID feature flag) the device SHOULD also
    fetch the updated EDID blobs using the VIRTIO_GPU_CMD_GET_EDID
    command.</dd></dl>
<a 
 id="x1-375001r379"></a>
<h4 class="subsectionHead"><span class="titlemark">5.7.5   </span> <a 
 id="x1-3760005"></a>Device Requirements: Device Initialization</h4>
<!--l. 85--><p class="nopar" >The driver SHOULD query the display information from the device using
the VIRTIO_GPU_CMD_GET_DISPLAY_INFO command and use that
information for the initial scanout setup. In case EDID support is negotiated
(VIRTIO_GPU_F_EDID feature flag) the device SHOULD also fetch the EDID
information using the VIRTIO_GPU_CMD_GET_EDID command. If no information
is available or all displays are disabled the driver MAY choose to use a fallback, such
as 1024x768 at display 0.
<!--l. 93--><p class="noindent" >The driver SHOULD query all shared memory regions supported by the device. If the
device supports shared memory, the <span 
class="aeti-10">shmid </span>of a region MUST (see <a 
href="#x1-10200010">2.10<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Shared Memory Regions --></a> <a 
href="#x1-10200010">Shared
Memory Regions<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Shared Memory Regions --></a>) be one of the following:
<!--l. 99-->
<div class="lstlisting" id="listing-97"><span class="label"><a 
 id="x1-376001r1"></a></span><span 
class="pcrr8t-x-x-80">enum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_shm_id</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_SHM_ID_UNDEFINED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_SHM_ID_HOST_VISIBLE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-376004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
                                                                  

                                                                  
</div>
<!--l. 106--><p class="noindent" >The shared memory region with VIRTIO_GPU_SHM_ID_HOST_VISIBLE
is referred as the "host visible memory region". The device MUST
support the VIRTIO_GPU_CMD_RESOURCE_MAP_BLOB and
VIRTIO_GPU_CMD_RESOURCE_UNMAP_BLOB if the host visible memory region
is available.
<a 
 id="x1-376005r382"></a>
<h4 class="subsectionHead"><span class="titlemark">5.7.6   </span> <a 
 id="x1-3770006"></a>Device Operation</h4>
<!--l. 113--><p class="nopar" >The virtio-gpu is based around the concept of resources private to the host. The
guest must DMA transfer into these resources, unless shared memory regions are
supported. This is a design requirement in order to interface with future 3D
rendering. In the unaccelerated 2D mode there is no support for DMA transfers from
resources, just to them.
<!--l. 119--><p class="noindent" >Resources are initially simple 2D resources, consisting of a width, height and format
along with an identifier. The guest must then attach backing store to the
resources in order for DMA transfers to work. This is like a GART in a real
GPU.
<a 
 id="x1-377001r381"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.6.1   </span> <a 
 id="x1-3780001"></a>Device Operation: Create a framebuffer and configure scanout</h5>
    <ul class="itemize1">
    <li class="itemize">Create                a                host                resource                using
    VIRTIO_GPU_CMD_RESOURCE_CREATE_2D.
    </li>
    <li class="itemize">Allocate a framebuffer from guest ram, and attach it as backing storage to
    the               resource               just               created,               using
    VIRTIO_GPU_CMD_RESOURCE_ATTACH_BACKING. Scatter lists are
    supported,  so  the  framebuffer  doesn’t  need  to  be  contignous  in  guest
    physical memory.
    </li>
    <li class="itemize">Use  VIRTIO_GPU_CMD_SET_SCANOUT  to  link  the  framebuffer  to  a
    display scanout.</li></ul>
<a 
 id="x1-378001r384"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.6.2   </span> <a 
 id="x1-3790002"></a>Device Operation: Update a framebuffer and scanout</h5>
    <ul class="itemize1">
    <li class="itemize">Render to your framebuffer memory.
    </li>
    <li class="itemize">Use VIRTIO_GPU_CMD_TRANSFER_TO_HOST_2D to update the host
    resource from guest memory.
    </li>
    <li class="itemize">Use  VIRTIO_GPU_CMD_RESOURCE_FLUSH  to  flush  the  updated
    resource to the display.</li></ul>
                                                                  

                                                                  
<a 
 id="x1-379001r385"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.6.3   </span> <a 
 id="x1-3800003"></a>Device Operation: Using pageflip</h5>
<!--l. 149--><p class="nopar" >It is possible to create multiple framebuffers, flip between them using
VIRTIO_GPU_CMD_SET_SCANOUT and VIRTIO_GPU_CMD_RESOURCE_FLUSH, and
update the invisible framebuffer using VIRTIO_GPU_CMD_TRANSFER_TO_HOST_2D.
<a 
 id="x1-380001r386"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.6.4   </span> <a 
 id="x1-3810004"></a>Device Operation: Multihead setup</h5>
<!--l. 156--><p class="nopar" >In case two or more displays are present there are different ways to configure
things:
    <ul class="itemize1">
    <li class="itemize">Create a single framebuffer, link it to all displays (mirroring).
    </li>
    <li class="itemize">Create an framebuffer for each display.
    </li>
    <li class="itemize">Create  one  big  framebuffer,  configure  scanouts  to  display  a  different
    rectangle of that framebuffer each.</li></ul>
<a 
 id="x1-381001r387"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.6.5   </span> <a 
 id="x1-3820005"></a>Device Requirements: Device Operation: Command lifecycle and
fencing</h5>
<!--l. 169--><p class="nopar" >The device MAY process controlq commands asyncronously and return them to the
driver before the processing is complete. If the driver needs to know when the
processing is finished it can set the VIRTIO_GPU_FLAG_FENCE flag in the
request. The device MUST finish the processing before returning the command
then.
<!--l. 175--><p class="noindent" >Note: current qemu implementation does asyncrounous processing only in 3d mode,
when offloading the processing to the host gpu.
<a 
 id="x1-382001r388"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.6.6   </span> <a 
 id="x1-3830006"></a>Device Operation: Configure mouse cursor</h5>
<!--l. 180--><p class="nopar" >The mouse cursor image is a normal resource, except that it must be
64x64 in size. The driver MUST create and populate the resource
(using the usual VIRTIO_GPU_CMD_RESOURCE_CREATE_2D,
VIRTIO_GPU_CMD_RESOURCE_ATTACH_BACKING and
VIRTIO_GPU_CMD_TRANSFER_TO_HOST_2D controlq commands) and make
sure they are completed (using VIRTIO_GPU_FLAG_FENCE).
<!--l. 187--><p class="noindent" >Then VIRTIO_GPU_CMD_UPDATE_CURSOR can be sent to the cursorq to set the
pointer shape and position. To move the pointer without updating the shape use
VIRTIO_GPU_CMD_MOVE_CURSOR instead.
<a 
 id="x1-383001r389"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">5.7.6.7   </span> <a 
 id="x1-3840007"></a>Device Operation: Request header</h5>
<!--l. 193--><p class="nopar" >All requests and responses on the virt queues have a fixed header using the following
layout structure and definitions:
<!--l. 196-->
<div class="lstlisting" id="listing-98"><span class="label"><a 
 id="x1-384001r1"></a></span><span 
class="pcrr8t-x-x-80">enum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_type</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80">d</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">commands</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_GET_DISPLAY_INFO</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0100</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_RESOURCE_CREATE_2D</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_RESOURCE_UNREF</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_SET_SCANOUT</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_RESOURCE_FLUSH</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_TRANSFER_TO_HOST_2D</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_RESOURCE_ATTACH_BACKING</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_RESOURCE_DETACH_BACKING</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_GET_CAPSET_INFO</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_GET_CAPSET</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_GET_EDID</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_RESOURCE_ASSIGN_UUID</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_RESOURCE_CREATE_BLOB</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_SET_SCANOUT_BLOB</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80">d</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">commands</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_CTX_CREATE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0200</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_CTX_DESTROY</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384022r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_CTX_ATTACH_RESOURCE</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_CTX_DETACH_RESOURCE</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384024r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_RESOURCE_CREATE_3D</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384025r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_TRANSFER_TO_HOST_3D</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384026r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_TRANSFER_FROM_HOST_3D</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384027r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_SUBMIT_3D</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384028r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_RESOURCE_MAP_BLOB</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384029r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_RESOURCE_UNMAP_BLOB</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384030r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384031r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cursor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">commands</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384032r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_UPDATE_CURSOR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0300</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384033r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CMD_MOVE_CURSOR</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384034r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384035r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">success</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">responses</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384036r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_OK_NODATA</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x1100</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384037r37"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_OK_DISPLAY_INFO</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384038r38"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_OK_CAPSET_INFO</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384039r39"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_OK_CAPSET</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384040r40"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_OK_EDID</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384041r41"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_OK_RESOURCE_UUID</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384042r42"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_OK_MAP_INFO</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384043r43"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384044r44"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">error</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">responses</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384045r45"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_ERR_UNSPEC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x1200</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384046r46"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_ERR_OUT_OF_MEMORY</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384047r47"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_ERR_INVALID_SCANOUT_ID</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384048r48"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_ERR_INVALID_RESOURCE_ID</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384049r49"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_ERR_INVALID_CONTEXT_ID</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384050r50"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_RESP_ERR_INVALID_PARAMETER</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384051r51"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384052r52"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384053r53"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_FLAG_FENCE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384054r54"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_FLAG_INFO_RING_IDX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384055r55"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384056r56"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384057r57"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384058r58"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384059r59"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fence_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384060r60"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ctx_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384061r61"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring_idx</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384062r62"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">[3];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-384063r63"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 262--><p class="noindent" >The fixed header <span 
class="aeti-10">struct virtio_gpu_ctrl_hdr </span>in each request includes the following
fields:
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">type</span> </dt><dd 
class="description">specifies the type of the driver request (VIRTIO_GPU_CMD_*) or device
    response (VIRTIO_GPU_RESP_*).
    </dd><dt class="description">
<span 
class="aebxti-10">flags</span> </dt><dd 
class="description">request / response flags.
    </dd><dt class="description">
<span 
class="aebxti-10">fence_id</span> </dt><dd 
class="description">If the driver sets the VIRTIO_GPU_FLAG_FENCE bit in the request <span 
class="aeti-10">flags</span>
    field the device MUST:
        <ul class="itemize1">
        <li class="itemize">set VIRTIO_GPU_FLAG_FENCE bit in the response,
        </li>
        <li class="itemize">copy the content of the <span 
class="aeti-10">fence_id </span>field from the request to the response,
        and
        </li>
        <li class="itemize">send the response only after command processing is complete.</li></ul>
    </dd><dt class="description">
<span 
class="aebxti-10">ctx_id</span> </dt><dd 
class="description">Rendering context (used in 3D mode only).
    </dd><dt class="description">
<span 
class="aebxti-10">ring_idx</span> </dt><dd 
class="description">If VIRTIO_GPU_F_CONTEXT_INIT is supported, then the driver MAY
    set VIRTIO_GPU_FLAG_INFO_RING_IDX bit in the request <span 
class="aeti-10">flags</span>. In that
    case:
        <ul class="itemize1">
        <li class="itemize"><span 
class="aeti-10">ring_idx  </span>indicates  the  value  of  a  context-specific  ring  index.  The
        minimum value is 0 and maximum value is 63 (inclusive).
        </li>
        <li class="itemize">If VIRTIO_GPU_FLAG_FENCE is set, <span 
class="aeti-10">fence_id  </span>acts as a sequence
        number on the synchronization timeline defined by <span 
class="aeti-10">ctx_idx  </span>and the
        ring index.
        </li>
        <li class="itemize">If  VIRTIO_GPU_FLAG_FENCE  is  set  and  when  the  command
        associated with <span 
class="aeti-10">fence_id </span>is complete, the device MUST send a response
                                                                  

                                                                  
        for all outstanding commands with a sequence number less than or
        equal to <span 
class="aeti-10">fence_id </span>on the same synchronization timeline.</li></ul>
    </dd></dl>
<!--l. 294--><p class="noindent" >On success the device will return VIRTIO_GPU_RESP_OK_NODATA in
case there is no payload. Otherwise the <span 
class="aeti-10">type </span>field will indicate the kind of
payload.
<!--l. 298--><p class="noindent" >On error the device will return one of the VIRTIO_GPU_RESP_ERR_* error
codes.
<a 
 id="x1-384064r390"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.6.8   </span> <a 
 id="x1-3850008"></a>Device Operation: controlq</h5>
<!--l. 303--><p class="nopar" >For any coordinates given 0,0 is top left, larger x moves right, larger y moves
down.
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_GET_DISPLAY_INFO</span> </dt><dd 
class="description">Retrieve          the          current
    output configuration. No request data (just bare <span 
class="aeti-10">struct virtio_gpu_ctrl_hdr</span>).
    Response  type  is  VIRTIO_GPU_RESP_OK_DISPLAY_INFO,  response
    data is <span 
class="aeti-10">struct virtio_gpu_resp_display_info</span>.
    <!--l. 314-->
    <div class="lstlisting" id="listing-99"><span class="label"><a 
 id="x1-385001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_MAX_SCANOUTS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385003r3"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_rect</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">x</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">y</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">width</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">height</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385008r8"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385010r10"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resp_display_info</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_display_one</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_rect</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">r</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">enabled</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pmodes</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_MAX_SCANOUTS</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385017r17"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 334--><p class="noindent" >The response contains a list of per-scanout information. The info contains
    whether the scanout is enabled and what its preferred position and size
    is.
    <!--l. 338--><p class="noindent" >The size (fields <span 
class="aeti-10">width </span>and <span 
class="aeti-10">height</span>) is similar to the native panel resolution in
    EDID display information, except that in the virtual machine case the size can
    change when the host window representing the guest display is gets
    resized.
    <!--l. 343--><p class="noindent" >The position (fields <span 
class="aeti-10">x </span>and <span 
class="aeti-10">y</span>) describe how the displays are arranged (i.e. which
    is – for example – the left display).
    <!--l. 347--><p class="noindent" >The <span 
class="aeti-10">enabled </span>field is set when the user enabled the display. It is roughly the same
    as the connected state of a phyiscal display connector.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_GET_EDID</span> </dt><dd 
class="description">Retrieve the EDID data for a given
    scanout. Request data is <span 
class="aeti-10">struct virtio_gpu_get_edid</span>). Response type is
    VIRTIO_GPU_RESP_OK_EDID, response data is <span 
class="aeti-10">struct virtio_gpu_resp_edid</span>.
    Support is optional and negotiated using the VIRTIO_GPU_F_EDID feature
    flag.
                                                                  

                                                                  
    <!--l. 357-->
    <div class="lstlisting" id="listing-100"><span class="label"><a 
 id="x1-385018r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_get_edid</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385019r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385020r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">scanout</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385021r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385022r5"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385023r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385024r7"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resp_edid</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385025r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385026r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385027r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385028r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">edid</span><span 
class="pcrr8t-x-x-80">[1024];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385029r12"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 372--><p class="noindent" >The response contains the EDID display data blob (as specified by VESA) for
    the scanout.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_RESOURCE_CREATE_2D</span> </dt><dd 
class="description">Create a 2D resource on the host.
    Request data is <span 
class="aeti-10">struct virtio_gpu_resource_create_2d</span>. Response type is
    VIRTIO_GPU_RESP_OK_NODATA.
    <!--l. 379-->
    <div class="lstlisting" id="listing-101"><span class="label"><a 
 id="x1-385030r1"></a></span><span 
class="pcrr8t-x-x-80">enum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_formats</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385031r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_FORMAT_B8G8R8A8_UNORM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385032r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_FORMAT_B8G8R8X8_UNORM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385033r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_FORMAT_A8R8G8B8_UNORM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385034r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_FORMAT_X8R8G8B8_UNORM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385035r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385036r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_FORMAT_R8G8B8A8_UNORM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">67,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385037r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_FORMAT_X8B8G8R8_UNORM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">68,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385038r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385039r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_FORMAT_A8B8G8R8_UNORM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">121,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385040r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_FORMAT_R8G8B8X8_UNORM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">134,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385041r12"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385042r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385043r14"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resource_create_2d</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385044r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385045r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resource_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385046r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">format</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385047r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">width</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385048r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">height</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385049r20"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 402--><p class="noindent" >This creates a 2D resource on the host with the specified width, height and
    format. The resource ids are generated by the guest.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_RESOURCE_UNREF</span> </dt><dd 
class="description">Destroy a resource. Request data is <span 
class="aeti-10">struct</span>
    <span 
class="aeti-10">virtio_gpu_resource_unref</span>. Response type is VIRTIO_GPU_RESP_OK_NODATA.
    <!--l. 409-->
    <div class="lstlisting" id="listing-102"><span class="label"><a 
 id="x1-385050r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resource_unref</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385051r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385052r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resource_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385053r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385054r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 417--><p class="noindent" >This informs the host that a resource is no longer required by the guest.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_SET_SCANOUT</span> </dt><dd 
class="description">Set the scanout parameters for a single
    output. Request data is <span 
class="aeti-10">struct virtio_gpu_set_scanout</span>. Response type is
    VIRTIO_GPU_RESP_OK_NODATA.
    <!--l. 425-->
    <div class="lstlisting" id="listing-103"><span class="label"><a 
 id="x1-385055r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_set_scanout</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385056r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385057r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_rect</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">r</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385058r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">scanout_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385059r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resource_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385060r6"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 434--><p class="noindent" >This sets the scanout parameters for a single scanout. The resource_id is the
    resource to be scanned out from, along with a rectangle.
    <!--l. 437--><p class="noindent" >Scanout rectangles must be completely covered by the underlying resource.
    Overlapping (or identical) scanouts are allowed, typical use case is screen
    mirroring.
                                                                  

                                                                  
    <!--l. 441--><p class="noindent" >The driver can use resource_id = 0 to disable a scanout.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_RESOURCE_FLUSH</span> </dt><dd 
class="description">Flush a scanout resource
    Request data is <span 
class="aeti-10">struct virtio_gpu_resource_flush</span>. Response type is
    VIRTIO_GPU_RESP_OK_NODATA.
    <!--l. 447-->
    <div class="lstlisting" id="listing-104"><span class="label"><a 
 id="x1-385061r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resource_flush</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385062r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385063r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_rect</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">r</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385064r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resource_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385065r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385066r6"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 456--><p class="noindent" >This flushes a resource to screen. It takes a rectangle and a resource id, and
    flushes any scanouts the resource is being used on.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_TRANSFER_TO_HOST_2D</span> </dt><dd 
class="description">Transfer from guest memory to
    host resource. Request data is <span 
class="aeti-10">struct virtio_gpu_transfer_to_host_2d</span>. Response
    type is VIRTIO_GPU_RESP_OK_NODATA.
    <!--l. 464-->
    <div class="lstlisting" id="listing-105"><span class="label"><a 
 id="x1-385067r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_transfer_to_host_2d</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385068r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385069r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_rect</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">r</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385070r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">offset</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385071r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resource_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385072r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385073r7"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 474--><p class="noindent" >This takes a resource id along with an destination offset into the resource, and a
    box to transfer to the host backing for the resource.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_RESOURCE_ATTACH_BACKING</span> </dt><dd 
class="description">Assign backing pages to
    a resource. Request data is <span 
class="aeti-10">struct virtio_gpu_resource_attach_backing</span>,
    followed by <span 
class="aeti-10">struct virtio_gpu_mem_entry </span>entries. Response type is
    VIRTIO_GPU_RESP_OK_NODATA.
    <!--l. 483-->
    <div class="lstlisting" id="listing-106"><span class="label"><a 
 id="x1-385074r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resource_attach_backing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385075r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385076r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resource_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385077r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">nr_entries</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385078r5"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385079r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385080r7"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_mem_entry</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385081r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">addr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385082r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385083r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385084r11"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 497--><p class="noindent" >This assign an array of guest pages as the backing store for a resource. These
    pages are then used for the transfer operations for that resource from that point
    on.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_RESOURCE_DETACH_BACKING</span> </dt><dd 
class="description">Detach backing pages from
    a resource. Request data is <span 
class="aeti-10">struct virtio_gpu_resource_detach_backing</span>. Response
    type is VIRTIO_GPU_RESP_OK_NODATA.
    <!--l. 506-->
                                                                  

                                                                  
    <div class="lstlisting" id="listing-107"><span class="label"><a 
 id="x1-385085r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resource_detach_backing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385086r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385087r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resource_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385088r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385089r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 514--><p class="noindent" >This detaches any backing pages from a resource, to be used in case of guest
    swapping or object destruction.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_GET_CAPSET_INFO</span> </dt><dd 
class="description">Gets the information associated with a
    particular <span 
class="aeti-10">capset_index</span>, which MUST less than <span 
class="aeti-10">num_capsets </span>defined in the
    device configuration. Request data is <span 
class="aeti-10">struct virtio_gpu_get_capset_info</span>. Response
    type is VIRTIO_GPU_RESP_OK_CAPSET_INFO.
    <!--l. 523--><p class="noindent" >On success, <span 
class="aeti-10">struct virtio_gpu_resp_capset_info </span>contains the <span 
class="aeti-10">capset_id</span>,
    <span 
class="aeti-10">capset_max_version</span>, <span 
class="aeti-10">capset_max_size </span>associated with capset at the specified
    capset_idex. fieldcapset_id MUST be one of the following (see listing for
    values):
        <ul class="itemize1">
        <li class="itemize"><a 
href="https://gitlab.freedesktop.org/virgl/virglrenderer/-/blob/master/src/virgl_hw.h#L526" >VIRTIO_GPU_CAPSET_VIRGL</a> – the first edition of Virgl (Gallium
        OpenGL) protocol.
        </li>
        <li class="itemize"><a 
href="https://gitlab.freedesktop.org/virgl/virglrenderer/-/blob/master/src/virgl_hw.h#L550" >VIRTIO_GPU_CAPSET_VIRGL2</a>  –  the  second  edition  of  Virgl
        (Gallium OpenGL) protocol after the capset fix.
        </li>
        <li class="itemize"><a 
href="https://android.googlesource.com/device/generic/vulkan-cereal/+/refs/heads/master/protocols/" >VIRTIO_GPU_CAPSET_GFXSTREAM</a>    –    gfxtream’s    (mostly)
        autogenerated GLES and Vulkan streaming protocols.
        </li>
        <li class="itemize"><a 
href="https://gitlab.freedesktop.org/olv/venus-protocol" >VIRTIO_GPU_CAPSET_VENUS</a>  –  Mesa’s  (mostly)  autogenerated
        Vulkan protocol.
        </li>
        <li class="itemize"><a 
href="https://chromium.googlesource.com/chromiumos/platform/crosvm/+/refs/heads/main/rutabaga_gfx/src/cross_domain/cross_domain_protocol.rs" >VIRTIO_GPU_CAPSET_CROSS_DOMAIN</a>  –  protocol  for  display
        virtualization via Wayland proxying.</li></ul>
    <!--l. 541-->
    <div class="lstlisting" id="listing-108"><span class="label"><a 
 id="x1-385090r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_get_capset_info</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385091r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385092r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">capset_index</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385093r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385094r5"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385095r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385096r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CAPSET_VIRGL</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385097r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CAPSET_VIRGL2</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385098r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CAPSET_GFXSTREAM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385099r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CAPSET_VENUS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385100r11"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CAPSET_CROSS_DOMAIN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385101r12"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resp_capset_info</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385102r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385103r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">capset_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385104r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">capset_max_version</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385105r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">capset_max_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385106r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385107r18"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_GET_CAPSET</span> </dt><dd 
class="description">Gets the capset associated with a particular
    <span 
class="aeti-10">capset_id </span>and <span 
class="aeti-10">capset_version</span>. Request data is <span 
class="aeti-10">struct virtio_gpu_get_capset</span>.
    Response type is VIRTIO_GPU_RESP_OK_CAPSET.
    <!--l. 567-->
    <div class="lstlisting" id="listing-109"><span class="label"><a 
 id="x1-385108r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_get_capset</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385109r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385110r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">capset_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385111r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">capset_version</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385112r5"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385113r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385114r7"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resp_capset</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385115r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385116r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">capset_data</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385117r10"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
                                                                  

                                                                  
    </div>
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_RESOURCE_ASSIGN_UUID</span> </dt><dd 
class="description">Creates an exported object from
    a resource. Request data is <span 
class="aeti-10">struct virtio_gpu_resource_assign_uuid</span>. Response type
    is VIRTIO_GPU_RESP_OK_RESOURCE_UUID, response data is <span 
class="aeti-10">struct</span>
    <span 
class="aeti-10">virtio_gpu_resp_resource_uuid</span>. Support is optional and negotiated using the
    VIRTIO_GPU_F_RESOURCE_UUID feature flag.
    <!--l. 587-->
    <div class="lstlisting" id="listing-110"><span class="label"><a 
 id="x1-385118r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resource_assign_uuid</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385119r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385120r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resource_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385121r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385122r5"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385123r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385124r7"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resp_resource_uuid</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385125r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385126r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">uuid</span><span 
class="pcrr8t-x-x-80">[16];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385127r10"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 600--><p class="noindent" >The response contains a UUID which identifies the exported object created from
    the host private resource. Note that if the resource has an attached backing,
    modifications made to the host private resource through the exported object by
    other devices are not visible in the attached backing until they are transferred
    into the backing.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_RESOURCE_CREATE_BLOB</span> </dt><dd 
class="description">Creates a virtio-gpu
    blob resource. Request data is <span 
class="aeti-10">struct virtio_gpu_resource_create_blob</span>,
    followed by <span 
class="aeti-10">struct virtio_gpu_mem_entry </span>entries. Response type is
    VIRTIO_GPU_RESP_OK_NODATA. Support is optional and negotiated using
    the VIRTIO_GPU_F_RESOURCE_BLOB feature flag.
    <!--l. 613-->
    <div class="lstlisting" id="listing-111"><span class="label"><a 
 id="x1-385128r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_BLOB_MEM_GUEST</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0001</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385129r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_BLOB_MEM_HOST3D</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0002</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385130r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_BLOB_MEM_HOST3D_GUEST</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0003</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385131r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385132r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_BLOB_FLAG_USE_MAPPABLE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0001</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385133r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_BLOB_FLAG_USE_SHAREABLE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0002</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385134r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_BLOB_FLAG_USE_CROSS_DEVICE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0004</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385135r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385136r9"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resource_create_blob</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385137r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385138r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resource_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385139r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">blob_mem</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385140r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">blob_flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385141r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">nr_entries</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385142r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">blob_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385143r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385144r17"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 634--><p class="noindent" >A blob resource is a container for:
        <ul class="itemize1">
        <li class="itemize">a guest memory allocation (referred to as a "guest-only blob resource").
        </li>
        <li class="itemize">a host memory allocation (referred to as a "host-only blob resource").
        </li>
        <li class="itemize">a guest memory and host memory allocation (referred to as a "default
        blob resource").</li></ul>
    <!--l. 645--><p class="noindent" >The memory properties of the blob resource MUST be described by <span 
class="aeti-10">blob_mem</span>,
    which MUST be non-zero.
    <!--l. 648--><p class="noindent" >For default and guest-only blob resources, <span 
class="aeti-10">nr_entries </span>guest memory entries
    may be assigned to the resource. For default blob resources (i.e, when
    <span 
class="aeti-10">blob_mem </span>is VIRTIO_GPU_BLOB_MEM_HOST3D_GUEST), these memory
                                                                  

                                                                  
    entries are used as a shadow buffer for the host memory. To facilitate
    drivers that support swap-in and swap-out, <span 
class="aeti-10">nr_entries </span>may be zero and
    VIRTIO_GPU_CMD_RESOURCE_ATTACH_BACKING may be subsequently
    used. VIRTIO_GPU_CMD_RESOURCE_DETACH_BACKING may be used to
    unassign memory entries.
    <!--l. 656--><p class="noindent" ><span 
class="aeti-10">blob_mem </span>can only be VIRTIO_GPU_BLOB_MEM_HOST3D and
    VIRTIO_GPU_BLOB_MEM_HOST3D_GUEST if VIRTIO_GPU_F_VIRGL is
    supported. VIRTIO_GPU_BLOB_MEM_GUEST is valid regardless whether
    VIRTIO_GPU_F_VIRGL is supported or not.
    <!--l. 661--><p class="noindent" >For VIRTIO_GPU_BLOB_MEM_HOST3D and VIRTIO_GPU_BLOB_MEM_HOST3D_GUEST,
    the virtio-gpu resource MUST be created from the rendering context
    local object identified by the <span 
class="aeti-10">blob_id</span>. The actual allocation is done via
    VIRTIO_GPU_CMD_SUBMIT_3D.
    <!--l. 666--><p class="noindent" >The driver MUST inform the device if the blob resource is used for memory
    access, sharing between driver instances and/or sharing with other devices. This
    is done via the <span 
class="aeti-10">blob_flags </span>field.
    <!--l. 670--><p class="noindent" >If VIRTIO_GPU_F_VIRGL is set, both VIRTIO_GPU_CMD_TRANSFER_TO_HOST_3D
    and VIRTIO_GPU_CMD_TRANSFER_FROM_HOST_3D may be used to
    update the resource. There is no restriction on the image/buffer view the driver
    has on the blob resource.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_SET_SCANOUT_BLOB</span> </dt><dd 
class="description">sets scanout parameters for a blob
    resource. Request data is <span 
class="aeti-10">struct virtio_gpu_set_scanout_blob</span>. Response type is
    VIRTIO_GPU_RESP_OK_NODATA. Support is optional and negotiated using
    the VIRTIO_GPU_F_RESOURCE_BLOB feature flag.
    <!--l. 681-->
    <div class="lstlisting" id="listing-112"><span class="label"><a 
 id="x1-385147r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_set_scanout_blob</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385148r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385149r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_rect</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">r</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385150r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">scanout_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385151r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resource_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385152r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">width</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385153r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">height</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385154r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">format</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385155r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385156r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">strides</span><span 
class="pcrr8t-x-x-80">[4];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385157r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">offsets</span><span 
class="pcrr8t-x-x-80">[4];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-385158r12"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 696--><p class="noindent" >The rectangle <span 
class="aeti-10">r </span>represents the portion of the blob resource being displayed. The
    rest is the metadata associated with the blob resource. The format MUST be
    one of <span 
class="aeti-10">enum virtio_gpu_formats</span>. The format MAY be compressed with header
    and data planes.
    </dd></dl>
<a 
 id="x1-385159r391"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.6.9   </span> <a 
 id="x1-3860009"></a>Device Operation: controlq (3d)</h5>
<!--l. 705--><p class="nopar" >These commands are supported by the device if the VIRTIO_GPU_F_VIRGL feature
flag is set.
    <dl class="description"><dt class="description">
                                                                  

                                                                  
<span 
class="aeb10-">VIRTIO_GPU_CMD_CTX_CREATE</span> </dt><dd 
class="description">creates  a  context  for  submitting  an
    opaque  command  stream.  Request  data  is  <span 
class="aeti-10">struct  virtio_gpu_ctx_create</span>.
    Response type is VIRTIO_GPU_RESP_OK_NODATA.
    <!--l. 714-->
    <div class="lstlisting" id="listing-113"><span class="label"><a 
 id="x1-386001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_CONTEXT_INIT_CAPSET_ID_MASK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x000000ff</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386002r2"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctx_create</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">nlen</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">context_init</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">char</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">debug_name</span><span 
class="pcrr8t-x-x-80">[64];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386007r7"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    <!--l. 724--><p class="noindent" >The implementation MUST create a context for the given <span 
class="aeti-10">ctx_id </span>in the <span 
class="aeti-10">hdr</span>. For
    debugging purposes, a <span 
class="aeti-10">debug_name </span>and it’s length <span 
class="aeti-10">nlen </span>is provided by the
    driver. If VIRTIO_GPU_F_CONTEXT_INIT is supported, then lower 8 bits of
    <span 
class="aeti-10">context_init </span>MAY contain the <span 
class="aeti-10">capset_id </span>associated with context. In that case,
    then the device MUST create a context that can handle the specified command
    stream.
    <!--l. 732--><p class="noindent" >If the lower 8-bits of the <span 
class="aeti-10">context_init </span>are zero, then the type of the context is
    determined by the device.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_CTX_DESTROY</span> </dt><dd 
class="description">
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_CTX_ATTACH_RESOURCE</span> </dt><dd 
class="description">
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_CTX_DETACH_RESOURCE</span> </dt><dd 
class="description">Manage virtio-gpu 3d
    contexts.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_RESOURCE_CREATE_3D</span> </dt><dd 
class="description">Create virtio-gpu 3d resources.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_TRANSFER_TO_HOST_3D</span> </dt><dd 
class="description">
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_TRANSFER_FROM_HOST_3D</span> </dt><dd 
class="description">Transfer data from and to
    virtio-gpu 3d resources.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_SUBMIT_3D</span> </dt><dd 
class="description">Submit an opaque command stream. The type of
    the command stream is determined when creating a context.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_RESOURCE_MAP_BLOB</span> </dt><dd 
class="description">maps a host-only blob resource
    into an offset in the host visible memory region. Request data is <span 
class="aeti-10">struct</span>
    <span 
class="aeti-10">virtio_gpu_resource_map_blob</span>. The driver MUST not map a blob resource that is
    already mapped. Response type is VIRTIO_GPU_RESP_OK_MAP_INFO. Support
    is optional and negotiated using the VIRTIO_GPU_F_RESOURCE_BLOB
    feature flag and checking for the presence of the host visible memory
                                                                  

                                                                  
    region.
    <!--l. 759-->
    <div class="lstlisting" id="listing-114"><span class="label"><a 
 id="x1-386008r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resource_map_blob</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386009r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386010r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resource_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386011r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386012r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">offset</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386013r6"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386014r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386015r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_MAP_CACHE_MASK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0f</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386016r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_MAP_CACHE_NONE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x00</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386017r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_MAP_CACHE_CACHED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x01</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386018r11"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_MAP_CACHE_UNCACHED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x02</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386019r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPU_MAP_CACHE_WC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x03</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386020r13"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resp_map_info</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386021r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386022r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">map_info</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386023r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386024r17"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_RESOURCE_UNMAP_BLOB</span> </dt><dd 
class="description">unmaps a host-only blob
    resource from the host visible memory region. Request data is <span 
class="aeti-10">struct</span>
    <span 
class="aeti-10">virtio_gpu_resource_unmap_blob</span>. Response type is VIRTIO_GPU_RESP_OK_NODATA.
    Support is optional and negotiated using the VIRTIO_GPU_F_RESOURCE_BLOB
    feature flag and checking for the presence of the host visible memory
    region.
    <!--l. 786-->
    <div class="lstlisting" id="listing-115"><span class="label"><a 
 id="x1-386025r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_resource_unmap_blob</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386026r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386027r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resource_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386028r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-386029r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    </dd></dl>
<a 
 id="x1-386030r392"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.7.6.10   </span> <a 
 id="x1-38700010"></a>Device Operation: cursorq</h5>
<!--l. 798--><p class="nopar" >Both cursorq commands use the same command struct.
<!--l. 800-->
<div class="lstlisting" id="listing-116"><span class="label"><a 
 id="x1-387001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_cursor_pos</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-387002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">scanout_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-387003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">x</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-387004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">y</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-387005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-387006r6"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-387007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-387008r8"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_update_cursor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-387009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_ctrl_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-387010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpu_cursor_pos</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pos</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-387011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resource_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-387012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hot_x</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-387013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hot_y</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-387014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-387015r15"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_UPDATE_CURSOR</span> </dt><dd 
class="description">
    Update cursor. Request data is <span 
class="aeti-10">struct virtio_gpu_update_cursor</span>. Response
    type is VIRTIO_GPU_RESP_OK_NODATA.
    <!--l. 825--><p class="noindent" >Full cursor update. Cursor will be loaded from the specified <span 
class="aeti-10">resource_id</span>
    and will be moved to <span 
class="aeti-10">pos</span>. The driver must transfer the cursor into the
    resource beforehand (using control queue commands) and make sure the
    commands to fill the resource are actually processed (using fencing).
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_GPU_CMD_MOVE_CURSOR</span> </dt><dd 
class="description">Move
    cursor. Request data is <span 
class="aeti-10">struct virtio_gpu_update_cursor</span>. Response type is
    VIRTIO_GPU_RESP_OK_NODATA.
                                                                  

                                                                  
    <!--l. 836--><p class="noindent" >Move cursor to the place specified in <span 
class="aeti-10">pos</span>. The other fields are not used and
    will be ignored by the device.
    </dd></dl>
<a 
 id="x1-387016r383"></a>
<h4 class="subsectionHead"><span class="titlemark">5.7.7   </span> <a 
 id="x1-3880007"></a>VGA Compatibility</h4>
<!--l. 843--><p class="nopar" >Applies to Virtio Over PCI only. The GPU device can come with and without VGA
compatibility. The PCI class should be DISPLAY_VGA if VGA compatibility is
present and DISPLAY_OTHER otherwise.
<!--l. 847--><p class="noindent" >VGA compatibility: PCI region 0 has the linear framebuffer, standard vga registers
are present. Configuring a scanout (VIRTIO_GPU_CMD_SET_SCANOUT) switches
the device from vga compatibility mode into native virtio mode. A reset switches it
back into vga compatibility mode.
<!--l. 853--><p class="noindent" >Note: qemu implementation also provides bochs dispi interface io ports and mmio bar
at pci region 1 and is therefore fully compatible with the qemu stdvga (see
<a 
href="https://git.qemu-project.org/?p=qemu.git;a=blob;f=docs/specs/standard-vga.txt;hb=HEAD" >docs/specs/standard-vga.txt</a> in the qemu source tree).
<a 
 id="x1-388001r375"></a>
<h3 class="sectionHead"><span class="titlemark">5.8   </span> <a 
 id="x1-3890008"></a>Input Device</h3>
<!--l. 3--><p class="nopar" >The virtio input device can be used to create virtual human interface devices such as
keyboards, mice and tablets. An instance of the virtio device represents one such
input device. Device behavior mirrors that of the evdev layer in Linux, making
pass-through implementations on top of evdev easy.
<!--l. 9--><p class="noindent" >This specification defines how evdev events are transported over virtio and how
the set of supported events is discovered by a driver. It does not, however,
define the semantics of input events as this is dependent on the particular
evdev implementation. For the list of events used by Linux input devices, see
<a 
href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/include/uapi/linux/input-event-codes.h" >include/uapi/linux/input-event-codes.h</a> in the Linux source tree.
<a 
 id="x1-389001r394"></a>
<h4 class="subsectionHead"><span class="titlemark">5.8.1   </span> <a 
 id="x1-3900001"></a>Device ID</h4>
<!--l. 19--><p class="nopar" >18
<a 
 id="x1-390001r396"></a>
<h4 class="subsectionHead"><span class="titlemark">5.8.2   </span> <a 
 id="x1-3910002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">eventq
    </dd><dt class="description">
<span 
class="aeb10-">1</span> </dt><dd 
class="description">statusq</dd></dl>
<a 
 id="x1-391001r397"></a>
<h4 class="subsectionHead"><span class="titlemark">5.8.3   </span> <a 
 id="x1-3920003"></a>Feature bits</h4>
<!--l. 30--><p class="nopar" >None.
                                                                  

                                                                  
<a 
 id="x1-392001r398"></a>
<h4 class="subsectionHead"><span class="titlemark">5.8.4   </span> <a 
 id="x1-3930004"></a>Device configuration layout</h4>
<!--l. 34--><p class="nopar" >Device configuration holds all information the guest needs to handle the device, most
importantly the events which are supported.
<!--l. 37-->
<div class="lstlisting" id="listing-117"><span class="label"><a 
 id="x1-393001r1"></a></span><span 
class="pcrr8t-x-x-80">enum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_input_config_select</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_INPUT_CFG_UNSET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x00</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_INPUT_CFG_ID_NAME</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x01</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_INPUT_CFG_ID_SERIAL</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x02</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_INPUT_CFG_ID_DEVIDS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x03</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_INPUT_CFG_PROP_BITS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x10</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_INPUT_CFG_EV_BITS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x11</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_INPUT_CFG_ABS_INFO</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x12</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393009r9"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393011r11"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_input_absinfo</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">min</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fuzz</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flat</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">res</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393017r17"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393019r19"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_input_devids</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bustype</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">vendor</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393022r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">product</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">version</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393024r24"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393025r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393026r26"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_input_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393027r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">select</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393028r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">subsel</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393029r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393030r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">[5];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393031r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">union</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393032r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">char</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">string</span><span 
class="pcrr8t-x-x-80">[128];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393033r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bitmap</span><span 
class="pcrr8t-x-x-80">[128];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393034r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_input_absinfo</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">abs</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393035r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_input_devids</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ids</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393036r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-393037r37"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 77--><p class="noindent" >To query a specific piece of information the driver sets <span 
class="aeti-10">select </span>and <span 
class="aeti-10">subsel </span>accordingly,
then checks <span 
class="aeti-10">size </span>to see how much information is available. <span 
class="aeti-10">size </span>can be zero if no
information is available. Strings do not include a NUL terminator. Related evdev
ioctl names are provided for reference.
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_INPUT_CFG_ID_NAME</span> </dt><dd 
class="description"><span 
class="aeti-10">subsel  </span>is  zero.  Returns  the  name  of  the
    device, in <span 
class="aeti-10">u.string</span>.
    <!--l. 88--><p class="noindent" >Similar to EVIOCGNAME ioctl for Linux evdev devices.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_INPUT_CFG_ID_SERIAL</span> </dt><dd 
class="description"><span 
class="aeti-10">subsel  </span>is zero. Returns the serial number
    of the device, in <span 
class="aeti-10">u.string</span>.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_INPUT_CFG_ID_DEVIDS</span> </dt><dd 
class="description"><span 
class="aeti-10">subsel </span>is zero. Returns ID information of
    the device, in <span 
class="aeti-10">u.ids</span>.
    <!--l. 98--><p class="noindent" >Similar to EVIOCGID ioctl for Linux evdev devices.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_INPUT_CFG_PROP_BITS</span> </dt><dd 
class="description"><span 
class="aeti-10">subsel  </span>is  zero.  Returns  input  properties
    of the device, in <span 
class="aeti-10">u.bitmap</span>. Individual bits in the bitmap correspond to
    INPUT_PROP_* constants used by the underlying evdev implementation.
    <!--l. 106--><p class="noindent" >Similar to EVIOCGPROP ioctl for Linux evdev devices.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_INPUT_CFG_EV_BITS</span> </dt><dd 
class="description"><span 
class="aeti-10">subsel  </span>specifies  the  event  type  using  EV_*
    constants  in  the  underlying  evdev  implementation.  If  <span 
class="aeti-10">size  </span>is  non-zero
    the  event  type  is  supported  and  a  bitmap  of  supported  event  codes
    is  returned  in  <span 
class="aeti-10">u.bitmap</span>.  Individual  bits  in  the  bitmap  correspond  to
    implementation-defined input event codes, for example keys or pointing
    device axes.
    <!--l. 117--><p class="noindent" >Similar to EVIOCGBIT ioctl for Linux evdev devices.
    </dd><dt class="description">
                                                                  

                                                                  
<span 
class="aeb10-">VIRTIO_INPUT_CFG_ABS_INFO</span> </dt><dd 
class="description"><span 
class="aeti-10">subsel  </span>specifies  the  absolute  axis  using
    ABS_*  constants  in  the  underlying  evdev  implementation.  Information
    about the axis will be returned in <span 
class="aeti-10">u.abs</span>.
    <!--l. 124--><p class="noindent" >Similar to EVIOCGABS ioctl for Linux evdev devices.
    </dd></dl>
<a 
 id="x1-393038r399"></a>
<h4 class="subsectionHead"><span class="titlemark">5.8.5   </span> <a 
 id="x1-3940005"></a>Device Initialization</h4>
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-394002x1">The device is queried for supported event types and codes.
    </li>
    <li 
  class="enumerate" id="x1-394004x2">The eventq is populated with receive buffers.</li></ol>
<a 
 id="x1-394005r393"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.8.5.1   </span> <a 
 id="x1-3950001"></a>Driver Requirements: Device Initialization</h5>
<!--l. 136--><p class="nopar" >A driver MUST set both <span 
class="aeti-10">select </span>and <span 
class="aeti-10">subsel </span>when querying device configuration, in any
order.
<!--l. 139--><p class="noindent" >A driver MUST NOT write to configuration fields other than <span 
class="aeti-10">select </span>and
<span 
class="aeti-10">subsel</span>.
<!--l. 142--><p class="noindent" >A driver SHOULD check the <span 
class="aeti-10">size </span>field before accessing the configuration
information.
<a 
 id="x1-395001r401"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.8.5.2   </span> <a 
 id="x1-3960002"></a>Device Requirements: Device Initialization</h5>
<!--l. 146--><p class="nopar" >A device MUST set the <span 
class="aeti-10">size </span>field to zero if it doesn’t support a given <span 
class="aeti-10">select </span>and
<span 
class="aeti-10">subsel </span>combination.
<a 
 id="x1-396001r400"></a>
<h4 class="subsectionHead"><span class="titlemark">5.8.6   </span> <a 
 id="x1-3970006"></a>Device Operation</h4>
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-397002x1">Input events such as press and release events for keys and buttons, and
    motion events for pointing devices are sent from the device to the driver
    using the eventq.
    </li>
    <li 
  class="enumerate" id="x1-397004x2">Status feedback such as keyboard LED updates are sent from the driver to
    the device using the statusq.
    </li>
    <li 
  class="enumerate" id="x1-397006x3">Both queues use the same virtio_input_event struct. <span 
class="aeti-10">type</span>, <span 
class="aeti-10">code </span>and <span 
class="aeti-10">value</span>
    are filled according to the Linux input layer (evdev) interface, except that
    the fields are in little endian byte order whereas the evdev ioctl interface
    uses native endian-ness.</li></ol>
                                                                  

                                                                  
<!--l. 164-->
<div class="lstlisting" id="listing-118"><span class="label"><a 
 id="x1-397007r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_input_event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-397008r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-397009r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">code</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-397010r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">value</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-397011r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-397012r402"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.8.6.1   </span> <a 
 id="x1-3980001"></a>Driver Requirements: Device Operation</h5>
<!--l. 174--><p class="nopar" >A driver SHOULD keep the eventq populated with buffers. These buffers MUST be
device-writable and MUST be at least the size of struct virtio_input_event.
<!--l. 178--><p class="noindent" >Buffers placed into the statusq by a driver MUST be at least the size of struct
virtio_input_event.
<!--l. 181--><p class="noindent" >A driver SHOULD ignore eventq input events it does not recognize. Note that evdev
devices generally maintain backward compatibility by sending redundant events and
relying on the consuming side using only the events it understands and ignoring the
rest.
<a 
 id="x1-398001r404"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.8.6.2   </span> <a 
 id="x1-3990002"></a>Device Requirements: Device Operation</h5>
<!--l. 188--><p class="nopar" >A device MAY drop input events if the eventq does not have enough available
buffers. It SHOULD NOT drop individual input events if they are part of a
sequence forming one input device update. For example, a pointing device
update typically consists of several input events, one for each axis, and a
terminating EV_SYN event. A device SHOULD either buffer or drop the entire
sequence.
<a 
 id="x1-399001r395"></a>
<h3 class="sectionHead"><span class="titlemark">5.9   </span> <a 
 id="x1-4000009"></a>Crypto Device</h3>
<!--l. 3--><p class="nopar" >The virtio crypto device is a virtual cryptography device as well as a virtual
cryptographic accelerator. The virtio crypto device provides the following crypto
services: CIPHER, MAC, HASH, and AEAD. Virtio crypto devices have a single
control queue and at least one data queue. Crypto operation requests are placed into
a data queue, and serviced by the device. Some crypto operation requests are only
valid in the context of a session. The role of the control queue is facilitating control
operation requests. Sessions management is realized with control operation
requests.
<a 
 id="x1-400001r403"></a>
<h4 class="subsectionHead"><span class="titlemark">5.9.1   </span> <a 
 id="x1-4010001"></a>Device ID</h4>
<!--l. 15--><p class="nopar" >20
<a 
 id="x1-401001r407"></a>
<h4 class="subsectionHead"><span class="titlemark">5.9.2   </span> <a 
 id="x1-4020002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
                                                                  

                                                                  
<span 
class="aeb10-">0</span> </dt><dd 
class="description">dataq1
    </dd><dt class="description">
<span 
class="aeb10-">…</span> </dt><dd 
class="description">
    </dd><dt class="description">
<span 
class="aeb10-">N-1</span> </dt><dd 
class="description">dataqN
    </dd><dt class="description">
<span 
class="aeb10-">N</span> </dt><dd 
class="description">controlq</dd></dl>
<!--l. 26--><p class="nopar" >N is set by <span 
class="aeti-10">max_dataqueues</span>.
<a 
 id="x1-402001r408"></a>
<h4 class="subsectionHead"><span class="titlemark">5.9.3   </span> <a 
 id="x1-4030003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
 </dt><dd 
class="description">VIRTIO_CRYPTO_F_REVISION_1 (0) revision 1. Revision 1 has a specific
    request format and other enhancements (which result in some additional
    requirements).
    </dd><dt class="description">
 </dt><dd 
class="description">VIRTIO_CRYPTO_F_CIPHER_STATELESS_MODE   (1)   stateless   mode
    requests are supported by the CIPHER service.
    </dd><dt class="description">
 </dt><dd 
class="description">VIRTIO_CRYPTO_F_HASH_STATELESS_MODE (2) stateless mode requests
    are supported by the HASH service.
    </dd><dt class="description">
 </dt><dd 
class="description">VIRTIO_CRYPTO_F_MAC_STATELESS_MODE (3) stateless mode requests
    are supported by the MAC service.
    </dd><dt class="description">
 </dt><dd 
class="description">VIRTIO_CRYPTO_F_AEAD_STATELESS_MODE    (4)    stateless    mode
    requests are supported by the AEAD service.</dd></dl>
<a 
 id="x1-403001r405"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.3.1   </span> <a 
 id="x1-4040001"></a>Feature bit requirements</h5>
<!--l. 47--><p class="nopar" >Some crypto feature bits require other crypto feature bits (see <a 
href="#x1-150001">2.2.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Feature Bits --></a>):
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_CRYPTO_F_CIPHER_STATELESS_MODE</span> </dt><dd 
class="description">Requires
    VIRTIO_CRYPTO_F_REVISION_1.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_CRYPTO_F_HASH_STATELESS_MODE</span> </dt><dd 
class="description">Requires
    VIRTIO_CRYPTO_F_REVISION_1.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_CRYPTO_F_MAC_STATELESS_MODE</span> </dt><dd 
class="description">Requires
    VIRTIO_CRYPTO_F_REVISION_1.
                                                                  

                                                                  
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_CRYPTO_F_AEAD_STATELESS_MODE</span> </dt><dd 
class="description">Requires
    VIRTIO_CRYPTO_F_REVISION_1.</dd></dl>
<a 
 id="x1-404001r409"></a>
<h4 class="subsectionHead"><span class="titlemark">5.9.4   </span> <a 
 id="x1-4050004"></a>Supported crypto services</h4>
<!--l. 59--><p class="nopar" >The following crypto services are defined:
<!--l. 61-->
<div class="lstlisting" id="listing-119"><span class="label"><a 
 id="x1-405001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CIPHER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">service</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-405002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_CIPHER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-405003r3"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">HASH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">service</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-405004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_HASH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-405005r5"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">MAC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">Message</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Authentication</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Codes</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">service</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-405006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_MAC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-405007r7"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">AEAD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">Authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Encryption</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Associated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Data</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">service</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-405008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_AEAD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span>
</div>
<!--l. 72--><p class="noindent" >The above constants designate bits used to indicate the which of crypto services are
offered by the device as described in, see <a 
href="#x1-4100005">5.9.5<!--tex4ht:ref: sec:Device Types / Crypto Device / Device configuration layout --></a>.
<a 
 id="x1-405009r410"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.4.1   </span> <a 
 id="x1-4060001"></a>CIPHER services</h5>
<!--l. 77--><p class="nopar" >The following CIPHER algorithms are defined:
<!--l. 79-->
<div class="lstlisting" id="listing-120"><span class="label"><a 
 id="x1-406001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_NO_CIPHER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-406002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_ARC4</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-406003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_AES_ECB</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-406004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_AES_CBC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-406005r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_AES_CTR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-406006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_DES_ECB</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-406007r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_DES_CBC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-406008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_3DES_ECB</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-406009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_3DES_CBC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-406010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_3DES_CTR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-406011r11"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_KASUMI_F8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">10</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-406012r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_SNOW3G_UEA2</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">11</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-406013r13"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_AES_F8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">12</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-406014r14"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_AES_XTS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">13</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-406015r15"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_ZUC_EEA3</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">14</span>
</div>
<!--l. 97--><p class="noindent" >The above constants have two usages:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-406017x1">As bit numbers, used to tell the driver which CIPHER algorithms are
    supported by the device, see <a 
href="#x1-4100005">5.9.5<!--tex4ht:ref: sec:Device Types / Crypto Device / Device configuration layout --></a>.
    </li>
    <li 
  class="enumerate" id="x1-406019x2">As  values,  used  to  designate  the  algorithm  in  (CIPHER  type)  crypto
    operation requests, see <a 
href="#x1-4180001">5.9.7.2.1<!--tex4ht:ref: sec:Device Types / Crypto Device / Device Operation / Control Virtqueue / Session operation --></a>.</li></ol>
<a 
 id="x1-406020r412"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.4.2   </span> <a 
 id="x1-4070002"></a>HASH services</h5>
<!--l. 107--><p class="nopar" >The following HASH algorithms are defined:
<!--l. 109-->
<div class="lstlisting" id="listing-121"><span class="label"><a 
 id="x1-407001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_NO_HASH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-407002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_MD5</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-407003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-407004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA_224</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-407005r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA_256</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-407006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA_384</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-407007r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA_512</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-407008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA3_224</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-407009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA3_256</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-407010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA3_384</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-407011r11"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA3_512</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">10</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-407012r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA3_SHAKE128</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">11</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-407013r13"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_SHA3_SHAKE256</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">12</span>
</div>
<!--l. 125--><p class="noindent" >The above constants have two usages:
                                                                  

                                                                  
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-407015x1">As  bit  numbers,  used  to  tell  the  driver  which  HASH  algorithms  are
    supported by the device, see <a 
href="#x1-4100005">5.9.5<!--tex4ht:ref: sec:Device Types / Crypto Device / Device configuration layout --></a>.
    </li>
    <li 
  class="enumerate" id="x1-407017x2">As values, used to designate the algorithm in (HASH type) crypto operation
    requires, see <a 
href="#x1-4180001">5.9.7.2.1<!--tex4ht:ref: sec:Device Types / Crypto Device / Device Operation / Control Virtqueue / Session operation --></a>.</li></ol>
<a 
 id="x1-407018r413"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.4.3   </span> <a 
 id="x1-4080003"></a>MAC services</h5>
<!--l. 135--><p class="nopar" >The following MAC algorithms are defined:
<!--l. 137-->
<div class="lstlisting" id="listing-122"><span class="label"><a 
 id="x1-408001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_NO_MAC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-408002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_HMAC_MD5</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-408003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_HMAC_SHA1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-408004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_HMAC_SHA_224</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-408005r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_HMAC_SHA_256</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-408006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_HMAC_SHA_384</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-408007r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_HMAC_SHA_512</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-408008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_CMAC_3DES</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">25</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-408009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_CMAC_AES</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">26</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-408010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_KASUMI_F9</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">27</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-408011r11"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_SNOW3G_UIA2</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">28</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-408012r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_GMAC_AES</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">41</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-408013r13"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_GMAC_TWOFISH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">42</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-408014r14"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_CBCMAC_AES</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">49</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-408015r15"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_CBCMAC_KASUMI_F9</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">50</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-408016r16"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_XCBC_AES</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">53</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-408017r17"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_ZUC_EIA3</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">54</span>
</div>
<!--l. 157--><p class="noindent" >The above constants have two usages:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-408019x1">As  bit  numbers,  used  to  tell  the  driver  which  MAC  algorithms  are
    supported by the device, see <a 
href="#x1-4100005">5.9.5<!--tex4ht:ref: sec:Device Types / Crypto Device / Device configuration layout --></a>.
    </li>
    <li 
  class="enumerate" id="x1-408021x2">As values, used to designate the algorithm in (MAC type) crypto operation
    requests, see <a 
href="#x1-4180001">5.9.7.2.1<!--tex4ht:ref: sec:Device Types / Crypto Device / Device Operation / Control Virtqueue / Session operation --></a>.</li></ol>
<a 
 id="x1-408022r414"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.4.4   </span> <a 
 id="x1-4090004"></a>AEAD services</h5>
<!--l. 167--><p class="nopar" >The following AEAD algorithms are defined:
<!--l. 169-->
<div class="lstlisting" id="listing-123"><span class="label"><a 
 id="x1-409001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_NO_AEAD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-409002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_AEAD_GCM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-409003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_AEAD_CCM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-409004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_AEAD_CHACHA20_POLY1305</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span>
</div>
<!--l. 176--><p class="noindent" >The above constants have two usages:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-409006x1">As  bit  numbers,  used  to  tell  the  driver  which  AEAD  algorithms  are
    supported by the device, see <a 
href="#x1-4100005">5.9.5<!--tex4ht:ref: sec:Device Types / Crypto Device / Device configuration layout --></a>.
    </li>
    <li 
  class="enumerate" id="x1-409008x2">As  values,  used  to  designate  the  algorithm  in  (DEAD  type)  crypto
    operation requests, see <a 
href="#x1-4180001">5.9.7.2.1<!--tex4ht:ref: sec:Device Types / Crypto Device / Device Operation / Control Virtqueue / Session operation --></a>.</li></ol>
<a 
 id="x1-409009r411"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">5.9.5   </span> <a 
 id="x1-4100005"></a>Device configuration layout</h4>
<!--l. 186--><p class="nopar" >Crypto device configuration uses the following layout structure:
<!--l. 188-->
<div class="lstlisting" id="listing-124"><span class="label"><a 
 id="x1-410001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-410002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-410003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_dataqueues</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-410004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">crypto_services</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-410005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Detailed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algorithms</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mask</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-410006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher_algo_l</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-410007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher_algo_h</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-410008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-410009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mac_algo_l</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-410010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mac_algo_h</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-410011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aead_algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-410012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Maximum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-410013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_cipher_key_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-410014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Maximum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-410015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_auth_key_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-410016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-410017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Maximum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">each</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">crypto</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">request</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">content</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-410018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-410019r19"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
    <dl class="description"><dt class="description">
 </dt><dd 
class="description">Currently, only one <span 
class="aeti-10">status </span>bit is defined: VIRTIO_CRYPTO_S_HW_READY set
    indicates that the device is ready to process requests, this bit is read-only for the
    driver <!--l. 214-->
    <div class="lstlisting" id="listing-125"><span class="label"><a 
 id="x1-410020r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_S_HW_READY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0)</span>
    
    </div>
    </dd><dt class="description">
<span 
class="aebxti-10">max_dataqueues</span> </dt><dd 
class="description">is the maximum number of data virtqueues that can be
    configured by the device. The driver MAY use only one data queue, or it can use
    more to achieve better performance.
    </dd><dt class="description">
<span 
class="aebxti-10">crypto_services</span> </dt><dd 
class="description">crypto service offered, see <a 
href="#x1-4050004">5.9.4<!--tex4ht:ref: sec:Device Types / Crypto Device / Supported crypto services --></a>.
    </dd><dt class="description">
<span 
class="aebxti-10">cipher_algo_l</span> </dt><dd 
class="description">CIPHER algorithms bits 0-31, see <a 
href="#x1-4060001">5.9.4.1<!--tex4ht:ref: sec:Device Types / Crypto Device / Supported crypto services / CIPHER services --></a>.
    </dd><dt class="description">
<span 
class="aebxti-10">cipher_algo_h</span> </dt><dd 
class="description">CIPHER algorithms bits 32-63, see <a 
href="#x1-4060001">5.9.4.1<!--tex4ht:ref: sec:Device Types / Crypto Device / Supported crypto services / CIPHER services --></a>.
    </dd><dt class="description">
<span 
class="aebxti-10">hash_algo</span> </dt><dd 
class="description">HASH algorithms bits, see <a 
href="#x1-4070002">5.9.4.2<!--tex4ht:ref: sec:Device Types / Crypto Device / Supported crypto services / HASH services --></a>.
    </dd><dt class="description">
<span 
class="aebxti-10">mac_algo_l</span> </dt><dd 
class="description">MAC algorithms bits 0-31, see <a 
href="#x1-4080003">5.9.4.3<!--tex4ht:ref: sec:Device Types / Crypto Device / Supported crypto services / MAC services --></a>.
    </dd><dt class="description">
<span 
class="aebxti-10">mac_algo_h</span> </dt><dd 
class="description">MAC algorithms bits 32-63, see <a 
href="#x1-4080003">5.9.4.3<!--tex4ht:ref: sec:Device Types / Crypto Device / Supported crypto services / MAC services --></a>.
    </dd><dt class="description">
<span 
class="aebxti-10">aead_algo</span> </dt><dd 
class="description">AEAD algorithms bits, see <a 
href="#x1-4090004">5.9.4.4<!--tex4ht:ref: sec:Device Types / Crypto Device / Supported crypto services / AEAD services --></a>.
    </dd><dt class="description">
<span 
class="aebxti-10">max_cipher_key_len</span> </dt><dd 
class="description">is the maximum length of cipher key supported by the
    device.
    </dd><dt class="description">
<span 
class="aebxti-10">max_auth_key_len</span> </dt><dd 
class="description">is the maximum length of authenticated key supported by the
    device.
                                                                  

                                                                  
    </dd><dt class="description">
<span 
class="aebxti-10">reserved</span> </dt><dd 
class="description">is reserved for future use.
    </dd><dt class="description">
<span 
class="aebxti-10">max_size</span> </dt><dd 
class="description">is the maximum size of the variable-length parameters of data operation
    of each crypto request’s content supported by the device.</dd></dl>
<span 
class="aeb10-">Note:</span> Unless explicitly stated otherwise all lengths and sizes are in bytes.
<a 
 id="x1-410021r415"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.5.1   </span> <a 
 id="x1-4110001"></a>Device Requirements: Device configuration layout</h5>
    <ul class="itemize1">
    <li class="itemize">The device MUST set <span 
class="aeti-10">max_dataqueues </span>to between 1 and 65535 inclusive.
    </li>
    <li class="itemize">The device MUST set the <span 
class="aeti-10">status </span>with valid flags, undefined flags MUST
    NOT be set.
    </li>
    <li class="itemize">The  device  MUST  accept  and  handle  requests  after  <span 
class="aeti-10">status  </span>is  set  to
    VIRTIO_CRYPTO_S_HW_READY.
    </li>
    <li class="itemize">The device MUST set <span 
class="aeti-10">crypto_services  </span>based on the crypto services the
    device offers.
    </li>
    <li class="itemize">The device MUST set detailed algorithms masks for each service advertised
    by <span 
class="aeti-10">crypto_services</span>. The device MUST NOT set the not defined algorithms
    bits.
    </li>
    <li class="itemize">The device MUST set <span 
class="aeti-10">max_size </span>to show the maximum size of crypto request
    the device supports.
    </li>
    <li class="itemize">The device MUST set <span 
class="aeti-10">max_cipher_key_len </span>to show the maximum length of
    cipher key if the device supports CIPHER service.
    </li>
    <li class="itemize">The device MUST set <span 
class="aeti-10">max_auth_key_len </span>to show the maximum length of
    authenticated key if the device supports MAC service.</li></ul>
<a 
 id="x1-411001r417"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.5.2   </span> <a 
 id="x1-4120002"></a>Driver Requirements: Device configuration layout</h5>
    <ul class="itemize1">
    <li class="itemize">The  driver  MUST  read  the  <span 
class="aeti-10">status  </span>from  the  bottom  bit  of  status  to
    check whether the VIRTIO_CRYPTO_S_HW_READY is set, and the driver
    MUST reread it after device reset.
    </li>
    <li class="itemize">The  driver  MUST  NOT  transmit  any  requests  to  the  device  if  the
    VIRTIO_CRYPTO_S_HW_READY is not set.
                                                                  

                                                                  
    </li>
    <li class="itemize">The driver MUST read <span 
class="aeti-10">max_dataqueues </span>field to discover the number of
    data queues the device supports.
    </li>
    <li class="itemize">The driver MUST read <span 
class="aeti-10">crypto_services </span>field to discover which services the
    device is able to offer.
    </li>
    <li class="itemize">The driver SHOULD ignore the not defined algorithms bits.
    </li>
    <li class="itemize">The   driver   MUST   read   the   detailed   algorithms   fields   based   on
    <span 
class="aeti-10">crypto_services </span>field.
    </li>
    <li class="itemize">The driver SHOULD read <span 
class="aeti-10">max_size </span>to discover the maximum size of the
    variable-length parameters of data operation of the crypto request’s content
    the device supports and MUST guarantee that the size of each crypto
    request’s content is within the <span 
class="aeti-10">max_size</span>, otherwise the request will fail and
    the driver MUST reset the device.
    </li>
    <li class="itemize">The driver SHOULD read <span 
class="aeti-10">max_cipher_key_len </span>to discover the maximum
    length   of   cipher   key   the   device   supports   and   MUST   guarantee
    that  the  <span 
class="aeti-10">key_len  </span>(CIPHER  service  or  AEAD  service)  is  within  the
    <span 
class="aeti-10">max_cipher_key_len </span>of the device configuration, otherwise the request will
    fail.
    </li>
    <li class="itemize">The  driver  SHOULD  read  <span 
class="aeti-10">max_auth_key_len  </span>to  discover  the  maximum
    length  of  authenticated  key  the  device  supports  and  MUST  guarantee
    that the <span 
class="aeti-10">auth_key_len </span>(MAC service) is within the <span 
class="aeti-10">max_auth_key_len </span>of the
    device configuration, otherwise the request will fail.</li></ul>
<a 
 id="x1-412001r416"></a>
<h4 class="subsectionHead"><span class="titlemark">5.9.6   </span> <a 
 id="x1-4130006"></a>Device Initialization</h4>
<a 
 id="x1-413001r418"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.6.1   </span> <a 
 id="x1-4140001"></a>Driver Requirements: Device Initialization</h5>
    <ul class="itemize1">
    <li class="itemize">The driver MUST configure and initialize all virtqueues.
    </li>
    <li class="itemize">The  driver  MUST  read  the  supported  crypto  services  from  bits  of
    <span 
class="aeti-10">crypto_services</span>.
    </li>
    <li class="itemize">The driver MUST read the supported algorithms based on <span 
class="aeti-10">crypto_services</span>
    field.</li></ul>
<a 
 id="x1-414001r419"></a>
<h4 class="subsectionHead"><span class="titlemark">5.9.7   </span> <a 
 id="x1-4150007"></a>Device Operation</h4>
<!--l. 300--><p class="nopar" >The operation of a virtio crypto device is driven by requests placed on the virtqueues.
                                                                  

                                                                  
Requests consist of a queue-type specific header (specifying among others the
operation) and an operation specific payload.
<!--l. 304--><p class="noindent" >If VIRTIO_CRYPTO_F_REVISION_1 is negotiated the device may support both
session mode (See <a 
href="#x1-4180001">5.9.7.2.1<!--tex4ht:ref: sec:Device Types / Crypto Device / Device Operation / Control Virtqueue / Session operation --></a>) and stateless mode operation requests. In stateless mode
all operation parameters are supplied as a part of each request, while in session
mode, some or all operation parameters are managed within the session.
Stateless mode is guarded by feature bits 0-4 on a service level. If stateless
mode is negotiated for a service, the service accepts both session mode and
stateless requests; otherwise stateless mode requests are rejected (via operation
status).
<a 
 id="x1-415001r420"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.7.1   </span> <a 
 id="x1-4160001"></a>Operation Status</h5>
<!--l. 315--><p class="nopar" >The device MUST return a status code as part of the operation (both session
operation and service operation) result. The valid operation status as follows:
<!--l. 318-->
<div class="lstlisting" id="listing-126"><span class="label"><a 
 id="x1-416001r1"></a></span><span 
class="pcrr8t-x-x-80">enum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_STATUS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-416002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-416003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_ERR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-416004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_BADMSG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-416005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_NOTSUPP</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-416006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_INVSESS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-416007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_NOSPC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-416008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAX</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-416009r9"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
    <ul class="itemize1">
    <li class="itemize">VIRTIO_CRYPTO_OK: success.
    </li>
    <li class="itemize">VIRTIO_CRYPTO_BADMSG:  authentication  failed  (only  when  AEAD
    decryption).
    </li>
    <li class="itemize">VIRTIO_CRYPTO_NOTSUPP: operation or algorithm is unsupported.
    </li>
    <li class="itemize">VIRTIO_CRYPTO_INVSESS: invalid session ID when executing crypto
    operations.
    </li>
    <li class="itemize">VIRTIO_CRYPTO_NOSPC:   no   free   session   ID   (only   when   the
    VIRTIO_CRYPTO_F_REVISION_1 feature bit is negotiated).
    </li>
    <li class="itemize">VIRTIO_CRYPTO_ERR: any failure not mentioned above occurs.</li></ul>
<a 
 id="x1-416010r422"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.7.2   </span> <a 
 id="x1-4170002"></a>Control Virtqueue</h5>
<!--l. 342--><p class="nopar" >The driver uses the control virtqueue to send control commands to the device, such
as session operations (See <a 
href="#x1-4180001">5.9.7.2.1<!--tex4ht:ref: sec:Device Types / Crypto Device / Device Operation / Control Virtqueue / Session operation --></a>).
<!--l. 346--><p class="noindent" >The header for controlq is of the following form: <!--l. 347-->
<div class="lstlisting" id="listing-127"><span class="label"><a 
 id="x1-417001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">service</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(((</span><span 
class="pcrr8t-x-x-80">service</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">|</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">op</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417003r3"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_ctrl_header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_CREATE_SESSION</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">' </span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_CIPHER</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x02</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_DESTROY_SESSION</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">' </span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_CIPHER</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x03</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_CREATE_SESSION</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">' </span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_HASH</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x02</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_DESTROY_SESSION</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">' </span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_HASH</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x03</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417012r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_CREATE_SESSION</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">' </span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_MAC</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x02</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417014r14"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_DESTROY_SESSION</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">' </span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_MAC</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x03</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417016r16"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_AEAD_CREATE_SESSION</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">' </span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_AEAD</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x02</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417018r18"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_AEAD_DESTROY_SESSION</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">' </span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_AEAD</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x03</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">opcode</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">should</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">service</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algorithms</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417022r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flag</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417024r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417025r25"></a></span><span 
class="pcrr8t-x-x-80">};</span>
                                                                  

                                                                  
</div>
<!--l. 375--><p class="noindent" >The controlq request is composed of four parts: <!--l. 376-->
<div class="lstlisting" id="listing-128"><span class="label"><a 
 id="x1-417026r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_op_ctrl_req</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417027r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417028r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417029r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_ctrl_header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">header</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417030r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417031r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CTRLQ_OP_SPEC_HDR_LEGACY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">56</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417032r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fixed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">opcode</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417033r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_flf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">flf_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417034r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417035r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">variable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">opcode</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417036r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_vlf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vlf_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417037r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417038r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417039r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417040r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">completion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417041r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_outcome</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">outcome_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-417042r17"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 396--><p class="noindent" ><span 
class="aeti-10">header </span>is a general header (see above).
<!--l. 398--><p class="noindent" ><span 
class="aeti-10">op_flf  </span>is the opcode (in <span 
class="aeti-10">header</span>) specific fixed-length paramenters.
<!--l. 400--><p class="noindent" ><span 
class="aeti-10">flf_len </span>depends on the VIRTIO_CRYPTO_F_REVISION_1 feature bit (see
below).
<!--l. 402--><p class="noindent" ><span 
class="aeti-10">op_vlf  </span>is the opcode (in <span 
class="aeti-10">header</span>) specific variable-length paramenters.
<!--l. 404--><p class="noindent" ><span 
class="aeti-10">vlf_len </span>is the size of the specific structure used.
<span 
class="aeb10-">Note:</span> The  <span 
class="aeti-10">vlf_len  </span>of  session-destroy  operation  and  the  hash-session-create
      operation is ZERO.
    <ul class="itemize1">
    <li class="itemize">If                 the                 opcode                 (in                 <span 
class="aeti-10">header</span>)
    is VIRTIO_CRYPTO_CIPHER_CREATE_SESSION then <span 
class="aeti-10">op_flf  </span>is struct
    virtio_crypto_sym_create_session_flf if VIRTIO_CRYPTO_F_REVISION_1
    is negotiated and struct virtio_crypto_sym_create_session_flf is padded to
    56     bytes     if     NOT     negotiated,     and     <span 
class="aeti-10">op_vlf     </span>is     struct
    virtio_crypto_sym_create_session_vlf.
    </li>
    <li class="itemize">If                 the                 opcode                 (in                 <span 
class="aeti-10">header</span>)
    is  VIRTIO_CRYPTO_HASH_CREATE_SESSION  then  <span 
class="aeti-10">op_flf  </span>is  struct
    virtio_crypto_hash_create_session_flf if VIRTIO_CRYPTO_F_REVISION_1
    is negotiated and struct virtio_crypto_hash_create_session_flf is padded to
    56 bytes if NOT negotiated.
    </li>
    <li class="itemize">If the opcode (in <span 
class="aeti-10">header</span>) is VIRTIO_CRYPTO_MAC_CREATE_SESSION
    then                         <span 
class="aeti-10">op_flf                        </span>is                         struct
    virtio_crypto_mac_create_session_flf if VIRTIO_CRYPTO_F_REVISION_1
    is negotiated and struct virtio_crypto_mac_create_session_flf is padded to
    56     bytes     if     NOT     negotiated,     and     <span 
class="aeti-10">op_vlf     </span>is     struct
    virtio_crypto_mac_create_session_vlf.
    </li>
    <li class="itemize">If                 the                 opcode                 (in                 <span 
class="aeti-10">header</span>)
    is  VIRTIO_CRYPTO_AEAD_CREATE_SESSION  then  <span 
class="aeti-10">op_flf  </span>is  struct
    virtio_crypto_aead_create_session_flf if VIRTIO_CRYPTO_F_REVISION_1
    is negotiated and struct virtio_crypto_aead_create_session_flf is padded to
    56     bytes     if     NOT     negotiated,     and     <span 
class="aeti-10">op_vlf     </span>is     struct
    virtio_crypto_aead_create_session_vlf.
                                                                  

                                                                  
    </li>
    <li class="itemize">If                                                                                           the
    opcode (in <span 
class="aeti-10">header</span>) is VIRTIO_CRYPTO_CIPHER_DESTROY_SESSION
    or              VIRTIO_CRYPTO_HASH_DESTROY_SESSION              or
    VIRTIO_CRYPTO_MAC_DESTROY_SESSION
    or VIRTIO_CRYPTO_AEAD_DESTROY_SESSION then <span 
class="aeti-10">op_flf  </span>is struct
    virtio_crypto_destroy_session_flf  if  VIRTIO_CRYPTO_F_REVISION_1  is
    negotiated and struct virtio_crypto_destroy_session_flf is padded to 56 bytes
    if NOT negotiated.</li></ul>
<!--l. 437--><p class="noindent" ><span 
class="aeti-10">op_outcome </span>stores the result of operation and must be struct virtio_crypto_destroy_session_input
for destroy session or struct virtio_crypto_create_session_input for create
session.
<!--l. 441--><p class="noindent" ><span 
class="aeti-10">outcome_len </span>is the size of the structure used.
<a 
 id="x1-417043r373"></a>
<h5 class="paragraphHead"><span class="titlemark">5.9.7.2.1</span> <a 
 id="x1-4180001"></a>Session operation</h5>
The session is a handle which describes the cryptographic parameters to be applied
to a number of buffers.
<!--l. 450--><p class="noindent" >The following structure stores the result of session creation set by the device:
<!--l. 452-->
<div class="lstlisting" id="listing-129"><span class="label"><a 
 id="x1-418001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_create_session_input</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-418002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">session_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-418003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-418004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-418005r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 460--><p class="noindent" >A request to destroy a session includes the following information:
<!--l. 462-->
<div class="lstlisting" id="listing-130"><span class="label"><a 
 id="x1-418006r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_destroy_session_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-418007r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-418008r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">session_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-418009r4"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-418010r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-418011r6"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_destroy_session_input</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-418012r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-418013r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-418014r9"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-418015r332"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.9.7.2.1.1</span> <a 
 id="x1-4190001"></a>Session operation: HASH session</h6>
The fixed-length paramenters of HASH session requests is as follows:
<!--l. 480-->
<div class="lstlisting" id="listing-131"><span class="label"><a 
 id="x1-419001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_hash_create_session_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-419002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-419003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-419004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-419005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-419006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-419007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-419008r8"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-419009r425"></a>
                                                                  

                                                                  
<h6 class="subparagraphHead"><span class="titlemark">5.9.7.2.1.2</span> <a 
 id="x1-4200002"></a>Session operation: MAC session</h6>
The fixed-length and the variable-length parameters of MAC session requests are as
follows:
<!--l. 497-->
<div class="lstlisting" id="listing-132"><span class="label"><a 
 id="x1-420001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_mac_create_session_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-420002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-420003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-420004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-420005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-420006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-420007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-420008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-420009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth_key_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-420010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-420011r11"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-420012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-420013r13"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_mac_create_session_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-420014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-420015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-420016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-420017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth_key</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">auth_key_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-420018r18"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 518--><p class="noindent" >The length of <span 
class="aeti-10">auth_key </span>is specified in <span 
class="aeti-10">auth_key_len </span>in the struct
virtio_crypto_mac_create_session_flf.
<a 
 id="x1-420019r426"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.9.7.2.1.3</span> <a 
 id="x1-4210003"></a>Session operation: Symmetric algorithms session</h6>
The request of symmetric session could be the CIPHER algorithms request or the
chain algorithms (chaining CIPHER and HASH/MAC) request.
<!--l. 528--><p class="noindent" >The fixed-length and the variable-length parameters of CIPHER session requests are
as follows:
<!--l. 530-->
<div class="lstlisting" id="listing-133"><span class="label"><a 
 id="x1-421001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_cipher_session_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OP_ENCRYPT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OP_DECRYPT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">encryption</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">decryption</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421013r13"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421015r15"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_cipher_session_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher_key</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421020r20"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 553--><p class="noindent" >The length of <span 
class="aeti-10">cipher_key </span>is specified in <span 
class="aeti-10">key_len </span>in the struct virtio_crypto_cipher_session_flf.
<!--l. 556--><p class="noindent" >The fixed-length and the variable-length parameters of Chain session requests are as
follows:
<!--l. 558-->
<div class="lstlisting" id="listing-134"><span class="label"><a 
 id="x1-421021r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_alg_chain_session_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421022r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421023r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421024r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_ALG_CHAIN_ORDER_HASH_THEN_CIPHER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421025r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_ALG_CHAIN_ORDER_CIPHER_THEN_HASH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421026r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">alg_chain_order</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421027r7"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Plain</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421028r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_HASH_MODE_PLAIN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421029r9"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">mac</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421030r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_HASH_MODE_AUTH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421031r11"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Nested</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421032r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_HASH_MODE_NESTED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421033r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_mode</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421034r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_cipher_session_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher_hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421035r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421036r16"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_ALG_CHAIN_SESS_OP_SPEC_HDR_SIZE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421037r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fixed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421038r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo_flf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_ALG_CHAIN_SESS_OP_SPEC_HDR_SIZE</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421039r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421040r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">AAD</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421041r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421042r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421043r23"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421044r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421045r25"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_alg_chain_session_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421046r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421047r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421048r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421049r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher_key</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421050r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421051r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth_key</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">auth_key_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421052r32"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 593--><p class="noindent" ><span 
class="aeti-10">hash_mode </span>decides the type used by <span 
class="aeti-10">algo_flf</span>.
<!--l. 595--><p class="noindent" ><span 
class="aeti-10">algo_flf  </span>is fixed to 16 bytes and MUST contains or be one of the following
types:
    <ul class="itemize1">
    <li class="itemize">struct virtio_crypto_hash_create_session_flf
    </li>
    <li class="itemize">struct virtio_crypto_mac_create_session_flf</li></ul>
<!--l. 601--><p class="nopar" >The data of unused part (if has) in <span 
class="aeti-10">algo_flf  </span>will be ignored.
                                                                  

                                                                  
<!--l. 603--><p class="noindent" >The length of <span 
class="aeti-10">cipher_key </span>is specified in <span 
class="aeti-10">key_len </span>in <span 
class="aeti-10">cipher_hdr</span>.
<!--l. 605--><p class="noindent" >The length of <span 
class="aeti-10">auth_key </span>is specified in <span 
class="aeti-10">auth_key_len </span>in struct virtio_crypto_mac_create_session_flf.
<!--l. 608--><p class="noindent" >The fixed-length parameters of Symmetric session requests are as follows:
<!--l. 610-->
<div class="lstlisting" id="listing-135"><span class="label"><a 
 id="x1-421053r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_sym_create_session_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421054r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421055r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421056r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_SESS_OP_SPEC_HDR_SIZE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">48</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421057r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fixed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">opcode</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421058r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_flf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_SESS_OP_SPEC_HDR_SIZE</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421059r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421060r8"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">No</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">operation</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421061r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_OP_NONE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421062r10"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">operation</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">on</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421063r11"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_OP_CIPHER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421064r12"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Chain</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">any</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">any</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mac</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">operation</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">order</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421065r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">depends</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">on</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">value</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">alg_chain_order</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">param</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421066r14"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_OP_ALGORITHM_CHAINING</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421067r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421068r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421069r17"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 630--><p class="noindent" ><span 
class="aeti-10">op_flf  </span>is fixed to 48 bytes, MUST contains or be one of the following types:
    <ul class="itemize1">
    <li class="itemize">struct virtio_crypto_cipher_session_flf
    </li>
    <li class="itemize">struct virtio_crypto_alg_chain_session_flf</li></ul>
<!--l. 636--><p class="nopar" >The data of unused part (if has) in <span 
class="aeti-10">op_flf  </span>will be ignored.
<!--l. 638--><p class="noindent" ><span 
class="aeti-10">op_type </span>decides the type used by <span 
class="aeti-10">op_flf</span>.
<!--l. 640--><p class="noindent" >The variable-length parameters of Symmetric session requests are as follows:
<!--l. 642-->
<div class="lstlisting" id="listing-136"><span class="label"><a 
 id="x1-421070r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_sym_create_session_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421071r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421072r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">variable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">opcode</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421073r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_vlf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vlf_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-421074r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 650--><p class="noindent" ><span 
class="aeti-10">op_vlf  </span>MUST contains or be one of the following types:
    <ul class="itemize1">
    <li class="itemize">struct virtio_crypto_cipher_session_vlf
    </li>
    <li class="itemize">struct virtio_crypto_alg_chain_session_vlf</li></ul>
<!--l. 656--><p class="noindent" ><span 
class="aeti-10">op_type </span>in struct virtio_crypto_sym_create_session_flf decides the type used by
<span 
class="aeti-10">op_vlf</span>.
<!--l. 659--><p class="noindent" ><span 
class="aeti-10">vlf_len </span>is the size of the specific structure used.
<a 
 id="x1-421075r427"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.9.7.2.1.4</span> <a 
 id="x1-4220004"></a>Session operation: AEAD session</h6>
The fixed-length and the variable-length parameters of AEAD session requests are as
follows:
<!--l. 667-->
<div class="lstlisting" id="listing-137"><span class="label"><a 
 id="x1-422001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_aead_create_session_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-422002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-422003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-422004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_AEAD_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-422005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-422006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-422007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-422008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Authentication</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tag</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-422009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tag_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-422010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">AAD</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-422011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-422012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">encryption</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">decryption</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OP_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-422013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-422014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-422015r15"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-422016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-422017r17"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_aead_create_session_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-422018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-422019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-422020r20"></a></span><span 
class="pcrr8t-x-x-80">};</span>
                                                                  

                                                                  
</div>
<!--l. 690--><p class="noindent" >The length of <span 
class="aeti-10">key </span>is specified in <span 
class="aeti-10">key_len </span>in struct virtio_crypto_aead_create_session_flf.
<a 
 id="x1-422021r428"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.9.7.2.1.5</span> <a 
 id="x1-4230005"></a>Driver Requirements: Session operation: create session</h6>
    <ul class="itemize1">
    <li class="itemize">The driver MUST set the <span 
class="aeti-10">opcode </span>field based on service type: CIPHER,
    HASH, MAC, or AEAD.
    </li>
    <li class="itemize">The  driver  MUST  set  the  control  general  header,  the  opcode  specific
    header,  the  opcode  specific  extra  parameters  and  the  opcode  specific
    outcome buffer in turn. See <a 
href="#x1-4170002">5.9.7.2<!--tex4ht:ref: sec:Device Types / Crypto Device / Device Operation / Control Virtqueue --></a>.
    </li>
    <li class="itemize">The driver MUST set the <span 
class="aeti-10">reversed </span>field to zero.</li></ul>
<a 
 id="x1-423001r429"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.9.7.2.1.6</span> <a 
 id="x1-4240006"></a>Device Requirements: Session operation: create session</h6>
    <ul class="itemize1">
    <li class="itemize">The  device  MUST  use  the  corresponding  opcode  specific  structure
    according to the <span 
class="aeti-10">opcode </span>in the control general header.
    </li>
    <li class="itemize">The device MUST extract extra parameters according to the structures
    used.
    </li>
    <li class="itemize">The device MUST set the <span 
class="aeti-10">status </span>field to one of the following values of enum
    VIRTIO_CRYPTO_STATUS after finish a session creation:
        <ul class="itemize2">
        <li class="itemize">VIRTIO_CRYPTO_OK if a session is created successfully.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_NOTSUPP if the requested algorithm or operation
        is unsupported.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_NOSPC  if  no  free  session  ID  (only  when  the
        VIRTIO_CRYPTO_F_REVISION_1 feature bit is negotiated).
        </li>
        <li class="itemize">VIRTIO_CRYPTO_ERR if failure not mentioned above occurs.</li></ul>
    </li>
    <li class="itemize">The device MUST set the <span 
class="aeti-10">session_id </span>field to a unique session identifier only if
    the status is set to VIRTIO_CRYPTO_OK.</li></ul>
<a 
 id="x1-424001r430"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.9.7.2.1.7</span> <a 
 id="x1-4250007"></a>Driver Requirements: Session operation: destroy session</h6>
    <ul class="itemize1">
    <li class="itemize">The driver MUST set the <span 
class="aeti-10">opcode </span>field based on service type: CIPHER,
                                                                  

                                                                  
    HASH, MAC, or AEAD.
    </li>
    <li class="itemize">The driver MUST set the <span 
class="aeti-10">session_id </span>to a valid value assigned by the device
    when the session was created.</li></ul>
<a 
 id="x1-425001r431"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.9.7.2.1.8</span> <a 
 id="x1-4260008"></a>Device Requirements: Session operation: destroy session</h6>
    <ul class="itemize1">
    <li class="itemize">The device MUST set the <span 
class="aeti-10">status </span>field to one of the following values of enum
    VIRTIO_CRYPTO_STATUS.
        <ul class="itemize2">
        <li class="itemize">VIRTIO_CRYPTO_OK if a session is created successfully.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_ERR if any failure occurs.</li></ul>
    </li></ul>
<a 
 id="x1-426001r423"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.7.3   </span> <a 
 id="x1-4270003"></a>Data Virtqueue</h5>
<!--l. 748--><p class="nopar" >The driver uses the data virtqueues to transmit crypto operation requests to the
device, and completes the crypto operations.
<!--l. 751--><p class="noindent" >The header for dataq is as follows:
<!--l. 753-->
<div class="lstlisting" id="listing-138"><span class="label"><a 
 id="x1-427001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_op_header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_ENCRYPT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">' </span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_CIPHER</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x00</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER_DECRYPT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">' </span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_CIPHER</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x01</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">' </span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_HASH</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x00</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427008r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">' </span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_MAC</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x00</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_AEAD_ENCRYPT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">' </span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_AEAD</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x00</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427012r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_AEAD_DECRYPT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">' </span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OPCODE</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SERVICE_AEAD</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x01</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">opcode</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">should</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">service</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algorithms</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">session_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427018r18"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_FLAG_SESSION_MODE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">control</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flag</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">control</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">request</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flag</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427022r22"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<span 
class="aeb10-">Note:</span> If  VIRTIO_CRYPTO_F_REVISION_1  is  not  negotiated  the  <span 
class="aeti-10">flag  </span>is
      ignored.
      <!--l. 781--><p class="noindent" >If          VIRTIO_CRYPTO_F_REVISION_1          is          negotiated
      but   VIRTIO_CRYPTO_F_<SERVICE>_STATELESS_MODE   is   not
      negotiated,  then  the  device  SHOULD  reject  <SERVICE>  requests  if
      VIRTIO_CRYPTO_FLAG_SESSION_MODE is not set (in <span 
class="aeti-10">flag</span>).
<!--l. 786--><p class="noindent" >The dataq request is composed of four parts: <!--l. 787-->
<div class="lstlisting" id="listing-139"><span class="label"><a 
 id="x1-427023r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_op_data_req</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427024r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427025r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427026r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_op_header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">header</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427027r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427028r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_DATAQ_OP_SPEC_HDR_LEGACY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">48</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427029r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fixed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">opcode</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427030r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_flf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">flf_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427031r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427032r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&amp;&amp;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427033r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">variable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">opcode</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427034r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_vlf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vlf_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427035r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427036r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427037r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_inhdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">inhdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427038r16"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 806--><p class="noindent" ><span 
class="aeti-10">header </span>is a general header (see above).
<!--l. 808--><p class="noindent" ><span 
class="aeti-10">op_flf  </span>is the opcode (in <span 
class="aeti-10">header</span>) specific header.
                                                                  

                                                                  
<!--l. 810--><p class="noindent" ><span 
class="aeti-10">flf_len </span>depends on the VIRTIO_CRYPTO_F_REVISION_1 feature bit (see
below).
<!--l. 813--><p class="noindent" ><span 
class="aeti-10">op_vlf  </span>is the opcode (in <span 
class="aeti-10">header</span>) specific parameters.
<!--l. 815--><p class="noindent" ><span 
class="aeti-10">vlf_len </span>is the size of the specific structure used.
    <ul class="itemize1">
    <li class="itemize">If the the opcode (in <span 
class="aeti-10">header</span>) is VIRTIO_CRYPTO_CIPHER_ENCRYPT or
    VIRTIO_CRYPTO_CIPHER_DECRYPT then:
        <ul class="itemize2">
        <li class="itemize">If VIRTIO_CRYPTO_F_CIPHER_STATELESS_MODE is negotiated,
        <span 
class="aeti-10">op_flf </span>is struct virtio_crypto_sym_data_flf_stateless, and <span 
class="aeti-10">op_vlf </span>is struct
        virtio_crypto_sym_data_vlf_stateless.
        </li>
        <li class="itemize">If                   VIRTIO_CRYPTO_F_CIPHER_STATELESS_MODE
        is   NOT   negotiated,   <span 
class="aeti-10">op_flf   </span>is   struct   virtio_crypto_sym_data_flf
        if   VIRTIO_CRYPTO_F_REVISION_1   is   negotiated   and   struct
        virtio_crypto_sym_data_flf is padded to 48 bytes if NOT negotiated,
        and <span 
class="aeti-10">op_vlf  </span>is struct virtio_crypto_sym_data_vlf.</li></ul>
    </li>
    <li class="itemize">If the the opcode (in <span 
class="aeti-10">header</span>) is VIRTIO_CRYPTO_HASH:
        <ul class="itemize2">
        <li class="itemize">If  VIRTIO_CRYPTO_F_HASH_STATELESS_MODE  is  negotiated,
        <span 
class="aeti-10">op_flf  </span>is  struct  virtio_crypto_hash_data_flf_stateless,  and  <span 
class="aeti-10">op_vlf  </span>is
        struct virtio_crypto_hash_data_vlf_stateless.
        </li>
        <li class="itemize">If                       VIRTIO_CRYPTO_F_HASH_STATELESS_MODE
        is   NOT   negotiated,   <span 
class="aeti-10">op_flf   </span>is   struct   virtio_crypto_hash_data_flf
        if   VIRTIO_CRYPTO_F_REVISION_1   is   negotiated   and   struct
        virtio_crypto_hash_data_flf is padded to 48 bytes if NOT negotiated,
        and <span 
class="aeti-10">op_vlf  </span>is struct virtio_crypto_hash_data_vlf.</li></ul>
    </li>
    <li class="itemize">If the the opcode (in <span 
class="aeti-10">header</span>) is VIRTIO_CRYPTO_MAC:
        <ul class="itemize2">
        <li class="itemize">If   VIRTIO_CRYPTO_F_MAC_STATELESS_MODE   is   negotiated,
        <span 
class="aeti-10">op_flf   </span>is  struct  virtio_crypto_mac_data_flf_stateless,  and  <span 
class="aeti-10">op_vlf   </span>is
        struct virtio_crypto_mac_data_vlf_stateless.
        </li>
        <li class="itemize">If                        VIRTIO_CRYPTO_F_MAC_STATELESS_MODE
        is   NOT   negotiated,   <span 
class="aeti-10">op_flf   </span>is   struct   virtio_crypto_mac_data_flf
        if   VIRTIO_CRYPTO_F_REVISION_1   is   negotiated   and   struct
        virtio_crypto_mac_data_flf is padded to 48 bytes if NOT negotiated,
        and <span 
class="aeti-10">op_vlf  </span>is struct virtio_crypto_mac_data_vlf.</li></ul>
    </li>
    <li class="itemize">If the the opcode (in <span 
class="aeti-10">header</span>) is VIRTIO_CRYPTO_AEAD_ENCRYPT or
    VIRTIO_CRYPTO_AEAD_DECRYPT then:
                                                                  

                                                                  
        <ul class="itemize2">
        <li class="itemize">If  VIRTIO_CRYPTO_F_AEAD_STATELESS_MODE  is  negotiated,
        <span 
class="aeti-10">op_flf  </span>is  struct  virtio_crypto_aead_data_flf_stateless,  and  <span 
class="aeti-10">op_vlf  </span>is
        struct virtio_crypto_aead_data_vlf_stateless.
        </li>
        <li class="itemize">If                      VIRTIO_CRYPTO_F_AEAD_STATELESS_MODE
        is   NOT   negotiated,   <span 
class="aeti-10">op_flf   </span>is   struct   virtio_crypto_aead_data_flf
        if   VIRTIO_CRYPTO_F_REVISION_1   is   negotiated   and   struct
        virtio_crypto_aead_data_flf is padded to 48 bytes if NOT negotiated,
        and <span 
class="aeti-10">op_vlf  </span>is struct virtio_crypto_aead_data_vlf.</li></ul>
    </li></ul>
<!--l. 862--><p class="noindent" ><span 
class="aeti-10">inhdr </span>is a unified input header that used to return the status of the operations, is
defined as follows:
<!--l. 865-->
<div class="lstlisting" id="listing-140"><span class="label"><a 
 id="x1-427039r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_inhdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427040r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-427041r3"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-427042r433"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.7.4   </span> <a 
 id="x1-4280004"></a>HASH Service Operation</h5>
<!--l. 873--><p class="nopar" >Session mode HASH service requests are as follows:
<!--l. 875-->
<div class="lstlisting" id="listing-141"><span class="label"><a 
 id="x1-428001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_hash_data_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428006r6"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428008r8"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_hash_data_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428016r16"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 894--><p class="noindent" >Each data request uses the virtio_crypto_hash_data_flf structure and the
virtio_crypto_hash_data_vlf structure to store information used to run the HASH
operations.
<!--l. 898--><p class="noindent" ><span 
class="aeti-10">src_data </span>is the source data that will be processed. <span 
class="aeti-10">src_data_len </span>is the length of
source data. <span 
class="aeti-10">hash_result </span>is the result data and <span 
class="aeti-10">hash_result_len </span>is the length of
it.
<!--l. 903--><p class="noindent" >Stateless mode HASH service requests are as follows:
<!--l. 905-->
<div class="lstlisting" id="listing-142"><span class="label"><a 
 id="x1-428017r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_hash_data_flf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428018r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428019r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428020r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428021r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sess_para</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428022r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428023r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428024r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428025r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428026r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428027r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428028r12"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428029r13"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_hash_data_vlf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428030r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428031r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428032r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428033r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428034r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428035r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428036r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-428037r21"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-428038r424"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">5.9.7.4.1</span> <a 
 id="x1-4290001"></a>Driver Requirements: HASH Service Operation</h5>
    <ul class="itemize1">
    <li class="itemize">If the driver uses the session mode, then the driver MUST set <span 
class="aeti-10">session_id</span>
    in struct virtio_crypto_op_header to a valid value assigned by the device
    when the session was created.
    </li>
    <li class="itemize">If  the  VIRTIO_CRYPTO_F_HASH_STATELESS_MODE  feature  bit  is
    negotiated, 1) if the driver uses the stateless mode, then the driver MUST
    set the <span 
class="aeti-10">flag </span>field in struct virtio_crypto_op_header to ZERO and MUST set
    the fields in struct virtio_crypto_hash_data_flf_stateless.sess_para, 2) if the
    driver                uses                the                session                mode,
    then the driver MUST set the <span 
class="aeti-10">flag </span>field in struct virtio_crypto_op_header
    to VIRTIO_CRYPTO_FLAG_SESSION_MODE.
    </li>
    <li class="itemize">The  driver  MUST  set  <span 
class="aeti-10">opcode  </span>in  struct  virtio_crypto_op_header  to
    VIRTIO_CRYPTO_HASH.</li></ul>
<a 
 id="x1-429001r435"></a>
<h5 class="paragraphHead"><span class="titlemark">5.9.7.4.2</span> <a 
 id="x1-4300002"></a>Device Requirements: HASH Service Operation</h5>
    <ul class="itemize1">
    <li class="itemize">The device MUST use the corresponding structure according to the <span 
class="aeti-10">opcode</span>
    in the data general header.
    </li>
    <li class="itemize">If            the            VIRTIO_CRYPTO_F_HASH_STATELESS_MODE
    feature  bit  is  negotiated,  the  device  MUST  parse  <span 
class="aeti-10">flag  </span>field  in  struct
    virtio_crypto_op_header in order to decide which mode the driver uses.
    </li>
    <li class="itemize">The device MUST copy the results of HASH operations in the hash_result[]
    if HASH operations success.
    </li>
    <li class="itemize">The device MUST set <span 
class="aeti-10">status </span>in struct virtio_crypto_inhdr to one of the following
    values of enum VIRTIO_CRYPTO_STATUS:
        <ul class="itemize2">
        <li class="itemize">VIRTIO_CRYPTO_OK if the operation success.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_NOTSUPP if the requested algorithm or operation
        is unsupported.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_INVSESS if the session ID invalid when in session
        mode.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_ERR if any failure not mentioned above occurs.</li></ul>
    </li></ul>
<a 
 id="x1-430001r434"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">5.9.7.5   </span> <a 
 id="x1-4310005"></a>MAC Service Operation</h5>
<!--l. 967--><p class="nopar" >Session mode MAC service requests are as follows:
<!--l. 969-->
<div class="lstlisting" id="listing-143"><span class="label"><a 
 id="x1-431001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_mac_data_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_hash_data_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431003r3"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431005r5"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_mac_data_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431013r13"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 985--><p class="noindent" >Each request uses the virtio_crypto_mac_data_flf structure and the
virtio_crypto_mac_data_vlf structure to store information used to run the MAC
operations.
<!--l. 989--><p class="noindent" ><span 
class="aeti-10">src_data </span>is the source data that will be processed. <span 
class="aeti-10">src_data_len </span>is the length of
source data. <span 
class="aeti-10">hash_result </span>is the result data and <span 
class="aeti-10">hash_result_len </span>is the length of
it.
<!--l. 994--><p class="noindent" >Stateless mode MAC service requests are as follows:
<!--l. 996-->
<div class="lstlisting" id="listing-144"><span class="label"><a 
 id="x1-431014r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_mac_data_flf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431015r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431016r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431017r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431018r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431019r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth_key_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431020r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sess_para</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431021r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431022r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431023r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431024r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431025r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431026r13"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431027r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431028r15"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_mac_data_vlf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431029r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431030r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431031r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth_key</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">auth_key_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431032r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431033r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431034r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431035r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431036r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431037r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-431038r25"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1024--><p class="noindent" ><span 
class="aeti-10">auth_key </span>is the authenticated key that will be used during the process. <span 
class="aeti-10">auth_key_len</span>
is the length of the key.
<a 
 id="x1-431039r436"></a>
<h5 class="paragraphHead"><span class="titlemark">5.9.7.5.1</span> <a 
 id="x1-4320001"></a>Driver Requirements: MAC Service Operation</h5>
    <ul class="itemize1">
    <li class="itemize">If the driver uses the session mode, then the driver MUST set <span 
class="aeti-10">session_id</span>
    in struct virtio_crypto_op_header to a valid value assigned by the device
    when the session was created.
    </li>
    <li class="itemize">If  the  VIRTIO_CRYPTO_F_MAC_STATELESS_MODE  feature  bit  is
    negotiated, 1) if the driver uses the stateless mode, then the driver MUST
    set the <span 
class="aeti-10">flag </span>field in struct virtio_crypto_op_header to ZERO and MUST set
    the fields in struct virtio_crypto_mac_data_flf_stateless.sess_para, 2) if the
    driver                uses                the                session                mode,
    then the driver MUST set the <span 
class="aeti-10">flag </span>field in struct virtio_crypto_op_header
    to VIRTIO_CRYPTO_FLAG_SESSION_MODE.
    </li>
    <li class="itemize">The  driver  MUST  set  <span 
class="aeti-10">opcode  </span>in  struct  virtio_crypto_op_header  to
    VIRTIO_CRYPTO_MAC.</li></ul>
<a 
 id="x1-432001r438"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">5.9.7.5.2</span> <a 
 id="x1-4330002"></a>Device Requirements: MAC Service Operation</h5>
    <ul class="itemize1">
    <li class="itemize">If             the             VIRTIO_CRYPTO_F_MAC_STATELESS_MODE
    feature  bit  is  negotiated,  the  device  MUST  parse  <span 
class="aeti-10">flag  </span>field  in  struct
    virtio_crypto_op_header in order to decide which mode the driver uses.
    </li>
    <li class="itemize">The device MUST copy the results of MAC operations in the hash_result[]
    if HASH operations success.
    </li>
    <li class="itemize">The device MUST set <span 
class="aeti-10">status </span>in struct virtio_crypto_inhdr to one of the following
    values of enum VIRTIO_CRYPTO_STATUS:
        <ul class="itemize2">
        <li class="itemize">VIRTIO_CRYPTO_OK if the operation success.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_NOTSUPP if the requested algorithm or operation
        is unsupported.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_INVSESS if the session ID invalid when in session
        mode.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_ERR if any failure not mentioned above occurs.</li></ul>
    </li></ul>
<a 
 id="x1-433001r437"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.7.6   </span> <a 
 id="x1-4340006"></a>Symmetric algorithms Operation</h5>
<!--l. 1062--><p class="nopar" >Session mode CIPHER service requests are as follows:
<!--l. 1064-->
<div class="lstlisting" id="listing-145"><span class="label"><a 
 id="x1-434001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_cipher_data_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Byte</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">valid</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IV</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">Counter</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pointed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">by</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">below</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ciphers</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CBC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">F8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Kasumi</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">F8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SNOW3G</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">UEA2</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IV</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">which</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">must</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">same</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ciphers</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CTR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">counter</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">which</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">must</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">same</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">destination</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434017r17"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434019r19"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_cipher_data_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434022r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Initialization</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Vector</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Counter</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434024r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434025r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ciphers</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CBC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">F8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Kasumi</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">F8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434026r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SNOW3G</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">UEA2</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Initialization</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Vector</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">IV</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434027r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">value</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434028r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">block</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ciphers</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CTR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">counter</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434029r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">AES</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">XTS</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">128</span><span 
class="pcrr8t-x-x-80">bit</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tweak</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">i</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">from</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IEEE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Std</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1619-2007.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434030r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434031r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IV</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">Counter</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">will</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">updated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">after</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">every</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">partial</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cryptographic</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434032r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">operation</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434033r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434034r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434035r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434036r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434037r37"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434038r38"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434039r39"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Destination</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434040r40"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434041r41"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1108--><p class="noindent" >Session mode requests of algorithm chaining are as follows:
<!--l. 1110-->
<div class="lstlisting" id="listing-146"><span class="label"><a 
 id="x1-434042r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_alg_chain_data_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434043r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434044r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434045r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434046r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">destination</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434047r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434048r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Starting</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">point</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">processing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434049r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher_start_src_offset</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434050r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">that</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">will</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">computed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">on</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434051r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len_to_cipher</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434052r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Starting</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">point</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">processing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434053r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_start_src_offset</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434054r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">that</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">will</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">computed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">on</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434055r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len_to_hash</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434056r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434057r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434058r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434059r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434060r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434061r20"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434062r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434063r22"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_alg_chain_data_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434064r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434065r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434066r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Initialization</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Vector</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Counter</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434067r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434068r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434069r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434070r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">exists</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434071r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434072r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434073r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434074r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434075r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Destination</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434076r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434077r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434078r37"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434079r38"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1151--><p class="noindent" >Session mode requests of symmetric algorithm are as follows:
<!--l. 1153-->
<div class="lstlisting" id="listing-147"><span class="label"><a 
 id="x1-434080r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_sym_data_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434081r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434082r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434083r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_DATA_REQ_HDR_SIZE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">40</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434084r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_type_flf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_DATA_REQ_HDR_SIZE</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434085r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434086r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_OP_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434087r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434088r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434089r10"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434090r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434091r12"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_sym_data_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434092r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_type_vlf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">sym_para_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434093r14"></a></span><span 
class="pcrr8t-x-x-80">};</span>
                                                                  

                                                                  
</div>
<!--l. 1170--><p class="noindent" >Each request uses the virtio_crypto_sym_data_flf structure and the
virtio_crypto_sym_data_flf structure to store information used to run the CIPHER
operations.
<!--l. 1174--><p class="noindent" ><span 
class="aeti-10">op_type_flf  </span>is the <span 
class="aeti-10">op_type </span>specific header, it MUST starts with or be one of the
following structures:
    <ul class="itemize1">
    <li class="itemize">struct virtio_crypto_cipher_data_flf
    </li>
    <li class="itemize">struct virtio_crypto_alg_chain_data_flf</li></ul>
<!--l. 1181--><p class="noindent" >The length of <span 
class="aeti-10">op_type_flf </span>is fixed to 40 bytes, the data of unused part (if has) will be
ingored.
<!--l. 1184--><p class="noindent" ><span 
class="aeti-10">op_type_vlf </span>is the <span 
class="aeti-10">op_type </span>specific parameters, it MUST starts with or be one of the
following structures:
    <ul class="itemize1">
    <li class="itemize">struct virtio_crypto_cipher_data_vlf
    </li>
    <li class="itemize">struct virtio_crypto_alg_chain_data_vlf</li></ul>
<!--l. 1191--><p class="noindent" ><span 
class="aeti-10">sym_para_len </span>is the size of the specific structure used.
<!--l. 1193--><p class="noindent" >Stateless mode CIPHER service requests are as follows:
<!--l. 1195-->
<div class="lstlisting" id="listing-148"><span class="label"><a 
 id="x1-434094r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_cipher_data_flf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434095r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434096r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434097r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434098r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434099r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434100r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434101r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OP_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434102r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434103r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sess_para</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434104r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434105r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434106r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Byte</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">valid</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IV</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">Counter</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">pointed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">by</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">below</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434107r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434108r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434109r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434110r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434111r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">destination</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434112r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434113r20"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434114r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434115r22"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_cipher_data_vlf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434116r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434117r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434118r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434119r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher_key</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434120r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434121r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Initialization</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Vector</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Counter</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434122r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434123r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434124r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434125r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434126r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434127r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Destination</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434128r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434129r36"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1234--><p class="noindent" >Stateless mode requests of algorithm chaining are as follows:
<!--l. 1236-->
<div class="lstlisting" id="listing-149"><span class="label"><a 
 id="x1-434130r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_alg_chain_data_flf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434131r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434132r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_ALG_CHAIN_ORDER_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434133r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">alg_chain_order</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434134r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434135r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434136r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434137r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434138r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_CIPHER</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434139r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434140r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434141r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434142r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OP_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434143r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434144r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434145r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434146r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434147r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_HASH_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_MAC_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434148r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434149r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434150r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth_key_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434151r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_HASH_MODE_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434152r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_mode</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434153r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434154r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sess_para</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434155r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434156r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434157r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434158r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434159r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">destination</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434160r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434161r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Starting</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">point</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">processing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434162r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher_start_src_offset</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434163r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">that</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">will</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">computed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">on</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434164r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len_to_cipher</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434165r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Starting</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">point</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">processing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434166r37"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_start_src_offset</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434167r38"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">that</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">will</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">computed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">on</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434168r39"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len_to_hash</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434169r40"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434170r41"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434171r42"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434172r43"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434173r44"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434174r45"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434175r46"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434176r47"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_alg_chain_data_vlf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434177r48"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434178r49"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434179r50"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434180r51"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher_key</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434181r52"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434182r53"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth_key</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">auth_key_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434183r54"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Initialization</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Vector</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Counter</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434184r55"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434185r56"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">exists</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434186r57"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434187r58"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434188r59"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434189r60"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434190r61"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434191r62"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434192r63"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Destination</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434193r64"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434194r65"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Hash</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434195r66"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hash_result</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">hash_result_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434196r67"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1306--><p class="noindent" >Stateless mode requests of symmetric algorithm are as follows:
<!--l. 1308-->
<div class="lstlisting" id="listing-150"><span class="label"><a 
 id="x1-434197r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_sym_data_flf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434198r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434199r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_DATE_REQ_HDR_STATELESS_SIZE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">72</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434200r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_type_flf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_DATE_REQ_HDR_STATELESS_SIZE</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434201r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434202r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434203r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_SYM_OP_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434204r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434205r9"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434206r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434207r11"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_sym_data_vlf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434208r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op_type_vlf</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">sym_para_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-434209r13"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1324--><p class="noindent" ><span 
class="aeti-10">op_type_flf  </span>is the <span 
class="aeti-10">op_type </span>specific header, it MUST starts with or be one of the
following structures:
                                                                  

                                                                  
    <ul class="itemize1">
    <li class="itemize">struct virtio_crypto_cipher_data_flf_stateless
    </li>
    <li class="itemize">struct virtio_crypto_alg_chain_data_flf_stateless</li></ul>
<!--l. 1331--><p class="noindent" >The length of <span 
class="aeti-10">op_type_flf </span>is fixed to 72 bytes, the data of unused part (if has) will be
ingored.
<!--l. 1334--><p class="noindent" ><span 
class="aeti-10">op_type_vlf </span>is the <span 
class="aeti-10">op_type </span>specific parameters, it MUST starts with or be one of the
following structures:
    <ul class="itemize1">
    <li class="itemize">struct virtio_crypto_cipher_data_vlf_stateless
    </li>
    <li class="itemize">struct virtio_crypto_alg_chain_data_vlf_stateless</li></ul>
<!--l. 1341--><p class="noindent" ><span 
class="aeti-10">sym_para_len </span>is the size of the specific structure used.
<a 
 id="x1-434210r439"></a>
<h5 class="paragraphHead"><span class="titlemark">5.9.7.6.1</span> <a 
 id="x1-4350001"></a>Driver Requirements: Symmetric algorithms Operation</h5>
    <ul class="itemize1">
    <li class="itemize">If the driver uses the session mode, then the driver MUST set <span 
class="aeti-10">session_id</span>
    in struct virtio_crypto_op_header to a valid value assigned by the device
    when the session was created.
    </li>
    <li class="itemize">If the VIRTIO_CRYPTO_F_CIPHER_STATELESS_MODE feature bit is
    negotiated, 1) if the driver uses the stateless mode, then the driver MUST
    set the <span 
class="aeti-10">flag </span>field in struct virtio_crypto_op_header to ZERO and MUST
    set the fields in struct virtio_crypto_cipher_data_flf_stateless.sess_para or
    struct virtio_crypto_alg_chain_data_flf_stateless.sess_para, 2) if the driver
    uses the session mode, then the driver MUST set the <span 
class="aeti-10">flag </span>field in struct
    virtio_crypto_op_header to VIRTIO_CRYPTO_FLAG_SESSION_MODE.
    </li>
    <li class="itemize">The driver MUST set the <span 
class="aeti-10">opcode </span>field in struct virtio_crypto_op_header to
    VIRTIO_CRYPTO_CIPHER_ENCRYPT                                        or
    VIRTIO_CRYPTO_CIPHER_DECRYPT.
    </li>
    <li class="itemize">The driver MUST specify the fields of struct virtio_crypto_cipher_data_flf in
    struct virtio_crypto_sym_data_flf and struct virtio_crypto_cipher_data_vlf
    in   struct   virtio_crypto_sym_data_vlf   if   the   request   is   based   on
    VIRTIO_CRYPTO_SYM_OP_CIPHER.
    </li>
    <li class="itemize">The         driver         MUST         specify         the         fields         of
    struct virtio_crypto_alg_chain_data_flf in struct virtio_crypto_sym_data_flf
    and                                                                                    struct
    virtio_crypto_alg_chain_data_vlf in struct virtio_crypto_sym_data_vlf if the
    request is of the VIRTIO_CRYPTO_SYM_OP_ALGORITHM_CHAINING
                                                                  

                                                                  
    type.</li></ul>
<a 
 id="x1-435001r441"></a>
<h5 class="paragraphHead"><span class="titlemark">5.9.7.6.2</span> <a 
 id="x1-4360002"></a>Device Requirements: Symmetric algorithms Operation</h5>
    <ul class="itemize1">
    <li class="itemize">If the VIRTIO_CRYPTO_F_CIPHER_STATELESS_MODE feature bit is
    negotiated,              the              device              MUST              parse
    <span 
class="aeti-10">flag </span>field in struct virtio_crypto_op_header in order to decide which mode
    the driver uses.
    </li>
    <li class="itemize">The  device  MUST  parse  the  virtio_crypto_sym_data_req  based  on  the
    <span 
class="aeti-10">opcode </span>field in general header.
    </li>
    <li class="itemize">The device MUST parse the fields of struct virtio_crypto_cipher_data_flf in
    struct virtio_crypto_sym_data_flf and struct virtio_crypto_cipher_data_vlf
    in   struct   virtio_crypto_sym_data_vlf   if   the   request   is   based   on
    VIRTIO_CRYPTO_SYM_OP_CIPHER.
    </li>
    <li class="itemize">The device MUST parse the fields of struct virtio_crypto_alg_chain_data_flf
    in          struct          virtio_crypto_sym_data_flf          and          struct
    virtio_crypto_alg_chain_data_vlf in struct virtio_crypto_sym_data_vlf if the
    request is of the VIRTIO_CRYPTO_SYM_OP_ALGORITHM_CHAINING
    type.
    </li>
    <li class="itemize">The  device  MUST  copy  the  result  of  cryptographic  operation  in  the
    dst_data[] in both plain CIPHER mode and algorithms chain mode.
    </li>
    <li class="itemize">The device MUST check the <span 
class="aeti-10">para</span>.<span 
class="aeti-10">add_len </span>is bigger than 0 before parse the
    additional authenticated data in plain algorithms chain mode.
    </li>
    <li class="itemize">The                                                                                    device
    MUST copy the result of HASH/MAC operation in the hash_result[] is of
    the VIRTIO_CRYPTO_SYM_OP_ALGORITHM_CHAINING type.
    </li>
    <li class="itemize">The device MUST set the <span 
class="aeti-10">status </span>field in struct virtio_crypto_inhdr to one of the
    following values of enum VIRTIO_CRYPTO_STATUS:
        <ul class="itemize2">
        <li class="itemize">VIRTIO_CRYPTO_OK if the operation success.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_NOTSUPP if the requested algorithm or operation
        is unsupported.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_INVSESS  if  the  session  ID  is  invalid  in  session
        mode.
        </li>
                                                                  

                                                                  
        <li class="itemize">VIRTIO_CRYPTO_ERR if failure not mentioned above occurs.</li></ul>
    </li></ul>
<a 
 id="x1-436001r440"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.9.7.7   </span> <a 
 id="x1-4370007"></a>AEAD Service Operation</h5>
<!--l. 1400--><p class="nopar" >Session mode requests of symmetric algorithm are as follows:
<!--l. 1402-->
<div class="lstlisting" id="listing-151"><span class="label"><a 
 id="x1-437001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_aead_data_flf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Byte</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">valid</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IV</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">GCM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">either</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">12</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">96-</span><span 
class="pcrr8t-x-x-80">bit</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IVs</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">which</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">case</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">points</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">J0</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">nonce</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">which</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">can</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">range</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">13</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">inclusive</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">should</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">at</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">least</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tag_len</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Authentication</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tag</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tag_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437020r20"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437022r22"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_aead_data_vlf</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437024r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437025r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437026r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Initialization</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Vector</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437027r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437028r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">GCM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">either</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IV</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">96</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">J0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437029r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">other</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sizes</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">where</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">J0</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">defined</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">by</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">NIST</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SP800</span><span 
class="pcrr8t-x-x-80">-38</span><span 
class="pcrr8t-x-x-80">D</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437030r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Regardless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IV</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">full</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">needs</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">allocated</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437031r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CCM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mode</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">first</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">byte</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">nonce</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">should</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437032r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">written</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">starting</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">at</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&amp;</span><span 
class="pcrr8t-x-x-80">iv</span><span 
class="pcrr8t-x-x-80">[1]</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">allow</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">space</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">implementation</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437033r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">first</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">byte</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Note</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">that</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">full</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437034r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">should</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">allocated</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">even</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">though</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">will</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">have</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437035r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">value</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">less</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">than</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437036r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437037r37"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IV</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">will</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">updated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">after</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">every</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">partial</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cryptographic</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">operation</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437038r38"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437039r39"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437040r40"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437041r41"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437042r42"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">exists</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437043r43"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437044r44"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437045r45"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437046r46"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Pointer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">output</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437047r47"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437048r48"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 1453--><p class="noindent" >Each request uses the virtio_crypto_aead_data_flf structure and the
virtio_crypto_aead_data_flf structure to store information used to run the AEAD
operations.
<!--l. 1457--><p class="noindent" >Stateless mode AEAD service requests are as follows:
<!--l. 1459-->
<div class="lstlisting" id="listing-152"><span class="label"><a 
 id="x1-437049r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_aead_data_flf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437050r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437051r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_AEAD_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437052r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">algo</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437053r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437054r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437055r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">encrypt</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">decrypt</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">See</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_CRYPTO_OP_</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437056r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437057r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sess_para</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437058r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437059r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Byte</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">valid</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IV</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437060r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437061r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Authentication</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tag</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437062r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tag_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437063r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">auth</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437064r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437065r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437066r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437067r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">should</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">at</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">least</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">+</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tag_len</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437068r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437069r21"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437070r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437071r23"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_crypto_aead_data_vlf_stateless</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437072r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437073r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437074r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">cipher</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437075r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">key_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437076r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Initialization</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Vector</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437077r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">iv</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">iv_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437078r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437079r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">src_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437080r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Additional</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">authenticated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">exists</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437081r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">aad</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">aad_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437082r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437083r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">portion</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437084r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Pointer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">output</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437085r37"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_data</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">dst_data_len</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-437086r38"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-437087r442"></a>
<h5 class="paragraphHead"><span class="titlemark">5.9.7.7.1</span> <a 
 id="x1-4380001"></a>Driver Requirements: AEAD Service Operation</h5>
    <ul class="itemize1">
    <li class="itemize">If the driver uses the session mode, then the driver MUST set <span 
class="aeti-10">session_id</span>
    in struct virtio_crypto_op_header to a valid value assigned by the device
    when the session was created.
    </li>
    <li class="itemize">If  the  VIRTIO_CRYPTO_F_AEAD_STATELESS_MODE  feature  bit  is
    negotiated, 1) if the driver uses the stateless mode, then the driver MUST
    set the <span 
class="aeti-10">flag </span>field in struct virtio_crypto_op_header to ZERO and MUST set
    the fields in struct virtio_crypto_aead_data_flf_stateless.sess_para, 2) if the
    driver                uses                the                session                mode,
    then the driver MUST set the <span 
class="aeti-10">flag </span>field in struct virtio_crypto_op_header
    to VIRTIO_CRYPTO_FLAG_SESSION_MODE.
    </li>
    <li class="itemize">The driver MUST set the <span 
class="aeti-10">opcode </span>field in struct virtio_crypto_op_header to
    VIRTIO_CRYPTO_AEAD_ENCRYPT                                           or
    VIRTIO_CRYPTO_AEAD_DECRYPT.</li></ul>
<a 
 id="x1-438001r444"></a>
<h5 class="paragraphHead"><span class="titlemark">5.9.7.7.2</span> <a 
 id="x1-4390002"></a>Device Requirements: AEAD Service Operation</h5>
    <ul class="itemize1">
                                                                  

                                                                  
    <li class="itemize">If  the  VIRTIO_CRYPTO_F_AEAD_STATELESS_MODE  feature  bit  is
    negotiated,                                                                              the
    device MUST parse the virtio_crypto_aead_data_vlf_stateless based on the
    <span 
class="aeti-10">opcode </span>field in general header.
    </li>
    <li class="itemize">The  device  MUST  copy  the  result  of  cryptographic  operation  in  the
    dst_data[].
    </li>
    <li class="itemize">The device MUST copy the authentication tag in the dst_data[] offset the
    cipher result.
    </li>
    <li class="itemize">The device MUST set the <span 
class="aeti-10">status </span>field in struct virtio_crypto_inhdr to one
    of the following values of enum VIRTIO_CRYPTO_STATUS:
    </li>
    <li class="itemize">When the <span 
class="aeti-10">opcode </span>field is VIRTIO_CRYPTO_AEAD_DECRYPT, the device
    MUST verify and return the verification result to the driver.
        <ul class="itemize2">
        <li class="itemize">VIRTIO_CRYPTO_OK if the operation success.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_NOTSUPP if the requested algorithm or operation
        is unsupported.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_BADMSG if the verification result is incorrect.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_INVSESS if the session ID invalid when in session
        mode.
        </li>
        <li class="itemize">VIRTIO_CRYPTO_ERR if any failure not mentioned above occurs.</li></ul>
    </li></ul>
<a 
 id="x1-439001r406"></a>
<h3 class="sectionHead"><span class="titlemark">5.10   </span> <a 
 id="x1-44000010"></a>Socket Device</h3>
<!--l. 3--><p class="nopar" >The virtio socket device is a zero-configuration socket communications device. It
facilitates data transfer between the guest and device without using the Ethernet or
IP protocols.
<a 
 id="x1-440001r421"></a>
<h4 class="subsectionHead"><span class="titlemark">5.10.1   </span> <a 
 id="x1-4410001"></a>Device ID</h4>
<!--l. 8--><p class="nopar" >19
<a 
 id="x1-441001r447"></a>
<h4 class="subsectionHead"><span class="titlemark">5.10.2   </span> <a 
 id="x1-4420002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">rx
    </dd><dt class="description">
                                                                  

                                                                  
<span 
class="aeb10-">1</span> </dt><dd 
class="description">tx
    </dd><dt class="description">
<span 
class="aeb10-">2</span> </dt><dd 
class="description">event</dd></dl>
<a 
 id="x1-442001r448"></a>
<h4 class="subsectionHead"><span class="titlemark">5.10.3   </span> <a 
 id="x1-4430003"></a>Feature bits</h4>
<!--l. 19--><p class="nopar" >If no feature bit is set, only stream socket type is supported. If
VIRTIO_VSOCK_F_SEQPACKET has been negotiated, the device MAY act as if
VIRTIO_VSOCK_F_STREAM has also been negotiated.
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_VSOCK_F_STREAM (0)</span> </dt><dd 
class="description">stream socket type is supported.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_VSOCK_F_SEQPACKET (1)</span> </dt><dd 
class="description">seqpacket socket type is supported.</dd></dl>
<a 
 id="x1-443001r449"></a>
<h4 class="subsectionHead"><span class="titlemark">5.10.4   </span> <a 
 id="x1-4440004"></a>Device configuration layout</h4>
<!--l. 30--><p class="nopar" >Socket device configuration uses the following layout structure:
<!--l. 32-->
<div class="lstlisting" id="listing-153"><span class="label"><a 
 id="x1-444001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_vsock_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-444002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">guest_cid</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-444003r3"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 38--><p class="noindent" >The <span 
class="aeti-10">guest_cid </span>field contains the guest’s context ID, which uniquely identifies
the device for its lifetime. The upper 32 bits of the CID are reserved and
zeroed.
<!--l. 42--><p class="noindent" >The following CIDs are reserved and cannot be used as the guest’s context
ID:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > CID             </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Notes                                 </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >0 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >Reserved</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 1                 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Reserved                            </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 2                 </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Well-known CID for the host  </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0xffffffff         </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Reserved                            </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-6"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0xffffffffffffffff  </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Reserved                            </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-7"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<a 
 id="x1-444004r450"></a>
<h4 class="subsectionHead"><span class="titlemark">5.10.5   </span> <a 
 id="x1-4450005"></a>Device Initialization</h4>
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-445002x1">The guest’s cid is read from <span 
class="aeti-10">guest_cid</span>.
    </li>
    <li 
  class="enumerate" id="x1-445004x2">Buffers are added to the event virtqueue to receive events from the device.
    </li>
    <li 
  class="enumerate" id="x1-445006x3">Buffers are added to the rx virtqueue to start receiving packets.</li></ol>
<a 
 id="x1-445007r451"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">5.10.6   </span> <a 
 id="x1-4460006"></a>Device Operation</h4>
<!--l. 72--><p class="nopar" >Packets transmitted or received contain a header before the payload:
<!--l. 74-->
<div class="lstlisting" id="listing-154"><span class="label"><a 
 id="x1-446001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_vsock_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_cid</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_cid</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">src_port</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dst_port</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">op</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buf_alloc</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fwd_cnt</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446012r12"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 89--><p class="noindent" >The upper 32 bits of src_cid and dst_cid are reserved and zeroed.
<!--l. 91--><p class="noindent" >Most packets simply transfer data but control packets are also used for connection
and buffer space management. <span 
class="aeti-10">op </span>is one of the following operation constants:
<!--l. 95-->
<div class="lstlisting" id="listing-155"><span class="label"><a 
 id="x1-446013r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_OP_INVALID</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446014r2"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Connect</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">operations</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446015r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_OP_REQUEST</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446016r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_OP_RESPONSE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446017r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_OP_RST</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446018r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_OP_SHUTDOWN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446019r7"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">To</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">send</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">payload</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446020r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_OP_RW</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446021r9"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Tell</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">peer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">our</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">credit</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">info</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446022r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_OP_CREDIT_UPDATE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446023r11"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Request</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">peer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">send</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">credit</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">info</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">us</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-446024r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_OP_CREDIT_REQUEST</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span>
</div>
<a 
 id="x1-446025r443"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.10.6.1   </span> <a 
 id="x1-4470001"></a>Virtqueue Flow Control</h5>
<!--l. 112--><p class="nopar" >The tx virtqueue carries packets initiated by applications and replies to received
packets. The rx virtqueue carries packets initiated by the device and replies to
previously transmitted packets.
<!--l. 116--><p class="noindent" >If both rx and tx virtqueues are filled by the driver and device at the same time then
it appears that a deadlock is reached. The driver has no free tx descriptors to send
replies. The device has no free rx descriptors to send replies either. Therefore neither
device nor driver can process virtqueues since that may involve sending new
replies.
<!--l. 122--><p class="noindent" >This is solved using additional resources outside the virtqueue to hold packets. With
additional resources, it becomes possible to process incoming packets even when
outgoing packets cannot be sent.
<!--l. 126--><p class="noindent" >Eventually even the additional resources will be exhausted and further processing is
not possible until the other side processes the virtqueue that it has neglected. This
stop to processing prevents one side from causing unbounded resource consumption
in the other side.
<a 
 id="x1-447001r445"></a>
<h5 class="paragraphHead"><span class="titlemark">5.10.6.1.1</span> <a 
 id="x1-4480001"></a>Driver Requirements: Device Operation: Virtqueue Flow Control</h5>
The rx virtqueue MUST be processed even when the tx virtqueue is full so long
as there are additional resources available to hold packets outside the tx
virtqueue.
<a 
 id="x1-448001r454"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">5.10.6.1.2</span> <a 
 id="x1-4490002"></a>Device Requirements: Device Operation: Virtqueue Flow Control</h5>
The tx virtqueue MUST be processed even when the rx virtqueue is full so long
as there are additional resources available to hold packets outside the rx
virtqueue.
<a 
 id="x1-449001r453"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.10.6.2   </span> <a 
 id="x1-4500002"></a>Addressing</h5>
<!--l. 141--><p class="nopar" >Flows are identified by a (source, destination) address tuple. An address consists of a
(cid, port number) tuple. The header fields used for this are <span 
class="aeti-10">src_cid</span>, <span 
class="aeti-10">src_port</span>, <span 
class="aeti-10">dst_cid</span>,
and <span 
class="aeti-10">dst_port</span>.
<!--l. 145--><p class="noindent" >Currently stream and seqpacket sockets are supported. <span 
class="aeti-10">type </span>is 1
(VIRTIO_VSOCK_TYPE_STREAM) for stream socket types, and 2
(VIRTIO_VSOCK_TYPE_SEQPACKET) for seqpacket socket types.
<!--l. 148-->
<div class="lstlisting" id="listing-156"><span class="label"><a 
 id="x1-450001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_TYPE_STREAM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-450002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_TYPE_SEQPACKET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span>
</div>
<!--l. 153--><p class="noindent" >Stream sockets provide in-order, guaranteed, connection-oriented delivery
without message boundaries. Seqpacket sockets provide in-order, guaranteed,
connection-oriented delivery with message and record boundaries.
<a 
 id="x1-450003r456"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.10.6.3   </span> <a 
 id="x1-4510003"></a>Buffer Space Management</h5>
<!--l. 158--><p class="nopar" ><span 
class="aeti-10">buf_alloc </span>and <span 
class="aeti-10">fwd_cnt </span>are used for buffer space management of stream sockets. The
guest and the device publish how much buffer space is available per socket. Only
payload bytes are counted and header bytes are not included. This facilitates flow
control so data is never dropped.
<!--l. 163--><p class="noindent" ><span 
class="aeti-10">buf_alloc </span>is the total receive buffer space, in bytes, for this socket. This includes both
free and in-use buffers. <span 
class="aeti-10">fwd_cnt </span>is the free-running bytes received counter. The sender
calculates the amount of free receive buffer space as follows:
<!--l. 168-->
<div class="lstlisting" id="listing-157"><span class="label"><a 
 id="x1-451001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tx_cnt</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sender</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">free</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">running</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">transmitted</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">counter</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-451002r2"></a></span><span 
class="pcrr8t-x-x-80">u32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">peer_free</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">peer_buf_alloc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">tx_cnt</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">peer_fwd_cnt</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span>
</div>
<!--l. 173--><p class="noindent" >If there is insufficient buffer space, the sender waits until virtqueue
buffers are returned and checks <span 
class="aeti-10">buf_alloc </span>and <span 
class="aeti-10">fwd_cnt </span>again. Sending the
VIRTIO_VSOCK_OP_CREDIT_REQUEST packet queries how much buffer space is
available. The reply to this query is a VIRTIO_VSOCK_OP_CREDIT_UPDATE
packet. It is also valid to send a VIRTIO_VSOCK_OP_CREDIT_UPDATE packet
without previously receiving a VIRTIO_VSOCK_OP_CREDIT_REQUEST
                                                                  

                                                                  
packet. This allows communicating updates any time a change in buffer space
occurs.
<a 
 id="x1-451003r455"></a>
<h5 class="paragraphHead"><span class="titlemark">5.10.6.3.1</span> <a 
 id="x1-4520001"></a>Driver Requirements: Device Operation: Buffer Space Management</h5>
VIRTIO_VSOCK_OP_RW data packets MUST only be transmitted when the peer
has sufficient free buffer space for the payload.
<!--l. 185--><p class="noindent" >All packets associated with a stream flow MUST contain valid information in
<span 
class="aeti-10">buf_alloc </span>and <span 
class="aeti-10">fwd_cnt </span>fields.
<a 
 id="x1-452001r458"></a>
<h5 class="paragraphHead"><span class="titlemark">5.10.6.3.2</span> <a 
 id="x1-4530002"></a>Device Requirements: Device Operation: Buffer Space Management</h5>
VIRTIO_VSOCK_OP_RW data packets MUST only be transmitted when the peer
has sufficient free buffer space for the payload.
<!--l. 192--><p class="noindent" >All packets associated with a stream flow MUST contain valid information in
<span 
class="aeti-10">buf_alloc </span>and <span 
class="aeti-10">fwd_cnt </span>fields.
<a 
 id="x1-453001r457"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.10.6.4   </span> <a 
 id="x1-4540004"></a>Receive and Transmit</h5>
<!--l. 196--><p class="nopar" >The driver queues outgoing packets on the tx virtqueue and incoming packet receive
buffers on the rx virtqueue. Packets are of the following form:
<!--l. 199-->
<div class="lstlisting" id="listing-158"><span class="label"><a 
 id="x1-454001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_vsock_packet</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-454002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_vsock_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-454003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-454004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 206--><p class="noindent" >Virtqueue buffers for outgoing packets are read-only. Virtqueue buffers for incoming
packets are write-only.
<a 
 id="x1-454005r459"></a>
<h5 class="paragraphHead"><span class="titlemark">5.10.6.4.1</span> <a 
 id="x1-4550001"></a>Driver Requirements: Device Operation: Receive and Transmit</h5>
The <span 
class="aeti-10">guest_cid </span>configuration field MUST be used as the source CID when sending
outgoing packets.
<!--l. 214--><p class="noindent" >A VIRTIO_VSOCK_OP_RST reply MUST be sent if a packet is received with an
unknown <span 
class="aeti-10">type </span>value.
<a 
 id="x1-455001r461"></a>
<h5 class="paragraphHead"><span class="titlemark">5.10.6.4.2</span> <a 
 id="x1-4560002"></a>Device Requirements: Device Operation: Receive and Transmit</h5>
The <span 
class="aeti-10">guest_cid </span>configuration field MUST NOT contain a reserved CID as listed in
<a 
href="#x1-4440004">5.10.4<!--tex4ht:ref: sec:Device Types / Socket Device / Device configuration layout --></a>.
<!--l. 221--><p class="noindent" >A VIRTIO_VSOCK_OP_RST reply MUST be sent if a packet is received with an
                                                                  

                                                                  
unknown <span 
class="aeti-10">type </span>value.
<a 
 id="x1-456001r460"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.10.6.5   </span> <a 
 id="x1-4570005"></a>Stream Sockets</h5>
<!--l. 226--><p class="nopar" >Connections are established by sending a VIRTIO_VSOCK_OP_REQUEST packet. If
a listening socket exists on the destination a VIRTIO_VSOCK_OP_RESPONSE reply
is sent and the connection is established. A VIRTIO_VSOCK_OP_RST reply is sent if
a listening socket does not exist on the destination or the destination has insufficient
resources to establish the connection.
<!--l. 232--><p class="noindent" >When a connected socket receives VIRTIO_VSOCK_OP_SHUTDOWN the header <span 
class="aeti-10">flags</span>
field bit VIRTIO_VSOCK_SHUTDOWN_F_RECEIVE (bit 0) set indicates that the
peer will not receive any more data and bit VIRTIO_VSOCK_SHUTDOWN_F_SEND
(bit 1) set indicates that the peer will not send any more data. These hints are
permanent once sent and successive packets with bits clear do not reset
them.
<!--l. 238-->
<div class="lstlisting" id="listing-159"><span class="label"><a 
 id="x1-457001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_SHUTDOWN_F_RECEIVE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-457002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_SHUTDOWN_F_SEND</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span>
</div>
<!--l. 243--><p class="noindent" >The VIRTIO_VSOCK_OP_RST packet aborts the connection process or forcibly
disconnects a connected socket.
<!--l. 246--><p class="noindent" >Clean disconnect is achieved by one or more VIRTIO_VSOCK_OP_SHUTDOWN
packets that indicate no more data will be sent and received, followed by a
VIRTIO_VSOCK_OP_RST response from the peer. If no VIRTIO_VSOCK_OP_RST
response is received within an implementation-specific amount of time, a
VIRTIO_VSOCK_OP_RST packet is sent to forcibly disconnect the socket.
<!--l. 252--><p class="noindent" >The clean disconnect process ensures that neither peer reuses the (source,
destination) address tuple for a new connection while the other peer is still processing
the old connection.
<a 
 id="x1-457003r463"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.10.6.6   </span> <a 
 id="x1-4580006"></a>Seqpacket Sockets</h5>
<a 
 id="x1-458001r462"></a>
<h5 class="paragraphHead"><span class="titlemark">5.10.6.6.1</span> <a 
 id="x1-4590001"></a>Message and record boundaries</h5>
Two types of boundaries are supported: message and record boundaries.
<!--l. 261--><p class="noindent" >A message contains data sent in a single operation. A single message can be split into
multiple RW packets. To provide message boundaries, last RW packet of each
message has VIRTIO_VSOCK_SEQ_EOM bit (bit 0) set in the <span 
class="aeti-10">flags </span>of packet’s
header.
<!--l. 266--><p class="noindent" >Record is any number of subsequent messages, where last message is sent with
                                                                  

                                                                  
POSIX MSG_EOR flag set. Record boundary means that receiver gets MSG_EOR
flag set in the corresponding message where sender set it. To provide record
boundaries, last RW packet of each record has VIRTIO_VSOCK_SEQ_EOR bit (bit
1) set in the <span 
class="aeti-10">flags </span>of packet’s header.
<!--l. 272-->
<div class="lstlisting" id="listing-160"><span class="label"><a 
 id="x1-459001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_SEQ_EOM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-459002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_SEQ_EOR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1)</span>
</div>
<a 
 id="x1-459003r464"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.10.6.7   </span> <a 
 id="x1-4600007"></a>Device Events</h5>
<!--l. 279--><p class="nopar" >Certain events are communicated by the device to the driver using the event
virtqueue.
<!--l. 282--><p class="noindent" >The event buffer is as follows:
<!--l. 284-->
<div class="lstlisting" id="listing-161"><span class="label"><a 
 id="x1-460001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VSOCK_EVENT_TRANSPORT_RESET</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-460002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-460003r3"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_vsock_event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-460004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-460005r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 292--><p class="noindent" >The VIRTIO_VSOCK_EVENT_TRANSPORT_RESET event indicates that
communication has been interrupted. This usually occurs if the guest has been
physically migrated. The driver shuts down established connections and the <span 
class="aeti-10">guest_cid</span>
configuration field is fetched again. Existing listen sockets remain but their CID is
updated to reflect the current <span 
class="aeti-10">guest_cid</span>.
<a 
 id="x1-460006r465"></a>
<h5 class="paragraphHead"><span class="titlemark">5.10.6.7.1</span> <a 
 id="x1-4610001"></a>Driver Requirements: Device Operation: Device Events</h5>
Event virtqueue buffers SHOULD be replenished quickly so that no events are
missed.
<!--l. 304--><p class="noindent" >The <span 
class="aeti-10">guest_cid </span>configuration field MUST be fetched to determine the current CID
when a VIRTIO_VSOCK_EVENT_TRANSPORT_RESET event is received.
<!--l. 307--><p class="noindent" >Existing connections MUST be shut down when a VIRTIO_VSOCK_EVENT_TRANSPORT_RESET
event is received.
<!--l. 310--><p class="noindent" >Listen connections MUST remain operational with the current CID when a
VIRTIO_VSOCK_EVENT_TRANSPORT_RESET event is received.
<a 
 id="x1-461001r446"></a>
<h3 class="sectionHead"><span class="titlemark">5.11   </span> <a 
 id="x1-46200011"></a>File System Device</h3>
<!--l. 3--><p class="nopar" >The virtio file system device provides file system access. The device either directly
manages a file system or it acts as a gateway to a remote file system. The details of
                                                                  

                                                                  
how the device implementation accesses files are hidden by the device interface,
allowing for a range of use cases.
<!--l. 8--><p class="noindent" >Unlike block-level storage devices such as virtio block and SCSI, the virtio file system
device provides file-level access to data. The device interface is based on the Linux
Filesystem in Userspace (FUSE) protocol. This consists of requests for file system
traversal and access the files and directories within it. The protocol details are
defined by <a 
href="#x1-3001r1">FUSE</a>.
<!--l. 14--><p class="noindent" >The device acts as the FUSE file system daemon and the driver acts as the FUSE
client mounting the file system. The virtio file system device provides the mechanism
for transporting FUSE requests, much like /dev/fuse in a traditional FUSE
application.
<!--l. 19--><p class="noindent" >This section relies on definitions from <a 
href="#x1-3001r1">FUSE</a>.
<a 
 id="x1-462001r452"></a>
<h4 class="subsectionHead"><span class="titlemark">5.11.1   </span> <a 
 id="x1-4630001"></a>Device ID</h4>
<!--l. 22--><p class="nopar" >26
<a 
 id="x1-463001r469"></a>
<h4 class="subsectionHead"><span class="titlemark">5.11.2   </span> <a 
 id="x1-4640002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">hiprio
    </dd><dt class="description">
<span 
class="aeb10-">1</span> </dt><dd 
class="description">notification queue
    </dd><dt class="description">
<span 
class="aeb10-">2</span><span 
class="aeb10-">…n</span> </dt><dd 
class="description">request queues</dd></dl>
<!--l. 32--><p class="nopar" >The notification queue only exists if VIRTIO_FS_F_NOTIFICATION is
set.
<a 
 id="x1-464001r470"></a>
<h4 class="subsectionHead"><span class="titlemark">5.11.3   </span> <a 
 id="x1-4650003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_FS_F_NOTIFICATION (0)</span> </dt><dd 
class="description">Device  has  support  for  FUSE  notify
    messages. The notification queue is virtqueue 1.</dd></dl>
<a 
 id="x1-465001r471"></a>
<h4 class="subsectionHead"><span class="titlemark">5.11.4   </span> <a 
 id="x1-4660004"></a>Device configuration layout</h4>
<!--l. 43-->
<div class="lstlisting" id="listing-162"><span class="label"><a 
 id="x1-466001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_fs_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">char</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tag</span><span 
class="pcrr8t-x-x-80">[36];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num_request_queues</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notify_buf_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-466005r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
                                                                  

                                                                  
<!--l. 51--><p class="noindent" >The <span 
class="aeti-10">tag </span>and <span 
class="aeti-10">num_request_queues </span>fields are always available. The <span 
class="aeti-10">notify_buf_size </span>field
is only available when VIRTIO_FS_F_NOTIFICATION is set.
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">tag</span> </dt><dd 
class="description">is the name associated with this file system. The tag is encoded in UTF-8
    and padded with NUL bytes if shorter than the available space. This field
    is not NUL-terminated if the encoded bytes take up the entire field.
    </dd><dt class="description">
<span 
class="aebxti-10">num_request_queues</span> </dt><dd 
class="description">is the total number of request virtqueues exposed by
    the device. Each virtqueue offers identical functionality and there are no
    ordering guarantees between requests made available on different queues.
    Use of multiple queues is intended to increase performance.
    </dd><dt class="description">
<span 
class="aebxti-10">notify_buf_size</span> </dt><dd 
class="description">is the minimum number of bytes required for each buffer in
    the notification queue.</dd></dl>
<a 
 id="x1-466006r466"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.11.4.1   </span> <a 
 id="x1-4670001"></a>Driver Requirements: Device configuration layout</h5>
<!--l. 71--><p class="nopar" >The driver MUST NOT write to device configuration fields.
<!--l. 73--><p class="noindent" >The driver MAY use from one up to <span 
class="aeti-10">num_request_queues </span>request virtqueues.
<a 
 id="x1-467001r473"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.11.4.2   </span> <a 
 id="x1-4680002"></a>Device Requirements: Device configuration layout</h5>
<!--l. 77--><p class="nopar" >The device MUST set <span 
class="aeti-10">num_request_queues </span>to 1 or greater.
<!--l. 79--><p class="noindent" >The device MUST set <span 
class="aeti-10">notify_buf_size </span>to be large enough to hold any of the FUSE
notify messages that this device emits.
<a 
 id="x1-468001r472"></a>
<h4 class="subsectionHead"><span class="titlemark">5.11.5   </span> <a 
 id="x1-4690005"></a>Device Initialization</h4>
<!--l. 84--><p class="nopar" >On initialization the driver first discovers the device’s virtqueues.
<!--l. 86--><p class="noindent" >The driver populates the notification queue with buffers for receiving FUSE notify
messages if VIRTIO_FS_F_NOTIFICATION is set.
<!--l. 89--><p class="noindent" >The FUSE session is started by sending a FUSE_INIT request as defined by the
FUSE protocol on one request virtqueue. All virtqueues provide access to the same
FUSE session and therefore only one FUSE_INIT request is required regardless of the
number of available virtqueues.
<a 
 id="x1-469001r475"></a>
<h4 class="subsectionHead"><span class="titlemark">5.11.6   </span> <a 
 id="x1-4700006"></a>Device Operation</h4>
<!--l. 96--><p class="nopar" >Device operation consists of operating the virtqueues to facilitate file system
access.
<!--l. 99--><p class="noindent" >The FUSE request types are as follows:
                                                                  

                                                                  
    <ul class="itemize1">
    <li class="itemize">Normal requests are made available by the driver on request queues and
    are used by the device.
    </li>
    <li class="itemize">High   priority   requests   (FUSE_INTERRUPT,   FUSE_FORGET,   and
    FUSE_BATCH_FORGET) are made available by the driver on the hiprio
    queue so the device is able to process them even if the request queues are
    full.</li></ul>
<!--l. 109--><p class="noindent" >FUSE notify messages are received on the notification queue if
VIRTIO_FS_F_NOTIFICATION is set.
<a 
 id="x1-470001r474"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.11.6.1   </span> <a 
 id="x1-4710001"></a>Device Operation: Request Queues</h5>
<!--l. 114--><p class="nopar" >The driver enqueues normal requests on an arbitrary request queue. High priority
requests are not placed on request queues. The device processes requests in any order.
The driver is responsible for ensuring that ordering constraints are met by making
available a dependent request only after its prerequisite request has been
used.
<!--l. 120--><p class="noindent" >Requests have the following format with endianness chosen by the driver in the
FUSE_INIT request used to initiate the session as detailed below:
<!--l. 123-->
<div class="lstlisting" id="listing-163"><span class="label"><a 
 id="x1-471001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_fs_req</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-471002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">readable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-471003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fuse_in_header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-471004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">datain</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-471005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-471006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-471007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fuse_out_header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">out</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-471008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dataout</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-471009r9"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 135--><p class="noindent" >Note that the words "in" and "out" follow the FUSE meaning and do not indicate the
direction of data transfer under VIRTIO. "In" means input to a request and "out"
means output from processing a request.
<!--l. 139--><p class="noindent" ><span 
class="aeti-10">in </span>is the common header for all types of FUSE requests.
<!--l. 141--><p class="noindent" ><span 
class="aeti-10">datain </span>consists of request-specific data, if any. This is identical to the data read from
the /dev/fuse device by a FUSE daemon.
<!--l. 144--><p class="noindent" ><span 
class="aeti-10">out </span>is the completion header common to all types of FUSE requests.
<!--l. 146--><p class="noindent" ><span 
class="aeti-10">dataout </span>consists of request-specific data, if any. This is identical to the data written
to the /dev/fuse device by a FUSE daemon.
<!--l. 149--><p class="noindent" >For example, the full layout of a FUSE_READ request is as follows:
<!--l. 151-->
<div class="lstlisting" id="listing-164"><span class="label"><a 
 id="x1-471010r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_fs_read_req</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-471011r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">readable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-471012r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fuse_in_header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-471013r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">union</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-471014r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fuse_read_in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">readin</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-471015r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">datain</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">sizeof</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fuse_read_in</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-471016r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-471017r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-471018r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-471019r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fuse_out_header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">out</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-471020r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">dataout</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">out</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sizeof</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fuse_out_header</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-471021r12"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
                                                                  

                                                                  
<!--l. 166--><p class="noindent" >The FUSE protocol documented in <a 
href="#x1-3001r1">FUSE</a> specifies the set of request types and their
contents.
<!--l. 169--><p class="noindent" >The endianness of the FUSE protocol session is detectable by inspecting
the uint32_t <span 
class="aeti-10">in.opcode </span>field of the FUSE_INIT request sent by the driver
to the device. This allows the device to determine whether the session is
little-endian or big-endian. The next FUSE_INIT message terminates the
current session and starts a new session with the possibility of changing
endianness.
<a 
 id="x1-471022r477"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.11.6.2   </span> <a 
 id="x1-4720002"></a>Device Operation: High Priority Queue</h5>
<!--l. 178--><p class="nopar" >The hiprio queue follows the same request format as the request queues. This queue
only contains FUSE_INTERRUPT, FUSE_FORGET, and FUSE_BATCH_FORGET
requests.
<!--l. 182--><p class="noindent" >Interrupt and forget requests have a higher priority than normal requests. The
separate hiprio queue is used for these requests to ensure they can be delivered even
when all request queues are full.
<a 
 id="x1-472001r467"></a>
<h5 class="paragraphHead"><span class="titlemark">5.11.6.2.1</span> <a 
 id="x1-4730001"></a>Device Requirements: Device Operation: High Priority Queue</h5>
The device MUST NOT pause processing of the hiprio queue due to activity on a
normal request queue.
<!--l. 191--><p class="noindent" >The device MAY process request queues concurrently with the hiprio queue.
<a 
 id="x1-473001r479"></a>
<h5 class="paragraphHead"><span class="titlemark">5.11.6.2.2</span> <a 
 id="x1-4740002"></a>Driver Requirements: Device Operation: High Priority Queue</h5>
The driver MUST submit FUSE_INTERRUPT, FUSE_FORGET, and
FUSE_BATCH_FORGET requests solely on the hiprio queue.
<!--l. 197--><p class="noindent" >The driver MUST not submit normal requests on the hiprio queue.
<!--l. 199--><p class="noindent" >The driver MUST anticipate that request queues are processed concurrently with the
hiprio queue.
<a 
 id="x1-474001r478"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.11.6.3   </span> <a 
 id="x1-4750003"></a>Device Operation: Notification Queue</h5>
<!--l. 203--><p class="nopar" >The notification queue is populated with buffers by the driver and these buffers are
used by the device to emit FUSE notify messages. Notification queue buffer layout is
as follows:
<!--l. 207-->
<div class="lstlisting" id="listing-165"><span class="label"><a 
 id="x1-475001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_fs_notify</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-475002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">//</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">part</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-475003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fuse_out_header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">out_hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-475004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">char</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">outarg</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">notify_buf_size</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sizeof</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fuse_out_header</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-475005r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
                                                                  

                                                                  
<!--l. 215--><p class="noindent" ><span 
class="aeti-10">outarg </span>contains the FUSE notify message payload that depends on the type of
notification being emitted.
<!--l. 218--><p class="noindent" >If the driver provides notification queue buffers at a slower rate than the
device emits FUSE notify messages then the virtqueue will eventually become
empty. The behavior in response to an empty virtqueue depends on the
FUSE notify message type. The following FUSE notify message types are
supported:
    <ul class="itemize1">
    <li class="itemize">FUSE_NOTIFY_LOCK  messages  are  delivered  when  buffers  become
    available  again.  The  device  has  resources  for  a  certain  number  of  lock
    requests. If the device runs out of resources new lock requests fail with
    ENOLCK.</li></ul>
<a 
 id="x1-475006r480"></a>
<h5 class="paragraphHead"><span class="titlemark">5.11.6.3.1</span> <a 
 id="x1-4760001"></a>Driver Requirements: Device Operation: Notification Queue</h5>
The driver MUST provide buffers of at least <span 
class="aeti-10">notify_buf_size </span>bytes.
<!--l. 230--><p class="noindent" >The driver SHOULD replenish notification queue buffers sufficiently quickly so that
there is always at least one available buffer.
<a 
 id="x1-476001r481"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.11.6.4   </span> <a 
 id="x1-4770004"></a>Device Operation: DAX Window</h5>
<!--l. 235--><p class="nopar" >FUSE_READ and FUSE_WRITE requests transfer file contents between the
driver-provided buffer and the device. In cases where data transfer is undesirable, the
device can map file contents into the DAX window shared memory region. The driver
then accesses file contents directly in device-owned memory without a data
transfer.
<!--l. 241--><p class="noindent" >The DAX Window is an alternative mechanism for accessing file contents.
FUSE_READ/FUSE_WRITE requests and DAX Window accesses are possible at the
same time. Providing the DAX Window is optional for devices. Using the DAX
Window is optional for drivers.
<!--l. 246--><p class="noindent" >Shared memory region ID 0 is called the DAX window. Drivers map this
shared memory region with writeback caching as if it were regular RAM. The
contents of the DAX window are undefined unless a mapping exists for that
range.
<!--l. 250--><p class="noindent" >The driver maps a file range into the DAX window using the FUSE_SETUPMAPPING
request. Alignment constraints for FUSE_SETUPMAPPING and
FUSE_REMOVEMAPPING requests are communicated during FUSE_INIT
negotiation.
<!--l. 254--><p class="noindent" >When a FUSE_SETUPMAPPING request perfectly overlaps a previous mapping, the
previous mapping is replaced. When a mapping partially overlaps a previous
mapping, the previous mapping is split into one or two smaller mappings. When
a mapping is partially unmapped it is also split into one or two smaller
                                                                  

                                                                  
mappings.
<!--l. 260--><p class="noindent" >Establishing new mappings or splitting existing mappings consumes resources. If the
device runs out of resources the FUSE_SETUPMAPPING request fails until
resources are available again following FUSE_REMOVEMAPPING.
<!--l. 264--><p class="noindent" >After FUSE_SETUPMAPPING has completed successfully the file range is
accessible from the DAX window at the offset provided by the driver in
the request. A mapping is removed using the FUSE_REMOVEMAPPING
request.
<!--l. 268--><p class="noindent" >Data is only guaranteed to be persistent when a FUSE_FSYNC request is used
by the device after having been made available by the driver following the
write.
<a 
 id="x1-477001r482"></a>
<h5 class="paragraphHead"><span class="titlemark">5.11.6.4.1</span> <a 
 id="x1-4780001"></a>Device Requirements: Device Operation: DAX Window</h5>
The device MAY provide the DAX Window to memory-mapped access to file
contents. If present, the DAX Window MUST be shared memory region ID
0.
<!--l. 275--><p class="noindent" >The device MUST support FUSE_READ and FUSE_WRITE requests regardless of
whether the DAX Window is being used or not.
<!--l. 277--><p class="noindent" >The device MUST allow mappings that completely or partially overlap existing
mappings within the DAX window.
<!--l. 279--><p class="noindent" >The device MUST reject mappings that would go beyond the end of the DAX
window.
<a 
 id="x1-478001r484"></a>
<h5 class="paragraphHead"><span class="titlemark">5.11.6.4.2</span> <a 
 id="x1-4790002"></a>Driver Requirements: Device Operation: DAX Window</h5>
The driver SHOULD be prepared to find shared memory region ID 0 absent and fall
back to FUSE_READ and FUSE_WRITE requests.
<!--l. 285--><p class="noindent" >The driver MAY use both FUSE_READ/FUSE_WRITE requests and the DAX
Window to access file contents.
<!--l. 287--><p class="noindent" >The driver MUST NOT access DAX window areas that have not been mapped.
<a 
 id="x1-479001r483"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.11.6.5   </span> <a 
 id="x1-4800005"></a>Security Considerations</h5>
<!--l. 291--><p class="nopar" >The device provides access to a file system containing files owned by one or more
POSIX user ids and group ids. The device has no secure way of differentiating
between users originating requests via the driver. Therefore the device accepts the
POSIX user ids and group ids provided by the driver and security is enforced by the
driver rather than the device. It is nevertheless possible for devices to implement
POSIX user id and group id mapping or whitelisting to control the ownership and
access available to the driver.
                                                                  

                                                                  
<!--l. 299--><p class="noindent" >File systems containing special files including device nodes and setuid executable files
pose a security concern. These properties are defined by the file type and mode,
which are set by the driver when creating new files or by changes at a later time.
These special files present a security risk when the file system is shared with another
machine. A setuid executable or a device node placed by a malicious machine
make it possible for unprivileged users on other machines to elevate their
privileges through the shared file system. This issue can be solved on some
operating systems using mount options that ignore special files. It is also
possible for devices to implement restrictions on special files by refusing their
creation.
<!--l. 310--><p class="noindent" >When the device provides shared access to a file system between multiple machines,
symlink race conditions, exhausting file system capacity, and overwriting or deleting
files used by others are factors to consider. These issues have a long history in
multi-user operating systems and also apply to virtio-fs. They are typically managed
at the file system administration level by providing shared access only to mutually
trusted users.
<!--l. 317--><p class="noindent" >Multiple machines sharing access to a file system are susceptible to timing
side-channel attacks. By measuring the latency of accesses to file contents or file
system metadata it is possible to infer whether other machines also accessed the same
information. Short latencies indicate that the information was cached due to a
previous access. This can reveal sensitive information, such as whether certain code
paths were taken. The DAX Window provides direct access to file contents and is
therefore a likely target of such attacks. These attacks are also possible with
traditional FUSE requests. The safest approach is to avoid sharing file systems
between untrusted machines.
<a 
 id="x1-480001r486"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.11.6.6   </span> <a 
 id="x1-4810006"></a>Live migration considerations</h5>
<!--l. 329--><p class="nopar" >When a driver is migrated to a new device it is necessary to consider the FUSE
session and its state. The continuity of FUSE inode numbers (also known as
nodeids) and fh values is necessary so the driver can continue operation without
disruption.
<!--l. 334--><p class="noindent" >It is possible to maintain the FUSE session across live migration either by
transferring the state or by redirecting requests from the new device to the
old device where the state resides. The details of how to achieve this are
implementation-dependent and are not visible at the device interface level.
<!--l. 339--><p class="noindent" >Maintaining version and feature information negotiated by FUSE_INIT is necessary
so that no FUSE protocol feature changes are visible to the driver across live
migration. The FUSE_INIT information forms part of the FUSE session state that
needs to be transferred during live migration.
<a 
 id="x1-481001r468"></a>
                                                                  

                                                                  
<h3 class="sectionHead"><span class="titlemark">5.12   </span> <a 
 id="x1-48200012"></a>RPMB Device</h3>
<!--l. 3--><p class="nopar" >virtio-rpmb is a virtio based RPMB (Replay Protected Memory Block) device. It is
used as a tamper-resistant and anti-replay storage. The device is driven via requests
including read, write, get write counter and program key, which are submitted via a
request queue. This section relies on definitions from paragraph 6.6.22 of
<a 
href="#x1-3001r1">eMMC</a>.
<a 
 id="x1-482001r476"></a>
<h4 class="subsectionHead"><span class="titlemark">5.12.1   </span> <a 
 id="x1-4830001"></a>Device ID</h4>
<!--l. 11--><p class="nopar" >28
<a 
 id="x1-483001r489"></a>
<h4 class="subsectionHead"><span class="titlemark">5.12.2   </span> <a 
 id="x1-4840002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">requestq</dd></dl>
<a 
 id="x1-484001r490"></a>
<h4 class="subsectionHead"><span class="titlemark">5.12.3   </span> <a 
 id="x1-4850003"></a>Feature bits</h4>
<!--l. 21--><p class="nopar" >None.
<a 
 id="x1-485001r491"></a>
<h4 class="subsectionHead"><span class="titlemark">5.12.4   </span> <a 
 id="x1-4860004"></a>Device configuration layout</h4>
<!--l. 25--><p class="nopar" >All fields of this configuration are always available and read-only for the
driver.
<!--l. 27-->
<div class="lstlisting" id="listing-166"><span class="label"><a 
 id="x1-486001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_rpmb_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-486002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">capacity</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-486003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_wr_cnt</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-486004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_rd_cnt</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-486005r5"></a></span><span 
class="pcrr8t-x-x-80">}</span>
</div>
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">capacity</span> </dt><dd 
class="description">is the capacity of the device (expressed in 128KB units). The values
    MUST range between 0x00 and 0x80 inclusive.
    </dd><dt class="description">
<span 
class="aebxti-10">max_wr_cnt and max_rd_cnt</span> </dt><dd 
class="description">are  the  maximum  numbers  of  RPMB  block
    count (256B) that can be performed to device in one request. 0 implies no
    limitation.</dd></dl>
<a 
 id="x1-486006r492"></a>
<h4 class="subsectionHead"><span class="titlemark">5.12.5   </span> <a 
 id="x1-4870005"></a>Device Requirements: Device Initialization</h4>
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-487002x1">The virtqueue is initialized.
    </li>
    <li 
  class="enumerate" id="x1-487004x2">The device capacity MUST be initialized to a multiple of 128Kbytes and
                                                                  

                                                                  
    up to 16Mbytes.</li></ol>
<a 
 id="x1-487005r493"></a>
<h4 class="subsectionHead"><span class="titlemark">5.12.6   </span> <a 
 id="x1-4880006"></a>Device Operation</h4>
<!--l. 53--><p class="nopar" >The operation of a virtio RPMB device is driven by the requests placed on the virtqueue.
The type of request can be program key (VIRTIO_RPMB_REQ_PROGRAM_KEY),
get write counter (VIRTIO_RPMB_REQ_GET_WRITE_COUNTER), write
(VIRTIO_RPMB_REQ_DATA_WRITE), and read (VIRTIO_RPMB_REQ_DATA_READ).
A program key or write request can also combine with a result read
(VIRTIO_RPMB_REQ_RESULT_READ) for a returned result.
<!--l. 60-->
<div class="lstlisting" id="listing-167"><span class="label"><a 
 id="x1-488001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">RPMB</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Request</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Types</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-488002r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_RPMB_REQ_PROGRAM_KEY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0001</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-488003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_RPMB_REQ_GET_WRITE_COUNTER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0002</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-488004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_RPMB_REQ_DATA_WRITE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0003</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-488005r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_RPMB_REQ_DATA_READ</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0004</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-488006r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_RPMB_REQ_RESULT_READ</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0005</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-488007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-488008r8"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">RPMB</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Response</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Types</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-488009r9"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_RPMB_RESP_PROGRAM_KEY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0100</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-488010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_RPMB_RESP_GET_COUNTER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0200</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-488011r11"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_RPMB_RESP_DATA_WRITE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0300</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-488012r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_RPMB_RESP_DATA_READ</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0400</span>
</div>
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">VIRTIO_RPMB_REQ_PROGRAM_KEY</span> </dt><dd 
class="description">requests for authentication key
    programming. If VIRTIO_RPMB_REQ_RESULT_READ is requested, the
    device     returns     the     RPMB     frame     with     the     response
    (VIRTIO_RPMB_RESP_PROGRAM_KEY), the calculated MAC and the
    result.
    </dd><dt class="description">
<span 
class="aebxti-10">VIRTIO_RPMB_REQ_GET_WRITE_COUNTER</span> </dt><dd 
class="description">requests  for  reading
    the write counter. The device returns the RPMB frame with the response
    (VIRTIO_RPMB_RESP_GET_COUNTER), the writer counter, a copy of
    the nonce received in the request, the calculated MAC and the result.
    </dd><dt class="description">
<span 
class="aebxti-10">VIRTIO_RPMB_REQ_DATA_WRITE</span> </dt><dd 
class="description">requests
    for authenticated data write. If VIRTIO_RPMB_REQ_RESULT_READ is
    requested, the device returns the RPMB data frame with the response
    (VIRTIO_RPMB_RESP_DATA_WRITE), the incremented counter value,
    the data address, the calculated MAC and the result.
    </dd><dt class="description">
<span 
class="aebxti-10">VIRTIO_RPMB_REQ_DATA_READ</span> </dt><dd 
class="description">requests   for   authenticated   data
    read.   The   device   returns   the   RPMB   frame   with   the   response
    (VIRTIO_RPMB_RESP_DATA_READ),  the  block  count,  a  copy  of  the
    nonce received in the request, the address, the data, the calculated MAC
    and the result.
    </dd><dt class="description">
<span 
class="aebxti-10">VIRTIO_RPMB_REQ_RESULT_READ</span> </dt><dd 
class="description">requests  for  a  returned  result.
    It  is  used  following  with  VIRTIO_RPMB_REQ_PROGRAM_KEY  or
    VIRTIO_RPMB_REQ_DATA_WRITE request types for a returned result
    in one or multiple RPMB frames. If it’s not requested, the device will not
                                                                  

                                                                  
    return result frame to the driver.</dd></dl>
<a 
 id="x1-488013r487"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.12.6.1   </span> <a 
 id="x1-4890001"></a>Device Operation: Request Queue</h5>
<!--l. 104--><p class="nopar" >The request information is delivered in RPMB frame. The frame is in size of
512B.
<!--l. 107-->
<div class="lstlisting" id="listing-168"><span class="label"><a 
 id="x1-489001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_rpmb_frame</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-489002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">stuff</span><span 
class="pcrr8t-x-x-80">[196];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-489003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">key_mac</span><span 
class="pcrr8t-x-x-80">[32];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-489004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">[256];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-489005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">nonce</span><span 
class="pcrr8t-x-x-80">[16];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-489006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write_counter</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-489007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">address</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-489008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">block_count</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-489009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">result</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-489010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">req_resp</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-489011r11"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-489012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-489013r13"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">RPMB</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Operation</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Results</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-489014r14"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_RPMB_RES_OK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0000</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-489015r15"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_RPMB_RES_GENERAL_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0001</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-489016r16"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_RPMB_RES_AUTH_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0002</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-489017r17"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_RPMB_RES_COUNT_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0003</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-489018r18"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_RPMB_RES_ADDR_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0004</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-489019r19"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_RPMB_RES_WRITE_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0005</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-489020r20"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_RPMB_RES_READ_FAILURE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0006</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-489021r21"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_RPMB_RES_NO_AUTH_KEY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0007</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-489022r22"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_RPMB_RES_WRITE_COUNTER_EXPIRED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0080</span>
</div>
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">stuff</span> </dt><dd 
class="description">Padding for the frame.
    </dd><dt class="description">
<span 
class="aebxti-10">key_mac</span> </dt><dd 
class="description">is  the  authentication  key  or  the  message  authentication  code
    (MAC)  depending  on  the  request/response  type.  If  the  request  is
    VIRTIO_RPMB_REQ_PROGRAM_KEY, it’s used as an authentication
    key. Otherwise, it’s used as MAC. The MAC is calculated using HMAC
    SHA-256. It takes as input a key and a message. The key used for the MAC
    calculation is always the 256-bit RPMB authentication key. The message
    used as input to the MAC calculation is the concatenation of the fields in
    the RPMB frames excluding stuff bytes and the MAC itself.
    </dd><dt class="description">
<span 
class="aebxti-10">data</span> </dt><dd 
class="description">is used to be written or read via authenticated read/write access. It’s fixed
    256B.
    </dd><dt class="description">
<span 
class="aebxti-10">nonce</span> </dt><dd 
class="description">is a random number generated by the user for the read or get write
    counter requests and copied to the response by the device. It’s used for
    anti-replay protection.
    </dd><dt class="description">
<span 
class="aebxti-10">writer_counter</span> </dt><dd 
class="description">is the counter value for the total amount of the successful
    authenticated data write requests.
    </dd><dt class="description">
<span 
class="aebxti-10">address</span> </dt><dd 
class="description">is the address of the data to be written to or read from the RPMB
    virtio device. It is the number of the accessed half sector (256B).
    </dd><dt class="description">
<span 
class="aebxti-10">block_count</span> </dt><dd 
class="description">is the number of blocks (256B) requested to be read/written. It’s
    limited by <span 
class="aeti-10">max_wr_cnt </span>or <span 
class="aeti-10">max_rd_cnt</span>. For RPMB read request, one virtio
    buffer including request command and the subsequent [<span 
class="aeti-10">block_count</span>] virtio
    buffers for response data are placed in the queue. For RPMB write request,
    [<span 
class="aeti-10">block_count</span>] virtio buffers including request command and data are placed
    in the queue.
                                                                  

                                                                  
    </dd><dt class="description">
<span 
class="aebxti-10">result</span> </dt><dd 
class="description">includes information about the status of access made to the device. It is
    written by the device.
    </dd><dt class="description">
<span 
class="aebxti-10">req_resp</span> </dt><dd 
class="description">is the type of request or response, to/from the device.</dd></dl>
<a 
 id="x1-489023r485"></a>
<h5 class="paragraphHead"><span class="titlemark">5.12.6.1.1</span> <a 
 id="x1-4900001"></a>Device Requirements: Device Operation: Program Key</h5>
If VIRTIO_RPMB_REQ_RESULT_READ is requested, the device SHOULD
return the RPMB frame with the response, the calculated MAC and the
result:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-490002x1">If                         the                         <span 
class="aeti-10">block_count                       </span>is
    not set to 1 then VIRTIO_RPMB_RES_GENERAL_FAILURE SHOULD
    be responded as <span 
class="aeti-10">result</span>.
    </li>
    <li 
  class="enumerate" id="x1-490004x2">If       the       programming       of       authentication       key       fails,
    then VIRTIO_RPMB_RES_WRITE_FAILURE SHOULD be responded as
    <span 
class="aeti-10">result</span>.
    </li>
    <li 
  class="enumerate" id="x1-490006x3">If            some            other            error            occurs            then
    returned result VIRTIO_RPMB_RES_GENERAL_FAILURE SHOULD be
    responded as <span 
class="aeti-10">result</span>.
    </li>
    <li 
  class="enumerate" id="x1-490008x4">The <span 
class="aeti-10">req_resp </span>value VIRTIO_RPMB_RESP_PROGRAM_KEY SHOULD be
    responded.</li></ol>
<a 
 id="x1-490009r496"></a>
<h5 class="paragraphHead"><span class="titlemark">5.12.6.1.2</span> <a 
 id="x1-4910002"></a>Device Requirements: Device Operation: Get Write Counter</h5>
If the authentication key is not yet programmed then VIRTIO_RPMB_RES_NO_AUTH_KEY
SHOULD be returned in <span 
class="aeti-10">result</span>.
<!--l. 196--><p class="noindent" >If block count has not been set to 1 then VIRTIO_RPMB_RES_GENERAL_FAILURE
SHOULD be responded as <span 
class="aeti-10">result</span>.
<!--l. 199--><p class="noindent" >The <span 
class="aeti-10">req_resp </span>value VIRTIO_RPMB_RESP_GET_COUNTER SHOULD be
responded.
<a 
 id="x1-491001r497"></a>
<h5 class="paragraphHead"><span class="titlemark">5.12.6.1.3</span> <a 
 id="x1-4920003"></a>Device Requirements: Device Operation: Data Write</h5>
If VIRTIO_RPMB_REQ_RESULT_READ is requested, the device SHOULD return
the RPMB data frame with the response VIRTIO_RPMB_RESP_DATA_WRITE, the
incremented counter value, the data address, the calculated MAC and the
                                                                  

                                                                  
result:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-492002x1">If    the    authentication    key    is    not    yet    programmed,    then
    VIRTIO_RPMB_RES_NO_AUTH_KEY SHOULD be returned in <span 
class="aeti-10">result</span>.
    </li>
    <li 
  class="enumerate" id="x1-492004x2">If    block    count    is    zero    or    greater    than    <span 
class="aeti-10">max_wr_cnt    </span>then
    VIRTIO_RPMB_RES_GENERAL_FAILURE SHOULD be responded.
    </li>
    <li 
  class="enumerate" id="x1-492006x3">The  device  MUST  check  whether  the  write  counter  has  expired.  If
    the  write  counter  is  expired  then  the  <span 
class="aeti-10">result  </span>SHOULD  be  set  to
    VIRTIO_RPMB_RES_WRITE_COUNTER_EXPIRED.
    </li>
    <li 
  class="enumerate" id="x1-492008x4">If there is an error in the address (out of range) then the <span 
class="aeti-10">result </span>SHOULD
    be set to VIRTIO_RPMB_RES_ADDR_FAILURE.
    </li>
    <li 
  class="enumerate" id="x1-492010x5">The device MUST calculate the MAC taking authentication key and frame
    as input, and compare this with the MAC in the request. If the two MAC’s
    are  different  then  VIRTIO_RPMB_RES_AUTH_FAILURE  SHOULD  be
    returned in <span 
class="aeti-10">result</span>.
    </li>
    <li 
  class="enumerate" id="x1-492012x6">If the writer counter in the request is different from the one maintained
    by the device then VIRTIO_RPMB_RES_COUNT_FAILURE SHOULD be
    returned in <span 
class="aeti-10">result</span>.
    </li>
    <li 
  class="enumerate" id="x1-492014x7">If the MAC and write counter comparisons are matched then the write
    request  is  considered  to  be  authenticated.  The  data  from  the  request
    SHOULD be written to the address indicated in the request and the write
    counter SHOULD be incremented by 1.
    </li>
    <li 
  class="enumerate" id="x1-492016x8">If      the      write      fails      then      the      <span 
class="aeti-10">result      </span>SHOULD      be
    VIRTIO_RPMB_RES_WRITE_FAILURE.
    </li>
    <li 
  class="enumerate" id="x1-492018x9">If some other error occurs during the writing procedure then the <span 
class="aeti-10">result</span>
    SHOULD be VIRTIO_RPMB_RES_GENERAL_FAILURE.
    </li>
    <li 
  class="enumerate" id="x1-492020x10">The <span 
class="aeti-10">req_resp  </span>value VIRTIO_RPMB_RESP_DATA_WRITE SHOULD be
    responded.</li></ol>
<a 
 id="x1-492021r498"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">5.12.6.1.4</span> <a 
 id="x1-4930004"></a>Device Requirements: Device Operation: Data Read</h5>
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-493002x1">If    the    authentication    key    is    not    yet    programmed    then
    VIRTIO_RPMB_RES_NO_AUTH_KEY SHOULD be returned in <span 
class="aeti-10">result</span>.
    </li>
    <li 
  class="enumerate" id="x1-493004x2">If     block     count     is     zero     or     greater     than     <span 
class="aeti-10">max_rd_cnt</span>
    then VIRTIO_RPMB_RES_GENERAL_FAILURE SHOULD be responded
    as <span 
class="aeti-10">result</span>.
    </li>
    <li 
  class="enumerate" id="x1-493006x3">If there is an error in the address (out of range) then the <span 
class="aeti-10">result </span>SHOULD
    be set to VIRTIO_RPMB_RES_ADDR_FAILURE.
    </li>
    <li 
  class="enumerate" id="x1-493008x4">If data fetch from addressed location inside the device fails then the <span 
class="aeti-10">result</span>
    SHOULD be VIRTIO_RPMB_RES_READ_FAILURE.
    </li>
    <li 
  class="enumerate" id="x1-493010x5">If  some  other  error  occurs  during  the  read  procedure  then  the  <span 
class="aeti-10">result</span>
    SHOULD be VIRTIO_RPMB_RES_GENERAL_FAILURE.
    </li>
    <li 
  class="enumerate" id="x1-493012x6">The device SHOULD respond with <span 
class="aeti-10">block_count </span>frames containing the data
    and <span 
class="aeti-10">req_resp </span>value set to VIRTIO_RPMB_RESP_DATA_READ.</li></ol>
<a 
 id="x1-493013r499"></a>
<h5 class="paragraphHead"><span class="titlemark">5.12.6.1.5</span> <a 
 id="x1-4940005"></a>Device Requirements: Device Operation: Result Read</h5>
If the <span 
class="aeti-10">block_count </span>has not been set to 1 of VIRTIO_RPMB_REQ_RESULT_READ
request then VIRTIO_RPMB_RES_GENERAL_FAILURE SHOULD be responded as
<span 
class="aeti-10">result</span>.
<a 
 id="x1-494001r495"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.12.6.2   </span> <a 
 id="x1-4950002"></a>Driver Requirements: Device Operation</h5>
<!--l. 268--><p class="nopar" >The RPMB frames MUST not be packed by the driver. The driver MUST configure,
initialize and format virtqueue for the RPMB requests received from its caller then
send it to the device.
<a 
 id="x1-495001r501"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.12.6.3   </span> <a 
 id="x1-4960003"></a>Device Requirements: Device Operation</h5>
<!--l. 273--><p class="nopar" >The virtio-rpmb device could be backed in a number of ways. It SHOULD keep
consistent behaviors with hardware as described in paragraph 6.6.22 of <a 
href="#x1-3001r1">eMMC</a>. Some
elements are maintained by the device:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-496002x1">The device MUST maintain a one-time programmable authentication key.
    It cannot be overwritten, erased or read. The key is used to authenticate
                                                                  

                                                                  
    the accesses when MAC is calculated. This key MUST be kept regardless
    of device reset or reboot.
    </li>
    <li 
  class="enumerate" id="x1-496004x2">The device MUST maintain a read-only monotonic write counter. It MUST
    be initialized to zero and added by one automatically along with successful
    write operation. The value cannot be reset. After the counter has reached
    its maximum value 0xFFFF FFFF, it will not be incremented anymore.
    This counter MUST be kept regardless of device reset or reboot.
    </li>
    <li 
  class="enumerate" id="x1-496006x3">The  device  MUST  maintain  the  data  for  read/write  via  authenticated
    access.</li></ol>
<a 
 id="x1-496007r488"></a>
<h3 class="sectionHead"><span class="titlemark">5.13   </span> <a 
 id="x1-49700013"></a>IOMMU device</h3>
<!--l. 3--><p class="nopar" >The virtio-iommu device manages Direct Memory Access (DMA) from one or more
endpoints. It may act both as a proxy for physical IOMMUs managing devices
assigned to the guest, and as virtual IOMMU managing emulated and paravirtualized
devices.
<!--l. 8--><p class="noindent" >The driver first discovers endpoints managed by the virtio-iommu device using
platform specific mechanisms. It then sends requests to create virtual address spaces
and virtual-to-physical mappings for these endpoints. In its simplest form, the
virtio-iommu supports four request types:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-497002x1">Create a domain and attach an endpoint to it. <br 
class="newline" /><span 
class="pcrr8t-">attach(endpoint = 0x8, domain = 1)</span>
    </li>
    <li 
  class="enumerate" id="x1-497004x2">Create  a  mapping  between  a  range  of  guest-virtual  and  guest-physical
    address. <br 
class="newline" /><span 
class="pcrr8t-">map(domain = 1, virt_start = 0x1000, virt_end =</span>
    <span 
class="pcrr8t-">0x1fff, phys = 0xa000, flags = READ)</span>
    <!--l. 22--><p class="noindent" >Endpoint 0x8, for example a hardware PCI endpoint with BDF 00:01.0,
    can now read at addresses 0x1000-0x1fff. These accesses are translated into
    system-physical addresses by the IOMMU.
    </li>
    <li 
  class="enumerate" id="x1-497006x3">Remove the mapping.<br 
class="newline" /><span 
class="pcrr8t-">unmap(domain = 1, virt_start = 0x1000, virt_end =</span>
    <span 
class="pcrr8t-">0x1fff)</span>
    <!--l. 29--><p class="noindent" >Any  access  to  addresses  0x1000-0x1fff  by  endpoint  0x8  would  now  be
    rejected.
    </li>
    <li 
  class="enumerate" id="x1-497008x4">Detach the device and remove the domain.<br 
class="newline" /><span 
class="pcrr8t-">detach(endpoint = 0x8, domain = 1)</span></li></ol>
<a 
 id="x1-497009r494"></a>
<h4 class="subsectionHead"><span class="titlemark">5.13.1   </span> <a 
 id="x1-4980001"></a>Device ID</h4>
<!--l. 37--><p class="nopar" >23
<a 
 id="x1-498001r504"></a>
<h4 class="subsectionHead"><span class="titlemark">5.13.2   </span> <a 
 id="x1-4990002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">requestq
    </dd><dt class="description">
<span 
class="aeb10-">1</span> </dt><dd 
class="description">eventq</dd></dl>
<a 
 id="x1-499001r505"></a>
<h4 class="subsectionHead"><span class="titlemark">5.13.3   </span> <a 
 id="x1-5000003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_IOMMU_F_INPUT_RANGE (0)</span> </dt><dd 
class="description">Available range of virtual addresses
    is described in <span 
class="aeti-10">input_range</span>.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_IOMMU_F_DOMAIN_RANGE (1)</span> </dt><dd 
class="description">The     number     of     domains
    supported is described in <span 
class="aeti-10">domain_range</span>.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_IOMMU_F_MAP_UNMAP (2)</span> </dt><dd 
class="description">Map and unmap requests are available.<span class="footnote-mark"><a 
href="#fn19x5" id="fn19x5-bk"><sup class="textsuperscript">19</sup></a></span><a 
 id="x1-500001f19"></a>
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_IOMMU_F_BYPASS (3)</span> </dt><dd 
class="description">Endpoints that are not attached to a domain
    are in bypass mode.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_IOMMU_F_PROBE (4)</span> </dt><dd 
class="description">The PROBE request is available.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_IOMMU_F_MMIO (5)</span> </dt><dd 
class="description">The VIRTIO_IOMMU_MAP_F_MMIO flag is
    available.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_IOMMU_F_BYPASS_CONFIG (6)</span> </dt><dd 
class="description">
    Field <span 
class="aeti-10">bypass </span>of struct virtio_iommu_config determines whether endpoints
    that   are   not   attached   to   a   domain   are   in   bypass   mode.   Flag
    VIRTIO_IOMMU_ATTACH_F_BYPASS  determines  whether  endpoints
    that are attached to a domain are in bypass mode.
    </dd></dl>
<a 
 id="x1-500002r502"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">5.13.3.1   </span> <a 
 id="x1-5010001"></a>Driver Requirements: Feature bits</h5>
<!--l. 81--><p class="nopar" >The driver SHOULD accept any of the VIRTIO_IOMMU_F_INPUT_RANGE,
VIRTIO_IOMMU_F_DOMAIN_RANGE and VIRTIO_IOMMU_F_PROBE feature
bits if offered by the device.
<a 
 id="x1-501001r507"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.13.3.2   </span> <a 
 id="x1-5020002"></a>Device Requirements: Feature bits</h5>
<!--l. 87--><p class="nopar" >The device SHOULD offer feature bit VIRTIO_IOMMU_F_MAP_UNMAP.
<!--l. 89--><p class="noindent" >The VIRTIO_IOMMU_F_BYPASS_CONFIG feature supersedes VIRTIO_IOMMU_F_BYPASS.
New devices SHOULD NOT offer VIRTIO_IOMMU_F_BYPASS. Devices SHOULD NOT
offer both VIRTIO_IOMMU_F_BYPASS and VIRTIO_IOMMU_F_BYPASS_CONFIG.
<a 
 id="x1-502001r506"></a>
<h4 class="subsectionHead"><span class="titlemark">5.13.4   </span> <a 
 id="x1-5030004"></a>Device configuration layout</h4>
<!--l. 96--><p class="nopar" >The <span 
class="aeti-10">page_size_mask </span>field is always present. Availability of the others all depend on
feature bits described in <a 
href="#x1-5000003">5.13.3<!--tex4ht:ref: sec:Device Types / IOMMU Device / Feature bits --></a>.
<!--l. 100-->
<div class="lstlisting" id="listing-169"><span class="label"><a 
 id="x1-503001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-503002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">page_size_mask</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-503003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_range_64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-503004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">start</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-503005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">end</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-503006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">input_range</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-503007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_range_32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-503008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">start</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-503009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">end</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-503010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">domain_range</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-503011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">probe_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-503012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bypass</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-503013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">[3];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-503014r14"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-503015r508"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.13.4.1   </span> <a 
 id="x1-5040001"></a>Driver Requirements: Device configuration layout</h5>
<!--l. 119--><p class="nopar" >When the VIRTIO_IOMMU_F_BYPASS_CONFIG feature is negotiated, the driver
MAY write to <span 
class="aeti-10">bypass</span>. The driver MUST NOT write to any other device configuration
field.
<!--l. 123--><p class="noindent" >The driver MUST NOT write a value different than 0 or 1 to <span 
class="aeti-10">bypass</span>. The driver
SHOULD ignore bits 1-7 of <span 
class="aeti-10">bypass</span>.
<a 
 id="x1-504001r510"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.13.4.2   </span> <a 
 id="x1-5050002"></a>Device Requirements: Device configuration layout</h5>
<!--l. 129--><p class="nopar" >The device MUST set at least one bit in <span 
class="aeti-10">page_size_mask</span>, describing the page
granularity. The device MAY set more than one bit in <span 
class="aeti-10">page_size_mask</span>.
<!--l. 133--><p class="noindent" >If the device offers the VIRTIO_IOMMU_F_BYPASS_CONFIG feature, it MAY
initialize the <span 
class="aeti-10">bypass </span>field to 1. Field <span 
class="aeti-10">bypass </span>SHOULD NOT change on device reset,
but SHOULD be restored to its initial value on system reset.
<!--l. 138--><p class="noindent" >The device MUST NOT present a value different than 0 or 1 in <span 
class="aeti-10">bypass</span>.
<a 
 id="x1-505001r509"></a>
<h4 class="subsectionHead"><span class="titlemark">5.13.5   </span> <a 
 id="x1-5060005"></a>Device initialization</h4>
<!--l. 143--><p class="nopar" >When the device is reset, endpoints are not attached to any domain.
                                                                  

                                                                  
<!--l. 145--><p class="noindent" >Future devices might support more modes of operation besides MAP/UNMAP.
Drivers verify that devices set VIRTIO_IOMMU_F_MAP_UNMAP and fail gracefully
if they don’t.
<a 
 id="x1-506001r511"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.13.5.1   </span> <a 
 id="x1-5070001"></a>Driver Requirements: Device Initialization</h5>
<!--l. 151--><p class="nopar" >The driver MUST NOT negotiate VIRTIO_IOMMU_F_MAP_UNMAP if it is
incapable of sending VIRTIO_IOMMU_T_MAP and VIRTIO_IOMMU_T_UNMAP
requests.
<!--l. 154--><p class="noindent" >If the VIRTIO_IOMMU_F_PROBE feature is negotiated, the driver SHOULD send a
VIRTIO_IOMMU_T_PROBE request for each endpoint before attaching the endpoint
to a domain.
<a 
 id="x1-507001r512"></a>
<h4 class="subsectionHead"><span class="titlemark">5.13.6   </span> <a 
 id="x1-5080006"></a>Device operations</h4>
<!--l. 160--><p class="nopar" >Driver send requests on the request virtqueue, notifies the device and waits for the
device to return the request with a status in the used ring. All requests are split in
two parts: one device-readable, one device- writable.
<!--l. 165-->
<div class="lstlisting" id="listing-170"><span class="label"><a 
 id="x1-508001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_req_head</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">[3];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508006r6"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_req_tail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">[3];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508009r9"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 177--><p class="noindent" >Type may be one of:
<!--l. 179-->
<div class="lstlisting" id="listing-171"><span class="label"><a 
 id="x1-508010r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_T_ATTACH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508011r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_T_DETACH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508012r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_T_MAP</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508013r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_T_UNMAP</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508014r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_T_PROBE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span>
</div>
<!--l. 187--><p class="noindent" >A few general-purpose status codes are defined here.
<!--l. 189-->
<div class="lstlisting" id="listing-172"><span class="label"><a 
 id="x1-508015r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">All</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">good</span><span 
class="pcrr8t-x-x-80">!</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Carry</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">on</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508016r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_S_OK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508017r3"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Virtio</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">communication</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">error</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508018r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_S_IOERR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508019r5"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Unsupported</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">request</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508020r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_S_UNSUPP</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508021r7"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Internal</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">error</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508022r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_S_DEVERR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508023r9"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Invalid</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">parameters</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508024r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_S_INVAL</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508025r11"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Out</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">range</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">parameters</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508026r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_S_RANGE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">5</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508027r13"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Entry</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">not</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">found</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508028r14"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_S_NOENT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">6</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508029r15"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Bad</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">address</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508030r16"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_S_FAULT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">7</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508031r17"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Insufficient</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">resources</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-508032r18"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_S_NOMEM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span>
</div>
<!--l. 210--><p class="noindent" >When the device fails to parse a request, for instance if a request is too small for its
type and the device cannot find the tail, then it is unable to set <span 
class="aeti-10">status</span>. In that case,
it returns the buffers without writing to them.
<!--l. 215--><p class="noindent" >Range limits of some request fields are described in the device configuration:
    <ul class="itemize1">
    <li class="itemize"><span 
class="aeti-10">page_size_mask </span>contains the bitmask of all page sizes that can be mapped.
                                                                  

                                                                  
    The  least  significant  bit  set  defines  the  page  granularity  of  IOMMU
    mappings.
    <!--l. 223--><p class="noindent" >The smallest page granularity supported by the IOMMU is one byte. It is
    legal for the driver to map one byte at a time if bit 0 of <span 
class="aeti-10">page_size_mask </span>is
    set.
    <!--l. 227--><p class="noindent" >Other bits in <span 
class="aeti-10">page_size_mask </span>are hints and describe larger page sizes that
    the IOMMU device handles efficiently. For example, when the device stores
    mappings using a page table tree, it may be able to describe large mappings
    using a few leaf entries in intermediate tables, rather than using lots of
    entries in the last level of the tree. Creating mappings aligned on large
    page sizes can improve performance since they require fewer page table and
    TLB entries.
    </li>
    <li class="itemize">If       the       VIRTIO_IOMMU_F_DOMAIN_RANGE       feature       is
    offered, <span 
class="aeti-10">domain_range </span>describes the values supported in a <span 
class="aeti-10">domain </span>field. If
    the feature is not offered, any <span 
class="aeti-10">domain </span>value is valid.
    </li>
    <li class="itemize">If the VIRTIO_IOMMU_F_INPUT_RANGE feature is offered, <span 
class="aeti-10">input_range</span>
    contains the virtual address range that the IOMMU is able to translate.
    Any mapping request to virtual addresses outside of this range fails.
    <!--l. 244--><p class="noindent" >If the feature is not offered, virtual mappings span over the whole 64-bit
    address space (<span 
class="pcrr8t-">start = 0, end = 0xffffffff ffffffff</span>)</li></ul>
<!--l. 248--><p class="noindent" >An endpoint is in bypass mode if:
    <ul class="itemize1">
    <li class="itemize">the VIRTIO_IOMMU_F_BYPASS_CONFIG feature is offered and:
        <ul class="itemize2">
        <li class="itemize">config  field  <span 
class="aeti-10">bypass  </span>is  1  and  the  endpoint  is  not  attached  to
        a   domain.   This   applies   even   if   the   driver   does   not   accept
        the  VIRTIO_IOMMU_F_BYPASS_CONFIG  feature  and  the  device
        initializes field <span 
class="aeti-10">bypass </span>to 1.
        <!--l. 257--><p class="noindent" >or
        </li>
        <li class="itemize">the      endpoint      is      attached      to      a      domain      with
        VIRTIO_IOMMU_ATTACH_F_BYPASS.</li></ul>
    <!--l. 261--><p class="nopar" >or
    </li>
    <li class="itemize">the VIRTIO_IOMMU_F_BYPASS feature is negotiated and the endpoint is not
    attached to a domain.</li></ul>
<!--l. 266--><p class="noindent" >All accesses from an endpoint in bypass mode are allowed and translated by the
                                                                  

                                                                  
IOMMU using the identity function.
<a 
 id="x1-508033r513"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.13.6.1   </span> <a 
 id="x1-5090001"></a>Driver Requirements: Device operations</h5>
<!--l. 271--><p class="nopar" >The driver SHOULD set field <span 
class="aeti-10">reserved </span>of struct virtio_iommu_req_head to zero and
MUST ignore field <span 
class="aeti-10">reserved </span>of struct virtio_iommu_req_tail.
<!--l. 275--><p class="noindent" >When a device uses a buffer without having written to it (i.e. used length is zero), the
driver SHOULD interpret it as a request failure.
<!--l. 278--><p class="noindent" >If the VIRTIO_IOMMU_F_INPUT_RANGE feature is negotiated, the driver MUST
NOT send requests with <span 
class="aeti-10">virt_start </span>less than <span 
class="aeti-10">input_range.start </span>or <span 
class="aeti-10">virt_end </span>greater
than <span 
class="aeti-10">input_range.end</span>.
<!--l. 283--><p class="noindent" >If the VIRTIO_IOMMU_F_DOMAIN_RANGE feature is negotiated, the driver
MUST NOT send requests with <span 
class="aeti-10">domain </span>less than <span 
class="aeti-10">domain_range.start </span>or greater than
<span 
class="aeti-10">domain_range.end</span>.
<a 
 id="x1-509001r515"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.13.6.2   </span> <a 
 id="x1-5100002"></a>Device Requirements: Device operations</h5>
<!--l. 289--><p class="nopar" >The device SHOULD set <span 
class="aeti-10">status </span>to VIRTIO_IOMMU_S_OK if a request succeeds.
<!--l. 292--><p class="noindent" >If a request <span 
class="aeti-10">type </span>is not recognized, the device SHOULD NOT write the buffer and
SHOULD set the used length to zero.
<!--l. 295--><p class="noindent" >The device MUST ignore field <span 
class="aeti-10">reserved </span>of struct virtio_iommu_req_head and
SHOULD set field <span 
class="aeti-10">reserved </span>of struct virtio_iommu_req_tail to zero.
<!--l. 299--><p class="noindent" >The device SHOULD NOT let unattached endpoints that are not in bypass mode
access the guest-physical address space.
<a 
 id="x1-510001r516"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.13.6.3   </span> <a 
 id="x1-5110003"></a>ATTACH request</h5>
<!--l. 304-->
<div class="lstlisting" id="listing-173"><span class="label"><a 
 id="x1-511001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_req_attach</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-511002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_req_head</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">head</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-511003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">domain</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-511004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">endpoint</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-511005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-511006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">[4];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-511007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_req_tail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tail</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-511008r8"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-511009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-511010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_ATTACH_F_BYPASS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0)</span>
</div>
<!--l. 317--><p class="noindent" >Attach an endpoint to a domain. <span 
class="aeti-10">domain </span>uniquely identifies a domain within the
virtio-iommu device. If the domain doesn’t exist in the device, it is created.
Semantics of the <span 
class="aeti-10">endpoint </span>identifier are platform specific, but the following rules
apply:
    <ul class="itemize1">
    <li class="itemize">The endpoint ID uniquely identifies an endpoint from the virtio-iommu
    point  of  view.  Multiple  endpoints  whose  DMA  transactions  are  not
    translated by the same virtio-iommu device can have the same endpoint
    ID. Endpoints whose DMA transactions may be translated by the same
    virtio-iommu device have different endpoint IDs.
                                                                  

                                                                  
    </li>
    <li class="itemize">On some platforms, it might not be possible to completely isolate two
    endpoints  from  each  other.  For  example  on  a  conventional  PCI  bus,
    endpoints can snoop DMA transactions from other endpoints on the same
    bus. Such limitations need to be communicated in a platform specific way.</li></ul>
<!--l. 336--><p class="noindent" >Multiple endpoints can be attached to the same domain. An endpoint can be
attached to a single domain at a time. Endpoints attached to different domains are
isolated from each other.
<!--l. 340--><p class="noindent" >When the VIRTIO_IOMMU_F_BYPASS_CONFIG is negotiated, the driver can set
the VIRTIO_IOMMU_ATTACH_F_BYPASS flag to create a bypass domain.
Endpoints attached to this domain are in bypass mode.
<a 
 id="x1-511011r500"></a>
<h5 class="paragraphHead"><span class="titlemark">5.13.6.3.1</span> <a 
 id="x1-5120001"></a>Driver Requirements: ATTACH request</h5>
The driver SHOULD set <span 
class="aeti-10">reserved </span>to zero.
<!--l. 348--><p class="noindent" >The driver SHOULD ensure that endpoints that cannot be isolated from each other
are attached to the same domain.
<!--l. 351--><p class="noindent" >If the domain already exists and is a bypass domain, the driver SHOULD set the
VIRTIO_IOMMU_ATTACH_F_BYPASS flag. If the domain exists and is not a bypass
domain, the driver SHOULD NOT set the VIRTIO_IOMMU_ATTACH_F_BYPASS
flag.
<a 
 id="x1-512001r518"></a>
<h5 class="paragraphHead"><span class="titlemark">5.13.6.3.2</span> <a 
 id="x1-5130002"></a>Device Requirements: ATTACH request</h5>
If the <span 
class="aeti-10">reserved </span>field of an ATTACH request is not zero, the device MUST reject the
request and set <span 
class="aeti-10">status </span>to VIRTIO_IOMMU_S_INVAL.
<!--l. 361--><p class="noindent" >If the device does not recognize a <span 
class="aeti-10">flags </span>bit, it MUST reject the request and set <span 
class="aeti-10">status</span>
to VIRTIO_IOMMU_S_INVAL.
<!--l. 365--><p class="noindent" >If the endpoint identified by <span 
class="aeti-10">endpoint </span>doesn’t exist, the device MUST reject the
request and set <span 
class="aeti-10">status </span>to VIRTIO_IOMMU_S_NOENT.
<!--l. 368--><p class="noindent" >If another endpoint is already attached to the domain identified by <span 
class="aeti-10">domain</span>, then
the device MAY attach the endpoint identified by <span 
class="aeti-10">endpoint </span>to the domain.
If it cannot do so, the device MUST reject the request and set <span 
class="aeti-10">status </span>to
VIRTIO_IOMMU_S_UNSUPP.
<!--l. 373--><p class="noindent" >If the domain already exists and the VIRTIO_IOMMU_ATTACH_F_BYPASS flag is
not consistent with that domain, the device SHOULD reject the request and set
<span 
class="aeti-10">status </span>to VIRTIO_IOMMU_S_INVAL.
<!--l. 377--><p class="noindent" >If the endpoint identified by <span 
class="aeti-10">endpoint </span>is already attached to another domain, then
the device SHOULD first detach it from that domain and attach it to the one
identified by <span 
class="aeti-10">domain</span>. In that case the device SHOULD behave as if the driver issued
                                                                  

                                                                  
a DETACH request with this <span 
class="aeti-10">endpoint</span>, followed by the ATTACH request.
If the device cannot do so, it MUST reject the request and set <span 
class="aeti-10">status </span>to
VIRTIO_IOMMU_S_UNSUPP.
<!--l. 385--><p class="noindent" >If properties of the endpoint (obtained with a PROBE request) are compatible with
properties of other endpoints already attached to the requested domain, then the
device SHOULD attach the endpoint. Otherwise the device SHOULD reject the
request and set <span 
class="aeti-10">status </span>to VIRTIO_IOMMU_S_UNSUPP.
<!--l. 391--><p class="noindent" >A device that does not reject the request MUST attach the endpoint.
<a 
 id="x1-513001r517"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.13.6.4   </span> <a 
 id="x1-5140004"></a>DETACH request</h5>
<!--l. 395-->
<div class="lstlisting" id="listing-174"><span class="label"><a 
 id="x1-514001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_req_detach</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-514002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_req_head</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">head</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-514003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">domain</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-514004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">endpoint</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-514005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">[8];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-514006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_req_tail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tail</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-514007r7"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 405--><p class="noindent" >Detach an endpoint from a domain. When this request completes, the endpoint
cannot access any mapping from that domain anymore. However the endpoint may
then be in bypass mode and access the guest-physical address space.
<!--l. 410--><p class="noindent" >After all endpoints have been successfully detached from a domain, it ceases to exist
and its ID can be reused by the driver for another domain.
<a 
 id="x1-514008r519"></a>
<h5 class="paragraphHead"><span class="titlemark">5.13.6.4.1</span> <a 
 id="x1-5150001"></a>Driver Requirements: DETACH request</h5>
The driver SHOULD set <span 
class="aeti-10">reserved </span>to zero.
<a 
 id="x1-515001r521"></a>
<h5 class="paragraphHead"><span class="titlemark">5.13.6.4.2</span> <a 
 id="x1-5160002"></a>Device Requirements: DETACH request</h5>
The device MUST ignore <span 
class="aeti-10">reserved</span>.
<!--l. 421--><p class="noindent" >If the endpoint identified by <span 
class="aeti-10">endpoint </span>doesn’t exist, then the device MUST reject the
request and set <span 
class="aeti-10">status </span>to VIRTIO_IOMMU_S_NOENT.
<!--l. 425--><p class="noindent" >If the domain identified by <span 
class="aeti-10">domain </span>doesn’t exist, or if the endpoint identified by
<span 
class="aeti-10">endpoint </span>isn’t attached to this domain, then the device MAY set the request <span 
class="aeti-10">status </span>to
VIRTIO_IOMMU_S_INVAL.
<!--l. 430--><p class="noindent" >The device MUST ensure that after being detached from a domain, the endpoint
cannot access any mapping from that domain.
<a 
 id="x1-516001r520"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.13.6.5   </span> <a 
 id="x1-5170005"></a>MAP request</h5>
<!--l. 435-->
                                                                  

                                                                  
<div class="lstlisting" id="listing-175"><span class="label"><a 
 id="x1-517001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_req_map</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-517002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_req_head</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">head</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-517003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">domain</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-517004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virt_start</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-517005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virt_end</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-517006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">phys_start</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-517007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-517008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_req_tail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tail</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-517009r9"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-517010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-517011r11"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Read</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">access</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">allowed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-517012r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_MAP_F_READ</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-517013r13"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Write</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">access</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">allowed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-517014r14"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_MAP_F_WRITE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-517015r15"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Accesses</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">memory</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">mapped</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">I</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">O</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-517016r16"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_MAP_F_MMIO</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2)</span>
</div>
<!--l. 454--><p class="noindent" >Map a range of virtually-contiguous addresses to a range of physically-contiguous
addresses of the same size. After the request succeeds, all endpoints attached to this
domain can access memory in the range <span 
class="cmr-10">[</span><span 
class="cmmi-10">virt</span>_<span 
class="cmmi-10">start</span><span 
class="cmr-10">;</span><span 
class="cmmi-10">virt</span>_<span 
class="cmmi-10">end</span><span 
class="cmr-10">] </span>(inclusive). For
example, if an endpoint accesses address <span 
class="cmmi-10">V A </span><span 
class="cmsy-10">∈ </span><span 
class="cmr-10">[</span><span 
class="cmmi-10">virt</span>_<span 
class="cmmi-10">start</span><span 
class="cmr-10">;</span><span 
class="cmmi-10">virt</span>_<span 
class="cmmi-10">end</span><span 
class="cmr-10">]</span>, the device (or
the physical IOMMU) translates the address: <span 
class="cmmi-10">PA </span><span 
class="cmr-10">= </span><span 
class="cmmi-10">V A</span><span 
class="cmsy-10">−</span><span 
class="cmmi-10">virt</span>_<span 
class="cmmi-10">start </span><span 
class="cmr-10">+ </span><span 
class="cmmi-10">phys</span>_<span 
class="cmmi-10">start</span>. If
the access parameters are compatible with <span 
class="aeti-10">flags </span>(for instance, the access is write and
<span 
class="aeti-10">flags </span>are VIRTIO_IOMMU_MAP_F_READ | VIRTIO_IOMMU_MAP_F_WRITE)
then the IOMMU allows the access to reach <span 
class="cmmi-10">PA</span>.
<!--l. 465--><p class="noindent" >The range defined by <span 
class="aeti-10">virt_start </span>and <span 
class="aeti-10">virt_end </span>should be within the limits specified by
<span 
class="aeti-10">input_range</span>. Given <span 
class="cmmi-10">phys</span>_<span 
class="cmmi-10">end </span><span 
class="cmr-10">= </span><span 
class="cmmi-10">phys</span>_<span 
class="cmmi-10">start </span><span 
class="cmr-10">+ </span><span 
class="cmmi-10">virt</span>_<span 
class="cmmi-10">end</span><span 
class="cmsy-10">−</span><span 
class="cmmi-10">virt</span>_<span 
class="cmmi-10">start</span>, the range defined
by <span 
class="aeti-10">phys_start </span>and phys_end should be within the guest-physical address space. This
includes upper and lower limits, as well as any carving of guest-physical addresses for
use by the host. Guest physical boundaries are set by the host in a platform specific
way.
<!--l. 473--><p class="noindent" >Availability and allowed combinations of <span 
class="aeti-10">flags </span>depend on the underlying IOMMU
architectures. VIRTIO_IOMMU_MAP_F_READ and VIRTIO_IOMMU_MAP_F_WRITE
are usually implemented, although READ is sometimes implied by WRITE.
In addition combinations such as "WRITE and not READ" might not be
supported.
<!--l. 479--><p class="noindent" >The VIRTIO_IOMMU_MAP_F_MMIO flag is a memory type rather than a
protection flag. It is only available when the VIRTIO_IOMMU_F_MMIO feature
has been negotiated. Accesses to the mapping are not speculated, buffered,
cached, split into multiple accesses or combined with other accesses. It may be
used, for example, to map Message Signaled Interrupt doorbells when a
VIRTIO_IOMMU_RESV_MEM_T_MSI region isn’t available. To trigger interrupts
the endpoint performs a direct memory write to another peripheral, the IRQ
chip.
<!--l. 488--><p class="noindent" >This request is only available when VIRTIO_IOMMU_F_MAP_UNMAP has been
negotiated.
<a 
 id="x1-517017r522"></a>
<h5 class="paragraphHead"><span class="titlemark">5.13.6.5.1</span> <a 
 id="x1-5180001"></a>Driver Requirements: MAP request</h5>
The driver SHOULD set undefined <span 
class="aeti-10">flags </span>bits to zero.
<!--l. 495--><p class="noindent" >The driver SHOULD NOT send MAP requests on a bypass domain.
<!--l. 497--><p class="noindent" ><span 
class="aeti-10">virt_end </span>MUST be strictly greater than <span 
class="aeti-10">virt_start</span>.
<!--l. 499--><p class="noindent" >The driver SHOULD set the VIRTIO_IOMMU_MAP_F_MMIO flag when the
physical range corresponds to memory-mapped device registers. The physical range
                                                                  

                                                                  
SHOULD have a single memory type: either normal memory or memory-mapped
I/O.
<!--l. 504--><p class="noindent" >If it intends to allow read accesses from endpoints attached to the domain, the driver
MUST set the VIRTIO_IOMMU_MAP_F_READ flag.
<!--l. 507--><p class="noindent" >If the VIRTIO_IOMMU_F_MMIO feature isn’t negotiated, the driver MUST NOT
use the VIRTIO_IOMMU_MAP_F_MMIO flag.
<a 
 id="x1-518001r524"></a>
<h5 class="paragraphHead"><span class="titlemark">5.13.6.5.2</span> <a 
 id="x1-5190002"></a>Device Requirements: MAP request</h5>
If <span 
class="aeti-10">virt_start</span>, <span 
class="aeti-10">phys_start </span>or (<span 
class="aeti-10">virt_end </span>+ 1) is not aligned on the page granularity, the
device SHOULD reject the request and set <span 
class="aeti-10">status </span>to VIRTIO_IOMMU_S_RANGE.
<!--l. 516--><p class="noindent" >If a mapping already exists in the requested range, the device SHOULD reject the
request and set <span 
class="aeti-10">status </span>to VIRTIO_IOMMU_S_INVAL.
<!--l. 519--><p class="noindent" >If the device doesn’t recognize a <span 
class="aeti-10">flags </span>bit, it MUST reject the request and set <span 
class="aeti-10">status</span>
to VIRTIO_IOMMU_S_INVAL.
<!--l. 522--><p class="noindent" >If <span 
class="aeti-10">domain </span>does not exist, the device SHOULD reject the request and set <span 
class="aeti-10">status </span>to
VIRTIO_IOMMU_S_NOENT.
<!--l. 525--><p class="noindent" >If the domain is a bypass domain, the device SHOULD reject the request and set
<span 
class="aeti-10">status </span>to VIRTIO_IOMMU_S_INVAL.
<!--l. 528--><p class="noindent" >The device MUST NOT allow writes to a range mapped without the
VIRTIO_IOMMU_MAP_F_WRITE flag. However, if the underlying architecture does
not support write-only mappings, the device MAY allow reads to a range mapped
with VIRTIO_IOMMU_MAP_F_WRITE but not VIRTIO_IOMMU_MAP_F_READ.
<a 
 id="x1-519001r523"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.13.6.6   </span> <a 
 id="x1-5200006"></a>UNMAP request</h5>
<!--l. 536-->
<div class="lstlisting" id="listing-176"><span class="label"><a 
 id="x1-520001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_req_unmap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_req_head</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">head</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">domain</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virt_start</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virt_end</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">[4];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_req_tail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tail</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520008r8"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 547--><p class="noindent" >Unmap a range of addresses mapped with VIRTIO_IOMMU_T_MAP. We define here
a mapping as a virtual region created with a single MAP request. All mappings
covered by the range <span 
class="cmr-10">[</span><span 
class="cmmi-10">virt</span>_<span 
class="cmmi-10">start</span><span 
class="cmr-10">;</span><span 
class="cmmi-10">virt</span>_<span 
class="cmmi-10">end</span><span 
class="cmr-10">] </span>(inclusive) are removed.
<!--l. 552--><p class="noindent" >The semantics of unmapping are specified in <a 
href="#x1-5210001">5.13.6.6.1<!--tex4ht:ref: drivernormative:Device Types / IOMMU Device / Device operations / UNMAP request --></a> and <a 
href="#x1-5220002">5.13.6.6.2<!--tex4ht:ref: devicenormative:Device Types / IOMMU Device / Device operations / UNMAP request --></a>, and illustrated
with the following requests, assuming each example sequence starts with a blank
address space. We define two pseudocode functions <span 
class="pcrr8t-">map(virt_start,</span>
<span 
class="pcrr8t-">virt_end) -&gt; mapping </span>and <span 
class="pcrr8t-">unmap(virt_start, virt_end)</span>.
<!--l. 560-->
                                                                  

                                                                  
<div class="lstlisting" id="listing-177"><span class="label"><a 
 id="x1-520009r1"></a></span><span 
class="pcrr8t-x-x-80">(1)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unmap</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">virt_start</span><span 
class="pcrr8t-x-x-80">=0,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520010r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virt_end</span><span 
class="pcrr8t-x-x-80">=4)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">succeeds</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">doesn</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">t</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unmap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">anything</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520011r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520012r4"></a></span><span 
class="pcrr8t-x-x-80">(2)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">map</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">virt_start</span><span 
class="pcrr8t-x-x-80">=0,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520013r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virt_end</span><span 
class="pcrr8t-x-x-80">=9)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520014r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unmap</span><span 
class="pcrr8t-x-x-80">(0,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">succeeds</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unmaps</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520015r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520016r8"></a></span><span 
class="pcrr8t-x-x-80">(3)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">map</span><span 
class="pcrr8t-x-x-80">(0,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520017r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">b</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">map</span><span 
class="pcrr8t-x-x-80">(5,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520018r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unmap</span><span 
class="pcrr8t-x-x-80">(0,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">succeeds</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unmaps</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">b</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520019r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520020r12"></a></span><span 
class="pcrr8t-x-x-80">(4)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">map</span><span 
class="pcrr8t-x-x-80">(0,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520021r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unmap</span><span 
class="pcrr8t-x-x-80">(0,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fails</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">doesn</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">t</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unmap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">anything</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520022r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520023r15"></a></span><span 
class="pcrr8t-x-x-80">(5)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">map</span><span 
class="pcrr8t-x-x-80">(0,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520024r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">b</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">map</span><span 
class="pcrr8t-x-x-80">(5,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520025r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unmap</span><span 
class="pcrr8t-x-x-80">(0,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">succeeds</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unmaps</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520026r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520027r19"></a></span><span 
class="pcrr8t-x-x-80">(6)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">map</span><span 
class="pcrr8t-x-x-80">(0,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520028r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unmap</span><span 
class="pcrr8t-x-x-80">(0,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">9)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">succeeds</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unmaps</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520029r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520030r22"></a></span><span 
class="pcrr8t-x-x-80">(7)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">map</span><span 
class="pcrr8t-x-x-80">(0,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520031r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">b</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">map</span><span 
class="pcrr8t-x-x-80">(10,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">14)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-520032r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unmap</span><span 
class="pcrr8t-x-x-80">(0,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">14)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">succeeds</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unmaps</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">b</span>
</div>
<!--l. 587--><p class="noindent" >As illustrated by example (4), partially removing a mapping isn’t supported.
<!--l. 590--><p class="noindent" >This request is only available when VIRTIO_IOMMU_F_MAP_UNMAP has been
negotiated.
<a 
 id="x1-520033r525"></a>
<h5 class="paragraphHead"><span class="titlemark">5.13.6.6.1</span> <a 
 id="x1-5210001"></a>Driver Requirements: UNMAP request</h5>
The driver SHOULD set the <span 
class="aeti-10">reserved </span>field to zero.
<!--l. 597--><p class="noindent" >The range, defined by <span 
class="aeti-10">virt_start </span>and <span 
class="aeti-10">virt_end</span>, SHOULD cover one or more contiguous
mappings created with MAP requests. The range MAY spill over unmapped virtual
addresses.
<!--l. 601--><p class="noindent" >The first address of a range MUST either be the first address of a mapping or be
outside any mapping. The last address of a range MUST either be the last address of
a mapping or be outside any mapping.
<!--l. 605--><p class="noindent" >The driver SHOULD NOT send UNMAP requests on a bypass domain.
<a 
 id="x1-521001r527"></a>
<h5 class="paragraphHead"><span class="titlemark">5.13.6.6.2</span> <a 
 id="x1-5220002"></a>Device Requirements: UNMAP request</h5>
If the <span 
class="aeti-10">reserved </span>field of an UNMAP request is not zero, the device MAY set the
request <span 
class="aeti-10">status </span>to VIRTIO_IOMMU_S_INVAL, in which case the device MAY perform
the UNMAP operation.
<!--l. 613--><p class="noindent" >If <span 
class="aeti-10">domain </span>does not exist, the device SHOULD set the request <span 
class="aeti-10">status </span>to
VIRTIO_IOMMU_S_NOENT.
<!--l. 616--><p class="noindent" >If the domain is a bypass domain, the device SHOULD reject the request and set
<span 
class="aeti-10">status </span>to VIRTIO_IOMMU_S_INVAL.
<!--l. 619--><p class="noindent" >If a mapping affected by the range is not covered in its entirety by the range (the
UNMAP request would split the mapping), then the device SHOULD set the request
<span 
class="aeti-10">status </span>to VIRTIO_IOMMU_S_RANGE, and SHOULD NOT remove any
mapping.
<!--l. 624--><p class="noindent" >If part of the range or the full range is not covered by an existing mapping, then the
device SHOULD remove all mappings affected by the range and set the request <span 
class="aeti-10">status</span>
to VIRTIO_IOMMU_S_OK.
<a 
 id="x1-522001r526"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.13.6.7   </span> <a 
 id="x1-5230007"></a>PROBE request</h5>
<!--l. 630--><p class="nopar" >If the VIRTIO_IOMMU_F_PROBE feature bit is present, the driver sends a
VIRTIO_IOMMU_T_PROBE request for each endpoint that the virtio-iommu
device manages. This probe is performed before attaching the endpoint to a
                                                                  

                                                                  
domain.
<!--l. 635-->
<div class="lstlisting" id="listing-178"><span class="label"><a 
 id="x1-523001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_req_probe</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-523002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_req_head</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">head</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-523003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">readable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-523004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">endpoint</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-523005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">[64];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-523006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-523007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-523008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">properties</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">probe_size</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-523009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_req_tail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">tail</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-523010r10"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">endpoint</span> </dt><dd 
class="description">has the same meaning as in ATTACH and DETACH requests.
    </dd><dt class="description">
<span 
class="aebxti-10">reserved</span> </dt><dd 
class="description">is used as padding, so that future extensions can add fields to the
    device-readable part.
    </dd><dt class="description">
<span 
class="aebxti-10">properties</span> </dt><dd 
class="description">contains a list of properties of the <span 
class="aeti-10">endpoint</span>, filled by the device. The
    length of the <span 
class="aeti-10">properties </span>field is <span 
class="aeti-10">probe_size </span>bytes. Each property is described
    with a struct virtio_iommu_probe_property header, which may be followed
    by a value of size <span 
class="aeti-10">length</span>.
    <!--l. 661-->
    <div class="lstlisting" id="listing-179"><span class="label"><a 
 id="x1-523011r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_probe_property</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-523012r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-523013r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">12;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-523014r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-523015r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-523016r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-523017r7"></a></span><span 
class="pcrr8t-x-x-80">};</span>
    
    </div>
    </dd></dl>
<!--l. 673--><p class="noindent" >The driver allocates a buffer for the PROBE request, large enough to accommodate
<span 
class="aeti-10">probe_size </span>bytes of <span 
class="aeti-10">properties</span>. It writes <span 
class="aeti-10">endpoint </span>and adds the buffer to the request
queue. The device fills the <span 
class="aeti-10">properties </span>field with a list of properties for this
endpoint.
<!--l. 679--><p class="noindent" >The driver parses the first property by reading <span 
class="aeti-10">type</span>, then <span 
class="aeti-10">length</span>. If the driver
recognizes <span 
class="aeti-10">type</span>, it reads and handles the rest of the property. The driver then reads
the next property, that is located <span 
class="cmr-10">(</span><span 
class="aeti-10">length</span> <span 
class="cmr-10">+ 4) </span>bytes after the beginning of the first
one, and so on. The driver parses all properties until it reaches an empty property
(<span 
class="aeti-10">type </span>is 0) or the end of <span 
class="aeti-10">properties</span>.
<!--l. 686--><p class="noindent" >Available property types are described in section <a 
href="#x1-5260008">5.13.6.8<!--tex4ht:ref: sec:Device Types / IOMMU Device / Device operations / PROBE properties --></a>.
<a 
 id="x1-523018r528"></a>
<h5 class="paragraphHead"><span class="titlemark">5.13.6.7.1</span> <a 
 id="x1-5240001"></a>Driver Requirements: PROBE request</h5>
The size of <span 
class="aeti-10">properties </span>MUST be <span 
class="aeti-10">probe_size </span>bytes.
<!--l. 693--><p class="noindent" >The driver SHOULD set field <span 
class="aeti-10">reserved </span>of the PROBE request to zero.
<!--l. 695--><p class="noindent" >If the driver doesn’t recognize the <span 
class="aeti-10">type </span>of a property, it SHOULD ignore the
property.
                                                                  

                                                                  
<!--l. 698--><p class="noindent" >The driver SHOULD NOT deduce the property length from <span 
class="aeti-10">type</span>.
<!--l. 700--><p class="noindent" >The driver MUST ignore a property whose <span 
class="aeti-10">reserved </span>field is not zero.
<!--l. 703--><p class="noindent" >If the driver ignores a property, it SHOULD continue parsing the list.
<a 
 id="x1-524001r530"></a>
<h5 class="paragraphHead"><span class="titlemark">5.13.6.7.2</span> <a 
 id="x1-5250002"></a>Device Requirements: PROBE request</h5>
The device MUST ignore field <span 
class="aeti-10">reserved </span>of a PROBE request.
<!--l. 709--><p class="noindent" >If the endpoint identified by <span 
class="aeti-10">endpoint </span>doesn’t exist, then the device SHOULD reject
the request and set <span 
class="aeti-10">status </span>to VIRTIO_IOMMU_S_NOENT.
<!--l. 713--><p class="noindent" >If the device does not offer the VIRTIO_IOMMU_F_PROBE feature, and if the driver
sends a VIRTIO_IOMMU_T_PROBE request, then the device SHOULD NOT write
the buffer and SHOULD set the used length to zero.
<!--l. 717--><p class="noindent" >The device SHOULD set field <span 
class="aeti-10">reserved </span>of a property to zero.
<!--l. 719--><p class="noindent" >The device MUST write the size of a property without the struct
virtio_iommu_probe_property header, in bytes, into <span 
class="aeti-10">length</span>.
<!--l. 722--><p class="noindent" >When two properties follow each other, the device MUST put the second property
exactly <span 
class="cmr-10">(</span><span 
class="aeti-10">length</span> <span 
class="cmr-10">+ 4) </span>bytes after the beginning of the first one.
<!--l. 726--><p class="noindent" >If the <span 
class="aeti-10">properties </span>list is smaller than <span 
class="aeti-10">probe_size</span>, the device SHOULD NOT write any
property. It SHOULD reject the request and set <span 
class="aeti-10">status </span>to VIRTIO_IOMMU_S_INVAL.
<!--l. 730--><p class="noindent" >If the device doesn’t fill all <span 
class="aeti-10">probe_size </span>bytes with properties, it SHOULD fill the
remaining bytes of <span 
class="aeti-10">properties </span>with zeroes.
<a 
 id="x1-525001r529"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.13.6.8   </span> <a 
 id="x1-5260008"></a>PROBE properties</h5>
<!--l. 735-->
<div class="lstlisting" id="listing-180"><span class="label"><a 
 id="x1-526001r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_PROBE_T_RESV_MEM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span>
</div>
<a 
 id="x1-526002r531"></a>
<h5 class="paragraphHead"><span class="titlemark">5.13.6.8.1</span> <a 
 id="x1-5270001"></a>Property RESV_MEM</h5>
The RESV_MEM property describes a chunk of reserved virtual memory. It may be
used by the device to describe virtual address ranges that cannot be used by the
driver, or that are special.
<!--l. 745-->
<div class="lstlisting" id="listing-181"><span class="label"><a 
 id="x1-527001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_probe_resv_mem</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-527002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_probe_property</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">head</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-527003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">subtype</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-527004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">[3];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-527005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">start</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-527006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">end</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-527007r7"></a></span><span 
class="pcrr8t-x-x-80">};</span>
                                                                  

                                                                  
</div>
<!--l. 755--><p class="noindent" >Fields <span 
class="aeti-10">start </span>and <span 
class="aeti-10">end </span>describe the range of reserved virtual addresses. <span 
class="aeti-10">subtype </span>may be
one of:
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_IOMMU_RESV_MEM_T_RESERVED (0)</span> </dt><dd 
class="description">These   virtual   addresses
    cannot be used in a MAP requests. The region is be reserved by the device,
    for example, if the platform needs to setup DMA mappings of its own.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_IOMMU_RESV_MEM_T_MSI (1)</span> </dt><dd 
class="description">This
    region is a doorbell for Message Signaled Interrupts (MSIs). It is similar to
    VIRTIO_IOMMU_RESV_MEM_T_RESERVED, in that the driver cannot
    map virtual addresses described by the property.
    <!--l. 769--><p class="noindent" >In addition it provides information about MSI doorbells. If the endpoint
    doesn’t have a VIRTIO_IOMMU_RESV_MEM_T_MSI property, then the
    driver creates an MMIO mapping to the doorbell of the MSI controller.</dd></dl>
<a 
 id="x1-527008r432"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.13.6.8.1.1</span> <a 
 id="x1-5280001"></a>Driver Requirements: Property RESV_MEM</h6>
The driver SHOULD NOT map any virtual address described by a
VIRTIO_IOMMU_RESV_MEM_T_RESERVED or VIRTIO_IOMMU_RESV_MEM_T_MSI
property.
<!--l. 779--><p class="noindent" >The driver MUST ignore <span 
class="aeti-10">reserved</span>.
<!--l. 781--><p class="noindent" >The driver SHOULD treat any <span 
class="aeti-10">subtype </span>it doesn’t recognize as if it was
VIRTIO_IOMMU_RESV_MEM_T_RESERVED.
<a 
 id="x1-528001r534"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.13.6.8.1.2</span> <a 
 id="x1-5290002"></a>Device Requirements: Property RESV_MEM</h6>
The device SHOULD set <span 
class="aeti-10">reserved </span>to zero.
<!--l. 788--><p class="noindent" >The device SHOULD NOT present more than one VIRTIO_IOMMU_RESV_MEM_T_MSI
property per endpoint.
<!--l. 791--><p class="noindent" >The device SHOULD NOT present multiple RESV_MEM properties that overlap
each other for the same endpoint.
<!--l. 794--><p class="noindent" >The device SHOULD reject a MAP request that overlaps a RESV_MEM
region.
<!--l. 796--><p class="noindent" >The device SHOULD NOT allow accesses from the endpoint to RESV_MEM regions
to affect any other component than the endpoint and the driver.
<a 
 id="x1-529001r532"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.13.6.9   </span> <a 
 id="x1-5300009"></a>Fault reporting</h5>
<!--l. 801--><p class="nopar" >The device can report translation faults and other significant asynchronous events on
                                                                  

                                                                  
the event virtqueue. The driver initially populates the queue with device-writeable
buffers. When the device needs to report an event, it fills a buffer and notifies
the driver. The driver consumes the report and adds a new buffer to the
virtqueue.
<!--l. 807--><p class="noindent" >If no buffer is available, the device can either wait for one to be consumed, or drop
the event.
<!--l. 810-->
<div class="lstlisting" id="listing-182"><span class="label"><a 
 id="x1-530001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_iommu_fault</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-530002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reason</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-530003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">[3];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-530004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-530005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">endpoint</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-530006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved1</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-530007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">address</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-530008r8"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-530009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-530010r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_FAULT_F_READ</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-530011r11"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_FAULT_F_WRITE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-530012r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_IOMMU_FAULT_F_ADDRESS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8)</span>
</div>
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">reason</span> </dt><dd 
class="description">The reason for this report. It may have the following values:
        <dl class="description"><dt class="description">
    <span 
class="aeb10-">VIRTIO_IOMMU_FAULT_R_UNKNOWN (0)</span> </dt><dd 
class="description">
        An internal error happened, or an error that cannot be described with
        the following reasons.
        </dd><dt class="description">
    <span 
class="aeb10-">VIRTIO_IOMMU_FAULT_R_DOMAIN (1)</span> </dt><dd 
class="description">The  endpoint  attempted  to
        access <span 
class="aeti-10">address </span>without being attached to a domain.
        </dd><dt class="description">
    <span 
class="aeb10-">VIRTIO_IOMMU_FAULT_R_MAPPING (2)</span> </dt><dd 
class="description">The endpoint attempted to
        access <span 
class="aeti-10">address</span>, which wasn’t mapped in the domain or didn’t have the
        correct protection flags.</dd></dl>
    </dd><dt class="description">
<span 
class="aebxti-10">flags</span> </dt><dd 
class="description">Information about the fault context.
    </dd><dt class="description">
<span 
class="aebxti-10">endpoint</span> </dt><dd 
class="description">The endpoint causing the fault.
    </dd><dt class="description">
<span 
class="aebxti-10">reserved </span><span 
class="aeb10-">and </span><span 
class="aebxti-10">reserved1</span> </dt><dd 
class="description">Should be zero.
    </dd><dt class="description">
<span 
class="aebxti-10">address</span> </dt><dd 
class="description">If VIRTIO_IOMMU_FAULT_F_ADDRESS is set, the address causing the
    fault.</dd></dl>
<!--l. 844--><p class="noindent" >When the fault is reported by a physical IOMMU, the fault reasons may not match
exactly the reason of the original fault report. The device does its best to find the
closest match.
<!--l. 848--><p class="noindent" >If the device encounters an internal error that wasn’t caused by a specific endpoint, it
is unlikely that the driver would be able to do anything else than print the fault and
stop using the device, so reporting the fault on the event queue isn’t useful.
In that case, we recommend using the DEVICE_NEEDS_RESET status
                                                                  

                                                                  
bit.
<a 
 id="x1-530013r533"></a>
<h5 class="paragraphHead"><span class="titlemark">5.13.6.9.1</span> <a 
 id="x1-5310001"></a>Driver Requirements: Fault reporting</h5>
If the <span 
class="aeti-10">reserved </span>field is not zero, the driver MUST ignore the fault report.
<!--l. 859--><p class="noindent" >The driver MUST ignore <span 
class="aeti-10">reserved1</span>.
<!--l. 861--><p class="noindent" >The driver MUST ignore undefined <span 
class="aeti-10">flags</span>.
<!--l. 863--><p class="noindent" >If the driver doesn’t recognize <span 
class="aeti-10">reason</span>, it SHOULD treat the fault as if it was
VIRTIO_IOMMU_FAULT_R_UNKNOWN.
<a 
 id="x1-531001r537"></a>
<h5 class="paragraphHead"><span class="titlemark">5.13.6.9.2</span> <a 
 id="x1-5320002"></a>Device Requirements: Fault reporting</h5>
The device SHOULD set <span 
class="aeti-10">reserved </span>and <span 
class="aeti-10">reserved1 </span>to zero.
<!--l. 870--><p class="noindent" >The device SHOULD set undefined <span 
class="aeti-10">flags </span>to zero.
<!--l. 872--><p class="noindent" >The device SHOULD write a valid endpoint ID in <span 
class="aeti-10">endpoint</span>.
<!--l. 874--><p class="noindent" >The device MAY omit setting VIRTIO_IOMMU_FAULT_F_ADDRESS and writing
<span 
class="aeti-10">address </span>in any fault report, regardless of the <span 
class="aeti-10">reason</span>.
<!--l. 877--><p class="noindent" >If a buffer is too small to contain the fault report<span class="footnote-mark"><a 
href="#fn20x5" id="fn20x5-bk"><sup class="textsuperscript">20</sup></a></span>, the device SHOULD NOT use
multiple buffers to describe it. The device MAY fall back to using an older fault
report format that fits in the buffer.
<!--l. 883--><p class="noindent" ><a 
 id="x1-532001f20"></a>
<a 
 id="x1-532002r503"></a>
<h3 class="sectionHead"><span class="titlemark">5.14   </span> <a 
 id="x1-53300014"></a>Sound Device</h3>
<!--l. 3--><p class="nopar" >The virtio sound card is a virtual audio device supporting input and output PCM
streams.
<!--l. 6--><p class="noindent" >A device is managed by control requests and can send various notifications through
dedicated queues. A driver can transmit PCM frames using message-based transport
or shared memory.
<!--l. 10--><p class="noindent" >A small part of the specification reuses existing layouts and values from the High
Definition Audio specification (<a 
href="#x1-3001r1">HDA</a>). It allows to provide the same functionality and
assist in two possible cases:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-533002x1">implementation of a universal sound driver,
    </li>
    <li 
  class="enumerate" id="x1-533004x2">implementation of a sound driver as part of the High Definition Audio
    subsystem.</li></ol>
<a 
 id="x1-533005r514"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">5.14.1   </span> <a 
 id="x1-5340001"></a>Device ID</h4>
<!--l. 22--><p class="nopar" >25
<a 
 id="x1-534001r540"></a>
<h4 class="subsectionHead"><span class="titlemark">5.14.2   </span> <a 
 id="x1-5350002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">controlq
    </dd><dt class="description">
<span 
class="aeb10-">1</span> </dt><dd 
class="description">eventq
    </dd><dt class="description">
<span 
class="aeb10-">2</span> </dt><dd 
class="description">txq
    </dd><dt class="description">
<span 
class="aeb10-">3</span> </dt><dd 
class="description">rxq</dd></dl>
<!--l. 33--><p class="nopar" >The control queue is used for sending control messages from the driver to the
device.
<!--l. 36--><p class="noindent" >The event queue is used for sending notifications from the device to the
driver.
<!--l. 38--><p class="noindent" >The tx queue is used to send PCM frames for output streams.
<!--l. 40--><p class="noindent" >The rx queue is used to receive PCM frames from input streams.
<a 
 id="x1-535001r541"></a>
<h4 class="subsectionHead"><span class="titlemark">5.14.3   </span> <a 
 id="x1-5360003"></a>Feature Bits</h4>
<!--l. 44--><p class="nopar" >None currently defined.
<a 
 id="x1-536001r542"></a>
<h4 class="subsectionHead"><span class="titlemark">5.14.4   </span> <a 
 id="x1-5370004"></a>Device Configuration Layout</h4>
<!--l. 48-->
<div class="lstlisting" id="listing-183"><span class="label"><a 
 id="x1-537001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-537002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">jacks</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-537003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">streams</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-537004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">chmaps</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-537005r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 56--><p class="noindent" >A configuration space contains the following fields:
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">jacks</span> </dt><dd 
class="description">(driver-read-only) indicates a total number of all available jacks.
    </dd><dt class="description">
<span 
class="aebxti-10">streams</span> </dt><dd 
class="description">(driver-read-only)  indicates  a  total  number  of  all  available  PCM
    streams.
    </dd><dt class="description">
<span 
class="aebxti-10">chmaps</span> </dt><dd 
class="description">(driver-read-only) indicates a total number of all available channel
    maps.</dd></dl>
                                                                  

                                                                  
<a 
 id="x1-537006r543"></a>
<h4 class="subsectionHead"><span class="titlemark">5.14.5   </span> <a 
 id="x1-5380005"></a>Device Initialization</h4>
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-538002x1">Configure the control, event, tx and rx queues.
    </li>
    <li 
  class="enumerate" id="x1-538004x2">Read the <span 
class="aeti-10">jacks </span>field and send a control request to query information about
    the available jacks.
    </li>
    <li 
  class="enumerate" id="x1-538006x3">Read the <span 
class="aeti-10">streams </span>field and send a control request to query information
    about the available PCM streams.
    </li>
    <li 
  class="enumerate" id="x1-538008x4">Read the <span 
class="aeti-10">chmaps </span>field and send a control request to query information
    about the available channel maps.
    </li>
    <li 
  class="enumerate" id="x1-538010x5">Populate the event queue with empty buffers.</li></ol>
<a 
 id="x1-538011r536"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.14.5.1   </span> <a 
 id="x1-5390001"></a>Driver Requirements: Device Initialization</h5>
    <ul class="itemize1">
    <li class="itemize">The driver MUST populate the event queue with empty buffers of at least
    the struct virtio_snd_event size.
    </li>
    <li class="itemize">The driver MUST NOT put a device-readable buffers in the event queue.</li></ul>
<a 
 id="x1-539001r544"></a>
<h4 class="subsectionHead"><span class="titlemark">5.14.6   </span> <a 
 id="x1-5400006"></a>Device Operation</h4>
<!--l. 90--><p class="nopar" >All control messages are placed into the control queue and all notifications are
placed into the event queue. They use the following layout structure and
definitions:
<!--l. 94-->
<div class="lstlisting" id="listing-184"><span class="label"><a 
 id="x1-540001r1"></a></span><span 
class="pcrr8t-x-x-80">enum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">jack</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">control</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">request</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">types</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_R_JACK_INFO</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_R_JACK_REMAP</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">control</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">request</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">types</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_R_PCM_INFO</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0100</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_R_PCM_SET_PARAMS</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_R_PCM_PREPARE</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_R_PCM_RELEASE</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_R_PCM_START</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_R_PCM_STOP</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">channel</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">map</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">control</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">request</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">types</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_R_CHMAP_INFO</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0200</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">jack</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">types</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_EVT_JACK_CONNECTED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x1000</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_EVT_JACK_DISCONNECTED</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">types</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540022r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_EVT_PCM_PERIOD_ELAPSED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x1100</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_EVT_PCM_XRUN</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540024r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540025r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">common</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">codes</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540026r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_S_OK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x8000</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540027r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_S_BAD_MSG</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540028r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_S_NOT_SUPP</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540029r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_S_IO_ERR</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540030r30"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540031r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540032r32"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">common</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540033r33"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540034r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">code</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540035r35"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540036r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540037r37"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">an</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notification</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540038r38"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540039r39"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540040r40"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540041r41"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 138--><p class="noindent" >A generic control message consists of a request part and a response part.
<!--l. 140--><p class="noindent" >A request part has, or consists of, a common header containing the following
device-readable field:
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">code</span> </dt><dd 
class="description">specifies a device request type (VIRTIO_SND_R_*).</dd></dl>
                                                                  

                                                                  
<!--l. 147--><p class="noindent" >A response part has, or consists of, a common header containing the following
device-writable field:
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">code</span> </dt><dd 
class="description">indicates a device request status (VIRTIO_SND_S_*).</dd></dl>
<!--l. 154--><p class="noindent" >The status field can take one of the following values:
    <ul class="itemize1">
    <li class="itemize">VIRTIO_SND_S_OK - success.
    </li>
    <li class="itemize">VIRTIO_SND_S_BAD_MSG - a control message is malformed or contains
    invalid parameters.
    </li>
    <li class="itemize">VIRTIO_SND_S_NOT_SUPP - requested operation or parameters are not
    supported.
    </li>
    <li class="itemize">VIRTIO_SND_S_IO_ERR - an I/O error occurred.</li></ul>
<!--l. 164--><p class="noindent" >The request part may be followed by an additional device-readable payload,
and the response part may be followed by an additional device-writable
payload.
<!--l. 167--><p class="noindent" >An event notification contains the following device-writable fields:
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">hdr</span> </dt><dd 
class="description">indicates an event type (VIRTIO_SND_EVT_*).
    </dd><dt class="description">
<span 
class="aebxti-10">data</span> </dt><dd 
class="description">indicates an optional event data.</dd></dl>
<!--l. 174--><p class="noindent" >For all entities involved in the exchange of audio data, the device uses one of the
following data flow directions:
<!--l. 177-->
<div class="lstlisting" id="listing-185"><span class="label"><a 
 id="x1-540042r1"></a></span><span 
class="pcrr8t-x-x-80">enum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540043r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_D_OUTPUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540044r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_D_INPUT</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-540045r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<a 
 id="x1-540046r545"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.14.6.1   </span> <a 
 id="x1-5410001"></a>Item Information Request</h5>
<!--l. 186--><p class="nopar" >A special control message is used to request information about any kind of
configuration item. The request part uses the following structure definition:
<!--l. 189-->
<div class="lstlisting" id="listing-186"><span class="label"><a 
 id="x1-541001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_query_info</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-541002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-541003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">start_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-541004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">count</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-541005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-541006r6"></a></span><span 
class="pcrr8t-x-x-80">};</span>
                                                                  

                                                                  
</div>
<!--l. 198--><p class="noindent" >The request contains the following device-readable fields:
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">hdr</span> </dt><dd 
class="description">specifies a particular item request type (VIRTIO_SND_R_*_INFO).
    </dd><dt class="description">
<span 
class="aebxti-10">start_id</span> </dt><dd 
class="description">specifies the starting identifier for the item (the range of available
    identifiers  is  limited  by  the  total  number  of  particular  items  that  is
    indicated in the device configuration space).
    </dd><dt class="description">
<span 
class="aebxti-10">count</span> </dt><dd 
class="description">specifies the number of items for which information is requested (the
    total number of particular items is indicated in the device configuration
    space).
    </dd><dt class="description">
<span 
class="aebxti-10">size</span> </dt><dd 
class="description">specifies the size of the structure containing information for one item (used
    for backward compatibility).</dd></dl>
<!--l. 212--><p class="noindent" >The response consists of the virtio_snd_hdr structure (contains the request status
code), followed by the device-writable information structures of the item. Each
information structure begins with the following common header:
<!--l. 216-->
<div class="lstlisting" id="listing-187"><span class="label"><a 
 id="x1-541007r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_info</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-541008r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hda_fn_nid</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-541009r3"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 222--><p class="noindent" >The header contains the following field:
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">hda_fn_nid</span> </dt><dd 
class="description">indicates a function group node identifier (see <a 
href="#x1-3001r1">HDA</a>, section 7.1.2).
    This field can be used to link together different types of resources (e.g.
    jacks with streams and channel maps with streams).</dd></dl>
<a 
 id="x1-541010r547"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.14.6.2   </span> <a 
 id="x1-5420002"></a>Driver Requirements: Item Information Request</h5>
    <ul class="itemize1">
    <li class="itemize">The driver MUST NOT set <span 
class="aeti-10">start_id </span>and <span 
class="aeti-10">count </span>such that <span 
class="aeti-10">start_id </span>+ <span 
class="aeti-10">count</span>
    is greater than the total number of particular items that is indicated in the
    device configuration space.
    </li>
    <li class="itemize">The driver MUST provide a buffer of sizeof(struct virtio_snd_hdr) + <span 
class="aeti-10">count</span>
    * <span 
class="aeti-10">size </span>bytes for the response.</li></ul>
<a 
 id="x1-542001r548"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">5.14.6.3   </span> <a 
 id="x1-5430003"></a>Relationships with the High Definition Audio Specification</h5>
<!--l. 243--><p class="nopar" >The High Definition Audio specification introduces the codec as part of the hardware
that implements some of the functionality. The codec architecture and capabilities
are described by tree structure of special nodes each of which is either a function
module or a function group (see <a 
href="#x1-3001r1">HDA</a> for details).
<!--l. 249--><p class="noindent" >The virtio sound specification assumes that a single codec is implemented in the
device. Function module nodes are simulated by item information structures, and
function group nodes are simulated by the <span 
class="aeti-10">hda_fn_nid </span>field in each such
structure.
<a 
 id="x1-543001r549"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.14.6.4   </span> <a 
 id="x1-5440004"></a>Jack Control Messages</h5>
<!--l. 256--><p class="nopar" >A jack control request has, or consists of, a common header with the following layout
structure:
<!--l. 259-->
<div class="lstlisting" id="listing-188"><span class="label"><a 
 id="x1-544001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_jack_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-544002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-544003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">jack_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-544004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 266--><p class="noindent" >The header consists of the following device-readable fields:
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">hdr</span> </dt><dd 
class="description">specifies a request type (VIRTIO_SND_R_JACK_*).
    </dd><dt class="description">
<span 
class="aebxti-10">jack_id</span> </dt><dd 
class="description">specifies a jack identifier from 0 to <span 
class="aeti-10">jacks </span>- 1.</dd></dl>
<a 
 id="x1-544005r538"></a>
<h5 class="paragraphHead"><span class="titlemark">5.14.6.4.1</span> <a 
 id="x1-5450001"></a>VIRTIO_SND_R_JACK_INFO</h5>
Query information about the available jacks.
<!--l. 277--><p class="noindent" >The request consists of the virtio_snd_query_info structure (see <a 
href="#x1-5410001">Item Information
Request<!--tex4ht:ref: sec:Device Types / Sound Device / Device Operation / Item Information Request --></a>). The response consists of the virtio_snd_hdr structure, followed by the
following jack information structures:
<!--l. 282-->
<div class="lstlisting" id="listing-189"><span class="label"><a 
 id="x1-545001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">supported</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">jack</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">features</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-545002r2"></a></span><span 
class="pcrr8t-x-x-80">enum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-545003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_JACK_F_REMAP</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-545004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-545005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-545006r6"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_jack_info</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-545007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_info</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-545008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">features</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_JACK_F_XXX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-545009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hda_reg_defconf</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-545010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hda_reg_caps</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-545011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">connected</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-545012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-545013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">[7];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-545014r14"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 299--><p class="noindent" >The structure contains the following device-writable fields:
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">features</span> </dt><dd 
class="description">indicates a supported feature bit map:
                                                                  

                                                                  
        <ul class="itemize1">
        <li class="itemize">VIRTIO_SND_JACK_F_REMAP - jack remapping support.</li></ul>
    </dd><dt class="description">
<span 
class="aebxti-10">hda_reg_defconf</span> </dt><dd 
class="description">indicates a pin default configuration value (see <a 
href="#x1-3001r1">HDA</a>, section
    7.3.3.31).
    </dd><dt class="description">
<span 
class="aebxti-10">hda_reg_caps</span> </dt><dd 
class="description">indicates a pin capabilities value (see <a 
href="#x1-3001r1">HDA</a>, section 7.3.4.9).
    </dd><dt class="description">
<span 
class="aebxti-10">connected</span> </dt><dd 
class="description">indicates the current jack connection status (1 - connected, 0 -
    disconnected).</dd></dl>
<a 
 id="x1-545015r535"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.14.6.4.1.1</span> <a 
 id="x1-5460001"></a>Device Requirements: Jack Information</h6>
    <ul class="itemize1">
    <li class="itemize">The device MUST NOT set undefined feature values.
    </li>
    <li class="itemize">The device MUST initialize the <span 
class="aeti-10">padding </span>bytes to 0.</li></ul>
<a 
 id="x1-546001r551"></a>
<h5 class="paragraphHead"><span class="titlemark">5.14.6.4.2</span> <a 
 id="x1-5470002"></a>VIRTIO_SND_R_JACK_REMAP</h5>
If the VIRTIO_SND_JACK_F_REMAP feature bit is set in the jack information, then
the driver can send a control request to change the association and/or sequence
number for the specified jack ID.
<!--l. 327--><p class="noindent" >The request uses the following structure and layout definitions:
<!--l. 329-->
<div class="lstlisting" id="listing-190"><span class="label"><a 
 id="x1-547001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_jack_remap</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-547002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_jack_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">code</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_R_JACK_REMAP</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-547003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">association</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-547004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sequence</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-547005r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 337--><p class="noindent" >The request contains the following device-readable fields:
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">association</span> </dt><dd 
class="description">specifies the selected association number.
    </dd><dt class="description">
<span 
class="aebxti-10">sequence</span> </dt><dd 
class="description">specifies the selected sequence number.</dd></dl>
<a 
 id="x1-547006r550"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.14.6.5   </span> <a 
 id="x1-5480005"></a>Jack Notifications</h5>
<!--l. 346--><p class="nopar" >Jack notifications consist of a virtio_snd_event structure, which has the following
device-writable fields:
                                                                  

                                                                  
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">hdr</span> </dt><dd 
class="description">indicates a jack event type:
        <ul class="itemize1">
        <li class="itemize">VIRTIO_SND_EVT_JACK_CONNECTED  -  an  external  device  has
        been connected to the jack.
        </li>
        <li class="itemize">VIRTIO_SND_EVT_JACK_DISCONNECTED  -  an  external  device
        has been disconnected from the jack.</li></ul>
    </dd><dt class="description">
<span 
class="aebxti-10">data</span> </dt><dd 
class="description">indicates a jack identifier from 0 to <span 
class="aeti-10">jacks </span>- 1.</dd></dl>
<a 
 id="x1-548001r554"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.14.6.6   </span> <a 
 id="x1-5490006"></a>PCM Control Messages</h5>
<!--l. 360--><p class="nopar" >A PCM control request has, or consists of, a common header with the following
layout structure:
<!--l. 363-->
<div class="lstlisting" id="listing-191"><span class="label"><a 
 id="x1-549001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_pcm_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-549002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-549003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">stream_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-549004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 370--><p class="noindent" >The header consists of the following device-readable fields:
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">hdr</span> </dt><dd 
class="description">specifies request type (VIRTIO_SND_R_PCM_*).
    </dd><dt class="description">
<span 
class="aebxti-10">stream_id</span> </dt><dd 
class="description">specifies a PCM stream identifier from 0 to <span 
class="aeti-10">streams </span>- 1.</dd></dl>
<a 
 id="x1-549005r553"></a>
<h5 class="paragraphHead"><span class="titlemark">5.14.6.6.1</span> <a 
 id="x1-5500001"></a>PCM Command Lifecycle</h5>
A PCM stream has the following command lifecycle:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-550002x1">SET PARAMETERS
    <!--l. 384--><p class="noindent" >The driver negotiates the stream parameters (format, transport, etc) with
    the device.
    <!--l. 387--><p class="noindent" >Possible valid transitions: set parameters, prepare.
    </li>
    <li 
  class="enumerate" id="x1-550004x2">PREPARE
    <!--l. 391--><p class="noindent" >The device prepares the stream (allocates resources, etc).
    <!--l. 393--><p class="noindent" >Possible valid transitions: set parameters, prepare, start, release.
                                                                  

                                                                  
    </li>
    <li 
  class="enumerate" id="x1-550006x3">Output only: the driver transfers data for pre-buffing.
    </li>
    <li 
  class="enumerate" id="x1-550008x4">START
    <!--l. 399--><p class="noindent" >The device starts the stream (unmute, putting into running state, etc).
    <!--l. 401--><p class="noindent" >Possible valid transitions: stop.
    </li>
    <li 
  class="enumerate" id="x1-550010x5">The driver transfers data to/from the stream.
    </li>
    <li 
  class="enumerate" id="x1-550012x6">STOP
    <!--l. 407--><p class="noindent" >The device stops the stream (mute, putting into non-running state, etc).
    <!--l. 409--><p class="noindent" >Possible valid transitions: start, release.
    </li>
    <li 
  class="enumerate" id="x1-550014x7">RELEASE
    <!--l. 413--><p class="noindent" >The device releases the stream (frees resources, etc).
    <!--l. 415--><p class="noindent" >Possible valid transitions: set parameters, prepare.
    </li></ol>
<a 
 id="x1-550015r556"></a>
<h5 class="paragraphHead"><span class="titlemark">5.14.6.6.2</span> <a 
 id="x1-5510002"></a>VIRTIO_SND_R_PCM_INFO</h5>
Query information about the available streams.
<!--l. 423--><p class="noindent" >The request consists of the virtio_snd_query_info structure (see <a 
href="#x1-5410001">Item Information
Request<!--tex4ht:ref: sec:Device Types / Sound Device / Device Operation / Item Information Request --></a>). The response consists of the virtio_snd_hdr structure, followed by the
following stream information structures:
<!--l. 428-->
<div class="lstlisting" id="listing-192"><span class="label"><a 
 id="x1-551001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">supported</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">stream</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">features</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551002r2"></a></span><span 
class="pcrr8t-x-x-80">enum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_F_SHMEM_HOST</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_F_SHMEM_GUEST</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_F_MSG_POLLING</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_F_EVT_SHMEM_PERIODS</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_F_EVT_XRUNS</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551008r8"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551010r10"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">supported</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">sample</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">formats</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551011r11"></a></span><span 
class="pcrr8t-x-x-80">enum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">analog</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">formats</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">width</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">physical</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">width</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_IMA_ADPCM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_MU_LAW</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_A_LAW</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_S8</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_U8</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_S16</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_U16</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_S18_3</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">18</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">24</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_U18_3</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">18</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">24</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551022r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_S20_3</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">20</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">24</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_U20_3</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">20</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">24</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551024r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_S24_3</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">24</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">24</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551025r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_U24_3</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">24</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">24</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551026r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_S20</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">20</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551027r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_U20</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">20</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551028r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_S24</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">24</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551029r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_U24</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">24</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551030r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_S32</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551031r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_U32</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551032r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_FLOAT</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551033r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_FLOAT64</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551034r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">digital</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">formats</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">width</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">physical</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">width</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551035r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_DSD_U8</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551036r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_DSD_U16</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551037r37"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_DSD_U32</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551038r38"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_IEC958_SUBFRAME</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bits</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551039r39"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551040r40"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551041r41"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">supported</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PCM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">frame</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rates</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551042r42"></a></span><span 
class="pcrr8t-x-x-80">enum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551043r43"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_RATE_5512</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551044r44"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_RATE_8000</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551045r45"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_RATE_11025</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551046r46"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_RATE_16000</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551047r47"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_RATE_22050</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551048r48"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_RATE_32000</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551049r49"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_RATE_44100</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551050r50"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_RATE_48000</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551051r51"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_RATE_64000</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551052r52"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_RATE_88200</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551053r53"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_RATE_96000</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551054r54"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_RATE_176400</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551055r55"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_RATE_192000</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551056r56"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_RATE_384000</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551057r57"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551058r58"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551059r59"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_pcm_info</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551060r60"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_info</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551061r61"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">features</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_F_XXX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551062r62"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">formats</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_FMT_XXX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551063r63"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rates</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_RATE_XXX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551064r64"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">direction</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551065r65"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">channels_min</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551066r66"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">channels_max</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551067r67"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551068r68"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">[5];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-551069r69"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 500--><p class="noindent" >The structure contains the following device-writable fields:
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">features</span> </dt><dd 
class="description">indicates a bit map of the supported features, which can be negotiated by
    setting the stream parameters:
        <ul class="itemize1">
        <li class="itemize">VIRTIO_SND_PCM_F_SHMEM_HOST  -  supports  sharing  a  host
        memory with a guest,
                                                                  

                                                                  
        </li>
        <li class="itemize">VIRTIO_SND_PCM_F_SHMEM_GUEST - supports sharing a guest
        memory with a host,
        </li>
        <li class="itemize">VIRTIO_SND_PCM_F_MSG_POLLING - supports polling mode for
        message-based transport,
        </li>
        <li class="itemize">VIRTIO_SND_PCM_F_EVT_SHMEM_PERIODS  -  supports  elapsed
        period notifications for shared memory transport,
        </li>
        <li class="itemize">VIRTIO_SND_PCM_F_EVT_XRUNS  -  supports  underrun/overrun
        notifications.</li></ul>
    </dd><dt class="description">
<span 
class="aebxti-10">formats</span> </dt><dd 
class="description">indicates a supported sample format bit map.
    </dd><dt class="description">
<span 
class="aebxti-10">rates</span> </dt><dd 
class="description">indicates a supported frame rate bit map.
    </dd><dt class="description">
<span 
class="aebxti-10">direction</span> </dt><dd 
class="description">indicates the direction of data flow (VIRTIO_SND_D_*).
    </dd><dt class="description">
<span 
class="aebxti-10">channels_min</span> </dt><dd 
class="description">indicates a minimum number of supported channels.
    </dd><dt class="description">
<span 
class="aebxti-10">channels_max</span> </dt><dd 
class="description">indicates a maximum number of supported channels.</dd></dl>
<!--l. 521--><p class="noindent" >Only interleaved samples are supported.
<a 
 id="x1-551070r552"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.14.6.6.2.1</span> <a 
 id="x1-5520001"></a>Device Requirements: Stream Information</h6>
    <ul class="itemize1">
    <li class="itemize">The device MUST NOT set undefined feature, format, rate and direction
    values.
    </li>
    <li class="itemize">The device MUST initialize the <span 
class="aeti-10">padding </span>bytes to 0.</li></ul>
<a 
 id="x1-552001r557"></a>
<h5 class="paragraphHead"><span class="titlemark">5.14.6.6.3</span> <a 
 id="x1-5530003"></a>VIRTIO_SND_R_PCM_SET_PARAMS</h5>
Set selected stream parameters for the specified stream ID.
<!--l. 535--><p class="noindent" >The request uses the following structure and layout definitions:
<!--l. 537-->
<div class="lstlisting" id="listing-193"><span class="label"><a 
 id="x1-553001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_pcm_set_params</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-553002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_pcm_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">code</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_R_PCM_SET_PARAMS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-553003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer_bytes</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-553004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">period_bytes</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-553005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">features</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_PCM_F_XXX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-553006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">channels</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-553007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">format</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-553008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rate</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-553009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-553010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-553011r11"></a></span><span 
class="pcrr8t-x-x-80">};</span>
                                                                  

                                                                  
</div>
<!--l. 551--><p class="noindent" >The request contains the following device-readable fields:
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">buffer_bytes</span> </dt><dd 
class="description">specifies the size of the hardware buffer used by the driver.
    </dd><dt class="description">
<span 
class="aebxti-10">period_bytes</span> </dt><dd 
class="description">specifies the size of the hardware period used by the driver.
    </dd><dt class="description">
<span 
class="aebxti-10">features</span> </dt><dd 
class="description">specifies a selected feature bit map:
        <ul class="itemize1">
        <li class="itemize">VIRTIO_SND_PCM_F_SHMEM_HOST - use shared memory allocated
        by  the  host  (is  a  placeholder  and  MUST  NOT  be  selected  at  the
        moment),
        </li>
        <li class="itemize">VIRTIO_SND_PCM_F_SHMEM_GUEST        -        use        shared
        memory allocated by the guest (is a placeholder and MUST NOT be
        selected at the moment),
        </li>
        <li class="itemize">VIRTIO_SND_PCM_F_MSG_POLLING  -  suppress  available  buffer
        notifications for tx and rx queues (device should poll virtqueue),
        </li>
        <li class="itemize">VIRTIO_SND_PCM_F_EVT_SHMEM_PERIODS   -   enable   elapsed
        period notifications for shared memory transport,
        </li>
        <li class="itemize">VIRTIO_SND_PCM_F_EVT_XRUNS   -   enable   underrun/overrun
        notifications.</li></ul>
    </dd><dt class="description">
<span 
class="aebxti-10">channels</span> </dt><dd 
class="description">specifies a selected number of channels.
    </dd><dt class="description">
<span 
class="aebxti-10">format</span> </dt><dd 
class="description">specifies a selected sample format (VIRTIO_SND_PCM_FMT_*).
    </dd><dt class="description">
<span 
class="aebxti-10">rate</span> </dt><dd 
class="description">specifies a selected frame rate (VIRTIO_SND_PCM_RATE_*).</dd></dl>
<a 
 id="x1-553012r558"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.14.6.6.3.1</span> <a 
 id="x1-5540001"></a>Device Requirements: Stream Parameters</h6>
    <ul class="itemize1">
    <li class="itemize">If the device has an intermediate buffer, its size MUST be no less than the
    specified <span 
class="aeti-10">buffer_bytes </span>value.</li></ul>
<a 
 id="x1-554001r560"></a>
                                                                  

                                                                  
<h6 class="subparagraphHead"><span class="titlemark">5.14.6.6.3.2</span> <a 
 id="x1-5550002"></a>Driver Requirements: Stream Parameters</h6>
    <ul class="itemize1">
    <li class="itemize"><span 
class="aeti-10">period_bytes   </span>MUST   be   a   divider   <span 
class="aeti-10">buffer_bytes</span>,   i.e.   <span 
class="aeti-10">buffer_bytes   </span>%
    <span 
class="aeti-10">period_bytes </span>== 0.
    </li>
    <li class="itemize">The driver MUST NOT set undefined feature, format and rate values.
    </li>
    <li class="itemize">The driver MUST NOT set the feature, format, and rate that are not
    specified in the stream configuration.
    </li>
    <li class="itemize">The  driver  MUST  NOT  set  the  <span 
class="aeti-10">channels  </span>value  as  less  than  the
    <span 
class="aeti-10">channels_min  </span>or greater than the <span 
class="aeti-10">channels_max  </span>values specified in the
    stream configuration.
    </li>
    <li class="itemize">The driver MUST NOT set the VIRTIO_SND_PCM_F_SHMEM_HOST
    and VIRTIO_SND_PCM_F_SHMEM_GUEST bits at the same time.
    </li>
    <li class="itemize">The driver MUST initialize the <span 
class="aeti-10">padding </span>byte to 0.
    </li>
    <li class="itemize">If the bits associated with the shared memory are not selected, the driver
    MUST use the tx and rx queues for data transfer (see <a 
href="#x1-5620008">PCM I/O Messages<!--tex4ht:ref: sec:Device Types / Sound Device / Device Operation / PCM IO Messages --></a>).</li></ul>
<a 
 id="x1-555001r559"></a>
<h5 class="paragraphHead"><span class="titlemark">5.14.6.6.4</span> <a 
 id="x1-5560004"></a>VIRTIO_SND_R_PCM_PREPARE</h5>
Prepare a stream with specified stream ID.
<a 
 id="x1-556001r562"></a>
<h5 class="paragraphHead"><span class="titlemark">5.14.6.6.5</span> <a 
 id="x1-5570005"></a>VIRTIO_SND_R_PCM_RELEASE</h5>
Release a stream with specified stream ID.
<a 
 id="x1-557001r561"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.14.6.6.5.1</span> <a 
 id="x1-5580001"></a>Device Requirements: Stream Release</h6>
    <ul class="itemize1">
    <li class="itemize">The device MUST complete all pending I/O messages for the specified
    stream ID.
    </li>
    <li class="itemize">The  device  MUST  NOT  complete  the  control  request  while  there  are
    pending I/O messages for the specified stream ID.</li></ul>
<a 
 id="x1-558001r563"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">5.14.6.6.6</span> <a 
 id="x1-5590006"></a>VIRTIO_SND_R_PCM_START</h5>
Start a stream with specified stream ID.
<a 
 id="x1-559001r565"></a>
<h5 class="paragraphHead"><span class="titlemark">5.14.6.6.7</span> <a 
 id="x1-5600007"></a>VIRTIO_SND_R_PCM_STOP</h5>
Stop a stream with specified stream ID.
<a 
 id="x1-560001r555"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.14.6.7   </span> <a 
 id="x1-5610007"></a>PCM Notifications</h5>
<!--l. 626--><p class="nopar" >The device can announce support for different PCM events using feature
bits in the stream information structure. To enable notifications, the driver
must negotiate these features using the set stream parameters request (see
<a 
href="#x1-5530003">5.14.6.6.3<!--tex4ht:ref: sec:Device Types / Sound Device / Device Operation / PCM Stream Parameters --></a>).
<!--l. 631--><p class="noindent" >PCM stream notifications consist of a virtio_snd_event structure, which has the
following device-writable fields:
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">hdr</span> </dt><dd 
class="description">indicates a PCM stream event type:
        <ul class="itemize1">
        <li class="itemize">VIRTIO_SND_EVT_PCM_PERIOD_ELAPSED  -  a  hardware  buffer
        period has elapsed, the period size is controlled using the <span 
class="aeti-10">period_bytes</span>
        field.
        </li>
        <li class="itemize">VIRTIO_SND_EVT_PCM_XRUN - an underflow for the output stream
        or an overflow for the input stream has occurred.</li></ul>
    </dd><dt class="description">
<span 
class="aebxti-10">data</span> </dt><dd 
class="description">indicates a PCM stream identifier from 0 to <span 
class="aeti-10">streams </span>- 1.</dd></dl>
<a 
 id="x1-561001r567"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.14.6.8   </span> <a 
 id="x1-5620008"></a>PCM I/O Messages</h5>
<!--l. 647--><p class="nopar" >An I/O message consists of the header part, followed by the buffer, and then the
status part.
<!--l. 650-->
<div class="lstlisting" id="listing-194"><span class="label"><a 
 id="x1-562001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">an</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">I</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">O</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-562002r2"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_pcm_xfer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-562003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">stream_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-562004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-562005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-562006r6"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">an</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">I</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">O</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-562007r7"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_pcm_status</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-562008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-562009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">latency_bytes</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-562010r10"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 663--><p class="noindent" >The header part consists of the following device-readable field:
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">stream_id</span> </dt><dd 
class="description">specifies a PCM stream identifier from 0 to <span 
class="aeti-10">streams </span>- 1.</dd></dl>
<!--l. 669--><p class="noindent" >The status part consists of the following device-writable fields:
                                                                  

                                                                  
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">status</span> </dt><dd 
class="description">contains   VIRTIO_SND_S_OK   if   an   operation   is   successful,   and
    VIRTIO_SND_S_IO_ERR otherwise.
    </dd><dt class="description">
<span 
class="aebxti-10">latency_bytes</span> </dt><dd 
class="description">indicates the current device latency.</dd></dl>
<!--l. 677--><p class="noindent" >Since all buffers in the queue (with one exception) should be of the size <span 
class="aeti-10">period_bytes</span>,
the completion of such an I/O request can be considered an elapsed period
notification.
<a 
 id="x1-562011r566"></a>
<h5 class="paragraphHead"><span class="titlemark">5.14.6.8.1</span> <a 
 id="x1-5630001"></a>Output Stream</h5>
In case of an output stream, the header is followed by a device-readable buffer
containing PCM frames for writing to the device. All messages are placed into the tx
queue.
<a 
 id="x1-563001r564"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.14.6.8.1.1</span> <a 
 id="x1-5640001"></a>Device Requirements: Output Stream</h6>
    <ul class="itemize1">
    <li class="itemize">The device MUST NOT complete the I/O request until the buffer is totally
    consumed.</li></ul>
<a 
 id="x1-564001r570"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.14.6.8.1.2</span> <a 
 id="x1-5650002"></a>Driver Requirements: Output Stream</h6>
    <ul class="itemize1">
    <li class="itemize">The driver SHOULD populate the tx queue with <span 
class="aeti-10">period_bytes </span>sized buffers.
    The only exception is the end of the stream.
    </li>
    <li class="itemize">The driver MUST NOT place device-writable buffers into the tx queue.</li></ul>
<a 
 id="x1-565001r569"></a>
<h5 class="paragraphHead"><span class="titlemark">5.14.6.8.2</span> <a 
 id="x1-5660002"></a>Input Stream</h5>
In case of an input stream, the header is followed by a device-writable buffer being
populated with PCM frames from the device. All messages are placed into the rx
queue.
<!--l. 708--><p class="noindent" >A used descriptor specifies the length of the buffer that was written by the device. It
should be noted that the length value contains the size of the virtio_snd_pcm_status
structure plus the size of the recorded frames.
<a 
 id="x1-566001r571"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.14.6.8.2.1</span> <a 
 id="x1-5670001"></a>Device Requirements: Input Stream</h6>
    <ul class="itemize1">
    <li class="itemize">The device MUST NOT complete the I/O request until the buffer is full.
                                                                  

                                                                  
    The only exception is the end of the stream.</li></ul>
<a 
 id="x1-567001r573"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.14.6.8.2.2</span> <a 
 id="x1-5680002"></a>Driver Requirements: Input Stream</h6>
    <ul class="itemize1">
    <li class="itemize">The driver SHOULD populate the rx queue with <span 
class="aeti-10">period_bytes </span>sized empty
    buffers before starting the stream.
    </li>
    <li class="itemize">The driver MUST NOT place device-readable buffers into the rx queue.</li></ul>
<a 
 id="x1-568001r568"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.14.6.9   </span> <a 
 id="x1-5690009"></a>Channel Map Control Messages</h5>
<!--l. 729--><p class="nopar" >A device can provide one or more channel maps assigned to all streams with the same
data flow direction in the same function group.
<a 
 id="x1-569001r572"></a>
<h5 class="paragraphHead"><span class="titlemark">5.14.6.9.1</span> <a 
 id="x1-5700001"></a>VIRTIO_SND_R_CHMAP_INFO</h5>
Query information about the available channel maps.
<!--l. 736--><p class="noindent" >The request consists of the virtio_snd_query_info structure (see <a 
href="#x1-5410001">Item Information
Request<!--tex4ht:ref: sec:Device Types / Sound Device / Device Operation / Item Information Request --></a>). The response consists of the virtio_snd_hdr structure, followed by the
following channel map information structures:
<!--l. 741-->
<div class="lstlisting" id="listing-195"><span class="label"><a 
 id="x1-570001r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">standard</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">channel</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">position</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">definition</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570002r2"></a></span><span 
class="pcrr8t-x-x-80">enum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_NONE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">undefined</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_NA</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">silent</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_MONO</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">mono</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">stream</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_FL</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">front</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">left</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_FR</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">front</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">right</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_RL</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rear</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">left</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_RR</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rear</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">right</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_FC</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">front</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">center</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_LFE</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">low</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">frequency</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">LFE</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570012r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_SL</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">side</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">left</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570013r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_SR</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">side</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">right</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570014r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_RC</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rear</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">center</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570015r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_FLC</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">front</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">left</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">center</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570016r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_FRC</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">front</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">right</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">center</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570017r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_RLC</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rear</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">left</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">center</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570018r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_RRC</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rear</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">right</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">center</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570019r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_FLW</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">front</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">left</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">wide</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570020r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_FRW</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">front</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">right</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">wide</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570021r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_FLH</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">front</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">left</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">high</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570022r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_FCH</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">front</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">center</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">high</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570023r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_FRH</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">front</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">right</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">high</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570024r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_TC</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">top</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">center</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570025r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_TFL</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">top</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">front</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">left</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570026r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_TFR</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">top</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">front</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">right</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570027r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_TFC</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">top</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">front</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">center</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570028r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_TRL</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">top</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rear</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">left</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570029r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_TRR</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">top</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rear</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">right</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570030r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_TRC</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">top</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rear</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">center</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570031r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_TFLC</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">top</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">front</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">left</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">center</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570032r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_TFRC</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">top</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">front</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">right</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">center</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570033r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_TSL</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">top</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">side</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">left</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570034r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_TSR</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">top</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">side</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">right</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570035r35"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_LLFE</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">left</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">LFE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570036r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_RLFE</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">right</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">LFE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570037r37"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_BC</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bottom</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">center</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570038r38"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_BLC</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bottom</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">left</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">center</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570039r39"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_BRC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bottom</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">right</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">center</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570040r40"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570041r41"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570042r42"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">maximum</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">possible</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">number</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">channels</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570043r43"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_MAX_SIZE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">18</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570044r44"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570045r45"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_chmap_info</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570046r46"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_snd_info</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570047r47"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">direction</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570048r48"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">channels</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570049r49"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">positions</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">VIRTIO_SND_CHMAP_MAX_SIZE</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-570050r50"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 794--><p class="noindent" >The structure contains the following device-writable fields:
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">direction</span> </dt><dd 
class="description">indicates the direction of data flow (VIRTIO_SND_D_*).
    </dd><dt class="description">
<span 
class="aebxti-10">channels</span> </dt><dd 
class="description">indicates the number of valid channel position values.
    </dd><dt class="description">
<span 
class="aebxti-10">positions</span> </dt><dd 
class="description">indicates channel position values (VIRTIO_SND_CHMAP_*).</dd></dl>
<a 
 id="x1-570051r574"></a>
<h6 class="subparagraphHead"><span class="titlemark">5.14.6.9.1.1</span> <a 
 id="x1-5710001"></a>Device Requirements: Channel Map Information</h6>
    <ul class="itemize1">
    <li class="itemize">The device MUST NOT set undefined direction values.
    </li>
    <li class="itemize">The   device   MUST   NOT   set   the   channels   value   to   more   than
    VIRTIO_SND_CHMAP_MAX_SIZE.</li></ul>
                                                                  

                                                                  
<a 
 id="x1-571001r539"></a>
<h3 class="sectionHead"><span class="titlemark">5.15   </span> <a 
 id="x1-57200015"></a>Memory Device</h3>
<!--l. 3--><p class="nopar" >The virtio memory device provides and manages a memory region in guest physical
address space. This memory region is partitioned into memory blocks of fixed size
that can either be in the state plugged or unplugged. Once plugged, a memory block
can be used like ordinary RAM. The driver selects memory blocks to (un)plug and
requests the device to perform the (un)plug.
<!--l. 10--><p class="noindent" >The device requests the driver to plug a certain amount of memory, by setting the
<span 
class="aeti-10">requested_size </span>in the device configuration, which can change at runtime. It is up to
the device driver to fulfill this request by (un)plugging memory blocks. Once the
<span 
class="aeti-10">plugged_size </span>is greater or equal to the <span 
class="aeti-10">requested_size</span>, requests to plug memory blocks
will be rejected by the device.
<!--l. 17--><p class="noindent" >The device-managed memory region is split into two parts, the usable region and the
unusable region. All memory blocks in the unusable region are unplugged and
requests to plug them will be rejected. The device will grow the usable region to fit
the <span 
class="aeti-10">requested_size</span>. Usually, the usable region is bigger than the <span 
class="aeti-10">requested_size </span>of the
device, to give the driver some flexibility when selecting memory blocks to
plug.
<!--l. 24--><p class="noindent" >On initial start, and after a system reset, all memory blocks are unplugged. In corner
cases, memory blocks might still be plugged after a system reset, and the driver
usually requests to unplug all memory while initializing, before starting to select
memory blocks to plug.
<!--l. 29--><p class="noindent" >The device-managed memory region is not exposed as RAM via other firmware / hw
interfaces (e.g., e820 on x86). The driver is responsible for deciding how
plugged memory blocks will be used. A common use case is to expose plugged
memory blocks to the operating system as system RAM, available for the page
allocator.
<!--l. 35--><p class="noindent" >Some platforms provide memory properties for system RAM that are
usually queried and modified using special CPU instructions. Memory
properties might be implicitly queried or modified on memory access. Memory
properties can include advanced memory protection, access and change
indication, or memory usage indication relevant in virtualized environments.
<span class="footnote-mark"><a 
href="#fn21x5" id="fn21x5-bk"><sup class="textsuperscript">21</sup></a></span><a 
 id="x1-572001f21"></a> The
device provides the exact same properties with the exact same semantics
for plugged device memory as available for comparable RAM in the same
configuration.
<a 
 id="x1-572002r546"></a>
<h4 class="subsectionHead"><span class="titlemark">5.15.1   </span> <a 
 id="x1-5730001"></a>Device ID</h4>
<!--l. 46--><p class="nopar" >24
<a 
 id="x1-573001r579"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">5.15.2   </span> <a 
 id="x1-5740002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">guest-request</dd></dl>
<a 
 id="x1-574001r580"></a>
<h4 class="subsectionHead"><span class="titlemark">5.15.3   </span> <a 
 id="x1-5750003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_MEM_F_ACPI_PXM (0)</span> </dt><dd 
class="description">The field <span 
class="aeti-10">node_id </span>in the device configuration
    is valid and corresponds to an ACPI PXM.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_MEM_F_UNPLUGGED_INACCESSIBLE (1)</span> </dt><dd 
class="description">The driver is not allowed
    to access unplugged memory. <span class="footnote-mark"><a 
href="#fn22x5" id="fn22x5-bk"><sup class="textsuperscript">22</sup></a></span><a 
 id="x1-575001f22"></a></dd></dl>
<a 
 id="x1-575002r581"></a>
<h4 class="subsectionHead"><span class="titlemark">5.15.4   </span> <a 
 id="x1-5760004"></a>Device configuration layout</h4>
<!--l. 67--><p class="nopar" >All fields of this configuration are always available and read-only for the
driver.
<!--l. 70-->
<div class="lstlisting" id="listing-196"><span class="label"><a 
 id="x1-576001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_mem_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-576002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">block_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-576003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">node_id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-576004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">[6];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-576005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">addr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-576006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">region_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-576007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">usable_region_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-576008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">plugged_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-576009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">requested_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-576010r10"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">block_size</span> </dt><dd 
class="description">is the size and the alignment in bytes of a memory block. Cannot
    change.
    </dd><dt class="description">
<span 
class="aebxti-10">node_id</span> </dt><dd 
class="description">has   no   meaning   without   VIRTIO_MEM_F_ACPI_PXM.   With
    VIRTIO_MEM_F_ACPI_PXM, this field is valid and corresponds to an
    ACPI PXM. Cannot change.
    </dd><dt class="description">
<span 
class="aebxti-10">padding</span> </dt><dd 
class="description">has no meaning and is reserved for future use.
    </dd><dt class="description">
<span 
class="aebxti-10">addr</span> </dt><dd 
class="description">is the guest physical address of the start of the device-managed memory
    region in bytes. Cannot change.
    </dd><dt class="description">
<span 
class="aebxti-10">region_size</span> </dt><dd 
class="description">is the size of device-managed memory region in bytes. Cannot
    change.
    </dd><dt class="description">
<span 
class="aebxti-10">usable_region_size</span> </dt><dd 
class="description">is   the   size   of   the   usable   device-managed   memory
    region.   Can   grow   up   to   <span 
class="aeti-10">region_size</span>.   Can   only   shrink   due   to
    VIRTIO_MEM_REQ_UNPLUG_ALL requests.
                                                                  

                                                                  
    </dd><dt class="description">
<span 
class="aebxti-10">plugged_size</span> </dt><dd 
class="description">is the amount of plugged memory in bytes within the usable
    device-managed memory region.
    </dd><dt class="description">
<span 
class="aebxti-10">requested_size</span> </dt><dd 
class="description">is the requested amount of plugged memory within the usable
    device-managed memory region.</dd></dl>
<a 
 id="x1-576011r575"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.15.4.1   </span> <a 
 id="x1-5770001"></a>Driver Requirements: Device configuration layout</h5>
<!--l. 105--><p class="nopar" >The driver MUST NOT write to device configuration fields.
<!--l. 107--><p class="noindent" >The driver MUST ignore the value of <span 
class="aeti-10">padding</span>.
<!--l. 109--><p class="noindent" >The driver MUST ignore the value of <span 
class="aeti-10">node_id </span>without VIRTIO_MEM_F_ACPI_PXM.
<a 
 id="x1-577001r583"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.15.4.2   </span> <a 
 id="x1-5780002"></a>Device Requirements: Device configuration layout</h5>
<!--l. 114--><p class="nopar" >The device MAY change <span 
class="aeti-10">usable_region_size </span>and <span 
class="aeti-10">requested_size</span>.
<!--l. 117--><p class="noindent" >The device MUST NOT change <span 
class="aeti-10">block_size</span>, <span 
class="aeti-10">node_id</span>, <span 
class="aeti-10">addr</span>, and <span 
class="aeti-10">region_size</span>, except
during a system reset.
<!--l. 120--><p class="noindent" >The device MUST change <span 
class="aeti-10">plugged_size </span>to reflect the size of plugged memory
blocks.
<!--l. 123--><p class="noindent" >The device MUST set <span 
class="aeti-10">usable_region_size </span>to <span 
class="aeti-10">requested_size </span>or greater.
<!--l. 126--><p class="noindent" >The device MUST set <span 
class="aeti-10">block_size </span>to a power of two.
<!--l. 128--><p class="noindent" >The device MUST set <span 
class="aeti-10">addr</span>, <span 
class="aeti-10">region_size</span>, <span 
class="aeti-10">usable_region_size</span>, <span 
class="aeti-10">plugged_size</span>, <span 
class="aeti-10">requested_size</span>
to multiples of <span 
class="aeti-10">block_size</span>.
<!--l. 132--><p class="noindent" >The device MUST set <span 
class="aeti-10">region_size </span>to 0 or greater.
<!--l. 134--><p class="noindent" >The device MUST NOT shrink <span 
class="aeti-10">usable_region_size</span>, except when processing an
UNPLUG ALL request, or during a system reset.
<!--l. 137--><p class="noindent" >The device MUST send a configuration update notification when changing
<span 
class="aeti-10">usable_region_size </span>or <span 
class="aeti-10">requested_size</span>, except when processing an UNPLUG ALL
request.
<!--l. 141--><p class="noindent" >The device SHOULD NOT send a configuration update notification when changing
<span 
class="aeti-10">plugged_size</span>.
<!--l. 144--><p class="noindent" >The device MAY send a configuration update notification even if nothing
changed.
<a 
 id="x1-578001r582"></a>
<h4 class="subsectionHead"><span class="titlemark">5.15.5   </span> <a 
 id="x1-5790005"></a>Device Initialization</h4>
<!--l. 149--><p class="nopar" >On initialization, the driver first discovers the device’s virtqueues. It then reads the
device configuration.
                                                                  

                                                                  
<!--l. 152--><p class="noindent" >In case the driver detects that the device still has memory plugged (<span 
class="aeti-10">plugged_size </span>in
the device configuration is greater than 0), the driver will either try to re-initialize by
issuing STATE requests, or try to unplug all memory before continuing.
Special handling might be necessary in case some plugged memory might
still be relevant (e.g., system dump, memory still in use after unloading the
driver).
<a 
 id="x1-579001r584"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.15.5.1   </span> <a 
 id="x1-5800001"></a>Driver Requirements: Device Initialization</h5>
<!--l. 161--><p class="nopar" >The driver SHOULD accept VIRTIO_MEM_F_UNPLUGGED_INACCESSIBLE if it
is offered and the driver supports it.
<!--l. 164--><p class="noindent" >The driver SHOULD issue UNPLUG ALL requests until successful if the device still
has memory plugged and the plugged memory is not in use.
<a 
 id="x1-580001r586"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.15.5.2   </span> <a 
 id="x1-5810002"></a>Device Requirements: Device Initialization</h5>
<!--l. 169--><p class="nopar" >A device MAY fail to operate further if VIRTIO_MEM_F_UNPLUGGED_INACCESSIBLE
is not accepted.
<!--l. 172--><p class="noindent" >The device MUST NOT change the state of memory blocks during device
reset.
<!--l. 174--><p class="noindent" >The device MUST NOT modify memory or memory properties of plugged memory
blocks during device reset.
<a 
 id="x1-581001r585"></a>
<h4 class="subsectionHead"><span class="titlemark">5.15.6   </span> <a 
 id="x1-5820006"></a>Device Operation</h4>
<!--l. 179--><p class="nopar" >The device notifies the driver about the amount of memory the device wants the
driver to consume via the device. These resize requests from the device are
communciated via the <span 
class="aeti-10">requested_size </span>in the device configuration. The driver will react
by requesting to (un)plug specific memory blocks, to make the <span 
class="aeti-10">plugged_size </span>match the
<span 
class="aeti-10">requested_size </span>as close as possible.
<!--l. 186--><p class="noindent" >The driver sends requests to the device on the guest-request virtqueue, notifies the
device, and waits for the device to respond. Requests have a common header, defining
the request type, followed by request-specific data. All requests are 24 bytes long and
have the layout:
<!--l. 191-->
<div class="lstlisting" id="listing-197"><span class="label"><a 
 id="x1-582001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_mem_req</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">[3];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">union</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_mem_req_plug</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">plug</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_mem_req_unplug</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unplug</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_mem_req_state</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">state</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582010r10"></a></span><span 
class="pcrr8t-x-x-80">}</span>
</div>
<!--l. 204--><p class="noindent" >Possible request types are:
<!--l. 206-->
                                                                  

                                                                  
<div class="lstlisting" id="listing-198"><span class="label"><a 
 id="x1-582011r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_MEM_REQ_PLUG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582012r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_MEM_REQ_UNPLUG</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582013r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_MEM_REQ_UNPLUG_ALL</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582014r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_MEM_REQ_STATE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span>
</div>
<!--l. 213--><p class="noindent" >Responses have a common header, defining the response type, followed by
request-specific data. All responses are 10 bytes long and have the layout:
<!--l. 216-->
<div class="lstlisting" id="listing-199"><span class="label"><a 
 id="x1-582015r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_mem_resp</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582016r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582017r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">[3];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582018r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582019r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">union</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582020r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_mem_resp_state</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">state</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582021r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582022r8"></a></span><span 
class="pcrr8t-x-x-80">}</span>
</div>
<!--l. 227--><p class="noindent" >Possible response types, in general, are:
<!--l. 229-->
<div class="lstlisting" id="listing-200"><span class="label"><a 
 id="x1-582023r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_MEM_RESP_ACK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582024r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_MEM_RESP_NACK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582025r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_MEM_RESP_BUSY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-582026r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_MEM_RESP_ERROR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3</span>
</div>
<a 
 id="x1-582027r587"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.15.6.1   </span> <a 
 id="x1-5830001"></a>Driver Requirements: Device Operation</h5>
<!--l. 238--><p class="nopar" >The driver MUST NOT write memory or modify memory properties of unplugged
memory blocks.
<!--l. 241--><p class="noindent" >The driver MUST NOT read memory or query memory properties of unplugged
memory blocks outside <span 
class="aeti-10">usable_region_size</span>.
<!--l. 244--><p class="noindent" >The driver MUST NOT read memory or query memory properties of unplugged
memory blocks inside <span 
class="aeti-10">usable_region_size </span>via DMA.
<!--l. 247--><p class="noindent" >If VIRTIO_MEM_F_UNPLUGGED_INACCESSIBLE has not been negotiated, the
driver SHOULD NOT read memory or query memory properties of unplugged
memory blocks inside <span 
class="aeti-10">usable_region_size </span>via the CPU.
<!--l. 251--><p class="noindent" >If VIRTIO_MEM_F_UNPLUGGED_INACCESSIBLE has been negotiated, the driver
MUST NOT read memory or query memory properties of unplugged memory
blocks.
<!--l. 254--><p class="noindent" >The driver MUST NOT request unplug of memory blocks while corresponding
memory or memory properties are still in use.
<!--l. 257--><p class="noindent" >The driver SHOULD initialize memory blocks after plugging them, the content is
undefined.
<!--l. 260--><p class="noindent" >The driver SHOULD react to resize requests from the device (<span 
class="aeti-10">requested_size </span>in the
device configuration changed) by (un)plugging memory blocks.
<!--l. 264--><p class="noindent" >The driver SHOULD only plug memory blocks it can actually use.
                                                                  

                                                                  
<!--l. 266--><p class="noindent" >The driver MAY not reach the requested size (<span 
class="aeti-10">requested_size </span>in the device
configuration), for example, because it cannot free up any plugged memory blocks to
unplug them, or it would not be able to make use of unplugged memory blocks after
plugging them (e.g., alignment).
<a 
 id="x1-583001r589"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.15.6.2   </span> <a 
 id="x1-5840002"></a>Device Requirements: Device Operation</h5>
<!--l. 273--><p class="nopar" >The device MUST provide the exact same memory properties with the exact same
semantics for device memory the platform provides in the same configuration for
comparable RAM.
<!--l. 277--><p class="noindent" >The device MAY modify memory of unplugged memory blocks or reset memory
properties of such memory blocks to platform defaults at any time.
<!--l. 280--><p class="noindent" >The device MUST NOT modify memory or memory properties of plugged memory
blocks.
<!--l. 283--><p class="noindent" >The device MUST allow the driver to read and write memory and to query and
modify memory attributes of plugged memory blocks.
<!--l. 286--><p class="noindent" >If VIRTIO_MEM_F_UNPLUGGED_INACCESSIBLE has not been negotiated,
the device MUST allow the driver to read memory and to query memory
properties of unplugged memory blocks inside <span 
class="aeti-10">usable_region_size </span>via the CPU.
<span class="footnote-mark"><a 
href="#fn23x5" id="fn23x5-bk"><sup class="textsuperscript">23</sup></a></span><a 
 id="x1-584001f23"></a>
<!--l. 292--><p class="noindent" >The device MAY change the state of memory blocks during system resets.
<!--l. 294--><p class="noindent" >The device SHOULD unplug all memory blocks during system resets.
<a 
 id="x1-584002r590"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.15.6.3   </span> <a 
 id="x1-5850003"></a>PLUG request</h5>
<!--l. 298--><p class="nopar" >Request to plug consecutive memory blocks that are currently unplugged.
<!--l. 300--><p class="noindent" >The request-specific data in a PLUG request has the format:
<!--l. 302-->
<div class="lstlisting" id="listing-201"><span class="label"><a 
 id="x1-585001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_mem_req_plug</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-585002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">addr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-585003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">nb_blocks</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-585004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">[3];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-585005r5"></a></span><span 
class="pcrr8t-x-x-80">}</span>
</div>
<!--l. 310--><p class="noindent" ><span 
class="aeti-10">addr </span>is the guest physical address of the first memory block. <span 
class="aeti-10">nb_blocks </span>is the number
of consecutive memory blocks
<!--l. 313--><p class="noindent" >Responses don’t have request-specific data defined.
<a 
 id="x1-585006r576"></a>
<h5 class="paragraphHead"><span class="titlemark">5.15.6.3.1</span> <a 
 id="x1-5860001"></a>Driver Requirements: PLUG request</h5>
The driver MUST ignore anything except the response type in a response.
<a 
 id="x1-586001r592"></a>
                                                                  

                                                                  
<h5 class="paragraphHead"><span class="titlemark">5.15.6.3.2</span> <a 
 id="x1-5870002"></a>Device Requirements: PLUG request</h5>
The device MUST ignore anything except the request type and the request-specific
data in a request.
<!--l. 324--><p class="noindent" >The device MUST ignore the <span 
class="aeti-10">padding </span>in the request-specific data in a request.
<!--l. 327--><p class="noindent" >The device MUST reject requests with VIRTIO_MEM_RESP_ERROR if <span 
class="aeti-10">addr </span>is not
aligned to the <span 
class="aeti-10">block_size </span>in the device configuration, if <span 
class="aeti-10">nb_blocks </span>is not greater than 0,
or if any memory block outside of the usable device-managed memory region is
covered by the request.
<!--l. 332--><p class="noindent" >The device MUST reject requests with VIRTIO_MEM_RESP_ERROR if any memory
block covered by the request is already plugged.
<!--l. 335--><p class="noindent" >The device MAY reject requests with VIRTIO_MEM_RESP_BUSY if the request can
currently not be processed.
<!--l. 338--><p class="noindent" >The device MUST acknowledge requests with VIRTIO_MEM_RESP_ACK in case all
memory blocks were successfully plugged. The device MUST reflect the change in the
device configuration <span 
class="aeti-10">plugged_size</span>.
<a 
 id="x1-587001r591"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.15.6.4   </span> <a 
 id="x1-5880004"></a>UNPLUG request</h5>
<!--l. 344--><p class="nopar" >Request to unplug consecutive memory blocks that are currently plugged.
<!--l. 346--><p class="noindent" >The request-specific data in an UNPLUG request has the format:
<!--l. 348-->
<div class="lstlisting" id="listing-202"><span class="label"><a 
 id="x1-588001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_mem_req_unplug</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-588002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">addr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-588003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">nb_blocks</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-588004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">[3];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-588005r5"></a></span><span 
class="pcrr8t-x-x-80">}</span>
</div>
<!--l. 356--><p class="noindent" ><span 
class="aeti-10">addr </span>is the guest physical address of the first memory block. <span 
class="aeti-10">nb_blocks </span>is the number
of consecutive memory blocks
<!--l. 359--><p class="noindent" >Responses don’t have request-specific data defined.
<a 
 id="x1-588006r593"></a>
<h5 class="paragraphHead"><span class="titlemark">5.15.6.4.1</span> <a 
 id="x1-5890001"></a>Driver Requirements: UNPLUG request</h5>
The driver MUST ignore anything except the response type in a response.
<a 
 id="x1-589001r595"></a>
<h5 class="paragraphHead"><span class="titlemark">5.15.6.4.2</span> <a 
 id="x1-5900002"></a>Device Requirements: UNPLUG request</h5>
The device MUST ignore anything except the request type and the request-specific
data in a request.
<!--l. 370--><p class="noindent" >The device MUST ignore the <span 
class="aeti-10">padding </span>in the request-specific data in a request.
                                                                  

                                                                  
<!--l. 373--><p class="noindent" >The device MUST reject requests with VIRTIO_MEM_RESP_ERROR if <span 
class="aeti-10">addr </span>is not
aligned to the <span 
class="aeti-10">block_size </span>in the device configuration, if <span 
class="aeti-10">nb_blocks </span>is not greater than 0,
or if any memory block outside of the usable device-managed memory region is
covered by the request.
<!--l. 378--><p class="noindent" >The device MUST reject requests with VIRTIO_MEM_RESP_ERROR if any memory
block covered by the request is already unplugged.
<!--l. 381--><p class="noindent" >The device MAY reject requests with VIRTIO_MEM_RESP_BUSY if the request can
currently not be processed.
<!--l. 384--><p class="noindent" >The device MUST acknowledge requests with VIRTIO_MEM_RESP_ACK in case all
memory blocks were successfully unplugged. The device MUST reflect the change in
the device configuration <span 
class="aeti-10">plugged_size</span>.
<a 
 id="x1-590001r594"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.15.6.5   </span> <a 
 id="x1-5910005"></a>UNPLUG ALL request</h5>
<!--l. 390--><p class="nopar" >Request to unplug all memory blocks the device has currently plugged. If successful,
the <span 
class="aeti-10">plugged_size </span>in the device configuration will be 0 and <span 
class="aeti-10">usable_region_size </span>might
have changed.
<!--l. 394--><p class="noindent" >Requests don’t have request-specific data defined, only the request type is relevant.
Responses don’t have request-specific data defined, only the response type is
relevant.
<a 
 id="x1-591001r596"></a>
<h5 class="paragraphHead"><span class="titlemark">5.15.6.5.1</span> <a 
 id="x1-5920001"></a>Driver Requirements: UNPLUG request</h5>
The driver MUST ignore any data in a response except the response type.
<a 
 id="x1-592001r598"></a>
<h5 class="paragraphHead"><span class="titlemark">5.15.6.5.2</span> <a 
 id="x1-5930002"></a>Device Requirements: UNPLUG request</h5>
The device MUST ignore any data in a request except the request type.
<!--l. 406--><p class="noindent" >The device MUST ignore the <span 
class="aeti-10">padding </span>in the request-specific data in a request.
<!--l. 409--><p class="noindent" >The device MAY reject requests with VIRTIO_MEM_RESP_BUSY if the request can
currently not be processed.
<!--l. 412--><p class="noindent" >The device MUST acknowledge requests with VIRTIO_MEM_RESP_ACK in case all
memory blocks were successfully unplugged.
<!--l. 415--><p class="noindent" >The device MUST set <span 
class="aeti-10">plugged_size </span>to 0 in case the request is acknowledged with
VIRTIO_MEM_RESP_ACK.
<!--l. 418--><p class="noindent" >The device MAY modify <span 
class="aeti-10">usable_region_size </span>before responding with
VIRTIO_MEM_RESP_ACK.
<a 
 id="x1-593001r597"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">5.15.6.6   </span> <a 
 id="x1-5940006"></a>STATE request</h5>
<!--l. 423--><p class="nopar" >Request the state (plugged, unplugged, mixed) of consecutive memory blocks.
<!--l. 425--><p class="noindent" >The request-specific data in a STATE request has the format:
<!--l. 427-->
<div class="lstlisting" id="listing-203"><span class="label"><a 
 id="x1-594001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_mem_req_state</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-594002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">addr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-594003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">nb_blocks</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-594004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">[3];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-594005r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 435--><p class="noindent" ><span 
class="aeti-10">addr </span>is the guest physical address of the first memory block. <span 
class="aeti-10">nb_blocks </span>is the number
of consecutive memory blocks.
<!--l. 438--><p class="noindent" >The request-specific data in a STATE response has the format:
<!--l. 440-->
<div class="lstlisting" id="listing-204"><span class="label"><a 
 id="x1-594006r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_mem_resp_state</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-594007r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-594008r3"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 446--><p class="noindent" >Whereby <span 
class="aeti-10">type </span>defines one of three different state types:
<!--l. 448-->
<div class="lstlisting" id="listing-205"><span class="label"><a 
 id="x1-594009r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_MEM_STATE_PLUGGED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-594010r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_MEM_STATE_UNPLUGGED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-594011r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_MEM_STATE_MIXED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span>
</div>
<a 
 id="x1-594012r599"></a>
<h5 class="paragraphHead"><span class="titlemark">5.15.6.6.1</span> <a 
 id="x1-5950001"></a>Driver Requirements: STATE request</h5>
The driver MUST ignore anything except the response type and the request-specific
data in a response.
<!--l. 459--><p class="noindent" >The driver MUST ignore the request-specific data in a response in case the response
type is not VIRTIO_MEM_RESP_ACK.
<a 
 id="x1-595001r601"></a>
<h5 class="paragraphHead"><span class="titlemark">5.15.6.6.2</span> <a 
 id="x1-5960002"></a>Device Requirements: STATE request</h5>
The device MUST ignore anything except the request type and the request-specific
data in a request.
<!--l. 467--><p class="noindent" >The device MUST ignore the <span 
class="aeti-10">padding </span>in the request-specific data in a request.
<!--l. 470--><p class="noindent" >The device MUST reject requests with VIRTIO_MEM_RESP_ERROR if <span 
class="aeti-10">addr </span>is not
aligned to the <span 
class="aeti-10">block_size </span>in the device configuration, if <span 
class="aeti-10">nb_blocks </span>is not greater than 0,
or if any memory block outside of the usable device-managed memory region is
covered by the request.
                                                                  

                                                                  
<!--l. 475--><p class="noindent" >The device MUST acknowledge requests with VIRTIO_MEM_RESP_ACK, supplying
the state of the memory blocks.
<!--l. 478--><p class="noindent" >The device MUST set the state type in the response to VIRTIO_MEM_STATE_PLUGGED
if all requested memory blocks are plugged. The device MUST set the state type in
the response to VIRTIO_MEM_STATE_UNPLUGGED if all requested memory
blocks are unplugged. Otherwise, the device MUST set state type in the response to
VIRTIO_MEM_STATE_MIXED.
<a 
 id="x1-596001r578"></a>
<h3 class="sectionHead"><span class="titlemark">5.16   </span> <a 
 id="x1-59700016"></a>I2C Adapter Device</h3>
<!--l. 3--><p class="nopar" >virtio-i2c is a virtual I2C adapter device. It provides a way to flexibly organize and
use the host I2C controlled devices from the guest. By attaching the host ACPI I2C
controlled nodes to the virtual I2C adapter device, the guest can communicate
with them without changing or adding extra drivers for these controlled I2C
devices.
<a 
 id="x1-597001r588"></a>
<h4 class="subsectionHead"><span class="titlemark">5.16.1   </span> <a 
 id="x1-5980001"></a>Device ID</h4>
<!--l. 10--><p class="nopar" >34
<a 
 id="x1-598001r604"></a>
<h4 class="subsectionHead"><span class="titlemark">5.16.2   </span> <a 
 id="x1-5990002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">requestq</dd></dl>
<a 
 id="x1-599001r605"></a>
<h4 class="subsectionHead"><span class="titlemark">5.16.3   </span> <a 
 id="x1-6000003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_I2C_F_ZERO_LENGTH_REQUEST (0)</span> </dt><dd 
class="description">The
    device supports zero-length I2C request and <span 
class="aeti-10">VIRTIO_I2C_FLAGS_M_RD</span>
    flag. It is mandatory to implement this feature.</dd></dl>
<span 
class="aeb10-">Note:</span> The  <span 
class="aeti-10">VIRTIO_I2C_FLAGS_M_RD  </span>flag  was  not  present  in  the  initial
      implementation of the specification and the direction of the transfer (read
      or  write)  was  inferred  from  the  permissions  (read-only  or  write-only)
      of the buffer itself. There is no need of having backwards compatibility
      for the older specification and so the <span 
class="aeti-10">VIRTIO_I2C_FLAGS_FAIL_NEXT</span>
      feature is made mandatory. The driver should abort negotiation with the
      device, if the device doesn’t offer this feature.
<a 
 id="x1-600001r606"></a>
<h4 class="subsectionHead"><span class="titlemark">5.16.4   </span> <a 
 id="x1-6010004"></a>Device configuration layout</h4>
<!--l. 38--><p class="nopar" >None currently defined.
<a 
 id="x1-601001r607"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">5.16.5   </span> <a 
 id="x1-6020005"></a>Device Initialization</h4>
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-602002x1">The virtqueue is initialized.</li></ol>
<a 
 id="x1-602003r608"></a>
<h4 class="subsectionHead"><span class="titlemark">5.16.6   </span> <a 
 id="x1-6030006"></a>Device Operation</h4>
<a 
 id="x1-603001r600"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.16.6.1   </span> <a 
 id="x1-6040001"></a>Device Operation: Request Queue</h5>
<!--l. 50--><p class="nopar" >The driver queues requests to the virtqueue, and they are used by the device. The
request is the representation of segments of an I2C transaction. Each request is of the
form:
<!--l. 54-->
<div class="lstlisting" id="listing-206"><span class="label"><a 
 id="x1-604001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_i2c_out_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-604002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">addr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-604003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-604004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-604005r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 62-->
<div class="lstlisting" id="listing-207"><span class="label"><a 
 id="x1-604006r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_i2c_in_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-604007r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-604008r3"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 68-->
<div class="lstlisting" id="listing-208"><span class="label"><a 
 id="x1-604009r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_i2c_req</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-604010r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_i2c_out_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">out_hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-604011r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buf</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-604012r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_i2c_in_hdr</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in_hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-604013r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 76--><p class="noindent" >The <span 
class="aeti-10">addr </span>of the request is the address of the I2C controlled device. For 7-bit address
mode (A0 ... A6) and 10-bit address mode (A0 ... A9), the format of <span 
class="aeti-10">addr </span>is defined
as follows:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Bits               </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 15   </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 14   </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 13   </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 12   </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 11   </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 10   </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 9    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 8    </td><td style="text-align: left; min-width: \@testpach 10 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 7    </td><td style="text-align: left; min-width: \@testpach 11 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 6    </td><td style="text-align: left; min-width: \@testpach 12 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 5    </td><td style="text-align: left; min-width: \@testpach 13 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 4    </td><td style="text-align: left; min-width: \@testpach 14 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 3    </td><td style="text-align: left; min-width: \@testpach 15 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 2    </td><td style="text-align: left; min-width: \@testpach 16 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 1    </td><td style="text-align: left; min-width: \@testpach 17 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0  </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >7-bit address </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >0 </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >0 </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >0 </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >0 </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >0 </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >0 </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >0 </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >0 </td><td style="text-align: left; min-width: \@testpach 10 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >A6 </td><td style="text-align: left; min-width: \@testpach 11 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >A5 </td><td style="text-align: left; min-width: \@testpach 12 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >A4 </td><td style="text-align: left; min-width: \@testpach 13 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >A3 </td><td style="text-align: left; min-width: \@testpach 14 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >A2 </td><td style="text-align: left; min-width: \@testpach 15 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >A1 </td><td style="text-align: left; min-width: \@testpach 16 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >A0 </td><td style="text-align: left; min-width: \@testpach 17 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >0</td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 10-bit address  </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > A7  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > A6  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > A5  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > A4  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > A3  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > A2  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > A1  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > A0  </td><td style="text-align: left; min-width: \@testpach 10 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 1    </td><td style="text-align: left; min-width: \@testpach 11 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 1    </td><td style="text-align: left; min-width: \@testpach 12 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 1    </td><td style="text-align: left; min-width: \@testpach 13 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 1    </td><td style="text-align: left; min-width: \@testpach 14 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0    </td><td style="text-align: left; min-width: \@testpach 15 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > A9  </td><td style="text-align: left; min-width: \@testpach 16 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > A8  </td><td style="text-align: left; min-width: \@testpach 17 ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0  </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<!--l. 90--><p class="noindent" >The <span 
class="aeti-10">padding </span>is used to pad to full dword.
<!--l. 92--><p class="noindent" >The <span 
class="aeti-10">flags </span>of the request is defined as follows:
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_I2C_FLAGS_FAIL_NEXT(0)</span> </dt><dd 
class="description">is  used  to  group  the  requests.  For  a
    group requests, a driver clears this bit on the final request and sets it on
    the other requests. If this bit is set and a device fails to process the current
    request, it needs to fail the next request instead of attempting to execute
    it.
                                                                  

                                                                  
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_I2C_FLAGS_M_RD(1)</span> </dt><dd 
class="description">is  used  to  mark  the  request  as  READ  or
    WRITE. If <span 
class="aeti-10">VIRTIO_I2C_FLAGS_M_RD </span>bit is set in the <span 
class="aeti-10">flags</span>, then the
    request is called a read request. If <span 
class="aeti-10">VIRTIO_I2C_FLAGS_M_RD </span>bit is unset
    in the <span 
class="aeti-10">flags</span>, then the request is called a write request.</dd></dl>
<!--l. 107--><p class="noindent" >Other bits of <span 
class="aeti-10">flags </span>are currently reserved as zero for future feature extensibility.
<!--l. 110--><p class="noindent" >The <span 
class="aeti-10">buf </span>is optional and will not be present for a zero-length request, like the SMBus
"Quick" command. The <span 
class="aeti-10">buf </span>contains one segment of an I2C transaction being read
from or written to the device, based on the value of the <span 
class="aeti-10">VIRTIO_I2C_FLAGS_M_RD</span>
bit in the <span 
class="aeti-10">flags </span>field.
<!--l. 115--><p class="noindent" >The final <span 
class="aeti-10">status </span>byte of the request is written by the device: either VIRTIO_I2C_MSG_OK
for success or VIRTIO_I2C_MSG_ERR for error.
<!--l. 118-->
<div class="lstlisting" id="listing-209"><span class="label"><a 
 id="x1-604014r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_I2C_MSG_OK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-604015r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_I2C_MSG_ERR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span>
</div>
<!--l. 123--><p class="noindent" >The virtio I2C protocol supports write-read requests, i.e. an I2C write segment
followed by a read segment (usually, the write segment provides the number of an I2C
controlled device register to be read), by grouping a list of requests together using the
<span 
class="aeti-10">VIRTIO_I2C_FLAGS_FAIL_NEXT </span>flag.
<a 
 id="x1-604016r610"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.16.6.2   </span> <a 
 id="x1-6050002"></a>Device Operation: Operation Status</h5>
<!--l. 130--><p class="nopar" ><span 
class="aeti-10">addr</span>, <span 
class="aeti-10">flags</span>, and “length of <span 
class="aeti-10">buf </span>” are determined by the driver, while <span 
class="aeti-10">status </span>is
determined by the processing of the device. A driver, for a write request, puts the
data to be written to the device into the <span 
class="aeti-10">buf</span>, while a device, for a read request, puts
the data read from device into the <span 
class="aeti-10">buf  </span>according to the request from the
driver.
<!--l. 136--><p class="noindent" >A driver may send one request or multiple requests to the device at a time. The
requests in the virtqueue are both queued and processed in order.
<!--l. 139--><p class="noindent" >If a driver sends multiple requests at a time and a device fails to process some of
them, then a device needs to set the <span 
class="aeti-10">status </span>of the first failed request to be
VIRTIO_I2C_MSG_ERR. For the remaining requests in the same group with the first
failed one, a driver needs to treat them as VIRTIO_I2C_MSG_ERR, no matter what
<span 
class="aeti-10">status </span>of them, a device needs to fail them instead of attempting to execute them
according to the VIRTIO_I2C_FLAGS_FAIL_NEXT bit.
<a 
 id="x1-605001r611"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.16.6.3   </span> <a 
 id="x1-6060003"></a>Driver Requirements: Device Operation</h5>
<!--l. 148--><p class="nopar" >A driver MUST accept the <span 
class="aeti-10">VIRTIO_I2C_F_ZERO_LENGTH_REQUEST </span>feature and
MUST abort negotiation with the device, if the device doesn’t offer this
                                                                  

                                                                  
feature.
<!--l. 152--><p class="noindent" >A driver MUST set <span 
class="aeti-10">addr </span>and <span 
class="aeti-10">flags </span>before sending the request.
<!--l. 154--><p class="noindent" >A driver MUST set the reserved bits of <span 
class="aeti-10">flags </span>to be zero.
<!--l. 156--><p class="noindent" >A driver MUST NOT send the <span 
class="aeti-10">buf</span>, for a zero-length request.
<!--l. 158--><p class="noindent" >A driver MUST NOT use <span 
class="aeti-10">buf</span>, for a read request, if the final <span 
class="aeti-10">status </span>returned from the
device is VIRTIO_I2C_MSG_ERR.
<!--l. 161--><p class="noindent" >A driver MUST set the <span 
class="aeti-10">VIRTIO_I2C_FLAGS_M_RD </span>flag for a read operation, where
the buffer is write-only for the device.
<!--l. 164--><p class="noindent" >A driver MUST NOT set the <span 
class="aeti-10">VIRTIO_I2C_FLAGS_M_RD </span>flag for a write operation,
where the buffer is read-only for the device.
<!--l. 167--><p class="noindent" >A driver MUST queue the requests in order if multiple requests are going to be sent
at a time.
<!--l. 170--><p class="noindent" >If multiple requests are sent at a time and some of them returned from the device
have the <span 
class="aeti-10">status </span>being VIRTIO_I2C_MSG_ERR, a driver MUST treat the first failed
request and the remaining requests in the same group with the first failed one as
VIRTIO_I2C_MSG_ERR.
<a 
 id="x1-606001r612"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.16.6.4   </span> <a 
 id="x1-6070004"></a>Device Requirements: Device Operation</h5>
<!--l. 177--><p class="nopar" >A device MUST offer the <span 
class="aeti-10">VIRTIO_I2C_F_ZERO_LENGTH_REQUEST </span>feature and
MUST reject any driver that doesn’t negotiate this feature.
<!--l. 180--><p class="noindent" >A device SHOULD keep consistent behaviors with the hardware as described in
<a 
href="#x1-3001r1">I2C</a>.
<!--l. 183--><p class="noindent" >A device MUST NOT change the value of <span 
class="aeti-10">addr</span>, and reserved bits of <span 
class="aeti-10">flags</span>.
<!--l. 186--><p class="noindent" >A device MUST not change the value of the <span 
class="aeti-10">buf  </span>for a write request.
<!--l. 188--><p class="noindent" >A device MUST place one I2C segment of the “length of <span 
class="aeti-10">buf </span>”, for the read request,
into the <span 
class="aeti-10">buf  </span>according the driver’s request.
<!--l. 191--><p class="noindent" >A device MUST guarantee the requests in the virtqueue being processed in order if
multiple requests are received at a time.
<!--l. 194--><p class="noindent" >If multiple requests are received at a time and processing of some of the
requests fails, a device MUST set the <span 
class="aeti-10">status </span>of the first failed request to be
VIRTIO_I2C_MSG_ERR and MAY set the <span 
class="aeti-10">status </span>of the remaining requests in the
same group with the first failed one to be VIRTIO_I2C_MSG_ERR.
<a 
 id="x1-607001r603"></a>
<h3 class="sectionHead"><span class="titlemark">5.17   </span> <a 
 id="x1-60800017"></a>SCMI Device</h3>
<!--l. 3--><p class="nopar" >An SCMI device implements the Arm System Control and Management Interface
(SCMI). SCMI can be used for sensors, power state management, clock management
                                                                  

                                                                  
and performance management among other things.
<!--l. 7--><p class="noindent" >This section relies on definitions from the <a 
href="#x1-3001r1">SCMI specification</a>.
<!--l. 10--><p class="noindent" >Virtio SCMI device and driver are mapped to SCMI platform and agent respectively.
The device is visible to a particular SCMI agent. The device allows a guest to
communicate as an SCMI agent using one or more SCMI protocols. The default
SCMI protocols are defined in the <a 
href="#x1-3001r1">SCMI specification</a>. Virtio provides a transport
medium for exchanging SCMI messages between the SCMI agent and platform.
The virtio SCMI transport allows the queueing of multiple messages and
responses.
<!--l. 19--><p class="noindent" >SCMI FastChannels are not supported.
<a 
 id="x1-608001r609"></a>
<h4 class="subsectionHead"><span class="titlemark">5.17.1   </span> <a 
 id="x1-6090001"></a>Device ID</h4>
<!--l. 23--><p class="nopar" >32
<a 
 id="x1-609001r615"></a>
<h4 class="subsectionHead"><span class="titlemark">5.17.2   </span> <a 
 id="x1-6100002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">cmdq
    </dd><dt class="description">
<span 
class="aeb10-">1</span> </dt><dd 
class="description">eventq</dd></dl>
<!--l. 32--><p class="nopar" >The cmdq is used by the driver to send commands to the device. The device replies
with responses (not delayed responses) over the cmdq.
<!--l. 35--><p class="noindent" >The eventq is used by the device to send notifications and delayed responses. The
eventq only exists if VIRTIO_SCMI_F_P2A_CHANNELS was negotiated.
<a 
 id="x1-610001r616"></a>
<h4 class="subsectionHead"><span class="titlemark">5.17.3   </span> <a 
 id="x1-6110003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_SCMI_F_P2A_CHANNELS (0)</span> </dt><dd 
class="description">Device    implements    some    SCMI
    notifications, or delayed responses.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_SCMI_F_SHARED_MEMORY (1)</span> </dt><dd 
class="description">Device   implements   any   SCMI
    statistics shared memory region.</dd></dl>
<!--l. 48--><p class="nopar" >VIRTIO_SCMI_F_P2A_CHANNELS is used to determine the existence of the eventq.
The eventq is required for SCMI notifications and delayed responses.
<!--l. 52--><p class="noindent" >VIRTIO_SCMI_F_SHARED_MEMORY is used to determine whether the device
provides any SCMI statistics shared memory region. SCMI statistics shared memory
regions are defined by some SCMI protocols.
<!--l. 56--><p class="noindent" >The SCMI protocols provide the PROTOCOL_MESSAGE_ATTRIBUTES
                                                                  

                                                                  
commands to inquire about the particular SCMI notifications and delayed responses
implemented by the device. The SCMI protocols provide additional commands to
detect other features implemented by the device.
<a 
 id="x1-611001r613"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.17.3.1   </span> <a 
 id="x1-6120001"></a>Device Requirements: Feature bits</h5>
<!--l. 63--><p class="nopar" >The device MUST offer VIRTIO_SCMI_F_P2A_CHANNELS if the device can
implement at least one SCMI notification, or delayed response.
<!--l. 66--><p class="noindent" >The device MUST offer VIRTIO_SCMI_F_SHARED_MEMORY if the device can
implement at least one SCMI statistics shared memory region.
<a 
 id="x1-612001r617"></a>
<h4 class="subsectionHead"><span class="titlemark">5.17.4   </span> <a 
 id="x1-6130004"></a>Device configuration layout</h4>
<!--l. 71--><p class="nopar" >There is no configuration data for the device.
<a 
 id="x1-613001r619"></a>
<h4 class="subsectionHead"><span class="titlemark">5.17.5   </span> <a 
 id="x1-6140005"></a>Device Initialization</h4>
<!--l. 75--><p class="nopar" >The <a 
href="#x1-1070001">general requirements on device initialization</a> apply.
<a 
 id="x1-614001r620"></a>
<h4 class="subsectionHead"><span class="titlemark">5.17.6   </span> <a 
 id="x1-6150006"></a>Device Operation</h4>
<!--l. 81--><p class="nopar" >The SCMI transport used for the device puts each SCMI message into a dedicated
virtio buffer. The driver uses the cmdq for transmitting SCMI commands and
receiving the corresponding SCMI responses. The device uses the eventq
for transmitting SCMI notifications and delayed responses. Each message
includes an SCMI protocol header and payload, as defined by the <a 
href="#x1-3001r1">SCMI
specification</a>.
<a 
 id="x1-615001r618"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.17.6.1   </span> <a 
 id="x1-6160001"></a>cmdq Operation</h5>
<!--l. 90--><p class="nopar" >Each buffer in the cmdq holds a single SCMI command once the buffer has been
made available. When the buffer has been marked as used, it contains the SCMI
response. An arbitrary number of such SCMI messages can be in transit at the same
time. Conceptually, each SCMI message in the cmdq uses its own SCMI A2P (agent
to platform) channel.
<!--l. 96--><p class="noindent" >The SCMI response is in the same virtio buffer as the corresponding SCMI command.
The response contains the return values which SCMI specifies for each command,
whether synchronous or asynchronous. Delayed responses are distinct SCMI messages
transmitted over the eventq.
<!--l. 101--><p class="noindent" >Buffers in the cmdq contain both the request and the response. A request has the
following layout:
<!--l. 104-->
<div class="lstlisting" id="listing-210"><span class="label"><a 
 id="x1-616001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scmi_request</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-616002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-616003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">params</span><span 
class="pcrr8t-x-x-80">[&lt;</span><span 
class="pcrr8t-x-x-80">actual</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">parameters</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80">&gt;];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-616004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
                                                                  

                                                                  
</div>
<!--l. 111--><p class="noindent" >The virtio_scmi_request fields are interpreted as follows:
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">hdr</span> </dt><dd 
class="description">(device-readable) contains the SCMI message header
    </dd><dt class="description">
<span 
class="aebxti-10">params</span> </dt><dd 
class="description">(device-readable) comprises the SCMI message parameters</dd></dl>
<!--l. 119--><p class="noindent" >A cmdq response has the following layout:
<!--l. 121-->
<div class="lstlisting" id="listing-211"><span class="label"><a 
 id="x1-616005r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scmi_response</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-616006r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-616007r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ret_values</span><span 
class="pcrr8t-x-x-80">[&lt;</span><span 
class="pcrr8t-x-x-80">actual</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">return</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">values</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80">&gt;];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-616008r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 128--><p class="noindent" >The virtio_scmi_response fields are interpreted as follows:
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">hdr</span> </dt><dd 
class="description">(device-writable) contains the SCMI message header
    </dd><dt class="description">
<span 
class="aebxti-10">ret_values</span> </dt><dd 
class="description">(device-writable) comprises the SCMI message return values</dd></dl>
<!--l. 136--><p class="noindent" >If VIRTIO_SCMI_F_P2A_CHANNELS was not negotiated, the device responds
to SCMI commands as if no SCMI notifications or delayed responses were
implemented.
<a 
 id="x1-616009r602"></a>
<h5 class="paragraphHead"><span class="titlemark">5.17.6.1.1</span> <a 
 id="x1-6170001"></a>Device Requirements: cmdq Operation</h5>
The device MAY process available commands out of order and in parallel.
<!--l. 144--><p class="noindent" >The device MUST process all available commands eventually, even in the case of
bursts of multiple command messages.
<!--l. 147--><p class="noindent" >If the <span 
class="aeti-10">status </span>field in the <span 
class="aeti-10">virtio_scmi_response ret_values </span>has a value other than
SUCCESS, the device MUST set the size of <span 
class="aeti-10">ret_values </span>to the size of the <span 
class="aeti-10">status</span>
field.
<!--l. 151--><p class="noindent" >If the driver requests an SCMI notification or a delayed response and there are
currently NOT enough available buffers in the eventq, the device SHOULD still
return SCMI status code SUCCESS.
<!--l. 155--><p class="noindent" >If VIRTIO_SCMI_F_P2A_CHANNELS was not negotiated, the device MUST deny
any request for an SCMI notification or a delayed response by returning SCMI status
code NOT_SUPPORTED.
                                                                  

                                                                  
<!--l. 159--><p class="noindent" >If VIRTIO_SCMI_F_P2A_CHANNELS was not negotiated, the device MUST NOT
indicate in the PROTOCOL_MESSAGE_ATTRIBUTES return values that any
SCMI notification, or delayed response, is implemented.
<a 
 id="x1-617001r623"></a>
<h5 class="paragraphHead"><span class="titlemark">5.17.6.1.2</span> <a 
 id="x1-6180002"></a>Driver Requirements: cmdq Operation</h5>
Before sending a command, the driver MUST wait for responses to all commands
whose completion the driver considers prerequisites to executing the command.
<!--l. 169--><p class="noindent" >With every command message, the driver MUST provide enough device-writable
memory to enable the device to return corresponding return values.
<!--l. 173--><p class="noindent" >If VIRTIO_SCMI_F_P2A_CHANNELS was not negotiated, the driver MUST NOT
request any SCMI notification, nor any delayed response.
<a 
 id="x1-618001r622"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.17.6.2   </span> <a 
 id="x1-6190002"></a>Setting Up eventq Buffers</h5>
<!--l. 178--><p class="nopar" >The driver has to populate the eventq before the device can use it.
<a 
 id="x1-619001r624"></a>
<h5 class="paragraphHead"><span class="titlemark">5.17.6.2.1</span> <a 
 id="x1-6200001"></a>Driver Requirements: Setting Up eventq Buffers</h5>
If VIRTIO_SCMI_F_P2A_CHANNELS was negotiated, the driver SHOULD populate
the eventq with buffers.
<!--l. 185--><p class="noindent" >The driver MUST NOT put device-readable descriptors into the eventq.
<!--l. 187--><p class="noindent" >The driver MUST NOT put into the eventq any buffer which is smaller than
the largest SCMI P2A (platform to agent) message which the driver will
request.
<a 
 id="x1-620001r625"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.17.6.3   </span> <a 
 id="x1-6210003"></a>eventq Operation</h5>
<!--l. 193--><p class="nopar" >Each buffer in the eventq holds (once the buffer is marked as used) either a single
SCMI notification, or a single SCMI delayed response. An arbitrary number of such
SCMI messages can be in transit at the same time. Conceptually, each SCMI message
transmitted over the eventq uses its own SCMI P2A (platform to agent) channel.
Buffers in the eventq have the following layout:
<!--l. 200-->
<div class="lstlisting" id="listing-212"><span class="label"><a 
 id="x1-621001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_scmi_event_msg</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-621002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">start</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">writable</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">data</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-621003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">hdr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-621004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">payload</span><span 
class="pcrr8t-x-x-80">[&lt;</span><span 
class="pcrr8t-x-x-80">actual</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">payload</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80">&gt;];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-621005r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">hdr</span> </dt><dd 
class="description">(device-writable) contains the SCMI message header
    </dd><dt class="description">
                                                                  

                                                                  
<span 
class="aebxti-10">payload</span> </dt><dd 
class="description">(device-writable) comprises the SCMI message payload</dd></dl>
<a 
 id="x1-621006r626"></a>
<h5 class="paragraphHead"><span class="titlemark">5.17.6.3.1</span> <a 
 id="x1-6220001"></a>Device Requirements: eventq Operation</h5>
If the device intends to send a notification and there are no available buffers in the
eventq, the device MAY drop the notification, or send a corresponding notification
later, once enough buffers become available.
<!--l. 220--><p class="noindent" >The device MAY send the notification later if the events which cause the notification
take place in quick succession.
<!--l. 223--><p class="noindent" >If the device sends the notification later, the device MAY send the notification with
updated data, unless the specific SCMI protocol disallows this.
<!--l. 227--><p class="noindent" >If the device intends to send a notification and there are available buffers, but one of
the buffers is too small to fit the notification, the device MAY omit the
notification.
<!--l. 231--><p class="noindent" >If the device intends to send a delayed response and there are no available buffers in
the eventq, the device MUST send the corresponding delayed response once enough
buffers become available.
<!--l. 235--><p class="noindent" >If the <span 
class="aeti-10">status </span>field in a delayed response <span 
class="aeti-10">payload </span>has a value other than SUCCESS, the
device MUST set the size of <span 
class="aeti-10">payload </span>to the size of the <span 
class="aeti-10">status </span>field.
<a 
 id="x1-622001r627"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.17.6.4   </span> <a 
 id="x1-6230004"></a>Shared Memory Operation</h5>
<!--l. 241--><p class="nopar" >Various SCMI protocols define statistics shared memory regions (for statistics and
sensor values).
<a 
 id="x1-623001r628"></a>
<h5 class="paragraphHead"><span class="titlemark">5.17.6.4.1</span> <a 
 id="x1-6240001"></a>Device Requirements: Shared Memory Operation</h5>
If VIRTIO_SCMI_F_SHARED_MEMORY was negotiated, the device MAY
implement an SCMI statistics shared memory region using a virtio shared memory
region.
<!--l. 250--><p class="noindent" >If the device implements a shared memory region, the device MUST assign the
corresponding shmid as per the following table:
<div class="tabular"><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > SCMI statistics shared memory region                     </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Virtio shmid         </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Reserved (invalid)                                                </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0                        </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Power state statistics shared memory region              </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 1                        </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-4"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Performance domain statistics shared memory region  </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 2                        </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-5"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Sensor Values Shared Memory                                </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 3                        </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-6"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Reserved for future use                                         </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 4 to 0x7F             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-7"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Vendor-specific statistics shared memory regions        </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x80 to 0xFF        </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-8"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > Reserved for future use                                         </td><td style="text-align: left; min-width: 0.7\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0x100 and greater  </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr class="row-9"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table></div>
<a 
 id="x1-624001r614"></a>
                                                                  

                                                                  
<h3 class="sectionHead"><span class="titlemark">5.18   </span> <a 
 id="x1-62500018"></a>GPIO Device</h3>
<!--l. 3--><p class="nopar" >The Virtio GPIO device is a virtual General Purpose Input/Output device that
supports a variable number of named I/O lines, which can be configured in input
mode or in output mode with logical level low (0) or high (1).
<a 
 id="x1-625001r621"></a>
<h4 class="subsectionHead"><span class="titlemark">5.18.1   </span> <a 
 id="x1-6260001"></a>Device ID</h4>
<!--l. 8--><p class="nopar" >41
<a 
 id="x1-626001r632"></a>
<h4 class="subsectionHead"><span class="titlemark">5.18.2   </span> <a 
 id="x1-6270002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">requestq
    </dd><dt class="description">
<span 
class="aeb10-">1</span> </dt><dd 
class="description">eventq</dd></dl>
<!--l. 17--><p class="nopar" >The <span 
class="aeti-10">eventq </span>virtqueue is available only if the <span 
class="aeti-10">VIRTIO_GPIO_F_IRQ </span>feature is offered
by the device.
<a 
 id="x1-627001r633"></a>
<h4 class="subsectionHead"><span class="titlemark">5.18.3   </span> <a 
 id="x1-6280003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_GPIO_F_IRQ (0)</span> </dt><dd 
class="description">The device supports interrupts on GPIO lines.</dd></dl>
<a 
 id="x1-628001r634"></a>
<h4 class="subsectionHead"><span class="titlemark">5.18.4   </span> <a 
 id="x1-6290004"></a>Device configuration layout</h4>
<!--l. 28--><p class="nopar" >GPIO device uses the following configuration structure layout:
<!--l. 30-->
<div class="lstlisting" id="listing-213"><span class="label"><a 
 id="x1-629001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpio_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-629002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ngpio</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-629003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80">[2];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-629004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">gpio_names_size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-629005r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">ngpio</span> </dt><dd 
class="description">is the total number of GPIO lines supported by the device.
    </dd><dt class="description">
<span 
class="aebxti-10">padding</span> </dt><dd 
class="description">has no meaning and is reserved for future use. This is set to zero by
    the device.
    </dd><dt class="description">
<span 
class="aebxti-10">gpio_names_size</span> </dt><dd 
class="description">is the size of the gpio-names memory block in bytes, which
    can             be             fetched             by             the             driver
    using the <span 
class="aeti-10">VIRTIO_GPIO_MSG_GET_LINE_NAMES </span>message. The device
    sets this to 0 if it doesn’t support names for the GPIO lines.</dd></dl>
<a 
 id="x1-629006r635"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">5.18.5   </span> <a 
 id="x1-6300005"></a>Device Initialization</h4>
    <ul class="itemize1">
    <li class="itemize">The driver configures and initializes the <span 
class="aeti-10">requestq </span>virtqueue.
    </li>
    <li class="itemize">The  driver  configures  and  initializes  the  <span 
class="aeti-10">eventq   </span>virtqueue,  if  the
    <span 
class="aeti-10">VIRTIO_GPIO_F_IRQ </span>feature has been negotiated.</li></ul>
<a 
 id="x1-630001r636"></a>
<h4 class="subsectionHead"><span class="titlemark">5.18.6   </span> <a 
 id="x1-6310006"></a>Device Operation: requestq</h4>
<!--l. 62--><p class="nopar" >The driver uses the <span 
class="aeti-10">requestq </span>virtqueue to send messages to the device. The driver
sends a pair of buffers, request (filled by driver) and response (to be filled by device
later), to the device. The device in turn fills the response buffer and sends it back to
the driver.
<!--l. 67-->
<div class="lstlisting" id="listing-214"><span class="label"><a 
 id="x1-631001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpio_request</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">gpio</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">value</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631005r5"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 75--><p class="noindent" >All the fields of this structure are set by the driver and read by the device.
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">type</span> </dt><dd 
class="description">is the GPIO message type, i.e. one of <span 
class="aeti-10">VIRTIO_GPIO_MSG_* </span>values.
    </dd><dt class="description">
<span 
class="aebxti-10">gpio</span> </dt><dd 
class="description">is the GPIO line number, i.e. 0 <= <span 
class="aeti-10">gpio </span>< <span 
class="aeti-10">ngpio</span>.
    </dd><dt class="description">
<span 
class="aebxti-10">value</span> </dt><dd 
class="description">is a message specific value.</dd></dl>
<!--l. 87-->
<div class="lstlisting" id="listing-215"><span class="label"><a 
 id="x1-631006r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpio_response</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631007r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631008r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">value</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631009r4"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631010r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631011r6"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Possible</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">values</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631012r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPIO_STATUS_OK</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631013r8"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPIO_STATUS_ERR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x1</span>
</div>
<!--l. 98--><p class="noindent" >All the fields of this structure are set by the device and read by the driver.
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">status</span> </dt><dd 
class="description">of  the  GPIO  message,  <span 
class="aeti-10">VIRTIO_GPIO_STATUS_OK  </span>on  success  and
    <span 
class="aeti-10">VIRTIO_GPIO_STATUS_ERR </span>on failure.
    </dd><dt class="description">
<span 
class="aebxti-10">value</span> </dt><dd 
class="description">is a message specific value.</dd></dl>
<!--l. 108--><p class="noindent" >Following is the list of messages supported by the virtio gpio specification.
<!--l. 110-->
                                                                  

                                                                  
<div class="lstlisting" id="listing-216"><span class="label"><a 
 id="x1-631014r1"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">GPIO</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">message</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">types</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631015r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPIO_MSG_GET_LINE_NAMES</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0001</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631016r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPIO_MSG_GET_DIRECTION</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0002</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631017r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPIO_MSG_SET_DIRECTION</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0003</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631018r5"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPIO_MSG_GET_VALUE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0004</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631019r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPIO_MSG_SET_VALUE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0005</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631020r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPIO_MSG_SET_IRQ_TYPE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0006</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631021r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631022r9"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">GPIO</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Direction</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">types</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631023r10"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPIO_DIRECTION_NONE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x00</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631024r11"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPIO_DIRECTION_OUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x01</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631025r12"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPIO_DIRECTION_IN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x02</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631026r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631027r14"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">GPIO</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">interrupt</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">types</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631028r15"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPIO_IRQ_TYPE_NONE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x00</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631029r16"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPIO_IRQ_TYPE_EDGE_RISING</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x01</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631030r17"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPIO_IRQ_TYPE_EDGE_FALLING</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x02</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631031r18"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPIO_IRQ_TYPE_EDGE_BOTH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x03</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631032r19"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPIO_IRQ_TYPE_LEVEL_HIGH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x04</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-631033r20"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPIO_IRQ_TYPE_LEVEL_LOW</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x08</span>
</div>
<a 
 id="x1-631034r629"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.18.6.1   </span> <a 
 id="x1-6320001"></a>requestq Operation: Get Line Names</h5>
<!--l. 135--><p class="nopar" >The driver sends this message to receive a stream of zero-terminated strings, where
each string represents the name of a GPIO line, present in increasing order of the
GPIO line numbers. The names of the GPIO lines are optional and may be present
only for a subset of GPIO lines. If missing, then a zero-byte must be present for the
GPIO line. If present, the name string must be zero-terminated and the name must
be unique within a GPIO Device. The names of the GPIO lines are encoded in 7-bit
ASCII.
<!--l. 143--><p class="noindent" >These names of the GPIO lines should be most meaningful producer names for the
system, such as name indicating the usage. For example "MMC-CD", "Red LED
Vdd" and "ethernet reset" are reasonable line names as they describe what
the line is used for, while "GPIO0" is not a good name to give to a GPIO
line.
<!--l. 148--><p class="noindent" >Here is an example of how the gpio names memory block may look like for a GPIO
device with 10 GPIO lines, where line names are provided only for lines 0
("MMC-CD"), 5 ("Red LED Vdd") and 7 ("ethernet reset").
<!--l. 152-->
<div class="lstlisting" id="listing-217"><span class="label"><a 
 id="x1-632001r1"></a></span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">gpio_names</span><span 
class="pcrr8t-x-x-80">[]</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">=</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-632002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">M</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">M</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">C</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’-’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">C</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">D</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-632003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-632004r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-632005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-632006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-632007r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">R</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">e</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">d</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">L</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">E</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">D</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">V</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">d</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">d</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-632008r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-632009r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">E</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">t</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">h</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">e</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">r</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">n</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">e</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">t</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">r</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">e</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">e</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">t</span><span 
class="pcrr8t-x-x-80">’,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-632010r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0,</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-632011r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-632012r12"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 167--><p class="noindent" >The device sets the <span 
class="aeti-10">gpio_names_size </span>to a non-zero value if this message is supported
by the device, else it must be set to zero.
<!--l. 170--><p class="noindent" >This message type uses different layout for the response structure, as the device needs
to return the <span 
class="aeti-10">gpio_names </span>array.
<!--l. 173-->
<div class="lstlisting" id="listing-218"><span class="label"><a 
 id="x1-632013r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpio_response_N</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-632014r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-632015r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">value</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">N</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-632016r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 180--><p class="noindent" >The driver must allocate the <span 
class="aeti-10">value[N] </span>buffer in the <span 
class="aeti-10">struct virtio_gpio_response_N </span>for
N bytes, where N = <span 
class="aeti-10">gpio_names_size</span>.
<!--l. 189--><p class="noindent" ><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeb10-">Request  </span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">type</span>              </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">gpio</span>              </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">value</span>              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">VIRTIO_GPIO_MSG_GET_LINE_NAMES</span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >0 </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0                 </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table>
                                                                  

                                                                  
<!--l. 197--><p class="noindent" ><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeb10-">Response  </span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">status</span>             </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">value[N]</span>           </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">Where N is</span>        </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">VIRTIO_GPIO_STATUS_*</span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >gpio-names        </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">gpio_names_size</span>    </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table>
<a 
 id="x1-632017r638"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.18.6.2   </span> <a 
 id="x1-6330002"></a>requestq Operation: Get Direction</h5>
<!--l. 201--><p class="nopar" >The driver sends this message to request the device to return a line’s configured
direction.
<!--l. 210--><p class="noindent" ><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeb10-">Request  </span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">type</span>              </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">gpio</span>              </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">value</span>              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">VIRTIO_GPIO_MSG_GET_DIRECTION</span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >line number  </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0                 </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table>
<!--l. 218--><p class="noindent" ><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeb10-">Response  </span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">status</span>                      </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">value</span>                      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">VIRTIO_GPIO_STATUS_*</span>    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0  =  none,  1  =  output,  2  =
 input                      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          </td>
</tr></table>
<a 
 id="x1-633001r639"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.18.6.3   </span> <a 
 id="x1-6340003"></a>requestq Operation: Set Direction</h5>
<!--l. 222--><p class="nopar" >The driver sends this message to request the device to configure a line’s direction.
The driver can either set the direction to <span 
class="aeti-10">VIRTIO_GPIO_DIRECTION_IN</span>
or <span 
class="aeti-10">VIRTIO_GPIO_DIRECTION_OUT</span>, which also activates the line, or to
<span 
class="aeti-10">VIRTIO_GPIO_DIRECTION_NONE</span>, which deactivates the line.
<!--l. 228--><p class="noindent" >The driver should set the value of the GPIO line, using the <span 
class="aeti-10">VIRTIO_GPIO_MSG_SET_VALUE</span>
message, before setting the direction of the line to output to avoid any undesired
behavior.
<!--l. 238--><p class="noindent" ><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeb10-">Request  </span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">type</span>              </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">gpio</span>              </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">value</span>              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">VIRTIO_GPIO_MSG_SET_DIRECTION</span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >line number   </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0   =   none,   1   =
 output, 2 = input   </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         </td>
</tr></table>
<!--l. 246--><p class="noindent" ><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeb10-">Response  </span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">status</span>                      </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">value</span>                      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">VIRTIO_GPIO_STATUS_*</span>    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0                          </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table>
<a 
 id="x1-634001r640"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.18.6.4   </span> <a 
 id="x1-6350004"></a>requestq Operation: Get Value</h5>
<!--l. 250--><p class="nopar" >The driver sends this message to request the device to return current value sensed on
a line.
<!--l. 259--><p class="noindent" ><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeb10-">Request  </span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">type</span>              </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">gpio</span>              </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">value</span>              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">VIRTIO_GPIO_MSG_GET_VALUE</span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >line number       </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0                 </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table>
                                                                  

                                                                  
<!--l. 267--><p class="noindent" ><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeb10-">Response  </span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">status</span>                      </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">value</span>                      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">VIRTIO_GPIO_STATUS_*</span>    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0 = low, 1 = high            </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table>
<a 
 id="x1-635001r641"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.18.6.5   </span> <a 
 id="x1-6360005"></a>requestq Operation: Set Value</h5>
<!--l. 271--><p class="nopar" >The driver sends this message to request the device to set the value of a line. The
line may already be configured for output or may get configured to output
later, at which point this output value must be used by the device for the
line.
<!--l. 281--><p class="noindent" ><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeb10-">Request  </span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">type</span>              </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">gpio</span>              </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">value</span>              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">VIRTIO_GPIO_MSG_SET_VALUE</span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >line number       </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0 = low, 1 = high   </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table>
<!--l. 289--><p class="noindent" ><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeb10-">Response  </span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">status</span>                      </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">value</span>                      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">VIRTIO_GPIO_STATUS_*</span>    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0                          </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table>
<a 
 id="x1-636001r642"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.18.6.6   </span> <a 
 id="x1-6370006"></a>requestq Operation: Set IRQ Type</h5>
<!--l. 293--><p class="nopar" >This request is allowed only if the <span 
class="aeti-10">VIRTIO_GPIO_F_IRQ </span>feature has been
negotiated.
<!--l. 296--><p class="noindent" >The interrupt configuration is divided into two steps, enabling or disabling of the
interrupt at the device and masking or unmasking of the interrupt for delivery at the
driver. This request only pertains to enabling or disabling of the interrupt at the
device, the masking and unmasking of the interrupt is handled by a separate request
that takes place over the <span 
class="aeti-10">eventq </span>virtqueue.
<!--l. 303--><p class="noindent" >The driver sends the <span 
class="aeti-10">VIRTIO_GPIO_MSG_SET_IRQ_TYPE </span>message over the
<span 
class="aeti-10">requestq </span>virtqueue to enable or disable interrupt for a GPIO line at the
device.
<!--l. 307--><p class="noindent" >The driver sends this message with trigger type set to any valid value other than
<span 
class="aeti-10">VIRTIO_GPIO_IRQ_TYPE_NONE</span>, to enable the interrupt for a GPIO line, this
doesn’t unmask the interrupt for delivery at the driver though. For edge trigger type,
the device should latch the interrupt events from this point onward and notify it to
the driver once the interrupt is unmasked. For level trigger type, the device should
notify the driver once the interrupt signal on a line is sensed and the interrupt is
unmasked for the line.
<!--l. 315--><p class="noindent" >The driver sends this message with trigger type set to <span 
class="aeti-10">VIRTIO_GPIO_IRQ_TYPE_NONE</span>,
to disable the interrupt for a GPIO line. The device should discard any latched
interrupt event associated with it. In order to change the trigger type of an already
enabled interrupt, the driver should first disable the interrupt and then re-enable it
with appropriate trigger type.
                                                                  

                                                                  
<!--l. 321--><p class="noindent" >The interrupts are masked at initialization and the driver unmasks them by queuing
a pair of buffers, of type <span 
class="aeti-10">virtio_gpio_irq_request </span>and <span 
class="aeti-10">virtio_gpio_irq_response</span>, over
the <span 
class="aeti-10">eventq </span>virtqueue for a GPIO line. A separate pair of buffers must be
queued for each GPIO line, the driver wants to configure for interrupts.
Once an already enabled interrupt is unmasked by the driver, the device
can notify the driver of an active interrupt signal on the GPIO line. This is
done by updating the <span 
class="aeti-10">struct virtio_gpio_irq_response </span>buffer’s <span 
class="aeti-10">status </span>with
<span 
class="aeti-10">VIRTIO_GPIO_IRQ_STATUS_VALID </span>and returning the updated buffers to the
driver. The interrupt is masked automatically at this point until the buffers are
available again at the device.
<!--l. 333--><p class="noindent" >The interrupt for a GPIO line should not be unmasked before being enabled by the
driver.
<!--l. 336--><p class="noindent" >If the interrupt is disabled by the driver, by setting the trigger type to
<span 
class="aeti-10">VIRTIO_GPIO_IRQ_TYPE_NONE</span>, or the interrupt is unmasked without
being enabled first, the device should return any unused pair of buffers for
the GPIO line, over the <span 
class="aeti-10">eventq </span>virtqueue, after setting the <span 
class="aeti-10">status </span>field to
<span 
class="aeti-10">VIRTIO_GPIO_IRQ_STATUS_INVALID</span>. This also masks the interrupt.
<!--l. 348--><p class="noindent" ><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeb10-">Request  </span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">type</span>              </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">gpio</span>              </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">value</span>              </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">VIRTIO_GPIO_MSG_SET_IRQ_TYPE</span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >line number    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > one                   of
 <span 
class="aeti-10">VIRTIO_GPIO_IRQ_TYPE_*</span></td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >         </td>
</tr></table>
<!--l. 356--><p class="noindent" ><table style="border-collapse:collapse;"><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-1"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeb10-">Response  </span></td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">status</span>                      </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">value</span>                      </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-2"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" >          </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > <span 
class="aeti-10">VIRTIO_GPIO_STATUS_*</span>    </td><td style="text-align: left; min-width: \TX@col@width ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" > 0                          </td></tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td></tr><tr class="row-3"><td style="text-align: left; min-width: 0.2\textwidth ; border-left-style:solid; border-right-style:solid; border-width:thin; padding-left:6pt; padding-right:6pt;" ></td>
</tr></table>
<a 
 id="x1-637001r643"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.18.6.7   </span> <a 
 id="x1-6380007"></a>requestq Operation: Message Flow</h5>
    <ul class="itemize1">
    <li class="itemize">The  driver  queues  <span 
class="aeti-10">struct  virtio_gpio_request  </span>and  <span 
class="aeti-10">virtio_gpio_response</span>
    buffers  to  the  <span 
class="aeti-10">requestq  </span>virtqueue,  after  filling  all  fields  of  the  <span 
class="aeti-10">struct</span>
    <span 
class="aeti-10">virtio_gpio_request </span>buffer as defined by the specific message type.
    </li>
    <li class="itemize">The driver notifies the device of the presence of buffers on the <span 
class="aeti-10">requestq</span>
    virtqueue.
    </li>
    <li class="itemize">The device, after receiving the message from the driver, processes it and
    fills all the fields of the <span 
class="aeti-10">struct virtio_gpio_response </span>buffer (received from the
    driver). The <span 
class="aeti-10">status </span>must be set to <span 
class="aeti-10">VIRTIO_GPIO_STATUS_OK </span>on success
    and <span 
class="aeti-10">VIRTIO_GPIO_STATUS_ERR </span>on failure.
    </li>
    <li class="itemize">The device puts the buffers back on the <span 
class="aeti-10">requestq </span>virtqueue and notifies the
                                                                  

                                                                  
    driver of the same.
    </li>
    <li class="itemize">The driver fetches the buffers and processes the response received in the
    <span 
class="aeti-10">virtio_gpio_response </span>buffer.
    </li>
    <li class="itemize">The driver can send multiple messages in parallel for same or different
    GPIO line.</li></ul>
<a 
 id="x1-638001r644"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.18.6.8   </span> <a 
 id="x1-6390008"></a>Driver Requirements: requestq Operation</h5>
    <ul class="itemize1">
    <li class="itemize">The driver MUST send messages on the <span 
class="aeti-10">requestq </span>virtqueue.
    </li>
    <li class="itemize">The                       driver                       MUST                       queue
    both <span 
class="aeti-10">struct virtio_gpio_request </span>and <span 
class="aeti-10">virtio_gpio_response </span>for every message
    sent to the device.
    </li>
    <li class="itemize">The <span 
class="aeti-10">struct virtio_gpio_request  </span>buffer MUST be filled by the driver and
    MUST be read-only for the device.
    </li>
    <li class="itemize">The <span 
class="aeti-10">struct virtio_gpio_response </span>buffer MUST be filled by the device and
    MUST be writable by the device.
    </li>
    <li class="itemize">The driver MAY send multiple messages for same or different GPIO lines
    in parallel.
    </li>
    <li class="itemize">The driver MUST NOT send IRQ messages if the <span 
class="aeti-10">VIRTIO_GPIO_F_IRQ</span>
    feature has not been negotiated.
    </li>
    <li class="itemize">The driver MUST NOT send IRQ messages for a GPIO line configured for
    output.
    </li>
    <li class="itemize">The                                      driver                                      MUST
    set the IRQ trigger type to <span 
class="aeti-10">VIRTIO_GPIO_IRQ_TYPE_NONE </span>once it is
    done using the GPIO line configured for interrupts.
    </li>
    <li class="itemize">In  order  to  change  the  trigger  type  of  an  already  enabled  interrupt,
    the driver MUST first disable the interrupt and then re-enable it with
    appropriate trigger type.</li></ul>
<a 
 id="x1-639001r645"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">5.18.6.9   </span> <a 
 id="x1-6400009"></a>Device Requirements: requestq Operation</h5>
    <ul class="itemize1">
    <li class="itemize">The device MUST set all the fields of the <span 
class="aeti-10">struct virtio_gpio_response </span>before
    sending it back to the driver.
    </li>
    <li class="itemize">The  device  MUST  set  all  the  fields  of  the  <span 
class="aeti-10">struct  virtio_gpio_config  </span>on
    receiving a configuration request from the driver.
    </li>
    <li class="itemize">The  device  MUST  set  the  <span 
class="aeti-10">gpio_names_size  </span>field  as  zero  in  the  <span 
class="aeti-10">struct</span>
    <span 
class="aeti-10">virtio_gpio_config</span>, if it doesn’t implement names for individual GPIO lines.
    </li>
    <li class="itemize">The   device   MUST   set   the   <span 
class="aeti-10">gpio_names_size   </span>field,   in   the   <span 
class="aeti-10">struct</span>
    <span 
class="aeti-10">virtio_gpio_config</span>, with the size of gpio-names memory block in bytes, if the
    device implements names for individual GPIO lines. The strings MUST be
    zero-terminated and an unique (if available) within the GPIO device.
    </li>
    <li class="itemize">The device MUST process multiple messages, for the same GPIO line,
    sequentially and respond to them in the order they were received on the
    virtqueue.
    </li>
    <li class="itemize">The device MAY process messages, for different GPIO lines, out of order
    and in parallel, and MAY send message’s response to the driver out of
    order.
    </li>
    <li class="itemize">The  device  MUST  discard  all  state  information  corresponding  to  a
    GPIO  line,  once  the  driver  has  requested  to  set  its  direction  to
    <span 
class="aeti-10">VIRTIO_GPIO_DIRECTION_NONE</span>.
    </li>
    <li class="itemize">The device MUST latch an edge interrupt if the interrupt is enabled but
    still masked.
    </li>
    <li class="itemize">The device MUST NOT latch an level interrupt if the interrupt is enabled
    but still masked.
    </li>
    <li class="itemize">The device MUST discard any latched interrupt for a GPIO line, once
    interrupt is disabled for the same.</li></ul>
<a 
 id="x1-640001r637"></a>
<h4 class="subsectionHead"><span class="titlemark">5.18.7   </span> <a 
 id="x1-6410007"></a>Device Operation: eventq</h4>
<!--l. 459--><p class="nopar" >The <span 
class="aeti-10">eventq </span>virtqueue is used by the driver to unmask the interrupts and used by the
                                                                  

                                                                  
device to notify the driver of newly sensed interrupts. In order to unmask interrupt
on a GPIO line, the driver queues a pair of buffers, <span 
class="aeti-10">struct virtio_gpio_irq_request</span>
(filled by driver) and <span 
class="aeti-10">struct virtio_gpio_irq_response </span>(to be filled by device later), to
the <span 
class="aeti-10">eventq </span>virtqueue. A separate pair of buffers must be queued for each GPIO
line, the driver wants to configure for interrupts. The device, on sensing an
interrupt, returns the pair of buffers for the respective GPIO line, which also
masks the interrupts. The driver can queue the buffers again to unmask the
interrupt.
<!--l. 469-->
<div class="lstlisting" id="listing-219"><span class="label"><a 
 id="x1-641001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpio_irq_request</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-641002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">gpio</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-641003r3"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 475--><p class="noindent" >This structure is filled by the driver and read by the device.
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">gpio</span> </dt><dd 
class="description">is the GPIO line number, i.e. 0 <= <span 
class="aeti-10">gpio </span>< <span 
class="aeti-10">ngpio</span>.</dd></dl>
<!--l. 482-->
<div class="lstlisting" id="listing-220"><span class="label"><a 
 id="x1-641004r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_gpio_irq_response</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-641005r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-641006r3"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-641007r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-641008r5"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Possible</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">values</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">interrupt</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-641009r6"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPIO_IRQ_STATUS_INVALID</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x0</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-641010r7"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_GPIO_IRQ_STATUS_VALID</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span><span 
class="pcrr8t-x-x-80">x1</span>
</div>
<!--l. 492--><p class="noindent" >This structure is filled by the device and read by the driver.
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">status</span> </dt><dd 
class="description">of   the   interrupt   event,   <span 
class="aeti-10">VIRTIO_GPIO_IRQ_STATUS_VALID   </span>on
    interrupt  and  <span 
class="aeti-10">VIRTIO_GPIO_IRQ_STATUS_INVALID  </span>to  return  the
    buffers back to the driver after interrupt is disabled.</dd></dl>
<a 
 id="x1-641011r646"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.18.7.1   </span> <a 
 id="x1-6420001"></a>eventq Operation: Message Flow</h5>
    <ul class="itemize1">
    <li class="itemize">The virtio-gpio driver is requested by a client driver to enable interrupt for
    a GPIO line and configure it to a particular trigger type.
    </li>
    <li class="itemize">The driver sends the <span 
class="aeti-10">VIRTIO_GPIO_MSG_SET_IRQ_TYPE </span>message, over
    the <span 
class="aeti-10">requestq </span>virtqueue, and the device configures the GPIO line for the
    requested  trigger  type  and  enables  the  interrupt.  The  interrupt  is  still
    masked for delivery though. The device shall latch the interrupt from now
    onward for edge trigger type.
    </li>
    <li class="itemize">The driver unmasks the interrupt by queuing a pair of buffers to the <span 
class="aeti-10">eventq</span>
    virtqueue for the GPIO line. The driver can do this before enabling the
    interrupt as well, though the interrupt must be both unmasked and enabled
                                                                  

                                                                  
    to get delivered at the driver.
    </li>
    <li class="itemize">The driver notifies the device of the presence of new buffers on the <span 
class="aeti-10">eventq</span>
    virtqueue. The interrupt is fully configured at this point.
    </li>
    <li class="itemize">The  device,  on  sensing  an  active  interrupt  on  the  GPIO  line,  finds
    the  matching  buffers  (based  on  GPIO  line  number)  from  the  <span 
class="aeti-10">eventq</span>
    virtqueue and update its <span 
class="aeti-10">struct virtio_gpio_irq_response </span>buffer’s <span 
class="aeti-10">status </span>with
    <span 
class="aeti-10">VIRTIO_GPIO_IRQ_STATUS_VALID </span>and returns the pair of buffers to
    the device. This results in masking the interrupt as well.
    </li>
    <li class="itemize">The device notifies the driver of the presence of returned buffers on the
    <span 
class="aeti-10">eventq </span>virtqueue.
    </li>
    <li class="itemize">If the GPIO line is configured for level interrupts, the device ignores any
    further interrupt signals on this GPIO line, until the interrupt is unmasked
    again by the driver by making the buffers available to the device. Once the
    interrupt is unmasked again and the interrupt on the line is still active, the
    device shall notify the driver again.
    </li>
    <li class="itemize">If the GPIO line is configured for edge interrupts, the device latches the
    interrupt received for this GPIO line, until the interrupt is unmasked again
    by  the  driver  by  making  the  buffers  available  to  the  device.  Once  the
    interrupt is unmasked again and an interrupt was latched earlier, the device
    shall notify the driver again.
    </li>
    <li class="itemize">The  driver  on  receiving  the  notification  from  the  device,  processes  the
    interrupt. The interrupt is masked at the device until the buffers are queued
    again by the driver.
    </li>
    <li class="itemize">In a typical guest operating system kernel, the virtio-gpio driver notifies
    the client driver, that is associated with this GPIO line, to process the
    event. In the case of a level triggered interrupt, the client driver shall fully
    process and acknowledge the event at its source to return the line to its
    inactive state before the interrupt is unmasked again to avoid a spurious
    interrupt.
    </li>
    <li class="itemize">Once the interrupt is handled, the driver may queue a pair of buffers for
    the GPIO line to unmask the interrupt again.
    </li>
    <li class="itemize">The            driver            can            also            disable            the
                                                                  

                                                                  
    interrupt by sending the <span 
class="aeti-10">VIRTIO_GPIO_MSG_SET_IRQ_TYPE </span>message,
    with  <span 
class="aeti-10">VIRTIO_GPIO_IRQ_TYPE_NONE  </span>trigger  type.  In  that  case,  the
    device shall return the unused pair of buffers for the GPIO line after setting
    the <span 
class="aeti-10">status </span>field with <span 
class="aeti-10">VIRTIO_GPIO_IRQ_STATUS_INVALID</span>.</li></ul>
<a 
 id="x1-642001r648"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.18.7.2   </span> <a 
 id="x1-6430002"></a>Driver Requirements: eventq Operation</h5>
    <ul class="itemize1">
    <li class="itemize">The driver MUST both enable and unmask the interrupt in order to get
    notified for the same.
    </li>
    <li class="itemize">The driver MUST enable the interrupt before unmasking it.
    </li>
    <li class="itemize">To unmask the interrupt, the driver MUST queue a separate pair of buffers
    to the <span 
class="aeti-10">eventq </span>virtqueue for each GPIO line.
    </li>
    <li class="itemize">The driver MUST NOT add multiple pairs of buffers for the same GPIO
    line on the <span 
class="aeti-10">eventq </span>virtqueue.</li></ul>
<a 
 id="x1-643001r649"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.18.7.3   </span> <a 
 id="x1-6440003"></a>Device Requirements: eventq Operation</h5>
    <ul class="itemize1">
    <li class="itemize">The device MUST NOT send an interrupt event to the driver for a GPIO
    line unless the interrupt has been both unmasked and enabled by the driver.
    </li>
    <li class="itemize">On   receiving   <span 
class="aeti-10">VIRTIO_GPIO_MSG_SET_IRQ_TYPE   </span>message,   with
    <span 
class="aeti-10">VIRTIO_GPIO_IRQ_TYPE_NONE </span>trigger type, the device MUST return
    the buffers, if they were received earlier, after setting the <span 
class="aeti-10">status </span>field to
    <span 
class="aeti-10">VIRTIO_GPIO_IRQ_STATUS_INVALID</span>.</li></ul>
<a 
 id="x1-644001r631"></a>
<h3 class="sectionHead"><span class="titlemark">5.19   </span> <a 
 id="x1-64500019"></a>PMEM Device</h3>
<!--l. 3--><p class="nopar" >The virtio pmem device is a persistent memory (NVDIMM) device that provides a
virtio based asynchronous flush mechanism. This avoids the need for a separate page
cache in the guest and keeps the page cache only in the host. Under memory
pressure, the host makes use of efficient memory reclaim decisions for page cache
pages of all the guests. This helps to reduce the memory footprint and fits more
guests in the host system.
<!--l. 11--><p class="noindent" >The virtio pmem device provides access to byte-addressable persistent memory. The
persistent memory is a directly accessible range of system memory. Data written to
this memory is made persistent by separately sending a flush command.
Writes that have been flushed are preserved across device reset and power
failure.
                                                                  

                                                                  
<a 
 id="x1-645001r647"></a>
<h4 class="subsectionHead"><span class="titlemark">5.19.1   </span> <a 
 id="x1-6460001"></a>Device ID</h4>
<!--l. 18--><p class="nopar" >27
<a 
 id="x1-646001r652"></a>
<h4 class="subsectionHead"><span class="titlemark">5.19.2   </span> <a 
 id="x1-6470002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">req_vq</dd></dl>
<a 
 id="x1-647001r653"></a>
<h4 class="subsectionHead"><span class="titlemark">5.19.3   </span> <a 
 id="x1-6480003"></a>Feature bits</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_PMEM_F_SHMEM_REGION (0)</span> </dt><dd 
class="description">The  guest  physical  address  range
    will be indicated as a shared memory region.</dd></dl>
<a 
 id="x1-648001r654"></a>
<h4 class="subsectionHead"><span class="titlemark">5.19.4   </span> <a 
 id="x1-6490004"></a>Device configuration layout</h4>
<!--l. 34-->
<div class="lstlisting" id="listing-221"><span class="label"><a 
 id="x1-649001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pmem_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-649002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">start</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-649003r3"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">size</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-649004r4"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">start</span> </dt><dd 
class="description">contains the physical address of the first byte of the persistent memory
    region, if VIRTIO_PMEM_F_SHMEM_REGION has not been negotiated.
    </dd><dt class="description">
<span 
class="aebxti-10">size</span> </dt><dd 
class="description">contains                        the                        length                        of
    this address range, if VIRTIO_PMEM_F_SHMEM_REGION has not been
    negotiated.</dd></dl>
<a 
 id="x1-649005r655"></a>
<h4 class="subsectionHead"><span class="titlemark">5.19.5   </span> <a 
 id="x1-6500005"></a>Device Initialization</h4>
<!--l. 51--><p class="nopar" >The device indicates the guest physical address to the driver in one of two
ways:
    <ol  class="enumerate1" >
    <li 
  class="enumerate" id="x1-650002x1">As a physical address, using virtio_pmem_config.
    </li>
    <li 
  class="enumerate" id="x1-650004x2">As a shared memory region.</li></ol>
<!--l. 57--><p class="noindent" >The driver determines the start address and size of the persistent memory region in
preparation for reading or writing data.
<!--l. 59--><p class="noindent" >The driver initializes req_vq in preparation for making flush requests.
                                                                  

                                                                  
<a 
 id="x1-650005r650"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.19.5.1   </span> <a 
 id="x1-6510001"></a>Device Requirements: Device Initialization</h5>
<!--l. 63--><p class="nopar" >If VIRTIO_PMEM_F_SHMEM_REGION has been negotiated, the device MUST
indicate the guest physical address as a shared memory region. The device MUST
use shared memory region ID 0. The device SHOULD set <span 
class="aeti-10">start </span>and <span 
class="aeti-10">size </span>to
zero.
<!--l. 67--><p class="noindent" >If VIRTIO_PMEM_F_SHMEM_REGION has not been negotiated, the device MUST
indicate the guest physical address as a physical address. The device MUST set
<span 
class="aeti-10">start </span>to the absolute address and <span 
class="aeti-10">size </span>to the size of the address range, in
bytes.
<a 
 id="x1-651001r657"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.19.5.2   </span> <a 
 id="x1-6520002"></a>Driver Requirements: Device Initialization</h5>
<!--l. 74--><p class="nopar" >If VIRTIO_PMEM_F_SHMEM_REGION has been negotiated, the driver MUST
query shared memory ID 0 for the physical address ranges, and MUST NOT use <span 
class="aeti-10">start</span>
or <span 
class="aeti-10">stop</span>.
<!--l. 78--><p class="noindent" >If VIRTIO_PMEM_F_SHMEM_REGION has not been negotiated, the driver MUST
read the physical address ranges from <span 
class="aeti-10">start </span>and <span 
class="aeti-10">stop</span>.
<a 
 id="x1-652001r656"></a>
<h4 class="subsectionHead"><span class="titlemark">5.19.6   </span> <a 
 id="x1-6530006"></a>Driver Operations</h4>
<!--l. 83--><p class="nopar" >Requests have the following format:
<!--l. 85-->
<div class="lstlisting" id="listing-222"><span class="label"><a 
 id="x1-653001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pmem_req</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-653002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">type</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-653003r3"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 91--><p class="noindent" ><span 
class="aeti-10">type </span>is the request command type.
<!--l. 93--><p class="noindent" >Possible request types are:
<!--l. 95-->
<div class="lstlisting" id="listing-223"><span class="label"><a 
 id="x1-653004r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_PMEM_REQ_TYPE_FLUSH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0</span>
</div>
<a 
 id="x1-653005r659"></a>
<h4 class="subsectionHead"><span class="titlemark">5.19.7   </span> <a 
 id="x1-6540007"></a>Device Operations</h4>
<a 
 id="x1-654001r658"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.19.7.1   </span> <a 
 id="x1-6550001"></a>Device Requirements: Device Operation: Virtqueue flush</h5>
<!--l. 102--><p class="nopar" >The device MUST ensure that all writes completed before a flush request
persist across device reset and power failure before completing the flush
                                                                  

                                                                  
request.
<a 
 id="x1-655001r661"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.19.7.2   </span> <a 
 id="x1-6560002"></a>Device Operations</h5>
<!--l. 105-->
<div class="lstlisting" id="listing-224"><span class="label"><a 
 id="x1-656001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_pmem_resp</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-656002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ret</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-656003r3"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
<!--l. 111--><p class="noindent" ><span 
class="aeti-10">ret </span>is the value which the device returns after command completion.
<a 
 id="x1-656004r662"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.19.7.3   </span> <a 
 id="x1-6570003"></a>Device Requirements: Device Operation: Virtqueue return</h5>
<!--l. 115--><p class="nopar" >The device MUST return "0" for success and "-1" for failure.
<a 
 id="x1-657001r660"></a>
<h4 class="subsectionHead"><span class="titlemark">5.19.8   </span> <a 
 id="x1-6580008"></a>Possible security implications</h4>
<!--l. 119--><p class="nopar" >There could be potential security implications depending on how memory mapped
backing device is used. By default device emulation is done with SHARED memory
mapping. There is a contract between driver and device to access shared memory
region for read or write operations.
<!--l. 124--><p class="noindent" >If a malicious driver or device maps the same memory region, the attacker can make
use of known side channel attacks to predict the current state of data. If both
attacker and victim somehow execute same shared code after a flush or evict
operation, with difference in execution timing attacker could infer another device’s
data.
<a 
 id="x1-658001r664"></a>
<h4 class="subsectionHead"><span class="titlemark">5.19.9   </span> <a 
 id="x1-6590009"></a>Countermeasures</h4>
<a 
 id="x1-659001r663"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.19.9.1   </span> <a 
 id="x1-6600001"></a>With SHARED mapping</h5>
<!--l. 134--><p class="nopar" >If a device’s backing region is shared between multiple devices, this may
act as a metric for side channel attacks. As a counter measure every device
should have its own (not shared with another driver) SHARED backing
memory.
<a 
 id="x1-660001r666"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.19.9.2   </span> <a 
 id="x1-6610002"></a>With PRIVATE mapping</h5>
<!--l. 139--><p class="nopar" >There maybe be chances of side channels attack with PRIVATE memory mapping
similar to SHARED with read-only shared mappings. PRIVATE is not used for virtio
pmem making this usecase irrelevant.
<a 
 id="x1-661001r667"></a>
                                                                  

                                                                  
<h5 class="subsubsectionHead"><span class="titlemark">5.19.9.3   </span> <a 
 id="x1-6620003"></a>Workload specific mapping</h5>
<!--l. 145--><p class="nopar" >When using SHARED mappings with a workload that is a single application inside
the driver where the risk in sharing data is very low or nonexisting, the device
sharing the same backing region with a SHARED mapping can be used as a valid
configuration.
<a 
 id="x1-662001r668"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.19.9.4   </span> <a 
 id="x1-6630004"></a>Prevent cache eviction</h5>
<!--l. 151--><p class="nopar" >Don’t allow device shared region eviction from driver filesystem trim or discard like
commands with virtio pmem. This rules out any possibility of evict-reload cache side
channel attacks if backing region is shared (SHARED) between mutliple devices.
Though if we use per device backing file with shared mapping this countermeasure is
not required.
<a 
 id="x1-663001r651"></a>
<h3 class="sectionHead"><span class="titlemark">5.20   </span> <a 
 id="x1-66400020"></a>Vhost-user Device Backend</h3>
<!--l. 4--><p class="nopar" >The vhost-user device backend facilitates vhost-user device emulation through
vhost-user protocol exchanges and access to shared memory. Software-defined
networking, storage, and other I/O appliances can provide services through this
device.
<!--l. 9--><p class="noindent" >This section relies on definitions from the <a 
href="#x1-3001r1">Vhost-user Protocol</a>. Knowledge of the
vhost-user protocol is a prerequisite for understanding this device.
<!--l. 13--><p class="noindent" >The <a 
href="#x1-3001r1">Vhost-user Protocol</a> was originally designed for processes on a single system
communicating over UNIX domain sockets. The virtio vhost-user device backend
allows the vhost-user backend to communicate with the vhost-user frontend over
the device instead of a UNIX domain socket. This allows the backend and
frontend to run on two separate systems such as a virtual machine and a
hypervisor.
<!--l. 20--><p class="noindent" >The vhost-user backend program exchanges vhost-user protocol messages with the
vhost-user frontend through this device. How the device implementation
communicates with the vhost-user frontend is beyond the scope of this specification.
One possible device implementation uses a UNIX domain socket to relay messages to
a vhost-user frontend process running on the same host.
<!--l. 26--><p class="noindent" >Existing vhost-user backend programs that communicate over UNIX domain sockets
can support the virtio vhost-user device backend without invasive changes because
the pre-existing vhost-user wire protocol is used.
<a 
 id="x1-664001r665"></a>
<h4 class="subsectionHead"><span class="titlemark">5.20.1   </span> <a 
 id="x1-6650001"></a>Device ID</h4>
<!--l. 31--><p class="nopar" >43
<a 
 id="x1-665001r671"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">5.20.2   </span> <a 
 id="x1-6660002"></a>Virtqueues</h4>
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">rxq (device-to-driver vhost-user protocol messages)
    </dd><dt class="description">
<span 
class="aeb10-">1</span> </dt><dd 
class="description">txq (driver-to-device vhost-user protocol messages)</dd></dl>
<a 
 id="x1-666001r672"></a>
<h4 class="subsectionHead"><span class="titlemark">5.20.3   </span> <a 
 id="x1-6670003"></a>Feature bits</h4>
<!--l. 42--><p class="nopar" >No feature bits are defined at this time.
<a 
 id="x1-667001r673"></a>
<h4 class="subsectionHead"><span class="titlemark">5.20.4   </span> <a 
 id="x1-6680004"></a>Device configuration layout</h4>
<!--l. 46--><p class="nopar" >All fields of this configuration are always available.
<!--l. 48-->
<div class="lstlisting" id="listing-225"><span class="label"><a 
 id="x1-668001r1"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio_vhost_user_config</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-668002r2"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">status</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-668003r3"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VHOST_USER_STATUS_BACKEND_UP</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">0)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-668004r4"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_VHOST_USER_STATUS_FRONTEND_UP</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(1</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-668005r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">max_vhost_queues</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-668006r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">u8</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">uuid</span><span 
class="pcrr8t-x-x-80">[16];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-668007r7"></a></span><span 
class="pcrr8t-x-x-80">};</span>
</div>
    <dl class="description"><dt class="description">
<span 
class="aebxti-10">status</span> </dt><dd 
class="description">contains the vhost-user operational status. The default value of this field
    is 0.
    <!--l. 62--><p class="noindent" >The  driver  sets  VIRTIO_VHOST_USER_STATUS_BACKEND_UP  to
    indicate readiness for the vhost-user frontend to connect. The vhost-user
    frontend cannot connect unless the driver has set this bit first.
    <!--l. 66--><p class="noindent" >The  device  sets  VIRTIO_VHOST_USER_STATUS_FRONTEND_UP  to
    indicate that the vhost-user frontend is connected.
    <!--l. 69--><p class="noindent" >When the driver clears VIRTIO_VHOST_USER_STATUS_BACKEND_UP
    while  the  vhost-user  frontend  is  connected,  the  vhost-user  frontend  is
    disconnected.
    <!--l. 72--><p class="noindent" >When                    the                    vhost-user                    frontend
    disconnects, both VIRTIO_VHOST_USER_STATUS_BACKEND_UP and
    VIRTIO_VHOST_USER_STATUS_FRONTEND_UP  are  cleared  by  the
    device.   Communication   can   be   restarted   by   the   driver   setting
    VIRTIO_VHOST_USER_STATUS_BACKEND_UP again.
    <!--l. 77--><p class="noindent" >A configuration change notification is sent when the device changes this
    field, unless a write to the field by the driver caused the change.
    </dd><dt class="description">
<span 
class="aebxti-10">max_vhost_queues</span> </dt><dd 
class="description">is the maximum number of vhost-user queues supported
    by this device. This field is always greater than 0.
                                                                  

                                                                  
    </dd><dt class="description">
<span 
class="aebxti-10">uuid</span> </dt><dd 
class="description">is the Universally Unique Identifier (UUID) for this device. If the device
    has no UUID then this field contains the nil UUID (all zeroes). The UUID
    allows vhost-user backend programs to identify a specific vhost-user device
    backend among many without relying on bus addresses.</dd></dl>
<a 
 id="x1-668008r669"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.20.4.1   </span> <a 
 id="x1-6690001"></a>Driver Requirements: Device configuration layout</h5>
<!--l. 92--><p class="nopar" >The driver MUST NOT write to device configuration fields other than <span 
class="aeti-10">status</span>.
<!--l. 94--><p class="noindent" >The driver MUST NOT set undefined bits in the <span 
class="aeti-10">status </span>configuration field.
<a 
 id="x1-669001r674"></a>
<h4 class="subsectionHead"><span class="titlemark">5.20.5   </span> <a 
 id="x1-6700005"></a>Device Initialization</h4>
<!--l. 98--><p class="nopar" >The driver initializes the rxq/txq virtqueues and then it sets
VIRTIO_VHOST_USER_STATUS_BACKEND_UP to the <span 
class="aeti-10">status </span>field of the device
configuration structure.
<a 
 id="x1-670001r675"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.20.5.1   </span> <a 
 id="x1-6710001"></a>Driver Requirements: Device Initialization</h5>
<!--l. 104--><p class="nopar" >The driver SHOULD check the <span 
class="aeti-10">max_vhost_queues </span>configuration field to determine
how many queues the vhost-user backend will be able to support.
<!--l. 107--><p class="noindent" >The driver SHOULD fetch the <span 
class="aeti-10">uuid </span>configuration field to allow vhost-user backend
programs to identify a specific device among many.
<!--l. 110--><p class="noindent" >The driver SHOULD place at least one buffer in rxq before setting the
VIRTIO_VHOST_USER_STATUS_BACKEND_UP bit in the <span 
class="aeti-10">status </span>configuration
field.
<!--l. 113--><p class="noindent" >The driver MUST handle rxq virtqueue notifications that occur before the
configuration change notification. It is possible that a vhost-user protocol message
from the vhost-user frontend arrives before the driver has seen the configuration
change notification for the VIRTIO_VHOST_USER_STATUS_FRONTEND_UP
<span 
class="aeti-10">status </span>change.
<a 
 id="x1-671001r676"></a>
<h4 class="subsectionHead"><span class="titlemark">5.20.6   </span> <a 
 id="x1-6720006"></a>Device Operation</h4>
<!--l. 121--><p class="nopar" >Device operation consists of operating request queues and response queues.
<a 
 id="x1-672001r677"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.20.6.1   </span> <a 
 id="x1-6730001"></a>Device Operation: Request Queues</h5>
<!--l. 125--><p class="nopar" >The driver receives vhost-user protocol messages from the vhost-user frontend on rxq.
The driver sends responses to the vhost-user frontend on txq.
<!--l. 128--><p class="noindent" >The driver sends backend-initiated requests on txq. The driver receives responses
from the vhost-user frontend on rxq.
                                                                  

                                                                  
<!--l. 131--><p class="noindent" >All virtqueues offer in-order guaranteed delivery semantics for vhost-user protocol
messages.
<!--l. 134--><p class="noindent" >Each buffer is a vhost-user protocol message as defined by the <a 
href="#x1-3001r1">Vhost-user Protocol</a>.
In order to enable cross-endian communication, all message fields are little-endian
instead of the native byte order normally used by the protocol.
<!--l. 139--><p class="noindent" >The appropriate size of rxq buffers is at least as large as the largest message defined
by the <a 
href="#x1-3001r1">Vhost-user Protocol</a> standard version that the driver supports. If the
vhost-user frontend sends a message that is too large for an rxq buffer, then
DEVICE_NEEDS_RESET is set and the driver must reset the device.
<!--l. 145--><p class="noindent" >File descriptor passing is handled differently by the vhost-user device backend. When
a frontend-initiated message is received that carries one or more file descriptors
according to the vhost-user protocol, additional device resources become available to
the driver.
<a 
 id="x1-673001r678"></a>
<h4 class="subsectionHead"><span class="titlemark">5.20.7   </span> <a 
 id="x1-6740007"></a>Additional Device Resources</h4>
<!--l. 152--><p class="nopar" >The vhost-user device backend uses the following facilities from virtio device <a 
href="#x1-100002">2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device --></a> for the
vhost-user frontend and backend to exchange notifications and data through the
device:
    <dl class="description"><dt class="description">
<span 
class="aeb10-">Device auxiliary notification</span> </dt><dd 
class="description"><a 
href="#x1-180003">2.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Notifications --></a>  The  driver  signals  the  vhost-user  frontend
    through device auxiliary notifications. The signal does not carry any data,
    it is purely an event.
    </dd><dt class="description">
<span 
class="aeb10-">Driver auxiliary notification</span> </dt><dd 
class="description"><a 
href="#x1-180003">2.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Notifications --></a> The vhost-user frontend signals the driver for
    events  besides  virtqueue  activity  and  configuration  changes  by  sending
    driver auxiliary notification.
    </dd><dt class="description">
<span 
class="aeb10-">Shared memory</span> </dt><dd 
class="description"><a 
href="#x1-10200010">2.10<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Shared Memory Regions --></a> The vhost-user frontend gives access to memory that can
    be mapped by the driver.</dd></dl>
<a 
 id="x1-674001r679"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.20.7.1   </span> <a 
 id="x1-6750001"></a>Device auxiliary notifications</h5>
<!--l. 169--><p class="nopar" >The vhost-user device backend provides all (or part) of the following device auxiliary
notifications:
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">Vring call for vhost-user queue 0
    </dd><dt class="description">
<span 
class="aeb10-">…</span> </dt><dd 
class="description">
    </dd><dt class="description">
<span 
class="aeb10-">N-1</span> </dt><dd 
class="description">Vring call for vhost-user queue N-1
                                                                  

                                                                  
    </dd><dt class="description">
<span 
class="aeb10-">N</span> </dt><dd 
class="description">Vring err for vhost-user queue 0
    </dd><dt class="description">
<span 
class="aeb10-">…</span> </dt><dd 
class="description">
    </dd><dt class="description">
<span 
class="aeb10-">2N-1</span> </dt><dd 
class="description">Vring err for vhost-user queue N-1
    </dd><dt class="description">
<span 
class="aeb10-">2N</span> </dt><dd 
class="description">Log</dd></dl>
<!--l. 182--><p class="noindent" >where N is the number of the vhost-user virtqueues.
<a 
 id="x1-675001r681"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.20.7.2   </span> <a 
 id="x1-6760002"></a>Driver auxiliary notifications</h5>
<!--l. 186--><p class="nopar" >The vhost-user device backend provides all (or part) of the following driver auxiliary
notifications:
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">Vring kick for vhost-user queue 0
    </dd><dt class="description">
<span 
class="aeb10-">…</span> </dt><dd 
class="description">
    </dd><dt class="description">
<span 
class="aeb10-">N-1</span> </dt><dd 
class="description">Vring kick for vhost-user queue N-1</dd></dl>
<!--l. 195--><p class="noindent" >where N is the number of the vhost-user virtqueues.
<a 
 id="x1-676001r682"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.20.7.3   </span> <a 
 id="x1-6770003"></a>Shared Memory</h5>
<!--l. 199--><p class="nopar" >When the VHOST_USER_PROTOCOL_F_CONFIGURE_MEM_SLOTS protocol
feature is not present, the vhost-user device backend provides the following
vhost-user memory regions as a single shared memory:
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">Vhost-user memory region 0
    </dd><dt class="description">
<span 
class="aeb10-">1</span> </dt><dd 
class="description">Vhost-user memory region 1
    </dd><dt class="description">
<span 
class="aeb10-">…</span> </dt><dd 
class="description">
    </dd><dt class="description">
<span 
class="aeb10-">M-1</span> </dt><dd 
class="description">Vhost-user memory region M-1
    </dd><dt class="description">
<span 
class="aeb10-">M</span> </dt><dd 
class="description">Log memory region</dd></dl>
<!--l. 211--><p class="noindent" >where M is the total number of vhost-user memory regions that can be mapped by
                                                                  

                                                                  
the driver using the VHOST_USER_SET_MEM_TABLE protocol message plus the
log memory region.
<!--l. 215--><p class="noindent" >When the VHOST_USER_PROTOCOL_F_CONFIGURE_MEM_SLOTS protocol
feature has been negotiated, the vhost-user device backend still provides
all the vhost-user memory regions as a single shared memory, however the
number of vhost-user memory regions exported in the single shared memory is
dynamic, i.e. VHOST_USER_ADD_MEM_REG message adds a vhost-user
memory regions to the shared memory that can be mapped by the driver and
VHOST_USER_REM_MEM_REG removes the region from the shared memory.
One possible method the shared memory could be managed with is memory
compaction. In this method, the device would remove the vhost-user memory region
from the shared memory when VHOST_USER_REM_MEM_REG is received
for the specific vhost-user memory region. The device would run memory
compaction on the shared memory to remove any fragmentation caused by
previously received VHOST_USER_REM_MEM_REG protocol messages when
VHOST_USER_ADD_MEM_REG protocol message is received before adding the new
vhost-user memory region to the shared memory. The driver would then
make the corresponding shifts in the mmap addresses of the shifted memory
regions.
<a 
 id="x1-677001r630"></a>
<h5 class="paragraphHead"><span class="titlemark">5.20.7.3.1</span> <a 
 id="x1-6780001"></a>Device Requirements: Shared Memory layout</h5>
The device exports all memory regions reported by the vhost-user frontend as a
single shared memory region <a 
href="#x1-10200010">2.10<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Shared Memory Regions --></a>.
<!--l. 238--><p class="noindent" >The size of this shared memory region exported by the device MUST be at least as
much as the sum of the sizes of all the memory regions reported by the vhost-user
frontend.
<!--l. 242--><p class="noindent" >When the VHOST_USER_PROTOCOL_F_CONFIGURE_MEM_SLOTS protocol
feature is not present, the memory regions exported by the device MUST be laid out
contiguously in the same order in which they are reported by the frontend with
vhost-user messages. The offsets in which the memory regions are mapped inside the
shared memory region MUST be the following:
    <dl class="description"><dt class="description">
<span 
class="aeb10-">0</span> </dt><dd 
class="description">Offset for vhost-user memory region 0
    </dd><dt class="description">
<span 
class="aeb10-">SIZE0</span> </dt><dd 
class="description">Offset for vhost-user memory region 1
    </dd><dt class="description">
<span 
class="aeb10-">…</span> </dt><dd 
class="description">
    </dd><dt class="description">
<span 
class="aeb10-">SIZE0 + SIZE1 + </span><span 
class="aeb10-">…</span> </dt><dd 
class="description">Offset for vhost-user memory region M</dd></dl>
<!--l. 256--><p class="noindent" >where SIZEi is the size of the vhost-user memory region i.
                                                                  

                                                                  
<!--l. 258--><p class="noindent" >When the VHOST_USER_PROTOCOL_F_CONFIGURE_MEM_SLOTS protocol
feature has been negotiated, the memory regions exported by the device might not be
contiguously laid out.
<a 
 id="x1-678001r683"></a>
<h5 class="subsubsectionHead"><span class="titlemark">5.20.7.4   </span> <a 
 id="x1-6790004"></a>Availability of Additional Resources</h5>
<!--l. 264--><p class="nopar" >The following vhost-user protocol messages convey access to additional device
resources:
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VHOST_USER_SET_MEM_TABLE</span> </dt><dd 
class="description">Contents of vhost-user memory regions are
    made available to the driver in the Shared Memory Region. Region contents
    are laid out in the same order as the vhost-user memory region list.
    </dd><dt class="description">
<span 
class="aeb10-">VHOST_USER_ADD_MEM_REG</span> </dt><dd 
class="description">Contents of the vhost-user memory region
    are made available to the driver in the Shared Memory Region.
    </dd><dt class="description">
<span 
class="aeb10-">VHOST_USER_REM_MEM_REG</span> </dt><dd 
class="description">Contents of the vhost-user memory region
    are no longer available to the driver in the Shared Memory Region.
    </dd><dt class="description">
<span 
class="aeb10-">VHOST_USER_SET_LOG_BASE</span> </dt><dd 
class="description">Contents  of  the  log  memory  region  are
    available to the driver in the Shared Memory Region.
    </dd><dt class="description">
<span 
class="aeb10-">VHOST_USER_SET_LOG_FD</span> </dt><dd 
class="description">The  log  doorbell  is  available  to  the  driver.
    Writes to the log doorbell before this message is received produce no effect.
    </dd><dt class="description">
<span 
class="aeb10-">VHOST_USER_SET_VRING_KICK</span> </dt><dd 
class="description">The vring kick notification for this queue
    is available to the driver. The first notification may occur before the driver
    has  processed  this  message.  If  a  kick  arrives  before  the  corresponding
    VHOST_USER_SET_VRING_KICK  message  has  been  processed,  the
    vhost-user backend should ignore the unknown kick and peek at the vring
    when VHOST_USER_SET_VRING_ENABLE is processed.
    </dd><dt class="description">
<span 
class="aeb10-">VHOST_USER_SET_VRING_CALL</span> </dt><dd 
class="description">The vring call device auxiliary notification
    for this queue is available to the driver. Writes to the vring call device
    auxiliary notification before this message is received produce no effect.
    </dd><dt class="description">
<span 
class="aeb10-">VHOST_USER_SET_VRING_ERR</span> </dt><dd 
class="description">The vring err device auxiliary notification
    for this queue is available to the driver. Writes to the vring err device
    auxiliary notification before this message is received produce no effect.
    </dd><dt class="description">
<span 
class="aeb10-">VHOST_USER_SET_SLAVE_REQ_FD</span> </dt><dd 
class="description">The         driver         may         send
                                                                  

                                                                  
    vhost-user protocol backend messages on txq. Backend-initiated messages
    put onto txq before this message is received are discarded by the device.</dd></dl>
                                                                  

                                                                  
<!--l. 6938--><p class="nopar" ><h2 class="chapterHead"><hr><span class="titlemark">6</span> <a 
 id="x1-6800006"></a>Reserved Feature Bits</h2>
Currently these device-independent feature bits are defined:
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_F_INDIRECT_DESC (28)</span> </dt><dd 
class="description">Negotiating this feature indicates that the
    driver  can  use  descriptors  with  the  VIRTQ_DESC_F_INDIRECT  flag
    set, as described in <a 
href="#x1-460003">2.7.5.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table / Indirect Descriptors --></a> <a 
href="#x1-460003">Indirect Descriptors<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table / Indirect Descriptors --></a> and <a 
href="#x1-790007">2.8.7<!--tex4ht:ref: sec:Packed Virtqueues / Indirect Flag: Scatter-Gather Support --></a> <a 
href="#x1-790007">Indirect Flag:
    Scatter-Gather Support<!--tex4ht:ref: sec:Packed Virtqueues / Indirect Flag: Scatter-Gather Support --></a>.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_F_EVENT_IDX(29)</span> </dt><dd 
class="description">This  feature  enables  the  <span 
class="aeti-10">used_event  </span>and  the
    <span 
class="aeti-10">avail_event </span>fields as described in <a 
href="#x1-510007">2.7.7<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Used Buffer Notification Suppression --></a>, <a 
href="#x1-540008">2.7.8<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Used Ring --></a> and <a 
href="#x1-8200010">2.8.10<!--tex4ht:ref: sec:Packed Virtqueues / Driver and Device Event Suppression --></a>.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_F_VERSION_1(32)</span> </dt><dd 
class="description">This indicates compliance with this specification,
    giving a simple way to detect legacy devices or drivers.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_F_ACCESS_PLATFORM(33)</span> </dt><dd 
class="description">This feature indicates that the device
    can  be  used  on  a  platform  where  device  access  to  data  in  memory  is
    limited and/or translated. E.g. this is the case if the device can be located
    behind  an  IOMMU  that  translates  bus  addresses  from  the  device  into
    physical addresses in memory, if the device can be limited to only access
    certain memory addresses or if special commands such as a cache flush
    can be needed to synchronise data in memory with the device. Whether
    accesses are actually limited or translated is described by platform-specific
    means. If this feature bit is set to 0, then the device has same access to
    memory addresses supplied to it as the driver has. In particular, the device
    will always use physical addresses matching addresses used by the driver
    (typically meaning physical addresses used by the CPU) and not translated
    further, and can access any address supplied to it by the driver. When clear,
    this overrides any platform-specific description of whether device access is
    limited or translated in any way, e.g. whether an IOMMU may be present.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_F_RING_PACKED(34)</span> </dt><dd 
class="description">This feature indicates support for the packed
    virtqueue layout as described in <a 
href="#x1-720008">2.8<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Packed Virtqueues --></a> <a 
href="#x1-720008">Packed Virtqueues<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Packed Virtqueues --></a>.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_F_IN_ORDER(35)</span> </dt><dd 
class="description">This feature indicates that all buffers are used by
    the device in the same order in which they have been made available.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_F_ORDER_PLATFORM(36)</span> </dt><dd 
class="description">This  feature  indicates  that  memory
    accesses by the driver and the device are ordered in a way described by the
    platform.
    <!--l. 6987--><p class="noindent" >If this feature bit is negotiated, the ordering in effect for any memory
    accesses by the driver that need to be ordered in a specific way with respect
                                                                  

                                                                  
    to accesses by the device is the one suitable for devices described by the
    platform. This implies that the driver needs to use memory barriers suitable
    for devices described by the platform; e.g. for the PCI transport in the case
    of hardware PCI devices.
    <!--l. 6994--><p class="noindent" >If this feature bit is not negotiated, then the device and driver are assumed
    to be implemented in software, that is they can be assumed to run on
    identical CPUs in an SMP configuration. Thus a weaker form of memory
    barriers is sufficient to yield better performance.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_F_SR_IOV(37)</span> </dt><dd 
class="description">This feature indicates that the device supports Single
    Root I/O Virtualization. Currently only PCI devices support this feature.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_F_NOTIFICATION_DATA(38)</span> </dt><dd 
class="description">This feature indicates that the driver
    passes  extra  data  (besides  identifying  the  virtqueue)  in  its  device
    notifications. See <a 
href="#x1-1010009">2.9<!--tex4ht:ref: sec:Virtqueues / Driver notifications --></a> <a 
href="#x1-1010009">Driver Notifications<!--tex4ht:ref: sec:Virtqueues / Driver notifications --></a>.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_F_NOTIF_CONFIG_DATA(39)</span> </dt><dd 
class="description">This feature indicates that the driver
    uses the data provided by the device as a virtqueue identifier in available
    buffer notifications. As mentioned in section <a 
href="#x1-1010009">2.9<!--tex4ht:ref: sec:Virtqueues / Driver notifications --></a>, when the driver is required
    to send an available buffer notification to the device, it sends the virtqueue
    number to be notified. The method of delivering notifications is transport
    specific.  With  the  PCI  transport,  the  device  can  optionally  provide  a
    per-virtqueue value for the driver to use in driver notifications, instead of
    the virtqueue number. Some devices may benefit from this flexibility by
    providing, for example, an internal virtqueue identifier, or an internal offset
    related to the virtqueue number.
    <!--l. 7021--><p class="noindent" >This feature indicates the availability of such value. The definition of the
    data  to  be  provided  in  driver  notification  and  the  delivery  method  is
    transport specific. For more details about driver notifications over PCI see
    <a 
href="#x1-1610002">4.1.5.2<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Available Buffer Notifications --></a>.
    </dd><dt class="description">
<span 
class="aeb10-">VIRTIO_F_RING_RESET(40)</span> </dt><dd 
class="description">This feature indicates that the driver can reset
    a queue individually. See <a 
href="#x1-280001">2.6.1<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Virtqueue Reset --></a>.
    </dd></dl>
<a 
 id="x1-680001r670"></a>
<h3 class="sectionHead"><span class="titlemark">6.1   </span> <a 
 id="x1-6810001"></a>Driver Requirements: Reserved Feature Bits</h3>
<!--l. 7034--><p class="nopar" >A driver MUST accept VIRTIO_F_VERSION_1 if it is offered. A driver MAY fail to
operate further if VIRTIO_F_VERSION_1 is not offered.
<!--l. 7037--><p class="noindent" >A driver SHOULD accept VIRTIO_F_ACCESS_PLATFORM if it is offered, and it
MUST then either disable the IOMMU or configure the IOMMU to translate
                                                                  

                                                                  
bus addresses passed to the device into physical addresses in memory. If
VIRTIO_F_ACCESS_PLATFORM is not offered, then a driver MUST pass only
physical addresses to the device.
<!--l. 7043--><p class="noindent" >A driver SHOULD accept VIRTIO_F_RING_PACKED if it is offered.
<!--l. 7045--><p class="noindent" >A driver SHOULD accept VIRTIO_F_ORDER_PLATFORM if it is offered. If
VIRTIO_F_ORDER_PLATFORM has been negotiated, a driver MUST use the
barriers suitable for hardware devices.
<!--l. 7049--><p class="noindent" >If VIRTIO_F_SR_IOV has been negotiated, a driver MAY enable virtual
functions through the device’s PCI SR-IOV capability structure. A driver
MUST NOT negotiate VIRTIO_F_SR_IOV if the device does not have a PCI
SR-IOV capability structure or is not a PCI device. A driver MUST negotiate
VIRTIO_F_SR_IOV and complete the feature negotiation (including checking the
FEATURES_OK <span 
class="aeti-10">device status </span>bit) before enabling virtual functions through the
device’s PCI SR-IOV capability structure. After once successfully negotiating
VIRTIO_F_SR_IOV, the driver MAY enable virtual functions through the device’s
PCI SR-IOV capability structure even if the device or the system has been fully or
partially reset, and even without re-negotiating VIRTIO_F_SR_IOV after the
reset.
<!--l. 7064--><p class="noindent" >A driver SHOULD accept VIRTIO_F_NOTIF_CONFIG_DATA if it is offered.
<a 
 id="x1-681001r687"></a>
<h3 class="sectionHead"><span class="titlemark">6.2   </span> <a 
 id="x1-6820002"></a>Device Requirements: Reserved Feature Bits</h3>
<!--l. 7068--><p class="nopar" >A device MUST offer VIRTIO_F_VERSION_1. A device MAY fail to operate further
if VIRTIO_F_VERSION_1 is not accepted.
<!--l. 7071--><p class="noindent" >A device SHOULD offer VIRTIO_F_ACCESS_PLATFORM if its access to memory is
through bus addresses distinct from and translated by the platform to physical
addresses used by the driver, and/or if it can only access certain memory
addresses with said access specified and/or granted by the platform. A device
MAY fail to operate further if VIRTIO_F_ACCESS_PLATFORM is not
accepted.
<!--l. 7079--><p class="noindent" >If VIRTIO_F_IN_ORDER has been negotiated, a device MUST use buffers in the
same order in which they have been available.
<!--l. 7082--><p class="noindent" >A device MAY fail to operate further if VIRTIO_F_ORDER_PLATFORM is offered
but not accepted. A device MAY operate in a slower emulation mode if
VIRTIO_F_ORDER_PLATFORM is offered but not accepted.
<!--l. 7087--><p class="noindent" >It is RECOMMENDED that an add-in card based PCI device offers both
VIRTIO_F_ACCESS_PLATFORM and VIRTIO_F_ORDER_PLATFORM for
maximum portability.
<!--l. 7091--><p class="noindent" >A device SHOULD offer VIRTIO_F_SR_IOV if it is a PCI device and presents a PCI
SR-IOV capability structure, otherwise it MUST NOT offer VIRTIO_F_SR_IOV.
<a 
 id="x1-682001r688"></a>
                                                                  

                                                                  
<h3 class="sectionHead"><span class="titlemark">6.3   </span> <a 
 id="x1-6830003"></a>Legacy Interface: Reserved Feature Bits</h3>
<!--l. 7097--><p class="nopar" >Transitional devices MAY offer the following:
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_F_NOTIFY_ON_EMPTY (24)</span> </dt><dd 
class="description">If this feature has been negotiated by driver,
    the device MUST issue a used buffer notification if the device runs out of
    available descriptors on a virtqueue, even though notifications are suppressed
    using the VIRTQ_AVAIL_F_NO_INTERRUPT flag or the <span 
class="aeti-10">used_event</span>
    field.
    <span 
class="aeb10-">Note:</span> An example of a driver using this feature is the legacy networking
          driver: it doesn’t need to know every time a packet is transmitted,
          but it does need to free the transmitted packets a finite time after
          they are transmitted. It can avoid using a timer if the device notifies
          it when all the packets are transmitted.
    </dd></dl>
<!--l. 7115--><p class="noindent" >Transitional devices MUST offer, and if offered by the device transitional drivers
MUST accept the following:
    <dl class="description"><dt class="description">
<span 
class="aeb10-">VIRTIO_F_ANY_LAYOUT (27)</span> </dt><dd 
class="description">This feature indicates that the device accepts
    arbitrary  descriptor  layouts,  as  described  in  Section  <a 
href="#x1-420003">2.7.4.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Message Framing / Legacy Interface: Message Framing --></a> <a 
href="#x1-420003">Legacy
    Interface: Message Framing<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Message Framing / Legacy Interface: Message Framing --></a>.
    </dd><dt class="description">
<span 
class="aeb10-">UNUSED (30)</span> </dt><dd 
class="description">Bit  30  is  used  by  qemu’s  implementation  to  check  for
    experimental early versions of virtio which did not perform correct feature
    negotiation, and SHOULD NOT be negotiated.</dd></dl>
                                                                  

                                                                  
<!--l. 4--><p class="nopar" ><h2 class="chapterHead"><hr><span class="titlemark">7</span> <a 
 id="x1-6840007"></a>Conformance</h2>
This chapter lists the conformance targets and clauses for each; this also forms a
useful checklist which authors are asked to consult for their implementations!
<a 
 id="x1-684001r689"></a>
<h3 class="sectionHead"><span class="titlemark">7.1   </span> <a 
 id="x1-6850001"></a>Conformance Targets</h3>
<!--l. 12--><p class="nopar" >Conformance targets:
    <dl class="description"><dt class="description">
<span 
class="aeb10-">Driver</span> </dt><dd 
class="description">A driver MUST conform to four conformance clauses:
        <ul class="itemize1">
        <li class="itemize">Clause <a 
href="#x1-6860002">7.2<!--tex4ht:ref: sec:Conformance / Driver Conformance --></a>.
        </li>
        <li class="itemize">One of clauses <a 
href="#x1-6870001">7.2.1<!--tex4ht:ref: sec:Conformance / Driver Conformance / PCI Driver Conformance --></a>, <a 
href="#x1-6880002">7.2.2<!--tex4ht:ref: sec:Conformance / Driver Conformance / MMIO Driver Conformance --></a> or <a 
href="#x1-6890003">7.2.3<!--tex4ht:ref: sec:Conformance / Driver Conformance / Channel I/O Driver Conformance --></a>.
        </li>
        <li class="itemize">One  of  clauses  <a 
href="#x1-6900004">7.2.4<!--tex4ht:ref: sec:Conformance / Driver Conformance / Network Driver Conformance --></a>,  <a 
href="#x1-6910005">7.2.5<!--tex4ht:ref: sec:Conformance / Driver Conformance / Block Driver Conformance --></a>,  <a 
href="#x1-6920006">7.2.6<!--tex4ht:ref: sec:Conformance / Driver Conformance / Console Driver Conformance --></a>,  <a 
href="#x1-6930007">7.2.7<!--tex4ht:ref: sec:Conformance / Driver Conformance / Entropy Driver Conformance --></a>,  <a 
href="#x1-6940008">7.2.8<!--tex4ht:ref: sec:Conformance / Driver Conformance / Traditional Memory Balloon Driver Conformance --></a>,  <a 
href="#x1-6950009">7.2.9<!--tex4ht:ref: sec:Conformance / Driver Conformance / SCSI Host Driver Conformance --></a>,  <a 
href="#x1-69600010">7.2.10<!--tex4ht:ref: sec:Conformance / Driver Conformance / Input Driver Conformance --></a>,  <a 
href="#x1-69700011">7.2.11<!--tex4ht:ref: sec:Conformance / Driver Conformance / Crypto Driver Conformance --></a>,
        <a 
href="#x1-69800012">7.2.12<!--tex4ht:ref: sec:Conformance / Driver Conformance / Socket Driver Conformance --></a>, <a 
href="#x1-69900013">7.2.13<!--tex4ht:ref: sec:Conformance / Driver Conformance / File System Driver Conformance --></a>, <a 
href="#x1-70000014">7.2.14<!--tex4ht:ref: sec:Conformance / Driver Conformance / RPMB Driver Conformance --></a>, <a 
href="#x1-70100015">7.2.15<!--tex4ht:ref: sec:Conformance / Driver Conformance / IOMMU Driver Conformance --></a>, <a 
href="#x1-70200016">7.2.16<!--tex4ht:ref: sec:Conformance / Driver Conformance / Sound Driver Conformance --></a>, <a 
href="#x1-70300017">7.2.17<!--tex4ht:ref: sec:Conformance / Driver Conformance / Memory Driver Conformance --></a>, <a 
href="#x1-70400018">7.2.18<!--tex4ht:ref: sec:Conformance / Driver Conformance / I2C Adapter Driver Conformance --></a>, <a 
href="#x1-70500019">7.2.19<!--tex4ht:ref: sec:Conformance / Driver Conformance / SCMI Driver Conformance --></a>, <a 
href="#x1-70600020">7.2.20<!--tex4ht:ref: sec:Conformance / Driver Conformance / GPIO Driver Conformance --></a>, <a 
href="#x1-70700021">7.2.21<!--tex4ht:ref: sec:Conformance / Driver Conformance / PMEM Driver Conformance --></a>
        or <a 
href="#x1-70800022">7.2.22<!--tex4ht:ref: sec:Conformance / Driver Conformance / Vhost-user Backend Driver Conformance --></a>.
        </li>
        <li class="itemize">Clause <a 
href="#x1-7320004">7.4<!--tex4ht:ref: sec:Conformance / Legacy Interface: Transitional Device and Transitional Driver Conformance --></a>.</li></ul>
    </dd><dt class="description">
<span 
class="aeb10-">Device</span> </dt><dd 
class="description">A device MUST conform to four conformance clauses:
        <ul class="itemize1">
        <li class="itemize">Clause <a 
href="#x1-7090003">7.3<!--tex4ht:ref: sec:Conformance / Device Conformance --></a>.
        </li>
        <li class="itemize">One of clauses <a 
href="#x1-7100001">7.3.1<!--tex4ht:ref: sec:Conformance / Device Conformance / PCI Device Conformance --></a>, <a 
href="#x1-7110002">7.3.2<!--tex4ht:ref: sec:Conformance / Device Conformance / MMIO Device Conformance --></a> or <a 
href="#x1-7120003">7.3.3<!--tex4ht:ref: sec:Conformance / Device Conformance / Channel I/O Device Conformance --></a>.
        </li>
        <li class="itemize">One  of  clauses  <a 
href="#x1-7130004">7.3.4<!--tex4ht:ref: sec:Conformance / Device Conformance / Network Device Conformance --></a>,  <a 
href="#x1-7140005">7.3.5<!--tex4ht:ref: sec:Conformance / Device Conformance / Block Device Conformance --></a>,  <a 
href="#x1-7150006">7.3.6<!--tex4ht:ref: sec:Conformance / Device Conformance / Console Device Conformance --></a>,  <a 
href="#x1-7160007">7.3.7<!--tex4ht:ref: sec:Conformance / Device Conformance / Entropy Device Conformance --></a>,  <a 
href="#x1-7170008">7.3.8<!--tex4ht:ref: sec:Conformance / Device Conformance / Traditional Memory Balloon Device Conformance --></a>,  <a 
href="#x1-7180009">7.3.9<!--tex4ht:ref: sec:Conformance / Device Conformance / SCSI Host Device Conformance --></a>,  <a 
href="#x1-71900010">7.3.10<!--tex4ht:ref: sec:Conformance / Device Conformance / Input Device Conformance --></a>,  <a 
href="#x1-72000011">7.3.11<!--tex4ht:ref: sec:Conformance / Device Conformance / Crypto Device Conformance --></a>,
        <a 
href="#x1-72100012">7.3.12<!--tex4ht:ref: sec:Conformance / Device Conformance / Socket Device Conformance --></a>, <a 
href="#x1-72200013">7.3.13<!--tex4ht:ref: sec:Conformance / Device Conformance / File System Device Conformance --></a>, <a 
href="#x1-72300014">7.3.14<!--tex4ht:ref: sec:Conformance / Device Conformance / RPMB Device Conformance --></a>, <a 
href="#x1-72400015">7.3.15<!--tex4ht:ref: sec:Conformance / Device Conformance / IOMMU Device Conformance --></a>, <a 
href="#x1-72500016">7.3.16<!--tex4ht:ref: sec:Conformance / Device Conformance / Sound Device Conformance --></a>, <a 
href="#x1-72600017">7.3.17<!--tex4ht:ref: sec:Conformance / Device Conformance / Memory Device Conformance --></a>, <a 
href="#x1-72700018">7.3.18<!--tex4ht:ref: sec:Conformance / Device Conformance / I2C Adapter Device Conformance --></a>, <a 
href="#x1-72800019">7.3.19<!--tex4ht:ref: sec:Conformance / Device Conformance / SCMI Device Conformance --></a>, <a 
href="#x1-72900020">7.3.20<!--tex4ht:ref: sec:Conformance / Device Conformance / GPIO Device Conformance --></a>, <a 
href="#x1-73000021">7.3.21<!--tex4ht:ref: sec:Conformance / Device Conformance / PMEM Device Conformance --></a>
        or <a 
href="#x1-73100022">7.3.22<!--tex4ht:ref: sec:Conformance / Device Conformance / Vhost-user Backend Device Conformance --></a>.
        </li>
        <li class="itemize">Clause <a 
href="#x1-7320004">7.4<!--tex4ht:ref: sec:Conformance / Legacy Interface: Transitional Device and Transitional Driver Conformance --></a>.</li></ul>
    </dd></dl>
<a 
 id="x1-685001r691"></a>
<h3 class="sectionHead"><span class="titlemark">7.2   </span> <a 
 id="x1-6860002"></a>Clause 1: Driver Conformance</h3>
<!--l. 72--><p class="nopar" >A driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-120001">2.1.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Device Status Field --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize"><a 
href="#x1-150001">2.2.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Feature Bits --></a>
    </li>
    <li class="itemize"><a 
href="#x1-210002">2.4.2<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Device Reset --></a>
    </li>
    <li class="itemize"><a 
href="#x1-230001">2.5.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Device Configuration Space --></a>
    </li>
    <li class="itemize"><a 
href="#x1-360001">2.7.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues --></a>
    </li>
    <li class="itemize"><a 
href="#x1-410002">2.7.4.2<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Message Framing --></a>
    </li>
    <li class="itemize"><a 
href="#x1-450002">2.7.5.2<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table --></a>
    </li>
    <li class="itemize"><a 
href="#x1-470001">2.7.5.3.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table / Indirect Descriptors --></a>
    </li>
    <li class="itemize"><a 
href="#x1-520001">2.7.7.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues / Used Buffer Notification Suppression --></a>
    </li>
    <li class="itemize"><a 
href="#x1-500001">2.7.6.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Available Ring --></a>
    </li>
    <li class="itemize"><a 
href="#x1-570003">2.7.8.3<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Used Ring --></a>
    </li>
    <li class="itemize"><a 
href="#x1-600001">2.7.10.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues / Available Buffer Notification Suppression --></a>
    </li>
    <li class="itemize"><a 
href="#x1-680001">2.7.13.3.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues / Supplying Buffers to The Device / Updating idx --></a>
    </li>
    <li class="itemize"><a 
href="#x1-700001">2.7.13.4.1<!--tex4ht:ref: drivernormative:Basic Facilities of a Virtio Device / Virtqueues / Supplying Buffers to The Device / Notifying The Device --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1080001">3.1.1<!--tex4ht:ref: drivernormative:General Initialization And Device Operation / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1130001">3.3.1<!--tex4ht:ref: drivernormative:General Initialization And Device Operation / Device Cleanup --></a>
    </li>
    <li class="itemize"><a 
href="#x1-6810001">6.1<!--tex4ht:ref: drivernormative:Reserved Feature Bits --></a></li></ul>
<a 
 id="x1-686001r680"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.1   </span> <a 
 id="x1-6870001"></a>Clause 2: PCI Driver Conformance</h4>
<!--l. 96--><p class="nopar" >A PCI driver MUST conform to the following normative statements:
    <ul class="itemize1">
                                                                  

                                                                  
    <li class="itemize"><a 
href="#x1-1190002">4.1.2.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Discovery --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1220001">4.1.3.1<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1250001">4.1.4.1<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / Virtio Structure PCI Capabilities --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1290002">4.1.4.3.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Common configuration structure layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1340002">4.1.4.5.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / ISR status capability --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1480002">4.1.4.11.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / PCI configuration access capability --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1580002">4.1.5.1.2.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Device Initialization / MSI-X Vector Configuration --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1670002">4.1.5.4.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Notification of Device Configuration Changes --></a></li></ul>
<a 
 id="x1-687001r693"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.2   </span> <a 
 id="x1-6880002"></a>Clause 3: MMIO Driver Conformance</h4>
<!--l. 111--><p class="nopar" >An MMIO driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-1730002">4.2.2.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over MMIO / MMIO Device Register Layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1760001">4.2.3.1.1<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over MMIO / MMIO-specific Initialization And Device Operation / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1800001">4.2.3.4.1<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio Over MMIO / MMIO-specific Initialization And Device Operation / Notifications From The Device --></a></li></ul>
<a 
 id="x1-688001r694"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.3   </span> <a 
 id="x1-6890003"></a>Clause 4: Channel I/O Driver Conformance</h4>
<!--l. 121--><p class="nopar" >A Channel I/O driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-1870004">4.3.1.4<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio over channel I/O / Basic Concepts --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1910002">4.3.2.1.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting the Virtio Revision --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1970001">4.3.2.3.1<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Communicating Status Information --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2120002">4.3.3.1.2.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio over channel I/O / Device Operation / Host->Guest Notification / Notification via Adapter I/O Interrupts --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize"><a 
href="#x1-2160002">4.3.3.2.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio over channel I/O / Device Operation / Guest->Host Notification --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2190002">4.3.3.3.2<!--tex4ht:ref: drivernormative:Virtio Transport Options / Virtio over channel I/O / Device Operation / Resetting Devices --></a></li></ul>
<a 
 id="x1-689001r695"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.4   </span> <a 
 id="x1-6900004"></a>Clause 5: Network Driver Conformance</h4>
<!--l. 134--><p class="nopar" >A network driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2290002">5.1.4.2<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2350001">5.1.6.2.1<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Packet Transmission --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2390001">5.1.6.3.1<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Setting Up Receive Buffers --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2430002">5.1.6.4.2<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Processing of Incoming Packets --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2530002">5.1.6.5.1.2<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Control Virtqueue / Packet Receive Filtering --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2560002">5.1.6.5.2.2<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Control Virtqueue / Setting MAC Address Filtering --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2610001">5.1.6.5.4.1<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Control Virtqueue / Gratuitous Packet Sending --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2650001">5.1.6.5.6.1<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Control Virtqueue / Automatic receive steering in multiqueue mode --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2750002">5.1.6.5.8.2<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Control Virtqueue / Offloads State Configuration / Setting Offloads State --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2710002">5.1.6.5.7.2<!--tex4ht:ref: drivernormative:Device Types / Network Device / Device Operation / Control Virtqueue / Receive-side scaling (RSS)  --></a></li></ul>
<a 
 id="x1-690001r696"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.5   </span> <a 
 id="x1-6910005"></a>Clause 6: Block Driver Conformance</h4>
<!--l. 151--><p class="nopar" >A block driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2860001">5.2.5.1<!--tex4ht:ref: drivernormative:Device Types / Block Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2900001">5.2.6.1<!--tex4ht:ref: drivernormative:Device Types / Block Device / Device Operation --></a></li></ul>
<a 
 id="x1-691001r697"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">7.2.6   </span> <a 
 id="x1-6920006"></a>Clause 7: Console Driver Conformance</h4>
<!--l. 160--><p class="nopar" >A console driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-3030001">5.3.6.1<!--tex4ht:ref: drivernormative:Device Types / Console Device / Device Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3060002">5.3.6.2.2<!--tex4ht:ref: drivernormative:Device Types / Console Device / Device Operation / Multiport Device Operation --></a></li></ul>
<a 
 id="x1-692001r698"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.7   </span> <a 
 id="x1-6930007"></a>Clause 8: Entropy Driver Conformance</h4>
<!--l. 169--><p class="nopar" >An entropy driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-3160001">5.4.6.1<!--tex4ht:ref: drivernormative:Device Types / Entropy Device / Device Operation --></a></li></ul>
<a 
 id="x1-693001r699"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.8   </span> <a 
 id="x1-6940008"></a>Clause 9: Traditional Memory Balloon Driver Conformance</h4>
<!--l. 177--><p class="nopar" >A traditional memory balloon driver MUST conform to the following normative
statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-3220001">5.5.3.1<!--tex4ht:ref: drivernormative:Device Types / Memory Balloon Device / Feature bits --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3290001">5.5.6.1<!--tex4ht:ref: drivernormative:Device Types / Memory Balloon Device / Device Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3330001">5.5.6.3.1<!--tex4ht:ref: drivernormative:Device Types / Memory Balloon Device / Device Operation / Memory Statistics --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3380001">5.5.6.5.1<!--tex4ht:ref: drivernormative:Device Types / Memory Balloon Device / Device Operation / Free Page Hinting --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3420001">5.5.6.6.1<!--tex4ht:ref: drivernormative:Device Types / Memory Balloon Device / Device Operation / Page Poison --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3450001">5.5.6.7.1<!--tex4ht:ref: drivernormative:Device Types / Memory Balloon Device / Device Operation / Free Page Reporting --></a></li></ul>
<a 
 id="x1-694001r700"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.9   </span> <a 
 id="x1-6950009"></a>Clause 10: SCSI Host Driver Conformance</h4>
<!--l. 190--><p class="nopar" >An SCSI host driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-3520001">5.6.4.1<!--tex4ht:ref: drivernormative:Device Types / SCSI Host Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3600002">5.6.6.1.2<!--tex4ht:ref: drivernormative:Device Types / SCSI Host Device / Device Operation / Device Operation: Request Queues --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3650001">5.6.6.3.1<!--tex4ht:ref: drivernormative:Device Types / SCSI Host Device / Device Operation / Device Operation: eventq --></a></li></ul>
                                                                  

                                                                  
<a 
 id="x1-695001r701"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.10   </span> <a 
 id="x1-69600010"></a>Clause 11: Input Driver Conformance</h4>
<!--l. 200--><p class="nopar" >An input driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-3950001">5.8.5.1<!--tex4ht:ref: drivernormative:Device Types / Input Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3980001">5.8.6.1<!--tex4ht:ref: drivernormative:Device Types / Input Device / Device Operation --></a></li></ul>
<a 
 id="x1-696001r702"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.11   </span> <a 
 id="x1-69700011"></a>Clause 12: Crypto Driver Conformance</h4>
<!--l. 209--><p class="nopar" >A Crypto driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-4120002">5.9.5.2<!--tex4ht:ref: drivernormative:Device Types / Crypto Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4140001">5.9.6.1<!--tex4ht:ref: drivernormative:Device Types / Crypto Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4230005">5.9.7.2.1.5<!--tex4ht:ref: drivernormative:Device Types / Crypto Device / Device Operation / Control Virtqueue / Session operation / Session operation: create session --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4250007">5.9.7.2.1.7<!--tex4ht:ref: drivernormative:Device Types / Crypto Device / Device Operation / Control Virtqueue / Session operation / Session operation: destroy session --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4290001">5.9.7.4.1<!--tex4ht:ref: drivernormative:Device Types / Crypto Device / Device Operation / HASH Service Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4320001">5.9.7.5.1<!--tex4ht:ref: drivernormative:Device Types / Crypto Device / Device Operation / MAC Service Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4350001">5.9.7.6.1<!--tex4ht:ref: drivernormative:Device Types / Crypto Device / Device Operation / Symmetric algorithms Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4380001">5.9.7.7.1<!--tex4ht:ref: drivernormative:Device Types / Crypto Device / Device Operation / AEAD Service Operation --></a></li></ul>
<a 
 id="x1-697001r703"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.12   </span> <a 
 id="x1-69800012"></a>Clause 13: Socket Driver Conformance</h4>
<!--l. 224--><p class="nopar" >A socket driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-4520001">5.10.6.3.1<!--tex4ht:ref: drivernormative:Device Types / Socket Device / Device Operation / Buffer Space Management --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4550001">5.10.6.4.1<!--tex4ht:ref: drivernormative:Device Types / Socket Device / Device Operation / Receive and Transmit --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4610001">5.10.6.7.1<!--tex4ht:ref: drivernormative:Device Types / Socket Device / Device Operation / Device Events --></a></li></ul>
<a 
 id="x1-698001r704"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">7.2.13   </span> <a 
 id="x1-69900013"></a>Clause 14: File System Driver Conformance</h4>
<!--l. 234--><p class="nopar" >A file system driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-4670001">5.11.4.1<!--tex4ht:ref: drivernormative:Device Types / File System Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4740002">5.11.6.2.2<!--tex4ht:ref: drivernormative:Device Types / File System Device / Device Operation / Device Operation: High Priority Queue --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4760001">5.11.6.3.1<!--tex4ht:ref: drivernormative:Device Types / File System Device / Device Operation / Device Operation: Notification Queue --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4790002">5.11.6.4.2<!--tex4ht:ref: drivernormative:Device Types / File System Device / Device Operation / Device Operation: DAX Window --></a></li></ul>
<a 
 id="x1-699001r705"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.14   </span> <a 
 id="x1-70000014"></a>Clause 15: RPMB Driver Conformance</h4>
<!--l. 245--><p class="nopar" >A RPMB driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-4950002">5.12.6.2<!--tex4ht:ref: drivernormative:Device Types / RPMB Device / Device Operation --></a></li></ul>
<a 
 id="x1-700001r706"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.15   </span> <a 
 id="x1-70100015"></a>Clause 16: IOMMU Driver Conformance</h4>
<!--l. 252--><p class="nopar" >An IOMMU driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-5010001">5.13.3.1<!--tex4ht:ref: drivernormative:Device Types / IOMMU Device / Feature bits --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5040001">5.13.4.1<!--tex4ht:ref: drivernormative:Device Types / IOMMU Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5070001">5.13.5.1<!--tex4ht:ref: drivernormative:Device Types / IOMMU Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5090001">5.13.6.1<!--tex4ht:ref: drivernormative:Device Types / IOMMU Device / Device operations --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5120001">5.13.6.3.1<!--tex4ht:ref: drivernormative:Device Types / IOMMU Device / Device operations / ATTACH request --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5150001">5.13.6.4.1<!--tex4ht:ref: drivernormative:Device Types / IOMMU Device / Device operations / DETACH request --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5180001">5.13.6.5.1<!--tex4ht:ref: drivernormative:Device Types / IOMMU Device / Device operations / MAP request --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5210001">5.13.6.6.1<!--tex4ht:ref: drivernormative:Device Types / IOMMU Device / Device operations / UNMAP request --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5240001">5.13.6.7.1<!--tex4ht:ref: drivernormative:Device Types / IOMMU Device / Device operations / PROBE request --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize"><a 
href="#x1-5280001">5.13.6.8.1.1<!--tex4ht:ref: drivernormative:Device Types / IOMMU Device / Device operations / PROBE properties / RESVMEM --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5310001">5.13.6.9.1<!--tex4ht:ref: drivernormative:Device Types / IOMMU Device / Device operations / Fault reporting --></a></li></ul>
<a 
 id="x1-701001r707"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.16   </span> <a 
 id="x1-70200016"></a>Clause 17: Sound Driver Conformance</h4>
<!--l. 270--><p class="nopar" >A sound driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-5390001">5.14.5.1<!--tex4ht:ref: drivernormative:Device Types / Sound Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5420002">5.14.6.2<!--tex4ht:ref: drivernormative:Device Types / Sound Device / Item Information Request --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5550002">5.14.6.6.3.2<!--tex4ht:ref: drivernormative:Device Types / Sound Device / Device Operation / PCM Stream Parameters --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5650002">5.14.6.8.1.2<!--tex4ht:ref: drivernormative:Device Types / Sound Device / Device Operation / PCM Output Stream --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5680002">5.14.6.8.2.2<!--tex4ht:ref: drivernormative:Device Types / Sound Device / Device Operation / PCM Input Stream --></a></li></ul>
<a 
 id="x1-702001r708"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.17   </span> <a 
 id="x1-70300017"></a>Clause 18: Memory Driver Conformance</h4>
<!--l. 282--><p class="nopar" >A memory driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-5770001">5.15.4.1<!--tex4ht:ref: drivernormative:Device Types / Memory Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5800001">5.15.5.1<!--tex4ht:ref: drivernormative:Device Types / Memory Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5830001">5.15.6.1<!--tex4ht:ref: drivernormative:Device Types / Memory Device / Device Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5860001">5.15.6.3.1<!--tex4ht:ref: drivernormative:Device Types / Memory Device / Device Operation / PLUG request --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5890001">5.15.6.4.1<!--tex4ht:ref: drivernormative:Device Types / Memory Device / Device Operation / UNPLUG request --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5920001">5.15.6.5.1<!--tex4ht:ref: drivernormative:Device Types / Memory Device / Device Operation / UNPLUG ALL request --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5950001">5.15.6.6.1<!--tex4ht:ref: drivernormative:Device Types / Memory Device / Device Operation / STATE request --></a></li></ul>
<a 
 id="x1-703001r709"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">7.2.18   </span> <a 
 id="x1-70400018"></a>Clause 19: I2C Adapter Driver Conformance</h4>
<!--l. 296--><p class="nopar" >An I2C Adapter driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-6060003">5.16.6.3<!--tex4ht:ref: drivernormative:Device Types / I2C Adapter Device / Device Operation --></a></li></ul>
<a 
 id="x1-704001r710"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.19   </span> <a 
 id="x1-70500019"></a>Clause 20: SCMI Driver Conformance</h4>
<!--l. 304--><p class="nopar" >An SCMI driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-6180002">5.17.6.1.2<!--tex4ht:ref: drivernormative:Device Types / SCMI Device / Device Operation / cmdq Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-6200001">5.17.6.2.1<!--tex4ht:ref: drivernormative:Device Types / SCMI Device / Device Operation / Setting Up eventq Buffers --></a></li></ul>
<a 
 id="x1-705001r711"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.20   </span> <a 
 id="x1-70600020"></a>Clause 21: GPIO Driver Conformance</h4>
<!--l. 313--><p class="nopar" >A General Purpose Input/Output (GPIO) driver MUST conform to the following
normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-6390008">5.18.6.8<!--tex4ht:ref: drivernormative:Device Types / GPIO Device / requestq Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-6430002">5.18.7.2<!--tex4ht:ref: drivernormative:Device Types / GPIO Device / eventq Operation --></a></li></ul>
<a 
 id="x1-706001r712"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.21   </span> <a 
 id="x1-70700021"></a>Clause 22: PMEM Driver Conformance</h4>
<!--l. 323--><p class="nopar" >A PMEM driver MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-6520002">5.19.5.2<!--tex4ht:ref: drivernormative:Device Types / PMEM Device / Device Initialization --></a></li></ul>
<a 
 id="x1-707001r713"></a>
<h4 class="subsectionHead"><span class="titlemark">7.2.22   </span> <a 
 id="x1-70800022"></a>Clause 23: Vhost-user Backend Driver Conformance</h4>
<!--l. 331--><p class="nopar" >A vhost-user backend driver MUST conform to the following normative
statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-6690001">5.20.4.1<!--tex4ht:ref: drivernormative:Device Types / Vhost-user Device Backend / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-6710001">5.20.5.1<!--tex4ht:ref: drivernormative:Device Types / Vhost-user Device Backend / Device Initialization --></a></li></ul>
<a 
 id="x1-708001r692"></a>
<h3 class="sectionHead"><span class="titlemark">7.3   </span> <a 
 id="x1-7090003"></a>Clause 24: Device Conformance</h3>
<!--l. 340--><p class="nopar" >A device MUST conform to the following normative statements:
                                                                  

                                                                  
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-130002">2.1.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Device Status Field --></a>
    </li>
    <li class="itemize"><a 
href="#x1-160002">2.2.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Feature Bits --></a>
    </li>
    <li class="itemize"><a 
href="#x1-200001">2.4.1<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Device Reset --></a>
    </li>
    <li class="itemize"><a 
href="#x1-240002">2.5.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Device Configuration Space --></a>
    </li>
    <li class="itemize"><a 
href="#x1-400001">2.7.4.1<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Message Framing --></a>
    </li>
    <li class="itemize"><a 
href="#x1-440001">2.7.5.1<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table --></a>
    </li>
    <li class="itemize"><a 
href="#x1-480002">2.7.5.3.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Descriptor Table / Indirect Descriptors --></a>
    </li>
    <li class="itemize"><a 
href="#x1-530002">2.7.7.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Virtqueues / Used Buffer Notification Suppression --></a>
    </li>
    <li class="itemize"><a 
href="#x1-560002">2.7.8.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Used Ring --></a>
    </li>
    <li class="itemize"><a 
href="#x1-610002">2.7.10.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Virtqueues / Available Buffer Notification Suppression --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1040002">2.10.2<!--tex4ht:ref: devicenormative:Basic Facilities of a Virtio Device / Shared Memory Regions --></a>
    </li>
    <li class="itemize"><a 
href="#x1-6820002">6.2<!--tex4ht:ref: devicenormative:Reserved Feature Bits --></a></li></ul>
<a 
 id="x1-709001r714"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.1   </span> <a 
 id="x1-7100001"></a>Clause 25: PCI Device Conformance</h4>
<!--l. 359--><p class="nopar" >A PCI device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-1160001">4.1.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1180001">4.1.2.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Discovery --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1230002">4.1.3.2<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1260002">4.1.4.2<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / Virtio Structure PCI Capabilities --></a>
    </li>
                                                                  

                                                                  
    <li class="itemize"><a 
href="#x1-1280001">4.1.4.3.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Common configuration structure layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1310001">4.1.4.4.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Notification capability --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1330001">4.1.4.5.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / ISR status capability --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1360001">4.1.4.6.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Device-specific configuration --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1380001">4.1.4.7.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Device auxiliary notification capability --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1400001">4.1.4.8.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Driver auxiliary notification capability --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1420001">4.1.4.9.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Shared memory capability --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1470001">4.1.4.11.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / PCI configuration access capability --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1510001">4.1.4.13.0.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Device Initialization / Non-transitional Device With Legacy Driver --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1570001">4.1.5.1.2.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Device Initialization / MSI-X Vector Configuration --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1640001">4.1.5.3.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Used Buffer Notifications --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1660001">4.1.5.4.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Notification of Device Configuration Changes --></a></li></ul>
<a 
 id="x1-710001r716"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.2   </span> <a 
 id="x1-7110002"></a>Clause 26: MMIO Device Conformance</h4>
<!--l. 382--><p class="nopar" >An MMIO device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-1720001">4.2.2.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio Over MMIO / MMIO Device Register Layout --></a></li></ul>
<a 
 id="x1-711001r717"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.3   </span> <a 
 id="x1-7120003"></a>Clause 27: Channel I/O Device Conformance</h4>
<!--l. 390--><p class="nopar" >A Channel I/O device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-1860003">4.3.1.3<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Basic Concepts --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1900001">4.3.2.1.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting the Virtio Revision --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize"><a 
href="#x1-1940001">4.3.2.2.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Configuring a Virtqueue --></a>
    </li>
    <li class="itemize"><a 
href="#x1-1980002">4.3.2.3.2<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Communicating Status Information --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2050001">4.3.2.6.3.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting Up Indicators / Setting Up Two-Stage Queue Indicators --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2110001">4.3.3.1.2.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Device Operation / Host->Guest Notification / Notification via Adapter I/O Interrupts --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2150001">4.3.3.2.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Device Operation / Guest->Host Notification --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2180001">4.3.3.3.1<!--tex4ht:ref: devicenormative:Virtio Transport Options / Virtio over channel I/O / Device Operation / Resetting Devices --></a></li></ul>
<a 
 id="x1-712001r718"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.4   </span> <a 
 id="x1-7130004"></a>Clause 28: Network Device Conformance</h4>
<!--l. 405--><p class="nopar" >A network device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2280001">5.1.4.1<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2360002">5.1.6.2.2<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Packet Transmission --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2400002">5.1.6.3.2<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Setting Up Receive Buffers --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2420001">5.1.6.4.1<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Processing of Incoming Packets --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2520001">5.1.6.5.1.1<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Control Virtqueue / Packet Receive Filtering --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2550001">5.1.6.5.2.1<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Control Virtqueue / Setting MAC Address Filtering --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2620002">5.1.6.5.4.2<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Control Virtqueue / Gratuitous Packet Sending --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2660002">5.1.6.5.6.2<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Control Virtqueue / Automatic receive steering in multiqueue mode --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2720003">5.1.6.5.7.3<!--tex4ht:ref: devicenormative:Device Types / Network Device / Device Operation / Control Virtqueue / Receive-side scaling (RSS) / RSS processing --></a></li></ul>
<a 
 id="x1-713001r719"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.5   </span> <a 
 id="x1-7140005"></a>Clause 29: Block Device Conformance</h4>
<!--l. 421--><p class="nopar" >A block device MUST conform to the following normative statements:
                                                                  

                                                                  
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-2870002">5.2.5.2<!--tex4ht:ref: devicenormative:Device Types / Block Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-2910002">5.2.6.2<!--tex4ht:ref: devicenormative:Device Types / Block Device / Device Operation --></a></li></ul>
<a 
 id="x1-714001r720"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.6   </span> <a 
 id="x1-7150006"></a>Clause 30: Console Device Conformance</h4>
<!--l. 430--><p class="nopar" >A console device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-3010001">5.3.5.1<!--tex4ht:ref: devicenormative:Device Types / Console Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3050001">5.3.6.2.1<!--tex4ht:ref: devicenormative:Device Types / Console Device / Device Operation / Multiport Device Operation --></a></li></ul>
<a 
 id="x1-715001r721"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.7   </span> <a 
 id="x1-7160007"></a>Clause 31: Entropy Device Conformance</h4>
<!--l. 439--><p class="nopar" >An entropy device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-3170002">5.4.6.2<!--tex4ht:ref: devicenormative:Device Types / Entropy Device / Device Operation --></a></li></ul>
<a 
 id="x1-716001r722"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.8   </span> <a 
 id="x1-7170008"></a>Clause 32: Traditional Memory Balloon Device Conformance</h4>
<!--l. 447--><p class="nopar" >A traditional memory balloon device MUST conform to the following normative
statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-3230002">5.5.3.2<!--tex4ht:ref: devicenormative:Device Types / Memory Balloon Device / Feature bits --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3300002">5.5.6.2<!--tex4ht:ref: devicenormative:Device Types / Memory Balloon Device / Device Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3340002">5.5.6.3.2<!--tex4ht:ref: devicenormative:Device Types / Memory Balloon Device / Device Operation / Memory Statistics --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3390002">5.5.6.5.2<!--tex4ht:ref: devicenormative:Device Types / Memory Balloon Device / Device Operation / Free Page Hinting --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3430002">5.5.6.6.2<!--tex4ht:ref: devicenormative:Device Types / Memory Balloon Device / Device Operation / Page Poison --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3460002">5.5.6.7.2<!--tex4ht:ref: devicenormative:Device Types / Memory Balloon Device / Device Operation / Free Page Reporting --></a></li></ul>
<a 
 id="x1-717001r723"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.9   </span> <a 
 id="x1-7180009"></a>Clause 33: SCSI Host Device Conformance</h4>
<!--l. 460--><p class="nopar" >An SCSI host device MUST conform to the following normative statements:
                                                                  

                                                                  
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-3530002">5.6.4.2<!--tex4ht:ref: devicenormative:Device Types / SCSI Host Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3550005">5.6.5<!--tex4ht:ref: devicenormative:Device Types / SCSI Host Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3590001">5.6.6.1.1<!--tex4ht:ref: devicenormative:Device Types / SCSI Host Device / Device Operation / Device Operation: Request Queues --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3660002">5.6.6.3.2<!--tex4ht:ref: devicenormative:Device Types / SCSI Host Device / Device Operation / Device Operation: eventq --></a></li></ul>
<a 
 id="x1-718001r724"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.10   </span> <a 
 id="x1-71900010"></a>Clause 34: Input Device Conformance</h4>
<!--l. 471--><p class="nopar" >An input device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-3960002">5.8.5.2<!--tex4ht:ref: devicenormative:Device Types / Input Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-3990002">5.8.6.2<!--tex4ht:ref: devicenormative:Device Types / Input Device / Device Operation --></a></li></ul>
<a 
 id="x1-719001r725"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.11   </span> <a 
 id="x1-72000011"></a>Clause 35: Crypto Device Conformance</h4>
<!--l. 480--><p class="nopar" >A Crypto device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-4110001">5.9.5.1<!--tex4ht:ref: devicenormative:Device Types / Crypto Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4240006">5.9.7.2.1.6<!--tex4ht:ref: devicenormative:Device Types / Crypto Device / Device Operation / Control Virtqueue / Session operation / Session operation: create session --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4260008">5.9.7.2.1.8<!--tex4ht:ref: devicenormative:Device Types / Crypto Device / Device Operation / Control Virtqueue / Session operation / Session operation: destroy session --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4300002">5.9.7.4.2<!--tex4ht:ref: devicenormative:Device Types / Crypto Device / Device Operation / HASH Service Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4330002">5.9.7.5.2<!--tex4ht:ref: devicenormative:Device Types / Crypto Device / Device Operation / MAC Service Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4360002">5.9.7.6.2<!--tex4ht:ref: devicenormative:Device Types / Crypto Device / Device Operation / Symmetric algorithms Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4390002">5.9.7.7.2<!--tex4ht:ref: devicenormative:Device Types / Crypto Device / Device Operation / AEAD Service Operation --></a></li></ul>
<a 
 id="x1-720001r726"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.12   </span> <a 
 id="x1-72100012"></a>Clause 36: Socket Device Conformance</h4>
<!--l. 494--><p class="nopar" >A socket device MUST conform to the following normative statements:
                                                                  

                                                                  
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-4530002">5.10.6.3.2<!--tex4ht:ref: devicenormative:Device Types / Socket Device / Device Operation / Buffer Space Management --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4560002">5.10.6.4.2<!--tex4ht:ref: devicenormative:Device Types / Socket Device / Device Operation / Receive and Transmit --></a></li></ul>
<a 
 id="x1-721001r727"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.13   </span> <a 
 id="x1-72200013"></a>Clause 37: File System Device Conformance</h4>
<!--l. 503--><p class="nopar" >A file system device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-4680002">5.11.4.2<!--tex4ht:ref: devicenormative:Device Types / File System Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4730001">5.11.6.2.1<!--tex4ht:ref: devicenormative:Device Types / File System Device / Device Operation / Device Operation: High Priority Queue --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4780001">5.11.6.4.1<!--tex4ht:ref: devicenormative:Device Types / File System Device / Device Operation / Device Operation: DAX Window --></a></li></ul>
<a 
 id="x1-722001r728"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.14   </span> <a 
 id="x1-72300014"></a>Clause 38: RPMB Device Conformance</h4>
<!--l. 513--><p class="nopar" >An RPMB device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-4870005">5.12.5<!--tex4ht:ref: devicenormative:Device Types / RPMB Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4900001">5.12.6.1.1<!--tex4ht:ref: devicenormative:Device Types / RPMB Device / Device Operation / Device Operation: Program Key --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4910002">5.12.6.1.2<!--tex4ht:ref: devicenormative:Device Types / RPMB Device / Device Operation / Device Operation: Get Write Counter --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4920003">5.12.6.1.3<!--tex4ht:ref: devicenormative:Device Types / RPMB Device / Device Operation / Device Operation: Data Write --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4930004">5.12.6.1.4<!--tex4ht:ref: devicenormative:Device Types / RPMB Device / Device Operation / Device Operation: Data Read --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4940005">5.12.6.1.5<!--tex4ht:ref: devicenormative:Device Types / RPMB Device / Device Operation / Device Operation: Result Read --></a>
    </li>
    <li class="itemize"><a 
href="#x1-4960003">5.12.6.3<!--tex4ht:ref: devicenormative:Device Types / RPMB Device / Device Operation --></a></li></ul>
<a 
 id="x1-723001r729"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.15   </span> <a 
 id="x1-72400015"></a>Clause 39: IOMMU Device Conformance</h4>
<!--l. 527--><p class="nopar" >An IOMMU device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-5020002">5.13.3.2<!--tex4ht:ref: devicenormative:Device Types / IOMMU Device / Feature bits --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize"><a 
href="#x1-5050002">5.13.4.2<!--tex4ht:ref: devicenormative:Device Types / IOMMU Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5100002">5.13.6.2<!--tex4ht:ref: devicenormative:Device Types / IOMMU Device / Device operations --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5130002">5.13.6.3.2<!--tex4ht:ref: devicenormative:Device Types / IOMMU Device / Device operations / ATTACH request --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5160002">5.13.6.4.2<!--tex4ht:ref: devicenormative:Device Types / IOMMU Device / Device operations / DETACH request --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5190002">5.13.6.5.2<!--tex4ht:ref: devicenormative:Device Types / IOMMU Device / Device operations / MAP request --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5220002">5.13.6.6.2<!--tex4ht:ref: devicenormative:Device Types / IOMMU Device / Device operations / UNMAP request --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5250002">5.13.6.7.2<!--tex4ht:ref: devicenormative:Device Types / IOMMU Device / Device operations / PROBE request --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5290002">5.13.6.8.1.2<!--tex4ht:ref: devicenormative:Device Types / IOMMU Device / Device operations / PROBE properties / RESVMEM --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5320002">5.13.6.9.2<!--tex4ht:ref: devicenormative:Device Types / IOMMU Device / Device operations / Fault reporting --></a></li></ul>
<a 
 id="x1-724001r730"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.16   </span> <a 
 id="x1-72500016"></a>Clause 40: Sound Device Conformance</h4>
<!--l. 544--><p class="nopar" >A sound device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-5460001">5.14.6.4.1.1<!--tex4ht:ref: devicenormative:Device Types / Sound Device / Device Operation / Jack Information --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5520001">5.14.6.6.2.1<!--tex4ht:ref: devicenormative:Device Types / Sound Device / Device Operation / PCM Stream Information --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5540001">5.14.6.6.3.1<!--tex4ht:ref: devicenormative:Device Types / Sound Device / Device Operation / PCM Stream Parameters --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5580001">5.14.6.6.5.1<!--tex4ht:ref: devicenormative:Device Types / Sound Device / Device Operation / PCM Stream Release --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5640001">5.14.6.8.1.1<!--tex4ht:ref: devicenormative:Device Types / Sound Device / Device Operation / PCM Output Stream --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5670001">5.14.6.8.2.1<!--tex4ht:ref: devicenormative:Device Types / Sound Device / Device Operation / PCM Input Stream --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5710001">5.14.6.9.1.1<!--tex4ht:ref: devicenormative:Device Types / Sound Device / Device Operation / Channel Map Information --></a></li></ul>
<a 
 id="x1-725001r731"></a>
                                                                  

                                                                  
<h4 class="subsectionHead"><span class="titlemark">7.3.17   </span> <a 
 id="x1-72600017"></a>Clause 41: Memory Device Conformance</h4>
<!--l. 558--><p class="nopar" >A memory device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-5780002">5.15.4.2<!--tex4ht:ref: devicenormative:Device Types / Memory Device / Device configuration layout --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5810002">5.15.5.2<!--tex4ht:ref: devicenormative:Device Types / Memory Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5840002">5.15.6.2<!--tex4ht:ref: devicenormative:Device Types / Memory Device / Device Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5870002">5.15.6.3.2<!--tex4ht:ref: devicenormative:Device Types / Memory Device / Device Operation / PLUG request --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5900002">5.15.6.4.2<!--tex4ht:ref: devicenormative:Device Types / Memory Device / Device Operation / UNPLUG request --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5930002">5.15.6.5.2<!--tex4ht:ref: devicenormative:Device Types / Memory Device / Device Operation / UNPLUG ALL request --></a>
    </li>
    <li class="itemize"><a 
href="#x1-5960002">5.15.6.6.2<!--tex4ht:ref: devicenormative:Device Types / Memory Device / Device Operation / STATE request --></a></li></ul>
<a 
 id="x1-726001r732"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.18   </span> <a 
 id="x1-72700018"></a>Clause 42: I2C Adapter Device Conformance</h4>
<!--l. 572--><p class="nopar" >An I2C Adapter device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-6070004">5.16.6.4<!--tex4ht:ref: devicenormative:Device Types / I2C Adapter Device / Device Operation --></a></li></ul>
<a 
 id="x1-727001r733"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.19   </span> <a 
 id="x1-72800019"></a>Clause 43: SCMI Device Conformance</h4>
<!--l. 580--><p class="nopar" >An SCMI device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-6120001">5.17.3.1<!--tex4ht:ref: devicenormative:Device Types / SCMI Device / Feature bits --></a>
    </li>
    <li class="itemize"><a 
href="#x1-6170001">5.17.6.1.1<!--tex4ht:ref: devicenormative:Device Types / SCMI Device / Device Operation / cmdq Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-6220001">5.17.6.3.1<!--tex4ht:ref: devicenormative:Device Types / SCMI Device / Device Operation / eventq Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-6240001">5.17.6.4.1<!--tex4ht:ref: devicenormative:Device Types / SCMI Device / Device Operation / Shared Memory Operation --></a></li></ul>
<a 
 id="x1-728001r734"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.20   </span> <a 
 id="x1-72900020"></a>Clause 44: GPIO Device Conformance</h4>
<!--l. 591--><p class="nopar" >A General Purpose Input/Output (GPIO) device MUST conform to the following
normative statements:
                                                                  

                                                                  
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-6400009">5.18.6.9<!--tex4ht:ref: devicenormative:Device Types / GPIO Device / requestq Operation --></a>
    </li>
    <li class="itemize"><a 
href="#x1-6440003">5.18.7.3<!--tex4ht:ref: devicenormative:Device Types / GPIO Device / eventq Operation --></a></li></ul>
<a 
 id="x1-729001r735"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.21   </span> <a 
 id="x1-73000021"></a>Clause 45: PMEM Device Conformance</h4>
<!--l. 601--><p class="nopar" >A PMEM device MUST conform to the following normative statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-6510001">5.19.5.1<!--tex4ht:ref: devicenormative:Device Types / PMEM Device / Device Initialization --></a>
    </li>
    <li class="itemize"><a 
href="#x1-6550001">5.19.7.1<!--tex4ht:ref: devicenormative:Device Types / PMEM Device / Device Operation / Virtqueue flush --></a>
    </li>
    <li class="itemize"><a 
href="#x1-6570003">5.19.7.3<!--tex4ht:ref: devicenormative:Device Types / PMEM Device / Device Operation / Virtqueue return --></a></li></ul>
<a 
 id="x1-730001r736"></a>
<h4 class="subsectionHead"><span class="titlemark">7.3.22   </span> <a 
 id="x1-73100022"></a>Clause 46: Vhost-user Backend Device Conformance</h4>
<!--l. 611--><p class="nopar" >A Vhost-user backend device MUST conform to the following normative
statements:
    <ul class="itemize1">
    <li class="itemize"><a 
href="#x1-6780001">5.20.7.3.1<!--tex4ht:ref: devicenormative:Device Types / Vhost-user Device Backend / Additional Device Resources / Shared Memory layout --></a></li></ul>
<a 
 id="x1-731001r715"></a>
<h3 class="sectionHead"><span class="titlemark">7.4   </span> <a 
 id="x1-7320004"></a>Clause 47: Legacy Interface: Transitional Device and Transitional Driver
Conformance</h3>
<!--l. 618--><p class="nopar" >A conformant implementation MUST be either transitional or non-transitional, see
<a 
href="#x1-60001">1.3.1<!--tex4ht:ref: intro:Legacy Interface: Terminology --></a>.
<!--l. 622--><p class="noindent" >An implementation MAY choose to implement OPTIONAL support for the legacy
interface, including support for legacy drivers or devices, by conforming to all of the
MUST or REQUIRED level requirements for the legacy interface for the transitional
devices and drivers.
<!--l. 628--><p class="noindent" >The requirements for the legacy interface for transitional implementations are located
in sections named “Legacy Interface” listed below:
    <ul class="itemize1">
    <li class="itemize">Section <a 
href="#x1-170003">2.2.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Feature Bits / Legacy Interface: A Note on Feature Bits --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-250003">2.5.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Configuration Space / Legacy Interface: A Note on Configuration Space endian-ness --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-260004">2.5.4<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Device Configuration Space / Legacy Interface: Device Configuration Space --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize">Section <a 
href="#x1-370002">2.7.2<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Layout --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-380003">2.7.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Legacy Interfaces: A Note on Virtqueue Endianness --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-420003">2.7.4.3<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / Message Framing / Legacy Interface: Message Framing --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1090002">3.1.2<!--tex4ht:ref: sec:General Initialization And Device Operation / Device Initialization / Legacy Interface: Device Initialization --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1200003">4.1.2.3<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Discovery / Legacy Interfaces: A Note on PCI Device Discovery --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-14900012">4.1.4.12<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI Device Layout / Legacy Interfaces: A Note on PCI Device Layout --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1550001">4.1.5.1.1.1<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Device Initialization / Virtio Device Configuration Layout Detection / Legacy Interface: A Note on Device Layout Detection --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1600001">4.1.5.1.3.1<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over PCI Bus / PCI-specific Initialization And Device Operation / Device Initialization / Virtqueue Configuration / Legacy Interface: A Note on Virtqueue Configuration --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1810004">4.2.4<!--tex4ht:ref: sec:Virtio Transport Options / Virtio Over MMIO / Legacy interface --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1920003">4.3.2.1.3<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting the Virtio Revision / Legacy Interfaces: A Note on Setting the Virtio Revision --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-1950002">4.3.2.2.2<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Configuring a Virtqueue / Legacy Interface: A Note on Configuring a Virtqueue --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2130003">4.3.3.1.3<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Operation / Host->Guest Notification / Legacy Interfaces: A Note on Host->Guest Notification --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2060004">4.3.2.6.4<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting Up Indicators / Legacy Interfaces: A Note on Setting Up Indicators --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2260002">5.1.3.2<!--tex4ht:ref: sec:Device Types / Network Device / Feature bits / Legacy Interface: Feature bits --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2300003">5.1.4.3<!--tex4ht:ref: sec:Device Types / Network Device / Device configuration layout / Legacy Interface: Device configuration layout --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2330001">5.1.6.1<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Legacy Interface: Device Operation --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2570003">5.1.6.5.2.3<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue / Setting MAC Address Filtering / Legacy Interface: Setting MAC Address Filtering --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2590001">5.1.6.5.3.1<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue / VLAN Filtering / Legacy Interface: VLAN Filtering --></a>
                                                                  

                                                                  
    </li>
    <li class="itemize">Section <a 
href="#x1-2670003">5.1.6.5.6.3<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue / Automatic receive steering in multiqueue mode / Legacy Interface: Automatic receive steering in multiqueue mode --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2760003">5.1.6.5.8.3<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue / Offloads State Configuration / Setting Offloads State / Legacy Interface: Setting Offloads State --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2820001">5.2.3.1<!--tex4ht:ref: sec:Device Types / Block Device / Feature bits / Legacy Interface: Feature bits --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2840001">5.2.4.1<!--tex4ht:ref: sec:Device Types / Block Device / Device configuration layout / Legacy Interface: Device configuration layout --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2880003">5.2.5.3<!--tex4ht:ref: sec:Device Types / Block Device / Device Initialization / Legacy Interface: Device Initialization --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2920003">5.2.6.3<!--tex4ht:ref: sec:Device Types / Block Device / Device Operation / Legacy Interface: Device Operation --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-2990001">5.3.4.1<!--tex4ht:ref: sec:Device Types / Console Device / Device configuration layout / Legacy Interface: Device configuration layout --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-3070003">5.3.6.3<!--tex4ht:ref: sec:Device Types / Console Device / Device Operation / Legacy Interface: Device Operation --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-3240001">5.5.3.2.0.1<!--tex4ht:ref: sec:Device Types / Memory Balloon Device / Feature bits / Legacy Interface: Feature bits --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-3310001">5.5.6.2.1<!--tex4ht:ref: sec:Device Types / Memory Balloon Device / Device Operation / Legacy Interface: Device Operation --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-3350003">5.5.6.3.3<!--tex4ht:ref: sec:Device Types / Memory Balloon Device / Device Operation / Memory Statistics / Legacy Interface: Memory Statistics --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-3540003">5.6.4.3<!--tex4ht:ref: sec:Device Types / SCSI Host Device / Device configuration layout / Legacy Interface: Device configuration layout --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-3570001">5.6.6.0.1<!--tex4ht:ref: sec:Device Types / SCSI Host Device / Device Operation / Legacy Interface: Device Operation --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-3610003">5.6.6.1.3<!--tex4ht:ref: sec:Device Types / SCSI Host Device / Device Operation / Device Operation: Request Queues / Legacy Interface: Device Operation: Request Queues --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-3630001">5.6.6.2.1<!--tex4ht:ref: sec:Device Types / SCSI Host Device / Device Operation / Device Operation: controlq / Legacy Interface: Device Operation: controlq --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-3670003">5.6.6.3.3<!--tex4ht:ref: sec:Device Types / SCSI Host Device / Device Operation / Device Operation: eventq / Legacy Interface: Device Operation: eventq --></a>
    </li>
    <li class="itemize">Section <a 
href="#x1-6830003">6.3<!--tex4ht:ref: sec:Reserved Feature Bits / Legacy Interface: Reserved Feature Bits --></a></li></ul>
                                                                  

                                                                  
<a 
 id="x1-732001r690"></a>
<!--l. 1--><p class="nopar" ><h2 class="appendixHead"><span class="titlemark">Appendix A</span>. <a 
 id="x1-733000A"></a>virtio_queue.h</h2>
This file is also available at the link <a 
href="https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/listings/virtio_queue.h" class="url" >https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/listings/virtio_queue.h</a>.
All definitions in this section are for non-normative reference only.
<!--l. 8--><div class="lstinputlisting">
<a 
 id="x1-733001"></a>
<span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733002r1"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">ifndef</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQUEUE_H</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733003r2"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQUEUE_H</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733004r3"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">An</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">interface</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">efficient</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtio</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">implementation</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733005r4"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733006r5"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">header</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">BSD</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">licensed</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">so</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">anyone</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">can</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">use</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">definitions</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733007r6"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">implement</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">compatible</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">drivers</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">servers</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733008r7"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733009r8"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Copyright</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2007,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2009,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IBM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Corporation</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733010r9"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Copyright</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2011,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Red</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Hat</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Inc</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733011r10"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">All</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">rights</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reserved</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733012r11"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733013r12"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Redistribution</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">use</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">binary</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">forms</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">without</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733014r13"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">modification</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">permitted</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">provided</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">that</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">following</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">conditions</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733015r14"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">are</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">met</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733016r15"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Redistributions</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">source</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">code</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">must</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">retain</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">copyright</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733017r16"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notice</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">list</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">conditions</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">following</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">disclaimer</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733018r17"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Redistributions</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">binary</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">form</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">must</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reproduce</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">copyright</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733019r18"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">notice</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">list</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">conditions</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">following</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">disclaimer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733020r19"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">documentation</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80">/</span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">other</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">materials</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">provided</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">distribution</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733021r20"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">3.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Neither</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">name</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IBM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">nor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">names</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">its</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">contributors</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733022r21"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">may</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">be</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">endorse</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">or</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">promote</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">products</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">derived</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">from</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">software</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733023r22"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">without</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">specific</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">prior</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">written</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">permission</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733024r23"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">THIS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SOFTWARE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PROVIDED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">BY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">THE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">COPYRIGHT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">HOLDERS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">AND</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CONTRIBUTORS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">‘‘</span><span 
class="pcrr8t-x-x-80">AS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IS</span><span 
class="pcrr8t-x-x-80">’’</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">AND</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733025r24"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ANY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">EXPRESS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IMPLIED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">WARRANTIES</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">INCLUDING</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">BUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">NOT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">LIMITED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">TO</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">THE</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733026r25"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IMPLIED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">WARRANTIES</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">MERCHANTABILITY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">AND</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">FITNESS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">FOR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">A</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PARTICULAR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PURPOSE</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733027r26"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ARE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">DISCLAIMED</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">NO</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">EVENT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SHALL</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IBM</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CONTRIBUTORS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">BE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">LIABLE</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733028r27"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">FOR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ANY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">DIRECT</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">INDIRECT</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">INCIDENTAL</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SPECIAL</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">EXEMPLARY</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CONSEQUENTIAL</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733029r28"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">DAMAGES</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">INCLUDING</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">BUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">NOT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">LIMITED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">TO</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PROCUREMENT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SUBSTITUTE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">GOODS</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733030r29"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SERVICES</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">LOSS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">USE</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">DATA</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">PROFITS</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">BUSINESS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">INTERRUPTION</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733031r30"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">HOWEVER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CAUSED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">AND</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ON</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ANY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">THEORY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">LIABILITY</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">WHETHER</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">CONTRACT</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">STRICT</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733032r31"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">LIABILITY</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">TORT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">INCLUDING</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">NEGLIGENCE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OR</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OTHERWISE</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ARISING</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ANY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">WAY</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733033r32"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">THE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">USE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">THIS</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SOFTWARE</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">EVEN</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">IF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ADVISED</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">THE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">POSSIBILITY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">OF</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733034r33"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">SUCH</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">DAMAGE</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733035r34"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733036r35"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">include</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;</span><span 
class="pcrr8t-x-x-80">stdint</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80">h</span><span 
class="pcrr8t-x-x-80">&gt;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733037r36"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733038r37"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">marks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">continuing</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">via</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">field</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733039r38"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_NEXT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733040r39"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">marks</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">write</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">otherwise</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">read</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733041r40"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_WRITE</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">2</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733042r41"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">This</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">means</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">contains</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">list</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733043r42"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_DESC_F_INDIRECT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">4</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733044r43"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733045r44"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">uses</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">advise</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">don</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">t</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">kick</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">me</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733046r45"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">when</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">you</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">add</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">It</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unreliable</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">so</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">it</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">simply</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">an</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733047r46"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">optimization</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733048r47"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_USED_F_NO_NOTIFY</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733049r48"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">driver</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">uses</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">in</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">advise</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">device</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">don</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">t</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733050r49"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">interrupt</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">me</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">when</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">you</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">consume</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">a</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">buffer</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">It</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unreliable</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">so</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">it</span><span 
class="pcrr8t-x-x-80">’</span><span 
class="pcrr8t-x-x-80">s</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733051r50"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">simply</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">an</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">optimization</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733052r51"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQ_AVAIL_F_NO_INTERRUPT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733053r52"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733054r53"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Support</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">indirect</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733055r54"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_INDIRECT_DESC</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">28</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733056r55"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733057r56"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Support</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail_event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">and</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used_event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">fields</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733058r57"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_EVENT_IDX</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">29</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733059r58"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733060r59"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Arbitrary</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">layouts</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733061r60"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">define</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_ANY_LAYOUT</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">27</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733062r61"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733063r62"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Virtqueue</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">bytes</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733064r63"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">These</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">can</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">chain</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">together</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">via</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">"</span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80">".</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733065r64"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733066r65"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Address</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">guest</span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80">physical</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733067r66"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le64</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">addr</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733068r67"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Length</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733069r68"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733070r69"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">The</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">as</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">indicated</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">above</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733071r70"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733072r71"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">We</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">chain</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unused</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptors</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">via</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">this</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">too</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733073r72"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">next</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733074r73"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733075r74"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733076r75"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733077r76"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733078r77"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733079r78"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733080r79"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_EVENT_IDX</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used_event</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733081r80"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733082r81"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733083r82"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">here</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ids</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">for</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">padding</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">reasons</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733084r83"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used_elem</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733085r84"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Index</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">start</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">chain</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733086r85"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">id</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733087r86"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Total</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">length</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">the</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">descriptor</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">chain</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">which</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">was</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">written</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">to</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733088r87"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le32</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">len</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733089r88"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733090r89"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733091r90"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733092r91"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">flags</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733093r92"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">idx</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733094r93"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used_elem</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733095r94"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">if</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_EVENT_IDX</span><span 
class="pcrr8t-x-x-80">:</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail_event</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733096r95"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733097r96"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733098r97"></a></span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733099r98"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">unsigned</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">int</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">num</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733100r99"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733101r100"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_desc</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">desc</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733102r101"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733103r102"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733104r103"></a></span><span 
class="pcrr8t-x-x-80">};</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733105r104"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733106r105"></a></span><span 
class="pcrr8t-x-x-80">static</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">inline</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">int</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq_need_event</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">uint16_t</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event_idx</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">uint16_t</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">new_idx</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">uint16_t</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">old_idx</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733107r106"></a></span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733108r107"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">return</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">uint16_t</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">new_idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event_idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">1)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&lt;</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">uint16_t</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">new_idx</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">-</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">old_idx</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80">;</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733109r108"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733110r109"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733111r110"></a></span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">Get</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">location</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">indices</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">only</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">with</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTIO_F_EVENT_IDX</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733112r111"></a></span><span 
class="pcrr8t-x-x-80">static</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">inline</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">virtq_used_event</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733113r112"></a></span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733114r113"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">backwards</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">compat</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">at</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">end</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733115r114"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">return</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">&amp;</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">num</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733116r115"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733117r116"></a></span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733118r117"></a></span><span 
class="pcrr8t-x-x-80">static</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">inline</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">virtq_avail_event</span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">struct</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">virtq</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">)</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733119r118"></a></span><span 
class="pcrr8t-x-x-80">{</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733120r119"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">For</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">backwards</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">compat</span><span 
class="pcrr8t-x-x-80">,</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">avail</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">event</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">index</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">is</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">at</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80">end</span><span 
class="pcrr8t-x-x-80">*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">of</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">.</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733121r120"></a></span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">return</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">(</span><span 
class="pcrr8t-x-x-80">le16</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*)</span><span 
class="pcrr8t-x-x-80">&amp;</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">used</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">ring</span><span 
class="pcrr8t-x-x-80">[</span><span 
class="pcrr8t-x-x-80">vq</span><span 
class="pcrr8t-x-x-80">-&gt;</span><span 
class="pcrr8t-x-x-80">num</span><span 
class="pcrr8t-x-x-80">];</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733122r121"></a></span><span 
class="pcrr8t-x-x-80">}</span><span 
class="pcrr8t-x-x-80"> </span><br /><span class="label"><a 
 id="x1-733123r122"></a></span><span 
class="pcrr8t-x-x-80">#</span><span 
class="pcrr8t-x-x-80">endif</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">/*</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">VIRTQUEUE_H</span><span 
class="pcrr8t-x-x-80"> </span><span 
class="pcrr8t-x-x-80">*/</span>
</div>
                                                                  

                                                                  
<a 
 id="x1-733124r690"></a>
<!--l. 1--><p class="nopar" ><h2 class="appendixHead"><span class="titlemark">Appendix B</span>. <a 
 id="x1-734000B"></a>Creating New Device Types</h2>
Various considerations are necessary when creating a new device type.
<a 
 id="x1-734001r738"></a>
<h3 class="sectionHead"><span class="titlemark">B.1   </span> <a 
 id="x1-7350001"></a>How Many Virtqueues?</h3>
<!--l. 8--><p class="nopar" >It is possible that a very simple device will operate entirely through its device
configuration space, but most will need at least one virtqueue in which it
will place requests. A device with both input and output (eg. console and
network devices described here) need two queues: one which the driver fills with
buffers to receive input, and one which the driver places buffers to transmit
output.
<a 
 id="x1-735001r742"></a>
<h3 class="sectionHead"><span class="titlemark">B.2   </span> <a 
 id="x1-7360002"></a>What Device Configuration Space Layout?</h3>
<!--l. 18--><p class="nopar" >Device configuration space should only be used for initialization-time parameters. It
is a limited resource with no synchronization between field written by the driver, so
for most uses it is better to use a virtqueue to update configuration information (the
network device does this for filtering, otherwise the table in the config space could
potentially be very large).
<!--l. 25--><p class="noindent" >Remember that configuration fields over 32 bits wide might not be atomically
writable by the driver. Therefore, no writeable field which triggers an action ought to
be wider than 32 bits.
<a 
 id="x1-736001r743"></a>
<h3 class="sectionHead"><span class="titlemark">B.3   </span> <a 
 id="x1-7370003"></a>What Device Number?</h3>
<!--l. 31--><p class="nopar" >Device numbers can be reserved by the OASIS committee: email
virtio-dev@lists.oasis-open.org to secure a unique one.
<!--l. 34--><p class="noindent" >Meanwhile for experimental drivers, use 65535 and work backwards.
<a 
 id="x1-737001r744"></a>
<h3 class="sectionHead"><span class="titlemark">B.4   </span> <a 
 id="x1-7380004"></a>How many MSI-X vectors? (for PCI)</h3>
<!--l. 38--><p class="nopar" >Using the optional MSI-X capability devices can speed up interrupt processing by
removing the need to read ISR Status register by guest driver (which might be an
expensive operation), reducing interrupt sharing between devices and queues within
the device, and handling interrupts from multiple CPUs. However, some systems
impose a limit (which might be as low as 256) on the total number of MSI-X vectors
that can be allocated to all devices. Devices and/or drivers should take this into
account, limiting the number of vectors used unless the device is expected
to cause a high volume of interrupts. Devices can control the number of
vectors used by limiting the MSI-X Table Size or not presenting MSI-X
capability in PCI configuration space. Drivers can control this by mapping events
                                                                  

                                                                  
to as small number of vectors as possible, or disabling MSI-X capability
altogether.
<a 
 id="x1-738001r745"></a>
<h3 class="sectionHead"><span class="titlemark">B.5   </span> <a 
 id="x1-7390005"></a>Device Improvements</h3>
<!--l. 56--><p class="nopar" >Any change to device configuration space, or new virtqueues, or behavioural changes,
should be indicated by negotiation of a new feature bit. This establishes
clarity<span class="footnote-mark"><a 
href="#fn24x9" id="fn24x9-bk"><sup class="textsuperscript">24</sup></a></span><a 
 id="x1-739001f24"></a>
and avoids future expansion problems.
<!--l. 62--><p class="noindent" >Clusters of functionality which are always implemented together can use a single bit,
but if one feature makes sense without the others they should not be gratuitously
grouped together to conserve feature bits.
                                                                  

                                                                  
<a 
 id="x1-739002r690"></a>
<!--l. 4--><p class="nopar" ><h2 class="appendixHead"><span class="titlemark">Appendix C</span>. <a 
 id="x1-740000C"></a>Acknowledgements</h2>
The following individuals have participated in the creation of this specification and
are gratefully acknowledged:
<a 
 id="Q1-1-748"></a>
<h4 class="likesubsectionHead"><a 
 id="x1-741000C"></a>Participants</h4>
<!--l. 9--><p class="nopar" >Allen Chia, Oracle <br 
class="newline" />Amit Shah, Red Hat <br 
class="newline" />Amos Kong, Red Hat <br 
class="newline" />Anthony Liguori, IBM <br 
class="newline" />Bruce Rogers, SUSE <br 
class="newline" />Bryan Venteicher, NetApp <br 
class="newline" />Chandra Thyamagondlu, Xilinx <br 
class="newline" />Chet Ensign, OASIS <br 
class="newline" />Cornelia Huck, Red Hat <br 
class="newline" />Cunming, Liang, Intel <br 
class="newline" />Damjan, Marion, Cisco <br 
class="newline" />Daniel Kiper, Oracle <br 
class="newline" />Fang Chen, Huawei <br 
class="newline" />Fang You, Huawei <br 
class="newline" />Geoff Brown, M2Mi <br 
class="newline" />Gerd Hoffmann, Red Hat <br 
class="newline" />Gershon Janssen, Individual Member <br 
class="newline" />Grant Likely, ARM <br 
class="newline" />Haggai Eran, Mellanox <br 
class="newline" />Halil Pasic, IBM <br 
class="newline" />James Bottomley, Parallels IP Holdings GmbH <br 
class="newline" />Jani Kokkonen, Huawei <br 
class="newline" />Jan Kiszka, Siemens AG <br 
class="newline" />Jens Freimann, Red Hat <br 
class="newline" />Jian Zhou, Huawei <br 
class="newline" />Karen Xie, Xilinx <br 
class="newline" />Kumar Sanghvi, Xilinx <br 
class="newline" />Lei Gong, Huawei <br 
class="newline" />Lior Narkis, Mellanox <br 
class="newline" />Luiz Capitulino, Red Hat <br 
class="newline" />Marc-André Lureau, Red Hat <br 
class="newline" />Mark Gray, Intel <br 
class="newline" />Michael S. Tsirkin, Red Hat <br 
class="newline" />Mihai Carabas, Oracle <br 
class="newline" />Nishank Trivedi, NetApp <br 
class="newline" />Paolo Bonzini, Red Hat <br 
class="newline" />Paul Mundt, Huawei <br 
class="newline" />Pawel Moll, ARM <br 
class="newline" />Peng Long, Huawei <br 
class="newline" />Piotr Uminski, Intel <br 
class="newline" />Qian Xum, Intel <br 
class="newline" />Richard Sohn, Alcatel-Lucent <br 
class="newline" />Rusty Russell, IBM <br 
class="newline" />Sasha Levin, Oracle <br 
class="newline" />Sergey Tverdyshev, Thales e-Security <br 
class="newline" />Stefan Hajnoczi, Red Hat <br 
class="newline" />Sundar Mohan, Xilinx <br 
class="newline" />Tom Lyon, Samya Systems, Inc. <br 
class="newline" />Victor Kaplansky, Red Hat <br 
class="newline" />Vijay Balakrishna, Oracle <br 
class="newline" />Wei Wang, Intel <br 
class="newline" />Xin Zeng, Intel <br 
class="newline" />
<!--l. 62--><p class="noindent" >The following non-members have provided valuable feedback on this specification and
are gratefully acknowledged:
<a 
 id="Q1-1-750"></a>
<h4 class="likesubsectionHead"><a 
 id="x1-742000C"></a>Reviewers</h4>
<!--l. 66--><p class="nopar" >Aaron Conole, Red Hat <br 
class="newline" />Adam Tao, Huawei <br 
class="newline" />Alexander Duyck, Intel <br 
class="newline" />Andreas Pape, ADITG/ESB <br 
class="newline" />Andrew Thornton, Google <br 
class="newline" />Arun Subbarao, LynuxWorks <br 
class="newline" />Baptiste Reynal, Virtual Open Systems <br 
class="newline" />Bharat Bhushan, NXP Semiconductors <br 
class="newline" />Brian Foley, ARM <br 
class="newline" />Chandra Thyamagondlu, Xilinx <br 
class="newline" />Changpeng Liu, Intel <br 
class="newline" />Christian Pinto, Virtual Open Systems <br 
class="newline" />Christoffer Dall, ARM <br 
class="newline" />Christoph Hellwig, Individual <br 
class="newline" />Christian Borntraeger, IBM <br 
class="newline" />Daniel Marcovitch, Mellanox <br 
class="newline" />David Alan Gilbert, Red Hat <br 
class="newline" />David Hildenbrand, Red Hat <br 
class="newline" />David Riddoch, Solarflare <br 
class="newline" />Denis V. Lunev, OpenVZ <br 
class="newline" />Dmitry Fleytman, Red Hat <br 
class="newline" />Don Wallwork, Broadcom <br 
class="newline" />Emily Drea, ARM <br 
class="newline" />Eric Auger, Red Hat <br 
class="newline" />Fam Zheng, Red Hat <br 
class="newline" />Francesco Fusco, Red Hat <br 
class="newline" />Frank Yang, Google <br 
class="newline" />Gil Savir, Intel <br 
class="newline" />Gonglei (Arei), Huawei <br 
class="newline" />Greg Kurz, IBM <br 
class="newline" />Hannes Reiencke, SUSE <br 
class="newline" />Ian Campbell, Docker <br 
class="newline" />Ilya Lesokhin, Mellanox <br 
class="newline" />Jacques Durand, Fujutsu <br 
class="newline" />Jakub Jermar, Kernkonzept <br 
class="newline" />Jan Scheurich, Ericsson <br 
class="newline" />Jason Baron, Akamai <br 
class="newline" />Jason Wang, Red Hat <br 
class="newline" />Jean-Philippe Brucker, ARM <br 
class="newline" />Jianfeng Tan, intel <br 
class="newline" />Jonathan Helman, Oracle <br 
class="newline" />Karandeep Chahal, DDN <br 
class="newline" />Kevin Lo, MSI <br 
class="newline" />Kevin Tian, Intel <br 
class="newline" />Kully Dhanoa, Intel <br 
class="newline" />Laura Novich, Red Hat <br 
class="newline" />Ladi Prosek, Red Hat <br 
class="newline" />Lars Ganrot, Napatech <br 
class="newline" />Longpeng (Mike), Huawei <br 
class="newline" />Mario Torrecillas Rodriguez, ARM <br 
class="newline" />Mark Rustad, Intel <br 
class="newline" />Maxime Coquelin, Red Hat <br 
class="newline" />Namhyung Kim, LG <br 
class="newline" />Ola Liljedahl, ARM <br 
class="newline" />Pankaj Gupta, Red Hat <br 
class="newline" />Patrick Durusau, OASIS <br 
class="newline" />Pierre Pfister, Cisco <br 
class="newline" />Pranavkumar Sawargaonkar, Linaro <br 
class="newline" />Rauchfuss Holm, Huawei <br 
class="newline" />Rob Miller, Broadcom <br 
class="newline" />Roman Kiryanov, Google <br 
class="newline" />Robin Cover, OASIS <br 
class="newline" />Roger S Chien, Intel <br 
class="newline" />Sameeh Jubran, Red Hat / Daynix <br 
class="newline" />Si-Wei Liu, Oracle <br 
class="newline" />Sridhar Samudrala, Intel <br 
class="newline" />Stefan Fritsch, Individual <br 
class="newline" />Stefano Garzarella, Red Hat <br 
class="newline" />Steven Luong, Cisco <br 
class="newline" />Thomas Huth, Red Hat <br 
class="newline" />Tiwei Bie, Intel <br 
class="newline" />Tomáš Golembiovský, Red Hat <br 
class="newline" />Venu Busireddy, Oracle <br 
class="newline" />Victor Kaplansky, Red Hat <br 
class="newline" />Vijayabhaskar Balakrishna, Oracle <br 
class="newline" />Vlad Yasevich, Red Hat <br 
class="newline" />Yan Vugenfirer, Red Hat / Daynix <br 
class="newline" />Wei Xu, Red Hat <br 
class="newline" />Will Deacon, ARM <br 
class="newline" />Willem de Bruijn, Google <br 
class="newline" />Yuanhan Liu, Intel <br 
class="newline" />Yuri Benditovich, Red Hat / Daynix <br 
class="newline" />Zhi Yong Wu, IBM <br 
class="newline" />Zhoujian, Huawei <br 
class="newline" />
                                                                  

                                                                  
<a 
 id="x1-742001r690"></a>
<!--l. 1--><p class="nopar" ><h2 class="appendixHead"><span class="titlemark">Appendix D</span>. <a 
 id="x1-743000D"></a>Revision History</h2>
The following changes have been made since the previous version of this
specification:
<a 
 id="x1-743001r1"></a><!--l. 8--><div class="longtable"> <table id="TBL-59" class="longtable" 
cellspacing="0" cellpadding="0"  
><colgroup id="TBL-59-1g"><col 
id="TBL-59-1"></colgroup><colgroup id="TBL-59-2g"><col 
id="TBL-59-2"></colgroup><colgroup id="TBL-59-3g"><col 
id="TBL-59-3"></colgroup><colgroup id="TBL-59-4g"><col 
id="TBL-59-4"></colgroup>
                                                                  

                                                                  
<tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-59-1-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-1-1"  
class="td11"> <span 
class="aeb10-">Revision  </span></td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-1-2"  
class="td11"> <span 
class="aeb10-">Date  </span></td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-1-3"  
class="td11"> <span 
class="aeb10-">Editor  </span></td><td  style="white-space:normal; text-align:left;" id="TBL-59-1-4"  
class="td11">
 <!--l. 8--><p class="noindent" ><span 
class="aeb10-">Changes Made</span>                        </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-59-2-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-2-1"  
class="td11">        </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-59-3-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-3-1"  
class="td11">         </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-3-2"  
class="td11">      </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-3-3"  
class="td11">        </td><td  style="white-space:normal; text-align:left;" id="TBL-59-3-4"  
class="td11">
</td></tr>
<tr  
 style="vertical-align:baseline;" id="TBL-59-4-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-4-1"  
class="td11"> 5c43ad7  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-4-2"  
class="td11"> 27 Feb 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-4-3"  
class="td11">    Halil Pasic       </td><td  style="white-space:normal; text-align:left;" id="TBL-59-4-4"  
class="td11">
 <!--l. 1--><p class="noindent" >ccw: be more precise about the
  semantic of revision 1
  <!--l. 4--><p class="noindent" >Revision
  1  of  the  CCW  transport  is
  currently defined as virtio 1.0.
  This  could  become  confusing
  when  we  bump  the  version  of
  the  virtio  specification  to  1.1,
  in  a  sense  that  it  could  be
  interpreted like one can not use
  any features not part of the 1.0
  specification.
  <!--l. 9--><p class="noindent" >So let us try to avoid confusion
  regarding    the    semantic    of
  virtio-ccw revision 1.
  <!--l. 12--><p class="noindent" >Fixes:
  <a 
href="https://issues.oasis-open.org/browse/VIRTIO-163" class="url" >https://issues.oasis-open.org/browse/VIRTIO-163</a>
  <!--l. 14--><p class="noindent" >Signed-off-by:     Halil     Pasic
  <pasic@linux.vnet.ibm.com>
  <!--l. 16--><p class="noindent" >Reviewed-by:   Cornelia   Huck
  <cohuck@redhat.com>
  <!--l. 18--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 20--><p class="noindent" >See <a 
href="#x1-1890001">4.3.2.1<!--tex4ht:ref: sec:Virtio Transport Options / Virtio over channel I/O / Device Initialization / Setting the Virtio Revision --></a>.
  <!--l. 23--><p class="noindent" >                                           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-59-5-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-5-1"  
class="td11"> d348ac0  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-5-2"  
class="td11"> 27 Feb 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-5-3"  
class="td11">    Halil Pasic       </td><td  style="white-space:normal; text-align:left;" id="TBL-59-5-4"  
class="td11">
 <!--l. 24--><p class="noindent" >introduction:     simplify     the
  designation of legacy
  <!--l. 27--><p class="noindent" >The  sentence  designating  the
  documents  defining  what  later
  became  known  as  the  legacy
  virtio  interface  had  the  most
  important piece of information
  placed in parenthesis.
  <!--l. 31--><p class="noindent" >Let’s  reword  this  sentence  so
  we  avoid  using  an  ambiguous
  designation based on a relative
  anchor (i.e. ’earlier drafts of this
  specification’) and just use the
  absolute anchor (version 1.0).
  <!--l. 35--><p class="noindent" >Fixes:
  <a 
href="https://issues.oasis-open.org/browse/VIRTIO-164" class="url" >https://issues.oasis-open.org/browse/VIRTIO-164</a>
  <!--l. 37--><p class="noindent" >Signed-off-by:     Halil     Pasic
  <pasic@linux.vnet.ibm.com>
  <!--l. 39--><p class="noindent" >Reviewed-by:   Cornelia   Huck
  <cohuck@redhat.com>
  <!--l. 41--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 43--><p class="noindent" >See <a 
href="#x1-60001">1.3.1<!--tex4ht:ref: intro:Legacy Interface: Terminology --></a>.                               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-59-6-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-6-1"  
class="td11">  bef3ff7   </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-6-2"  
class="td11"> 07 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-6-3"  
class="td11">  Stefan Hajnoczi   </td><td  style="white-space:normal; text-align:left;" id="TBL-59-6-4"  
class="td11">
 <!--l. 46--><p class="noindent" >virtio-blk: document data[] size
  constraints
  <!--l. 49--><p class="noindent" >The                             struct
  virtio_blk_req->data[] field is a
  multiple  of  512  bytes  long  for
  read and write requests. Flush
  requests don’t use data[] at all.
  <!--l. 52--><p class="noindent" >The           new           discard
  and write zeroes requests being
  introduced in VIRTIO 1.1 put
  struct
  virtio_blk_discard_write_zeroes
  elements into data[], so it must
  be a multiple of the struct size.
  <!--l. 56--><p class="noindent" >The                           uint8_t
  data[][512]  pseudo-code  makes
  it  look  like  discard  and  write
  zeroes  requests  must  pad  to
  512 bytes. This wastes memory
  since                           struct
  virtio_blk_discard_write_data  is
  only 16 bytes long.
  <!--l. 60--><p class="noindent" >Furthermore,      all      known
  implementations    wishing    to
  take advantage of this upcoming
  VIRTIO   1.1   feature   do   not
  use  512-byte  padding  (Linux
  virtio_blk.ko, QEMU virtio-blk
  device  emulation,  the  SPDK
  virtio-blk driver, and the SPDK
  vhost-user-blk device backend).
  <!--l. 65--><p class="noindent" >This   patch   documents   the
  data[]  size  constraints  clearly
  in the driver normative section.
  This is clearer than the current
  pseudo-code.
  <!--l. 68--><p class="noindent" >Fixes:
  <a 
href="https://github.com/oasis-tcs/virtio-spec/issues/32" class="url" >https://github.com/oasis-tcs/virtio-spec/issues/32</a>
  <!--l. 70--><p class="noindent" >Cc:     Michael     S.     Tsirkin
  <mst@redhat.com>
  <!--l. 72--><p class="noindent" >Cc:         Changpeng         Liu
  <changpeng.liu@intel.com>
  <!--l. 74--><p class="noindent" >Cc:       Stefano       Garzarella
  <sgarzare@redhat.com>
  <!--l. 76--><p class="noindent" >Signed-off-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  <!--l. 78--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 80--><p class="noindent" >See <a 
href="#x1-2890006">5.2.6<!--tex4ht:ref: sec:Device Types / Block Device / Device Operation --></a>.                               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-59-7-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-7-1"  
class="td11"> c5c0ce7   </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-7-2"  
class="td11"> 07 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-7-3"  
class="td11">  Stefan Hajnoczi   </td><td  style="white-space:normal; text-align:left;" id="TBL-59-7-4"  
class="td11">
 <!--l. 83--><p class="noindent" >virtio-blk:                      move
  virtio_blk_discard_write_zeroes
  definition
  <!--l. 86--><p class="noindent" >struct
  virtio_blk_discard_write_zeroes
  is         defined         alongside
  struct  virtio_blk_req  but  only
  discussed later in the text. Move
  it to where it belongs.
  <!--l. 90--><p class="noindent" >Fixes:
  <a 
href="https://github.com/oasis-tcs/virtio-spec/issues/32" class="url" >https://github.com/oasis-tcs/virtio-spec/issues/32</a>
  <!--l. 92--><p class="noindent" >Suggested-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 94--><p class="noindent" >Signed-off-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  <!--l. 96--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 98--><p class="noindent" >See <a 
href="#x1-2890006">5.2.6<!--tex4ht:ref: sec:Device Types / Block Device / Device Operation --></a>.                               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-59-8-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-8-1"  
class="td11">  caffe5c   </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-8-2"  
class="td11"> 07 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-8-3"  
class="td11">  Stefan Hajnoczi   </td><td  style="white-space:normal; text-align:left;" id="TBL-59-8-4"  
class="td11">
 <!--l. 101--><p class="noindent" >virtio-blk: describe write zeroes
  unmap semantics
  <!--l. 104--><p class="noindent" >Explain
  the meaning of the unmap flag.
  The details are already covered
  in the device normative section
  but  mentioning  it  here  makes
  the text easier to understand.
  <!--l. 108--><p class="noindent" >Fixes:
  <a 
href="https://github.com/oasis-tcs/virtio-spec/issues/32" class="url" >https://github.com/oasis-tcs/virtio-spec/issues/32</a>
  <!--l. 110--><p class="noindent" >Suggested-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 112--><p class="noindent" >Signed-off-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  <!--l. 114--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 116--><p class="noindent" >See <a 
href="#x1-2890006">5.2.6<!--tex4ht:ref: sec:Device Types / Block Device / Device Operation --></a>.                               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-59-9-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-9-1"  
class="td11"> 5f1e981   </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-9-2"  
class="td11"> 07 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-9-3"  
class="td11">  Stefan Hajnoczi   </td><td  style="white-space:normal; text-align:left;" id="TBL-59-9-4"  
class="td11">
 <!--l. 119--><p class="noindent" >virtio-blk:   avoid   inconsistent
  "DISCARD" term
  <!--l. 122--><p class="noindent" >"discard"  (lowercase)  is  used
  throughout  the  text.  Remove
  a lone instance of "DISCARD"
  (uppercase).
  <!--l. 125--><p class="noindent" >Fixes:
  <a 
href="https://github.com/oasis-tcs/virtio-spec/issues/32" class="url" >https://github.com/oasis-tcs/virtio-spec/issues/32</a>
  <!--l. 127--><p class="noindent" >Suggested-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 129--><p class="noindent" >Signed-off-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  <!--l. 131--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 133--><p class="noindent" >See <a 
href="#x1-2890006">5.2.6<!--tex4ht:ref: sec:Device Types / Block Device / Device Operation --></a>.                               </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-59-10-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-10-1"  
class="td11"> 31a52d2  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-10-2"  
class="td11"> 07 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-10-3"  
class="td11">  Stefan Hajnoczi   </td><td  style="white-space:normal; text-align:left;" id="TBL-59-10-4"  
class="td11">
 <!--l. 136--><p class="noindent" >virtio-blk:    clarify    semantics
  of multi-segment discard/write
  zeroes commands
  <!--l. 139--><p class="noindent" >Describe  the  failure  case  and
  maximum                   number
  of segments in a multi-segment
  discard/write zeroes command.
  <!--l. 142--><p class="noindent" >Fixes:
  <a 
href="https://github.com/oasis-tcs/virtio-spec/issues/34" class="url" >https://github.com/oasis-tcs/virtio-spec/issues/34</a>
  <!--l. 144--><p class="noindent" >Signed-off-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  <!--l. 146--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 148--><p class="noindent" >See <a 
href="#x1-2900001">5.2.6.1<!--tex4ht:ref: drivernormative:Device Types / Block Device / Device Operation --></a>.                             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-59-11-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-11-1"  
class="td11"> 90047f5  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-11-2"  
class="td11"> 21 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-11-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:normal; text-align:left;" id="TBL-59-11-4"  
class="td11">
 <!--l. 151--><p class="noindent" >format:  replace  "-  i.e."  with  ",
  i.e.,"
  <!--l. 154--><p class="noindent" >This seems to be preferred by
  native speakers, and seems just
  as effective as a sentence device.
  <!--l. 157--><p class="noindent" >Fixes:
  <a 
href="https://issues.oasis-open.org/browse/VIRTIO-171" class="url" >https://issues.oasis-open.org/browse/VIRTIO-171</a>
  Signed-off-by:     Michael     S.
  Tsirkin     <mst@redhat.com>
  Reviewed-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  <!--l. 162--><p class="noindent" >                                           </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-59-12-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-12-1"  
class="td11"> c7b2503  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-12-2"  
class="td11"> 21 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-12-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:normal; text-align:left;" id="TBL-59-12-4"  
class="td11">
 <!--l. 163--><p class="noindent" >conformance:    add    links    to
  crypto and input devices
  <!--l. 166--><p class="noindent" >Fixes:
  <a 
href="https://issues.oasis-open.org/browse/VIRTIO-174" class="url" >https://issues.oasis-open.org/browse/VIRTIO-174</a>
  <!--l. 168--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 170--><p class="noindent" >Reviewed-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  <!--l. 172--><p class="noindent" >See <a 
href="#x1-6850001">7.1<!--tex4ht:ref: sec:Conformance / Conformance Targets --></a>.                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-59-13-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-13-1"  
class="td11"> 0b5288f  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-13-2"  
class="td11"> 21 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-13-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:normal; text-align:left;" id="TBL-59-13-4"  
class="td11">
 <!--l. 175--><p class="noindent" >signal    start    and    end    of
  structures consistently
  <!--l. 178--><p class="noindent" >Make sure all structs have the
  format:
  <!--l. 180--><p class="noindent" >struct X .
  <!--l. 182--><p class="noindent" >... };
  <!--l. 185--><p class="noindent" >Fixes:
  <a 
href="https://issues.oasis-open.org/browse/VIRTIO-170" class="url" >https://issues.oasis-open.org/browse/VIRTIO-170</a>
  Signed-off-by:     Michael     S.
  Tsirkin     <mst@redhat.com>
  Reviewed-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  Reviewed-by:   Cornelia   Huck
  <cohuck@redhat.com>
  <!--l. 190--><p class="noindent" >See <a 
href="#x1-3620002">5.6.6.2<!--tex4ht:ref: sec:Device Types / SCSI Host Device / Device Operation / Device Operation: controlq --></a>.                             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-59-14-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-14-1"  
class="td11"> 69daf06  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-14-2"  
class="td11"> 21 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-14-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:normal; text-align:left;" id="TBL-59-14-4"  
class="td11">
 <!--l. 193--><p class="noindent" >editorial: explain each structure
  before use
  <!--l. 195--><p class="noindent" >Several   structures   are   listed
  before  they  are  introduced  in
  some   way.   Add   a   sentence
  before  each  one  so  they  don’t
  appear prior to any prose.
  <!--l. 199--><p class="noindent" >Fixes:
  <a 
href="https://issues.oasis-open.org/browse/VIRTIO-166" class="url" >https://issues.oasis-open.org/browse/VIRTIO-166</a>
  Signed-off-by:     Michael     S.
  Tsirkin     <mst@redhat.com>
  Reviewed-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  Reviewed-by:   Cornelia   Huck
  <cohuck@redhat.com>
  <!--l. 204--><p class="noindent" >See  <a 
href="#x1-2500005">5.1.6.5<!--tex4ht:ref: sec:Device Types / Network Device / Device Operation / Control Virtqueue --></a>,  <a 
href="#x1-540008">2.7.8<!--tex4ht:ref: sec:Basic Facilities of a Virtio Device / Virtqueues / The Virtqueue Used Ring --></a>,  <a 
href="#x1-4100005">5.9.5<!--tex4ht:ref: sec:Device Types / Crypto Device / Device configuration layout --></a>,  <a 
href="#x1-3730004">5.7.4<!--tex4ht:ref: sec:Device Types / GPU Device / Device configuration layout --></a>,
  <a 
href="#x1-3840007">5.7.6.7<!--tex4ht:ref: sec:Device Types / GPU Device / Device Operation / Device Operation: Request header --></a>, <a 
href="#x1-3840007">5.7.6.7<!--tex4ht:ref: sec:Device Types / GPU Device / Device Operation / Device Operation: Request header --></a> amd <a 
href="#x1-4440004">5.10.4<!--tex4ht:ref: sec:Device Types / Socket Device / Device configuration layout --></a>.        </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-59-15-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-15-1"  
class="td11"> d608f47  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-15-2"  
class="td11"> 21 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-15-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:normal; text-align:left;" id="TBL-59-15-4"  
class="td11">
 <!--l. 213--><p class="noindent" >conformance:  tweak  to  match
  OASIS requirements
  <!--l. 216--><p class="noindent" >Number clauses as required by
  OASIS.
  <!--l. 218--><p class="noindent" >Also  reference  the  transitional
  clause.
  <!--l. 220--><p class="noindent" >Fixes:
  <a 
href="https://issues.oasis-open.org/browse/VIRTIO-168" class="url" >https://issues.oasis-open.org/browse/VIRTIO-168</a>
  <!--l. 222--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 224--><p class="noindent" >Reviewed-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  <!--l. 226--><p class="noindent" >Reviewed-by:   Cornelia   Huck
  <cohuck@redhat.com>
  <!--l. 228--><p class="noindent" >See <a 
href="#x1-6840007">7<!--tex4ht:ref: sec:Conformance --></a>.                                    </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-59-16-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-16-1"  
class="td11"> 0dbd52d  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-16-2"  
class="td11"> 21 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-16-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:normal; text-align:left;" id="TBL-59-16-4"  
class="td11">
 <!--l. 231--><p class="noindent" >introduction:   update   link   to
  IEEE 802
  <!--l. 234--><p class="noindent" >Looks  like  all  GETIEEE  links
  got broken. Let’s just point to
  their main page.
  <!--l. 237--><p class="noindent" >Fixes:
  <a 
href="https://issues.oasis-open.org/browse/VIRTIO-175" class="url" >https://issues.oasis-open.org/browse/VIRTIO-175</a>
  <!--l. 239--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 241--><p class="noindent" >Reviewed-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  <!--l. 243--><p class="noindent" >Reviewed-by:   Jens   Freimann
  <jfreimann@redhat.com>
  <!--l. 245--><p class="noindent" >See <a 
href="#x1-30001">1.1<!--tex4ht:ref: sec:Normative References --></a>.                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-59-17-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-17-1"  
class="td11"> 7b361ea  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-17-2"  
class="td11"> 21 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-17-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:normal; text-align:left;" id="TBL-59-17-4"  
class="td11">
 <!--l. 248--><p class="noindent" >editorial: upgrade links to https
  <!--l. 251--><p class="noindent" >Several     links     have     been
  upgraded  and  now  redirect  to
  the https version. Upgrade our
  version accordingly.
  <!--l. 254--><p class="noindent" >Note   that   some   other   links
  use  the  status  301  -  moved
  permanently apparently in error
  (e.g.  for  a  language  specific
  redirect), not updating these.
  <!--l. 258--><p class="noindent" >Fixes:
  <a 
href="https://issues.oasis-open.org/browse/VIRTIO-173" class="url" >https://issues.oasis-open.org/browse/VIRTIO-173</a>
  <!--l. 260--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 262--><p class="noindent" >Reviewed-by:  Stefan  Hajnoczi
  <stefanha@redhat.com>
  <!--l. 264--><p class="noindent" >Reviewed-by:   Jens   Freimann
  <jfreimann@redhat.com>
  <!--l. 266--><p class="noindent" >See <a 
href="#x1-1doc"><!--tex4ht:ref: sec:Chair --></a>.                                     </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-59-18-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-18-1"  
class="td11"> 3e49aec  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-18-2"  
class="td11"> 21 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-18-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:normal; text-align:left;" id="TBL-59-18-4"  
class="td11">
 <!--l. 269--><p class="noindent" >conformance:    fix    confusion
  about legacy interface
  <!--l. 272--><p class="noindent" >The text describing the legacy
  interface also obliquely refers to
  a                   non-transitional
  implementation. This seems to
  cause confusion and there’s no
  good reason to do it here: this
  section is about legacy interface
  and transitional devices, it add
  not value at all. Just drop it.
  <!--l. 278--><p class="noindent" >Note:  the  spec  does  not  make
  it clear whether description of
  the legacy interface is normative
  or  not,  and  in  particular,  this
  section is not linked to from any
  conformance targets. Resolving
  that is left for later.
  <!--l. 283--><p class="noindent" >Fixes:
  <a 
href="https://issues.oasis-open.org/browse/VIRTIO-167" class="url" >https://issues.oasis-open.org/browse/VIRTIO-167</a>
  <!--l. 285--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 287--><p class="noindent" >Reviewed-by:   Cornelia   Huck
  <cohuck@redhat.com>
  <!--l. 289--><p class="noindent" >Acked-by:        Halil        Pasic
  <pasic@linux.ibm.com>
  <!--l. 291--><p class="noindent" >See <a 
href="#x1-7320004">7.4<!--tex4ht:ref: sec:Conformance / Legacy Interface: Transitional Device and Transitional Driver Conformance --></a>.                                 </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-59-19-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-19-1"  
class="td11"> 4cc8a4d  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-19-2"  
class="td11"> 21 Mar 2019  </td><td  style="white-space:nowrap; text-align:center;" id="TBL-59-19-3"  
class="td11"> Michael S. Tsirkin  </td><td  style="white-space:normal; text-align:left;" id="TBL-59-19-4"  
class="td11">
 <!--l. 294--><p class="noindent" >block: drop duplicate text
  <!--l. 297--><p class="noindent" >In version 1.1 draft 01 - Section
  5.2.6.4 - second bullet:
  <!--l. 299--><p class="noindent" >Duplicated
  text "errors, data_len, sense_len
  and residual MUST reside in a
  single, separate device-writable
  descriptor"  appears  +both  in
  the beginning and at the end of
  the 2nd sentence.
  <!--l. 303--><p class="noindent" >The original text:
  <!--l. 305--><p class="noindent" >For SCSI commands there are
  additional  constraints.  errors,
  data_len, sense_len and residual
  MUST       reside       in       a
  single, separate device-writable
  descriptor,  sense  MUST  reside
  in                                     a
  single  separate  device-writable
  descriptor   of   size   96   bytes,
  and  errors,  data_len,  sense_len
  and  residual  MUST  reside  a
  single  separate  device-writable
  descriptor.  I  suggest  to  delete
  the  1st  one,  so  in  the  end
  result,  fields  are  described  in
  same order as appear in struct
  virtio_scsi_pc_req.
  <!--l. 313--><p class="noindent" >Fixes:
  <a 
href="https://github.com/oasis-tcs/virtio-spec/issues/39" class="url" >https://github.com/oasis-tcs/virtio-spec/issues/39</a>
  <!--l. 315--><p class="noindent" >Reported-by:       Gil       Savir
  <gil.savir@intel.com>
  <!--l. 317--><p class="noindent" >Signed-off-by:     Michael     S.
  Tsirkin <mst@redhat.com>
  <!--l. 319--><p class="noindent" >See <a 
href="#x1-2930004">5.2.6.4<!--tex4ht:ref: sec:Device Types / Block Device / Legacy Interface: Framing Requirements --></a>.                             </td>
</tr><tr 
class="hline"><td><hr></td><td><hr></td><td><hr></td><td><hr></td></tr><tr  
 style="vertical-align:baseline;" id="TBL-59-20-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-20-1"  
class="td11">        </td>                                                      

                                                                  
</tr><tr  
 style="vertical-align:baseline;" id="TBL-59-21-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-21-1"  
class="td11">        </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-59-22-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-22-1"  
class="td11">        </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-59-23-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-23-1"  
class="td11">        </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-59-24-"><td  style="white-space:nowrap; text-align:center;" id="TBL-59-24-1"  
class="td11">        </td>
</tr>
</table></div>
                                                                  

                                                                  
<div class="footnotes"><!--l. 13--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn1x1-bk" id="fn1x1"><sup class="textsuperscript">1</sup></a></span><span 
class="aer-8">This lack of page-sharing implies that the implementation of the device (e.g. the hypervisor</span>
<span 
class="aer-8">or host) needs full access to the guest memory. Communication with untrusted parties (i.e.</span>
<span 
class="aer-8">inter-guest communication) requires copying.</span>
<!--l. 27--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn2x1-bk" id="fn2x1"><sup class="textsuperscript">2</sup></a></span><span 
class="aer-8">The Linux implementation further separates the virtio transport code from the specific</span>
<span 
class="aer-8">virtio drivers: these drivers are shared between different transports.</span>
<!--l. 308--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn3x2-bk" id="fn3x2"><sup class="textsuperscript">3</sup></a></span><span 
class="aer-8">For example, the simplest network device has one virtqueue for transmit and one for</span>
<span 
class="aer-8">receive.</span>
<!--l. 49--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn4x2-bk" id="fn4x2"><sup class="textsuperscript">4</sup></a></span><span 
class="aer-8">For example, if Queue Size is 4 then at most 4 buffers can be queued at any given</span>
<span 
class="aer-8">time.</span>
<!--l. 388--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn5x2-bk" id="fn5x2"><sup class="textsuperscript">5</sup></a></span><span 
class="aer-8">For example, if Queue Size is 4 then at most 4 buffers can be queued at any given</span>
<span 
class="aer-8">time.</span>
<!--l. 1742--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn6x4-bk" id="fn6x4"><sup class="textsuperscript">6</sup></a></span><span 
class="aer-8">For example, the simplest network device has two virtqueues.</span>
<!--l. 1773--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn7x4-bk" id="fn7x4"><sup class="textsuperscript">7</sup></a></span><span 
class="aer-8">The 4096 is based on the x86 page size, but it’s also large enough to ensure that the separate</span>
<span 
class="aer-8">parts of the virtqueue are on separate cache lines.</span>
<!--l. 3646--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn8x5-bk" id="fn8x5"><sup class="textsuperscript">8</sup></a></span><span 
class="aer-8">Due to various bugs in implementations, this field is not useful as a guarantee of the</span>
<span 
class="aer-8">transport header size.</span>
<!--l. 3658--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn9x5-bk" id="fn9x5"><sup class="textsuperscript">9</sup></a></span><span 
class="aer-8">This case is not handled by some older hardware, so is called out specifically in the</span>
<span 
class="aer-8">protocol.</span>
<!--l. 4312--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn10x5-bk" id="fn10x5"><sup class="textsuperscript">10</sup></a></span><span 
class="aer-8">Since there are no guarantees, it can use a hash filter or silently switch to allmulti or</span>
<span 
class="aer-8">promiscuous mode if it is given too many addresses.</span>
<!--l. 4850--><p class="nopar" ><span class="footnote-mark"><a 
href="#fn11x5-bk" id="fn11x5"><sup class="textsuperscript">11</sup></a></span><span 
class="aer-8">Consistent with </span><a 
href="#x1-2910002"><span 
class="aer-8">5.2.6.2</span><!--tex4ht:ref: devicenormative:Device Types / Block Device / Device Operation --></a><span 
class="aer-8">, a writethrough cache can be defined broadly as a cache that</span>
<span 
class="aer-8">commits writes to persistent device backend storage before reporting their completion. For</span>
<span 
class="aer-8">example, a battery-backed writeback cache actually counts as writethrough according to this</span>
<span 
class="aer-8">definition.</span>
<!--l. 5152--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn12x5-bk" id="fn12x5"><sup class="textsuperscript">12</sup></a></span><span 
class="aer-8">Note that in this case, according to </span><a 
href="#x1-2870002"><span 
class="aer-8">5.2.5.2</span><!--tex4ht:ref: devicenormative:Device Types / Block Device / Device Initialization --></a><span 
class="aer-8">, the device will not have offered</span>
<span 
class="aer-8">VIRTIO_BLK_F_CONFIG_WCE either.</span>
<!--l. 5424--><p class="nopar" ><span class="footnote-mark"><a 
href="#fn13x5-bk" id="fn13x5"><sup class="textsuperscript">13</sup></a></span><span 
class="aer-8">Because this is high importance and low bandwidth, the current Linux implementation</span>
<span 
class="aer-8">polls  for  the  buffer  to  become  used,  rather  than  waiting  for  a  used  buffer  notification,</span>
<span 
class="aer-8">simplifying  the  implementation  significantly.  However,  for  generic  serial  ports  with  the</span>
<span 
class="aer-8">O_NONBLOCK flag set, the polling limitation is relaxed and the consumed buffers are freed</span>
<span 
class="aer-8">upon the next write or poll call or when a port is closed or hot-unplugged.</span>
<!--l. 5730--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn14x5-bk" id="fn14x5"><sup class="textsuperscript">14</sup></a></span><span 
class="aer-8">This is historical, and independent of the guest page size.</span>
<!--l. 5746--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn15x5-bk" id="fn15x5"><sup class="textsuperscript">15</sup></a></span><span 
class="aer-8">In this case, deflation advice is merely a courtesy.</span>
<!--l. 6352--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn16x5-bk" id="fn16x5"><sup class="textsuperscript">16</sup></a></span><span 
class="aer-8">For example, INQUIRY or REPORT LUNS.</span>
<!--l. 6353--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn17x5-bk" id="fn17x5"><sup class="textsuperscript">17</sup></a></span><span 
class="aer-8">For example, I_T RESET.</span>
<!--l. 6492--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn18x5-bk" id="fn18x5"><sup class="textsuperscript">18</sup></a></span><span 
class="aer-8">There is no separate residual size for </span><span 
class="aeti8-">pi_bytesout </span><span 
class="aer-8">and </span><span 
class="aeti8-">pi_bytesin</span><span 
class="aer-8">. It can be computed from the</span>
<span 
class="aeti8-">residual </span><span 
class="aer-8">field, the size of the data integrity information per sector, and the sizes of </span><span 
class="aeti8-">pi_out</span><span 
class="aer-8">, </span><span 
class="aeti8-">pi_in</span><span 
class="aer-8">,</span>
<span 
class="aeti8-">dataout </span><span 
class="aer-8">and </span><span 
class="aeti8-">datain</span><span 
class="aer-8">.</span>
<!--l. 59--><p class="nopar" ><span class="footnote-mark"><a 
href="#fn19x5-bk" id="fn19x5"><sup class="textsuperscript">19</sup></a></span><span 
class="aer-8">Future  extensions  may  add  different  modes  of  operations.  At  the  moment,  only</span>
<span 
class="aer-8">VIRTIO_IOMMU_F_MAP_UNMAP is supported.</span>
<!--l. 883--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn20x5-bk" id="fn20x5"><sup class="textsuperscript">20</sup></a></span><span 
class="aer-8">This would happen for example if the device implements a more recent version of this</span>
<span 
class="aer-8">specification, whose fault report contains additional fields.</span>
<!--l. 41--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn21x5-bk" id="fn21x5"><sup class="textsuperscript">21</sup></a></span><span 
class="aer-8">For example, s390x provides storage keys for each 4 KiB page and may, depending on the</span>
<span 
class="aer-8">configuration, provide storage attributes for each 4 KiB page.</span>
<!--l. 62--><p class="nopar" ><span class="footnote-mark"><a 
href="#fn22x5-bk" id="fn22x5"><sup class="textsuperscript">22</sup></a></span><span 
class="aer-8">On platforms with memory properties that might get modified implicitly on memory</span>
<span 
class="aer-8">access, this feature is expected to be offered by the device.</span>
<!--l. 290--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn23x5-bk" id="fn23x5"><sup class="textsuperscript">23</sup></a></span><span 
class="aer-8">To allow for simplified dumping of memory. The CPU is expected to copy such memory to</span>
<span 
class="aer-8">another location before starting DMA.</span>
<!--l. 60--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn24x9-bk" id="fn24x9"><sup class="textsuperscript">24</sup></a></span><span 
class="aer-8">Even if it does mean documenting design or implementation mistakes!</span>             </div>
 
</body></html> 

                                                                  


